
/* /web/static/src/polyfills/clipboard.js */
odoo.define('@web/polyfills/clipboard',[],function(require){'use strict';let __exports={};class ClipboardItemImpl{constructor(items,options={}){this.items=items;this.options=options;}
get presentationStyle(){return this.options.presentationStyle;}
get types(){return Object.keys(this.items);}
getType(type){return this.items[type];}}
function blobToStr(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.addEventListener("load",()=>{const{result}=reader;if(typeof result==="string"){resolve(result);}else{reject("Cannot read Blob as String");}});reader.addEventListener("error",()=>{reject("Cannot read Blob");});reader.readAsText(blob);});}
async function stringify(item){const strItem={};for(const type of item.types){strItem[type]=await blobToStr(item.getType(type));}
return strItem;}
async function write(items){if(!items[0].getType("text/plain")){throw new Error(`Calling clipboard.write() without a "text/plain" type may result in an empty clipboard on some platforms.`);}
const strItem=await stringify(items[0]);const stubContainer=document.createElement("div");const shadowContainer=stubContainer.attachShadow({mode:"open"});const stub=document.createElement("span");stub.innerText=strItem["text/plain"];shadowContainer.appendChild(stub);document.body.appendChild(stubContainer);const selection=document.getSelection();const range=document.createRange();range.selectNodeContents(stub);selection.removeAllRanges();selection.addRange(range);const onCopy=(ev)=>{for(const type in strItem){ev.clipboardData.setData(type,strItem[type]);}
ev.preventDefault();};document.addEventListener("copy",onCopy);let result;try{result=document.execCommand("copy");}finally{document.removeEventListener("copy",onCopy);}
selection.removeAllRanges();document.body.removeChild(stubContainer);return result;}
if(window.navigator.clipboard){if(!window.navigator.clipboard.write){window.navigator.clipboard.write=write.bind(window);}
if(!window.ClipboardItem){window.ClipboardItem=ClipboardItemImpl;}}
return __exports;});;

/* /spreadsheet/static/src/o_spreadsheet/o_spreadsheet.js */
(function(exports,owl){'use strict';let _translate=(s)=>s;let _loaded=()=>false;function sprintf(s,...values){if(values.length===1&&typeof values[0]==="object"&&!(values[0]instanceof String)){const valuesDict=values[0];s=s.replace(/\%\(([^\)]+)\)s/g,(match,value)=>valuesDict[value]);}
else if(values.length>0){s=s.replace(/\%s/g,()=>values.shift());}
return s;}
function setTranslationMethod(tfn,loaded=()=>true){_translate=tfn;_loaded=loaded;}
const _t=function(s,...values){if(!_loaded()){return new LazyTranslatedString(s,values);}
return sprintf(_translate(s),...values);};class LazyTranslatedString extends String{values;constructor(str,values){super(str);this.values=values;}
valueOf(){const str=super.valueOf();return _loaded()?sprintf(_translate(str),...this.values):sprintf(str,...this.values);}
toString(){return this.valueOf();}}
var CellErrorType;(function(CellErrorType){CellErrorType["NotAvailable"]="#N/A";CellErrorType["InvalidReference"]="#REF";CellErrorType["BadExpression"]="#BAD_EXPR";CellErrorType["CircularDependency"]="#CYCLE";CellErrorType["UnknownFunction"]="#NAME?";CellErrorType["GenericError"]="#ERROR";})(CellErrorType||(CellErrorType={}));var CellErrorLevel;(function(CellErrorLevel){CellErrorLevel[CellErrorLevel["silent"]=0]="silent";CellErrorLevel[CellErrorLevel["error"]=1]="error";})(CellErrorLevel||(CellErrorLevel={}));class EvaluationError extends Error{errorType;logLevel;constructor(errorType,message,logLevel=CellErrorLevel.error){super(message);this.errorType=errorType;this.logLevel=logLevel;}
get isVerbose(){return this.logLevel>CellErrorLevel.silent;}}
class BadExpressionError extends EvaluationError{constructor(errorMessage){super(CellErrorType.BadExpression,errorMessage);}}
class CircularDependencyError extends EvaluationError{constructor(){super(CellErrorType.CircularDependency,_t("Circular reference"));}}
class InvalidReferenceError extends EvaluationError{constructor(){super(CellErrorType.InvalidReference,_t("Invalid reference"));}}
class NotAvailableError extends EvaluationError{constructor(errorMessage=undefined){super(CellErrorType.NotAvailable,errorMessage||_t("Data not available"),errorMessage?CellErrorLevel.error:CellErrorLevel.silent);}}
class UnknownFunctionError extends EvaluationError{constructor(fctName){super(CellErrorType.UnknownFunction,_t('Unknown function: "%s"',fctName));}}
const CANVAS_SHIFT=0.5;const BACKGROUND_GRAY_COLOR="#f5f5f5";const BACKGROUND_HEADER_COLOR="#F8F9FA";const BACKGROUND_HEADER_SELECTED_COLOR="#E8EAED";const BACKGROUND_HEADER_ACTIVE_COLOR="#595959";const TEXT_HEADER_COLOR="#666666";const FIGURE_BORDER_COLOR="#c9ccd2";const SELECTION_BORDER_COLOR="#3266ca";const HEADER_BORDER_COLOR="#C0C0C0";const CELL_BORDER_COLOR="#E2E3E3";const BACKGROUND_CHART_COLOR="#FFFFFF";const BG_HOVER_COLOR="#EBEBEB";const DISABLED_TEXT_COLOR="#CACACA";const DEFAULT_COLOR_SCALE_MIDPOINT_COLOR=0xb6d7a8;const LINK_COLOR="#01666b";const FILTERS_COLOR="#188038";const BACKGROUND_HEADER_FILTER_COLOR="#E6F4EA";const BACKGROUND_HEADER_SELECTED_FILTER_COLOR="#CEEAD6";const SEPARATOR_COLOR="#E0E2E4";const ICONS_COLOR="#4A4F59";const HEADER_GROUPING_BACKGROUND_COLOR="#F5F5F5";const HEADER_GROUPING_BORDER_COLOR="#999";const GRID_BORDER_COLOR="#E2E3E3";const FROZEN_PANE_HEADER_BORDER_COLOR="#BCBCBC";const FROZEN_PANE_BORDER_COLOR="#DADFE8";const COMPOSER_ASSISTANT_COLOR="#9B359B";const COLOR_PICKER_DEFAULTS=["#000000","#434343","#666666","#999999","#B7B7B7","#CCCCCC","#D9D9D9","#EFEFEF","#F3F3F3","#FFFFFF","#980000","#FF0000","#FF9900","#FFFF00","#00FF00","#00FFFF","#4A86E8","#0000FF","#9900FF","#FF00FF","#E6B8AF","#F4CCCC","#FCE5CD","#FFF2CC","#D9EAD3","#D0E0E3","#C9DAF8","#CFE2F3","#D9D2E9","#EAD1DC","#DD7E6B","#EA9999","#F9CB9C","#FFE599","#B6D7A8","#A2C4C9","#A4C2F4","#9FC5E8","#B4A7D6","#D5A6BD","#CC4125","#E06666","#F6B26B","#FFD966","#93C47D","#76A5AF","#6D9EEB","#6FA8DC","#8E7CC3","#C27BA0","#A61C00","#CC0000","#E69138","#F1C232","#6AA84F","#45818E","#3C78D8","#3D85C6","#674EA7","#A64D79","#85200C","#990000","#B45F06","#BF9000","#38761D","#134F5C","#1155CC","#0B5394","#351C75","#741B47","#5B0F00","#660000","#783F04","#7F6000","#274E13","#0C343D","#1C4587","#073763","#20124D","#4C1130",];const MIN_ROW_HEIGHT=10;const MIN_COL_WIDTH=5;const HEADER_HEIGHT=26;const HEADER_WIDTH=48;const TOPBAR_HEIGHT=63;const TOPBAR_TOOLBAR_HEIGHT=34;const BOTTOMBAR_HEIGHT=36;const DEFAULT_CELL_WIDTH=96;const DEFAULT_CELL_HEIGHT=23;const SCROLLBAR_WIDTH=15;const AUTOFILL_EDGE_LENGTH=8;const ICON_EDGE_LENGTH=18;const UNHIDE_ICON_EDGE_LENGTH=14;const MIN_CF_ICON_MARGIN=4;const MIN_CELL_TEXT_MARGIN=4;const CF_ICON_EDGE_LENGTH=15;const PADDING_AUTORESIZE_VERTICAL=3;const PADDING_AUTORESIZE_HORIZONTAL=MIN_CELL_TEXT_MARGIN;const GROUP_LAYER_WIDTH=21;const GRID_ICON_MARGIN=2;const GRID_ICON_EDGE_LENGTH=17;const FOOTER_HEIGHT=2*DEFAULT_CELL_HEIGHT;const MENU_WIDTH=250;const MENU_VERTICAL_PADDING=6;const MENU_ITEM_HEIGHT=26;const MENU_ITEM_PADDING_HORIZONTAL=11;const MENU_ITEM_PADDING_VERTICAL=4;const MENU_SEPARATOR_BORDER_WIDTH=1;const MENU_SEPARATOR_PADDING=5;const DEFAULT_STYLE={align:"left",verticalAlign:"bottom",wrapping:"overflow",bold:false,italic:false,strikethrough:false,underline:false,fontSize:10,fillColor:"",textColor:"#000000",};const DEFAULT_VERTICAL_ALIGN=DEFAULT_STYLE.verticalAlign;const DEFAULT_WRAPPING_MODE=DEFAULT_STYLE.wrapping;const DEFAULT_FONT_WEIGHT="400";const DEFAULT_FONT_SIZE=DEFAULT_STYLE.fontSize;const HEADER_FONT_SIZE=11;const DEFAULT_FONT="'Roboto', arial";const DEFAULT_BORDER_DESC={style:"thin",color:"#000000"};const DEFAULT_FILTER_BORDER_DESC={style:"thin",color:FILTERS_COLOR};const INCORRECT_RANGE_STRING=CellErrorType.InvalidReference;const MAX_HISTORY_STEPS=99;const DEFAULT_REVISION_ID="START_REVISION";const DEFAULT_FIGURE_HEIGHT=335;const DEFAULT_FIGURE_WIDTH=536;const FIGURE_BORDER_WIDTH=1;const MIN_FIG_SIZE=80;const MAX_CHAR_LABEL=20;const FIGURE_ID_SPLITTER="??";const DEFAULT_GAUGE_LOWER_COLOR="#cc0000";const DEFAULT_GAUGE_MIDDLE_COLOR="#f1c232";const DEFAULT_GAUGE_UPPER_COLOR="#6aa84f";const DEFAULT_SCORECARD_BASELINE_MODE="difference";const DEFAULT_SCORECARD_BASELINE_COLOR_UP="#00A04A";const DEFAULT_SCORECARD_BASELINE_COLOR_DOWN="#DC6965";const LINE_FILL_TRANSPARENCY=0.4;const DEBOUNCE_TIME=200;const MESSAGE_VERSION=1;const FORBIDDEN_SHEET_CHARS=["'","*","?","/","\\","[","]"];const FORBIDDEN_IN_EXCEL_REGEX=/'|\*|\?|\/|\\|\[|\]/;const FORMULA_REF_IDENTIFIER="|";const DEFAULT_ERROR_MESSAGE=_t("Invalid expression");var ComponentsImportance;(function(ComponentsImportance){ComponentsImportance[ComponentsImportance["Grid"]=0]="Grid";ComponentsImportance[ComponentsImportance["Highlight"]=5]="Highlight";ComponentsImportance[ComponentsImportance["HeaderGroupingButton"]=6]="HeaderGroupingButton";ComponentsImportance[ComponentsImportance["Figure"]=10]="Figure";ComponentsImportance[ComponentsImportance["ScrollBar"]=15]="ScrollBar";ComponentsImportance[ComponentsImportance["GridPopover"]=19]="GridPopover";ComponentsImportance[ComponentsImportance["GridComposer"]=20]="GridComposer";ComponentsImportance[ComponentsImportance["Dropdown"]=21]="Dropdown";ComponentsImportance[ComponentsImportance["IconPicker"]=25]="IconPicker";ComponentsImportance[ComponentsImportance["TopBarComposer"]=30]="TopBarComposer";ComponentsImportance[ComponentsImportance["Popover"]=35]="Popover";ComponentsImportance[ComponentsImportance["FigureAnchor"]=1000]="FigureAnchor";ComponentsImportance[ComponentsImportance["FigureSnapLine"]=1001]="FigureSnapLine";})(ComponentsImportance||(ComponentsImportance={}));let DEFAULT_SHEETVIEW_SIZE=0;function getDefaultSheetViewSize(){return DEFAULT_SHEETVIEW_SIZE;}
function setDefaultSheetViewSize(size){DEFAULT_SHEETVIEW_SIZE=size;}
const MAXIMAL_FREEZABLE_RATIO=0.85;const NEWLINE="\n";const FONT_SIZES=[6,7,8,9,10,11,12,14,18,24,36];function removeStringQuotes(str){if(str[0]==='"'){str=str.slice(1);}
if(str[str.length-1]==='"'&&str[str.length-2]!=="\\"){return str.slice(0,str.length-1);}
return str;}
function isCloneable(obj){return"clone"in obj&&obj.clone instanceof Function;}
function escapeRegExp(str){return str.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");}
function deepCopy(obj){const result=Array.isArray(obj)?[]:{};switch(typeof obj){case"object":{if(obj===null){return obj;}
else if(isCloneable(obj)){return obj.clone();}
else if(!(isPlainObject(obj)||obj instanceof Array)){throw new Error("Unsupported type: only objects and arrays are supported");}
for(const key in obj){result[key]=deepCopy(obj[key]);}
return result;}
case"number":case"string":case"boolean":case"function":case"undefined":return obj;default:throw new Error(`Unsupported type: ${typeof obj}`);}}
function isPlainObject(obj){return(typeof obj==="object"&&obj!==null&&(obj?.constructor===Object||obj?.constructor===undefined));}
function getUnquotedSheetName(sheetName){if(sheetName.startsWith("'")){sheetName=sheetName.slice(1,-1).replace(/''/g,"'");}
return sheetName;}
function getCanonicalSheetName(sheetName){if(sheetName.match(/\w/g)?.length!==sheetName.length){sheetName=`'${sheetName}'`;}
return sheetName;}
function clip(val,min,max){return val<min?min:val>max?max:val;}
function range(start,end,step=1){if(end<=start&&step>0){return[];}
if(step===0){throw new Error("range() step must not be zero");}
const length=Math.ceil(Math.abs((end-start)/step));const array=Array(length);for(let i=0;i<length;i++){array[i]=start+i*step;}
return array;}
function groupConsecutive(numbers){return numbers.reduce((groups,currentRow,index,rows)=>{if(Math.abs(currentRow-rows[index-1])===1){const lastGroup=groups[groups.length-1];lastGroup.push(currentRow);}
else{groups.push([currentRow]);}
return groups;},[]);}
function*linkNext(generator,nextGenerator){nextGenerator.next();for(const item of generator){const nextItem=nextGenerator.next();yield{...item,next:nextItem.done?undefined:nextItem.value,};}}
function isBoolean(str){const upperCased=str.toUpperCase();return upperCased==="TRUE"||upperCased==="FALSE";}
const MARKDOWN_LINK_REGEX=/^\[(.+)\]\((.+)\)$/;const WEB_LINK_REGEX=/^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,4}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/;function isMarkdownLink(str){return MARKDOWN_LINK_REGEX.test(str);}
function isWebLink(str){return WEB_LINK_REGEX.test(str);}
function markdownLink(label,url){return`[${label}](${url})`;}
function parseMarkdownLink(str){const matches=str.match(MARKDOWN_LINK_REGEX)||[];const label=matches[1];const url=matches[2];if(!label||!url){throw new Error(`Could not parse markdown link ${str}.`);}
return{label,url,};}
const O_SPREADSHEET_LINK_PREFIX="o-spreadsheet://";function isSheetUrl(url){return url.startsWith(O_SPREADSHEET_LINK_PREFIX);}
function buildSheetLink(sheetId){return`${O_SPREADSHEET_LINK_PREFIX}${sheetId}`;}
function parseSheetUrl(sheetLink){if(sheetLink.startsWith(O_SPREADSHEET_LINK_PREFIX)){return sheetLink.substr(O_SPREADSHEET_LINK_PREFIX.length);}
throw new Error(`${sheetLink} is not a valid sheet link`);}
function isDefined$1(argument){return argument!==undefined;}
function isNotNull(argument){return argument!==null;}
function isObjectEmptyRecursive(argument){if(argument===undefined)
return true;return Object.values(argument).every((value)=>typeof value==="object"?isObjectEmptyRecursive(value):!value);}
function getItemId(item,itemsDic){for(const key in itemsDic){if(deepEquals(itemsDic[key],item)){return parseInt(key,10);}}
const ids=Object.keys(itemsDic);const maxId=ids.length===0?0:largeMax(ids.map((id)=>parseInt(id,10)));itemsDic[maxId+1]=item;return maxId+1;}
function debounce(func,wait,immediate){let timeout;return function(){const context=this;const args=arguments;function later(){timeout=null;if(!immediate){func.apply(context,args);}}
const callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow){func.apply(context,args);}};}
function concat(chars){let output="";for(let i=0,len=chars.length;i<len;i++){output+=chars[i];}
return output;}
function lazy(fn){let isMemoized=false;let memo;const lazyValue=()=>{if(!isMemoized){memo=fn instanceof Function?fn():fn;isMemoized=true;}
return memo;};lazyValue.map=(callback)=>lazy(()=>callback(lazyValue()));return lazyValue;}
function findNextDefinedValue(arr,index){let value=arr.slice(index).find((val)=>val);if(!value){value=arr.slice(0,index).reverse().find((val)=>val);}
return value||"";}
function getAddHeaderStartIndex(position,base){return position==="after"?base+1:base;}
function deepEquals(o1,o2,ignoreFunctions){if(o1===o2)
return true;if((o1&&!o2)||(o2&&!o1))
return false;if(typeof o1!==typeof o2)
return false;if(typeof o1!=="object")
return false;for(const key in o2){if(!(key in o1)&&o2[key]!==undefined){return false;}}
for(const key in o1){const typeOfO1Key=typeof o1[key];if(typeOfO1Key!==typeof o2[key])
return false;if(typeOfO1Key==="object"){if(!deepEquals(o1[key],o2[key],ignoreFunctions))
return false;}
else{if(ignoreFunctions&&typeOfO1Key==="function"){continue;}
if(o1[key]!==o2[key])
return false;}}
return true;}
function includesAll(arr,values){return values.every((value)=>arr.includes(value));}
function removeFalsyAttributes(obj){const cleanObject={...obj};Object.keys(cleanObject).forEach((key)=>!cleanObject[key]&&delete cleanObject[key]);return cleanObject;}
const whiteSpaceSpecialCharacters=["\t","\f","\v",String.fromCharCode(parseInt("00a0",16)),String.fromCharCode(parseInt("1680",16)),String.fromCharCode(parseInt("2000",16)),String.fromCharCode(parseInt("200a",16)),String.fromCharCode(parseInt("2028",16)),String.fromCharCode(parseInt("2029",16)),String.fromCharCode(parseInt("202f",16)),String.fromCharCode(parseInt("205f",16)),String.fromCharCode(parseInt("3000",16)),String.fromCharCode(parseInt("feff",16)),];const whiteSpaceRegexp=new RegExp(whiteSpaceSpecialCharacters.join("|")+"|(\r\n|\r|\n)","g");function replaceSpecialSpaces(text){if(!text)
return"";if(!whiteSpaceRegexp.test(text))
return text;return text.replace(whiteSpaceRegexp,(match,newLine)=>(newLine?NEWLINE:" "));}
function isConsecutive(iterable){const array=Array.from(iterable).sort((a,b)=>a-b);for(let i=1;i<array.length;i++){if(array[i]-array[i-1]!==1){return false;}}
return true;}
class JetSet extends Set{addMany(iterable){for(const element of iterable){super.add(element);}
return this;}
deleteMany(iterable){let wasDeleted=false;for(const element of iterable){wasDeleted||=super.delete(element);}
return wasDeleted;}}
function memoize(func){const cache=new Map();const funcName=func.name?func.name+" (memoized)":"memoized";return{[funcName](...args){if(!cache.has(args[0])){cache.set(args[0],func(...args));}
return cache.get(args[0]);},}[funcName];}
function removeIndexesFromArray(array,indexes){return array.filter((_,index)=>!indexes.includes(index));}
function insertItemsAtIndex(array,items,index){const newArray=[...array];newArray.splice(index,0,...items);return newArray;}
function trimContent(content){const contentLines=content.split("\n");return contentLines.map((line)=>line.replace(/\s+/g," ").trim()).join("\n");}
function isNumberBetween(value,min,max){if(min>max){return isNumberBetween(value,max,min);}
return value>=min&&value<=max;}
function largeMax(array){let len=array.length;if(len<100000)
return Math.max(...array);let max=-Infinity;while(len--){max=array[len]>max?array[len]:max;}
return max;}
function largeMin(array){let len=array.length;if(len<100000)
return Math.min(...array);let min=+Infinity;while(len--){min=array[len]<min?array[len]:min;}
return min;}
const RBA_REGEX=/rgba?\(|\s+|\)/gi;const HEX_MATCH=/^#([A-F\d]{2}){3,4}$/;const colors$1=["#eb6d00","#0074d9","#ad8e00","#169ed4","#b10dc9","#00a82d","#00a3a3","#f012be","#3d9970","#111111","#62A300","#ff4136","#949494","#85144b","#001f3f",];function colorNumberString(color){return toHex(color.toString(16).padStart(6,"0"));}
function toHex(color){let hexColor=color;if(color.startsWith("rgb")){hexColor=rgbaStringToHex(color);}
else{hexColor=color.replace("#","").toUpperCase();if(hexColor.length===3||hexColor.length===4){hexColor=hexColor.split("").reduce((acc,h)=>acc+h+h,"");}
hexColor=`#${hexColor}`;}
if(!HEX_MATCH.test(hexColor)){throw new Error(`invalid color input: ${color}`);}
return hexColor;}
function isColorValid(color){try{toHex(color);return true;}
catch(error){return false;}}
function isHSLAValid(color){try{hslaToHex(color);return true;}
catch(error){return false;}}
const isColorValueValid=(v)=>v>=0&&v<=255;function rgba(r,g,b,a=1){const isInvalid=!isColorValueValid(r)||!isColorValueValid(g)||!isColorValueValid(b)||a<0||a>1;if(isInvalid){throw new Error(`Invalid RGBA values ${[r, g, b, a]}`);}
return{a,b,g,r};}
function relativeLuminance(color){let{r,g,b}=colorToRGBA(color);r/=255;g/=255;b/=255;const toLinearValue=(c)=>(c<=0.03928?c/12.92:((c+0.055)/1.055)**2.4);const R=toLinearValue(r);const G=toLinearValue(g);const B=toLinearValue(b);return 0.2126*R+0.7152*G+0.0722*B;}
function rgbaStringToHex(color){const stringVals=color.replace(RBA_REGEX,"").split(",");let alphaHex=255;if(stringVals.length!==3&&stringVals.length!==4){throw new Error("invalid color");}
else if(stringVals.length===4){const alpha=parseFloat(stringVals.pop()||"1");alphaHex=Math.round((alpha||1)*255);}
const vals=stringVals.map((val)=>parseInt(val,10));if(alphaHex!==255){vals.push(alphaHex);}
return"#"+concat(vals.map((value)=>value.toString(16).padStart(2,"0"))).toUpperCase();}
function rgbaToHex(rgba){let r=rgba.r.toString(16);let g=rgba.g.toString(16);let b=rgba.b.toString(16);let a=Math.round(rgba.a*255).toString(16);if(r.length===1)
r="0"+r;if(g.length===1)
g="0"+g;if(b.length===1)
b="0"+b;if(a.length===1)
a="0"+a;if(a==="ff")
a="";return("#"+r+g+b+a).toUpperCase();}
function colorToRGBA(color){color=toHex(color);let r;let g;let b;let a;if(color.length===7){r=parseInt(color[1]+color[2],16);g=parseInt(color[3]+color[4],16);b=parseInt(color[5]+color[6],16);a=255;}
else if(color.length===9){r=parseInt(color[1]+color[2],16);g=parseInt(color[3]+color[4],16);b=parseInt(color[5]+color[6],16);a=parseInt(color[7]+color[8],16);}
else{throw new Error("Invalid color");}
a=+(a/255).toFixed(3);return{a,r,g,b};}
function hslaToRGBA(hsla){hsla={...hsla};hsla.s/=100;hsla.l/=100;let c=(1-Math.abs(2*hsla.l-1))*hsla.s;let x=c*(1-Math.abs(((hsla.h/60)%2)-1));let m=hsla.l-c/2;let r=0;let g=0;let b=0;if(0<=hsla.h&&hsla.h<60){r=c;g=x;b=0;}
else if(60<=hsla.h&&hsla.h<120){r=x;g=c;b=0;}
else if(120<=hsla.h&&hsla.h<180){r=0;g=c;b=x;}
else if(180<=hsla.h&&hsla.h<240){r=0;g=x;b=c;}
else if(240<=hsla.h&&hsla.h<300){r=x;g=0;b=c;}
else if(300<=hsla.h&&hsla.h<360){r=c;g=0;b=x;}
r=Math.round((r+m)*255);g=Math.round((g+m)*255);b=Math.round((b+m)*255);return{a:hsla.a,r,g,b};}
function rgbaToHSLA(rgba){const r=rgba.r/255;const g=rgba.g/255;const b=rgba.b/255;let cMin=Math.min(r,g,b);let cMax=Math.max(r,g,b);let delta=cMax-cMin;let h=0;let s=0;let l=0;if(delta===0)
h=0;else if(cMax===r)
h=((g-b)/delta)%6;else if(cMax===g)
h=(b-r)/delta+2;else
h=(r-g)/delta+4;h=Math.round(h*60);if(h<0)
h+=360;l=(cMax+cMin)/2;s=delta===0?0:delta/(1-Math.abs(2*l-1));s=+(s*100).toFixed(1);l=+(l*100).toFixed(1);return{a:rgba.a,h,s,l};}
function hslaToHex(hsla){return rgbaToHex(hslaToRGBA(hsla));}
function hexToHSLA(hex){return rgbaToHSLA(colorToRGBA(hex));}
function isSameColor(color1,color2,tolerance=0){if(!(isColorValid(color1)&&isColorValid(color2))){return false;}
const rgb1=colorToRGBA(color1);const rgb2=colorToRGBA(color2);if(rgb1.a!==rgb2.a){return false;}
const diff=Math.sqrt(((rgb1.r-rgb2.r)/255)**2+((rgb1.g-rgb2.g)/255)**2+((rgb1.b-rgb2.b)/255)**2);return diff<=tolerance;}
function numberToLetters(n){if(n<0){throw new Error(`number must be positive. Got ${n}`);}
if(n<26){return String.fromCharCode(65+n);}
else{return numberToLetters(Math.floor(n/26)-1)+numberToLetters(n%26);}}
const LETTERS="ABCDEFGHIJKLMNOPQRSTUVWXYZ";const LETTERS_NUMBER_MAPPING={};for(const letter of LETTERS){const colIndex=letter.charCodeAt(0)-64;LETTERS_NUMBER_MAPPING[letter]=colIndex;LETTERS_NUMBER_MAPPING[letter.toLowerCase()]=colIndex;}
function lettersToNumber(letters){let result=-1;const l=letters.length;let pow=1;for(let i=l-1;i>=0;i--){const charCode=LETTERS_NUMBER_MAPPING[letters[i]];result+=charCode*pow;pow*=26;}
return result;}
function isCharALetter(char){return(char>="A"&&char<="Z")||(char>="a"&&char<="z");}
function isCharADigit(char){return char>="0"&&char<="9";}
function toCartesian(xc){xc=xc.trim();let numberPartStart=undefined;for(let i=0;i<xc.length;i++){const char=xc[i];if(!numberPartStart){if((char==="$"&&i===0)||isCharALetter(char)){continue;}
numberPartStart=i;}
if(!isCharADigit(char)){if(char==="$"&&i===numberPartStart){continue;}
throw new Error(`Invalid cell description: ${xc}`);}}
if(!numberPartStart||numberPartStart===xc.length){throw new Error(`Invalid cell description: ${xc}`);}
const letterPart=xc[0]==="$"?xc.slice(1,numberPartStart):xc.slice(0,numberPartStart);const numberPart=xc[numberPartStart]==="$"?xc.slice(numberPartStart+1):xc.slice(numberPartStart);if(letterPart.length<1||letterPart.length>3||numberPart.length<1||numberPart.length>7){throw new Error(`Invalid cell description: ${xc}`);}
const col=lettersToNumber(letterPart);const row=Number(numberPart)-1;if(isNaN(row)){throw new Error(`Invalid cell description: ${xc}`);}
return{col,row};}
function toXC(col,row,rangePart={colFixed:false,rowFixed:false}){return((rangePart.colFixed?"$":"")+
numberToLetters(col)+
(rangePart.rowFixed?"$":"")+
String(row+1));}
class DateTime{jsDate;constructor(year,month,day,hours=0,minutes=0,seconds=0){this.jsDate=new Date(Date.UTC(year,month,day,hours,minutes,seconds,0));}
static fromTimestamp(timestamp){const date=new Date(timestamp);return new DateTime(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds());}
static now(){const now=new Date();return new DateTime(now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds());}
toString(){return this.jsDate.toString();}
toLocaleDateString(){return this.jsDate.toLocaleDateString();}
getTime(){return this.jsDate.getTime();}
getFullYear(){return this.jsDate.getUTCFullYear();}
getMonth(){return this.jsDate.getUTCMonth();}
getDate(){return this.jsDate.getUTCDate();}
getDay(){return this.jsDate.getUTCDay();}
getHours(){return this.jsDate.getUTCHours();}
getMinutes(){return this.jsDate.getUTCMinutes();}
getSeconds(){return this.jsDate.getUTCSeconds();}
setFullYear(year){return this.jsDate.setUTCFullYear(year);}
setMonth(month){return this.jsDate.setUTCMonth(month);}
setDate(date){return this.jsDate.setUTCDate(date);}
setHours(hours){return this.jsDate.setUTCHours(hours);}
setMinutes(minutes){return this.jsDate.setUTCMinutes(minutes);}
setSeconds(seconds){return this.jsDate.setUTCSeconds(seconds);}}
const INITIAL_1900_DAY=new DateTime(1899,11,30);const MS_PER_DAY=24*60*60*1000;const CURRENT_MILLENIAL=2000;const CURRENT_YEAR=DateTime.now().getFullYear();const CURRENT_MONTH=DateTime.now().getMonth();const INITIAL_JS_DAY=DateTime.fromTimestamp(0);const DATE_JS_1900_OFFSET=INITIAL_JS_DAY.getTime()-INITIAL_1900_DAY.getTime();const mdyDateRegexp=/^\d{1,2}(\/|-|\s)\d{1,2}((\/|-|\s)\d{1,4})?$/;const ymdDateRegexp=/^\d{3,4}(\/|-|\s)\d{1,2}(\/|-|\s)\d{1,2}$/;const dateSeparatorsRegex=/\/|-|\s/;const dateRegexp=/^(\d{1,4})[\/-\s](\d{1,4})([\/-\s](\d{1,4}))?$/;const timeRegexp=/((\d+(:\d+)?(:\d+)?\s*(AM|PM))|(\d+:\d+(:\d+)?))$/;function valueToDateNumber(value,locale){switch(typeof value){case"number":return value;case"string":if(isDateTime(value,locale)){return parseDateTime(value,locale)?.value;}
return!value||isNaN(Number(value))?undefined:Number(value);default:return undefined;}}
function isDateTime(str,locale){return parseDateTime(str,locale)!==null;}
const CACHE=new Map();function parseDateTime(str,locale){if(!CACHE.has(locale)){CACHE.set(locale,new Map());}
if(!CACHE.get(locale).has(str)){CACHE.get(locale).set(str,_parseDateTime(str,locale));}
return CACHE.get(locale).get(str);}
function _parseDateTime(str,locale){str=str.trim();let time=null;const timeMatch=str.match(timeRegexp);if(timeMatch){time=parseTime(timeMatch[0]);if(time===null){return null;}
str=str.replace(timeMatch[0],"").trim();}
let date=null;const dateParts=getDateParts(str,locale);if(dateParts){const separator=dateParts.dateString.match(dateSeparatorsRegex)[0];date=parseDate(dateParts,separator);if(date===null){return null;}
str=str.replace(dateParts.dateString,"").trim();}
if(str!==""||!(date||time)){return null;}
if(date&&date.jsDate&&time&&time.jsDate){return{value:date.value+time.value,format:date.format+" "+(time.format==="hhhh:mm:ss"?"hh:mm:ss":time.format),jsDate:new DateTime(date.jsDate.getFullYear()+time.jsDate.getFullYear()-1899,date.jsDate.getMonth()+time.jsDate.getMonth()-11,date.jsDate.getDate()+time.jsDate.getDate()-30,date.jsDate.getHours()+time.jsDate.getHours(),date.jsDate.getMinutes()+time.jsDate.getMinutes(),date.jsDate.getSeconds()+time.jsDate.getSeconds()),};}
return date||time;}
function getDateParts(dateString,locale){const match=dateString.match(dateRegexp);if(!match){return null;}
const[,part1,part2,,part3]=match;if(part1.length>2&&part3&&part3.length>2){return null;}
if(part1.length>2){return{year:part1,month:part2,day:part3,dateString,type:"ymd"};}
const localeDateType=getLocaleDateFormatType(locale);if(!part3){if(part2.length>2){return{month:part1,year:part2,day:undefined,dateString,type:localeDateType};}
if(localeDateType==="dmy"){return{day:part1,month:part2,year:part3,dateString,type:"dmy"};}
return{month:part1,day:part2,year:part3,dateString,type:"mdy"};}
if(part3.length>2){if(localeDateType==="mdy"){return{month:part1,day:part2,year:part3,dateString,type:"mdy"};}
return{day:part1,month:part2,year:part3,dateString,type:"dmy"};}
if(localeDateType==="mdy"){return{month:part1,day:part2,year:part3,dateString,type:"mdy"};}
if(localeDateType==="ymd"){return{year:part1,month:part2,day:part3,dateString,type:"ymd"};}
if(localeDateType==="dmy"){return{day:part1,month:part2,year:part3,dateString,type:"dmy"};}
return null;}
function getLocaleDateFormatType(locale){switch(locale.dateFormat[0]){case"d":return"dmy";case"m":return"mdy";case"y":return"ymd";}
throw new Error("Invalid date format in locale");}
function parseDate(parts,separator){let{year:yearStr,month:monthStr,day:dayStr}=parts;const month=inferMonth(monthStr);const day=inferDay(dayStr);const year=inferYear(yearStr);if(year===null||month===null||day===null){return null;}
const leadingZero=(monthStr?.length===2&&month+1<10)||(dayStr?.length===2&&day<10);const fullYear=yearStr?.length!==2;const jsDate=new DateTime(year,month,day);if(jsDate.getMonth()!==month||jsDate.getDate()!==day){return null;}
const delta=jsDate.getTime()-INITIAL_1900_DAY.getTime();const format=getFormatFromDateParts(parts,separator,leadingZero,fullYear);return{value:Math.round(delta/MS_PER_DAY),format:format,jsDate,};}
function getFormatFromDateParts(parts,sep,leadingZero,fullYear){const yearFmt=parts.year?(fullYear?"yyyy":"yy"):undefined;const monthFmt=parts.month?(leadingZero?"mm":"m"):undefined;const dayFmt=parts.day?(leadingZero?"dd":"d"):undefined;switch(parts.type){case"mdy":return[monthFmt,dayFmt,yearFmt].filter(isDefined$1).join(sep);case"ymd":return[yearFmt,monthFmt,dayFmt].filter(isDefined$1).join(sep);case"dmy":return[dayFmt,monthFmt,yearFmt].filter(isDefined$1).join(sep);}}
function inferYear(yearStr){if(!yearStr){return CURRENT_YEAR;}
const nbr=Number(yearStr);switch(yearStr.length){case 1:return CURRENT_MILLENIAL+nbr;case 2:const offset=CURRENT_MILLENIAL+nbr>CURRENT_YEAR+10?-100:0;const base=CURRENT_MILLENIAL+offset;return base+nbr;case 3:case 4:return nbr;}
return null;}
function inferMonth(monthStr){if(!monthStr){return CURRENT_MONTH;}
const nbr=Number(monthStr);if(nbr>=1&&nbr<=12){return nbr-1;}
return null;}
function inferDay(dayStr){if(!dayStr){return 1;}
const nbr=Number(dayStr);if(nbr>=0&&nbr<=31){return nbr;}
return null;}
function parseTime(str){str=str.trim();if(timeRegexp.test(str)){const isAM=/AM/i.test(str);const isPM=/PM/i.test(str);const strTime=isAM||isPM?str.substring(0,str.length-2).trim():str;const parts=strTime.split(/:/);const isMinutes=parts.length>=2;const isSeconds=parts.length===3;let hours=Number(parts[0]);let minutes=isMinutes?Number(parts[1]):0;let seconds=isSeconds?Number(parts[2]):0;let format=isSeconds?"hh:mm:ss":"hh:mm";if(isAM||isPM){format+=" a";}
else if(!isMinutes){return null;}
if(hours>=12&&isAM){hours-=12;}
else if(hours<12&&isPM){hours+=12;}
minutes+=Math.floor(seconds/60);seconds%=60;hours+=Math.floor(minutes/60);minutes%=60;if(hours>=24){format="hhhh:mm:ss";}
const jsDate=new DateTime(1899,11,30,hours,minutes,seconds);return{value:hours/24+minutes/1440+seconds/86400,format:format,jsDate:jsDate,};}
return null;}
function numberToJsDate(value){const truncValue=Math.trunc(value);let date=DateTime.fromTimestamp(truncValue*MS_PER_DAY-DATE_JS_1900_OFFSET);let time=value-truncValue;time=time<0?1+time:time;const hours=Math.round(time*24);const minutes=Math.round((time-hours/24)*24*60);const seconds=Math.round((time-hours/24-minutes/24/60)*24*60*60);date.setHours(hours);date.setMinutes(minutes);date.setSeconds(seconds);return date;}
function jsDateToRoundNumber(date){return Math.round(jsDateToNumber(date));}
function jsDateToNumber(date){const delta=date.getTime()-INITIAL_1900_DAY.getTime();return delta/MS_PER_DAY;}
function getDaysInMonth(date){return new DateTime(date.getFullYear(),date.getMonth()+1,0).getDate();}
function isLastDayOfMonth(date){return getDaysInMonth(date)===date.getDate();}
function addMonthsToDate(date,months,keepEndOfMonth){const yStart=date.getFullYear();const mStart=date.getMonth();const dStart=date.getDate();const jsDate=new DateTime(yStart,mStart+months,1);if(keepEndOfMonth&&dStart===getDaysInMonth(date)){jsDate.setDate(getDaysInMonth(jsDate));}
else if(dStart>getDaysInMonth(jsDate)){jsDate.setDate(getDaysInMonth(jsDate));}
else{jsDate.setDate(dStart);}
return jsDate;}
function isLeapYear(year){const _year=Math.trunc(year);return(_year%4===0&&_year%100!=0)||_year%400===0;}
function getYearFrac(startDate,endDate,_dayCountConvention){if(startDate===endDate){return 0;}
if(startDate>endDate){const stack=endDate;endDate=startDate;startDate=stack;}
const jsStartDate=numberToJsDate(startDate);const jsEndDate=numberToJsDate(endDate);let dayStart=jsStartDate.getDate();let dayEnd=jsEndDate.getDate();const monthStart=jsStartDate.getMonth();const monthEnd=jsEndDate.getMonth();const yearStart=jsStartDate.getFullYear();const yearEnd=jsEndDate.getFullYear();let yearsStart=0;let yearsEnd=0;switch(_dayCountConvention){case 0:if(dayStart===31)
dayStart=30;if(dayStart===30&&dayEnd===31)
dayEnd=30;if(monthStart===1&&dayStart===(isLeapYear(yearStart)?29:28)){dayStart=30;if(monthEnd===1&&dayEnd===(isLeapYear(yearEnd)?29:28)){dayEnd=30;}}
yearsStart=yearStart+(monthStart*30+dayStart)/360;yearsEnd=yearEnd+(monthEnd*30+dayEnd)/360;break;case 1:let daysInYear=365;const isSameYear=yearStart===yearEnd;const isOneDeltaYear=yearStart+1===yearEnd;const isMonthEndBigger=monthStart<monthEnd;const isSameMonth=monthStart===monthEnd;const isDayEndBigger=dayStart<dayEnd;if((!isSameYear&&!isOneDeltaYear)||(!isSameYear&&isMonthEndBigger)||(!isSameYear&&isSameMonth&&isDayEndBigger)){let countYears=0;let countDaysInYears=0;for(let y=yearStart;y<=yearEnd;y++){countYears++;countDaysInYears+=isLeapYear(y)?366:365;}
daysInYear=countDaysInYears/countYears;}
else if(!isSameYear){if(isLeapYear(yearStart)&&monthStart<2){daysInYear=366;}
if(isLeapYear(yearEnd)&&(monthEnd>1||(monthEnd===1&&dayEnd===29))){daysInYear=366;}}
else{if(isLeapYear(yearStart)){daysInYear=366;}}
yearsStart=startDate/daysInYear;yearsEnd=endDate/daysInYear;break;case 2:yearsStart=startDate/360;yearsEnd=endDate/360;break;case 3:yearsStart=startDate/365;yearsEnd=endDate/365;break;case 4:if(dayStart===31)
dayStart=30;if(dayEnd===31)
dayEnd=30;yearsStart=yearStart+(monthStart*30+dayStart)/360;yearsEnd=yearEnd+(monthEnd*30+dayEnd)/360;break;}
return yearsEnd-yearsStart;}
function getTimeDifferenceInWholeMonths(startDate,endDate){const months=(endDate.getFullYear()-startDate.getFullYear())*12+
endDate.getMonth()-
startDate.getMonth();return startDate.getDate()>endDate.getDate()?months-1:months;}
function getTimeDifferenceInWholeDays(startDate,endDate){const startUtc=startDate.getTime();const endUtc=endDate.getTime();return Math.floor((endUtc-startUtc)/MS_PER_DAY);}
function getTimeDifferenceInWholeYears(startDate,endDate){const years=endDate.getFullYear()-startDate.getFullYear();const monthStart=startDate.getMonth();const monthEnd=endDate.getMonth();const dateStart=startDate.getDate();const dateEnd=endDate.getDate();const isEndMonthDateBigger=monthEnd>monthStart||(monthEnd===monthStart&&dateEnd>=dateStart);return isEndMonthDateBigger?years:years-1;}
function areTwoDatesWithinOneYear(startDate,endDate){return getYearFrac(startDate,endDate,1)<1;}
function areDatesSameDay(startDate,endDate){return Math.trunc(startDate)===Math.trunc(endDate);}
function isDateBetween(date,startDate,endDate){if(startDate>endDate){return isDateBetween(date,endDate,startDate);}
date=Math.trunc(date);startDate=Math.trunc(startDate);endDate=Math.trunc(endDate);return date>=startDate&&date<=endDate;}
function isDateStrictlyBefore(date,dateBefore){return Math.trunc(date)<Math.trunc(dateBefore);}
function isDateBefore(date,dateBefore){return Math.trunc(date)<=Math.trunc(dateBefore);}
function isDateStrictlyAfter(date,dateAfter){return Math.trunc(date)>Math.trunc(dateAfter);}
function isDateAfter(date,dateAfter){return Math.trunc(date)>=Math.trunc(dateAfter);}
const getFormulaNumberRegex=memoize(function getFormulaNumberRegex(decimalSeparator){decimalSeparator=escapeRegExp(decimalSeparator);return new RegExp(`(^-?\\d+(${decimalSeparator}?\\d*(e\\d+)?)?|^-?${decimalSeparator}\\d+)(?!\\w|!)`);});const getNumberRegex=memoize(function getNumberRegex(locale){const decimalSeparator=escapeRegExp(locale.decimalSeparator);const thousandsSeparator=escapeRegExp(locale.thousandsSeparator);const pIntegerAndDecimals=`(\\d+(${thousandsSeparator}\\d{3,})*(${decimalSeparator}\\d*)?)`;const pOnlyDecimals=`(${decimalSeparator}\\d+)`;const pScientificFormat="(e(\\+|-)?\\d+)?";const pPercentFormat="(\\s*%)?";const pNumber="(\\s*"+pIntegerAndDecimals+"|"+pOnlyDecimals+")"+pScientificFormat+pPercentFormat;const pMinus="(\\s*-)?";const pCurrencyFormat="(\\s*[\\$€])?";const p1=pMinus+pCurrencyFormat+pNumber;const p2=pMinus+pNumber+pCurrencyFormat;const p3=pCurrencyFormat+pMinus+pNumber;const pNumberExp="^(("+[p1,p2,p3].join(")|(")+"))$";const numberRegexp=new RegExp(pNumberExp,"i");return numberRegexp;});function isNumber(value,locale){if(!value)
return false;return getNumberRegex(locale).test(value.trim());}
const getInvaluableSymbolsRegexp=memoize(function getInvaluableSymbolsRegexp(locale){return new RegExp(`[\$€${escapeRegExp(locale.thousandsSeparator)}]`,"g");});function parseNumber(str,locale){if(locale.decimalSeparator!=="."){str=str.replace(locale.decimalSeparator,".");}
str=str.replace(getInvaluableSymbolsRegexp(locale),"");let n=Number(str);if(isNaN(n)&&str.includes("%")){n=Number(str.split("%")[0]);if(!isNaN(n)){return n/100;}}
return n;}
function percentile(values,percent,isInclusive){const sortedValues=[...values].sort((a,b)=>a-b);let percentIndex=(sortedValues.length+(isInclusive?-1:1))*percent;if(!isInclusive){percentIndex--;}
if(Number.isInteger(percentIndex)){return sortedValues[percentIndex];}
const indexSup=Math.ceil(percentIndex);const indexLow=Math.floor(percentIndex);return(sortedValues[indexSup]*(percentIndex-indexLow)+
sortedValues[indexLow]*(indexSup-percentIndex));}
var CellValueType;(function(CellValueType){CellValueType["boolean"]="boolean";CellValueType["number"]="number";CellValueType["text"]="text";CellValueType["empty"]="empty";CellValueType["error"]="error";})(CellValueType||(CellValueType={}));var ClipboardMIMEType;(function(ClipboardMIMEType){ClipboardMIMEType["PlainText"]="text/plain";ClipboardMIMEType["Html"]="text/html";})(ClipboardMIMEType||(ClipboardMIMEType={}));function isSheetDependent(cmd){return"sheetId"in cmd;}
function isHeadersDependant(cmd){return"dimension"in cmd&&"sheetId"in cmd&&"elements"in cmd;}
function isTargetDependent(cmd){return"target"in cmd&&"sheetId"in cmd;}
function isRangeDependant(cmd){return"ranges"in cmd;}
function isZoneDependent(cmd){return"zone"in cmd;}
function isPositionDependent(cmd){return"col"in cmd&&"row"in cmd&&"sheetId"in cmd;}
const invalidateEvaluationCommands=new Set(["RENAME_SHEET","DELETE_SHEET","CREATE_SHEET","ADD_COLUMNS_ROWS","REMOVE_COLUMNS_ROWS","UNDO","REDO","ADD_MERGE","UPDATE_LOCALE",]);const invalidateDependenciesCommands=new Set([...invalidateEvaluationCommands,"MOVE_RANGES",]);const invalidateCFEvaluationCommands=new Set([...invalidateEvaluationCommands,"DUPLICATE_SHEET","EVALUATE_CELLS","ADD_CONDITIONAL_FORMAT","REMOVE_CONDITIONAL_FORMAT","CHANGE_CONDITIONAL_FORMAT_PRIORITY",]);const readonlyAllowedCommands=new Set(["START","ACTIVATE_SHEET","COPY","RESIZE_SHEETVIEW","SET_VIEWPORT_OFFSET","SELECT_SEARCH_NEXT_MATCH","SELECT_SEARCH_PREVIOUS_MATCH","UPDATE_SEARCH","CLEAR_SEARCH","EVALUATE_CELLS","SET_CURRENT_CONTENT","SET_FORMULA_VISIBILITY","OPEN_CELL_POPOVER","CLOSE_CELL_POPOVER","UPDATE_FILTER",]);const coreTypes=new Set(["UPDATE_CELL","UPDATE_CELL_POSITION","CLEAR_CELL","DELETE_CONTENT","ADD_COLUMNS_ROWS","REMOVE_COLUMNS_ROWS","RESIZE_COLUMNS_ROWS","HIDE_COLUMNS_ROWS","UNHIDE_COLUMNS_ROWS","SET_GRID_LINES_VISIBILITY","UNFREEZE_COLUMNS","UNFREEZE_ROWS","FREEZE_COLUMNS","FREEZE_ROWS","UNFREEZE_COLUMNS_ROWS","ADD_MERGE","REMOVE_MERGE","CREATE_SHEET","DELETE_SHEET","DUPLICATE_SHEET","MOVE_SHEET","RENAME_SHEET","HIDE_SHEET","SHOW_SHEET","MOVE_RANGES","ADD_CONDITIONAL_FORMAT","REMOVE_CONDITIONAL_FORMAT","CHANGE_CONDITIONAL_FORMAT_PRIORITY","CREATE_FIGURE","DELETE_FIGURE","UPDATE_FIGURE","SET_FORMATTING","CLEAR_FORMATTING","SET_BORDER","SET_ZONE_BORDERS","CREATE_CHART","UPDATE_CHART","CREATE_FILTER_TABLE","REMOVE_FILTER_TABLE","CREATE_IMAGE","GROUP_HEADERS","UNGROUP_HEADERS","UNFOLD_HEADER_GROUP","FOLD_HEADER_GROUP","FOLD_ALL_HEADER_GROUPS","UNFOLD_ALL_HEADER_GROUPS","UNFOLD_HEADER_GROUPS_IN_ZONE","FOLD_HEADER_GROUPS_IN_ZONE","ADD_DATA_VALIDATION_RULE","REMOVE_DATA_VALIDATION_RULE","UPDATE_LOCALE",]);function isCoreCommand(cmd){return coreTypes.has(cmd.type);}
function canExecuteInReadonly(cmd){return readonlyAllowedCommands.has(cmd.type);}
class DispatchResult{reasons;constructor(results=[]){if(!Array.isArray(results)){results=[results];}
results=[...new Set(results)];this.reasons=results.filter((result)=>result!=="Success");}
static get Success(){return SUCCESS;}
get isSuccessful(){return this.reasons.length===0;}
isCancelledBecause(reason){return this.reasons.includes(reason);}}
const SUCCESS=new DispatchResult();exports.CommandResult=void 0;(function(CommandResult){CommandResult["Success"]="Success";CommandResult["CancelledForUnknownReason"]="CancelledForUnknownReason";CommandResult["WillRemoveExistingMerge"]="WillRemoveExistingMerge";CommandResult["MergeIsDestructive"]="MergeIsDestructive";CommandResult["CellIsMerged"]="CellIsMerged";CommandResult["InvalidTarget"]="InvalidTarget";CommandResult["EmptyUndoStack"]="EmptyUndoStack";CommandResult["EmptyRedoStack"]="EmptyRedoStack";CommandResult["NotEnoughElements"]="NotEnoughElements";CommandResult["NotEnoughSheets"]="NotEnoughSheets";CommandResult["MissingSheetName"]="MissingSheetName";CommandResult["UnchangedSheetName"]="UnchangedSheetName";CommandResult["DuplicatedSheetName"]="DuplicatedSheetName";CommandResult["DuplicatedSheetId"]="DuplicatedSheetId";CommandResult["ForbiddenCharactersInSheetName"]="ForbiddenCharactersInSheetName";CommandResult["WrongSheetMove"]="WrongSheetMove";CommandResult["WrongSheetPosition"]="WrongSheetPosition";CommandResult["InvalidAnchorZone"]="InvalidAnchorZone";CommandResult["SelectionOutOfBound"]="SelectionOutOfBound";CommandResult["TargetOutOfSheet"]="TargetOutOfSheet";CommandResult["WrongCutSelection"]="WrongCutSelection";CommandResult["WrongPasteSelection"]="WrongPasteSelection";CommandResult["WrongPasteOption"]="WrongPasteOption";CommandResult["WrongFigurePasteOption"]="WrongFigurePasteOption";CommandResult["EmptyClipboard"]="EmptyClipboard";CommandResult["EmptyRange"]="EmptyRange";CommandResult["InvalidRange"]="InvalidRange";CommandResult["InvalidZones"]="InvalidZones";CommandResult["InvalidSheetId"]="InvalidSheetId";CommandResult["InvalidFigureId"]="InvalidFigureId";CommandResult["InputAlreadyFocused"]="InputAlreadyFocused";CommandResult["MaximumRangesReached"]="MaximumRangesReached";CommandResult["MinimumRangesReached"]="MinimumRangesReached";CommandResult["InvalidChartDefinition"]="InvalidChartDefinition";CommandResult["InvalidDataSet"]="InvalidDataSet";CommandResult["InvalidLabelRange"]="InvalidLabelRange";CommandResult["InvalidScorecardKeyValue"]="InvalidScorecardKeyValue";CommandResult["InvalidScorecardBaseline"]="InvalidScorecardBaseline";CommandResult["InvalidGaugeDataRange"]="InvalidGaugeDataRange";CommandResult["EmptyGaugeRangeMin"]="EmptyGaugeRangeMin";CommandResult["GaugeRangeMinNaN"]="GaugeRangeMinNaN";CommandResult["EmptyGaugeRangeMax"]="EmptyGaugeRangeMax";CommandResult["GaugeRangeMaxNaN"]="GaugeRangeMaxNaN";CommandResult["GaugeRangeMinBiggerThanRangeMax"]="GaugeRangeMinBiggerThanRangeMax";CommandResult["GaugeLowerInflectionPointNaN"]="GaugeLowerInflectionPointNaN";CommandResult["GaugeUpperInflectionPointNaN"]="GaugeUpperInflectionPointNaN";CommandResult["GaugeLowerBiggerThanUpper"]="GaugeLowerBiggerThanUpper";CommandResult["InvalidAutofillSelection"]="InvalidAutofillSelection";CommandResult["WrongComposerSelection"]="WrongComposerSelection";CommandResult["MinBiggerThanMax"]="MinBiggerThanMax";CommandResult["LowerBiggerThanUpper"]="LowerBiggerThanUpper";CommandResult["MidBiggerThanMax"]="MidBiggerThanMax";CommandResult["MinBiggerThanMid"]="MinBiggerThanMid";CommandResult["FirstArgMissing"]="FirstArgMissing";CommandResult["SecondArgMissing"]="SecondArgMissing";CommandResult["MinNaN"]="MinNaN";CommandResult["MidNaN"]="MidNaN";CommandResult["MaxNaN"]="MaxNaN";CommandResult["ValueUpperInflectionNaN"]="ValueUpperInflectionNaN";CommandResult["ValueLowerInflectionNaN"]="ValueLowerInflectionNaN";CommandResult["MinInvalidFormula"]="MinInvalidFormula";CommandResult["MidInvalidFormula"]="MidInvalidFormula";CommandResult["MaxInvalidFormula"]="MaxInvalidFormula";CommandResult["ValueUpperInvalidFormula"]="ValueUpperInvalidFormula";CommandResult["ValueLowerInvalidFormula"]="ValueLowerInvalidFormula";CommandResult["InvalidSortZone"]="InvalidSortZone";CommandResult["WaitingSessionConfirmation"]="WaitingSessionConfirmation";CommandResult["MergeOverlap"]="MergeOverlap";CommandResult["TooManyHiddenElements"]="TooManyHiddenElements";CommandResult["Readonly"]="Readonly";CommandResult["InvalidViewportSize"]="InvalidViewportSize";CommandResult["InvalidScrollingDirection"]="InvalidScrollingDirection";CommandResult["FigureDoesNotExist"]="FigureDoesNotExist";CommandResult["InvalidConditionalFormatId"]="InvalidConditionalFormatId";CommandResult["InvalidCellPopover"]="InvalidCellPopover";CommandResult["EmptyTarget"]="EmptyTarget";CommandResult["InvalidFreezeQuantity"]="InvalidFreezeQuantity";CommandResult["FrozenPaneOverlap"]="FrozenPaneOverlap";CommandResult["ValuesNotChanged"]="ValuesNotChanged";CommandResult["InvalidFilterZone"]="InvalidFilterZone";CommandResult["FilterOverlap"]="FilterOverlap";CommandResult["FilterNotFound"]="FilterNotFound";CommandResult["MergeInFilter"]="MergeInFilter";CommandResult["NonContinuousTargets"]="NonContinuousTargets";CommandResult["DuplicatedFigureId"]="DuplicatedFigureId";CommandResult["InvalidSelectionStep"]="InvalidSelectionStep";CommandResult["DuplicatedChartId"]="DuplicatedChartId";CommandResult["ChartDoesNotExist"]="ChartDoesNotExist";CommandResult["InvalidHeaderIndex"]="InvalidHeaderIndex";CommandResult["InvalidQuantity"]="InvalidQuantity";CommandResult["MoreThanOneColumnSelected"]="MoreThanOneColumnSelected";CommandResult["EmptySplitSeparator"]="EmptySplitSeparator";CommandResult["SplitWillOverwriteContent"]="SplitWillOverwriteContent";CommandResult["NoSplitSeparatorInSelection"]="NoSplitSeparatorInSelection";CommandResult["NoActiveSheet"]="NoActiveSheet";CommandResult["InvalidLocale"]="InvalidLocale";CommandResult["AlreadyInPaintingFormatMode"]="AlreadyInPaintingFormatMode";CommandResult["MoreThanOneRangeSelected"]="MoreThanOneRangeSelected";CommandResult["NoColumnsProvided"]="NoColumnsProvided";CommandResult["ColumnsNotIncludedInZone"]="ColumnsNotIncludedInZone";CommandResult["DuplicatesColumnsSelected"]="DuplicatesColumnsSelected";CommandResult["InvalidHeaderGroupStartEnd"]="InvalidHeaderGroupStartEnd";CommandResult["HeaderGroupAlreadyExists"]="HeaderGroupAlreadyExists";CommandResult["UnknownHeaderGroup"]="UnknownHeaderGroup";CommandResult["UnknownDataValidationRule"]="UnknownDataValidationRule";CommandResult["UnknownDataValidationCriterionType"]="UnknownDataValidationCriterionType";CommandResult["InvalidDataValidationCriterionValue"]="InvalidDataValidationCriterionValue";CommandResult["InvalidNumberOfCriterionValues"]="InvalidNumberOfCriterionValues";CommandResult["BlockingValidationRule"]="BlockingValidationRule";CommandResult["InvalidCopyPasteSelection"]="InvalidCopyPasteSelection";CommandResult["NoChanges"]="NoChanges";CommandResult["InvalidInputId"]="InvalidInputId";})(exports.CommandResult||(exports.CommandResult={}));const DEFAULT_LOCALES=[{name:"English (US)",code:"en_US",thousandsSeparator:",",decimalSeparator:".",dateFormat:"m/d/yyyy",timeFormat:"hh:mm:ss a",formulaArgSeparator:",",},{name:"French",code:"fr_FR",thousandsSeparator:" ",decimalSeparator:",",dateFormat:"dd/mm/yyyy",timeFormat:"hh:mm:ss",formulaArgSeparator:";",},];const DEFAULT_LOCALE=DEFAULT_LOCALES[0];const borderStyles=["thin","medium","thick","dashed","dotted"];function isMatrix(x){return Array.isArray(x)&&Array.isArray(x[0]);}
var DIRECTION;(function(DIRECTION){DIRECTION["UP"]="up";DIRECTION["DOWN"]="down";DIRECTION["LEFT"]="left";DIRECTION["RIGHT"]="right";})(DIRECTION||(DIRECTION={}));var LAYERS;(function(LAYERS){LAYERS[LAYERS["Background"]=0]="Background";LAYERS[LAYERS["Highlights"]=1]="Highlights";LAYERS[LAYERS["Clipboard"]=2]="Clipboard";LAYERS[LAYERS["Search"]=3]="Search";LAYERS[LAYERS["Chart"]=4]="Chart";LAYERS[LAYERS["Autofill"]=5]="Autofill";LAYERS[LAYERS["Selection"]=6]="Selection";LAYERS[LAYERS["Headers"]=7]="Headers";})(LAYERS||(LAYERS={}));const SORT_TYPES_ORDER=["number","string","boolean","undefined"];function assert(condition,message){if(!condition()){throw new EvaluationError(CellErrorType.GenericError,message);}}
const expectNumberValueError=(value)=>_t("The function [[FUNCTION_NAME]] expects a number value, but '%s' is a string, and cannot be coerced to a number.",value);const expectNumberRangeError=(lowerBound,upperBound,value)=>_t("The function [[FUNCTION_NAME]] expects a number value between %s and %s inclusive, but receives %s.",lowerBound.toString(),upperBound.toString(),value.toString());const expectStringSetError=(stringSet,value)=>{const stringSetString=stringSet.map((str)=>`'${str}'`).join(", ");return _t("The function [[FUNCTION_NAME]] has an argument with value '%s'. It should be one of: %s.",value,stringSetString);};function toNumber(value,locale){switch(typeof value){case"number":return value;case"boolean":return value?1:0;case"string":if(isNumber(value,locale)||value===""){return parseNumber(value,locale);}
const internalDate=parseDateTime(value,locale);if(internalDate){return internalDate.value;}
throw new Error(expectNumberValueError(value));default:return 0;}}
function tryToNumber(value,locale){try{return toNumber(value,locale);}
catch(e){return undefined;}}
function tryCastAsNumberMatrix(data,argName){data.forEach((row)=>{row.forEach((cell)=>{if(typeof cell!=="number"){throw new Error(_t("Function [[FUNCTION_NAME]] expects number values for %s, but got a %s.",typeof cell,argName));}});});return data;}
function strictToNumber(value,locale){if(value===""){throw new Error(expectNumberValueError(value));}
return toNumber(value,locale);}
function toInteger(value,locale){return Math.trunc(toNumber(value,locale));}
function strictToInteger(value,locale){return Math.trunc(strictToNumber(value,locale));}
function assertNumberGreaterThanOrEqualToOne(value){assert(()=>value>=1,_t("The function [[FUNCTION_NAME]] expects a number value to be greater than or equal to 1, but receives %s.",value.toString()));}
function toString(value){switch(typeof value){case"string":return value;case"number":return value.toString();case"boolean":return value?"TRUE":"FALSE";default:return"";}}
const normalizeString=memoize(function normalizeString(str){return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");});const expectBooleanValueError=(value)=>_t("The function [[FUNCTION_NAME]] expects a boolean value, but '%s' is a text, and cannot be coerced to a number.",value);function toBoolean(value){switch(typeof value){case"boolean":return value;case"string":if(value){let uppercaseVal=value.toUpperCase();if(uppercaseVal==="TRUE"){return true;}
if(uppercaseVal==="FALSE"){return false;}
throw new Error(expectBooleanValueError(value));}
else{return false;}
case"number":return value?true:false;default:return false;}}
function strictToBoolean(value){if(value===""){throw new Error(expectBooleanValueError(value));}
return toBoolean(value);}
function toJsDate(value,locale){return numberToJsDate(toNumber(value,locale));}
function visitArgs(args,cellCb,dataCb){for(let arg of args){if(isMatrix(arg)){const lenRow=arg.length;const lenCol=arg[0].length;for(let y=0;y<lenCol;y++){for(let x=0;x<lenRow;x++){cellCb(arg[x][y]);}}}
else{dataCb(arg);}}}
function visitAny(args,cb){visitArgs(args,cb,cb);}
function visitNumbers(args,cb,locale){visitArgs(args,(cellValue)=>{if(typeof cellValue==="number"){cb(cellValue);}},(argValue)=>{cb(strictToNumber(argValue,locale));});}
function reduceArgs(args,cellCb,dataCb,initialValue,dir="rowFirst"){let val=initialValue;for(let arg of args){if(isMatrix(arg)){const numberOfCols=arg.length;const numberOfRows=arg[0].length;if(dir==="rowFirst"){for(let row=0;row<numberOfRows;row++){for(let col=0;col<numberOfCols;col++){val=cellCb(val,arg[col][row]);}}}
else{for(let col=0;col<numberOfCols;col++){for(let row=0;row<numberOfRows;row++){val=cellCb(val,arg[col][row]);}}}}
else{val=dataCb(val,arg);}}
return val;}
function reduceAny(args,cb,initialValue,dir="rowFirst"){return reduceArgs(args,cb,cb,initialValue,dir);}
function reduceNumbers(args,cb,initialValue,locale){return reduceArgs(args,(acc,ArgValue)=>{if(typeof ArgValue==="number"){return cb(acc,ArgValue);}
return acc;},(acc,argValue)=>{return cb(acc,strictToNumber(argValue,locale));},initialValue);}
function reduceNumbersTextAs0(args,cb,initialValue,locale){return reduceArgs(args,(acc,ArgValue)=>{if(ArgValue!==undefined&&ArgValue!==null){if(typeof ArgValue==="number"){return cb(acc,ArgValue);}
else if(typeof ArgValue==="boolean"){return cb(acc,toNumber(ArgValue,locale));}
else{return cb(acc,0);}}
return acc;},(acc,argValue)=>{return cb(acc,toNumber(argValue,locale));},initialValue);}
function generateMatrix(nColumns,nRows,callback){const returned=Array(nColumns);for(let col=0;col<nColumns;col++){returned[col]=Array(nRows);for(let row=0;row<nRows;row++){returned[col][row]=callback(col,row);}}
return returned;}
function matrixMap(matrix,fn){if(matrix.length===0){return[];}
return generateMatrix(matrix.length,matrix[0].length,(col,row)=>fn(matrix[col][row]));}
function transposeMatrix(matrix){if(!matrix.length){return[];}
return generateMatrix(matrix[0].length,matrix.length,(i,j)=>matrix[j][i]);}
function conditionalVisitArgs(args,cellCb,dataCb){for(let arg of args){if(isMatrix(arg)){const lenRow=arg.length;const lenCol=arg[0].length;for(let y=0;y<lenCol;y++){for(let x=0;x<lenRow;x++){if(!cellCb(arg[x][y]??undefined))
return;}}}
else{if(!dataCb(arg))
return;}}}
function conditionalVisitBoolean(args,cb){return conditionalVisitArgs(args,(ArgValue)=>{if(typeof ArgValue==="boolean"){return cb(ArgValue);}
if(typeof ArgValue==="number"){return cb(ArgValue?true:false);}
return true;},(argValue)=>{if(argValue!==undefined&&argValue!==null){return cb(strictToBoolean(argValue));}
return true;});}
function getPredicate(descr,isQuery,locale){let operator;let operand;let subString=descr.substring(0,2);if(subString==="<="||subString===">="||subString==="<>"){operator=subString;operand=descr.substring(2);}
else{subString=descr.substring(0,1);if(subString==="<"||subString===">"||subString==="="){operator=subString;operand=descr.substring(1);}
else{operator="=";operand=descr;}}
if(isNumber(operand,locale)){operand=toNumber(operand,locale);}
else if(operand==="TRUE"||operand==="FALSE"){operand=toBoolean(operand);}
const result={operator,operand};if(typeof operand==="string"){if(isQuery){operand+="*";}
result.regexp=operandToRegExp(operand);}
return result;}
function operandToRegExp(operand){let exp="";let predecessor="";for(let char of operand){if(char==="?"&&predecessor!=="~"){exp+=".";}
else if(char==="*"&&predecessor!=="~"){exp+=".*";}
else{if(char==="*"||char==="?"){exp=exp.slice(0,-1);}
if(["^",".","[","]","$","(",")","*","+","?","|","{","}","\\"].includes(char)){exp+="\\";}
exp+=char;}
predecessor=char;}
return new RegExp("^"+exp+"$","i");}
function evaluatePredicate(value,criterion){const{operator,operand}=criterion;if(value===undefined||operand===undefined||value===null||operand===null){return false;}
if(typeof operand==="number"&&operator==="="){return toString(value)===toString(operand);}
if(operator==="<>"||operator==="="){let result;if(typeof value===typeof operand){if(typeof value==="string"&&criterion.regexp){result=criterion.regexp.test(value);}
else{result=value===operand;}}
else{result=false;}
return operator==="="?result:!result;}
if(typeof value===typeof operand){switch(operator){case"<":return value<operand;case">":return value>operand;case"<=":return value<=operand;case">=":return value>=operand;}}
return false;}
function visitMatchingRanges(args,cb,locale,isQuery=false){const countArg=args.length;if(countArg%2===1){throw new Error(_t("Function [[FUNCTION_NAME]] expects criteria_range and criterion to be in pairs."));}
const dimRow=args[0].length;const dimCol=args[0][0].length;let predicates=[];for(let i=0;i<countArg-1;i+=2){const criteriaRange=args[i];if(!isMatrix(criteriaRange)||criteriaRange.length!==dimRow||criteriaRange[0].length!==dimCol){throw new Error(_t("Function [[FUNCTION_NAME]] expects criteria_range to have the same dimension"));}
const description=toString(args[i+1]);predicates.push(getPredicate(description,isQuery,locale));}
for(let i=0;i<dimRow;i++){for(let j=0;j<dimCol;j++){let validatedPredicates=true;for(let k=0;k<countArg-1;k+=2){const criteriaValue=args[k][i][j];const criterion=predicates[k/2];validatedPredicates=evaluatePredicate(criteriaValue??undefined,criterion);if(!validatedPredicates){break;}}
if(validatedPredicates){cb(i,j);}}}}
function dichotomicSearch(data,target,mode,sortOrder,rangeLength,getValueInData){if(target===null||target===undefined){return-1;}
const _target=normalizeValue(target);const targetType=typeof _target;let matchVal=undefined;let matchValIndex=undefined;let indexLeft=0;let indexRight=rangeLength-1;let indexMedian;let currentIndex;let currentVal;let currentType;while(indexRight-indexLeft>=0){indexMedian=Math.floor((indexLeft+indexRight)/2);currentIndex=indexMedian;currentVal=normalizeValue(getValueInData(data,currentIndex));currentType=typeof currentVal;while(indexLeft<currentIndex&&targetType!==currentType){currentIndex--;currentVal=normalizeValue(getValueInData(data,currentIndex));currentType=typeof currentVal;}
if(currentType!==targetType||currentVal===undefined||currentVal===null){indexLeft=indexMedian+1;continue;}
if(mode==="strict"&&currentVal===_target){matchVal=currentVal;matchValIndex=currentIndex;}
else if(mode==="nextSmaller"&&currentVal<=_target){if(matchVal===undefined||matchVal===null||matchVal<currentVal||(matchVal===currentVal&&sortOrder==="asc"&&matchValIndex<currentIndex)||(matchVal===currentVal&&sortOrder==="desc"&&matchValIndex>currentIndex)){matchVal=currentVal;matchValIndex=currentIndex;}}
else if(mode==="nextGreater"&&currentVal>=_target){if(matchVal===undefined||matchVal>currentVal||(matchVal===currentVal&&sortOrder==="asc"&&matchValIndex<currentIndex)||(matchVal===currentVal&&sortOrder==="desc"&&matchValIndex>currentIndex)){matchVal=currentVal;matchValIndex=currentIndex;}}
if((sortOrder==="asc"&&currentVal>_target)||(sortOrder==="desc"&&currentVal<=_target)){indexRight=currentIndex-1;}
else{indexLeft=indexMedian+1;}}
return matchValIndex!==undefined?matchValIndex:-1;}
function linearSearch(data,target,mode,numberOfValues,getValueInData,reverseSearch=false){if(target===null||target===undefined)
return-1;const _target=normalizeValue(target);const getValue=reverseSearch?(data,i)=>getValueInData(data,numberOfValues-i-1):getValueInData;let closestMatch=undefined;let closestMatchIndex=-1;for(let i=0;i<numberOfValues;i++){const value=normalizeValue(getValue(data,i));if(value===_target){return reverseSearch?numberOfValues-i-1:i;}
if(mode==="nextSmaller"){if((!closestMatch&&compareCellValues(_target,value)>=0)||(compareCellValues(_target,value)>=0&&compareCellValues(value,closestMatch)>0)){closestMatch=value;closestMatchIndex=i;}}
else if(mode==="nextGreater"){if((!closestMatch&&compareCellValues(_target,value)<=0)||(compareCellValues(_target,value)<=0&&compareCellValues(value,closestMatch)<0)){closestMatch=value;closestMatchIndex=i;}}}
return reverseSearch?numberOfValues-closestMatchIndex-1:closestMatchIndex;}
function normalizeValue(value){return typeof value==="string"?normalizeString(value):value;}
function compareCellValues(left,right){let typeOrder=SORT_TYPES_ORDER.indexOf(typeof left)-SORT_TYPES_ORDER.indexOf(typeof right);if(typeOrder===0){if(typeof left==="string"&&typeof right==="string"){typeOrder=left.localeCompare(right);}
else if(typeof left==="number"&&typeof right==="number"){typeOrder=left-right;}
else if(typeof left==="boolean"&&typeof right==="boolean"){typeOrder=Number(left)-Number(right);}}
return typeOrder;}
function toMatrix(data){if(data===undefined){return[[]];}
return isMatrix(data)?data:[[data]];}
function flattenRowFirst(items,callback){return reduceAny(items,(array,val)=>{array.push(callback(val));return array;},[],"rowFirst");}
function toCriterionDateNumber(dateValue){const today=DateTime.now();switch(dateValue){case"today":return jsDateToNumber(today);case"yesterday":return jsDateToNumber(DateTime.fromTimestamp(today.setDate(today.getDate()-1)));case"tomorrow":return jsDateToNumber(DateTime.fromTimestamp(today.setDate(today.getDate()+1)));case"lastWeek":return jsDateToNumber(DateTime.fromTimestamp(today.setDate(today.getDate()-7)));case"lastMonth":return jsDateToNumber(DateTime.fromTimestamp(today.setMonth(today.getMonth()-1)));case"lastYear":return jsDateToNumber(DateTime.fromTimestamp(today.setFullYear(today.getFullYear()-1)));}}
function getDateNumberCriterionValues(criterion,locale){if("dateValue"in criterion&&criterion.dateValue!=="exactDate"){return[toCriterionDateNumber(criterion.dateValue)];}
return criterion.values.map((value)=>valueToDateNumber(value,locale));}
function getCriterionValuesAsNumber(criterion,locale){return criterion.values.map((value)=>tryToNumber(value,locale));}
const MAX_DELAY=140;const MIN_DELAY=20;const ACCELERATION=0.035;function scrollDelay(value){return MIN_DELAY+(MAX_DELAY-MIN_DELAY)*Math.exp(-ACCELERATION*(value-1));}
const MAX_DECIMAL_PLACES=20;const DEFAULT_FORMAT_NUMBER_OF_DIGITS=11;const thousandsGroupsRegexp=/(\d+?)(?=(\d{3})+(?!\d)|$)/g;const zeroRegexp=/0/g;const MONTHS={0:_t("January"),1:_t("February"),2:_t("March"),3:_t("April"),4:_t("May"),5:_t("June"),6:_t("July"),7:_t("August"),8:_t("September"),9:_t("October"),10:_t("November"),11:_t("December"),};const DAYS$1={0:_t("Sunday"),1:_t("Monday"),2:_t("Tuesday"),3:_t("Wednesday"),4:_t("Thursday"),5:_t("Friday"),6:_t("Saturday"),};const internalFormatByFormatString={};function parseFormat(formatString){let internalFormat=internalFormatByFormatString[formatString];if(internalFormat===undefined){internalFormat=convertFormatToInternalFormat(formatString);internalFormatByFormatString[formatString]=internalFormat;}
return internalFormat;}
function formatValue(value,{format,locale}){switch(typeof value){case"string":if(value.includes('\\"')){return value.replace(/\\"/g,'"');}
return value;case"boolean":return value?"TRUE":"FALSE";case"number":if(!format){format=createDefaultFormat(value);}
const internalFormat=parseFormat(format);return applyInternalFormat(value,internalFormat,locale);case"object":return"0";}}
function applyInternalFormat(value,internalFormat,locale){if(internalFormat[0].type==="DATE"){return applyDateTimeFormat(value,internalFormat[0].format);}
let formattedValue=value<0?"-":"";for(let part of internalFormat){switch(part.type){case"NUMBER":formattedValue+=applyInternalNumberFormat(Math.abs(value),part.format,locale);break;case"STRING":formattedValue+=part.format;break;}}
return formattedValue;}
function applyInternalNumberFormat(value,format,locale){if(format.isPercent){value=value*100;}
value=value/format.magnitude;let maxDecimals=0;if(format.decimalPart!==undefined){maxDecimals=format.decimalPart.length;}
const{integerDigits,decimalDigits}=splitNumber(value,maxDecimals);let formattedValue=applyIntegerFormat(integerDigits,format.integerPart,format.thousandsSeparator?locale.thousandsSeparator:undefined);if(format.decimalPart!==undefined){formattedValue+=locale.decimalSeparator+applyDecimalFormat(decimalDigits||"",format.decimalPart);}
if(format.isPercent){formattedValue+="%";}
return formattedValue;}
function applyIntegerFormat(integerDigits,integerFormat,thousandsSeparator){const _integerDigits=integerDigits==="0"?"":integerDigits;let formattedInteger=_integerDigits;const delta=integerFormat.length-_integerDigits.length;if(delta>0){const restIntegerFormat=integerFormat.substring(0,delta);const countZero=(restIntegerFormat.match(zeroRegexp)||[]).length;formattedInteger="0".repeat(countZero)+formattedInteger;}
if(thousandsSeparator){formattedInteger=formattedInteger.match(thousandsGroupsRegexp)?.join(thousandsSeparator)||formattedInteger;}
return formattedInteger;}
function applyDecimalFormat(decimalDigits,decimalFormat){let formattedDecimals=decimalDigits;if(decimalFormat.length-decimalDigits.length>0){const restDecimalFormat=decimalFormat.substring(decimalDigits.length,decimalFormat.length+1);const countZero=(restDecimalFormat.match(zeroRegexp)||[]).length;formattedDecimals=formattedDecimals+"0".repeat(countZero);}
return formattedDecimals;}
const numberRepresentation=[];function splitNumber(value,maxDecimals=MAX_DECIMAL_PLACES){const asString=value.toString();if(asString.includes("e"))
return splitNumberIntl(value,maxDecimals);if(Number.isInteger(value)){return{integerDigits:asString,decimalDigits:undefined};}
const indexOfDot=asString.indexOf(".");let integerDigits=asString.substring(0,indexOfDot);let decimalDigits=asString.substring(indexOfDot+1);if(maxDecimals===0){if(Number(decimalDigits[0])>=5){integerDigits=(Number(integerDigits)+1).toString();}
return{integerDigits,decimalDigits:undefined};}
if(decimalDigits.length>maxDecimals){const{integerDigits:roundedIntegerDigits,decimalDigits:roundedDecimalDigits}=limitDecimalDigits(decimalDigits,maxDecimals);decimalDigits=roundedDecimalDigits;if(roundedIntegerDigits!=="0"){integerDigits=(Number(integerDigits)+Number(roundedIntegerDigits)).toString();}}
return{integerDigits,decimalDigits:removeTrailingZeroes(decimalDigits||"")};}
function removeTrailingZeroes(numberString){let i=numberString.length-1;while(i>=0&&numberString[i]==="0"){i--;}
return numberString.slice(0,i+1)||undefined;}
const leadingZeroesRegexp=/^0+/;function limitDecimalDigits(decimalDigits,maxDecimals){let integerDigits="0";let resultDecimalDigits=decimalDigits;let slicedDecimalDigits=decimalDigits.slice(0,maxDecimals);const i=maxDecimals;if(Number(decimalDigits[i])<5){return{integerDigits,decimalDigits:slicedDecimalDigits};}
const leadingZeroes=slicedDecimalDigits.match(leadingZeroesRegexp)?.[0]||"";const slicedRoundedUp=(Number(slicedDecimalDigits)+1).toString();const withoutLeadingZeroes=slicedDecimalDigits.slice(leadingZeroes.length);const carryOver=slicedRoundedUp.length>withoutLeadingZeroes.length;if(carryOver&&!leadingZeroes){integerDigits="1";resultDecimalDigits=undefined;}
else if(carryOver){resultDecimalDigits=leadingZeroes.slice(0,-1)+slicedRoundedUp;}
else{resultDecimalDigits=leadingZeroes+slicedRoundedUp;}
return{integerDigits,decimalDigits:resultDecimalDigits};}
function splitNumberIntl(value,maxDecimals=MAX_DECIMAL_PLACES){let formatter=numberRepresentation[maxDecimals];if(!formatter){formatter=new Intl.NumberFormat("en-US",{maximumFractionDigits:maxDecimals,useGrouping:false,});numberRepresentation[maxDecimals]=formatter;}
const[integerDigits,decimalDigits]=formatter.format(value).split(".");return{integerDigits,decimalDigits};}
function numberToString(number,decimalSeparator){const{integerDigits,decimalDigits}=splitNumber(number,20);return decimalDigits?integerDigits+decimalSeparator+decimalDigits:integerDigits;}
function isDateTimeFormat(format){if(!allowedDateTimeFormatFirstChar.has(format[0])){return false;}
try{applyDateTimeFormat(1,format);return true;}
catch(error){return false;}}
const allowedDateTimeFormatFirstChar=new Set(["h","m","y","d"]);function applyDateTimeFormat(value,format){const jsDate=numberToJsDate(value);const indexH=format.indexOf("h");let strDate="";let strTime="";if(indexH>0){strDate=formatJSDate(jsDate,format.substring(0,indexH-1));strTime=formatJSTime(jsDate,format.substring(indexH));}
else if(indexH===0){strTime=formatJSTime(jsDate,format);}
else if(indexH<0){strDate=formatJSDate(jsDate,format);}
return strDate+(strDate&&strTime?" ":"")+strTime;}
function formatJSDate(jsDate,format){const sep=format.match(/\/|-|\s/)?.[0];const parts=sep?format.split(sep):[format];return parts.map((p)=>{switch(p){case"d":return jsDate.getDate();case"dd":return jsDate.getDate().toString().padStart(2,"0");case"ddd":return DAYS$1[jsDate.getDay()].slice(0,3);case"dddd":return DAYS$1[jsDate.getDay()];case"m":return jsDate.getMonth()+1;case"mm":return String(jsDate.getMonth()+1).padStart(2,"0");case"mmm":return MONTHS[jsDate.getMonth()].slice(0,3);case"mmmm":return MONTHS[jsDate.getMonth()];case"mmmmm":return MONTHS[jsDate.getMonth()].slice(0,1);case"yy":const fullYear=String(jsDate.getFullYear()).replace("-","").padStart(2,"0");return fullYear.slice(fullYear.length-2);case"yyyy":return jsDate.getFullYear();default:throw new Error(`invalid format: ${format}`);}}).join(sep);}
function formatJSTime(jsDate,format){let parts=format.split(/:|\s/);const dateHours=jsDate.getHours();const isMeridian=parts[parts.length-1]==="a";let hours=dateHours;let meridian="";if(isMeridian){hours=hours===0?12:hours>12?hours-12:hours;meridian=dateHours>=12?" PM":" AM";parts.pop();}
return(parts.map((p)=>{switch(p){case"hhhh":const helapsedHours=Math.floor((jsDate.getTime()-INITIAL_1900_DAY.getTime())/(60*60*1000));return helapsedHours.toString();case"hh":return hours.toString().padStart(2,"0");case"mm":return jsDate.getMinutes().toString().padStart(2,"0");case"ss":return jsDate.getSeconds().toString().padStart(2,"0");default:throw new Error(`invalid format: ${format}`);}}).join(":")+meridian);}
const getDecimalNumberRegex=memoize(function getDecimalNumberRegex(locale){return new RegExp(`[0-9]+${escapeRegExp(locale.decimalSeparator)}[0-9]`);});function createDefaultFormat(value){let{integerDigits,decimalDigits}=splitNumber(value);if(!decimalDigits)
return"0";const digitsInIntegerPart=integerDigits.replace("-","").length;if(digitsInIntegerPart+2>DEFAULT_FORMAT_NUMBER_OF_DIGITS){return"0";}
const spaceForDecimalsDigits=DEFAULT_FORMAT_NUMBER_OF_DIGITS-digitsInIntegerPart-1;({decimalDigits}=splitNumber(value,Math.min(spaceForDecimalsDigits,decimalDigits.length)));return decimalDigits?"0."+"0".repeat(decimalDigits.length):"0";}
function detectDateFormat(content,locale){if(!isDateTime(content,locale)){return undefined;}
const internalDate=parseDateTime(content,locale);return internalDate.format;}
function detectNumberFormat(content){if(!isNumber(content,DEFAULT_LOCALE)){return undefined;}
const digitBase=content.includes(".")?"0.00":"0";const matchedCurrencies=content.match(/[\$€]/);if(matchedCurrencies){const matchedFirstDigit=content.match(/[\d]/);const currency="[$"+matchedCurrencies.values().next().value+"]";if(matchedFirstDigit.index<matchedCurrencies.index){return"#,##"+digitBase+currency;}
return currency+"#,##"+digitBase;}
if(content.includes("%")){return digitBase+"%";}
return undefined;}
function createCurrencyFormat(currency){const decimalPlaces=currency.decimalPlaces??2;const position=currency.position??"before";const code=currency.code??"";const symbol=currency.symbol??"";const decimalRepresentation=decimalPlaces?"."+"0".repeat(decimalPlaces):"";const numberFormat="#,##0"+decimalRepresentation;let textExpression=`${code} ${symbol}`.trim();if(position==="after"&&code){textExpression=" "+textExpression;}
return insertTextInFormat(textExpression,position,numberFormat);}
function insertTextInFormat(text,position,format){const textExpression=`[$${text}]`;return position==="before"?textExpression+format:format+textExpression;}
function roundFormat(format){const internalFormat=parseFormat(format);const roundedFormat=internalFormat.map((formatPart)=>{if(formatPart.type==="NUMBER"){return{type:formatPart.type,format:{...formatPart.format,decimalPart:undefined,},};}
return formatPart;});return convertInternalFormatToFormat(roundedFormat);}
function createLargeNumberFormat(format,magnitude,postFix,locale){const internalFormat=parseFormat(format||"#,##0");const largeNumberFormat=[];for(let i=0;i<internalFormat.length;i++){const formatPart=internalFormat[i];if(formatPart.type!=="NUMBER"){largeNumberFormat.push(formatPart);continue;}
largeNumberFormat.push({...formatPart,format:{...formatPart.format,magnitude,decimalPart:undefined,},});largeNumberFormat.push({type:"STRING",format:postFix,});const nextFormatPart=internalFormat[i+1];if(nextFormatPart?.type==="STRING"&&["k","m","b"].includes(nextFormatPart.format)){i++;}}
return convertInternalFormatToFormat(largeNumberFormat);}
function changeDecimalPlaces(format,step,locale){const internalFormat=parseFormat(format);const newInternalFormat=internalFormat.map((intFmt)=>{if(intFmt.type==="NUMBER"){return{...intFmt,format:changeInternalNumberFormatDecimalPlaces(intFmt.format,step)};}
else{return intFmt;}});const newFormat=convertInternalFormatToFormat(newInternalFormat);internalFormatByFormatString[newFormat]=newInternalFormat;return newFormat;}
function changeInternalNumberFormatDecimalPlaces(format,step){const _format={...format};const sign=Math.sign(step);const decimalLength=_format.decimalPart?.length||0;const countZero=Math.min(Math.max(0,decimalLength+sign),MAX_DECIMAL_PLACES);_format.decimalPart="0".repeat(countZero);if(_format.decimalPart===""){delete _format.decimalPart;}
return _format;}
function convertFormatToInternalFormat(format){if(format===""){throw new Error("A format cannot be empty");}
let currentIndex=0;let result=[];while(currentIndex<format.length){let closingIndex;if(format.charAt(currentIndex)==="["){if(format.charAt(currentIndex+1)!=="$"){throw new Error(`Currency formats have to be prefixed by a $: ${format}`);}
closingIndex=format.substring(currentIndex+1).indexOf("]")+currentIndex+2;if(closingIndex===0){throw new Error(`Invalid currency brackets format: ${format}`);}
const str=format.substring(currentIndex+2,closingIndex-1);if(str.includes("[")){throw new Error(`Invalid currency format: ${format}`);}
result.push({type:"STRING",format:str,});}
else{const nextPartIndex=format.substring(currentIndex).indexOf("[");closingIndex=nextPartIndex>-1?nextPartIndex+currentIndex:format.length;const subFormat=format.substring(currentIndex,closingIndex);if(isDateTimeFormat(subFormat)){result.push({type:"DATE",format:subFormat});}
else{result.push({type:"NUMBER",format:convertToInternalNumberFormat(subFormat),});}}
currentIndex=closingIndex;}
return result;}
const magnitudeRegex=/,*?$/;function convertToInternalNumberFormat(format){format=format.trim();if(containsInvalidNumberChars(format)){throw new Error(`Invalid number format: ${format}`);}
const isPercent=format.includes("%");const magnitudeCommas=format.match(magnitudeRegex)?.[0]||"";const magnitude=!magnitudeCommas?1:1000**magnitudeCommas.length;let _format=format.slice(0,format.length-(magnitudeCommas.length||0));const thousandsSeparator=_format.includes(",");if(/\..*,/.test(_format)){throw new Error("A format can't contain ',' symbol in the decimal part");}
_format=_format.replace("%","").replace(",","");const extraSigns=_format.match(/[\%|,]/);if(extraSigns){throw new Error(`A format can only contain a single '${extraSigns[0]}' symbol`);}
const[integerPart,decimalPart]=_format.split(".");if(decimalPart&&decimalPart.length>20){throw new Error("A format can't contain more than 20 decimal places");}
if(decimalPart!==undefined){return{integerPart,isPercent,thousandsSeparator,decimalPart,magnitude,};}
else{return{integerPart,isPercent,thousandsSeparator,magnitude,};}}
const validNumberChars=/[,#0.%]/g;function containsInvalidNumberChars(format){return Boolean(format.replace(validNumberChars,""));}
function convertInternalFormatToFormat(internalFormat){let format="";for(let part of internalFormat){let currentFormat;switch(part.type){case"NUMBER":const fmt=part.format;currentFormat=fmt.integerPart;if(fmt.thousandsSeparator){currentFormat=currentFormat.slice(0,-3)+","+currentFormat.slice(-3);}
if(fmt.decimalPart!==undefined){currentFormat+="."+fmt.decimalPart;}
if(fmt.isPercent){currentFormat+="%";}
if(fmt.magnitude){currentFormat+=",".repeat(Math.log10(fmt.magnitude)/3);}
break;case"STRING":currentFormat=`[$${part.format}]`;break;case"DATE":currentFormat=part.format;break;}
format+=currentFormat;}
return format;}
const cellReference=new RegExp(/\$?([A-Z]{1,3})\$?([0-9]{1,7})/,"i");const singleCellReference=new RegExp(/^\$?([A-Z]{1,3})\$?([0-9]{1,7})$/,"i");const colHeader=new RegExp(/^\$?([A-Z]{1,3})+$/,"i");const rowHeader=new RegExp(/^\$?([0-9]{1,7})+$/,"i");const colReference=new RegExp(/^\s*('.+'!|[^']+!)?\$?([A-Z]{1,3})$/,"i");const rowReference=new RegExp(/^\s*('.+'!|[^']+!)?\$?([0-9]{1,7})$/,"i");const fullRowXc=/(\$?[A-Z]{1,3})?\$?[0-9]{1,7}\s*:\s*(\$?[A-Z]{1,3})?\$?[0-9]{1,7}\s*/i;const fullColXc=/\$?[A-Z]{1,3}(\$?[0-9]{1,7})?\s*:\s*\$?[A-Z]{1,3}(\$?[0-9]{1,7})?\s*/i;const rangeReference=new RegExp(/^\s*('.+'!|[^']+!)?/.source+"("+
[cellReference.source,fullRowXc.source,fullColXc.source].join("|")+")"+/$/.source,"i");function isColReference(xc){return colReference.test(xc);}
function isRowReference(xc){return rowReference.test(xc);}
function isColHeader(str){return colHeader.test(str);}
function isRowHeader(str){return rowHeader.test(str);}
function isSingleCellReference(xc){return singleCellReference.test(xc);}
function splitReference(ref){const parts=ref.split("!");const xc=parts.pop();const sheetName=getUnquotedSheetName(parts.join("!"))||undefined;return{sheetName,xc};}
function toZoneWithoutBoundaryChanges(xc){if(xc.includes("!")){xc=xc.split("!").at(-1);}
if(xc.includes("$")){xc=xc.replaceAll("$","");}
let firstRangePart="";let secondRangePart;if(xc.includes(":")){[firstRangePart,secondRangePart]=xc.split(":");firstRangePart=firstRangePart.trim();secondRangePart=secondRangePart.trim();}
else{firstRangePart=xc.trim();}
let top,bottom,left,right;let fullCol=false;let fullRow=false;let hasHeader=false;if(isColReference(firstRangePart)){left=right=lettersToNumber(firstRangePart);top=bottom=0;fullCol=true;}
else if(isRowReference(firstRangePart)){top=bottom=parseInt(firstRangePart,10)-1;left=right=0;fullRow=true;}
else{const c=toCartesian(firstRangePart);left=right=c.col;top=bottom=c.row;hasHeader=true;}
if(secondRangePart){if(isColReference(secondRangePart)){right=lettersToNumber(secondRangePart);fullCol=true;}
else if(isRowReference(secondRangePart)){bottom=parseInt(secondRangePart,10)-1;fullRow=true;}
else{const c=toCartesian(secondRangePart);right=c.col;bottom=c.row;top=fullCol?bottom:top;left=fullRow?right:left;hasHeader=true;}}
if(fullCol&&fullRow){throw new Error("Wrong zone xc. The zone cannot be at the same time a full column and a full row");}
const zone={top,left,bottom:fullCol?undefined:bottom,right:fullRow?undefined:right,};hasHeader=hasHeader&&(fullRow||fullCol);if(hasHeader){zone.hasHeader=hasHeader;}
return zone;}
function toUnboundedZone(xc){const zone=toZoneWithoutBoundaryChanges(xc);if(zone.right!==undefined&&zone.right<zone.left){const tmp=zone.left;zone.left=zone.right;zone.right=tmp;}
if(zone.bottom!==undefined&&zone.bottom<zone.top){const tmp=zone.top;zone.top=zone.bottom;zone.bottom=tmp;}
return zone;}
function toZone(xc){const zone=toUnboundedZone(xc);if(zone.bottom===undefined||zone.right===undefined){throw new Error("This does not support unbounded ranges");}
return zone;}
function isZoneValid(zone){const{bottom,top,left,right}=zone;if((bottom!==undefined&&isNaN(bottom))||isNaN(top)||isNaN(left)||(right!==undefined&&isNaN(right))){return false;}
return isZoneOrdered(zone)&&zone.top>=0&&zone.left>=0;}
function isZoneOrdered(zone){return((zone.bottom===undefined||(zone.bottom>=zone.top&&zone.bottom>=0))&&(zone.right===undefined||(zone.right>=zone.left&&zone.right>=0)));}
function zoneToXc(zone){const{top,bottom,left,right}=zone;const hasHeader="hasHeader"in zone?zone.hasHeader:false;const isOneCell=top===bottom&&left===right;if(bottom===undefined&&right!==undefined){return top===0&&!hasHeader?`${numberToLetters(left)}:${numberToLetters(right)}`:`${toXC(left, top)}:${numberToLetters(right)}`;}
else if(right===undefined&&bottom!==undefined){return left===0&&!hasHeader?`${top + 1}:${bottom + 1}`:`${toXC(left, top)}:${bottom + 1}`;}
else if(bottom!==undefined&&right!==undefined){return isOneCell?toXC(left,top):`${toXC(left, top)}:${toXC(right, bottom)}`;}
throw new Error(_t("Bad zone format"));}
function expandZoneOnInsertion(zone,start,base,position,quantity){const dimension=start==="left"?"columns":"rows";const baseElement=position==="before"?base-1:base;const end=start==="left"?"right":"bottom";const zoneEnd=zone[end];if(zone[start]<=baseElement&&zoneEnd&&zoneEnd>baseElement){return createAdaptedZone(zone,dimension,"RESIZE",quantity);}
if(baseElement<zone[start]){return createAdaptedZone(zone,dimension,"MOVE",quantity);}
return{...zone};}
function updateSelectionOnInsertion(selection,start,base,position,quantity){const dimension=start==="left"?"columns":"rows";const baseElement=position==="before"?base-1:base;const end=start==="left"?"right":"bottom";if(selection[start]<=baseElement&&selection[end]>baseElement){return createAdaptedZone(selection,dimension,"RESIZE",quantity);}
if(baseElement<selection[start]){return createAdaptedZone(selection,dimension,"MOVE",quantity);}
return{...selection};}
function updateSelectionOnDeletion(zone,start,elements){const end=start==="left"?"right":"bottom";let newStart=zone[start];let newEnd=zone[end];for(let removedElement of elements.sort((a,b)=>b-a)){if(zone[start]>removedElement){newStart--;newEnd--;}
if(zone[start]<removedElement&&zone[end]>=removedElement){newEnd--;}}
return{...zone,[start]:newStart,[end]:newEnd};}
function reduceZoneOnDeletion(zone,start,elements){const end=start==="left"?"right":"bottom";let newStart=zone[start];let newEnd=zone[end];const zoneEnd=zone[end];for(let removedElement of elements.sort((a,b)=>b-a)){if(zone[start]>removedElement){newStart--;if(newEnd!==undefined)
newEnd--;}
if(zoneEnd!==undefined&&newEnd!==undefined&&zone[start]<=removedElement&&zoneEnd>=removedElement){newEnd--;}}
if(newEnd!==undefined&&newStart>newEnd){return undefined;}
return{...zone,[start]:newStart,[end]:newEnd};}
function union(...zones){return{top:Math.min(...zones.map((zone)=>zone.top)),left:Math.min(...zones.map((zone)=>zone.left)),bottom:Math.max(...zones.map((zone)=>zone.bottom)),right:Math.max(...zones.map((zone)=>zone.right)),};}
function intersection(z1,z2){if(!overlap(z1,z2)){return undefined;}
return{top:Math.max(z1.top,z2.top),left:Math.max(z1.left,z2.left),bottom:Math.min(z1.bottom,z2.bottom),right:Math.min(z1.right,z2.right),};}
function isEqual(z1,z2){return(z1.left===z2.left&&z1.right===z2.right&&z1.top===z2.top&&z1.bottom===z2.bottom);}
function overlap(z1,z2){if(z1.bottom<z2.top||z2.bottom<z1.top){return false;}
if(z1.right<z2.left||z2.right<z1.left){return false;}
return true;}
function isInside(col,row,zone){const{left,right,top,bottom}=zone;return col>=left&&col<=right&&row>=top&&row<=bottom;}
function isZoneInside(smallZone,biggerZone){return isEqual(union(biggerZone,smallZone),biggerZone);}
function recomputeZones(zonesXc,toRemoveZonesXc){const zones=zonesXc.map(toUnboundedZone);const zonesToRemove=toRemoveZonesXc.map(toUnboundedZone);const maxBottom=Math.max(...zones.concat(zonesToRemove).map((zone)=>zone.bottom||0));const maxRight=Math.max(...zones.concat(zonesToRemove).map((zone)=>zone.right||0));const expandedZones=zones.map((zone)=>({...zone,bottom:zone.bottom===undefined?maxBottom+1:zone.bottom,right:zone.right===undefined?maxRight+1:zone.right,}));const expandedZonesToRemove=zonesToRemove.map((zone)=>({...zone,bottom:zone.bottom===undefined?maxBottom+1:zone.bottom,right:zone.right===undefined?maxRight+1:zone.right,}));const zonePositions=expandedZones.map(positions).flat();const positionsToRemove=expandedZonesToRemove.map(positions).flat();const positionToKeep=positionsDifference(zonePositions,positionsToRemove);const columns=mergePositionsIntoColumns(positionToKeep);return mergeAlignedColumns(columns).map((zone)=>({...zone,bottom:zone.bottom===maxBottom+1?undefined:zone.bottom,right:zone.right===maxRight+1?undefined:zone.right,})).map(zoneToXc);}
function mergeAlignedColumns(columns){if(columns.length===0){return[];}
if(columns.some((zone)=>zone.left!==zone.right)){throw new Error("only columns can be merged");}
const done=[];const cols=removeRedundantZones(columns);const isAdjacentAndAligned=(zone,nextZone)=>zone.top===nextZone.top&&zone.bottom===nextZone.bottom&&zone.right+1===nextZone.left;while(cols.length){const merged=cols.reduce((zone,nextZone)=>(isAdjacentAndAligned(zone,nextZone)?union(zone,nextZone):zone),cols.shift());done.push(merged);}
return removeRedundantZones(done);}
function removeRedundantZones(zones){const sortedZones=[...zones].sort((a,b)=>b.right-a.right).sort((a,b)=>b.bottom-a.bottom).sort((a,b)=>a.top-b.top).sort((a,b)=>a.left-b.left).reverse();const checked=[];while(sortedZones.length!==0){const zone=sortedZones.shift();const isIncludedInOther=sortedZones.some((otherZone)=>isZoneInside(zone,otherZone));if(!isIncludedInOther){checked.push(zone);}}
return checked.reverse();}
function mergePositionsIntoColumns(positions){if(positions.length===0){return[];}
const[startingPosition,...sortedPositions]=[...positions].sort((a,b)=>a.row-b.row).sort((a,b)=>a.col-b.col);const done=[];let active=positionToZone(startingPosition);for(const{col,row}of sortedPositions){if(isInside(col,row,active)){continue;}
else if(col===active.left&&row===active.bottom+1){const bottom=active.bottom+1;active={...active,bottom};}
else{done.push(active);active=positionToZone({col,row});}}
return[...done,active];}
function positionsDifference(positions,toRemove){const forbidden=new Set(toRemove.map(({col,row})=>`${col}-${row}`));return positions.filter(({col,row})=>!forbidden.has(`${col}-${row}`));}
function zoneToDimension(zone){return{numberOfRows:zone.bottom-zone.top+1,numberOfCols:zone.right-zone.left+1,};}
function isOneDimensional(zone){const{numberOfCols,numberOfRows}=zoneToDimension(zone);return numberOfCols===1||numberOfRows===1;}
function positions(zone){const positions=[];const[left,right]=[zone.right,zone.left].sort((a,b)=>a-b);const[top,bottom]=[zone.top,zone.bottom].sort((a,b)=>a-b);for(const col of range(left,right+1)){for(const row of range(top,bottom+1)){positions.push({col,row});}}
return positions;}
function forEachPositionsInZone(zone,callback){const{left,right,top,bottom}=zone;for(let col=left;col<=right;col++){for(let row=top;row<=bottom;row++){callback(col,row);}}}
function createAdaptedZone(zone,dimension,operation,by){const offsetX=dimension==="both"?by[0]:dimension==="columns"?by:0;const offsetY=dimension==="both"?by[1]:dimension==="rows"?by:0;const hasHeader="hasHeader"in zone?zone.hasHeader:false;let shouldStartBeMoved;if(isFullCol(zone)&&!hasHeader){shouldStartBeMoved=dimension!=="rows";}
else if(isFullRow(zone)&&!hasHeader){shouldStartBeMoved=dimension!=="columns";}
else{shouldStartBeMoved=true;}
const newZone={...zone};if(shouldStartBeMoved&&operation==="MOVE"){newZone["left"]+=offsetX;newZone["top"]+=offsetY;}
if(newZone["right"]!==undefined){newZone["right"]+=offsetX;}
if(newZone["bottom"]!==undefined){newZone["bottom"]+=offsetY;}
return newZone;}
function uniqueZones(zones){return zones.reverse().filter((zone,index,self)=>index===self.findIndex((z)=>z.top===zone.top&&z.bottom===zone.bottom&&z.left===zone.left&&z.right===zone.right)).reverse();}
function mergeOverlappingZones(zones){return zones.reduce((dissociatedZones,zone)=>{const nextIndex=dissociatedZones.length;for(let i=0;i<nextIndex;i++){if(overlap(dissociatedZones[i],zone)){dissociatedZones[i]=union(dissociatedZones[i],zone);return dissociatedZones;}}
dissociatedZones[nextIndex]=zone;return dissociatedZones;},[]);}
function findCellInNewZone(oldZone,currentZone){let col,row;const{left:oldLeft,right:oldRight,top:oldTop,bottom:oldBottom}=oldZone;const{left,right,top,bottom}=currentZone;if(left!=oldLeft){col=left;}
else if(right!=oldRight){col=right;}
else{col=left;}
if(top!=oldTop){row=top;}
else if(bottom!=oldBottom){row=bottom;}
else{row=top;}
return{col,row};}
function organizeZone(zone){return{top:Math.min(zone.top,zone.bottom),bottom:Math.max(zone.top,zone.bottom),left:Math.min(zone.left,zone.right),right:Math.max(zone.left,zone.right),};}
function positionToZone(position){return{left:position.col,right:position.col,top:position.row,bottom:position.row};}
function isFullRow(zone){return zone.right===undefined;}
function isFullCol(zone){return zone.bottom===undefined;}
function getZoneArea(zone){return(zone.bottom-zone.top+1)*(zone.right-zone.left+1);}
function areZonesContinuous(...zones){if(zones.length<2)
return true;return recomputeZones(zones.map(zoneToXc),[]).length===1;}
function getZonesCols(zones){const set=new Set();for(let zone of zones){for(let col of range(zone.left,zone.right+1)){set.add(col);}}
return set;}
function getZonesRows(zones){const set=new Set();for(let zone of zones){for(let row of range(zone.top,zone.bottom+1)){set.add(row);}}
return set;}
class RangeImpl{getSheetSize;_zone;parts;invalidXc;prefixSheet=false;sheetId;invalidSheetName;constructor(args,getSheetSize){this.getSheetSize=getSheetSize;this._zone=args.zone;this.prefixSheet=args.prefixSheet;this.invalidXc=args.invalidXc;this.sheetId=args.sheetId;this.invalidSheetName=args.invalidSheetName;let _fixedParts=[...args.parts];if(args.parts.length===1&&getZoneArea(this.zone)>1){_fixedParts.push({...args.parts[0]});}
else if(args.parts.length===2&&getZoneArea(this.zone)===1){_fixedParts.pop();}
this.parts=_fixedParts;}
static fromRange(range,getters){if(range instanceof RangeImpl){return range;}
return new RangeImpl(range,getters.getSheetSize);}
get unboundedZone(){return this._zone;}
get zone(){const{left,top,bottom,right}=this._zone;if(right!==undefined&&bottom!==undefined){return this._zone;}
else if(bottom===undefined&&right!==undefined){return{right,top,left,bottom:this.getSheetSize(this.sheetId).numberOfRows-1};}
else if(right===undefined&&bottom!==undefined){return{bottom,left,top,right:this.getSheetSize(this.sheetId).numberOfCols-1};}
throw new Error(_t("Bad zone format"));}
static getRangeParts(xc,zone){const parts=xc.split(":").map((p)=>{const isFullRow=isRowReference(p);return{colFixed:isFullRow?false:p.startsWith("$"),rowFixed:isFullRow?p.startsWith("$"):p.includes("$",1),};});const isFullCol=zone.bottom===undefined;const isFullRow=zone.right===undefined;if(isFullCol){parts[0].rowFixed=parts[0].rowFixed||parts[1].rowFixed;parts[1].rowFixed=parts[0].rowFixed||parts[1].rowFixed;}
if(isFullRow){parts[0].colFixed=parts[0].colFixed||parts[1].colFixed;parts[1].colFixed=parts[0].colFixed||parts[1].colFixed;}
return parts;}
get isFullCol(){return this._zone.bottom===undefined;}
get isFullRow(){return this._zone.right===undefined;}
get rangeData(){return{_zone:this._zone,_sheetId:this.sheetId,};}
orderZone(){if(isZoneOrdered(this._zone)){return this;}
const zone={...this._zone};let parts=this.parts;if(zone.right!==undefined&&zone.right<zone.left){let right=zone.right;zone.right=zone.left;zone.left=right;parts=[{colFixed:parts[1]?.colFixed||false,rowFixed:parts[0]?.rowFixed||false,},{colFixed:parts[0]?.colFixed||false,rowFixed:parts[1]?.rowFixed||false,},];}
if(zone.bottom!==undefined&&zone.bottom<zone.top){let bottom=zone.bottom;zone.bottom=zone.top;zone.top=bottom;parts=[{colFixed:parts[0]?.colFixed||false,rowFixed:parts[1]?.rowFixed||false,},{colFixed:parts[1]?.colFixed||false,rowFixed:parts[0]?.rowFixed||false,},];}
return this.clone({zone,parts});}
clone(rangeParams){return new RangeImpl({zone:rangeParams?.zone?rangeParams.zone:{...this._zone},sheetId:rangeParams?.sheetId?rangeParams.sheetId:this.sheetId,invalidSheetName:rangeParams&&"invalidSheetName"in rangeParams?rangeParams.invalidSheetName:this.invalidSheetName,invalidXc:rangeParams&&"invalidXc"in rangeParams?rangeParams.invalidXc:this.invalidXc,parts:rangeParams?.parts?rangeParams.parts:this.parts.map((part)=>{return{rowFixed:part.rowFixed,colFixed:part.colFixed};}),prefixSheet:rangeParams?.prefixSheet?rangeParams.prefixSheet:this.prefixSheet,},this.getSheetSize);}}
function copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,range){const sheetId=range.sheetId===sheetIdFrom?sheetIdTo:range.sheetId;return range.clone({sheetId});}
function createValidRange(getters,sheetId,xc){if(!xc)
return;const range=getters.getRangeFromSheetXC(sheetId,xc);return!(range.invalidSheetName||range.invalidXc)?range:undefined;}
function spreadRange(getters,ranges){const postProcessedRanges=[];for(const range of ranges){if(!getters.isRangeValid(range)){postProcessedRanges.push(range);continue;}
const{sheetName}=splitReference(range);const sheetPrefix=sheetName?`${sheetName}!`:"";const zone=toUnboundedZone(range);if(zone.bottom!==zone.top&&zone.left!=zone.right){if(zone.right){for(let j=zone.left;j<=zone.right;++j){postProcessedRanges.push(`${sheetPrefix}${zoneToXc({
                        left: j,
                        right: j,
                        top: zone.top,
                        bottom: zone.bottom,
                    })}`);}}
else{for(let j=zone.top;j<=zone.bottom;++j){postProcessedRanges.push(`${sheetPrefix}${zoneToXc({
                        left: zone.left,
                        right: zone.right,
                        top: j,
                        bottom: j,
                    })}`);}}}
else{postProcessedRanges.push(range);}}
return postProcessedRanges;}
function getCellPositionsInRanges(ranges){const cellPositions=[];for(const range of ranges){for(const position of positions(range.zone)){cellPositions.push({...position,sheetId:range.sheetId});}}
return cellPositions;}
function fuzzyMatch(pattern,str){pattern=pattern.toLocaleLowerCase();str=str.toLocaleLowerCase();let totalScore=0;let currentScore=0;let len=str.length;let patternIndex=0;for(let i=0;i<len;i++){if(str[i]===pattern[patternIndex]){patternIndex++;currentScore+=100+currentScore-i/200;}
else{currentScore=0;}
totalScore=totalScore+currentScore;}
return patternIndex===pattern.length?totalScore:0;}
function fuzzyLookup(pattern,list,fn){const results=[];list.forEach((data)=>{const score=fuzzyMatch(pattern,fn(data));if(score>0){results.push({score,elem:data});}});results.sort((a,b)=>b.score-a.score);return results.map((r)=>r.elem);}
function createDefaultRows(rowNumber){const rows=[];for(let i=0;i<rowNumber;i++){const row={cells:{},};rows.push(row);}
return rows;}
function moveHeaderIndexesOnHeaderAddition(indexHeaderAdded,numberAdded,headers){return headers.map((header)=>{if(header>=indexHeaderAdded){return header+numberAdded;}
return header;});}
function moveHeaderIndexesOnHeaderDeletion(deletedHeaders,headers){deletedHeaders=[...deletedHeaders].sort((a,b)=>b-a);return headers.map((header)=>{for(const deletedHeader of deletedHeaders){if(header>deletedHeader){header--;}
else if(header===deletedHeader){return undefined;}}
return header;}).filter(isDefined$1);}
function computeTextLinesHeight(textLineHeight,numberOfLines=1){return numberOfLines*(textLineHeight+MIN_CELL_TEXT_MARGIN)-MIN_CELL_TEXT_MARGIN;}
function getDefaultCellHeight(ctx,cell,colSize){if(!cell||(!cell.isFormula&&!cell.content)){return DEFAULT_CELL_HEIGHT;}
const maxWidth=cell.style?.wrapping==="wrap"?colSize-2*MIN_CELL_TEXT_MARGIN:undefined;const numberOfLines=cell.isFormula?1:splitTextToWidth(ctx,cell.content,cell.style,maxWidth).length;const fontSize=computeTextFontSizeInPixels(cell.style);return computeTextLinesHeight(fontSize,numberOfLines)+2*PADDING_AUTORESIZE_VERTICAL;}
const textWidthCache={};function computeTextWidth(context,text,style){const font=computeTextFont(style);if(!textWidthCache[font]){textWidthCache[font]={};}
if(textWidthCache[font][text]===undefined){context.save();context.font=font;const textWidth=context.measureText(text).width;context.restore();textWidthCache[font][text]=textWidth;}
return textWidthCache[font][text];}
function fontSizeInPixels(fontSize){return Math.round((fontSize*96)/72);}
function computeTextFont(style){const italic=style.italic?"italic ":"";const weight=style.bold?"bold":DEFAULT_FONT_WEIGHT;const size=computeTextFontSizeInPixels(style);return`${italic}${weight} ${size}px ${DEFAULT_FONT}`;}
function computeTextFontSizeInPixels(style){const sizeInPt=style?.fontSize||DEFAULT_FONT_SIZE;return fontSizeInPixels(sizeInPt);}
function splitWordToSpecificWidth(ctx,word,width,style){const wordWidth=computeTextWidth(ctx,word,style);if(wordWidth<=width){return[word];}
const splitWord=[];let wordPart="";for(let l of word){const wordPartWidth=computeTextWidth(ctx,wordPart+l,style);if(wordPartWidth>width){splitWord.push(wordPart);wordPart=l;}
else{wordPart+=l;}}
splitWord.push(wordPart);return splitWord;}
function splitTextToWidth(ctx,text,style,width){if(!style)
style={};const brokenText=[];const lines=text.includes(NEWLINE)?text.split(NEWLINE):[text];for(const line of lines){const words=line.includes(" ")?line.split(" "):[line];if(!width){brokenText.push(line);continue;}
let textLine="";let availableWidth=width;for(let word of words){const splitWord=splitWordToSpecificWidth(ctx,word,width,style);const lastPart=splitWord.pop();const lastPartWidth=computeTextWidth(ctx,lastPart,style);if(splitWord.length){if(textLine!==""){brokenText.push(textLine);textLine="";availableWidth=width;}
splitWord.forEach((wordPart)=>{brokenText.push(wordPart);});textLine=lastPart;availableWidth=width-lastPartWidth;}
else{const _word=textLine===""?lastPart:" "+lastPart;const wordWidth=computeTextWidth(ctx,_word,style);if(wordWidth<=availableWidth){textLine+=_word;availableWidth-=wordWidth;}
else{brokenText.push(textLine);textLine=lastPart;availableWidth=width-lastPartWidth;}}}
if(textLine!==""){brokenText.push(textLine);}}
return brokenText;}
function getFontSizeMatchingWidth(lineWidth,maxFontSize,getTextWidth,precision=0.25){let minFontSize=1;if(getTextWidth(minFontSize)>lineWidth)
return minFontSize;if(getTextWidth(maxFontSize)<lineWidth)
return maxFontSize;let fontSize=(minFontSize+maxFontSize)/2;let currentTextWidth=getTextWidth(fontSize);let iterations=0;while(Math.abs(currentTextWidth-lineWidth)>precision&&iterations<20){if(currentTextWidth>=lineWidth){maxFontSize=(minFontSize+maxFontSize)/2;}
else{minFontSize=(minFontSize+maxFontSize)/2;}
fontSize=(minFontSize+maxFontSize)/2;currentTextWidth=getTextWidth(fontSize);iterations++;}
return fontSize;}
function computeIconWidth(style){return computeTextFontSizeInPixels(style)+2*MIN_CF_ICON_MARGIN;}
function toLowerCase(str){return str?str.toLowerCase():"";}
const pxRegex=/([0-9\.]*)px/;function getContextFontSize(font){return Number(font.match(pxRegex)?.[1]);}
function drawDecoratedText(context,text,position,underline=false,strikethrough=false,strokeWidth=getContextFontSize(context.font)/10){context.fillText(text,position.x,position.y);if(!underline&&!strikethrough){return;}
const measure=context.measureText(text);const textWidth=measure.width;const textHeight=measure.actualBoundingBoxAscent+measure.actualBoundingBoxDescent;const boxHeight=measure.fontBoundingBoxAscent+measure.fontBoundingBoxDescent;let{x,y}=position;let strikeY=y,underlineY=y;switch(context.textAlign){case"center":x-=textWidth/2;break;case"right":x-=textWidth;break;}
switch(context.textBaseline){case"top":underlineY+=boxHeight-2*strokeWidth;strikeY+=boxHeight/2-strokeWidth;break;case"middle":underlineY+=boxHeight/2-strokeWidth;break;case"alphabetic":underlineY+=2*strokeWidth;strikeY-=3*strokeWidth;break;case"bottom":underlineY=y;strikeY-=textHeight/2-strokeWidth/2;break;}
if(underline){context.lineWidth=strokeWidth;context.strokeStyle=context.fillStyle;context.beginPath();context.moveTo(x,underlineY);context.lineTo(x+textWidth,underlineY);context.stroke();}
if(strikethrough){context.lineWidth=strokeWidth;context.strokeStyle=context.fillStyle;context.beginPath();context.moveTo(x,strikeY);context.lineTo(x+textWidth,strikeY);context.stroke();}}
class UuidGenerator{isFastIdStrategy=false;fastIdStart=0;setIsFastStrategy(isFast){this.isFastIdStrategy=isFast;}
uuidv4(){if(this.isFastIdStrategy){this.fastIdStart++;return String(this.fastIdStart);}
else if(window.crypto&&window.crypto.getRandomValues){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(c)=>(c^(crypto.getRandomValues(new Uint8Array(1))[0]&(15>>(c/4)))).toString(16));}
else{return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(Math.random()*16)|0,v=c==="x"?r:(r&0x3)|0x8;return v.toString(16);});}}}
function createActions(menuItems){return menuItems.map(createAction).sort((a,b)=>a.sequence-b.sequence);}
const uuidGenerator$2=new UuidGenerator();function createAction(item){const name=item.name;const children=item.children;const description=item.description;const icon=item.icon;return{id:item.id||uuidGenerator$2.uuidv4(),name:typeof name==="function"?name:()=>name,isVisible:item.isVisible?item.isVisible:()=>true,isEnabled:item.isEnabled?item.isEnabled:()=>true,isActive:item.isActive,execute:item.execute,children:children?(env)=>{return children.map((child)=>(typeof child==="function"?child(env):child)).flat().map(createAction);}:()=>[],isReadonlyAllowed:item.isReadonlyAllowed||false,separator:item.separator||false,icon:typeof icon==="function"?icon:()=>icon||"",description:typeof description==="function"?description:()=>description||"",textColor:item.textColor,sequence:item.sequence||0,};}
function transformZone(zone,executed){if(executed.type==="REMOVE_COLUMNS_ROWS"){return reduceZoneOnDeletion(zone,executed.dimension==="COL"?"left":"top",executed.elements);}
if(executed.type==="ADD_COLUMNS_ROWS"){return expandZoneOnInsertion(zone,executed.dimension==="COL"?"left":"top",executed.base,executed.position,executed.quantity);}
return{...zone};}
function transformRangeData(range,executed){const deletedSheet=executed.type==="DELETE_SHEET"&&executed.sheetId;if("sheetId"in executed&&range._sheetId!==executed.sheetId){return range;}
else{const newZone=transformZone(range._zone,executed);if(newZone&&deletedSheet!==range._sheetId){return{...range,_zone:newZone};}}
return undefined;}
class ChartJsComponent extends owl.Component{static template="o-spreadsheet-ChartJsComponent";canvas=owl.useRef("graphContainer");chart;currentRuntime;get background(){return this.chartRuntime.background;}
get canvasStyle(){return`background-color: ${this.background}`;}
get chartRuntime(){const runtime=this.env.model.getters.getChartRuntime(this.props.figure.id);if(!("chartJsConfig"in runtime)){throw new Error("Unsupported chart runtime");}
return runtime;}
setup(){owl.onMounted(()=>{const runtime=this.chartRuntime;this.currentRuntime=runtime;this.createChart(deepCopy(runtime.chartJsConfig));});owl.useEffect(()=>{const runtime=this.chartRuntime;if(!deepEquals(runtime,this.currentRuntime,"ignoreFunctions")){this.currentRuntime=runtime;this.updateChartJs(deepCopy(runtime));}});}
createChart(chartData){const canvas=this.canvas.el;const ctx=canvas.getContext("2d");this.chart=new window.Chart(ctx,chartData);}
updateChartJs(chartRuntime){const chartData=chartRuntime.chartJsConfig;if(chartData.data&&chartData.data.datasets){this.chart.data=chartData.data;if(chartData.options?.plugins?.title){this.chart.config.options.plugins.title=chartData.options.plugins.title;}
if(chartData.options&&"valueLabel"in chartData.options){if(chartData.options?.valueLabel){this.chart.config.options.valueLabel=chartData.options.valueLabel;}}}
else{this.chart.data.datasets=[];}
this.chart.config.options.plugins.tooltip=chartData.options.plugins.tooltip;this.chart.config.options.plugins.legend=chartData.options.plugins.legend;this.chart.config.options.scales=chartData.options?.scales;this.chart.update();}}
ChartJsComponent.props={figure:Object,};class AbstractChart{sheetId;title;getters;constructor(definition,sheetId,getters){this.title=definition.title;this.sheetId=sheetId;this.getters=getters;}
static validateChartDefinition(validator,definition){throw new Error("This method should be implemented by sub class");}
static transformDefinition(definition,executed){throw new Error("This method should be implemented by sub class");}
static getDefinitionFromContextCreation(context){throw new Error("This method should be implemented by sub class");}}
function updateChartRangesWithDataSets(getters,applyChange,chartDataSets,chartLabelRange){let isStale=false;const dataSetsWithUndefined=[];for(let index in chartDataSets){let ds=chartDataSets[index];if(ds.labelCell){const labelCell=adaptChartRange(ds.labelCell,applyChange);if(ds.labelCell!==labelCell){isStale=true;ds={...ds,labelCell:labelCell,};}}
const dataRange=adaptChartRange(ds.dataRange,applyChange);if(dataRange===undefined||getters.getRangeString(dataRange,dataRange.sheetId)===INCORRECT_RANGE_STRING){isStale=true;ds=undefined;}
else if(dataRange!==ds.dataRange){isStale=true;ds={...ds,dataRange,};}
dataSetsWithUndefined[index]=ds;}
let labelRange=chartLabelRange;const range=adaptChartRange(labelRange,applyChange);if(range!==labelRange){isStale=true;labelRange=range;}
const dataSets=dataSetsWithUndefined.filter(isDefined$1);return{isStale,dataSets,labelRange,};}
function copyDataSetsWithNewSheetId(sheetIdFrom,sheetIdTo,dataSets){return dataSets.map((ds)=>{return{dataRange:copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,ds.dataRange),labelCell:ds.labelCell?copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,ds.labelCell):undefined,};});}
function copyLabelRangeWithNewSheetId(sheetIdFrom,sheetIdTo,range){return range?copyRangeWithNewSheetId(sheetIdFrom,sheetIdTo,range):undefined;}
function adaptChartRange(range,applyChange){if(!range){return undefined;}
const change=applyChange(range);switch(change.changeType){case"NONE":return range;case"REMOVE":return undefined;default:return change.range;}}
function createDataSets(getters,dataSetsString,sheetId,dataSetsHaveTitle){const dataSets=[];for(const sheetXC of dataSetsString){const dataRange=getters.getRangeFromSheetXC(sheetId,sheetXC);const{unboundedZone:zone,sheetId:dataSetSheetId,invalidSheetName,invalidXc}=dataRange;if(invalidSheetName||invalidXc){continue;}
if(zone.left!==zone.right&&zone.top!==zone.bottom){if(zone.right===undefined){continue;}
for(let column=zone.left;column<=zone.right;column++){const columnZone={...zone,left:column,right:column,};dataSets.push(createDataSet(getters,dataSetSheetId,columnZone,dataSetsHaveTitle?{top:columnZone.top,bottom:columnZone.top,left:columnZone.left,right:columnZone.left,}:undefined));}}
else{dataSets.push(createDataSet(getters,dataSetSheetId,zone,dataSetsHaveTitle?{top:zone.top,bottom:zone.top,left:zone.left,right:zone.left,}:undefined));}}
return dataSets;}
function createDataSet(getters,sheetId,fullZone,titleZone){if(fullZone.left!==fullZone.right&&fullZone.top!==fullZone.bottom){throw new Error(`Zone should be a single column or row: ${zoneToXc(fullZone)}`);}
if(titleZone){const dataXC=zoneToXc(fullZone);const labelCellXC=zoneToXc(titleZone);return{labelCell:getters.getRangeFromSheetXC(sheetId,labelCellXC),dataRange:getters.getRangeFromSheetXC(sheetId,dataXC),};}
else{return{labelCell:undefined,dataRange:getters.getRangeFromSheetXC(sheetId,zoneToXc(fullZone)),};}}
function toExcelDataset(getters,ds){const labelZone=ds.labelCell?.zone;let dataZone=ds.dataRange.zone;if(labelZone){const{numberOfRows,numberOfCols}=zoneToDimension(dataZone);if(numberOfRows===1){dataZone={...dataZone,left:dataZone.left+1};}
else if(numberOfCols===1){dataZone={...dataZone,top:dataZone.top+1};}}
const dataRange=ds.dataRange.clone({zone:dataZone});return{label:ds.labelCell?getters.getRangeString(ds.labelCell,"forceSheetReference",{useFixedReference:true}):undefined,range:getters.getRangeString(dataRange,"forceSheetReference",{useFixedReference:true}),};}
function toExcelLabelRange(getters,labelRange,shouldRemoveFirstLabel){if(!labelRange)
return undefined;let zone={...labelRange.zone,};if(shouldRemoveFirstLabel&&labelRange.zone.bottom>labelRange.zone.top){zone.top=zone.top+1;}
const range=labelRange.clone({zone});return getters.getRangeString(range,"forceSheetReference",{useFixedReference:true});}
function transformChartDefinitionWithDataSetsWithZone(definition,executed){let labelRange;if(definition.labelRange){const labelZone=transformZone(toUnboundedZone(definition.labelRange),executed);labelRange=labelZone?zoneToXc(labelZone):undefined;}
const dataSets=definition.dataSets.map(toUnboundedZone).map((zone)=>transformZone(zone,executed)).filter(isDefined$1).map(zoneToXc);return{...definition,labelRange,dataSets,};}
const GraphColors=["rgb(31,119,180)","rgb(255,127,14)","rgb(174,199,232)","rgb(255,187,120)","rgb(44,160,44)","rgb(152,223,138)","rgb(214,39,40)","rgb(255,152,150)","rgb(148,103,189)","rgb(197,176,213)","rgb(140,86,75)","rgb(196,156,148)","rgb(227,119,194)","rgb(247,182,210)","rgb(127,127,127)","rgb(199,199,199)","rgb(188,189,34)","rgb(219,219,141)","rgb(23,190,207)","rgb(158,218,229)",];class ChartColors{graphColorIndex=0;next(){return GraphColors[this.graphColorIndex++%GraphColors.length];}}
function chartFontColor(backgroundColor){if(!backgroundColor){return"#000000";}
return relativeLuminance(backgroundColor)<0.3?"#FFFFFF":"#000000";}
function checkDataset(definition){if(definition.dataSets){const invalidRanges=definition.dataSets.find((range)=>!rangeReference.test(range))!==undefined;if(invalidRanges){return"InvalidDataSet";}
const zones=definition.dataSets.map(toUnboundedZone);if(zones.some((zone)=>zone.top!==zone.bottom&&isFullRow(zone))){return"InvalidDataSet";}}
return"Success";}
function checkLabelRange(definition){if(definition.labelRange){const invalidLabels=!rangeReference.test(definition.labelRange||"");if(invalidLabels){return"InvalidLabelRange";}}
return"Success";}
function shouldRemoveFirstLabel(labelRange,dataset,dataSetsHaveTitle){if(!dataSetsHaveTitle)
return false;if(!labelRange)
return false;if(!dataset)
return true;const datasetLength=getZoneArea(dataset.dataRange.zone);const labelLength=getZoneArea(labelRange.zone);if(labelLength<datasetLength){return false;}
return true;}
function getBaselineText(baseline,keyValue,baselineMode,locale){if(!baseline){return"";}
else if(baselineMode==="text"||keyValue?.type!==CellValueType.number||baseline.type!==CellValueType.number){return baseline.formattedValue;}
else{let diff=keyValue.value-baseline.value;if(baselineMode==="percentage"&&diff!==0){diff=(diff/baseline.value)*100;}
if(baselineMode!=="percentage"&&baseline.format){return formatValue(diff,{format:baseline.format,locale});}
const baselineStr=Math.abs(parseFloat(diff.toFixed(2))).toLocaleString();return baselineMode==="percentage"?baselineStr+"%":baselineStr;}}
function getBaselineColor(baseline,baselineMode,keyValue,colorUp,colorDown){if(baselineMode==="text"||baseline?.type!==CellValueType.number||keyValue?.type!==CellValueType.number){return undefined;}
const diff=keyValue.value-baseline.value;if(diff>0){return colorUp;}
else if(diff<0){return colorDown;}
return undefined;}
function getBaselineArrowDirection(baseline,keyValue,baselineMode){if(baselineMode==="text"||baseline?.type!==CellValueType.number||keyValue?.type!==CellValueType.number){return"neutral";}
const diff=keyValue.value-baseline.value;if(diff>0){return"up";}
else if(diff<0){return"down";}
return"neutral";}
function getChartPositionAtCenterOfViewport(getters,chartSize){const{x,y}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();const{width,height}=getters.getVisibleRect(getters.getActiveMainViewport());const position={x:x+scrollX+Math.max(0,(width-chartSize.width)/2),y:y+scrollY+Math.max(0,(height-chartSize.height)/2),};return position;}
function checkKeyValue(definition){return definition.keyValue&&!rangeReference.test(definition.keyValue)?"InvalidScorecardKeyValue":"Success";}
function checkBaseline(definition){return definition.baseline&&!rangeReference.test(definition.baseline)?"InvalidScorecardBaseline":"Success";}
const arrowDownPath=new window.Path2D("M8.6 4.8a.5.5 0 0 1 0 .75l-3.9 3.9a.5 .5 0 0 1 -.75 0l-3.8 -3.9a.5 .5 0 0 1 0 -.75l.4-.4a.5.5 0 0 1 .75 0l2.3 2.4v-5.7c0-.25.25-.5.5-.5h.6c.25 0 .5.25.5.5v5.8l2.3 -2.4a.5.5 0 0 1 .75 0z");const arrowUpPath=new window.Path2D("M8.7 5.5a.5.5 0 0 0 0-.75l-3.8-4a.5.5 0 0 0-.75 0l-3.8 4a.5.5 0 0 0 0 .75l.4.4a.5.5 0 0 0 .75 0l2.3-2.4v5.8c0 .25.25.5.5.5h.6c.25 0 .5-.25.5-.5v-5.8l2.2 2.4a.5.5 0 0 0 .75 0z");let ScorecardChart$1=class ScorecardChart extends AbstractChart{keyValue;baseline;baselineMode;baselineDescr;background;baselineColorUp;baselineColorDown;fontColor;type="scorecard";constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.keyValue=createValidRange(getters,sheetId,definition.keyValue);this.baseline=createValidRange(getters,sheetId,definition.baseline);this.baselineMode=definition.baselineMode;this.baselineDescr=definition.baselineDescr;this.background=definition.background;this.baselineColorUp=definition.baselineColorUp;this.baselineColorDown=definition.baselineColorDown;}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkKeyValue,checkBaseline);}
static getDefinitionFromContextCreation(context){return{background:context.background,type:"scorecard",keyValue:context.range?context.range[0]:undefined,title:context.title||"",baselineMode:DEFAULT_SCORECARD_BASELINE_MODE,baselineColorUp:DEFAULT_SCORECARD_BASELINE_COLOR_UP,baselineColorDown:DEFAULT_SCORECARD_BASELINE_COLOR_DOWN,baseline:context.auxiliaryRange||"",};}
static transformDefinition(definition,executed){let baselineZone;let keyValueZone;if(definition.baseline){baselineZone=transformZone(toUnboundedZone(definition.baseline),executed);}
if(definition.keyValue){keyValueZone=transformZone(toUnboundedZone(definition.keyValue),executed);}
return{...definition,baseline:baselineZone?zoneToXc(baselineZone):undefined,keyValue:keyValueZone?zoneToXc(keyValueZone):undefined,};}
copyForSheetId(sheetId){const baseline=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.baseline);const keyValue=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.keyValue);const definition=this.getDefinitionWithSpecificRanges(baseline,keyValue,sheetId);return new ScorecardChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificRanges(this.baseline,this.keyValue,sheetId);return new ScorecardChart(definition,sheetId,this.getters);}
getDefinition(){return this.getDefinitionWithSpecificRanges(this.baseline,this.keyValue);}
getContextCreation(){return{background:this.background,title:this.title,range:this.keyValue?[this.getters.getRangeString(this.keyValue,this.sheetId)]:undefined,auxiliaryRange:this.baseline?this.getters.getRangeString(this.baseline,this.sheetId):undefined,};}
getDefinitionWithSpecificRanges(baseline,keyValue,targetSheetId){return{baselineColorDown:this.baselineColorDown,baselineColorUp:this.baselineColorUp,baselineMode:this.baselineMode,title:this.title,type:"scorecard",background:this.background,baseline:baseline?this.getters.getRangeString(baseline,targetSheetId||this.sheetId):undefined,baselineDescr:this.baselineDescr,keyValue:keyValue?this.getters.getRangeString(keyValue,targetSheetId||this.sheetId):undefined,};}
getDefinitionForExcel(){return undefined;}
updateRanges(applyChange){const baseline=adaptChartRange(this.baseline,applyChange);const keyValue=adaptChartRange(this.keyValue,applyChange);if(this.baseline===baseline&&this.keyValue===keyValue){return this;}
const definition=this.getDefinitionWithSpecificRanges(baseline,keyValue);return new ScorecardChart(definition,this.sheetId,this.getters);}};function drawScoreChart(structure,canvas){const ctx=canvas.getContext("2d");canvas.width=structure.canvas.width;canvas.height=structure.canvas.height;ctx.fillStyle=structure.canvas.backgroundColor;ctx.fillRect(0,0,structure.canvas.width,structure.canvas.height);if(structure.title){ctx.font=structure.title.style.font;ctx.fillStyle=structure.title.style.color;ctx.fillText(structure.title.text,structure.title.position.x,structure.title.position.y);}
if(structure.baseline){ctx.font=structure.baseline.style.font;ctx.fillStyle=structure.baseline.style.color;drawDecoratedText(ctx,structure.baseline.text,structure.baseline.position,structure.baseline.style.underline,structure.baseline.style.strikethrough);}
if(structure.baselineArrow&&structure.baselineArrow.style.size>0){ctx.save();ctx.fillStyle=structure.baselineArrow.style.color;ctx.translate(structure.baselineArrow.position.x,structure.baselineArrow.position.y);const ratio=structure.baselineArrow.style.size/10;ctx.scale(ratio,ratio);switch(structure.baselineArrow.direction){case"down":{ctx.fill(arrowDownPath);break;}
case"up":{ctx.fill(arrowUpPath);break;}}
ctx.restore();}
if(structure.baselineDescr){ctx.font=structure.baselineDescr.style.font;ctx.fillStyle=structure.baselineDescr.style.color;ctx.fillText(structure.baselineDescr.text,structure.baselineDescr.position.x,structure.baselineDescr.position.y);}
if(structure.key){ctx.font=structure.key.style.font;ctx.fillStyle=structure.key.style.color;drawDecoratedText(ctx,structure.key.text,structure.key.position,structure.key.style.underline,structure.key.style.strikethrough);}}
function createScorecardChartRuntime(chart,getters){let keyValue="";let formattedKeyValue="";let keyValueCell;if(chart.keyValue){const keyValuePosition={sheetId:chart.keyValue.sheetId,col:chart.keyValue.zone.left,row:chart.keyValue.zone.top,};keyValueCell=getters.getEvaluatedCell(keyValuePosition);keyValue=String(keyValueCell.value);formattedKeyValue=keyValueCell.formattedValue;}
let baselineCell;const baseline=chart.baseline;if(baseline){const baselinePosition={sheetId:chart.baseline.sheetId,col:chart.baseline.zone.left,row:chart.baseline.zone.top,};baselineCell=getters.getEvaluatedCell(baselinePosition);}
const{background,fontColor}=getters.getStyleOfSingleCellChart(chart.background,chart.keyValue);const locale=getters.getLocale();return{title:_t(chart.title),keyValue:formattedKeyValue||keyValue,baselineDisplay:getBaselineText(baselineCell,keyValueCell,chart.baselineMode,locale),baselineArrow:getBaselineArrowDirection(baselineCell,keyValueCell,chart.baselineMode),baselineColor:getBaselineColor(baselineCell,chart.baselineMode,keyValueCell,chart.baselineColorUp,chart.baselineColorDown),baselineDescr:chart.baselineDescr?_t(chart.baselineDescr):"",fontColor,background,baselineStyle:chart.baselineMode!=="percentage"&&baseline?getters.getCellStyle({sheetId:baseline.sheetId,col:baseline.zone.left,row:baseline.zone.top,}):undefined,keyValueStyle:chart.keyValue?getters.getCellStyle({sheetId:chart.keyValue.sheetId,col:chart.keyValue.zone.left,row:chart.keyValue.zone.top,}):undefined,};}
const TITLE_FONT_SIZE=18;const BASELINE_BOX_HEIGHT_RATIO=0.35;const KEY_BOX_HEIGHT_RATIO=0.65;const BASELINE_DESCR_FONT_RATIO=0.9;const CHART_PADDING_RATIO=0.02;const LINE_HEIGHT=1.2;function formatBaselineDescr(baselineDescr,baseline){const _baselineDescr=baselineDescr||"";return baseline&&_baselineDescr?" "+_baselineDescr:_baselineDescr;}
function getDefaultContextFont(fontSize,bold=false,italic=false){const italicStr=italic?"italic":"";const weight=bold?"bold":"";return`${italicStr} ${weight} ${fontSize}px ${DEFAULT_FONT}`;}
function getScorecardConfiguration({width,height},runtime){const designer=new ScorecardChartConfigBuilder({width,height},runtime);return designer.computeDesign();}
class ScorecardChartConfigBuilder{runtime;context;width;height;constructor({width,height},runtime){this.runtime=runtime;const canvas=document.createElement("canvas");this.width=canvas.width=width;this.height=canvas.height=height;this.context=canvas.getContext("2d");}
computeDesign(){const structure={canvas:{width:this.width,height:this.height,backgroundColor:this.backgroundColor,},};const style=this.getTextStyles();const{height:titleHeight}=this.getTextDimensions(this.title,style.title.font);if(this.title){structure.title={text:this.title,style:style.title,position:{x:this.chartPadding,y:this.chartPadding+titleHeight,},};}
const baselineArrowSize=style.baselineArrow?.size??0;const{height:baselineHeight,width:baselineWidth}=this.getTextDimensions(this.baseline,style.baselineValue.font);const{width:baselineDescrWidth}=this.getTextDimensions(this.baselineDescr,style.baselineDescr.font);structure.baseline={text:this.baseline,style:style.baselineValue,position:{x:(this.width-baselineWidth-baselineDescrWidth+baselineArrowSize)/2,y:this.keyValue?this.height-2*this.chartPadding:this.height-(this.height-titleHeight-baselineHeight)/2-this.chartPadding,},};if(style.baselineArrow){structure.baselineArrow={direction:this.baselineArrow,style:style.baselineArrow,position:{x:structure.baseline.position.x-baselineArrowSize,y:structure.baseline.position.y-(baselineHeight+baselineArrowSize)/2,},};}
if(this.baselineDescr){structure.baselineDescr={text:this.baselineDescr,style:style.baselineDescr,position:{x:structure.baseline.position.x+baselineWidth,y:structure.baseline.position.y,},};}
const{height:keyHeight,width:keyWidth}=this.getTextDimensions(this.keyValue,style.keyValue.font);if(this.keyValue){structure.key={text:this.keyValue,style:style.keyValue,position:{x:(this.width-keyWidth)/2,y:(this.height-baselineHeight+titleHeight+keyHeight)/2-this.chartPadding,},};}
return structure;}
get title(){return this.runtime.title;}
get keyValue(){return this.runtime.keyValue;}
get baseline(){return this.runtime.baselineDisplay;}
get baselineDescr(){return formatBaselineDescr(this.runtime.baselineDescr,this.baseline);}
get baselineArrow(){return this.runtime.baselineArrow;}
get backgroundColor(){return this.runtime.background;}
get secondaryFontColor(){return relativeLuminance(this.backgroundColor)>0.3?"#525252":"#C8C8C8";}
get chartPadding(){return this.width*CHART_PADDING_RATIO;}
getTextDimensions(text,font){this.context.font=font;const measure=this.context.measureText(text);return{width:measure.width,height:measure.actualBoundingBoxAscent+measure.actualBoundingBoxDescent,};}
getTextStyles(){const maxLineWidth=this.width*(1-2*CHART_PADDING_RATIO);const widestElement=this.getWidestElement();const baseFontSize=widestElement.getElementMaxFontSize(this.getDrawableHeight(),this);const fontSizeMatchingWidth=getFontSizeMatchingWidth(maxLineWidth,baseFontSize,(fontSize)=>widestElement.getElementWidth(fontSize,this.context,this));let scalingFactor=fontSizeMatchingWidth/baseFontSize;const keyFontSize=new KeyValueElement(this.runtime.keyValueStyle).getElementMaxFontSize(this.getDrawableHeight(),this)*scalingFactor;const baselineFontSize=new BaselineElement(this.runtime.baselineStyle).getElementMaxFontSize(this.getDrawableHeight(),this)*scalingFactor;return{title:{font:getDefaultContextFont(TITLE_FONT_SIZE),color:this.secondaryFontColor,},keyValue:{color:this.runtime.keyValueStyle?.textColor||this.runtime.fontColor,font:getDefaultContextFont(keyFontSize,this.runtime.keyValueStyle?.bold,this.runtime.keyValueStyle?.italic),strikethrough:this.runtime.keyValueStyle?.strikethrough,underline:this.runtime.keyValueStyle?.underline,},baselineValue:{font:getDefaultContextFont(baselineFontSize,this.runtime.baselineStyle?.bold,this.runtime.baselineStyle?.italic),strikethrough:this.runtime.baselineStyle?.strikethrough,underline:this.runtime.baselineStyle?.underline,color:this.runtime.baselineStyle?.textColor||this.runtime.baselineColor||this.secondaryFontColor,},baselineDescr:{font:getDefaultContextFont(baselineFontSize*BASELINE_DESCR_FONT_RATIO),color:this.secondaryFontColor,},baselineArrow:this.baselineArrow==="neutral"?undefined:{size:this.keyValue?0.8*baselineFontSize:0,color:this.runtime.baselineColor||this.secondaryFontColor,},};}
getDrawableHeight(){const verticalPadding=2*this.chartPadding;let availableHeight=this.height-verticalPadding;availableHeight-=this.title?TITLE_FONT_SIZE*LINE_HEIGHT:0;return availableHeight;}
getWidestElement(){const baseline=new BaselineElement(this.runtime.baselineStyle);const keyValue=new KeyValueElement(this.runtime.keyValueStyle);return baseline.getElementWidth(BASELINE_BOX_HEIGHT_RATIO,this.context,this)>keyValue.getElementWidth(KEY_BOX_HEIGHT_RATIO,this.context,this)?baseline:keyValue;}}
class ScorecardScalableElement{style;constructor(style={}){this.style=style;}
measureTextWidth(ctx,text,fontSize){ctx.font=getDefaultContextFont(fontSize,this.style.bold,this.style.italic);return ctx.measureText(text).width;}}
class BaselineElement extends ScorecardScalableElement{getElementWidth(fontSize,ctx,chart){if(!chart.runtime){return 0;}
const baselineStr=chart.baseline;const largeText=chart.baselineArrow!=="neutral"?"A "+baselineStr:baselineStr;let textWidth=this.measureTextWidth(ctx,largeText,fontSize);textWidth+=this.measureTextWidth(ctx,chart.baselineDescr,fontSize*BASELINE_DESCR_FONT_RATIO);return textWidth;}
getElementMaxFontSize(availableHeight,chart){if(!chart.runtime){return 0;}
const haveBaseline=chart.baseline!==""||chart.baselineDescr;const maxHeight=haveBaseline?BASELINE_BOX_HEIGHT_RATIO*availableHeight:0;return maxHeight/LINE_HEIGHT;}}
class KeyValueElement extends ScorecardScalableElement{getElementWidth(fontSize,ctx,chart){if(!chart.runtime){return 0;}
const str=chart.keyValue||"";return this.measureTextWidth(ctx,str,fontSize);}
getElementMaxFontSize(availableHeight,chart){if(!chart.runtime){return 0;}
const haveBaseline=chart.baseline!==""||chart.baselineDescr;const maxHeight=haveBaseline?KEY_BOX_HEIGHT_RATIO*availableHeight:availableHeight;return maxHeight/LINE_HEIGHT;}}
class ScorecardChart extends owl.Component{static template="o-spreadsheet-ScorecardChart";canvas=owl.useRef("chartContainer");get runtime(){return this.env.model.getters.getChartRuntime(this.props.figure.id);}
setup(){owl.useEffect(this.createChart.bind(this),()=>{const canvas=this.canvas.el;const rect=canvas.getBoundingClientRect();return[rect.width,rect.height,this.runtime,this.canvas.el];});}
createChart(){const canvas=this.canvas.el;const config=getScorecardConfiguration(canvas.getBoundingClientRect(),this.runtime);drawScoreChart(config,canvas);}}
ScorecardChart.props={figure:Object,};class Registry{content={};add(key,value){this.content[key]=value;return this;}
get(key){const content=this.content[key];if(!content){if(!(key in this.content)){throw new Error(`Cannot find ${key} in this registry!`);}}
return content;}
contains(key){return key in this.content;}
getAll(){return Object.values(this.content);}
getKeys(){return Object.keys(this.content);}
remove(key){delete this.content[key];}}
function withHttps(url){return!/^https?:\/\//i.test(url)?`https://${url}`:url;}
const urlRegistry=new Registry();function createWebLink(url,label){url=withHttps(url);return{url,label:label||url,isExternal:true,isUrlEditable:true,};}
urlRegistry.add("sheet_URL",{match:(url)=>isSheetUrl(url),createLink:(url,label)=>{return{label,url,isExternal:false,isUrlEditable:false,};},urlRepresentation(url,getters){const sheetId=parseSheetUrl(url);return getters.tryGetSheetName(sheetId)||_t("Invalid sheet");},open(url,env){const sheetId=parseSheetUrl(url);env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:env.model.getters.getActiveSheetId(),sheetIdTo:sheetId,});},sequence:0,});const WebUrlSpec={createLink:createWebLink,match:(url)=>isWebLink(url),open:(url)=>window.open(url,"_blank"),urlRepresentation:(url)=>url,sequence:0,};function findMatchingSpec(url){return(urlRegistry.getAll().sort((a,b)=>a.sequence-b.sequence).find((urlType)=>urlType.match(url))||WebUrlSpec);}
function urlRepresentation(link,getters){return findMatchingSpec(link.url).urlRepresentation(link.url,getters);}
function openLink(link,env){findMatchingSpec(link.url).open(link.url,env);}
function detectLink(value){if(typeof value!=="string"){return undefined;}
if(isMarkdownLink(value)){const{label,url}=parseMarkdownLink(value);return findMatchingSpec(url).createLink(url,label);}
else if(isWebLink(value)){return createWebLink(value);}
return undefined;}
function evaluateLiteral(content,localeFormat){return createEvaluatedCell(parseLiteral(content||"",localeFormat.locale),localeFormat);}
function parseLiteral(content,locale){if(content.startsWith("=")){throw new Error(`Cannot parse "${content}" because it's not a literal value. It's a formula`);}
if(isNumber(content,DEFAULT_LOCALE)){return toNumber(content,DEFAULT_LOCALE);}
else if(isDateTime(content,locale)){return toNumber(content,locale);}
else if(isBoolean(content)){return content.toUpperCase()==="TRUE"?true:false;}
return content;}
function createEvaluatedCell(value,localeFormat){const link=detectLink(value);if(link){return{..._createEvaluatedCell(parseLiteral(link.label,localeFormat.locale),{format:localeFormat.format||detectDateFormat(link.label,localeFormat.locale)||detectNumberFormat(link.label),locale:localeFormat.locale,}),link,};}
return _createEvaluatedCell(value,localeFormat);}
function _createEvaluatedCell(value,localeFormat){try{for(const builder of builders){const evaluateCell=builder(value,localeFormat);if(evaluateCell){return evaluateCell;}}
return textCell((value||"").toString(),localeFormat);}
catch(error){return errorCell(new EvaluationError(CellErrorType.GenericError,error.message||DEFAULT_ERROR_MESSAGE));}}
function textCell(value,localeFormat){return{type:CellValueType.text,value,format:localeFormat.format,isAutoSummable:true,defaultAlign:"left",formattedValue:formatValue(value,localeFormat),};}
function numberCell(value,localeFormat){return{type:CellValueType.number,value:value||0,format:localeFormat.format,isAutoSummable:true,defaultAlign:"right",formattedValue:formatValue(value,localeFormat),};}
const EMPTY_EVALUATED_CELL={type:CellValueType.empty,value:"",format:undefined,isAutoSummable:true,defaultAlign:"left",formattedValue:"",};function emptyCell(localeFormat){if(localeFormat.format===undefined){return EMPTY_EVALUATED_CELL;}
return{type:CellValueType.empty,value:"",format:localeFormat.format,isAutoSummable:true,defaultAlign:"left",formattedValue:"",};}
function dateTimeCell(value,localeFormat){const formattedValue=formatValue(value,localeFormat);return{type:CellValueType.number,value,format:localeFormat.format,isAutoSummable:false,defaultAlign:"right",formattedValue,};}
function booleanCell(value,localeFormat){const formattedValue=value?"TRUE":"FALSE";return{type:CellValueType.boolean,value,format:localeFormat.format,isAutoSummable:false,defaultAlign:"center",formattedValue,};}
function errorCell(error){return{type:CellValueType.error,value:error.errorType,error,isAutoSummable:false,defaultAlign:"center",formattedValue:error.errorType,};}
const builders=[function createEmpty(value,localeFormat){if(value===""){return emptyCell(localeFormat);}
return undefined;},function createDateTime(value,localeFormat){if(!!localeFormat.format&&typeof value==="number"&&isDateTimeFormat(localeFormat.format)){return dateTimeCell(value,localeFormat);}
return undefined;},function createNumber(value,localeFormat){if(typeof value==="number"){return numberCell(value,localeFormat);}
else if(value===null){return numberCell(0,localeFormat);}
return undefined;},function createBoolean(value,localeFormat){if(typeof value==="boolean"){return booleanCell(value,localeFormat);}
return undefined;},];const autofillModifiersRegistry=new Registry();autofillModifiersRegistry.add("ALPHANUMERIC_INCREMENT_MODIFIER",{apply:(rule,data)=>{rule.current+=rule.increment;const content=`${rule.prefix}${rule.current
            .toString()
            .padStart(rule.numberPostfixLength || 0, "0")}`;return{cellData:{border:data.border,style:data.cell&&data.cell.style,format:data.cell&&data.cell.format,content,},tooltip:{props:{content}},};},}).add("INCREMENT_MODIFIER",{apply:(rule,data,getters)=>{rule.current+=rule.increment;const content=rule.current.toString();const locale=getters.getLocale();const tooltipValue=formatValue(rule.current,{format:data.cell?.format,locale});return{cellData:{border:data.border,style:data.cell&&data.cell.style,format:data.cell&&data.cell.format,content,},tooltip:content?{props:{content:tooltipValue}}:undefined,};},}).add("COPY_MODIFIER",{apply:(rule,data,getters)=>{const content=data.cell?.content||"";const localeFormat={locale:getters.getLocale(),format:data.cell?.format};return{cellData:{border:data.border,style:data.cell&&data.cell.style,format:data.cell&&data.cell.format,content,},tooltip:content?{props:{content:evaluateLiteral(data.cell?.content,localeFormat).formattedValue,},}:undefined,};},}).add("FORMULA_MODIFIER",{apply:(rule,data,getters,direction)=>{rule.current+=rule.increment;let x=0;let y=0;switch(direction){case"up":x=0;y=-rule.current;break;case"down":x=0;y=rule.current;break;case"left":x=-rule.current;y=0;break;case"right":x=rule.current;y=0;break;}
const cell=data.cell;if(!cell||!cell.isFormula){return{cellData:{}};}
const sheetId=data.sheetId;const content=getters.getTranslatedCellFormula(sheetId,x,y,cell.compiledFormula);return{cellData:{border:data.border,style:cell.style,format:cell.format,content,},tooltip:content?{props:{content}}:undefined,};},});const autofillRulesRegistry=new Registry();const numberPostfixRegExp=/(\d+)$/;const stringPrefixRegExp=/^(.*\D+)/;const alphaNumericValueRegExp=/^(.*\D+)(\d+)$/;function getGroup(cell,cells,filter){let group=[];let found=false;for(let x of cells){if(x===cell){found=true;}
const cellValue=x?.isFormula?undefined:evaluateLiteral(x?.content,{locale:DEFAULT_LOCALE});if(cellValue&&filter(cellValue)){group.push(cellValue);}
else{if(found){return group;}
group=[];}}
return group;}
function getAverageIncrement(group){const averages=[];let last=group[0];for(let i=1;i<group.length;i++){const current=group[i];averages.push(current-last);last=current;}
return averages.reduce((a,b)=>a+b,0)/averages.length;}
function calculateIncrementBasedOnGroup(group){let increment=1;if(group.length>=2){increment=getAverageIncrement(group)*group.length;}
return increment;}
autofillRulesRegistry.add("simple_value_copy",{condition:(cell,cells)=>{return(cells.length===1&&!cell.isFormula&&!(cell.format&&isDateTimeFormat(cell.format)));},generateRule:()=>{return{type:"COPY_MODIFIER"};},sequence:10,}).add("increment_alphanumeric_value",{condition:(cell)=>!cell.isFormula&&evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE}).type===CellValueType.text&&alphaNumericValueRegExp.test(cell.content),generateRule:(cell,cells)=>{const numberPostfix=parseInt(cell.content.match(numberPostfixRegExp)[0]);const prefix=cell.content.match(stringPrefixRegExp)[0];const numberPostfixLength=cell.content.length-prefix.length;const group=getGroup(cell,cells,(evaluatedCell)=>evaluatedCell.type===CellValueType.text&&alphaNumericValueRegExp.test(evaluatedCell.value)).filter((cell)=>prefix===cell.value.toString().match(stringPrefixRegExp)[0]).map((cell)=>parseInt(cell.value.toString().match(numberPostfixRegExp)[0]));const increment=calculateIncrementBasedOnGroup(group);return{type:"ALPHANUMERIC_INCREMENT_MODIFIER",prefix,current:numberPostfix,increment,numberPostfixLength,};},sequence:15,}).add("copy_text",{condition:(cell)=>!cell.isFormula&&evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE}).type===CellValueType.text,generateRule:()=>{return{type:"COPY_MODIFIER"};},sequence:20,}).add("update_formula",{condition:(cell)=>cell.isFormula,generateRule:(_,cells)=>{return{type:"FORMULA_MODIFIER",increment:cells.length,current:0};},sequence:30,}).add("increment_number",{condition:(cell)=>!cell.isFormula&&evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE}).type===CellValueType.number,generateRule:(cell,cells)=>{const group=getGroup(cell,cells,(evaluatedCell)=>evaluatedCell.type===CellValueType.number).map((cell)=>Number(cell.value));const increment=calculateIncrementBasedOnGroup(group);const evaluation=evaluateLiteral(cell.content,{locale:DEFAULT_LOCALE});return{type:"INCREMENT_MODIFIER",increment,current:evaluation.type===CellValueType.number?evaluation.value:0,};},sequence:40,});const STYLESHEETS={};let nextId=0;function css(strings,...args){const name=`__sheet__${nextId++}`;const value=String.raw(strings,...args);registerSheet(name,value);activateSheet(name);return name;}
function processSheet(str){const tokens=str.split(/(\{|\}|;)/).map((s)=>s.trim());const selectorStack=[];const parts=[];let rules=[];function generateSelector(stackIndex,parentSelector){const parts=[];for(const selector of selectorStack[stackIndex]){let part=(parentSelector&&parentSelector+" "+selector)||selector;if(part.includes("&")){part=selector.replace(/&/g,parentSelector||"");}
if(stackIndex<selectorStack.length-1){part=generateSelector(stackIndex+1,part);}
parts.push(part);}
return parts.join(", ");}
function generateRules(){if(rules.length){parts.push(generateSelector(0)+" {");parts.push(...rules);parts.push("}");rules=[];}}
while(tokens.length){let token=tokens.shift();if(token==="}"){generateRules();selectorStack.pop();}
else{if(tokens[0]==="{"){generateRules();selectorStack.push(token.split(/\s*,\s*/));tokens.shift();}
if(tokens[0]===";"){rules.push("  "+token+";");}}}
return parts.join("\n");}
function registerSheet(id,css){const sheet=document.createElement("style");sheet.textContent=processSheet(css);STYLESHEETS[id]=sheet;}
function activateSheet(id){const sheet=STYLESHEETS[id];sheet.setAttribute("component",id);document.head.appendChild(sheet);}
function getTextDecoration({strikethrough,underline,}){if(!strikethrough&&!underline){return"none";}
return`${strikethrough ? "line-through" : ""} ${underline ? "underline" : ""}`;}
function cellStyleToCss(style){const attributes=cellTextStyleToCss(style);if(!style)
return attributes;if(style.fillColor){attributes["background"]=style.fillColor;}
return attributes;}
function cellTextStyleToCss(style){const attributes={};if(!style)
return attributes;if(style.bold){attributes["font-weight"]="bold";}
if(style.italic){attributes["font-style"]="italic";}
if(style.strikethrough||style.underline){let decoration=style.strikethrough?"line-through":"";decoration=style.underline?decoration+" underline":decoration;attributes["text-decoration"]=decoration;}
if(style.textColor){attributes["color"]=style.textColor;}
return attributes;}
function cssPropertiesToCss(attributes){let styleStr="";for(const attName in attributes){if(!attributes[attName]){continue;}
styleStr+=`${attName}:${attributes[attName]}; `;}
return styleStr;}
function getElementMargins(el){const style=window.getComputedStyle(el);const margins={top:parseInt(style.marginTop,10)||0,bottom:parseInt(style.marginBottom,10)||0,left:parseInt(style.marginLeft,10)||0,right:parseInt(style.marginRight,10)||0,};return margins;}
const ERROR_TOOLTIP_MAX_HEIGHT=80;const ERROR_TOOLTIP_WIDTH=180;css`
  .o-error-tooltip {
    font-size: 13px;
    background-color: white;
    border-left: 3px solid red;
    padding: 10px;
    width: ${ERROR_TOOLTIP_WIDTH}px;
    box-sizing: border-box !important;
    overflow-wrap: break-word;

    .o-error-tooltip-message {
      overflow: hidden;
    }
  }
`;class ErrorToolTip extends owl.Component{static maxSize={maxHeight:ERROR_TOOLTIP_MAX_HEIGHT};static template="o-spreadsheet-ErrorToolTip";}
ErrorToolTip.props={errors:Array,onClosed:{type:Function,optional:true},};const ErrorToolTipPopoverBuilder={onHover:(position,getters)=>{const cell=getters.getEvaluatedCell(position);const errors=[];if(cell.type===CellValueType.error&&cell.error.isVerbose){errors.push({title:_t("Error"),message:cell.error.message,});}
const validationErrorMessage=getters.getInvalidDataValidationMessage(position);if(validationErrorMessage){errors.push({title:_t("Invalid"),message:validationErrorMessage,});}
if(!errors.length){return{isOpen:false};}
return{isOpen:true,props:{errors:errors},Component:ErrorToolTip,cellCorner:"TopRight",};},};css`
  .o-filter-menu-value {
    padding: 4px;
    line-height: 20px;
    height: 28px;
    .o-filter-menu-value-checked {
      width: 20px;
    }
  }
`;class FilterMenuValueItem extends owl.Component{static template="o-spreadsheet-FilterMenuValueItem";itemRef=owl.useRef("menuValueItem");setup(){owl.onWillPatch(()=>{if(this.props.scrolledTo){this.scrollListToSelectedValue();}});}
scrollListToSelectedValue(){if(!this.itemRef.el){return;}
this.itemRef.el.scrollIntoView?.({block:this.props.scrolledTo==="bottom"?"end":"start",});}}
FilterMenuValueItem.props={value:String,isChecked:Boolean,isSelected:Boolean,onMouseMove:Function,onClick:Function,scrolledTo:{type:String,optional:true},};const FILTER_MENU_HEIGHT=295;const CSS$2=css`
  .o-filter-menu {
    box-sizing: border-box;
    padding: 8px 16px;
    height: ${FILTER_MENU_HEIGHT}px;
    line-height: 1;

    .o-filter-menu-item {
      display: flex;
      box-sizing: border-box;
      height: ${MENU_ITEM_HEIGHT}px;
      padding: 4px 4px 4px 0px;
      cursor: pointer;
      user-select: none;

      &.selected {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    input {
      box-sizing: border-box;
      margin-bottom: 5px;
      border: 1px solid #949494;
      height: 24px;
      padding-right: 28px;
    }

    .o-search-icon {
      right: 5px;
      top: 4px;
      opacity: 0.4;

      svg {
        height: 16px;
        width: 16px;
        vertical-align: middle;
      }
    }

    .o-filter-menu-actions {
      display: flex;
      flex-direction: row;
      margin-bottom: 4px;

      .o-filter-menu-action-text {
        cursor: pointer;
        margin-right: 10px;
        color: blue;
        text-decoration: underline;
      }
    }

    .o-filter-menu-list {
      flex: auto;
      overflow-y: auto;
      border: 1px solid #949494;

      .o-filter-menu-no-values {
        color: #949494;
        font-style: italic;
      }
    }

    .o-filter-menu-buttons {
      margin-top: 9px;

      .o-filter-menu-button {
        border: 1px solid lightgrey;
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 500;
        line-height: 16px;
      }

      .o-filter-menu-button-cancel {
        background: white;
        &:hover {
          background-color: rgba(0, 0, 0, 0.08);
        }
      }

      .o-filter-menu-button-primary {
        background-color: #188038;
        &:hover {
          background-color: #1d9641;
        }
        color: white;
        font-weight: bold;
        margin-left: 10px;
      }
    }
  }
`;class FilterMenu extends owl.Component{static size={width:MENU_WIDTH,height:FILTER_MENU_HEIGHT};static template="o-spreadsheet-FilterMenu";static style=CSS$2;static components={FilterMenuValueItem};state=owl.useState({values:[],textFilter:"",selectedValue:undefined,});searchBar=owl.useRef("filterMenuSearchBar");setup(){owl.onWillUpdateProps((nextProps)=>{if(!deepEquals(nextProps.filterPosition,this.props.filterPosition)){this.state.values=this.getFilterValues(nextProps.filterPosition);}});this.state.values=this.getFilterValues(this.props.filterPosition);}
get isReadonly(){return this.env.model.getters.isReadonly();}
getFilterValues(position){const sheetId=this.env.model.getters.getActiveSheetId();const filter=this.env.model.getters.getFilter({sheetId,...position});if(!filter){return[];}
const cellValues=(filter.filteredZone?positions(filter.filteredZone):[]).filter(({row})=>!this.env.model.getters.isRowHidden(sheetId,row)).map(({col,row})=>this.env.model.getters.getEvaluatedCell({sheetId,col,row}).formattedValue);const filterValues=this.env.model.getters.getFilterValues({sheetId,...position});const strValues=[...cellValues,...filterValues];const normalizedFilteredValues=filterValues.map(toLowerCase);const normalizedValues=[...new Set(strValues.map(toLowerCase))];const sortedValues=normalizedValues.sort((val1,val2)=>val1.localeCompare(val2,undefined,{numeric:true,sensitivity:"base"}));return sortedValues.map((normalizedValue)=>{const checked=normalizedFilteredValues.findIndex((filteredValue)=>filteredValue===normalizedValue)===-1;return{checked,string:strValues.find((val)=>toLowerCase(val)===normalizedValue)||"",};});}
checkValue(value){this.state.selectedValue=value.string;value.checked=!value.checked;this.searchBar.el?.focus();}
onMouseMove(value){this.state.selectedValue=value.string;}
selectAll(){this.displayedValues.forEach((value)=>(value.checked=true));}
clearAll(){this.displayedValues.forEach((value)=>(value.checked=false));}
get filterTable(){const sheetId=this.env.model.getters.getActiveSheetId();const position=this.props.filterPosition;return this.env.model.getters.getFilterTable({sheetId,...position});}
get displayedValues(){if(!this.state.textFilter){return this.state.values;}
return fuzzyLookup(this.state.textFilter,this.state.values,(val)=>val.string);}
confirm(){const position=this.props.filterPosition;this.env.model.dispatch("UPDATE_FILTER",{...position,sheetId:this.env.model.getters.getActiveSheetId(),hiddenValues:this.state.values.filter((val)=>!val.checked).map((val)=>val.string),});this.props.onClosed?.();}
cancel(){this.props.onClosed?.();}
onKeyDown(ev){const displayedValues=this.displayedValues;if(displayedValues.length===0)
return;let selectedIndex=undefined;if(this.state.selectedValue!==undefined){const index=displayedValues.findIndex((val)=>val.string===this.state.selectedValue);selectedIndex=index===-1?undefined:index;}
switch(ev.key){case"ArrowDown":if(selectedIndex===undefined){selectedIndex=0;}
else{selectedIndex=Math.min(selectedIndex+1,displayedValues.length-1);}
ev.preventDefault();ev.stopPropagation();break;case"ArrowUp":if(selectedIndex===undefined){selectedIndex=displayedValues.length-1;}
else{selectedIndex=Math.max(selectedIndex-1,0);}
ev.preventDefault();ev.stopPropagation();break;case"Enter":if(selectedIndex!==undefined){this.checkValue(displayedValues[selectedIndex]);}
ev.stopPropagation();ev.preventDefault();break;}
this.state.selectedValue=selectedIndex!==undefined?displayedValues[selectedIndex].string:undefined;if(ev.key==="ArrowUp"||ev.key==="ArrowDown"){this.scrollListToSelectedValue(ev.key);}}
clearScrolledToValue(){this.state.values.forEach((val)=>(val.scrolledTo=undefined));}
scrollListToSelectedValue(arrow){this.clearScrolledToValue();const selectedValue=this.state.values.find((val)=>val.string===this.state.selectedValue);if(selectedValue){selectedValue.scrolledTo=arrow==="ArrowUp"?"top":"bottom";}}
sortFilterZone(sortDirection){const filterPosition=this.props.filterPosition;const filterTable=this.filterTable;if(!filterPosition||!filterTable||!filterTable.contentZone){return;}
const sheetId=this.env.model.getters.getActiveSheetId();this.env.model.dispatch("SORT_CELLS",{sheetId,col:filterPosition.col,row:filterTable.contentZone.top,zone:filterTable.contentZone,sortDirection,sortOptions:{emptyCellAsZero:true,sortHeaders:true},});this.props.onClosed?.();}}
FilterMenu.props={filterPosition:Object,onClosed:{type:Function,optional:true},};const FilterMenuPopoverBuilder={onOpen:(position,getters)=>{return{isOpen:true,props:{filterPosition:position},Component:FilterMenu,cellCorner:"BottomLeft",};},};const macRegex=/Mac/i;const MODIFIER_KEYS$1=["Shift","Control","Alt","Meta"];function isChildEvent(parent,ev){return!!ev.target&&parent.contains(ev.target);}
function gridOverlayPosition(){const spreadsheetElement=document.querySelector(".o-grid-overlay");if(spreadsheetElement){const{top,left}=spreadsheetElement?.getBoundingClientRect();return{top,left};}
throw new Error("Can't find spreadsheet position");}
function getBoundingRectAsPOJO(el){const rect=el.getBoundingClientRect();return{x:rect.x,y:rect.y,width:rect.width,height:rect.height,};}
function*iterateChildren(el){yield el;if(el.hasChildNodes()){for(let child of el.childNodes){yield*iterateChildren(child);}}}
function getOpenedMenus(){return Array.from(document.querySelectorAll(".o-spreadsheet .o-menu"));}
const letterRegex=/^[a-zA-Z]$/;function keyboardEventToShortcutString(ev,mode="key"){let keyDownString="";if(!MODIFIER_KEYS$1.includes(ev.key)){if(isCtrlKey(ev))
keyDownString+="Ctrl+";if(ev.altKey)
keyDownString+="Alt+";if(ev.shiftKey)
keyDownString+="Shift+";}
const key=mode==="key"?ev.key:ev.code;keyDownString+=letterRegex.test(key)?key.toUpperCase():key;return keyDownString;}
function isMacOS(){return Boolean(macRegex.test(navigator.userAgent));}
function isCtrlKey(ev){return isMacOS()?ev.metaKey:ev.ctrlKey;}
function useSpreadsheetRect(){const position=owl.useState({x:0,y:0,width:0,height:0});let spreadsheetElement=null;function updatePosition(){if(!spreadsheetElement){spreadsheetElement=document.querySelector(".o-spreadsheet");}
if(spreadsheetElement){const{top,left,width,height}=spreadsheetElement.getBoundingClientRect();position.x=left;position.y=top;position.width=width;position.height=height;}}
owl.onMounted(updatePosition);owl.onPatched(updatePosition);return position;}
function useAbsoluteBoundingRect(ref){const rect=owl.useState({x:0,y:0,width:0,height:0});function updateElRect(){const el=ref.el;if(el===null){return;}
const{top,left,width,height}=el.getBoundingClientRect();rect.x=left;rect.y=top;rect.width=width;rect.height=height;}
owl.onMounted(updateElRect);owl.onPatched(updateElRect);return rect;}
function usePopoverContainer(){const container=owl.useState({x:0,y:0,width:0,height:0});const component=owl.useComponent();const spreadsheetRect=useSpreadsheetRect();function updateRect(){const env=component.env;const newRect="getPopoverContainerRect"in env?env.getPopoverContainerRect():spreadsheetRect;container.x=newRect.x;container.y=newRect.y;container.width=newRect.width;container.height=newRect.height;}
updateRect();owl.onMounted(updateRect);owl.onPatched(updateRect);return container;}
function rectIntersection(rect1,rect2){return zoneToRect(intersection(rectToZone(rect1),rectToZone(rect2)));}
function rectUnion(...rects){return zoneToRect(union(...rects.map(rectToZone)));}
function rectToZone(rect){return{left:rect.x,top:rect.y,right:rect.x+rect.width,bottom:rect.y+rect.height,};}
function zoneToRect(zone){if(!zone)
return undefined;return{x:zone.left,y:zone.top,width:zone.right-zone.left,height:zone.bottom-zone.top,};}
css`
  .o-popover {
    position: absolute;
    z-index: ${ComponentsImportance.Popover};
    overflow: auto;
    box-shadow: 1px 2px 5px 2px rgb(51 51 51 / 15%);
    width: fit-content;
    height: fit-content;
  }
`;class Popover extends owl.Component{static template="o-spreadsheet-Popover";static defaultProps={positioning:"BottomLeft",verticalOffset:0,onMouseWheel:()=>{},onPopoverMoved:()=>{},onPopoverHidden:()=>{},zIndex:ComponentsImportance.Popover,};popoverRef=owl.useRef("popover");currentPosition=undefined;currentDisplayValue=undefined;spreadsheetRect=useSpreadsheetRect();containerRect;setup(){this.containerRect=usePopoverContainer();owl.useEffect(()=>{if(!this.containerRect)
throw new Error("Popover container is not defined");const el=this.popoverRef.el;const anchor=rectIntersection(this.props.anchorRect,this.containerRect);const newDisplay=anchor?"block":"none";if(this.currentDisplayValue!=="none"&&newDisplay==="none"){this.props.onPopoverHidden?.();}
el.style.display=newDisplay;this.currentDisplayValue=newDisplay;if(!anchor)
return;const propsMaxSize={width:this.props.maxWidth,height:this.props.maxHeight};let elDims={width:el.getBoundingClientRect().width,height:el.getBoundingClientRect().height,};const spreadsheetRect=this.spreadsheetRect;const popoverPositionHelper=this.props.positioning==="BottomLeft"?new BottomLeftPopoverContext(anchor,this.containerRect,propsMaxSize,spreadsheetRect):new TopRightPopoverContext(anchor,this.containerRect,propsMaxSize,spreadsheetRect);el.style["max-height"]=popoverPositionHelper.getMaxHeight(elDims.height)+"px";el.style["max-width"]=popoverPositionHelper.getMaxWidth(elDims.width)+"px";elDims={width:el.getBoundingClientRect().width,height:el.getBoundingClientRect().height,};let style=popoverPositionHelper.getCss(elDims,this.props.verticalOffset);for(const property of Object.keys(style)){el.style[property]=style[property];}
const newPosition=popoverPositionHelper.getCurrentPosition(elDims);if(this.currentPosition&&newPosition!==this.currentPosition){this.props.onPopoverMoved?.();}
this.currentPosition=newPosition;});}
get popoverStyle(){return cssPropertiesToCss({"z-index":`${this.props.zIndex}`,});}}
Popover.props={anchorRect:Object,containerRect:{type:Object,optional:true},positioning:{type:String,optional:true},maxWidth:{type:Number,optional:true},maxHeight:{type:Number,optional:true},verticalOffset:{type:Number,optional:true},onMouseWheel:{type:Function,optional:true},onPopoverHidden:{type:Function,optional:true},onPopoverMoved:{type:Function,optional:true},zIndex:{type:Number,optional:true},slots:Object,};class PopoverPositionContext{anchorRect;containerRect;propsMaxSize;spreadsheetOffset;constructor(anchorRect,containerRect,propsMaxSize,spreadsheetOffset){this.anchorRect=anchorRect;this.containerRect=containerRect;this.propsMaxSize=propsMaxSize;this.spreadsheetOffset=spreadsheetOffset;}
shouldRenderAtBottom(elementHeight){return(elementHeight<=this.availableHeightDown||this.availableHeightDown>=this.availableHeightUp);}
shouldRenderAtRight(elementWidth){return(elementWidth<=this.availableWidthRight||this.availableWidthRight>=this.availableWidthLeft);}
getMaxHeight(elementHeight){const shouldRenderAtBottom=this.shouldRenderAtBottom(elementHeight);const availableHeight=shouldRenderAtBottom?this.availableHeightDown:this.availableHeightUp;return this.propsMaxSize.height?Math.min(availableHeight,this.propsMaxSize.height):availableHeight;}
getMaxWidth(elementWidth){const shouldRenderAtRight=this.shouldRenderAtRight(elementWidth);const availableWidth=shouldRenderAtRight?this.availableWidthRight:this.availableWidthLeft;return this.propsMaxSize.width?Math.min(availableWidth,this.propsMaxSize.width):availableWidth;}
getCss(elDims,verticalOffset){const maxHeight=this.getMaxHeight(elDims.height);const maxWidth=this.getMaxWidth(elDims.width);const actualHeight=Math.min(maxHeight,elDims.height);const actualWidth=Math.min(maxWidth,elDims.width);const shouldRenderAtBottom=this.shouldRenderAtBottom(elDims.height);const shouldRenderAtRight=this.shouldRenderAtRight(elDims.width);verticalOffset=shouldRenderAtBottom?verticalOffset:-verticalOffset;const cssProperties={top:this.getTopCoordinate(actualHeight,shouldRenderAtBottom)-
this.spreadsheetOffset.y-
verticalOffset+"px",left:this.getLeftCoordinate(actualWidth,shouldRenderAtRight)-this.spreadsheetOffset.x+"px",};return cssProperties;}
getCurrentPosition(elDims){const shouldRenderAtBottom=this.shouldRenderAtBottom(elDims.height);const shouldRenderAtRight=this.shouldRenderAtRight(elDims.width);if(shouldRenderAtBottom&&shouldRenderAtRight)
return"BottomRight";if(shouldRenderAtBottom&&!shouldRenderAtRight)
return"BottomLeft";if(!shouldRenderAtBottom&&shouldRenderAtRight)
return"TopRight";return"TopLeft";}}
class BottomLeftPopoverContext extends PopoverPositionContext{get availableHeightUp(){return this.anchorRect.y-this.containerRect.y;}
get availableHeightDown(){return this.containerRect.height-this.availableHeightUp-this.anchorRect.height;}
get availableWidthRight(){return this.containerRect.x+this.containerRect.width-this.anchorRect.x;}
get availableWidthLeft(){return this.anchorRect.x+this.anchorRect.width-this.containerRect.x;}
getTopCoordinate(elementHeight,shouldRenderAtBottom){if(shouldRenderAtBottom){return this.anchorRect.y+this.anchorRect.height;}
else{return this.anchorRect.y-elementHeight;}}
getLeftCoordinate(elementWidth,shouldRenderAtRight){if(shouldRenderAtRight){return this.anchorRect.x;}
else{return this.anchorRect.x+this.anchorRect.width-elementWidth;}}}
class TopRightPopoverContext extends PopoverPositionContext{get availableHeightUp(){return this.anchorRect.y+this.anchorRect.height-this.containerRect.y;}
get availableHeightDown(){return this.containerRect.y+this.containerRect.height-this.anchorRect.y;}
get availableWidthRight(){return this.containerRect.width-this.anchorRect.width-this.availableWidthLeft;}
get availableWidthLeft(){return this.anchorRect.x-this.containerRect.x;}
getTopCoordinate(elementHeight,shouldRenderAtBottom){if(shouldRenderAtBottom){return this.anchorRect.y;}
else{return this.anchorRect.y+this.anchorRect.height-elementHeight;}}
getLeftCoordinate(elementWidth,shouldRenderAtRight){if(shouldRenderAtRight){return this.anchorRect.x+this.anchorRect.width;}
else{return this.anchorRect.x-elementWidth;}}}
css`
  .o-menu {
    background-color: white;
    padding: ${MENU_VERTICAL_PADDING}px 0px;
    width: ${MENU_WIDTH}px;
    box-sizing: border-box !important;

    .o-menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
      height: ${MENU_ITEM_HEIGHT}px;
      padding: ${MENU_ITEM_PADDING_VERTICAL}px ${MENU_ITEM_PADDING_HORIZONTAL}px;
      cursor: pointer;
      user-select: none;

      .o-menu-item-name {
        min-width: 40%;
      }

      &.o-menu-root {
        display: flex;
        justify-content: space-between;
      }

      .o-menu-item-icon {
        display: inline-block;
        margin: 0px 8px 0px 0px;
        width: ${MENU_ITEM_HEIGHT - 2 * MENU_ITEM_PADDING_VERTICAL}px;
        line-height: ${MENU_ITEM_HEIGHT - 2 * MENU_ITEM_PADDING_VERTICAL}px;
      }
      .o-menu-item-root {
        width: 10px;
      }

      &:not(.disabled) {
        &:hover,
        &.o-menu-item-active {
          background-color: ${BG_HOVER_COLOR};
        }
        .o-menu-item-description {
          color: grey;
        }
        .o-menu-item-icon {
          .o-icon {
            color: ${ICONS_COLOR};
          }
        }
      }
      &.disabled {
        color: ${DISABLED_TEXT_COLOR};
        cursor: not-allowed;
      }
    }
  }
`;class Menu extends owl.Component{static template="o-spreadsheet-Menu";static components={Menu,Popover};static defaultProps={depth:1,};subMenu=owl.useState({isOpen:false,position:null,scrollOffset:0,menuItems:[],});menuRef=owl.useRef("menu");position=useAbsoluteBoundingRect(this.menuRef);setup(){owl.useExternalListener(window,"click",this.onExternalClick,{capture:true});owl.useExternalListener(window,"contextmenu",this.onExternalClick,{capture:true});owl.onWillUpdateProps((nextProps)=>{if(nextProps.menuItems!==this.props.menuItems){this.closeSubMenu();}});}
get menuItemsAndSeparators(){const menuItemsAndSeparators=[];for(let i=0;i<this.props.menuItems.length;i++){const menuItem=this.props.menuItems[i];if(menuItem.isVisible(this.env)){menuItemsAndSeparators.push(menuItem);}
if(menuItem.separator&&i!==this.props.menuItems.length-1&&menuItemsAndSeparators[menuItemsAndSeparators.length-1]!=="separator"){menuItemsAndSeparators.push("separator");}}
if(menuItemsAndSeparators[menuItemsAndSeparators.length-1]==="separator"){menuItemsAndSeparators.pop();}
if(menuItemsAndSeparators.length===1&&menuItemsAndSeparators[0]==="separator"){return[];}
return menuItemsAndSeparators;}
get subMenuPosition(){const position=Object.assign({},this.subMenu.position);position.y-=this.subMenu.scrollOffset||0;return position;}
get popoverProps(){const isRoot=this.props.depth===1;return{anchorRect:{x:this.props.position.x-MENU_WIDTH*(this.props.depth-1),y:this.props.position.y,width:isRoot?0:MENU_WIDTH,height:isRoot?0:MENU_ITEM_HEIGHT,},positioning:"TopRight",verticalOffset:isRoot?0:MENU_VERTICAL_PADDING,onPopoverHidden:()=>this.closeSubMenu(),onPopoverMoved:()=>this.closeSubMenu(),};}
get childrenHaveIcon(){return this.props.menuItems.some((menuItem)=>!!this.getIconName(menuItem));}
getIconName(menu){if(menu.icon(this.env)){return menu.icon(this.env);}
if(menu.isActive?.(this.env)){return"o-spreadsheet-Icon.CHECK";}
return"";}
getColor(menu){return menu.textColor?`color: ${menu.textColor}`:undefined;}
async activateMenu(menu){const result=await menu.execute?.(this.env);this.close();this.props.onMenuClicked?.({detail:result});}
close(){this.closeSubMenu();this.props.onClose();}
onExternalClick(ev){const el=this.menuRef.el;if(el&&getOpenedMenus().some((el)=>isChildEvent(el,ev))){return;}
ev.closedMenuId=this.props.menuId;this.close();}
getName(menu){return menu.name(this.env);}
isRoot(menu){return!menu.execute;}
isEnabled(menu){if(menu.isEnabled(this.env)){return this.env.model.getters.isReadonly()?menu.isReadonlyAllowed:true;}
return false;}
onScroll(ev){this.subMenu.scrollOffset=ev.target.scrollTop;}
openSubMenu(menu,menuIndex,ev){const parentMenuEl=ev.currentTarget;if(!parentMenuEl)
return;const y=parentMenuEl.getBoundingClientRect().top;this.subMenu.position={x:this.position.x+this.props.depth*MENU_WIDTH,y:y-(this.subMenu.scrollOffset||0),};this.subMenu.menuItems=menu.children(this.env);this.subMenu.isOpen=true;this.subMenu.parentMenu=menu;}
isParentMenu(subMenu,menuItem){return subMenu.parentMenu?.id===menuItem.id;}
closeSubMenu(){this.subMenu.isOpen=false;this.subMenu.parentMenu=undefined;}
onClickMenu(menu,menuIndex,ev){if(this.isEnabled(menu)){if(this.isRoot(menu)){this.openSubMenu(menu,menuIndex,ev);}
else{this.activateMenu(menu);}}}
onMouseOver(menu,position,ev){if(this.isEnabled(menu)){if(this.isRoot(menu)){this.openSubMenu(menu,position,ev);}
else{this.closeSubMenu();}}}}
Menu.props={position:Object,menuItems:Array,depth:{type:Number,optional:true},maxHeight:{type:Number,optional:true},onClose:Function,onMenuClicked:{type:Function,optional:true},menuId:{type:String,optional:true},};const LINK_TOOLTIP_HEIGHT=32;const LINK_TOOLTIP_WIDTH=220;css`
  .o-link-tool {
    font-size: 13px;
    background-color: white;
    box-shadow: 0 1px 4px 3px rgba(60, 64, 67, 0.15);
    padding: 6px 12px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    height: ${LINK_TOOLTIP_HEIGHT}px;
    width: ${LINK_TOOLTIP_WIDTH}px;
    box-sizing: border-box !important;

    img {
      margin-right: 3px;
      width: 16px;
      height: 16px;
    }

    a.o-link {
      color: #01666b;
      text-decoration: none;
      flex-grow: 2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    a.o-link:hover {
      text-decoration: none;
      color: #001d1f;
      cursor: pointer;
    }
  }
  .o-link-icon {
    float: right;
    padding-left: 5px;
    .o-icon {
      height: 16px;
    }
  }
  .o-link-icon .o-icon {
    height: 13px;
  }
  .o-link-icon:hover {
    cursor: pointer;
    color: #000;
  }
`;class LinkDisplay extends owl.Component{static components={Menu};static template="o-spreadsheet-LinkDisplay";get cell(){const{col,row}=this.props.cellPosition;const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getEvaluatedCell({sheetId,col,row});}
get link(){if(this.cell.link){return this.cell.link;}
const{col,row}=this.props.cellPosition;throw new Error(`LinkDisplay Component can only be used with link cells. ${toXC(col, row)} is not a link.`);}
getUrlRepresentation(link){return urlRepresentation(link,this.env.model.getters);}
openLink(){openLink(this.link,this.env);}
edit(){const{col,row}=this.props.cellPosition;this.env.model.dispatch("OPEN_CELL_POPOVER",{col,row,popoverType:"LinkEditor",});}
unlink(){const sheetId=this.env.model.getters.getActiveSheetId();const{col,row}=this.props.cellPosition;const style=this.env.model.getters.getCellComputedStyle({sheetId,col,row});const textColor=style?.textColor===LINK_COLOR?undefined:style?.textColor;this.env.model.dispatch("UPDATE_CELL",{col,row,sheetId,content:this.link.label,style:{...style,textColor,underline:undefined},});}}
const LinkCellPopoverBuilder={onHover:(position,getters)=>{const cell=getters.getEvaluatedCell(position);const shouldDisplayLink=!getters.isDashboard()&&cell.link&&getters.isVisibleInViewport(position);if(!shouldDisplayLink)
return{isOpen:false};return{isOpen:true,Component:LinkDisplay,props:{cellPosition:position},cellCorner:"BottomLeft",};},};LinkDisplay.props={cellPosition:Object,onClosed:{type:Function,optional:true},};const POSTFIX_UNARY_OPERATORS=["%"];const OPERATORS="+,-,*,/,:,=,<>,>=,>,<=,<,^,&".split(",").concat(POSTFIX_UNARY_OPERATORS);function tokenize(str,locale=DEFAULT_LOCALE){str=replaceSpecialSpaces(str);const chars=new TokenizingChars(str);const result=[];while(!chars.isOver()){let token=tokenizeSpace(chars)||tokenizeArgsSeparator(chars,locale)||tokenizeParenthesis(chars)||tokenizeOperator(chars)||tokenizeString(chars)||tokenizeDebugger(chars)||tokenizeInvalidRange(chars)||tokenizeNumber(chars,locale)||tokenizeSymbol(chars);if(!token){token={type:"UNKNOWN",value:chars.shift()};}
result.push(token);}
return result;}
function tokenizeDebugger(chars){if(chars.current==="?"){chars.shift();return{type:"DEBUGGER",value:"?"};}
return null;}
const parenthesis={"(":{type:"LEFT_PAREN",value:"("},")":{type:"RIGHT_PAREN",value:")"},};function tokenizeParenthesis(chars){if(chars.current==="("||chars.current===")"){const value=chars.shift();return parenthesis[value];}
return null;}
function tokenizeArgsSeparator(chars,locale){if(chars.current===locale.formulaArgSeparator){const value=chars.shift();const type="ARG_SEPARATOR";return{type,value};}
return null;}
function tokenizeOperator(chars){for(let op of OPERATORS){if(chars.currentStartsWith(op)){chars.advanceBy(op.length);return{type:"OPERATOR",value:op};}}
return null;}
const FIRST_POSSIBLE_NUMBER_CHARS=new Set("0123456789");function tokenizeNumber(chars,locale){if(!FIRST_POSSIBLE_NUMBER_CHARS.has(chars.current)&&chars.current!==locale.decimalSeparator){return null;}
const match=chars.remaining().match(getFormulaNumberRegex(locale.decimalSeparator));if(match){chars.advanceBy(match[0].length);return{type:"NUMBER",value:match[0]};}
return null;}
function tokenizeString(chars){if(chars.current==='"'){const startChar=chars.shift();let letters=startChar;while(chars.current&&(chars.current!==startChar||letters[letters.length-1]==="\\")){letters+=chars.shift();}
if(chars.current==='"'){letters+=chars.shift();}
return{type:"STRING",value:letters,};}
return null;}
const SYMBOL_CHARS=new Set("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.!$");function tokenizeSymbol(chars){let result="";if(chars.current==="'"){let lastChar=chars.shift();result+=lastChar;while(chars.current){lastChar=chars.shift();result+=lastChar;if(lastChar==="'"){if(chars.current&&chars.current==="'"){lastChar=chars.shift();result+=lastChar;}
else{break;}}}
if(lastChar!=="'"){return{type:"UNKNOWN",value:result,};}}
while(chars.current&&SYMBOL_CHARS.has(chars.current)){result+=chars.shift();}
if(result.length){const value=result;const isReference=rangeReference.test(value);if(isReference){return{type:"REFERENCE",value};}
return{type:"SYMBOL",value};}
return null;}
function tokenizeSpace(chars){let length=0;while(chars.current===NEWLINE){length++;chars.shift();}
if(length){return{type:"SPACE",value:NEWLINE.repeat(length)};}
while(chars.current===" "){length++;chars.shift();}
if(length){return{type:"SPACE",value:" ".repeat(length)};}
return null;}
function tokenizeInvalidRange(chars){if(chars.currentStartsWith(INCORRECT_RANGE_STRING)){chars.advanceBy(INCORRECT_RANGE_STRING.length);return{type:"INVALID_REFERENCE",value:INCORRECT_RANGE_STRING};}
return null;}
class TokenizingChars{text;currentIndex=0;current;constructor(text){this.text=text;this.current=text[0];}
shift(){const current=this.current;const next=this.text[++this.currentIndex];this.current=next;return current;}
advanceBy(length){this.currentIndex+=length;this.current=this.text[this.currentIndex];}
isOver(){return this.currentIndex>=this.text.length;}
remaining(){return this.text.substring(this.currentIndex);}
currentStartsWith(str){if(this.current!==str[0]){return false;}
for(let j=1;j<str.length;j++){if(this.text[this.currentIndex+j]!==str[j]){return false;}}
return true;}}
function isValidLocale(locale){if(!(locale&&typeof locale==="object"&&typeof locale.name==="string"&&typeof locale.code==="string"&&typeof locale.thousandsSeparator==="string"&&typeof locale.decimalSeparator==="string"&&typeof locale.dateFormat==="string"&&typeof locale.timeFormat==="string"&&typeof locale.formulaArgSeparator==="string")){return false;}
if(!Object.values(locale).every((v)=>v)){return false;}
if(locale.formulaArgSeparator===locale.decimalSeparator){return false;}
if(locale.thousandsSeparator===locale.decimalSeparator){return false;}
try{formatValue(1,{locale,format:"#,##0.00"});formatValue(1,{locale,format:locale.dateFormat});formatValue(1,{locale,format:locale.timeFormat});}
catch{return false;}
return true;}
function canonicalizeNumberContent(content,locale){return content.startsWith("=")?canonicalizeFormula$1(content,locale):canonicalizeNumberLiteral(content,locale);}
function canonicalizeContent(content,locale){return content.startsWith("=")?canonicalizeFormula$1(content,locale):canonicalizeLiteral(content,locale);}
function localizeContent(content,locale){return content.startsWith("=")?localizeFormula(content,locale):localizeLiteral(content,locale);}
function canonicalizeFormula$1(formula,locale){return _localizeFormula$1(formula,locale,DEFAULT_LOCALE);}
function localizeFormula(formula,locale){return _localizeFormula$1(formula,DEFAULT_LOCALE,locale);}
function _localizeFormula$1(formula,fromLocale,toLocale){if(fromLocale.formulaArgSeparator===toLocale.formulaArgSeparator&&fromLocale.decimalSeparator===toLocale.decimalSeparator){return formula;}
const tokens=tokenize(formula,fromLocale);let localizedFormula="";for(const token of tokens){if(token.type==="NUMBER"){localizedFormula+=token.value.replace(fromLocale.decimalSeparator,toLocale.decimalSeparator);}
else if(token.type==="ARG_SEPARATOR"){localizedFormula+=toLocale.formulaArgSeparator;}
else{localizedFormula+=token.value;}}
return localizedFormula;}
function canonicalizeNumberLiteral(content,locale){if(locale.decimalSeparator==="."||!isNumber(content,locale)){return content;}
return content.replace(locale.thousandsSeparator,"").replace(locale.decimalSeparator,".");}
function canonicalizeLiteral(content,locale){if(isDateTime(content,locale)){const dateNumber=toNumber(content,locale);let format=DEFAULT_LOCALE.dateFormat;if(!Number.isInteger(dateNumber)){format+=" "+DEFAULT_LOCALE.timeFormat;}
return formatValue(dateNumber,{locale:DEFAULT_LOCALE,format});}
return canonicalizeNumberLiteral(content,locale);}
function localizeNumberLiteral(literal,locale){if(locale.decimalSeparator==="."||!isNumber(literal,DEFAULT_LOCALE)){return literal;}
const decimalNumberRegex=getDecimalNumberRegex(DEFAULT_LOCALE);const localized=literal.replace(decimalNumberRegex,(match)=>{return match.replace(".",locale.decimalSeparator);});return localized;}
function localizeLiteral(literal,locale){if(isDateTime(literal,DEFAULT_LOCALE)){const dateNumber=toNumber(literal,DEFAULT_LOCALE);let format=locale.dateFormat;if(!Number.isInteger(dateNumber)){format+=" "+locale.timeFormat;}
return formatValue(dateNumber,{locale,format});}
return localizeNumberLiteral(literal,locale);}
function canonicalizeCFRule(cf,locale){return changeCFRuleLocale(cf,(content)=>canonicalizeContent(content,locale));}
function localizeCFRule(cf,locale){return changeCFRuleLocale(cf,(content)=>localizeContent(content,locale));}
function localizeDataValidationRule(rule,locale){const localizedDVRule=deepCopy(rule);localizedDVRule.criterion.values=localizedDVRule.criterion.values.map((content)=>localizeContent(content,locale));return localizedDVRule;}
function changeCFRuleLocale(rule,changeContentLocale){rule=deepCopy(rule);switch(rule.type){case"CellIsRule":switch(rule.operator){case"Between":case"NotBetween":case"Equal":case"NotEqual":case"GreaterThan":case"GreaterThanOrEqual":case"LessThan":case"LessThanOrEqual":rule.values=rule.values.map((v)=>changeContentLocale(v));return rule;case"BeginsWith":case"ContainsText":case"EndsWith":case"NotContains":case"IsEmpty":case"IsNotEmpty":return rule;}
break;case"ColorScaleRule":rule.minimum=changeCFRuleThresholdLocale(rule.minimum,changeContentLocale);rule.maximum=changeCFRuleThresholdLocale(rule.maximum,changeContentLocale);if(rule.midpoint){rule.midpoint=changeCFRuleThresholdLocale(rule.midpoint,changeContentLocale);}
return rule;case"IconSetRule":rule.lowerInflectionPoint.value=changeContentLocale(rule.lowerInflectionPoint.value);rule.upperInflectionPoint.value=changeContentLocale(rule.upperInflectionPoint.value);return rule;}}
function changeCFRuleThresholdLocale(threshold,changeContentLocale){if(!threshold?.value){return threshold;}
const value=threshold.type==="formula"?"="+threshold.value:threshold.value;const modified=changeContentLocale(value);const newValue=threshold.type==="formula"?modified.slice(1):modified;return{...threshold,value:newValue};}
function getDateTimeFormat(locale){return locale.dateFormat+" "+locale.timeFormat;}
const linkSheet={name:_t("Link sheet"),children:[(env)=>{const sheets=env.model.getters.getSheetIds().map((sheetId)=>env.model.getters.getSheet(sheetId));return sheets.map((sheet)=>({id:sheet.id,name:sheet.name,execute:()=>markdownLink(sheet.name,buildSheetLink(sheet.id)),}));},],};const deleteSheet={name:_t("Delete"),isVisible:(env)=>{return env.model.getters.getSheetIds().length>1;},execute:(env)=>env.askConfirmation(_t("Are you sure you want to delete this sheet?"),()=>{env.model.dispatch("DELETE_SHEET",{sheetId:env.model.getters.getActiveSheetId()});}),};const duplicateSheet={name:_t("Duplicate"),execute:(env)=>{const sheetIdFrom=env.model.getters.getActiveSheetId();const sheetIdTo=env.model.uuidGenerator.uuidv4();env.model.dispatch("DUPLICATE_SHEET",{sheetId:sheetIdFrom,sheetIdTo,});env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom,sheetIdTo});},};const renameSheet=(args)=>{return{name:_t("Rename"),execute:args.renameSheetCallback,};};const sheetMoveRight={name:_t("Move right"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const sheetIds=env.model.getters.getVisibleSheetIds();return sheetIds.indexOf(sheetId)!==sheetIds.length-1;},execute:(env)=>env.model.dispatch("MOVE_SHEET",{sheetId:env.model.getters.getActiveSheetId(),delta:1,}),};const sheetMoveLeft={name:_t("Move left"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();return env.model.getters.getVisibleSheetIds()[0]!==sheetId;},execute:(env)=>env.model.dispatch("MOVE_SHEET",{sheetId:env.model.getters.getActiveSheetId(),delta:-1,}),};const hideSheet={name:_t("Hide sheet"),isVisible:(env)=>env.model.getters.getVisibleSheetIds().length!==1,execute:(env)=>env.model.dispatch("HIDE_SHEET",{sheetId:env.model.getters.getActiveSheetId()}),};class MenuItemRegistry extends Registry{add(key,value){if(value.id===undefined){value.id=key;}
this.content[key]=value;return this;}
addChild(key,path,value){if(typeof value!=="function"&&value.id===undefined){value.id=key;}
const root=path.splice(0,1)[0];let node=this.content[root];if(!node){throw new Error(`Path ${root + ":" + path.join(":")} not found`);}
for(let p of path){const children=node.children;if(!children||typeof children==="function"){throw new Error(`${p} is either not a node or it's dynamically computed`);}
node=children.find((elt)=>elt.id===p);if(!node){throw new Error(`Path ${root + ":" + path.join(":")} not found`);}}
if(!node.children){node.children=[];}
node.children.push(value);return this;}
getMenuItems(){return createActions(this.getAll());}}
const linkMenuRegistry=new MenuItemRegistry();linkMenuRegistry.add("sheet",{...linkSheet,sequence:10,});const MENU_OFFSET_X=320;const MENU_OFFSET_Y=100;const PADDING=12;const LINK_EDITOR_WIDTH=340;const LINK_EDITOR_HEIGHT=165;css`
  .o-link-editor {
    font-size: 13px;
    background-color: white;
    box-shadow: 0 1px 4px 3px rgba(60, 64, 67, 0.15);
    padding: ${PADDING}px;
    display: flex;
    flex-direction: column;
    border-radius: 4px;
    height: ${LINK_EDITOR_HEIGHT}px;
    width: ${LINK_EDITOR_WIDTH}px;

    .o-section {
      .o-section-title {
        font-weight: bold;
        color: dimgrey;
        margin-bottom: 5px;
      }
    }
    .o-buttons {
      padding-left: 16px;
      padding-top: 16px;
      padding-bottom: 16px;
      text-align: right;
    }
    input {
      box-sizing: border-box;
      width: 100%;
      border-radius: 4px;
      padding: 4px 23px 4px 10px;
      border: none;
      height: 24px;
      border: 1px solid lightgrey;
    }
    .o-link-url {
      position: relative;
      flex-grow: 1;
      button {
        position: absolute;
        right: 0px;
        top: 0px;
        border: none;
        height: 20px;
        width: 20px;
        background-color: #fff;
        margin: 2px 3px 1px 0px;
        padding: 0px 1px 0px 0px;
      }
      button:hover {
        cursor: pointer;
      }
    }
  }
`;class LinkEditor extends owl.Component{static template="o-spreadsheet-LinkEditor";static components={Menu};menuItems=linkMenuRegistry.getMenuItems();link=owl.useState(this.defaultState);menu=owl.useState({isOpen:false,});linkEditorRef=owl.useRef("linkEditor");position=useAbsoluteBoundingRect(this.linkEditorRef);urlInput=owl.useRef("urlInput");setup(){owl.onMounted(()=>this.urlInput.el?.focus());}
get defaultState(){const{col,row}=this.props.cellPosition;const sheetId=this.env.model.getters.getActiveSheetId();const cell=this.env.model.getters.getEvaluatedCell({sheetId,col,row});if(cell.link){return{url:cell.link.url,label:cell.formattedValue,isUrlEditable:cell.link.isUrlEditable,};}
return{label:cell.formattedValue,url:"",isUrlEditable:true,};}
get menuPosition(){return{x:this.position.x+MENU_OFFSET_X-PADDING-2,y:this.position.y+MENU_OFFSET_Y,};}
onSpecialLink(ev){const{detail:markdownLink}=ev;const link=detectLink(markdownLink);if(!link){return;}
this.link.url=link.url;this.link.label=link.label;this.link.isUrlEditable=link.isUrlEditable;}
getUrlRepresentation(link){return urlRepresentation(link,this.env.model.getters);}
openMenu(){this.menu.isOpen=true;}
removeLink(){this.link.url="";this.link.isUrlEditable=true;}
save(){const{col,row}=this.props.cellPosition;const locale=this.env.model.getters.getLocale();const label=this.link.label?canonicalizeNumberContent(this.link.label,locale):this.link.url;this.env.model.dispatch("UPDATE_CELL",{col:col,row:row,sheetId:this.env.model.getters.getActiveSheetId(),content:markdownLink(label,this.link.url),});this.props.onClosed?.();}
cancel(){this.props.onClosed?.();}
onKeyDown(ev){switch(ev.key){case"Enter":if(this.link.url){this.save();}
ev.stopPropagation();ev.preventDefault();break;case"Escape":this.cancel();ev.stopPropagation();break;}}}
const LinkEditorPopoverBuilder={onOpen:(position,getters)=>{return{isOpen:true,props:{cellPosition:position},Component:LinkEditor,cellCorner:"BottomLeft",};},};LinkEditor.props={cellPosition:Object,onClosed:{type:Function,optional:true},};const cellPopoverRegistry=new Registry();cellPopoverRegistry.add("ErrorToolTip",ErrorToolTipPopoverBuilder).add("LinkCell",LinkCellPopoverBuilder).add("LinkEditor",LinkEditorPopoverBuilder).add("FilterMenu",FilterMenuPopoverBuilder);function toXlsxHexColor(color){color=toHex(color).replace("#","");if(color.length===8){return color.slice(6)+color.slice(0,6);}
return color;}
const PasteInteractiveContent={wrongPasteSelection:_t("This operation is not allowed with multiple selections."),willRemoveExistingMerge:_t("This operation is not possible due to a merge. Please remove the merges first than try again."),wrongFigurePasteOption:_t("Cannot do a special paste of a figure."),frozenPaneOverlap:_t("This operation is not allowed due to an overlapping frozen pane."),};function handlePasteResult(env,result){if(!result.isSuccessful){if(result.reasons.includes("WrongPasteSelection")){env.raiseError(PasteInteractiveContent.wrongPasteSelection);}
else if(result.reasons.includes("WillRemoveExistingMerge")){env.raiseError(PasteInteractiveContent.willRemoveExistingMerge);}
else if(result.reasons.includes("WrongFigurePasteOption")){env.raiseError(PasteInteractiveContent.wrongFigurePasteOption);}
else if(result.reasons.includes("FrozenPaneOverlap")){env.raiseError(PasteInteractiveContent.frozenPaneOverlap);}}}
function interactivePaste(env,target,pasteOption){const result=env.model.dispatch("PASTE",{target,pasteOption});handlePasteResult(env,result);}
function interactivePasteFromOS(env,target,text,pasteOption){const result=env.model.dispatch("PASTE_FROM_OS_CLIPBOARD",{target,text,pasteOption});handlePasteResult(env,result);}
const CfTerms={Errors:{["InvalidRange"]:_t("The range is invalid"),["FirstArgMissing"]:_t("The argument is missing. Please provide a value"),["SecondArgMissing"]:_t("The second argument is missing. Please provide a value"),["MinNaN"]:_t("The minpoint must be a number"),["MidNaN"]:_t("The midpoint must be a number"),["MaxNaN"]:_t("The maxpoint must be a number"),["ValueUpperInflectionNaN"]:_t("The first value must be a number"),["ValueLowerInflectionNaN"]:_t("The second value must be a number"),["MinBiggerThanMax"]:_t("Minimum must be smaller then Maximum"),["MinBiggerThanMid"]:_t("Minimum must be smaller then Midpoint"),["MidBiggerThanMax"]:_t("Midpoint must be smaller then Maximum"),["LowerBiggerThanUpper"]:_t("Lower inflection point must be smaller than upper inflection point"),["MinInvalidFormula"]:_t("Invalid Minpoint formula"),["MaxInvalidFormula"]:_t("Invalid Maxpoint formula"),["MidInvalidFormula"]:_t("Invalid Midpoint formula"),["ValueUpperInvalidFormula"]:_t("Invalid upper inflection point formula"),["ValueLowerInvalidFormula"]:_t("Invalid lower inflection point formula"),["EmptyRange"]:_t("A range needs to be defined"),Unexpected:_t("The rule is invalid for an unknown reason"),},ColorScale:_t("Color scale"),IconSet:_t("Icon set"),};const CellIsOperators={IsEmpty:_t("Is empty"),IsNotEmpty:_t("Is not empty"),ContainsText:_t("Contains"),NotContains:_t("Does not contain"),BeginsWith:_t("Starts with"),EndsWith:_t("Ends with"),Equal:_t("Is equal to"),NotEqual:_t("Is not equal to"),GreaterThan:_t("Is greater than"),GreaterThanOrEqual:_t("Is greater than or equal to"),LessThan:_t("Is less than"),LessThanOrEqual:_t("Is less than or equal to"),Between:_t("Is between"),NotBetween:_t("Is not between"),};const ChartTerms={Series:_t("Series"),Errors:{Unexpected:_t("The chart definition is invalid for an unknown reason"),["InvalidDataSet"]:_t("The dataset is invalid"),["InvalidLabelRange"]:_t("Labels are invalid"),["InvalidScorecardKeyValue"]:_t("The key value is invalid"),["InvalidScorecardBaseline"]:_t("The baseline value is invalid"),["InvalidGaugeDataRange"]:_t("The data range is invalid"),["EmptyGaugeRangeMin"]:_t("A minimum range limit value is needed"),["GaugeRangeMinNaN"]:_t("The minimum range limit value must be a number"),["EmptyGaugeRangeMax"]:_t("A maximum range limit value is needed"),["GaugeRangeMaxNaN"]:_t("The maximum range limit value must be a number"),["GaugeRangeMinBiggerThanRangeMax"]:_t("Minimum range limit must be smaller than maximum range limit"),["GaugeLowerInflectionPointNaN"]:_t("The lower inflection point value must be a number"),["GaugeUpperInflectionPointNaN"]:_t("The upper inflection point value must be a number"),},};const CustomCurrencyTerms={Custom:_t("Custom"),};const MergeErrorMessage=_t("Merged cells are preventing this operation. Unmerge those cells and try again.");const SplitToColumnsTerms={Errors:{Unexpected:_t("Cannot split the selection for an unknown reason"),["NoSplitSeparatorInSelection"]:_t("There is no match for the selected separator in the selection"),["MoreThanOneColumnSelected"]:_t("Only a selection from a single column can be split"),["SplitWillOverwriteContent"]:_t("Splitting will overwrite existing content"),},};const RemoveDuplicateTerms={Errors:{Unexpected:_t("Cannot remove duplicates for an unknown reason"),["MoreThanOneRangeSelected"]:_t("Please select only one range of cells"),["EmptyTarget"]:_t("Please select a range of cells containing values."),["NoColumnsProvided"]:_t("Please select at latest one column to analyze."),["WillRemoveExistingMerge"]:PasteInteractiveContent.willRemoveExistingMerge,},};const DVTerms={DateIs:{today:_t("today"),yesterday:_t("yesterday"),tomorrow:_t("tomorrow"),lastWeek:_t("in the past week"),lastMonth:_t("in the past month"),lastYear:_t("in the past year"),},DateIsBefore:{today:_t("today"),yesterday:_t("yesterday"),tomorrow:_t("tomorrow"),lastWeek:_t("one week ago"),lastMonth:_t("one month ago"),lastYear:_t("one year ago"),},CriterionError:{notEmptyValue:_t("The value must not be empty"),numberValue:_t("The value must be a number"),dateValue:_t("The value must be a date"),validRange:_t("The value must be a valid range"),},};function getData(getters,ds){if(ds.dataRange){const labelCellZone=ds.labelCell?[zoneToXc(ds.labelCell.zone)]:[];const dataXC=recomputeZones([zoneToXc(ds.dataRange.zone)],labelCellZone)[0];if(dataXC===undefined){return[];}
const dataRange=getters.getRangeFromSheetXC(ds.dataRange.sheetId,dataXC);return getters.getRangeValues(dataRange).map((value)=>(value===""?undefined:value));}
return[];}
function filterEmptyDataPoints(labels,datasets){const numberOfDataPoints=Math.max(labels.length,...datasets.map((dataset)=>dataset.data?.length||0));const dataPointsIndexes=range(0,numberOfDataPoints).filter((dataPointIndex)=>{const label=labels[dataPointIndex];const values=datasets.map((dataset)=>dataset.data?.[dataPointIndex]);return label||values.some((value)=>value===0||Boolean(value));});return{labels:dataPointsIndexes.map((i)=>labels[i]||""),dataSetsValues:datasets.map((dataset)=>({...dataset,data:dataPointsIndexes.map((i)=>dataset.data[i]),})),};}
function aggregateDataForLabels(labels,datasets){const parseNumber=(value)=>(typeof value==="number"?value:0);const labelSet=new Set(labels);const labelMap={};labelSet.forEach((label)=>{labelMap[label]=new Array(datasets.length).fill(0);});for(const indexOfLabel of range(0,labels.length)){const label=labels[indexOfLabel];for(const indexOfDataset of range(0,datasets.length)){labelMap[label][indexOfDataset]+=parseNumber(datasets[indexOfDataset].data[indexOfLabel]);}}
return{labels:Array.from(labelSet),dataSetsValues:datasets.map((dataset,indexOfDataset)=>({...dataset,data:Array.from(labelSet).map((label)=>labelMap[label][indexOfDataset]),})),};}
function truncateLabel(label){if(!label){return"";}
if(label.length>MAX_CHAR_LABEL){return label.substring(0,MAX_CHAR_LABEL)+"…";}
return label;}
function getDefaultChartJsRuntime(chart,labels,fontColor,{format,locale,truncateLabels}){const options={responsive:true,maintainAspectRatio:false,layout:{padding:{left:20,right:20,top:chart.title?10:25,bottom:10},},elements:{line:{fill:false,},point:{hitRadius:15,},},animation:false,plugins:{title:{display:!!chart.title,text:_t(chart.title),color:fontColor,font:{size:22,weight:"normal"},},legend:{onClick:()=>{},},tooltip:{callbacks:{label:function(tooltipItem){const xLabel=tooltipItem.dataset?.label||tooltipItem.label;const yLabel=tooltipItem.parsed.y??tooltipItem.parsed;const toolTipFormat=!format&&Math.abs(yLabel)>=1000?"#,##":format;const yLabelStr=formatValue(yLabel,{format:toolTipFormat,locale});return xLabel?`${xLabel}: ${yLabelStr}`:yLabelStr;},},},},};return{type:chart.type,options,data:{labels:truncateLabels?labels.map(truncateLabel):labels,datasets:[],},plugins:[],};}
function getChartLabelFormat(getters,range){if(!range)
return undefined;return getters.getEvaluatedCell({sheetId:range.sheetId,col:range.zone.left,row:range.zone.top,}).format;}
function getChartLabelValues(getters,dataSets,labelRange){let labels={values:[],formattedValues:[]};if(labelRange){if(!labelRange.invalidXc&&!labelRange.invalidSheetName){labels={formattedValues:getters.getRangeFormattedValues(labelRange),values:getters.getRangeValues(labelRange).map((val)=>String(val)),};}}
else if(dataSets.length===1){for(let i=0;i<getData(getters,dataSets[0]).length;i++){labels.formattedValues.push("");labels.values.push("");}}
else{if(dataSets[0]){const ranges=getData(getters,dataSets[0]);labels={formattedValues:range(0,ranges.length).map((r)=>r.toString()),values:labels.formattedValues,};}}
return labels;}
function getChartDatasetFormat(getters,dataSets){for(const ds of dataSets){const formatsInDataset=getters.getRangeFormats(ds.dataRange);const format=formatsInDataset.find((f)=>f!==undefined&&!isDateTimeFormat(f));if(format)
return format;}
return undefined;}
function getChartDatasetValues(getters,dataSets){const datasetValues=[];for(const[dsIndex,ds]of Object.entries(dataSets)){let label;if(ds.labelCell){const labelRange=ds.labelCell;const cell=labelRange?getters.getEvaluatedCell({sheetId:labelRange.sheetId,col:labelRange.zone.left,row:labelRange.zone.top,}):undefined;label=cell&&labelRange?truncateLabel(cell.formattedValue):(label=`${ChartTerms.Series} ${parseInt(dsIndex) + 1}`);}
else{label=label=`${ChartTerms.Series} ${parseInt(dsIndex) + 1}`;}
let data=ds.dataRange?getData(getters,ds):[];datasetValues.push({data,label});}
return datasetValues;}
function getFillingMode(index){if(index===0){return"origin";}
else{return index-1;}}
function chartToImage(runtime,figure,type){const div=document.createElement("div");div.style.width=`${figure.width}px`;div.style.height=`${figure.height}px`;const canvas=document.createElement("canvas");div.append(canvas);canvas.setAttribute("width",figure.width.toString());canvas.setAttribute("height",figure.height.toString());document.body.append(div);if("chartJsConfig"in runtime){runtime.chartJsConfig.plugins=[backgroundColorChartJSPlugin];const chart=new window.Chart(canvas,deepCopy(runtime.chartJsConfig));const imgContent=chart.toBase64Image();chart.destroy();div.remove();return imgContent;}
else if(type==="scorecard"){const design=getScorecardConfiguration(figure,runtime);drawScoreChart(design,canvas);const imgContent=canvas.toDataURL();div.remove();return imgContent;}
return"";}
const backgroundColorChartJSPlugin={id:"customCanvasBackgroundColor",beforeDraw:(chart)=>{const{ctx}=chart;ctx.save();ctx.globalCompositeOperation="destination-over";ctx.fillStyle="#ffffff";ctx.fillRect(0,0,chart.width,chart.height);ctx.restore();},};class BarChart extends AbstractChart{dataSets;labelRange;background;verticalAxisPosition;legendPosition;stacked;aggregated;type="bar";dataSetsHaveTitle;constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataSets=createDataSets(getters,definition.dataSets,sheetId,definition.dataSetsHaveTitle);this.labelRange=createValidRange(getters,sheetId,definition.labelRange);this.background=definition.background;this.verticalAxisPosition=definition.verticalAxisPosition;this.legendPosition=definition.legendPosition;this.stacked=definition.stacked;this.aggregated=definition.aggregated;this.dataSetsHaveTitle=definition.dataSetsHaveTitle;}
static transformDefinition(definition,executed){return transformChartDefinitionWithDataSetsWithZone(definition,executed);}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkDataset,checkLabelRange);}
static getDefinitionFromContextCreation(context){return{background:context.background,dataSets:context.range?context.range:[],dataSetsHaveTitle:false,stacked:false,aggregated:false,legendPosition:"top",title:context.title||"",type:"bar",verticalAxisPosition:"left",labelRange:context.auxiliaryRange||undefined,};}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,this.sheetId)),auxiliaryRange:this.labelRange?this.getters.getRangeString(this.labelRange,this.sheetId):undefined,};}
copyForSheetId(sheetId){const dataSets=copyDataSetsWithNewSheetId(this.sheetId,sheetId,this.dataSets);const labelRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.labelRange);const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange,sheetId);return new BarChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange,sheetId);return new BarChart(definition,sheetId,this.getters);}
getDefinition(){return this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange);}
getDefinitionWithSpecificDataSets(dataSets,labelRange,targetSheetId){return{type:"bar",dataSetsHaveTitle:dataSets.length?Boolean(dataSets[0].labelCell):false,background:this.background,dataSets:dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,targetSheetId||this.sheetId)),legendPosition:this.legendPosition,verticalAxisPosition:this.verticalAxisPosition,labelRange:labelRange?this.getters.getRangeString(labelRange,targetSheetId||this.sheetId):undefined,title:this.title,stacked:this.stacked,aggregated:this.aggregated,};}
getDefinitionForExcel(){if(this.aggregated)
return undefined;const dataSets=this.dataSets.map((ds)=>toExcelDataset(this.getters,ds)).filter((ds)=>ds.range!==""&&ds.range!==INCORRECT_RANGE_STRING);const labelRange=toExcelLabelRange(this.getters,this.labelRange,shouldRemoveFirstLabel(this.labelRange,this.dataSets[0],this.dataSetsHaveTitle));return{...this.getDefinition(),backgroundColor:toXlsxHexColor(this.background||BACKGROUND_CHART_COLOR),fontColor:toXlsxHexColor(chartFontColor(this.background)),dataSets,labelRange,};}
updateRanges(applyChange){const{dataSets,labelRange,isStale}=updateChartRangesWithDataSets(this.getters,applyChange,this.dataSets,this.labelRange);if(!isStale){return this;}
const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange);return new BarChart(definition,this.sheetId,this.getters);}}
function getBarConfiguration(chart,labels,localeFormat){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,localeFormat);const legend={labels:{color:fontColor},};if((!chart.labelRange&&chart.dataSets.length===1)||chart.legendPosition==="none"){legend.display=false;}
else{legend.position=chart.legendPosition;}
config.options.plugins.legend={...config.options.plugins?.legend,...legend};config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.scales={x:{ticks:{padding:5,color:fontColor,},},y:{position:chart.verticalAxisPosition,beginAtZero:true,ticks:{color:fontColor,callback:(value)=>{value=Number(value);if(isNaN(value))
return value;const{locale,format}=localeFormat;return formatValue(value,{locale,format:!format&&Math.abs(value)>=1000?"#,##":format,});},},},};if(chart.stacked){config.options.scales.x.stacked=true;config.options.scales.y.stacked=true;}
return config;}
function createBarChartRuntime(chart,getters){const labelValues=getChartLabelValues(getters,chart.dataSets,chart.labelRange);let labels=labelValues.formattedValues;let dataSetsValues=getChartDatasetValues(getters,chart.dataSets);if(chart.dataSetsHaveTitle&&dataSetsValues[0]&&labels.length>dataSetsValues[0].data.length){labels.shift();}
({labels,dataSetsValues}=filterEmptyDataPoints(labels,dataSetsValues));if(chart.aggregated){({labels,dataSetsValues}=aggregateDataForLabels(labels,dataSetsValues));}
const dataSetFormat=getChartDatasetFormat(getters,chart.dataSets);const locale=getters.getLocale();const config=getBarConfiguration(chart,labels,{format:dataSetFormat,locale});const colors=new ChartColors();for(let{label,data}of dataSetsValues){const color=colors.next();const dataset={label,data,borderColor:color,backgroundColor:color,};config.data.datasets.push(dataset);}
return{chartJsConfig:config,background:chart.background||BACKGROUND_CHART_COLOR};}
function isDataRangeValid(definition){return definition.dataRange&&!rangeReference.test(definition.dataRange)?"InvalidGaugeDataRange":"Success";}
function checkRangeLimits(check,batchValidations){return batchValidations((definition)=>{if(definition.sectionRule){return check(definition.sectionRule.rangeMin,"rangeMin");}
return"Success";},(definition)=>{if(definition.sectionRule){return check(definition.sectionRule.rangeMax,"rangeMax");}
return"Success";});}
function checkInflectionPointsValue(check,batchValidations){return batchValidations((definition)=>{if(definition.sectionRule){return check(definition.sectionRule.lowerInflectionPoint.value,"lowerInflectionPointValue");}
return"Success";},(definition)=>{if(definition.sectionRule){return check(definition.sectionRule.upperInflectionPoint.value,"upperInflectionPointValue");}
return"Success";});}
function checkRangeMinBiggerThanRangeMax(definition){if(definition.sectionRule){if(Number(definition.sectionRule.rangeMin)>=Number(definition.sectionRule.rangeMax)){return"GaugeRangeMinBiggerThanRangeMax";}}
return"Success";}
function checkEmpty(value,valueName){if(value===""){switch(valueName){case"rangeMin":return"EmptyGaugeRangeMin";case"rangeMax":return"EmptyGaugeRangeMax";}}
return"Success";}
function checkNaN(value,valueName){if(isNaN(value)){switch(valueName){case"rangeMin":return"GaugeRangeMinNaN";case"rangeMax":return"GaugeRangeMaxNaN";case"lowerInflectionPointValue":return"GaugeLowerInflectionPointNaN";case"upperInflectionPointValue":return"GaugeUpperInflectionPointNaN";}}
return"Success";}
class GaugeChart extends AbstractChart{dataRange;sectionRule;background;type="gauge";constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataRange=createValidRange(this.getters,this.sheetId,definition.dataRange);this.sectionRule=definition.sectionRule;this.background=definition.background;}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,isDataRangeValid,validator.chainValidations(checkRangeLimits(checkEmpty,validator.batchValidations),checkRangeLimits(checkNaN,validator.batchValidations),checkRangeMinBiggerThanRangeMax),validator.chainValidations(checkInflectionPointsValue(checkNaN,validator.batchValidations)));}
static transformDefinition(definition,executed){let dataRangeZone;if(definition.dataRange){dataRangeZone=transformZone(toUnboundedZone(definition.dataRange),executed);}
return{...definition,dataRange:dataRangeZone?zoneToXc(dataRangeZone):undefined,};}
static getDefinitionFromContextCreation(context){return{background:context.background,title:context.title||"",type:"gauge",dataRange:context.range?context.range[0]:undefined,sectionRule:{colors:{lowerColor:DEFAULT_GAUGE_LOWER_COLOR,middleColor:DEFAULT_GAUGE_MIDDLE_COLOR,upperColor:DEFAULT_GAUGE_UPPER_COLOR,},rangeMin:"0",rangeMax:"100",lowerInflectionPoint:{type:"percentage",value:"15",},upperInflectionPoint:{type:"percentage",value:"40",},},};}
copyForSheetId(sheetId){const dataRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.dataRange);const definition=this.getDefinitionWithSpecificRanges(dataRange,sheetId);return new GaugeChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificRanges(this.dataRange,sheetId);return new GaugeChart(definition,sheetId,this.getters);}
getDefinition(){return this.getDefinitionWithSpecificRanges(this.dataRange);}
getDefinitionWithSpecificRanges(dataRange,targetSheetId){return{background:this.background,sectionRule:this.sectionRule,title:this.title,type:"gauge",dataRange:dataRange?this.getters.getRangeString(dataRange,targetSheetId||this.sheetId):undefined,};}
getDefinitionForExcel(){return undefined;}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataRange?[this.getters.getRangeString(this.dataRange,this.sheetId)]:undefined,};}
updateRanges(applyChange){const range=adaptChartRange(this.dataRange,applyChange);if(this.dataRange===range){return this;}
const definition=this.getDefinitionWithSpecificRanges(range);return new GaugeChart(definition,this.sheetId,this.getters);}}
function getGaugeConfiguration(chart,locale){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,[],fontColor,{locale,});config.options.hover=undefined;config.options.events=[];config.options.layout={padding:{left:30,right:30,top:chart.title?10:25,bottom:25},};config.options.needle={width:10,borderColor:"#000000",backgroundColor:"#000000",};config.options.valueLabel={display:false,font:{size:30,color:"#FFFFFF",},backgroundColor:"#000000",borderColor:"#000000",borderRadius:5,padding:{top:5,right:5,bottom:5,left:5,},};return config;}
function createGaugeChartRuntime(chart,getters){const locale=getters.getLocale();const config=getGaugeConfiguration(chart,locale);const colors=chart.sectionRule.colors;const lowerPoint=chart.sectionRule.lowerInflectionPoint;const upperPoint=chart.sectionRule.upperInflectionPoint;const lowerPointValue=Number(lowerPoint.value);const upperPointValue=Number(upperPoint.value);const minNeedleValue=Number(chart.sectionRule.rangeMin);const maxNeedleValue=Number(chart.sectionRule.rangeMax);const needleCoverage=maxNeedleValue-minNeedleValue;const needleInflectionPoint=[];if(lowerPoint.value!==""){const lowerPointNeedleValue=lowerPoint.type==="number"?lowerPointValue:minNeedleValue+(needleCoverage*lowerPointValue)/100;needleInflectionPoint.push({value:clip(lowerPointNeedleValue,minNeedleValue,maxNeedleValue),color:colors.lowerColor,});}
if(upperPoint.value!==""){const upperPointNeedleValue=upperPoint.type==="number"?upperPointValue:minNeedleValue+(needleCoverage*upperPointValue)/100;needleInflectionPoint.push({value:clip(upperPointNeedleValue,minNeedleValue,maxNeedleValue),color:colors.middleColor,});}
const data=[];const backgroundColor=[];needleInflectionPoint.sort((a,b)=>a.value-b.value).map((point)=>{data.push(point.value);backgroundColor.push(point.color);});data.push(maxNeedleValue);backgroundColor.push(colors.upperColor);const dataRange=chart.dataRange;const deltaBeyondRangeLimit=needleCoverage/30;let needleValue=minNeedleValue-deltaBeyondRangeLimit;let cellFormatter=undefined;let displayValue=false;if(dataRange!==undefined){const cell=getters.getEvaluatedCell({sheetId:dataRange.sheetId,col:dataRange.zone.left,row:dataRange.zone.top,});if(cell.type===CellValueType.number){needleValue=clip(cell.value,minNeedleValue-deltaBeyondRangeLimit,maxNeedleValue+deltaBeyondRangeLimit);cellFormatter=()=>getters.getRangeFormattedValues(dataRange)[0];displayValue=true;}}
config.options.valueLabel.display=displayValue;config.options.valueLabel.formatter=cellFormatter;config.data.datasets.push({data,minValue:Number(chart.sectionRule.rangeMin),value:needleValue,backgroundColor,});return{chartJsConfig:config,background:getters.getStyleOfSingleCellChart(chart.background,dataRange).background,};}
const UNIT_LENGTH={second:1000,minute:1000*60,hour:1000*3600,day:1000*3600*24,month:1000*3600*24*30,year:1000*3600*24*365,};const Milliseconds={inSeconds:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.second);},inMinutes:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.minute);},inHours:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.hour);},inDays:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.day);},inMonths:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.month);},inYears:function(milliseconds){return Math.floor(milliseconds/UNIT_LENGTH.year);},};const timeFormatLuxonCompatible=/^((d|dd|m|mm|yyyy|yy|hh|h|ss|a)(-|:|\s|\/))*(d|dd|m|mm|yyyy|yy|hh|h|ss|a)$/i;function getChartTimeOptions(labels,labelFormat,locale){const luxonFormat=convertDateFormatForLuxon(labelFormat);const timeUnit=getBestTimeUnitForScale(labels,luxonFormat,locale);const displayFormats={};if(timeUnit){displayFormats[timeUnit]=luxonFormat;}
return{parser:luxonFormat,displayFormats,unit:timeUnit??false,};}
function convertDateFormatForLuxon(format){const indexH=format.indexOf("h");if(indexH>=0){format=format.slice(0,indexH).replace(/m/g,"M")+format.slice(indexH);}
else{format=format.replace(/m/g,"M");}
if(!format.includes("a")){format=format.replace(/h/g,"H");}
return format;}
function getFormatMinDisplayUnit(format){if(format.includes("s")){return"second";}
else if(format.includes("m")){return"minute";}
else if(format.includes("h")||format.includes("H")){return"hour";}
else if(format.includes("d")){return"day";}
else if(format.includes("M")){return"month";}
return"year";}
function getBestTimeUnitForScale(labels,format,locale){const labelDates=labels.map((label)=>parseDateTime(label,locale)?.jsDate);if(labelDates.some((date)=>date===undefined)||labels.length<2){return undefined;}
const labelsTimestamps=labelDates.map((date)=>date.getTime());const period=largeMax(labelsTimestamps)-largeMin(labelsTimestamps);const minUnit=getFormatMinDisplayUnit(format);if(UNIT_LENGTH.second>=UNIT_LENGTH[minUnit]&&Milliseconds.inSeconds(period)<180){return"second";}
else if(UNIT_LENGTH.minute>=UNIT_LENGTH[minUnit]&&Milliseconds.inMinutes(period)<180){return"minute";}
else if(UNIT_LENGTH.hour>=UNIT_LENGTH[minUnit]&&Milliseconds.inHours(period)<96){return"hour";}
else if(UNIT_LENGTH.day>=UNIT_LENGTH[minUnit]&&Milliseconds.inDays(period)<90){return"day";}
else if(UNIT_LENGTH.month>=UNIT_LENGTH[minUnit]&&Milliseconds.inMonths(period)<36){return"month";}
return"year";}
class LineChart extends AbstractChart{dataSets;labelRange;background;verticalAxisPosition;legendPosition;labelsAsText;stacked;aggregated;type="line";dataSetsHaveTitle;cumulative;constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataSets=createDataSets(this.getters,definition.dataSets,sheetId,definition.dataSetsHaveTitle);this.labelRange=createValidRange(this.getters,sheetId,definition.labelRange);this.background=definition.background;this.verticalAxisPosition=definition.verticalAxisPosition;this.legendPosition=definition.legendPosition;this.labelsAsText=definition.labelsAsText;this.stacked=definition.stacked;this.aggregated=definition.aggregated;this.dataSetsHaveTitle=definition.dataSetsHaveTitle;this.cumulative=definition.cumulative;}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkDataset,checkLabelRange);}
static transformDefinition(definition,executed){return transformChartDefinitionWithDataSetsWithZone(definition,executed);}
static getDefinitionFromContextCreation(context){return{background:context.background,dataSets:context.range?context.range:[],dataSetsHaveTitle:false,labelsAsText:false,legendPosition:"top",title:context.title||"",type:"line",verticalAxisPosition:"left",labelRange:context.auxiliaryRange||undefined,stacked:false,aggregated:false,cumulative:false,};}
getDefinition(){return this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange);}
getDefinitionWithSpecificDataSets(dataSets,labelRange,targetSheetId){return{type:"line",dataSetsHaveTitle:dataSets.length?Boolean(dataSets[0].labelCell):false,background:this.background,dataSets:dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,targetSheetId||this.sheetId)),legendPosition:this.legendPosition,verticalAxisPosition:this.verticalAxisPosition,labelRange:labelRange?this.getters.getRangeString(labelRange,targetSheetId||this.sheetId):undefined,title:this.title,labelsAsText:this.labelsAsText,stacked:this.stacked,aggregated:this.aggregated,cumulative:this.cumulative,};}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,this.sheetId)),auxiliaryRange:this.labelRange?this.getters.getRangeString(this.labelRange,this.sheetId):undefined,};}
updateRanges(applyChange){const{dataSets,labelRange,isStale}=updateChartRangesWithDataSets(this.getters,applyChange,this.dataSets,this.labelRange);if(!isStale){return this;}
const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange);return new LineChart(definition,this.sheetId,this.getters);}
getDefinitionForExcel(){if(this.aggregated)
return undefined;const dataSets=this.dataSets.map((ds)=>toExcelDataset(this.getters,ds)).filter((ds)=>ds.range!==""&&ds.range!==INCORRECT_RANGE_STRING);const labelRange=toExcelLabelRange(this.getters,this.labelRange,shouldRemoveFirstLabel(this.labelRange,this.dataSets[0],this.dataSetsHaveTitle));return{...this.getDefinition(),backgroundColor:toXlsxHexColor(this.background||BACKGROUND_CHART_COLOR),fontColor:toXlsxHexColor(chartFontColor(this.background)),dataSets,labelRange,};}
copyForSheetId(sheetId){const dataSets=copyDataSetsWithNewSheetId(this.sheetId,sheetId,this.dataSets);const labelRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.labelRange);const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange,sheetId);return new LineChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange,sheetId);return new LineChart(definition,sheetId,this.getters);}}
function fixEmptyLabelsForDateCharts(labels,dataSetsValues){if(labels.length===0||labels.every((label)=>!label)){return{labels,dataSetsValues};}
const newLabels=[...labels];const newDatasets=deepCopy(dataSetsValues);for(let i=0;i<newLabels.length;i++){if(!newLabels[i]){newLabels[i]=findNextDefinedValue(newLabels,i);for(let ds of newDatasets){ds.data[i]=undefined;}}}
return{labels:newLabels,dataSetsValues:newDatasets};}
function canChartParseLabels(labelRange,getters){return canBeDateChart(labelRange,getters)||canBeLinearChart(labelRange,getters);}
function getChartAxisType(chart,getters){if(isDateChart(chart,getters)&&isLuxonTimeAdapterInstalled()){return"time";}
if(isLinearChart(chart,getters)){return"linear";}
return"category";}
function isDateChart(chart,getters){return!chart.labelsAsText&&canBeDateChart(chart.labelRange,getters);}
function isLinearChart(chart,getters){return!chart.labelsAsText&&canBeLinearChart(chart.labelRange,getters);}
function canBeDateChart(labelRange,getters){if(!labelRange||!canBeLinearChart(labelRange,getters)){return false;}
const labelFormat=getters.getEvaluatedCell({sheetId:labelRange.sheetId,col:labelRange.zone.left,row:labelRange.zone.top,}).format;return Boolean(labelFormat&&timeFormatLuxonCompatible.test(labelFormat));}
function canBeLinearChart(labelRange,getters){if(!labelRange){return false;}
const labels=getters.getRangeValues(labelRange);if(labels.some((label)=>isNaN(Number(label))&&label)){return false;}
if(labels.every((label)=>!label)){return false;}
return true;}
function getLineConfiguration(chart,labels,options){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,options);const legend={labels:{color:fontColor,generateLabels(chart){const{data}=chart;const labels=window.Chart.defaults.plugins.legend.labels.generateLabels(chart);for(const[index,label]of labels.entries()){label.fillStyle=data.datasets[index].borderColor;}
return labels;},},};if((!chart.labelRange&&chart.dataSets.length===1)||chart.legendPosition==="none"){legend.display=false;}
else{legend.position=chart.legendPosition;}
Object.assign(config.options.plugins.legend||{},legend);config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.scales={x:{ticks:{padding:5,color:fontColor,},},y:{position:chart.verticalAxisPosition,beginAtZero:true,ticks:{color:fontColor,callback:(value)=>{value=Number(value);if(isNaN(value))
return value;const{locale,format}=options;return formatValue(value,{locale,format:!format&&Math.abs(value)>=1000?"#,##":format,});},},},};if(chart.stacked&&config.options?.scales?.y){config.options.scales.y.stacked=true;}
return config;}
function createLineChartRuntime(chart,getters){const axisType=getChartAxisType(chart,getters);const labelValues=getChartLabelValues(getters,chart.dataSets,chart.labelRange);let labels=axisType==="linear"?labelValues.values:labelValues.formattedValues;let dataSetsValues=getChartDatasetValues(getters,chart.dataSets);if(chart.dataSetsHaveTitle&&dataSetsValues[0]&&labels.length>dataSetsValues[0].data.length){labels.shift();}
({labels,dataSetsValues}=filterEmptyDataPoints(labels,dataSetsValues));if(axisType==="time"){({labels,dataSetsValues}=fixEmptyLabelsForDateCharts(labels,dataSetsValues));}
if(chart.aggregated){({labels,dataSetsValues}=aggregateDataForLabels(labels,dataSetsValues));}
const locale=getters.getLocale();const truncateLabels=axisType==="category";const dataSetFormat=getChartDatasetFormat(getters,chart.dataSets);const options={format:dataSetFormat,locale,truncateLabels};const config=getLineConfiguration(chart,labels,options);const labelFormat=getChartLabelFormat(getters,chart.labelRange);if(axisType==="time"){const axis={type:"time",time:getChartTimeOptions(labels,labelFormat,locale),};Object.assign(config.options.scales.x,axis);config.options.scales.x.ticks.maxTicksLimit=15;}
else if(axisType==="linear"){config.options.scales.x.type="linear";config.options.scales.x.ticks.callback=(value)=>formatValue(value,{format:labelFormat,locale});config.options.plugins.tooltip.callbacks.title=(tooltipItem)=>{return formatValue(tooltipItem[0].parsed.x||tooltipItem[0].label,{locale,format:labelFormat,});};}
const colors=new ChartColors();for(let[index,{label,data}]of dataSetsValues.entries()){if(["linear","time"].includes(axisType)){data=data.map((y,index)=>({x:labels[index]||undefined,y}));}
const color=colors.next();let backgroundRGBA=colorToRGBA(color);if(chart.stacked){backgroundRGBA.a=LINE_FILL_TRANSPARENCY;}
if(chart.cumulative){let accumulator=0;data=data.map((value)=>{if(!isNaN(value)){accumulator+=parseFloat(value);return accumulator;}
return value;});}
const backgroundColor=rgbaToHex(backgroundRGBA);const dataset={label,data,tension:0,borderColor:color,backgroundColor,pointBackgroundColor:color,fill:chart.stacked?getFillingMode(index):false,};config.data.datasets.push(dataset);}
return{chartJsConfig:config,background:chart.background||BACKGROUND_CHART_COLOR};}
let missingTimeAdapterAlreadyWarned=false;function isLuxonTimeAdapterInstalled(){if(!window.Chart){return false;}
const adapter=new window.Chart._adapters._date({});const isInstalled=adapter._id==="luxon";if(!isInstalled&&!missingTimeAdapterAlreadyWarned){missingTimeAdapterAlreadyWarned=true;console.warn("'chartjs-adapter-luxon' time adapter is not installed. Time scale axes are disabled.");}
return isInstalled;}
class PieChart extends AbstractChart{dataSets;labelRange;background;legendPosition;type="pie";aggregated;dataSetsHaveTitle;constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.dataSets=createDataSets(getters,definition.dataSets,sheetId,definition.dataSetsHaveTitle);this.labelRange=createValidRange(getters,sheetId,definition.labelRange);this.background=definition.background;this.legendPosition=definition.legendPosition;this.aggregated=definition.aggregated;this.dataSetsHaveTitle=definition.dataSetsHaveTitle;}
static transformDefinition(definition,executed){return transformChartDefinitionWithDataSetsWithZone(definition,executed);}
static validateChartDefinition(validator,definition){return validator.checkValidations(definition,checkDataset,checkLabelRange);}
static getDefinitionFromContextCreation(context){return{background:context.background,dataSets:context.range?context.range:[],dataSetsHaveTitle:false,legendPosition:"top",title:context.title||"",type:"pie",labelRange:context.auxiliaryRange||undefined,aggregated:false,};}
getDefinition(){return this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange);}
getContextCreation(){return{background:this.background,title:this.title,range:this.dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,this.sheetId)),auxiliaryRange:this.labelRange?this.getters.getRangeString(this.labelRange,this.sheetId):undefined,};}
getDefinitionWithSpecificDataSets(dataSets,labelRange,targetSheetId){return{type:"pie",dataSetsHaveTitle:dataSets.length?Boolean(dataSets[0].labelCell):false,background:this.background,dataSets:dataSets.map((ds)=>this.getters.getRangeString(ds.dataRange,targetSheetId||this.sheetId)),legendPosition:this.legendPosition,labelRange:labelRange?this.getters.getRangeString(labelRange,targetSheetId||this.sheetId):undefined,title:this.title,aggregated:this.aggregated,};}
copyForSheetId(sheetId){const dataSets=copyDataSetsWithNewSheetId(this.sheetId,sheetId,this.dataSets);const labelRange=copyLabelRangeWithNewSheetId(this.sheetId,sheetId,this.labelRange);const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange,sheetId);return new PieChart(definition,sheetId,this.getters);}
copyInSheetId(sheetId){const definition=this.getDefinitionWithSpecificDataSets(this.dataSets,this.labelRange,sheetId);return new PieChart(definition,sheetId,this.getters);}
getDefinitionForExcel(){if(this.aggregated)
return undefined;const dataSets=this.dataSets.map((ds)=>toExcelDataset(this.getters,ds)).filter((ds)=>ds.range!==""&&ds.range!==INCORRECT_RANGE_STRING);const labelRange=toExcelLabelRange(this.getters,this.labelRange,shouldRemoveFirstLabel(this.labelRange,this.dataSets[0],this.dataSetsHaveTitle));return{...this.getDefinition(),backgroundColor:toXlsxHexColor(this.background||BACKGROUND_CHART_COLOR),fontColor:toXlsxHexColor(chartFontColor(this.background)),verticalAxisPosition:"left",dataSets,labelRange,};}
updateRanges(applyChange){const{dataSets,labelRange,isStale}=updateChartRangesWithDataSets(this.getters,applyChange,this.dataSets,this.labelRange);if(!isStale){return this;}
const definition=this.getDefinitionWithSpecificDataSets(dataSets,labelRange);return new PieChart(definition,this.sheetId,this.getters);}}
function getPieConfiguration(chart,labels,localeFormat){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,localeFormat);const legend={labels:{color:fontColor},};if((!chart.labelRange&&chart.dataSets.length===1)||chart.legendPosition==="none"){legend.display=false;}
else{legend.position=chart.legendPosition;}
Object.assign(config.options.plugins.legend||{},legend);config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.plugins.tooltip.callbacks.title=function(tooltipItems){return tooltipItems[0].dataset.label;};config.options.plugins.tooltip.callbacks.label=function(tooltipItem){const{format,locale}=localeFormat;const data=tooltipItem.dataset.data;const dataIndex=tooltipItem.dataIndex;const percentage=calculatePercentage(data,dataIndex);const xLabel=tooltipItem.label||tooltipItem.dataset.label;const yLabel=tooltipItem.parsed.y??tooltipItem.parsed;const toolTipFormat=!format&&Math.abs(yLabel)>=1000?"#,##":format;const yLabelStr=formatValue(yLabel,{format:toolTipFormat,locale});return xLabel?`${xLabel}: ${yLabelStr} (${percentage}%)`:`${yLabelStr} (${percentage}%)`;};return config;}
function getPieColors(colors,dataSetsValues){const pieColors=[];const maxLength=largeMax(dataSetsValues.map((ds)=>ds.data.length));for(let i=0;i<=maxLength;i++){pieColors.push(colors.next());}
return pieColors;}
function calculatePercentage(dataset,dataIndex){const numericData=dataset.filter((value)=>typeof value==="number");const total=numericData.reduce((sum,value)=>sum+value,0);if(!total){return"";}
const percentage=(dataset[dataIndex]/total)*100;return percentage.toFixed(2);}
function createPieChartRuntime(chart,getters){const labelValues=getChartLabelValues(getters,chart.dataSets,chart.labelRange);let labels=labelValues.formattedValues;let dataSetsValues=getChartDatasetValues(getters,chart.dataSets);if(chart.dataSetsHaveTitle&&dataSetsValues[0]&&labels.length>dataSetsValues[0].data.length){labels.shift();}
({labels,dataSetsValues}=filterEmptyDataPoints(labels,dataSetsValues));if(chart.aggregated){({labels,dataSetsValues}=aggregateDataForLabels(labels,dataSetsValues));}
const dataSetFormat=getChartDatasetFormat(getters,chart.dataSets);const locale=getters.getLocale();const config=getPieConfiguration(chart,labels,{format:dataSetFormat,locale});const colors=new ChartColors();for(let{label,data}of dataSetsValues){const backgroundColor=getPieColors(colors,dataSetsValues);const dataset={label,data,borderColor:"#FFFFFF",backgroundColor,};config.data.datasets.push(dataset);}
return{chartJsConfig:config,background:chart.background||BACKGROUND_CHART_COLOR};}
const chartRegistry=new Registry();chartRegistry.add("bar",{match:(type)=>type==="bar",createChart:(definition,sheetId,getters)=>new BarChart(definition,sheetId,getters),getChartRuntime:createBarChartRuntime,validateChartDefinition:(validator,definition)=>BarChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>BarChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>BarChart.getDefinitionFromContextCreation(context),name:_t("Bar"),sequence:10,});chartRegistry.add("line",{match:(type)=>type==="line",createChart:(definition,sheetId,getters)=>new LineChart(definition,sheetId,getters),getChartRuntime:createLineChartRuntime,validateChartDefinition:(validator,definition)=>LineChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>LineChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>LineChart.getDefinitionFromContextCreation(context),name:_t("Line"),sequence:20,});chartRegistry.add("pie",{match:(type)=>type==="pie",createChart:(definition,sheetId,getters)=>new PieChart(definition,sheetId,getters),getChartRuntime:createPieChartRuntime,validateChartDefinition:(validator,definition)=>PieChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>PieChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>PieChart.getDefinitionFromContextCreation(context),name:_t("Pie"),sequence:30,});chartRegistry.add("scorecard",{match:(type)=>type==="scorecard",createChart:(definition,sheetId,getters)=>new ScorecardChart$1(definition,sheetId,getters),getChartRuntime:createScorecardChartRuntime,validateChartDefinition:(validator,definition)=>ScorecardChart$1.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>ScorecardChart$1.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>ScorecardChart$1.getDefinitionFromContextCreation(context),name:_t("Scorecard"),sequence:40,});chartRegistry.add("gauge",{match:(type)=>type==="gauge",createChart:(definition,sheetId,getters)=>new GaugeChart(definition,sheetId,getters),getChartRuntime:createGaugeChartRuntime,validateChartDefinition:(validator,definition)=>GaugeChart.validateChartDefinition(validator,definition),transformDefinition:(definition,executed)=>GaugeChart.transformDefinition(definition,executed),getChartDefinitionFromContextCreation:(context)=>GaugeChart.getDefinitionFromContextCreation(context),name:_t("Gauge"),sequence:50,});const chartComponentRegistry=new Registry();chartComponentRegistry.add("line",ChartJsComponent);chartComponentRegistry.add("bar",ChartJsComponent);chartComponentRegistry.add("pie",ChartJsComponent);chartComponentRegistry.add("gauge",ChartJsComponent);chartComponentRegistry.add("scorecard",ScorecardChart);const currenciesRegistry=new Registry();css`
  .o-chart-container {
    width: 100%;
    height: 100%;
    position: relative;
  }
`;class ChartFigure extends owl.Component{static template="o-spreadsheet-ChartFigure";static components={};onDoubleClick(){this.env.model.dispatch("SELECT_FIGURE",{id:this.props.figure.id});this.env.openSidePanel("ChartPanel");}
get chartType(){return this.env.model.getters.getChartType(this.props.figure.id);}
get chartComponent(){const type=this.chartType;const component=chartComponentRegistry.get(type);if(!component){throw new Error(`Component is not defined for type ${type}`);}
return component;}}
ChartFigure.props={figure:Object,onFigureDeleted:Function,};class ImageFigure extends owl.Component{static template="o-spreadsheet-ImageFigure";static components={};get figureId(){return this.props.figure.id;}
get getImagePath(){return this.env.model.getters.getImagePath(this.figureId);}}
ImageFigure.props={figure:Object,onFigureDeleted:Function,};function centerFigurePosition(getters,size){const{x:offsetCorrectionX,y:offsetCorrectionY}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();const dim=getters.getSheetViewDimension();const rect=getters.getVisibleRect(getters.getActiveMainViewport());const scrollableViewportWidth=Math.min(rect.width,dim.width-offsetCorrectionX);const scrollableViewportHeight=Math.min(rect.height,dim.height-offsetCorrectionY);const position={x:offsetCorrectionX+scrollX+Math.max(0,(scrollableViewportWidth-size.width)/2),y:offsetCorrectionY+scrollY+Math.max(0,(scrollableViewportHeight-size.height)/2),};return position;}
function getMaxFigureSize(getters,figureSize){const size=deepCopy(figureSize);const dim=getters.getSheetViewDimension();const maxWidth=dim.width;const maxHeight=dim.height;if(size.width>maxWidth){const ratio=maxWidth/size.width;size.width=maxWidth;size.height=size.height*ratio;}
if(size.height>maxHeight){const ratio=maxHeight/size.height;size.height=maxHeight;size.width=size.width*ratio;}
return size;}
const figureRegistry=new Registry();figureRegistry.add("chart",{Component:ChartFigure,SidePanelComponent:"ChartPanel",menuBuilder:getChartMenu,});figureRegistry.add("image",{Component:ImageFigure,keepRatio:true,minFigSize:20,borderWidth:0,menuBuilder:getImageMenuRegistry,});function getChartMenu(figureId,onFigureDeleted,env){const menuItemSpecs=[{id:"edit",name:_t("Edit"),sequence:1,execute:()=>{env.model.dispatch("SELECT_FIGURE",{id:figureId});env.openSidePanel("ChartPanel");},icon:"o-spreadsheet-Icon.EDIT",},getCopyMenuItem(figureId,env),getCutMenuItem(figureId,env),getDeleteMenuItem(figureId,onFigureDeleted,env),];return createActions(menuItemSpecs);}
function getImageMenuRegistry(figureId,onFigureDeleted,env){const menuItemSpecs=[getCopyMenuItem(figureId,env),getCutMenuItem(figureId,env),{id:"reset_size",name:_t("Reset size"),sequence:4,execute:async()=>{const imagePath=env.model.getters.getImagePath(figureId);const size=env.model.getters.getImageSize(figureId)??(await env.imageProvider?.getImageOriginalSize(imagePath));if(!env.model.getters.getImageSize(figureId)){const image=env.model.getters.getImage(figureId);image.size=size;}
const{height,width}=getMaxFigureSize(env.model.getters,size);env.model.dispatch("UPDATE_FIGURE",{sheetId:env.model.getters.getActiveSheetId(),id:figureId,height,width,});},icon:"o-spreadsheet-Icon.REFRESH",},getDeleteMenuItem(figureId,onFigureDeleted,env),];return createActions(menuItemSpecs);}
function getCopyMenuItem(figureId,env){return{id:"copy",name:_t("Copy"),sequence:2,description:"Ctrl+C",execute:async()=>{env.model.dispatch("SELECT_FIGURE",{id:figureId});env.model.dispatch("COPY");await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.COPY",};}
function getCutMenuItem(figureId,env){return{id:"cut",name:_t("Cut"),sequence:3,description:"Ctrl+X",execute:async()=>{env.model.dispatch("SELECT_FIGURE",{id:figureId});env.model.dispatch("CUT");await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.CUT",};}
function getDeleteMenuItem(figureId,onFigureDeleted,env){return{id:"delete",name:_t("Delete"),sequence:10,execute:()=>{env.model.dispatch("DELETE_FIGURE",{sheetId:env.model.getters.getActiveSheetId(),id:figureId,});onFigureDeleted();},icon:"o-spreadsheet-Icon.DELETE",};}
const inverseCommandRegistry=new Registry().add("ADD_COLUMNS_ROWS",inverseAddColumnsRows).add("REMOVE_COLUMNS_ROWS",inverseRemoveColumnsRows).add("ADD_MERGE",inverseAddMerge).add("REMOVE_MERGE",inverseRemoveMerge).add("CREATE_SHEET",inverseCreateSheet).add("DELETE_SHEET",inverseDeleteSheet).add("DUPLICATE_SHEET",inverseDuplicateSheet).add("CREATE_FIGURE",inverseCreateFigure).add("CREATE_CHART",inverseCreateChart).add("HIDE_COLUMNS_ROWS",inverseHideColumnsRows).add("UNHIDE_COLUMNS_ROWS",inverseUnhideColumnsRows);for(const cmd of coreTypes.values()){if(!inverseCommandRegistry.contains(cmd)){inverseCommandRegistry.add(cmd,identity);}}
function identity(cmd){return[cmd];}
function inverseAddColumnsRows(cmd){const elements=[];let start=cmd.base;if(cmd.position==="after"){start++;}
for(let i=0;i<cmd.quantity;i++){elements.push(i+start);}
return[{type:"REMOVE_COLUMNS_ROWS",dimension:cmd.dimension,elements,sheetId:cmd.sheetId,},];}
function inverseAddMerge(cmd){return[{type:"REMOVE_MERGE",sheetId:cmd.sheetId,target:cmd.target}];}
function inverseRemoveMerge(cmd){return[{type:"ADD_MERGE",sheetId:cmd.sheetId,target:cmd.target}];}
function inverseCreateSheet(cmd){return[{type:"DELETE_SHEET",sheetId:cmd.sheetId}];}
function inverseDuplicateSheet(cmd){return[{type:"DELETE_SHEET",sheetId:cmd.sheetIdTo}];}
function inverseRemoveColumnsRows(cmd){const commands=[];const elements=[...cmd.elements].sort((a,b)=>a-b);for(let group of groupConsecutive(elements)){const column=group[0]===0?0:group[0]-1;const position=group[0]===0?"before":"after";commands.push({type:"ADD_COLUMNS_ROWS",dimension:cmd.dimension,quantity:group.length,base:column,sheetId:cmd.sheetId,position,});}
return commands;}
function inverseDeleteSheet(cmd){return[{type:"CREATE_SHEET",sheetId:cmd.sheetId,position:1}];}
function inverseCreateFigure(cmd){return[{type:"DELETE_FIGURE",id:cmd.figure.id,sheetId:cmd.sheetId}];}
function inverseCreateChart(cmd){return[{type:"DELETE_FIGURE",id:cmd.id,sheetId:cmd.sheetId}];}
function inverseHideColumnsRows(cmd){return[{type:"UNHIDE_COLUMNS_ROWS",sheetId:cmd.sheetId,dimension:cmd.dimension,elements:cmd.elements,},];}
function inverseUnhideColumnsRows(cmd){return[{type:"HIDE_COLUMNS_ROWS",sheetId:cmd.sheetId,dimension:cmd.dimension,elements:cmd.elements,},];}
function interactiveCut(env){const result=env.model.dispatch("CUT");if(!result.isSuccessful){if(result.isCancelledBecause("WrongCutSelection")){env.raiseError(_t("This operation is not allowed with multiple selections."));}}}
const AddMergeInteractiveContent={MergeIsDestructive:_t("Merging these cells will only preserve the top-leftmost value. Merge anyway?"),MergeInFilter:_t("You can't merge cells inside of an existing filter."),};function interactiveAddMerge(env,sheetId,target){const result=env.model.dispatch("ADD_MERGE",{sheetId,target});if(result.isCancelledBecause("MergeInFilter")){env.raiseError(AddMergeInteractiveContent.MergeInFilter);}
else if(result.isCancelledBecause("MergeIsDestructive")){env.askConfirmation(AddMergeInteractiveContent.MergeIsDestructive,()=>{env.model.dispatch("ADD_MERGE",{sheetId,target,force:true});});}}
function chartFactory(getters){const builders=chartRegistry.getAll().sort((a,b)=>a.sequence-b.sequence);function createChart(id,definition,sheetId){const builder=builders.find((builder)=>builder.match(definition.type));if(!builder){throw new Error(`No builder for this chart: ${definition.type}`);}
return builder.createChart(definition,sheetId,getters);}
return createChart;}
function chartRuntimeFactory(getters){const builders=chartRegistry.getAll().sort((a,b)=>a.sequence-b.sequence);function createRuntimeChart(chart){const builder=builders.find((builder)=>builder.match(chart.type));if(!builder){throw new Error("No runtime builder for this chart.");}
return builder.getChartRuntime(chart,getters);}
return createRuntimeChart;}
function validateChartDefinition(validator,definition){const validators=chartRegistry.getAll().find((validator)=>validator.match(definition.type));if(!validators){throw new Error("Unknown chart type.");}
return validators.validateChartDefinition(validator,definition);}
function transformDefinition(definition,executed){const transformation=chartRegistry.getAll().find((factory)=>factory.match(definition.type));if(!transformation){throw new Error("Unknown chart type.");}
return transformation.transformDefinition(definition,executed);}
function getChartDefinitionFromContextCreation(context,type){const chartClass=chartRegistry.get(type);return chartClass.getChartDefinitionFromContextCreation(context);}
function getChartTypes(){const result={};for(const key of chartRegistry.getKeys()){result[key]=chartRegistry.get(key).name;}
return result;}
function getSmartChartDefinition(zone,getters){let dataSetZone=zone;if(zone.left!==zone.right){dataSetZone={...zone,left:zone.left+1};}
const dataSets=[zoneToXc(dataSetZone)];const sheetId=getters.getActiveSheetId();const topLeftCell=getters.getCell({sheetId,col:zone.left,row:zone.top});if(getZoneArea(zone)===1&&topLeftCell?.content){return{type:"scorecard",title:"",background:topLeftCell.style?.fillColor||undefined,keyValue:zoneToXc(zone),baselineMode:DEFAULT_SCORECARD_BASELINE_MODE,baselineColorUp:DEFAULT_SCORECARD_BASELINE_COLOR_UP,baselineColorDown:DEFAULT_SCORECARD_BASELINE_COLOR_DOWN,};}
let title="";const cellsInFirstRow=getters.getEvaluatedCellsInZone(sheetId,{...dataSetZone,bottom:dataSetZone.top,});const dataSetsHaveTitle=!!cellsInFirstRow.find((cell)=>cell.type!==CellValueType.empty&&cell.type!==CellValueType.number);if(dataSetsHaveTitle){const texts=cellsInFirstRow.filter((cell)=>cell.type!==CellValueType.error&&cell.type!==CellValueType.empty).map((cell)=>cell.formattedValue);const lastElement=texts.splice(-1)[0];title=texts.join(", ");if(lastElement){title+=(title?" "+_t("and")+" ":"")+lastElement;}}
let labelRangeXc;if(zone.left!==zone.right){labelRangeXc=zoneToXc({...zone,right:zone.left,});}
const newLegendPos=dataSetZone.right===dataSetZone.left?"none":"top";const labelRange=labelRangeXc?getters.getRangeFromSheetXC(sheetId,labelRangeXc):undefined;if(canChartParseLabels(labelRange,getters)){return{title,dataSets,labelsAsText:false,stacked:false,aggregated:false,cumulative:false,labelRange:labelRangeXc,type:"line",dataSetsHaveTitle,verticalAxisPosition:"left",legendPosition:newLegendPos,};}
return{title,dataSets,labelRange:labelRangeXc,type:"bar",stacked:false,aggregated:false,dataSetsHaveTitle,verticalAxisPosition:"left",legendPosition:newLegendPos,};}
if(window.Chart){const DoughnutController=window.Chart?.DoughnutController;class GaugeController extends DoughnutController{static id="gauge";static defaults={...DoughnutController.defaults,circumference:180,rotation:270,};static overrides={aspectRatio:2,plugins:{legend:{display:false,},tooltip:{enabled:false,},},};get chartHeight(){return Math.abs(this.chart.chartArea.top-this.chart.chartArea.bottom);}
get chartWidth(){return Math.abs(this.chart.chartArea.left-this.chart.chartArea.right);}
get needleOptions(){const{config}=this.chart;const options=config.options;return options?.needle||{};}
get valueLabelOptions(){const{config}=this.chart;const options=config.options;return options?.valueLabel||{};}
get minValue(){const dataset=this.getDataset();return dataset.minValue||0;}
getValueAngleInPercent(value){const dataset=this.getDataset();const data=dataset.data||[];const max=Math.max(...data);const min=this.minValue;return(value-min)/(max-min);}
drawValueLabel(params){const{ctx}=this.chart;if(this.valueLabelOptions.display===false){return;}
ctx.save();ctx.beginPath();ctx.fillStyle=params.valueLabel.backgroundColor;ctx.strokeStyle=params.valueLabel.borderColor;ctx.roundRect(params.valueLabel.rect.x,params.valueLabel.rect.y,params.valueLabel.rect.width,params.valueLabel.rect.height,params.valueLabel.borderRadius);ctx.stroke();ctx.fill();ctx.textAlign="center";ctx.textBaseline="middle";ctx.font=params.valueLabel.font;ctx.fillStyle=params.valueLabel.textColor;ctx.fillText(params.valueLabel.valueText,params.valueLabel.textPosition.x,params.valueLabel.textPosition.y);ctx.restore();}
drawNeedle(params){const{ctx}=this.chart;if(this.needleOptions.display===false){return;}
ctx.save();ctx.translate(params.needle.position.x,params.needle.position.y);ctx.rotate(-Math.PI/2+Math.PI*params.needle.percent);ctx.beginPath();ctx.fillStyle=params.needle.backgroundColor;ctx.strokeStyle=params.needle.borderColor;ctx.ellipse(0,0,params.needle.width/2,params.needle.width/2,0,0,2*Math.PI);ctx.fill();ctx.stroke();ctx.closePath();ctx.fillStyle=params.needle.backgroundColor;ctx.strokeStyle=params.needle.borderColor;ctx.beginPath();ctx.moveTo(-params.needle.width/2,0);ctx.lineTo(0,-params.needle.height+10);ctx.lineTo(+params.needle.width/2,0);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();}
computeRenderingParams(){const{ctx,config}=this.chart;const options=config.options;options.layout=options.layout||{};options.layout.padding=options.layout.padding||{};const formatter=this.valueLabelOptions.formatter;const fmt=typeof formatter==="function"?formatter:(value)=>value;const dataset=this.getDataset();const value=dataset.value||0;const valueText=fmt(value).toString();const percent=this.getValueAngleInPercent(value);const fontFamily=this.valueLabelOptions.font?.family||"Arial";const optionsFontSize=this.valueLabelOptions.font?.size||0;const fontSize=optionsFontSize>=1?optionsFontSize:30;const font=`${fontSize}px ${fontFamily}`;const padding={right:0,left:0,top:0,bottom:0,...this.valueLabelOptions.padding,};padding.left=padding.left>=0?padding.left:10;padding.right=padding.right>=0?padding.right:10;padding.top=padding.top>=0?padding.top:10;padding.bottom=padding.bottom>=0?padding.bottom:10;const chartArea=this.chart.chartArea;const offsetX=this.offsetX||0;const offsetY=this.offsetY||0;const centerX=(chartArea.left+chartArea.right)/2;const centerY=(chartArea.top+chartArea.bottom)/2;const center={x:centerX+offsetX,y:centerY+offsetY,};const textPosition={x:center.x,y:center.y,};ctx.save();ctx.font=font;const metrics=ctx.measureText(valueText);ctx.restore();const textHeight=metrics.fontBoundingBoxAscent-metrics.fontBoundingBoxDescent;return{needle:{borderColor:this.needleOptions.borderColor||"#000",backgroundColor:this.needleOptions.backgroundColor||"#000",width:this.needleOptions.width||10,height:Math.min(this.chartHeight,this.chartWidth/2),position:{x:textPosition.x,y:textPosition.y,},percent,},valueLabel:{textColor:this.valueLabelOptions.font?.color||"#FFF",backgroundColor:this.valueLabelOptions.backgroundColor||"#000",borderColor:this.valueLabelOptions.borderColor||"#000",borderRadius:this.valueLabelOptions.borderRadius||10,rect:{x:center.x-metrics.width/2-padding.left,y:center.y+textHeight/2+padding.top,width:metrics.width+padding.left+padding.right,height:-(textHeight+6+padding.top+padding.bottom),},valueText,textPosition,textHeight,font,},};}
draw(){super.draw();const params=this.computeRenderingParams();this.drawNeedle(params);this.drawValueLabel(params);}
updateElements(elements,start,count,mode){super.updateElements(elements,start,count,mode);const dataset=this.getDataset();const data=this.getDataset().data;const minValue=dataset.minValue;const rotation=this.chart.options.rotation||0;const circumference=this.chart.options.circumference||0;for(let arcIndex=0;arcIndex<data.length;arcIndex++){const previousValue=arcIndex===0?minValue:data[arcIndex-1];const startAngleInPercent=this.getValueAngleInPercent(previousValue);const endAngleInPercent=this.getValueAngleInPercent(data[arcIndex]);const startAngle=degreesToRadians(rotation+circumference*startAngleInPercent)-Math.PI/2;const endAngle=degreesToRadians(rotation+circumference*endAngleInPercent)-Math.PI/2;const arcCircumference=endAngle-startAngle;const arc=elements[arcIndex];const propertiesUpdates={startAngle,endAngle,circumference:arcCircumference,};this.updateElement(arc,arcIndex,propertiesUpdates,mode);}}}
function degreesToRadians(degrees){return(degrees*Math.PI)/180;}
window.Chart.register(GaugeController);}
function setFormatter(env,format){env.model.dispatch("CANCEL_EDITION");env.model.dispatch("SET_FORMATTING",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),format,});}
function setStyle(env,style){env.model.dispatch("SET_FORMATTING",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),style,});}
const PASTE_ACTION=async(env)=>paste$1(env);const PASTE_VALUE_ACTION=async(env)=>paste$1(env,"onlyValue");async function paste$1(env,pasteOption){const spreadsheetClipboard=env.model.getters.getClipboardTextContent();const osClipboard=await env.clipboard.readText();switch(osClipboard.status){case"ok":const target=env.model.getters.getSelectedZones();if(osClipboard&&osClipboard.content!==spreadsheetClipboard){interactivePasteFromOS(env,target,osClipboard.content,pasteOption);}
else{interactivePaste(env,target,pasteOption);}
if(env.model.getters.isCutOperation()&&pasteOption!=="onlyValue"){await env.clipboard.write({[ClipboardMIMEType.PlainText]:""});}
break;case"notImplemented":env.raiseError(_t("Pasting from the context menu is not supported in this browser. Use keyboard shortcuts ctrl+c / ctrl+v instead."));break;case"permissionDenied":env.raiseError(_t("Access to the clipboard denied by the browser. Please enable clipboard permission for this page in your browser settings."));break;}}
const PASTE_FORMAT_ACTION=(env)=>paste$1(env,"onlyFormat");const DELETE_CONTENT_ROWS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Clear rows");}
let first;let last;const activesRows=env.model.getters.getActiveRows();if(activesRows.size!==0){first=largeMin([...activesRows]);last=largeMax([...activesRows]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.top;last=zone.bottom;}
if(first===last){return _t("Clear row %s",(first+1).toString());}
return _t("Clear rows %s - %s",(first+1).toString(),(last+1).toString());};const DELETE_CONTENT_ROWS_ACTION=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const target=[...env.model.getters.getActiveRows()].map((index)=>env.model.getters.getRowsZone(sheetId,index,index));env.model.dispatch("DELETE_CONTENT",{target,sheetId:env.model.getters.getActiveSheetId(),});};const DELETE_CONTENT_COLUMNS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Clear columns");}
let first;let last;const activeCols=env.model.getters.getActiveCols();if(activeCols.size!==0){first=largeMin([...activeCols]);last=largeMax([...activeCols]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.left;last=zone.right;}
if(first===last){return _t("Clear column %s",numberToLetters(first));}
return _t("Clear columns %s - %s",numberToLetters(first),numberToLetters(last));};const DELETE_CONTENT_COLUMNS_ACTION=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const target=[...env.model.getters.getActiveCols()].map((index)=>env.model.getters.getColsZone(sheetId,index,index));env.model.dispatch("DELETE_CONTENT",{target,sheetId:env.model.getters.getActiveSheetId(),});};const REMOVE_ROWS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Delete rows");}
let first;let last;const activesRows=env.model.getters.getActiveRows();if(activesRows.size!==0){first=largeMin([...activesRows]);last=largeMax([...activesRows]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.top;last=zone.bottom;}
if(first===last){return _t("Delete row %s",(first+1).toString());}
return _t("Delete rows %s - %s",(first+1).toString(),(last+1).toString());};const REMOVE_ROWS_ACTION=(env)=>{let rows=[...env.model.getters.getActiveRows()];if(!rows.length){const zone=env.model.getters.getSelectedZones()[0];for(let i=zone.top;i<=zone.bottom;i++){rows.push(i);}}
env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"ROW",elements:rows,});};const CAN_REMOVE_COLUMNS_ROWS=(dimension,env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedElements=env.model.getters.getElementsFromSelection(dimension);const includesAllVisibleHeaders=env.model.getters.checkElementsIncludeAllVisibleHeaders(sheetId,dimension,selectedElements);const includesAllNonFrozenHeaders=env.model.getters.checkElementsIncludeAllNonFrozenHeaders(sheetId,dimension,selectedElements);return!includesAllVisibleHeaders&&!includesAllNonFrozenHeaders;};const REMOVE_COLUMNS_NAME=(env)=>{if(env.model.getters.getSelectedZones().length>1){return _t("Delete columns");}
let first;let last;const activeCols=env.model.getters.getActiveCols();if(activeCols.size!==0){first=largeMin([...activeCols]);last=largeMax([...activeCols]);}
else{const zone=env.model.getters.getSelectedZones()[0];first=zone.left;last=zone.right;}
if(first===last){return _t("Delete column %s",numberToLetters(first));}
return _t("Delete columns %s - %s",numberToLetters(first),numberToLetters(last));};const NOT_ALL_VISIBLE_ROWS_SELECTED=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedRows=env.model.getters.getElementsFromSelection("ROW");return!env.model.getters.checkElementsIncludeAllVisibleHeaders(sheetId,"ROW",selectedRows);};const REMOVE_COLUMNS_ACTION=(env)=>{let columns=[...env.model.getters.getActiveCols()];if(!columns.length){const zone=env.model.getters.getSelectedZones()[0];for(let i=zone.left;i<=zone.right;i++){columns.push(i);}}
env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});};const NOT_ALL_VISIBLE_COLS_SELECTED=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedCols=env.model.getters.getElementsFromSelection("COL");return!env.model.getters.checkElementsIncludeAllVisibleHeaders(sheetId,"COL",selectedCols);};const INSERT_ROWS_BEFORE_ACTION=(env)=>{const activeRows=env.model.getters.getActiveRows();let row;let quantity;if(activeRows.size){row=largeMin([...activeRows]);quantity=activeRows.size;}
else{const zone=env.model.getters.getSelectedZones()[0];row=zone.top;quantity=zone.bottom-zone.top+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"before",base:row,quantity,dimension:"ROW",});};const INSERT_ROWS_AFTER_ACTION=(env)=>{const activeRows=env.model.getters.getActiveRows();let row;let quantity;if(activeRows.size){row=largeMax([...activeRows]);quantity=activeRows.size;}
else{const zone=env.model.getters.getSelectedZones()[0];row=zone.bottom;quantity=zone.bottom-zone.top+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"after",base:row,quantity,dimension:"ROW",});};const INSERT_COLUMNS_BEFORE_ACTION=(env)=>{const activeCols=env.model.getters.getActiveCols();let column;let quantity;if(activeCols.size){column=largeMin([...activeCols]);quantity=activeCols.size;}
else{const zone=env.model.getters.getSelectedZones()[0];column=zone.left;quantity=zone.right-zone.left+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"before",dimension:"COL",base:column,quantity,});};const INSERT_COLUMNS_AFTER_ACTION=(env)=>{const activeCols=env.model.getters.getActiveCols();let column;let quantity;if(activeCols.size){column=largeMax([...activeCols]);quantity=activeCols.size;}
else{const zone=env.model.getters.getSelectedZones()[0];column=zone.right;quantity=zone.right-zone.left+1;}
env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),position:"after",dimension:"COL",base:column,quantity,});};const HIDE_COLUMNS_NAME=(env)=>{const cols=env.model.getters.getElementsFromSelection("COL");let first=cols[0];let last=cols[cols.length-1];if(cols.length===1){return _t("Hide column %s",numberToLetters(first).toString());}
else if(last-first+1===cols.length){return _t("Hide columns %s - %s",numberToLetters(first).toString(),numberToLetters(last).toString());}
else{return _t("Hide columns");}};const HIDE_ROWS_NAME=(env)=>{const rows=env.model.getters.getElementsFromSelection("ROW");let first=rows[0];let last=rows[rows.length-1];if(rows.length===1){return _t("Hide row %s",(first+1).toString());}
else if(last-first+1===rows.length){return _t("Hide rows %s - %s",(first+1).toString(),(last+1).toString());}
else{return _t("Hide rows");}};const CREATE_CHART=(env)=>{const getters=env.model.getters;const id=env.model.uuidGenerator.uuidv4();const sheetId=getters.getActiveSheetId();if(getZoneArea(env.model.getters.getSelectedZone())===1){env.model.selection.selectTableAroundSelection();}
const size={width:DEFAULT_FIGURE_WIDTH,height:DEFAULT_FIGURE_HEIGHT};const position=getChartPositionAtCenterOfViewport(getters,size);const result=env.model.dispatch("CREATE_CHART",{sheetId,id,position,size,definition:getSmartChartDefinition(env.model.getters.getSelectedZone(),env.model.getters),});if(result.isSuccessful){env.model.dispatch("SELECT_FIGURE",{id});env.openSidePanel("ChartPanel");}};async function requestImage(env){try{return await env.imageProvider.requestImage();}
catch{env.raiseError(_t("An unexpected error occurred during the image transfer"));return undefined;}}
const CREATE_IMAGE=async(env)=>{if(env.imageProvider){const sheetId=env.model.getters.getActiveSheetId();const figureId=env.model.uuidGenerator.uuidv4();const image=await requestImage(env);if(!image){throw new Error("No image provider was given to the environment");}
const size=getMaxFigureSize(env.model.getters,image.size);const position=centerFigurePosition(env.model.getters,size);env.model.dispatch("CREATE_IMAGE",{sheetId,figureId,position,size,definition:image,});}};const FORMAT_PERCENT_ACTION=(env)=>setFormatter(env,"0.00%");const OPEN_CF_SIDEPANEL_ACTION=(env)=>{env.openSidePanel("ConditionalFormatting",{selection:env.model.getters.getSelectedZones()});};const INSERT_LINK=(env)=>{let{col,row}=env.model.getters.getActivePosition();env.model.dispatch("OPEN_CELL_POPOVER",{col,row,popoverType:"LinkEditor"});};const INSERT_LINK_NAME=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const{col,row}=env.model.getters.getActivePosition();const cell=env.model.getters.getEvaluatedCell({sheetId,col,row});return cell&&cell.link?_t("Edit link"):_t("Insert link");};const SELECTION_CONTAINS_FILTER=(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selectedZones=env.model.getters.getSelectedZones();return env.model.getters.doesZonesContainFilter(sheetId,selectedZones);};const IS_ONLY_ONE_RANGE=(env)=>{return env.model.getters.getSelectedZones().length===1;};const CAN_INSERT_HEADER=(env,dimension)=>{if(!IS_ONLY_ONE_RANGE(env)){return false;}
const activeHeaders=dimension==="COL"?env.model.getters.getActiveCols():env.model.getters.getActiveRows();const ortogonalActiveHeaders=dimension==="COL"?env.model.getters.getActiveRows():env.model.getters.getActiveCols();const sheetId=env.model.getters.getActiveSheetId();const zone=env.model.getters.getSelectedZone();const allSheetSelected=isEqual(zone,env.model.getters.getSheetZone(sheetId));return isConsecutive(activeHeaders)&&(ortogonalActiveHeaders.size===0||allSheetSelected);};const undo={name:_t("Undo"),description:"Ctrl+Z",execute:(env)=>env.model.dispatch("REQUEST_UNDO"),isEnabled:(env)=>env.model.getters.canUndo(),icon:"o-spreadsheet-Icon.UNDO",};const redo={name:_t("Redo"),description:"Ctrl+Y",execute:(env)=>env.model.dispatch("REQUEST_REDO"),isEnabled:(env)=>env.model.getters.canRedo(),icon:"o-spreadsheet-Icon.REDO",};const copy={name:_t("Copy"),description:"Ctrl+C",isReadonlyAllowed:true,execute:async(env)=>{env.model.dispatch("COPY");await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.COPY",};const cut={name:_t("Cut"),description:"Ctrl+X",execute:async(env)=>{interactiveCut(env);await env.clipboard.write(env.model.getters.getClipboardContent());},icon:"o-spreadsheet-Icon.CUT",};const paste={name:_t("Paste"),description:"Ctrl+V",execute:PASTE_ACTION,icon:"o-spreadsheet-Icon.PASTE",};const pasteSpecial={name:_t("Paste special"),isVisible:(env)=>{return!env.model.getters.isCutOperation();},icon:"o-spreadsheet-Icon.PASTE",};const pasteSpecialValue={name:_t("Paste value only"),description:"Ctrl+Shift+V",execute:PASTE_VALUE_ACTION,};const pasteSpecialFormat={name:_t("Paste format only"),execute:PASTE_FORMAT_ACTION,};const findAndReplace={name:_t("Find and replace"),description:"Ctrl+H",isReadonlyAllowed:true,execute:(env)=>{env.openSidePanel("FindAndReplace",{});},icon:"o-spreadsheet-Icon.FIND_AND_REPLACE",};const deleteValues={name:_t("Delete values"),execute:(env)=>env.model.dispatch("DELETE_CONTENT",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),}),};const deleteRows={name:REMOVE_ROWS_NAME,execute:REMOVE_ROWS_ACTION,isVisible:(env)=>CAN_REMOVE_COLUMNS_ROWS("ROW",env),};const deleteRow={...deleteRows,isVisible:IS_ONLY_ONE_RANGE,};const clearRows={name:DELETE_CONTENT_ROWS_NAME,execute:DELETE_CONTENT_ROWS_ACTION,};const deleteCols={name:REMOVE_COLUMNS_NAME,execute:REMOVE_COLUMNS_ACTION,isVisible:(env)=>CAN_REMOVE_COLUMNS_ROWS("COL",env),};const deleteCol={...deleteCols,isVisible:IS_ONLY_ONE_RANGE,};const clearCols={name:DELETE_CONTENT_COLUMNS_NAME,execute:DELETE_CONTENT_COLUMNS_ACTION,};const deleteCells={name:_t("Delete cells"),isVisible:IS_ONLY_ONE_RANGE,};const deleteCellShiftUp={name:_t("Delete cell and shift up"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("DELETE_CELL",{zone,shiftDimension:"ROW"});handlePasteResult(env,result);},};const deleteCellShiftLeft={name:_t("Delete cell and shift left"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("DELETE_CELL",{zone,shiftDimension:"COL"});handlePasteResult(env,result);},};const mergeCells={name:_t("Merge cells"),isEnabled:(env)=>!cannotMerge(env),isActive:(env)=>isInMerge(env),execute:(env)=>toggleMerge(env),icon:"o-spreadsheet-Icon.MERGE_CELL",};function cannotMerge(env){const zones=env.model.getters.getSelectedZones();const{top,left,right,bottom}=env.model.getters.getSelectedZone();const{sheetId}=env.model.getters.getActivePosition();const{xSplit,ySplit}=env.model.getters.getPaneDivisions(sheetId);return(zones.length>1||(top===bottom&&left===right)||(left<xSplit&&xSplit<=right)||(top<ySplit&&ySplit<=bottom));}
function isInMerge(env){if(!cannotMerge(env)){const zones=env.model.getters.getSelectedZones();const{col,row,sheetId}=env.model.getters.getActivePosition();const zone=env.model.getters.expandZone(sheetId,positionToZone({col,row}));return isEqual(zones[0],zone);}
return false;}
function toggleMerge(env){if(cannotMerge(env)){return;}
const zones=env.model.getters.getSelectedZones();const target=[zones[zones.length-1]];const sheetId=env.model.getters.getActiveSheetId();if(isInMerge(env)){env.model.dispatch("REMOVE_MERGE",{sheetId,target});}
else{interactiveAddMerge(env,sheetId,target);}}
var ACTION_EDIT=Object.freeze({__proto__:null,clearCols:clearCols,clearRows:clearRows,copy:copy,cut:cut,deleteCellShiftLeft:deleteCellShiftLeft,deleteCellShiftUp:deleteCellShiftUp,deleteCells:deleteCells,deleteCol:deleteCol,deleteCols:deleteCols,deleteRow:deleteRow,deleteRows:deleteRows,deleteValues:deleteValues,findAndReplace:findAndReplace,mergeCells:mergeCells,paste:paste,pasteSpecial:pasteSpecial,pasteSpecialFormat:pasteSpecialFormat,pasteSpecialValue:pasteSpecialValue,redo:redo,undo:undo});const ARG_REGEXP=/(.*?)\((.*?)\)(.*)/;const ARG_TYPES=["ANY","BOOLEAN","DATE","NUMBER","STRING","RANGE","RANGE<BOOLEAN>","RANGE<DATE>","RANGE<NUMBER>","RANGE<STRING>","META",];function arg(definition,description=""){return makeArg(definition,description);}
function makeArg(str,description){let parts=str.match(ARG_REGEXP);let name=parts[1].trim();if(!name){throw new Error(`Function argument definition is missing a name: '${str}'.`);}
let types=[];let isOptional=false;let isRepeating=false;let isLazy=false;let defaultValue;for(let param of parts[2].split(",")){const key=param.trim().toUpperCase();let type=ARG_TYPES.find((t)=>key===t);if(type){types.push(type);}
else if(key==="RANGE<ANY>"){types.push("RANGE");}
else if(key==="OPTIONAL"){isOptional=true;}
else if(key==="REPEATING"){isRepeating=true;}
else if(key==="LAZY"){isLazy=true;}
else if(key.startsWith("DEFAULT=")){defaultValue=param.trim().slice(8);}}
const result={name,description,type:types,};if(isOptional){result.optional=true;}
if(isRepeating){result.repeating=true;}
if(isLazy){result.lazy=true;}
if(defaultValue!==undefined){result.default=true;result.defaultValue=defaultValue;}
if(types.some((t)=>t.startsWith("RANGE"))){result.acceptMatrix=true;}
return result;}
function addMetaInfoFromArg(addDescr){let countArg=0;let minArg=0;let repeatingArg=0;for(let arg of addDescr.args){countArg++;if(!arg.optional&&!arg.repeating&&!arg.default){minArg++;}
if(arg.repeating){repeatingArg++;}}
const descr=addDescr;descr.minArgRequired=minArg;descr.maxArgPossible=repeatingArg?Infinity:countArg;descr.nbrArgRepeating=repeatingArg;descr.getArgToFocus=argTargeting(countArg,repeatingArg);descr.hidden=addDescr.hidden||false;return descr;}
function argTargeting(countArg,repeatingArg){if(!repeatingArg){return(argPosition)=>argPosition;}
if(repeatingArg===1){return(argPosition)=>Math.min(argPosition,countArg);}
const argBeforeRepeat=countArg-repeatingArg;return(argPosition)=>{if(argPosition<=argBeforeRepeat){return argPosition;}
const argAfterRepeat=(argPosition-argBeforeRepeat)%repeatingArg||repeatingArg;return argBeforeRepeat+argAfterRepeat;};}
function validateArguments(args){let previousArgRepeating=false;let previousArgOptional=false;let previousArgDefault=false;for(let current of args){if(current.type.includes("META")&&current.type.length>1){throw new Error(_t("Function ${name} has an argument that has been declared with more than one type whose type 'META'. The 'META' type can only be declared alone."));}
if(previousArgRepeating&&!current.repeating){throw new Error(_t("Function ${name} has no-repeatable arguments declared after repeatable ones. All repeatable arguments must be declared last."));}
const previousIsOptional=previousArgOptional||previousArgRepeating||previousArgDefault;const currentIsntOptional=!(current.optional||current.repeating||current.default);if(previousIsOptional&&currentIsntOptional){throw new Error(_t("Function ${name} has at mandatory arguments declared after optional ones. All optional arguments must be after all mandatory arguments."));}
previousArgRepeating=current.repeating;previousArgOptional=current.optional;previousArgDefault=current.default;}}
function assertSingleColOrRow(errorStr,arg){assert(()=>arg.length===1||arg[0].length===1,errorStr);}
function assertSameDimensions(errorStr,...args){if(args.every(isMatrix)){const cols=args[0].length;const rows=args[0][0].length;for(const arg of args){assert(()=>arg.length===cols&&arg[0].length===rows,errorStr);}
return;}
if(args.some((arg)=>Array.isArray(arg)&&(arg.length!==1||arg[0].length!==1))){throw new Error(errorStr);}}
function assertPositive(errorStr,arg){assert(()=>arg>0,errorStr);}
function assertSquareMatrix(errorStr,arg){assert(()=>arg.length===arg[0].length,errorStr);}
function isNumberMatrix(arg){return arg.every((row)=>row.every((val)=>typeof val==="number"));}
function getUnitMatrix(n){const matrix=Array(n);for(let i=0;i<n;i++){matrix[i]=Array(n).fill(0);matrix[i][i]=1;}
return matrix;}
function invertMatrix(M){if(M.length!==M[0].length){throw new Error(`Function [[FUNCTION_NAME]] invert matrix error, only square matrices are invertible`);}
let determinant=1;const dim=M.length;const I=getUnitMatrix(dim);const C=M.map((row)=>row.slice());for(let pivot=0;pivot<dim;pivot++){let diagonalElement=C[pivot][pivot];if(diagonalElement===0){for(let row=pivot+1;row<dim;row++){if(C[pivot][row]!=0){swapMatrixRows(C,pivot,row);swapMatrixRows(I,pivot,row);determinant*=-1;break;}}
diagonalElement=C[pivot][pivot];if(diagonalElement===0){return{determinant:0};}}
for(let col=0;col<dim;col++){C[col][pivot]=C[col][pivot]/diagonalElement;I[col][pivot]=I[col][pivot]/diagonalElement;}
determinant*=diagonalElement;for(let row=0;row<dim;row++){if(row===pivot){continue;}
const e=C[pivot][row];for(let col=0;col<dim;col++){C[col][row]-=e*C[col][pivot];I[col][row]-=e*I[col][pivot];}}}
return{inverted:I,determinant};}
function swapMatrixRows(matrix,row1,row2){for(let i=0;i<matrix.length;i++){const tmp=matrix[i][row1];matrix[i][row1]=matrix[i][row2];matrix[i][row2]=tmp;}}
function multiplyMatrices(matrix1,matrix2){if(matrix1.length!==matrix2[0].length){throw new Error(_t("Cannot multiply matrices : incompatible matrices size."));}
const rowsM1=matrix1[0].length;const colsM2=matrix2.length;const n=matrix1.length;const result=Array(colsM2);for(let col=0;col<colsM2;col++){result[col]=Array(rowsM1);for(let row=0;row<rowsM1;row++){let sum=0;for(let k=0;k<n;k++){sum+=matrix1[k][row]*matrix2[col][k];}
result[col][row]=sum;}}
return result;}
function toScalar(matrix){if(!isMatrix(matrix)){return matrix;}
if(matrix.length!==1||matrix[0].length!==1){throw new Error("toScalar: matrix should be a scalar or a 1x1 matrix");}
return matrix[0][0];}
const ARRAY_CONSTRAIN={description:_t("Returns a result array constrained to a specific width and height."),args:[arg("input_range (any, range<any>)",_t("The range to constrain.")),arg("rows (number)",_t("The number of rows in the constrained array.")),arg("columns (number)",_t("The number of columns in the constrained array.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(array,rows,columns){const _array=toMatrix(array);const _rowsArg=toInteger(rows?.value,this.locale);const _columnsArg=toInteger(columns?.value,this.locale);assertPositive(_t("The rows argument (%s) must be strictly positive.",_rowsArg.toString()),_rowsArg);assertPositive(_t("The columns argument (%s) must be strictly positive.",_rowsArg.toString()),_columnsArg);const _nbRows=Math.min(_rowsArg,_array[0].length);const _nbColumns=Math.min(_columnsArg,_array.length);return generateMatrix(_nbColumns,_nbRows,(col,row)=>_array[col][row]);},isExported:false,};const CHOOSECOLS={description:_t("Creates a new array from the selected columns in the existing range."),args:[arg("array (any, range<any>)",_t("The array that contains the columns to be returned.")),arg("col_num (number, range<number>)",_t("The first column index of the columns to be returned.")),arg("col_num2 (number, range<number>, repeating)",_t("The columns indexes of the columns to be returned.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(array,...columns){const _array=toMatrix(array);const _columns=flattenRowFirst(columns,(item)=>toInteger(item?.value,this.locale));assert(()=>_columns.every((col)=>col>0&&col<=_array.length),_t("The columns arguments must be between 1 and %s (got %s).",_array.length.toString(),(_columns.find((col)=>col<=0||col>_array.length)||0).toString()));const result=Array(_columns.length);for(let col=0;col<_columns.length;col++){const colIndex=_columns[col]-1;result[col]=_array[colIndex];}
return result;},isExported:true,};const CHOOSEROWS={description:_t("Creates a new array from the selected rows in the existing range."),args:[arg("array (any, range<any>)",_t("The array that contains the rows to be returned.")),arg("row_num (number, range<number>)",_t("The first row index of the rows to be returned.")),arg("row_num2 (number, range<number>, repeating)",_t("The rows indexes of the rows to be returned.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(array,...rows){const _array=toMatrix(array);const _rows=flattenRowFirst(rows,(item)=>toInteger(item?.value,this.locale));const _nbColumns=_array.length;assert(()=>_rows.every((row)=>row>0&&row<=_array[0].length),_t("The rows arguments must be between 1 and %s (got %s).",_array[0].length.toString(),(_rows.find((row)=>row<=0||row>_array[0].length)||0).toString()));return generateMatrix(_nbColumns,_rows.length,(col,row)=>_array[col][_rows[row]-1]);},isExported:true,};const EXPAND={description:_t("Expands or pads an array to specified row and column dimensions."),args:[arg("array (any, range<any>)",_t("The array to expand.")),arg("rows (number)",_t("The number of rows in the expanded array. If missing, rows will not be expanded.")),arg("columns (number, optional)",_t("The number of columns in the expanded array. If missing, columns will not be expanded.")),arg("pad_with (any, default=0)",_t("The value with which to pad.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(arg,rows,columns,padWith={value:0}){const _array=toMatrix(arg);const _nbRows=toInteger(rows?.value,this.locale);const _nbColumns=columns!==undefined?toInteger(columns.value,this.local):_array.length;assert(()=>_nbRows>=_array[0].length,_t("The rows arguments (%s) must be greater or equal than the number of rows of the array.",_nbRows.toString()));assert(()=>_nbColumns>=_array.length,_t("The columns arguments (%s) must be greater or equal than the number of columns of the array.",_nbColumns.toString()));return generateMatrix(_nbColumns,_nbRows,(col,row)=>col>=_array.length||row>=_array[col].length?padWith:_array[col][row]);},isExported:true,};const FLATTEN={description:_t("Flattens all the values from one or more ranges into a single column."),args:[arg("range (any, range<any>)",_t("The first range to flatten.")),arg("range2 (any, range<any>, repeating)",_t("Additional ranges to flatten.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(...ranges){return[flattenRowFirst(ranges,(val)=>(val===undefined?{value:""}:val))];},isExported:false,};const FREQUENCY={description:_t("Calculates the frequency distribution of a range."),args:[arg("data (range<number>)",_t("The array of ranges containing the values to be counted.")),arg("classes (number, range<number>)",_t("The range containing the set of classes.")),],returns:["RANGE<NUMBER>"],compute:function(data,classes){const _data=flattenRowFirst([data],(val)=>val).filter((val)=>typeof val==="number");const _classes=flattenRowFirst([classes],(val)=>val).filter((val)=>typeof val==="number");const sortedClasses=_classes.map((value,index)=>({initialIndex:index,value,count:0})).sort((a,b)=>a.value-b.value);sortedClasses.push({initialIndex:sortedClasses.length,value:Infinity,count:0});const sortedData=_data.sort((a,b)=>a-b);let index=0;for(const val of sortedData){while(val>sortedClasses[index].value&&index<sortedClasses.length-1){index++;}
sortedClasses[index].count++;}
const result=sortedClasses.sort((a,b)=>a.initialIndex-b.initialIndex).map((val)=>val.count);return[result];},isExported:true,};const HSTACK={description:_t("Appends ranges horizontally and in sequence to return a larger array."),args:[arg("range1 (any, range<any>)",_t("The first range to be appended.")),arg("range2 (any, range<any>, repeating)",_t("Additional ranges to add to range1.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(...ranges){const nbRows=Math.max(...ranges.map((r)=>r?.[0]?.length??0));const result=[];for(const range of ranges){const _range=toMatrix(range);for(let col=0;col<_range.length;col++){const array=Array(nbRows).fill({value:null});for(let row=0;row<_range[col].length;row++){array[row]=_range[col][row];}
result.push(array);}}
return result;},isExported:true,};const MDETERM={description:_t("Returns the matrix determinant of a square matrix."),args:[arg("square_matrix (number, range<number>)",_t("An range with an equal number of rows and columns representing a matrix whose determinant will be calculated.")),],returns:["NUMBER"],compute:function(matrix){const _matrix=toMatrix(matrix);assertSquareMatrix(_t("The argument square_matrix must have the same number of columns and rows."),_matrix);if(!isNumberMatrix(_matrix)){throw new Error(_t("The argument square_matrix must be a matrix of numbers."));}
const{determinant}=invertMatrix(_matrix);return determinant;},isExported:true,};const MINVERSE={description:_t("Returns the multiplicative inverse of a square matrix."),args:[arg("square_matrix (number, range<number>)",_t("An range with an equal number of rows and columns representing a matrix whose multiplicative inverse will be calculated.")),],returns:["RANGE<NUMBER>"],compute:function(matrix){const _matrix=toMatrix(matrix);assertSquareMatrix(_t("The argument square_matrix must have the same number of columns and rows."),_matrix);if(!isNumberMatrix(_matrix)){throw new Error(_t("The argument square_matrix must be a matrix of numbers."));}
const{inverted}=invertMatrix(_matrix);if(!inverted){throw new Error(_t("The matrix is not invertible."));}
return inverted;},isExported:true,};const MMULT={description:_t("Calculates the matrix product of two matrices."),args:[arg("matrix1 (number, range<number>)",_t("The first matrix in the matrix multiplication operation.")),arg("matrix2 (number, range<number>)",_t("The second matrix in the matrix multiplication operation.")),],returns:["RANGE<NUMBER>"],compute:function(matrix1,matrix2){const _matrix1=toMatrix(matrix1);const _matrix2=toMatrix(matrix2);assert(()=>_matrix1.length===_matrix2[0].length,_t("In [[FUNCTION_NAME]], the number of columns of the first matrix (%s) must be equal to the \
        number of rows of the second matrix (%s).",_matrix1.length.toString(),_matrix2[0].length.toString()));if(!isNumberMatrix(_matrix1)||!isNumberMatrix(_matrix2)){throw new Error(_t("The arguments matrix1 and matrix2 must be matrices of numbers."));}
return multiplyMatrices(_matrix1,_matrix2);},isExported:true,};const SUMPRODUCT={description:_t("Calculates the sum of the products of corresponding entries in equal-sized ranges."),args:[arg("range1 (number, range<number>)",_t("The first range whose entries will be multiplied with corresponding entries in the other ranges.")),arg("range2 (number, range<number>, repeating)",_t("The other range whose entries will be multiplied with corresponding entries in the other ranges.")),],returns:["NUMBER"],compute:function(...args){assertSameDimensions(_t("All the ranges must have the same dimensions."),...args);const _args=args.map(toMatrix);let result=0;for(let col=0;col<_args[0].length;col++){for(let row=0;row<_args[0][col].length;row++){if(!_args.every((range)=>typeof range[col][row]==="number")){continue;}
let product=1;for(const range of _args){product*=toNumber(range[col][row],this.locale);}
result+=product;}}
return result;},isExported:true,};function getSumXAndY(arrayX,arrayY,cb){assertSameDimensions("The arguments array_x and array_y must have the same dimensions.",arrayX,arrayY);const _arrayX=toMatrix(arrayX);const _arrayY=toMatrix(arrayY);let validPairFound=false;let result=0;for(const col in _arrayX){for(const row in _arrayX[col]){const arrayXValue=_arrayX[col][row];const arrayYValue=_arrayY[col][row];if(typeof arrayXValue!=="number"||typeof arrayYValue!=="number"){continue;}
validPairFound=true;result+=cb(arrayXValue,arrayYValue);}}
if(!validPairFound){throw new Error("The arguments array_x and array_y must contain at least one pair of numbers.");}
return result;}
const SUMX2MY2={description:_t("Calculates the sum of the difference of the squares of the values in two array."),args:[arg("array_x (number, range<number>)",_t("The array or range of values whose squares will be reduced by the squares of corresponding entries in array_y and added together.")),arg("array_y (number, range<number>)",_t("The array or range of values whose squares will be subtracted from the squares of corresponding entries in array_x and added together.")),],returns:["NUMBER"],compute:function(arrayX,arrayY){return getSumXAndY(arrayX,arrayY,(x,y)=>x**2-y**2);},isExported:true,};const SUMX2PY2={description:_t("Calculates the sum of the sum of the squares of the values in two array."),args:[arg("array_x (number, range<number>)",_t("The array or range of values whose squares will be added to the squares of corresponding entries in array_y and added together.")),arg("array_y (number, range<number>)",_t("The array or range of values whose squares will be added to the squares of corresponding entries in array_x and added together.")),],returns:["NUMBER"],compute:function(arrayX,arrayY){return getSumXAndY(arrayX,arrayY,(x,y)=>x**2+y**2);},isExported:true,};const SUMXMY2={description:_t("Calculates the sum of squares of the differences of values in two array."),args:[arg("array_x (number, range<number>)",_t("The array or range of values that will be reduced by corresponding entries in array_y, squared, and added together.")),arg("array_y (number, range<number>)",_t("The array or range of values that will be subtracted from corresponding entries in array_x, the result squared, and all such results added together.")),],returns:["NUMBER"],compute:function(arrayX,arrayY){return getSumXAndY(arrayX,arrayY,(x,y)=>(x-y)**2);},isExported:true,};const TO_COL_ROW_DEFAULT_IGNORE=0;const TO_COL_ROW_DEFAULT_SCAN=false;const TO_COL_ROW_ARGS=[arg("array (any, range<any>)",_t("The array which will be transformed.")),arg(`ignore (number, default=${TO_COL_ROW_DEFAULT_IGNORE})`,_t("The control to ignore blanks and errors. 0 (default) is to keep all values, 1 is to ignore blanks, 2 is to ignore errors, and 3 is to ignore blanks and errors.")),arg(`scan_by_column (number, default=${TO_COL_ROW_DEFAULT_SCAN})`,_t("Whether the array should be scanned by column. True scans the array by column and false (default) \
      scans the array by row.")),];const TOCOL={description:_t("Transforms a range of cells into a single column."),args:TO_COL_ROW_ARGS,returns:["RANGE<ANY>"],computeValueAndFormat:function(array,ignore={value:TO_COL_ROW_DEFAULT_IGNORE},scanByColumn={value:TO_COL_ROW_DEFAULT_SCAN}){const _array=toMatrix(array);const _ignore=toInteger(ignore.value,this.locale);const _scanByColumn=toBoolean(scanByColumn.value);assert(()=>_ignore>=0&&_ignore<=3,_t("Argument ignore must be between 0 and 3"));const result=(_scanByColumn?_array:transposeMatrix(_array)).flat().filter((item)=>(_ignore!==1&&_ignore!==3)||(item.value!==undefined&&item.value!==null));if(result.length===0){throw new NotAvailableError(_t("No results for the given arguments of TOCOL."));}
return[result];},isExported:true,};const TOROW={description:_t("Transforms a range of cells into a single row."),args:TO_COL_ROW_ARGS,returns:["RANGE<ANY>"],computeValueAndFormat:function(array,ignore={value:TO_COL_ROW_DEFAULT_IGNORE},scanByColumn={value:TO_COL_ROW_DEFAULT_SCAN}){const _array=toMatrix(array);const _ignore=toInteger(ignore.value,this.locale);const _scanByColumn=toBoolean(scanByColumn.value);assert(()=>_ignore>=0&&_ignore<=3,_t("Argument ignore must be between 0 and 3"));const result=(_scanByColumn?_array:transposeMatrix(_array)).flat().filter((item)=>(_ignore!==1&&_ignore!==3)||(item.value!==undefined&&item.value!==null)).map((item)=>[item]);if(result.length===0||result[0].length===0){throw new NotAvailableError(_t("No results for the given arguments of TOROW."));}
return result;},isExported:true,};const TRANSPOSE={description:_t("Transposes the rows and columns of a range."),args:[arg("range (any, range<any>)",_t("The range to be transposed."))],returns:["RANGE"],computeValueAndFormat:function(arg){const _array=toMatrix(arg);const nbColumns=_array[0].length;const nbRows=_array.length;return generateMatrix(nbColumns,nbRows,(col,row)=>_array[row][col]);},isExported:true,};const VSTACK={description:_t("Appends ranges vertically and in sequence to return a larger array."),args:[arg("range1 (any, range<any>)",_t("The first range to be appended.")),arg("range2 (any, range<any>, repeating)",_t("Additional ranges to add to range1.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(...ranges){const nbColumns=Math.max(...ranges.map((range)=>toMatrix(range).length));const nbRows=ranges.reduce((acc,range)=>acc+toMatrix(range)[0].length,0);const result=Array(nbColumns).fill([]).map(()=>Array(nbRows).fill({value:0}));let currentRow=0;for(const range of ranges){const _array=toMatrix(range);for(let col=0;col<_array.length;col++){for(let row=0;row<_array[col].length;row++){result[col][currentRow+row]=_array[col][row];}}
currentRow+=_array[0].length;}
return result;},isExported:true,};const WRAPCOLS={description:_t("Wraps the provided row or column of cells by columns after a specified number of elements to form a new array."),args:[arg("range (any, range<any>)",_t("The range to wrap.")),arg("wrap_count (number)",_t("The maximum number of cells for each column, rounded down to the nearest whole number.")),arg("pad_with  (any, default=0)",_t("The value with which to fill the extra cells in the range.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(range,wrapCount,padWith={value:0}){const _array=toMatrix(range);const nbRows=toInteger(wrapCount?.value,this.locale);assertSingleColOrRow(_t("Argument range must be a single row or column."),_array);const array=_array.flat();const nbColumns=Math.ceil(array.length/nbRows);return generateMatrix(nbColumns,nbRows,(col,row)=>{const index=col*nbRows+row;return index<array.length?array[index]:padWith;});},isExported:true,};const WRAPROWS={description:_t("Wraps the provided row or column of cells by rows after a specified number of elements to form a new array."),args:[arg("range (any, range<any>)",_t("The range to wrap.")),arg("wrap_count (number)",_t("The maximum number of cells for each row, rounded down to the nearest whole number.")),arg("pad_with  (any, default=0)",_t("The value with which to fill the extra cells in the range.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(range,wrapCount,padWith={value:0}){const _array=toMatrix(range);const nbColumns=toInteger(wrapCount?.value,this.locale);assertSingleColOrRow(_t("Argument range must be a single row or column."),_array);const array=_array.flat();const nbRows=Math.ceil(array.length/nbColumns);return generateMatrix(nbColumns,nbRows,(col,row)=>{const index=row*nbColumns+col;return index<array.length?array[index]:padWith;});},isExported:true,};var array=Object.freeze({__proto__:null,ARRAY_CONSTRAIN:ARRAY_CONSTRAIN,CHOOSECOLS:CHOOSECOLS,CHOOSEROWS:CHOOSEROWS,EXPAND:EXPAND,FLATTEN:FLATTEN,FREQUENCY:FREQUENCY,HSTACK:HSTACK,MDETERM:MDETERM,MINVERSE:MINVERSE,MMULT:MMULT,SUMPRODUCT:SUMPRODUCT,SUMX2MY2:SUMX2MY2,SUMX2PY2:SUMX2PY2,SUMXMY2:SUMXMY2,TOCOL:TOCOL,TOROW:TOROW,TRANSPOSE:TRANSPOSE,VSTACK:VSTACK,WRAPCOLS:WRAPCOLS,WRAPROWS:WRAPROWS});const FORMAT_LARGE_NUMBER={description:_t("Apply a large number format"),args:[arg("value (number)",_t("The number.")),arg("unit (string, optional)",_t("The formatting unit. Use 'k', 'm', or 'b' to force the unit")),],returns:["NUMBER"],computeFormat:function(arg,unit){const value=Math.abs(toNumber(arg?.value,this.locale));const format=arg?.format;if(unit!==undefined){const postFix=unit?.value;switch(postFix){case"k":return createLargeNumberFormat(format,1e3,"k",this.locale);case"m":return createLargeNumberFormat(format,1e6,"m",this.locale);case"b":return createLargeNumberFormat(format,1e9,"b",this.locale);default:throw new Error(_t("The formatting unit should be 'k', 'm' or 'b'."));}}
if(value<1e5){return createLargeNumberFormat(format,0,"",this.locale);}
else if(value<1e8){return createLargeNumberFormat(format,1e3,"k",this.locale);}
else if(value<1e11){return createLargeNumberFormat(format,1e6,"m",this.locale);}
return createLargeNumberFormat(format,1e9,"b",this.locale);},compute:function(value){return toNumber(value,this.locale);},};var misc=Object.freeze({__proto__:null,FORMAT_LARGE_NUMBER:FORMAT_LARGE_NUMBER});const DEFAULT_FACTOR=1;const DEFAULT_MODE=0;const DEFAULT_PLACES=0;const DEFAULT_SIGNIFICANCE=1;const DECIMAL_REPRESENTATION=/^-?[a-z0-9]+$/i;const ABS={description:_t("Absolute value of a number."),args:[arg("value (number)",_t("The number of which to return the absolute value."))],returns:["NUMBER"],compute:function(value){return Math.abs(toNumber(value,this.locale));},isExported:true,};const ACOS={description:_t("Inverse cosine of a value, in radians."),args:[arg("value (number)",_t("The value for which to calculate the inverse cosine. Must be between -1 and 1, inclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)<=1,_t("The value (%s) must be between -1 and 1 inclusive.",_value.toString()));return Math.acos(_value);},isExported:true,};const ACOSH={description:_t("Inverse hyperbolic cosine of a number."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic cosine. Must be greater than or equal to 1.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value>=1,_t("The value (%s) must be greater than or equal to 1.",_value.toString()));return Math.acosh(_value);},isExported:true,};const ACOT={description:_t("Inverse cotangent of a value."),args:[arg("value (number)",_t("The value for which to calculate the inverse cotangent."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);const sign=Math.sign(_value)||1;return(sign*Math.PI)/2-Math.atan(_value);},isExported:true,};const ACOTH={description:_t("Inverse hyperbolic cotangent of a value."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic cotangent. Must not be between -1 and 1, inclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)>1,_t("The value (%s) cannot be between -1 and 1 inclusive.",_value.toString()));return Math.log((_value+1)/(_value-1))/2;},isExported:true,};const ASIN={description:_t("Inverse sine of a value, in radians."),args:[arg("value (number)",_t("The value for which to calculate the inverse sine. Must be between -1 and 1, inclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)<=1,_t("The value (%s) must be between -1 and 1 inclusive.",_value.toString()));return Math.asin(_value);},isExported:true,};const ASINH={description:_t("Inverse hyperbolic sine of a number."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic sine.")),],returns:["NUMBER"],compute:function(value){return Math.asinh(toNumber(value,this.locale));},isExported:true,};const ATAN={description:_t("Inverse tangent of a value, in radians."),args:[arg("value (number)",_t("The value for which to calculate the inverse tangent."))],returns:["NUMBER"],compute:function(value){return Math.atan(toNumber(value,this.locale));},isExported:true,};const ATAN2={description:_t("Angle from the X axis to a point (x,y), in radians."),args:[arg("x (number)",_t("The x coordinate of the endpoint of the line segment for which to calculate the angle from the x-axis.")),arg("y (number)",_t("The y coordinate of the endpoint of the line segment for which to calculate the angle from the x-axis.")),],returns:["NUMBER"],compute:function(x,y){const _x=toNumber(x,this.locale);const _y=toNumber(y,this.locale);assert(()=>_x!==0||_y!==0,_t("Function [[FUNCTION_NAME]] caused a divide by zero error."));return Math.atan2(_y,_x);},isExported:true,};const ATANH={description:_t("Inverse hyperbolic tangent of a number."),args:[arg("value (number)",_t("The value for which to calculate the inverse hyperbolic tangent. Must be between -1 and 1, exclusive.")),],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>Math.abs(_value)<1,_t("The value (%s) must be between -1 and 1 exclusive.",_value.toString()));return Math.atanh(_value);},isExported:true,};const CEILING={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("value (number)",_t("The value to round up to the nearest integer multiple of factor.")),arg(`factor (number, default=${DEFAULT_FACTOR})`,_t("The number to whose multiples value will be rounded.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,factor=DEFAULT_FACTOR){const _value=toNumber(value,this.locale);const _factor=toNumber(factor,this.locale);assert(()=>_factor>=0||_value<=0,_t("The factor (%s) must be positive when the value (%s) is positive.",_factor.toString(),_value.toString()));return _factor?Math.ceil(_value/_factor)*_factor:0;},isExported:true,};const CEILING_MATH={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round up to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded. The sign of significance will be ignored.")),arg(`mode (number, default=${DEFAULT_MODE})`,_t("If number is negative, specifies the rounding direction. If 0 or blank, it is rounded towards zero. Otherwise, it is rounded away from zero.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE,mode=DEFAULT_MODE){let _significance=toNumber(significance,this.locale);if(_significance===0){return 0;}
const _number=toNumber(number,this.locale);_significance=Math.abs(_significance);if(_number>=0){return Math.ceil(_number/_significance)*_significance;}
const _mode=toNumber(mode,this.locale);if(_mode===0){return-Math.floor(Math.abs(_number)/_significance)*_significance;}
return-Math.ceil(Math.abs(_number)/_significance)*_significance;},isExported:true,};const CEILING_PRECISE={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round up to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance){return CEILING_MATH.compute.bind(this)(number,significance,0);},isExported:true,};const COS={description:_t("Cosine of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the cosine of, in radians."))],returns:["NUMBER"],compute:function(angle){return Math.cos(toNumber(angle,this.locale));},isExported:true,};const COSH={description:_t("Hyperbolic cosine of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic cosine of."))],returns:["NUMBER"],compute:function(value){return Math.cosh(toNumber(value,this.locale));},isExported:true,};const COT={description:_t("Cotangent of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the cotangent of, in radians."))],returns:["NUMBER"],compute:function(angle){const _angle=toNumber(angle,this.locale);assert(()=>_angle!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.tan(_angle);},isExported:true,};const COTH={description:_t("Hyperbolic cotangent of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic cotangent of."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.tanh(_value);},isExported:true,};const COUNTBLANK={description:_t("Number of empty values."),args:[arg("value1 (any, range)",_t("The first value or range in which to count the number of blanks.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges in which to count the number of blanks.")),],returns:["NUMBER"],compute:function(...argsValues){return reduceAny(argsValues,(acc,a)=>(a===null||a===undefined||a===""?acc+1:acc),0);},isExported:true,};const COUNTIF={description:_t("A conditional count across a range."),args:[arg("range (range)",_t("The range that is tested against criterion.")),arg("criterion (string)",_t("The pattern or test to apply to range.")),],returns:["NUMBER"],compute:function(...argsValues){let count=0;visitMatchingRanges(argsValues,(i,j)=>{count+=1;},this.locale);return count;},isExported:true,};const COUNTIFS={description:_t("Count values depending on multiple criteria."),args:[arg("criteria_range1 (range)",_t("The range to check against criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("Additional criteria to check.")),],returns:["NUMBER"],compute:function(...argsValues){let count=0;visitMatchingRanges(argsValues,(i,j)=>{count+=1;},this.locale);return count;},isExported:true,};function isDefined(value){switch(value){case undefined:return false;case"":return false;case null:return false;default:return true;}}
const COUNTUNIQUE={description:_t("Counts number of unique values in a range."),args:[arg("value1 (any, range)",_t("The first value or range to consider for uniqueness.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider for uniqueness.")),],returns:["NUMBER"],compute:function(...argsValues){return reduceAny(argsValues,(acc,a)=>(isDefined(a)?acc.add(a):acc),new Set()).size;},};const COUNTUNIQUEIFS={description:_t("Counts number of unique values in a range, filtered by a set of criteria."),args:[arg("range (range)",_t("The range of cells from which the number of unique values will be counted.")),arg("criteria_range1 (range)",_t("The range of cells over which to evaluate criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1, such that each cell that evaluates to TRUE will be included in the filtered set.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(range,...argsValues){let uniqueValues=new Set();visitMatchingRanges(argsValues,(i,j)=>{const value=range[i][j];if(isDefined(value)){uniqueValues.add(value);}},this.locale);return uniqueValues.size;},};const CSC={description:_t("Cosecant of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the cosecant of, in radians."))],returns:["NUMBER"],compute:function(angle){const _angle=toNumber(angle,this.locale);assert(()=>_angle!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.sin(_angle);},isExported:true,};const CSCH={description:_t("Hyperbolic cosecant of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic cosecant of."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return 1/Math.sinh(_value);},isExported:true,};const DECIMAL={description:_t("Converts from another base to decimal."),args:[arg("value (string)",_t("The number to convert.")),arg(",base (number)",_t("The base to convert the value from.")),],returns:["NUMBER"],compute:function(value,base){let _base=toNumber(base,this.locale);_base=Math.floor(_base);assert(()=>2<=_base&&_base<=36,_t("The base (%s) must be between 2 and 36 inclusive.",_base.toString()));const _value=toString(value);if(_value===""){return 0;}
assert(()=>!!DECIMAL_REPRESENTATION.test(_value),_t("The value (%s) must be a valid base %s representation.",_value,_base.toString()));const deci=parseInt(_value,_base);assert(()=>!isNaN(deci),_t("The value (%s) must be a valid base %s representation.",_value,_base.toString()));return deci;},isExported:true,};const DEGREES={description:_t("Converts an angle value in radians to degrees."),args:[arg("angle (number)",_t("The angle to convert from radians to degrees."))],returns:["NUMBER"],compute:function(angle){return(toNumber(angle,this.locale)*180)/Math.PI;},isExported:true,};const EXP={description:_t("Euler's number, e (~2.718) raised to a power."),args:[arg("value (number)",_t("The exponent to raise e."))],returns:["NUMBER"],compute:function(value){return Math.exp(toNumber(value,this.locale));},isExported:true,};const FLOOR={description:_t("Rounds number down to nearest multiple of factor."),args:[arg("value (number)",_t("The value to round down to the nearest integer multiple of factor.")),arg(`factor (number, default=${DEFAULT_FACTOR})`,_t("The number to whose multiples value will be rounded.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,factor=DEFAULT_FACTOR){const _value=toNumber(value,this.locale);const _factor=toNumber(factor,this.locale);assert(()=>_factor>=0||_value<=0,_t("The factor (%s) must be positive when the value (%s) is positive.",_factor.toString(),_value.toString()));return _factor?Math.floor(_value/_factor)*_factor:0;},isExported:true,};const FLOOR_MATH={description:_t("Rounds number down to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round down to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded. The sign of significance will be ignored.")),arg(`mode (number, default=${DEFAULT_MODE})`,_t("If number is negative, specifies the rounding direction. If 0 or blank, it is rounded away from zero. Otherwise, it is rounded towards zero.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE,mode=DEFAULT_MODE){let _significance=toNumber(significance,this.locale);if(_significance===0){return 0;}
const _number=toNumber(number,this.locale);_significance=Math.abs(_significance);if(_number>=0){return Math.floor(_number/_significance)*_significance;}
const _mode=toNumber(mode,this.locale);if(_mode===0){return-Math.ceil(Math.abs(_number)/_significance)*_significance;}
return-Math.floor(Math.abs(_number)/_significance)*_significance;},isExported:true,};const FLOOR_PRECISE={description:_t("Rounds number down to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round down to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE){return FLOOR_MATH.compute.bind(this)(number,significance,0);},isExported:true,};const ISEVEN={description:_t("Whether the provided value is even."),args:[arg("value (number)",_t("The value to be verified as even."))],returns:["BOOLEAN"],compute:function(value){const _value=strictToNumber(value,this.locale);return Math.floor(Math.abs(_value))&1?false:true;},isExported:true,};const ISO_CEILING={description:_t("Rounds number up to nearest multiple of factor."),args:[arg("number (number)",_t("The value to round up to the nearest integer multiple of significance.")),arg(`significance (number, default=${DEFAULT_SIGNIFICANCE})`,_t("The number to whose multiples number will be rounded.")),],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(number,significance=DEFAULT_SIGNIFICANCE){return CEILING_MATH.compute.bind(this)(number,significance,0);},isExported:true,};const ISODD={description:_t("Whether the provided value is even."),args:[arg("value (number)",_t("The value to be verified as even."))],returns:["BOOLEAN"],compute:function(value){const _value=strictToNumber(value,this.locale);return Math.floor(Math.abs(_value))&1?true:false;},isExported:true,};const LN={description:_t("The logarithm of a number, base e (euler's number)."),args:[arg("value (number)",_t("The value for which to calculate the logarithm, base e."))],returns:["NUMBER"],compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value>0,_t("The value (%s) must be strictly positive.",_value.toString()));return Math.log(_value);},isExported:true,};const MOD={description:_t("Modulo (remainder) operator."),args:[arg("dividend (number)",_t("The number to be divided to find the remainder.")),arg("divisor (number)",_t("The number to divide by.")),],returns:["NUMBER"],computeFormat:(dividend)=>dividend?.format,compute:function(dividend,divisor){const _divisor=toNumber(divisor,this.locale);assert(()=>_divisor!==0,_t("The divisor must be different from 0."));const _dividend=toNumber(dividend,this.locale);const modulus=_dividend%_divisor;if((modulus>0&&_divisor<0)||(modulus<0&&_divisor>0)){return modulus+_divisor;}
return modulus;},isExported:true,};const MUNIT={description:_t("Returns a n x n unit matrix, where n is the input dimension."),args:[arg("dimension (number)",_t("An integer specifying the dimension size of the unit matrix. It must be positive.")),],returns:["RANGE<NUMBER>"],compute:function(n){const _n=toInteger(n,this.locale);assertPositive(_t("The argument dimension must be positive"),_n);return getUnitMatrix(_n);},isExported:true,};const ODD={description:_t("Rounds a number up to the nearest odd integer."),args:[arg("value (number)",_t("The value to round to the next greatest odd number."))],returns:["NUMBER"],computeFormat:(number)=>number?.format,compute:function(value){const _value=toNumber(value,this.locale);let temp=Math.ceil(Math.abs(_value));temp=temp&1?temp:temp+1;return _value<0?-temp:temp;},isExported:true,};const PI={description:_t("The number pi."),args:[],returns:["NUMBER"],compute:function(){return Math.PI;},isExported:true,};const POWER={description:_t("A number raised to a power."),args:[arg("base (number)",_t("The number to raise to the exponent power.")),arg("exponent (number)",_t("The exponent to raise base to.")),],returns:["NUMBER"],computeFormat:(base)=>base?.format,compute:function(base,exponent){const _base=toNumber(base,this.locale);const _exponent=toNumber(exponent,this.locale);assert(()=>_base>=0||Number.isInteger(_exponent),_t("The exponent (%s) must be an integer when the base is negative.",_exponent.toString()));return Math.pow(_base,_exponent);},isExported:true,};const PRODUCT={description:_t("Result of multiplying a series of numbers together."),args:[arg("factor1 (number, range<number>)",_t("The first number or range to calculate for the product.")),arg("factor2 (number, range<number>, repeating)",_t("More numbers or ranges to calculate for the product.")),],returns:["NUMBER"],computeFormat:(factor1)=>{return isMatrix(factor1)?factor1[0][0]?.format:factor1?.format;},compute:function(...factors){let count=0;let acc=1;for(let n of factors){if(isMatrix(n)){for(let i of n){for(let j of i){if(typeof j==="number"){acc*=j;count+=1;}}}}
else if(n!==null&&n!==undefined){acc*=strictToNumber(n,this.locale);count+=1;}}
if(count===0){return 0;}
return acc;},isExported:true,};const RAND={description:_t("A random number between 0 inclusive and 1 exclusive."),args:[],returns:["NUMBER"],compute:function(){return Math.random();},isExported:true,};const RANDARRAY={description:_t("Returns a grid of random numbers between 0 inclusive and 1 exclusive."),args:[arg("rows (number, default=1)",_t("The number of rows to be returned.")),arg("columns (number, default=1)",_t("The number of columns to be returned.")),arg("min (number, default=0)",_t("The minimum number you would like returned.")),arg("max (number, default=1)",_t("The maximum number you would like returned.")),arg("whole_number (number, default=FALSE)",_t("Return a whole number or a decimal value.")),],returns:["RANGE<NUMBER>"],compute:function(rows=1,columns=1,min=0,max=1,whole_number=false){const _cols=toInteger(columns,this.locale);const _rows=toInteger(rows,this.locale);const _min=toNumber(min,this.locale);const _max=toNumber(max,this.locale);const _whole_number=toBoolean(whole_number);assertPositive(_t("The number columns (%s) must be positive.",_cols.toString()),_cols);assertPositive(_t("The number rows (%s) must be positive.",_rows.toString()),_rows);assert(()=>_min<=_max,_t("The maximum (%s) must be greater than or equal to the minimum (%s).",_max.toString(),_min.toString()));if(_whole_number){assert(()=>Number.isInteger(_min)&&Number.isInteger(_max),_t("The maximum (%s) and minimum (%s) must be integers when whole_number is TRUE.",_max.toString(),_min.toString()));}
const result=Array(_cols);for(let col=0;col<_cols;col++){result[col]=Array(_rows);for(let row=0;row<_rows;row++){if(!_whole_number){result[col][row]=_min+Math.random()*(_max-_min);}
else{result[col][row]=Math.floor(Math.random()*(_max-_min+1)+_min);}}}
return result;},isExported:true,};const RANDBETWEEN={description:_t("Random integer between two values, inclusive."),args:[arg("low (number)",_t("The low end of the random range.")),arg("high (number)",_t("The high end of the random range.")),],returns:["NUMBER"],computeFormat:(low)=>low?.format,compute:function(low,high){let _low=toNumber(low,this.locale);if(!Number.isInteger(_low)){_low=Math.ceil(_low);}
let _high=toNumber(high,this.locale);if(!Number.isInteger(_high)){_high=Math.floor(_high);}
assert(()=>_low<=_high,_t("The high (%s) must be greater than or equal to the low (%s).",_high.toString(),_low.toString()));return _low+Math.ceil((_high-_low+1)*Math.random())-1;},isExported:true,};const ROUND={description:_t("Rounds a number according to standard rules."),args:[arg("value (number)",_t("The value to round to places number of places.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of decimal places to which to round.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);const absValue=Math.abs(_value);let tempResult;if(_places===0){tempResult=Math.round(absValue);}
else{if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
tempResult=Math.round(absValue*Math.pow(10,_places))/Math.pow(10,_places);}
return _value>=0?tempResult:-tempResult;},isExported:true,};const ROUNDDOWN={description:_t("Rounds down a number."),args:[arg("value (number)",_t("The value to round to places number of places, always rounding down.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of decimal places to which to round.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);const absValue=Math.abs(_value);let tempResult;if(_places===0){tempResult=Math.floor(absValue);}
else{if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
tempResult=Math.floor(absValue*Math.pow(10,_places))/Math.pow(10,_places);}
return _value>=0?tempResult:-tempResult;},isExported:true,};const ROUNDUP={description:_t("Rounds up a number."),args:[arg("value (number)",_t("The value to round to places number of places, always rounding up.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of decimal places to which to round.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);const absValue=Math.abs(_value);let tempResult;if(_places===0){tempResult=Math.ceil(absValue);}
else{if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
tempResult=Math.ceil(absValue*Math.pow(10,_places))/Math.pow(10,_places);}
return _value>=0?tempResult:-tempResult;},isExported:true,};const SEC={description:_t("Secant of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the secant of, in radians."))],returns:["NUMBER"],compute:function(angle){return 1/Math.cos(toNumber(angle,this.locale));},isExported:true,};const SECH={description:_t("Hyperbolic secant of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic secant of."))],returns:["NUMBER"],compute:function(value){return 1/Math.cosh(toNumber(value,this.locale));},isExported:true,};const SIN={description:_t("Sine of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the sine of, in radians."))],returns:["NUMBER"],compute:function(angle){return Math.sin(toNumber(angle,this.locale));},isExported:true,};const SINH={description:_t("Hyperbolic sine of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic sine of."))],returns:["NUMBER"],compute:function(value){return Math.sinh(toNumber(value,this.locale));},isExported:true,};const SQRT={description:_t("Positive square root of a positive number."),args:[arg("value (number)",_t("The number for which to calculate the positive square root."))],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value){const _value=toNumber(value,this.locale);assert(()=>_value>=0,_t("The value (%s) must be positive or null.",_value.toString()));return Math.sqrt(_value);},isExported:true,};const SUM={description:_t("Sum of a series of numbers and/or cells."),args:[arg("value1 (number, range<number>)",_t("The first number or range to add together.")),arg("value2 (number, range<number>, repeating)",_t("Additional numbers or ranges to add to value1.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){return reduceNumbers(values,(acc,a)=>acc+a,0,this.locale);},isExported:true,};const SUMIF={description:_t("A conditional sum across a range."),args:[arg("criteria_range (range)",_t("The range which is tested against criterion.")),arg("criterion (string)",_t("The pattern or test to apply to range.")),arg("sum_range (range, default=criteria_range)",_t("The range to be summed, if different from range.")),],returns:["NUMBER"],compute:function(criteriaRange,criterion,sumRange){if(sumRange===undefined){sumRange=criteriaRange;}
let sum=0;visitMatchingRanges([criteriaRange,criterion],(i,j)=>{const value=sumRange[i][j];if(typeof value==="number"){sum+=value;}},this.locale);return sum;},isExported:true,};const SUMIFS={description:_t("Sums a range depending on multiple criteria."),args:[arg("sum_range (range)",_t("The range to sum.")),arg("criteria_range1 (range)",_t("The range to check against criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges to check.")),arg("criterion2 (string, repeating)",_t("Additional criteria to check.")),],returns:["NUMBER"],compute:function(sumRange,...criters){let sum=0;visitMatchingRanges(criters,(i,j)=>{const value=sumRange[i][j];if(typeof value==="number"){sum+=value;}},this.locale);return sum;},isExported:true,};const TAN={description:_t("Tangent of an angle provided in radians."),args:[arg("angle (number)",_t("The angle to find the tangent of, in radians."))],returns:["NUMBER"],compute:function(angle){return Math.tan(toNumber(angle,this.locale));},isExported:true,};const TANH={description:_t("Hyperbolic tangent of any real number."),args:[arg("value (number)",_t("Any real value to calculate the hyperbolic tangent of."))],returns:["NUMBER"],compute:function(value){return Math.tanh(toNumber(value,this.locale));},isExported:true,};const TRUNC={description:_t("Truncates a number."),args:[arg("value (number)",_t("The value to be truncated.")),arg(`places (number, default=${DEFAULT_PLACES})`,_t("The number of significant digits to the right of the decimal point to retain.")),],returns:["NUMBER"],computeFormat:(value)=>value?.format,compute:function(value,places=DEFAULT_PLACES){const _value=toNumber(value,this.locale);let _places=toNumber(places,this.locale);if(_places===0){return Math.trunc(_value);}
if(!Number.isInteger(_places)){_places=Math.trunc(_places);}
return Math.trunc(_value*Math.pow(10,_places))/Math.pow(10,_places);},isExported:true,};const INT={description:_t("Rounds a number down to the nearest integer that is less than or equal to it."),args:[arg("value (number)",_t("The number to round down to the nearest integer."))],returns:["NUMBER"],compute:function(value){return Math.floor(toNumber(value,this.locale));},isExported:true,};var math=Object.freeze({__proto__:null,ABS:ABS,ACOS:ACOS,ACOSH:ACOSH,ACOT:ACOT,ACOTH:ACOTH,ASIN:ASIN,ASINH:ASINH,ATAN:ATAN,ATAN2:ATAN2,ATANH:ATANH,CEILING:CEILING,CEILING_MATH:CEILING_MATH,CEILING_PRECISE:CEILING_PRECISE,COS:COS,COSH:COSH,COT:COT,COTH:COTH,COUNTBLANK:COUNTBLANK,COUNTIF:COUNTIF,COUNTIFS:COUNTIFS,COUNTUNIQUE:COUNTUNIQUE,COUNTUNIQUEIFS:COUNTUNIQUEIFS,CSC:CSC,CSCH:CSCH,DECIMAL:DECIMAL,DEGREES:DEGREES,EXP:EXP,FLOOR:FLOOR,FLOOR_MATH:FLOOR_MATH,FLOOR_PRECISE:FLOOR_PRECISE,INT:INT,ISEVEN:ISEVEN,ISODD:ISODD,ISO_CEILING:ISO_CEILING,LN:LN,MOD:MOD,MUNIT:MUNIT,ODD:ODD,PI:PI,POWER:POWER,PRODUCT:PRODUCT,RAND:RAND,RANDARRAY:RANDARRAY,RANDBETWEEN:RANDBETWEEN,ROUND:ROUND,ROUNDDOWN:ROUNDDOWN,ROUNDUP:ROUNDUP,SEC:SEC,SECH:SECH,SIN:SIN,SINH:SINH,SQRT:SQRT,SUM:SUM,SUMIF:SUMIF,SUMIFS:SUMIFS,TAN:TAN,TANH:TANH,TRUNC:TRUNC});function assertSameNumberOfElements(...args){const dims=args[0].length;args.forEach((arg,i)=>assert(()=>arg.length===dims,_t("[[FUNCTION_NAME]] has mismatched dimensions for argument %s (%s vs %s).",i.toString(),dims.toString(),arg.length.toString())));}
function filterAndFlatData(dataY,dataX){const _flatDataY=[];const _flatDataX=[];let lenY=0;let lenX=0;visitAny([dataY],(y)=>{_flatDataY.push(y);lenY+=1;});visitAny([dataX],(x)=>{_flatDataX.push(x);lenX+=1;});assert(()=>lenY===lenX,_t("[[FUNCTION_NAME]] has mismatched argument count %s vs %s.",lenY,lenX));const flatDataX=[];const flatDataY=[];for(let i=0;i<lenY;i++){const valueY=_flatDataY[i];const valueX=_flatDataX[i];if(typeof valueY==="number"&&typeof valueX==="number"){flatDataY.push(valueY);flatDataX.push(valueX);}}
return{flatDataX,flatDataY};}
function covariance(dataY,dataX,isSample){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const count=flatDataY.length;assert(()=>count!==0&&(!isSample||count!==1),_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));let sumY=0;let sumX=0;for(let i=0;i<count;i++){sumY+=flatDataY[i];sumX+=flatDataX[i];}
const averageY=sumY/count;const averageX=sumX/count;let acc=0;for(let i=0;i<count;i++){acc+=(flatDataY[i]-averageY)*(flatDataX[i]-averageX);}
return acc/(count-(isSample?1:0));}
function variance(args,isSample,textAs0,locale){let count=0;let sum=0;const reduceFunction=textAs0?reduceNumbersTextAs0:reduceNumbers;sum=reduceFunction(args,(acc,a)=>{count+=1;return acc+a;},0,locale);assert(()=>count!==0&&(!isSample||count!==1),_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));const average=sum/count;return(reduceFunction(args,(acc,a)=>acc+Math.pow(a-average,2),0,locale)/(count-(isSample?1:0)));}
function centile(data,percent,isInclusive,locale){const _percent=toNumber(percent,locale);assert(()=>(isInclusive?0<=_percent&&_percent<=1:0<_percent&&_percent<1),_t("Function [[FUNCTION_NAME]] parameter 2 value is out of range."));let sortedArray=[];let index;let count=0;visitAny(data,(d)=>{if(typeof d==="number"){index=dichotomicSearch(sortedArray,d,"nextSmaller","asc",sortedArray.length,(array,i)=>array[i]);sortedArray.splice(index+1,0,d);count++;}});assert(()=>count!==0,_t("[[FUNCTION_NAME]] has no valid input data."));if(!isInclusive){assert(()=>1/(count+1)<=_percent&&_percent<=count/(count+1),_t("Function [[FUNCTION_NAME]] parameter 2 value is out of range."));}
return percentile(sortedArray,_percent,isInclusive);}
function prepareDataForRegression(X,Y,newX){const _X=X.length?X:[range(1,Y.flat().length+1)];const nVar=_X.length;let _newX=newX.length?newX:_X;_newX=_newX.length===nVar?transposeMatrix(_newX):_newX;return{_X,_newX};}
function fullLinearRegression(X,Y,computeIntercept=true,verbose=false){const y=Y.flat();const n=y.length;let{_X}=prepareDataForRegression(X,Y,[]);_X=_X.length===n?transposeMatrix(_X):_X.slice();assertSameNumberOfElements(_X[0],y);const nVar=_X.length;const nDeg=n-nVar-(computeIntercept?1:0);const yMatrix=[y];const xMatrix=transposeMatrix(_X.reverse());let avgX=[];for(let i=0;i<nVar;i++){avgX.push(0);if(computeIntercept){for(const xij of _X[i]){avgX[i]+=xij;}
avgX[i]/=n;}}
let avgY=0;if(computeIntercept){for(const yi of y){avgY+=yi;}
avgY/=n;}
const redX=xMatrix.map((row)=>row.map((value,i)=>value-avgX[i]));if(computeIntercept){xMatrix.forEach((row)=>row.push(1));}
const coeffs=getLMSCoefficients(xMatrix,yMatrix);if(!computeIntercept){coeffs.push([0]);}
if(!verbose){return coeffs;}
const dot1=multiplyMatrices(redX,transposeMatrix(redX));const{inverted:dotInv}=invertMatrix(dot1);if(dotInv===undefined){throw new Error(_t("Matrix is not invertible"));}
let SSE=0,SSR=0;for(let i=0;i<n;i++){const yi=y[i]-avgY;let temp=0;for(let j=0;j<nVar;j++){const xi=redX[i][j];temp+=xi*coeffs[j][0];}
const ei=yi-temp;SSE+=ei*ei;SSR+=temp*temp;}
const RMSE=Math.sqrt(SSE/nDeg);const r2=SSR/(SSR+SSE);const f_stat=SSR/nVar/(SSE/nDeg);const deltaCoeffs=[];for(let i=0;i<nVar;i++){deltaCoeffs.push(RMSE*Math.sqrt(dotInv[i][i]));}
if(computeIntercept){const dot2=multiplyMatrices(dotInv,[avgX]);const dot3=multiplyMatrices(transposeMatrix([avgX]),dot2);deltaCoeffs.push(RMSE*Math.sqrt(dot3[0][0]+1/y.length));}
const returned=[[coeffs[0][0],deltaCoeffs[0],r2,f_stat,SSR],[coeffs[1][0],deltaCoeffs[1],RMSE,nDeg,SSE],];for(let i=2;i<nVar;i++){returned.push([coeffs[i][0],deltaCoeffs[i],"","",""]);}
if(computeIntercept){returned.push([coeffs[nVar][0],deltaCoeffs[nVar],"","",""]);}
else{returned.push([0,"","","",""]);}
return returned;}
function polynomialRegression(flatY,flatX,order,intercept){assertSameNumberOfElements(flatX,flatY);assert(()=>order>=1,_t("Function [[FUNCTION_NAME]] A regression of order less than 1 cannot be possible."));const yMatrix=[flatY];const xMatrix=flatX.map((x)=>range(0,order).map((i)=>Math.pow(x,order-i)));if(intercept){xMatrix.forEach((row)=>row.push(1));}
const coeffs=getLMSCoefficients(xMatrix,yMatrix);if(!intercept){coeffs.push([0]);}
return coeffs;}
function getLMSCoefficients(xMatrix,yMatrix){const xMatrixT=transposeMatrix(xMatrix);const dot1=multiplyMatrices(xMatrix,xMatrixT);const{inverted:dotInv}=invertMatrix(dot1);if(dotInv===undefined){throw new Error(_t("Matrix is not invertible"));}
const dot2=multiplyMatrices(xMatrix,yMatrix);return transposeMatrix(multiplyMatrices(dotInv,dot2));}
function evaluatePolynomial(coeffs,x,order){return coeffs.reduce((acc,coeff,i)=>acc+coeff*Math.pow(x,order-i),0);}
function expM(M){return M.map((col)=>col.map((cell)=>Math.exp(cell)));}
function logM(M){return M.map((col)=>col.map((cell)=>Math.log(cell)));}
function predictLinearValues(Y,X,newX,computeIntercept){const{_X,_newX}=prepareDataForRegression(X,Y,newX);const coeffs=fullLinearRegression(_X,Y,computeIntercept,false);const nVar=coeffs.length-1;const newY=_newX.map((col)=>{let value=0;for(let i=0;i<nVar;i++){value+=coeffs[i][0]*col[nVar-i-1];}
value+=coeffs[nVar][0];return[value];});return newY.length===newX.length?newY:transposeMatrix(newY);}
const AVEDEV={description:_t("Average magnitude of deviations from mean."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){let count=0;const sum=reduceNumbers(values,(acc,a)=>{count+=1;return acc+a;},0,this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));const average=sum/count;return reduceNumbers(values,(acc,a)=>acc+Math.abs(average-a),0,this.locale)/count;},isExported:true,};const AVERAGE={description:_t("Numerical average value in a dataset, ignoring text."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the average value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the average value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){let count=0;const sum=reduceNumbers(values,(acc,a)=>{count+=1;return acc+a;},0,this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const rangeError=_t("[[FUNCTION_NAME]] has mismatched range sizes.");const negativeWeightError=_t("[[FUNCTION_NAME]] expects the weight to be positive or equal to 0.");const AVERAGE_WEIGHTED={description:_t("Weighted average."),args:[arg("values (number, range<number>)",_t("Values to average.")),arg("weights (number, range<number>)",_t("Weights for each corresponding value.")),arg("additional_values (number, range<number>, repeating)",_t("Additional values to average.")),arg("additional_weights (number, range<number>, repeating)",_t("Additional weights.")),],returns:["NUMBER"],computeFormat:(values)=>{return isMatrix(values)?values[0][0]?.format:values?.format;},compute:function(...values){let sum=0;let count=0;let value;let weight;assert(()=>values.length%2===0,_t("Wrong number of Argument[]. Expected an even number of Argument[]."));for(let n=0;n<values.length-1;n+=2){value=values[n];weight=values[n+1];if(isMatrix(value)){assert(()=>isMatrix(weight),rangeError);let dimColValue=value.length;let dimLinValue=value[0].length;assert(()=>dimColValue===weight.length&&dimLinValue===weight[0].length,rangeError);for(let i=0;i<dimColValue;i++){for(let j=0;j<dimLinValue;j++){let subValue=value[i][j];let subWeight=weight[i][j];let subValueIsNumber=typeof subValue==="number";let subWeightIsNumber=typeof subWeight==="number";assert(()=>subValueIsNumber===subWeightIsNumber,_t("[[FUNCTION_NAME]] expects number values."));if(subWeightIsNumber){assert(()=>subWeight>=0,negativeWeightError);sum+=subValue*subWeight;count+=subWeight;}}}}
else{weight=toNumber(weight,this.locale);value=toNumber(value,this.locale);assert(()=>weight>=0,negativeWeightError);sum+=value*weight;count+=weight;}}
assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},};const AVERAGEA={description:_t("Numerical average value in a dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the average value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the average value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){let count=0;const sum=reduceNumbersTextAs0(values,(acc,a)=>{count+=1;return acc+a;},0,this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const AVERAGEIF={description:_t("Average of values depending on criteria."),args:[arg("criteria_range (number, range<number>)",_t("The range to check against criterion.")),arg("criterion (string)",_t("The pattern or test to apply to criteria_range.")),arg("average_range (number, range<number>, default=criteria_range)",_t("The range to average. If not included, criteria_range is used for the average instead.")),],returns:["NUMBER"],compute:function(criteriaRange,criterion,averageRange){const _criteriaRange=toMatrix(criteriaRange);const _averageRange=averageRange===undefined?_criteriaRange:toMatrix(averageRange);let count=0;let sum=0;visitMatchingRanges([criteriaRange,criterion],(i,j)=>{const value=_averageRange[i][j];if(typeof value==="number"){count+=1;sum+=value;}},this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const AVERAGEIFS={description:_t("Average of values depending on multiple criteria."),args:[arg("average_range (range)",_t("The range to average.")),arg("criteria_range1 (range)",_t("The range to check against criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1.")),arg("criteria_range2 (any, range, repeating)",_t("Additional criteria_range and criterion to check.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(averageRange,...values){const _averageRange=toMatrix(averageRange);let count=0;let sum=0;visitMatchingRanges(values,(i,j)=>{const value=_averageRange[i][j];if(typeof value==="number"){count+=1;sum+=value;}},this.locale);assert(()=>count!==0,_t("Evaluation of function [[FUNCTION_NAME]] caused a divide by zero error."));return sum/count;},isExported:true,};const COUNT={description:_t("The number of numeric values in dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when counting.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when counting.")),],returns:["NUMBER"],compute:function(...values){let count=0;for(let n of values){if(isMatrix(n)){for(let i of n){for(let j of i){if(typeof j==="number"){count+=1;}}}}
else if(typeof n!=="string"||isNumber(n,this.locale)||parseDateTime(n,this.locale)){count+=1;}}
return count;},isExported:true,};const COUNTA={description:_t("The number of values in a dataset."),args:[arg("value1 (any, range)",_t("The first value or range to consider when counting.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider when counting.")),],returns:["NUMBER"],compute:function(...values){return reduceAny(values,(acc,a)=>(a!==undefined&&a!==null?acc+1:acc),0);},isExported:true,};const COVAR={description:_t("The covariance of a dataset."),args:[arg("data_y (any, range)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (any, range)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){return covariance(dataY,dataX,false);},isExported:true,};const COVARIANCE_P={description:_t("The covariance of a dataset."),args:[arg("data_y (any, range)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (any, range)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){return covariance(dataY,dataX,false);},isExported:true,};const COVARIANCE_S={description:_t("The sample covariance of a dataset."),args:[arg("data_y (any, range)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (any, range)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){return covariance(dataY,dataX,true);},isExported:true,};const FORECAST={description:_t("Calculates the expected y-value for a specified x based on a linear regression of a dataset."),args:[arg("x (number, range<number>)",_t("The value(s) on the x-axis to forecast.")),arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(x,dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);return predictLinearValues([flatDataY],[flatDataX],matrixMap(toMatrix(x),(value)=>toNumber(value,this.locale)),true);},isExported:true,};const GROWTH={description:_t("Fits points to exponential growth trend."),args:[arg("known_data_y (range<number>)",_t("The array or range containing dependent (y) values that are already known, used to curve fit an ideal exponential growth curve.")),arg("known_data_x (range<number>, default={1;2;3;...})",_t("The values of the independent variable(s) corresponding with known_data_y.")),arg("new_data_x (any, range, default=known_data_x)",_t("The data points to return the y values for on the ideal curve fit.")),arg("b (boolean, default=TRUE)",_t("Given a general exponential form of y = b*m^x for a curve fit, calculates b if TRUE or forces b to be 1 and only calculates the m values if FALSE.")),],returns:["NUMBER"],compute:function(knownDataY,knownDataX=[],newDataX=[],b=true){return expM(predictLinearValues(logM(tryCastAsNumberMatrix(knownDataY,"the first argument (known_data_y)")),tryCastAsNumberMatrix(knownDataX,"the second argument (known_data_x)"),tryCastAsNumberMatrix(newDataX,"the third argument (new_data_y)"),toBoolean(b)));},};const INTERCEPT={description:_t("Compute the intercept of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const[[],[intercept]]=fullLinearRegression([flatDataX],[flatDataY]);return intercept;},isExported:true,};const LARGE={description:_t("Nth largest element from a data set."),args:[arg("data (any, range)",_t("Array or range containing the dataset to consider.")),arg("n (number)",_t("The rank from largest to smallest of the element to return.")),],returns:["NUMBER"],computeValueAndFormat:function(data,n){const _n=Math.trunc(toNumber(n?.value,this.locale));let largests=[];let index;let count=0;visitAny([data],(d)=>{if(typeof d.value==="number"){index=dichotomicSearch(largests,d.value,"nextSmaller","asc",largests.length,(array,i)=>array[i].value);largests.splice(index+1,0,d);count++;if(count>_n){largests.shift();count--;}}});const result=largests.shift();assert(()=>result!==undefined,_t("[[FUNCTION_NAME]] has no valid input data."));assert(()=>count>=_n,_t("Function [[FUNCTION_NAME]] parameter 2 value (%s) is out of range.",_n));return result;},isExported:true,};const LINEST={description:_t("Compute the intercept of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>, default={1;2;3;...})",_t("The range representing the array or matrix of independent data.")),arg("calculate_b (boolean, default=TRUE)",_t("A flag specifying wheter to compute the slope or not")),arg("verbose (boolean, default=FALSE)",_t("A flag specifying whether to return additional regression statistics or only the linear coefficients and the y-intercept")),],returns:["NUMBER"],compute:function(dataY,dataX=[],calculateB=true,verbose=false){return fullLinearRegression(tryCastAsNumberMatrix(dataX,"the first argument (data_y)"),tryCastAsNumberMatrix(dataY,"the second argument (data_x)"),toBoolean(calculateB),toBoolean(verbose));},isExported:true,};const LOGEST={description:_t("Compute the intercept of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>, optional, default={1;2;3;...})",_t("The range representing the array or matrix of independent data.")),arg("calculate_b (boolean, default=TRUE)",_t("A flag specifying wheter to compute the slope or not")),arg("verbose (boolean, default=FALSE)",_t("A flag specifying whether to return additional regression statistics or only the linear coefficients and the y-intercept")),],returns:["NUMBER"],compute:function(dataY,dataX=[],calculateB=true,verbose=false){const coeffs=fullLinearRegression(tryCastAsNumberMatrix(dataX,"the second argument (data_x)"),logM(tryCastAsNumberMatrix(dataY,"the first argument (data_y)")),toBoolean(calculateB),toBoolean(verbose));for(let i=0;i<coeffs.length;i++){coeffs[i][0]=Math.exp(coeffs[i][0]);}
return coeffs;},isExported:true,};const MATTHEWS={description:_t("Compute the Matthews correlation coefficient of a dataset."),args:[arg("data_x (range)",_t("The range representing the array or matrix of observed data.")),arg("data_y (range)",_t("The range representing the array or matrix of predicted data.")),],returns:["NUMBER"],compute:function(dataX,dataY){const flatX=dataX.flat();const flatY=dataY.flat();assertSameNumberOfElements(flatX,flatY);if(flatX.length===0){throw new Error(_t("[[FUNCTION_NAME]] expects non-empty ranges for both parameters."));}
const n=flatX.length;let trueN=0,trueP=0,falseP=0,falseN=0;for(let i=0;i<n;++i){const isTrue1=toBoolean(flatX[i]);const isTrue2=toBoolean(flatY[i]);if(isTrue1===isTrue2){if(isTrue1){trueP++;}
else{trueN++;}}
else{if(isTrue1){falseN++;}
else{falseP++;}}}
return((trueP*trueN-falseP*falseN)/Math.sqrt((trueP+falseP)*(trueP+falseN)*(trueN+falseP)*(trueN+falseN)));},isExported:false,};const MAX={description:_t("Maximum value in a numeric dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the maximum value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the maximum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const result=reduceNumbers(values,(acc,a)=>(acc<a?a:acc),-Infinity,this.locale);return result===-Infinity?0:result;},isExported:true,};const MAXA={description:_t("Maximum numeric value in a dataset."),args:[arg("value1 (any, range)",_t("The first value or range to consider when calculating the maximum value.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider when calculating the maximum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const maxa=reduceNumbersTextAs0(values,(acc,a)=>{return Math.max(a,acc);},-Infinity,this.locale);return maxa===-Infinity?0:maxa;},isExported:true,};const MAXIFS={description:_t("Returns the maximum value in a range of cells, filtered by a set of criteria."),args:[arg("range (range)",_t("The range of cells from which the maximum will be determined.")),arg("criteria_range1 (range)",_t("The range of cells over which to evaluate criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1, such that each cell that evaluates to TRUE will be included in the filtered set.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(range,...args){let result=-Infinity;const _range=toMatrix(range);visitMatchingRanges(args,(i,j)=>{const value=_range[i][j];if(typeof value==="number"){result=result<value?value:result;}},this.locale);return result===-Infinity?0:result;},isExported:true,};const MEDIAN={description:_t("Median value in a numeric dataset."),args:[arg("value1 (any, range)",_t("The first value or range to consider when calculating the median value.")),arg("value2 (any, range, repeating)",_t("Additional values or ranges to consider when calculating the median value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){let data=[];visitNumbers(values,(arg)=>{data.push(arg);},this.locale);return centile(data,0.5,true,this.locale);},isExported:true,};const MIN={description:_t("Minimum value in a numeric dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the minimum value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the minimum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const result=reduceNumbers(values,(acc,a)=>(a<acc?a:acc),Infinity,this.locale);return result===Infinity?0:result;},isExported:true,};const MINA={description:_t("Minimum numeric value in a dataset."),args:[arg("value1 (number, range<number>)",_t("The first value or range to consider when calculating the minimum value.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to consider when calculating the minimum value.")),],returns:["NUMBER"],computeFormat:(value1)=>{return isMatrix(value1)?value1[0][0]?.format:value1?.format;},compute:function(...values){const mina=reduceNumbersTextAs0(values,(acc,a)=>{return Math.min(a,acc);},Infinity,this.locale);return mina===Infinity?0:mina;},isExported:true,};const MINIFS={description:_t("Returns the minimum value in a range of cells, filtered by a set of criteria."),args:[arg("range (range)",_t("The range of cells from which the minimum will be determined.")),arg("criteria_range1 (range)",_t("The range of cells over which to evaluate criterion1.")),arg("criterion1 (string)",_t("The pattern or test to apply to criteria_range1, such that each cell that evaluates to TRUE will be included in the filtered set.")),arg("criteria_range2 (any, range, repeating)",_t("Additional ranges over which to evaluate the additional criteria. The filtered set will be the intersection of the sets produced by each criterion-range pair.")),arg("criterion2 (string, repeating)",_t("The pattern or test to apply to criteria_range2.")),],returns:["NUMBER"],compute:function(range,...args){let result=Infinity;const _range=toMatrix(range);visitMatchingRanges(args,(i,j)=>{const value=_range[i][j];if(typeof value==="number"){result=result>value?value:result;}},this.locale);return result===Infinity?0:result;},isExported:true,};const PEARSON={description:_t("Compute the Pearson product-moment correlation coefficient of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataX,dataY);if(flatDataX.length===0){throw new Error(_t("[[FUNCTION_NAME]] expects non-empty ranges for both parameters."));}
if(flatDataX.length<2){throw new Error(_t("[[FUNCTION_NAME]] needs at least two values for both parameters"));}
const n=flatDataX.length;let sumX=0,sumY=0,sumXY=0,sumXX=0,sumYY=0;for(let i=0;i<n;i++){const xij=flatDataX[i];const yij=flatDataY[i];sumX+=xij;sumY+=yij;sumXY+=xij*yij;sumXX+=xij*xij;sumYY+=yij*yij;}
return((n*sumXY-sumX*sumY)/Math.sqrt((n*sumXX-sumX*sumX)*(n*sumYY-sumY*sumY)));},isExported:true,};const CORREL=PEARSON;const PERCENTILE={description:_t("Value at a given percentile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("percentile (number)",_t("The percentile whose value within data will be calculated and returned.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,percentile){return PERCENTILE_INC.compute.bind(this)(data,percentile);},isExported:true,};const PERCENTILE_EXC={description:_t("Value at a given percentile of a dataset exclusive of 0 and 1."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("percentile (number)",_t("The percentile, exclusive of 0 and 1, whose value within 'data' will be calculated and returned.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,percentile){return centile([data],percentile,false,this.locale);},isExported:true,};const PERCENTILE_INC={description:_t("Value at a given percentile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("percentile (number)",_t("The percentile whose value within data will be calculated and returned.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,percentile){return centile([data],percentile,true,this.locale);},isExported:true,};const POLYFIT_COEFFS={description:_t("Compute the coefficients of polynomial regression of the dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),arg("order (number)",_t("The order of the polynomial to fit the data, between 1 and 6.")),arg("intercept (boolean, default=TRUE)",_t("A flag specifying whether to compute the intercept or not.")),],returns:["RANGE<NUMBER>"],compute:function(dataY,dataX,order,intercept=true){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);return polynomialRegression(flatDataY,flatDataX,toNumber(order,this.locale),toBoolean(intercept));},isExported:false,};const POLYFIT_FORECAST={description:_t("Predict value by computing a polynomial regression of the dataset."),args:[arg("x (number, range<number>)",_t("The value(s) on the x-axis to forecast.")),arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),arg("order (number)",_t("The order of the polynomial to fit the data, between 1 and 6.")),arg("intercept (boolean, default=TRUE)",_t("A flag specifying whether to compute the intercept or not.")),],returns:["NUMBER"],compute:function(x,dataY,dataX,order,intercept=true){const _order=toNumber(order,this.locale);const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const coeffs=polynomialRegression(flatDataY,flatDataX,_order,toBoolean(intercept)).flat();return matrixMap(toMatrix(x),(xij)=>evaluatePolynomial(coeffs,toNumber(xij,this.locale),_order));},isExported:false,};const QUARTILE={description:_t("Value nearest to a specific quartile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("quartile_number (number)",_t("Which quartile value to return.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,quartileNumber){return QUARTILE_INC.compute.bind(this)(data,quartileNumber);},isExported:true,};const QUARTILE_EXC={description:_t("Value nearest to a specific quartile of a dataset exclusive of 0 and 4."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("quartile_number (number)",_t("Which quartile value, exclusive of 0 and 4, to return.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,quartileNumber){const _quartileNumber=Math.trunc(toNumber(quartileNumber,this.locale));return centile([data],0.25*_quartileNumber,false,this.locale);},isExported:true,};const QUARTILE_INC={description:_t("Value nearest to a specific quartile of a dataset."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("quartile_number (number)",_t("Which quartile value to return.")),],returns:["NUMBER"],computeFormat:(data)=>{return isMatrix(data)?data[0][0]?.format:data?.format;},compute:function(data,quartileNumber){const _quartileNumber=Math.trunc(toNumber(quartileNumber,this.locale));return centile([data],0.25*_quartileNumber,true,this.locale);},isExported:true,};const RANK={description:_t("Returns the rank of a specified value in a dataset."),args:[arg("value (number)",_t("The value whose rank will be determined.")),arg("data (range)",_t("The range containing the dataset to consider.")),arg("is_ascending (boolean, default=FALSE)",_t("Whether to consider the values in data in descending or ascending order.")),],returns:["ANY"],compute:function(value,data,isAscending=false){const _isAscending=toBoolean(isAscending);const _value=toNumber(value,this.locale);let rank=1;let found=false;for(const row of data){for(const cell of row){if(typeof cell!=="number"){continue;}
const _cell=toNumber(cell,this.locale);if(_cell===_value){found=true;}
else if(_cell>_value!==_isAscending){rank++;}}}
if(!found){throw new NotAvailableError(_t("Value not found in the given data."));}
return rank;},isExported:true,};const RSQ={description:_t("Compute the square of r, the Pearson product-moment correlation coefficient of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const pearson=PEARSON.compute.bind(this);return Math.pow(pearson(dataX,dataY),2.0);},isExported:true,};const SLOPE={description:_t("Compute the slope of the linear regression."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const[[slope]]=fullLinearRegression([flatDataX],[flatDataY]);return slope;},isExported:true,};const SMALL={description:_t("Nth smallest element in a data set."),args:[arg("data (any, range)",_t("The array or range containing the dataset to consider.")),arg("n (number)",_t("The rank from smallest to largest of the element to return.")),],returns:["NUMBER"],computeValueAndFormat:function(data,n){const _n=Math.trunc(toNumber(n?.value,this.locale));let largests=[];let index;let count=0;visitAny([data],(d)=>{if(typeof d.value==="number"){index=dichotomicSearch(largests,d.value,"nextSmaller","asc",largests.length,(array,i)=>array[i].value);largests.splice(index+1,0,d);count++;if(count>_n){largests.pop();count--;}}});const result=largests.pop();assert(()=>result!==undefined,_t("[[FUNCTION_NAME]] has no valid input data."));assert(()=>count>=_n,_t("Function [[FUNCTION_NAME]] parameter 2 value (%s) is out of range.",_n));return result;},isExported:true,};const SPEARMAN={description:_t("Compute the Spearman rank correlation coefficient of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataX,dataY){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const n=flatDataX.length;const order=flatDataX.map((e,i)=>[e,flatDataY[i]]);order.sort((a,b)=>a[0]-b[0]);for(let i=0;i<n;++i){order[i][0]=i;}
order.sort((a,b)=>a[1]-b[1]);let sum=0.0;for(let i=0;i<n;++i){sum+=(order[i][0]-i)**2;}
return 1-(6*sum)/(n**3-n);},isExported:false,};const STDEV={description:_t("Standard deviation."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VAR.compute.bind(this)(...values));},isExported:true,};const STDEV_P={description:_t("Standard deviation of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VAR_P.compute.bind(this)(...values));},isExported:true,};const STDEV_S={description:_t("Standard deviation."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VAR_S.compute.bind(this)(...values));},isExported:true,};const STDEVA={description:_t("Standard deviation of sample (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VARA.compute.bind(this)(...values));},isExported:true,};const STDEVP={description:_t("Standard deviation of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VARP.compute.bind(this)(...values));},isExported:true,};const STDEVPA={description:_t("Standard deviation of entire population (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return Math.sqrt(VARPA.compute.bind(this)(...values));},isExported:true,};const STEYX={description:_t("Calculates the standard error of the predicted y-value for each x in the regression of a dataset."),args:[arg("data_y (range<number>)",_t("The range representing the array or matrix of dependent data.")),arg("data_x (range<number>)",_t("The range representing the array or matrix of independent data.")),],returns:["NUMBER"],compute:function(dataY,dataX){const{flatDataX,flatDataY}=filterAndFlatData(dataY,dataX);const data=fullLinearRegression([flatDataX],[flatDataY],true,true);return data[1][2];},isExported:true,};const TREND={description:_t("Fits points to linear trend derived via least-squares."),args:[arg("known_data_y (number, range<number>)",_t("The array or range containing dependent (y) values that are already known, used to curve fit an ideal linear trend.")),arg("known_data_x (number, range<number>, optional, default={1;2;3;...})",_t("The values of the independent variable(s) corresponding with known_data_y.")),arg("new_data_x (number, range<number>, optional, default=known_data_x)",_t("The data points to return the y values for on the ideal curve fit.")),arg("b (boolean, optional, default=TRUE)",_t("Given a general linear form of y = m*x+b for a curve fit, calculates b if TRUE or forces b to be 0 and only calculates the m values if FALSE, i.e. forces the curve fit to pass through the origin.")),],returns:["NUMBER"],compute:function(knownDataY,knownDataX=[],newDataX=[],b=true){return predictLinearValues(tryCastAsNumberMatrix(knownDataY,"the first argument (known_data_y)"),tryCastAsNumberMatrix(knownDataX,"the second argument (known_data_x)"),tryCastAsNumberMatrix(newDataX,"the third argument (new_data_y)"),toBoolean(b));},};const VAR={description:_t("Variance."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return variance(values,true,false,this.locale);},isExported:true,};const VAR_P={description:_t("Variance of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return variance(values,false,false,this.locale);},isExported:true,};const VAR_S={description:_t("Variance."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return variance(values,true,false,this.locale);},isExported:true,};const VARA={description:_t("Variance of sample (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the sample.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the sample.")),],returns:["NUMBER"],compute:function(...values){return variance(values,true,true,this.locale);},isExported:true,};const VARP={description:_t("Variance of entire population."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return variance(values,false,false,this.locale);},isExported:true,};const VARPA={description:_t("Variance of entire population (text as 0)."),args:[arg("value1 (number, range<number>)",_t("The first value or range of the population.")),arg("value2 (number, range<number>, repeating)",_t("Additional values or ranges to include in the population.")),],returns:["NUMBER"],compute:function(...values){return variance(values,false,true,this.locale);},isExported:true,};var statistical=Object.freeze({__proto__:null,AVEDEV:AVEDEV,AVERAGE:AVERAGE,AVERAGEA:AVERAGEA,AVERAGEIF:AVERAGEIF,AVERAGEIFS:AVERAGEIFS,AVERAGE_WEIGHTED:AVERAGE_WEIGHTED,CORREL:CORREL,COUNT:COUNT,COUNTA:COUNTA,COVAR:COVAR,COVARIANCE_P:COVARIANCE_P,COVARIANCE_S:COVARIANCE_S,FORECAST:FORECAST,GROWTH:GROWTH,INTERCEPT:INTERCEPT,LARGE:LARGE,LINEST:LINEST,LOGEST:LOGEST,MATTHEWS:MATTHEWS,MAX:MAX,MAXA:MAXA,MAXIFS:MAXIFS,MEDIAN:MEDIAN,MIN:MIN,MINA:MINA,MINIFS:MINIFS,PEARSON:PEARSON,PERCENTILE:PERCENTILE,PERCENTILE_EXC:PERCENTILE_EXC,PERCENTILE_INC:PERCENTILE_INC,POLYFIT_COEFFS:POLYFIT_COEFFS,POLYFIT_FORECAST:POLYFIT_FORECAST,QUARTILE:QUARTILE,QUARTILE_EXC:QUARTILE_EXC,QUARTILE_INC:QUARTILE_INC,RANK:RANK,RSQ:RSQ,SLOPE:SLOPE,SMALL:SMALL,SPEARMAN:SPEARMAN,STDEV:STDEV,STDEVA:STDEVA,STDEVP:STDEVP,STDEVPA:STDEVPA,STDEV_P:STDEV_P,STDEV_S:STDEV_S,STEYX:STEYX,TREND:TREND,VAR:VAR,VARA:VARA,VARP:VARP,VARPA:VARPA,VAR_P:VAR_P,VAR_S:VAR_S});function getMatchingCells(database,field,criteria,locale){const indexColNameDB=new Map();const dimRowDB=database.length;for(let indexCol=dimRowDB-1;indexCol>=0;indexCol--){indexColNameDB.set(toString(database[indexCol][0]).toUpperCase(),indexCol);}
if(typeof field!=="number"&&typeof field!=="string"){throw new Error(_t("The field must be a number or a string"));}
let index;if(typeof field==="number"){index=Math.trunc(field)-1;if(index<0||dimRowDB-1<index){throw new Error(_t("The field (%s) must be one of %s or must be a number between 1 and %s inclusive.",field.toString(),dimRowDB.toString()));}}
else{const colName=toString(field).toUpperCase();index=indexColNameDB.get(colName)??-1;if(index===-1){throw new Error(_t("The field (%s) must be one of %s.",toString(field),[...indexColNameDB.keys()].toString()));}}
const dimColCriteria=criteria[0].length;if(dimColCriteria<2){throw new Error(_t("The criteria range contains %s row, it must be at least 2 rows.",dimColCriteria.toString()));}
let matchingRows=new Set();const dimColDB=database[0].length;for(let indexRow=1;indexRow<dimColCriteria;indexRow++){let args=[];let existColNameDB=true;for(let indexCol=0;indexCol<criteria.length;indexCol++){const currentName=toString(criteria[indexCol][0]).toUpperCase();const indexColDB=indexColNameDB.get(currentName);const criter=criteria[indexCol][indexRow];if(criter!==null){if(indexColDB!==undefined){args.push([database[indexColDB].slice(1,dimColDB)]);args.push(criter);}
else{existColNameDB=false;break;}}}
if(existColNameDB){if(args.length>0){visitMatchingRanges(args,(i,j)=>{matchingRows.add(j);},locale,true);}
else{matchingRows=new Set(Array(dimColDB-1).keys());break;}}}
const fieldCol=database[index];const matchingCells=[...matchingRows].map((x)=>fieldCol[x+1]);return matchingCells;}
const databaseArgs=[arg("database (range)",_t("The array or range containing the data to consider, structured in such a way that the first row contains the labels for each column's values.")),arg("field (any)",_t("Indicates which column in database contains the values to be extracted and operated on.")),arg("criteria (range)",_t("An array or range containing zero or more criteria to filter the database values by before operating.")),];const DAVERAGE={description:_t("Average of a set of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return AVERAGE.compute.bind(this)([cells]);},isExported:true,};const DCOUNT={description:_t("Counts values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return COUNT.compute.bind(this)([cells]);},isExported:true,};const DCOUNTA={description:_t("Counts values and text from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return COUNTA.compute.bind(this)([cells]);},isExported:true,};const DGET={description:_t("Single value from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);assert(()=>cells.length===1,_t("More than one match found in DGET evaluation."));return cells[0];},isExported:true,};const DMAX={description:_t("Maximum of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return MAX.compute.bind(this)([cells]);},isExported:true,};const DMIN={description:_t("Minimum of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return MIN.compute.bind(this)([cells]);},isExported:true,};const DPRODUCT={description:_t("Product of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return PRODUCT.compute.bind(this)([cells]);},isExported:true,};const DSTDEV={description:_t("Standard deviation of population sample from table."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return STDEV.compute.bind(this)([cells]);},isExported:true,};const DSTDEVP={description:_t("Standard deviation of entire population from table."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return STDEVP.compute.bind(this)([cells]);},isExported:true,};const DSUM={description:_t("Sum of values from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return SUM.compute.bind(this)([cells]);},isExported:true,};const DVAR={description:_t("Variance of population sample from table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return VAR.compute.bind(this)([cells]);},isExported:true,};const DVARP={description:_t("Variance of a population from a table-like range."),args:databaseArgs,returns:["NUMBER"],compute:function(database,field,criteria){const cells=getMatchingCells(database,field,criteria,this.locale);return VARP.compute.bind(this)([cells]);},isExported:true,};var database=Object.freeze({__proto__:null,DAVERAGE:DAVERAGE,DCOUNT:DCOUNT,DCOUNTA:DCOUNTA,DGET:DGET,DMAX:DMAX,DMIN:DMIN,DPRODUCT:DPRODUCT,DSTDEV:DSTDEV,DSTDEVP:DSTDEVP,DSUM:DSUM,DVAR:DVAR,DVARP:DVARP});const DEFAULT_TYPE=1;const DEFAULT_WEEKEND=1;var TIME_UNIT;(function(TIME_UNIT){TIME_UNIT["WHOLE_YEARS"]="Y";TIME_UNIT["WHOLE_MONTHS"]="M";TIME_UNIT["WHOLE_DAYS"]="D";TIME_UNIT["DAYS_WITHOUT_WHOLE_MONTHS"]="MD";TIME_UNIT["MONTH_WITHOUT_WHOLE_YEARS"]="YM";TIME_UNIT["DAYS_BETWEEN_NO_MORE_THAN_ONE_YEAR"]="YD";})(TIME_UNIT||(TIME_UNIT={}));const DATE={description:_t("Converts year/month/day into a date."),args:[arg("year (number)",_t("The year component of the date.")),arg("month (number)",_t("The month component of the date.")),arg("day (number)",_t("The day component of the date.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(year,month,day){let _year=Math.trunc(toNumber(year,this.locale));const _month=Math.trunc(toNumber(month,this.locale));const _day=Math.trunc(toNumber(day,this.locale));assert(()=>0<=_year&&_year<=9999,_t("The year (%s) must be between 0 and 9999 inclusive.",_year.toString()));if(_year<1900){_year+=1900;}
const jsDate=new DateTime(_year,_month-1,_day);const result=jsDateToRoundNumber(jsDate);assert(()=>result>=0,_t("The function [[FUNCTION_NAME]] result must be greater than or equal 01/01/1900."));return result;},isExported:true,};const DATEDIF={description:_t("Calculates the number of days, months, or years between two dates."),args:[arg("start_date (date)",_t("The start date to consider in the calculation. Must be a reference to a cell containing a DATE, a function returning a DATE type, or a number.")),arg("end_date (date)",_t("The end date to consider in the calculation. Must be a reference to a cell containing a DATE, a function returning a DATE type, or a number.")),arg("unit (string)",_t('A text abbreviation for unit of time. Accepted values are "Y" (the number of whole years between start_date and end_date), "M" (the number of whole months between start_date and end_date), "D" (the number of days between start_date and end_date), "MD" (the number of days between start_date and end_date after subtracting whole months), "YM" (the number of whole months between start_date and end_date after subtracting whole years), "YD" (the number of days between start_date and end_date, assuming start_date and end_date were no more than one year apart).')),],returns:["NUMBER"],compute:function(startDate,endDate,unit){const _unit=toString(unit).toUpperCase();assert(()=>Object.values(TIME_UNIT).includes(_unit),expectStringSetError(Object.values(TIME_UNIT),toString(unit)));const _startDate=Math.trunc(toNumber(startDate,this.locale));const _endDate=Math.trunc(toNumber(endDate,this.locale));const jsStartDate=numberToJsDate(_startDate);const jsEndDate=numberToJsDate(_endDate);assert(()=>_endDate>=_startDate,_t("start_date (%s) should be on or before end_date (%s).",jsStartDate.toLocaleDateString(),jsEndDate.toLocaleDateString()));switch(_unit){case TIME_UNIT.WHOLE_YEARS:return getTimeDifferenceInWholeYears(jsStartDate,jsEndDate);case TIME_UNIT.WHOLE_MONTHS:return getTimeDifferenceInWholeMonths(jsStartDate,jsEndDate);case TIME_UNIT.WHOLE_DAYS:{return getTimeDifferenceInWholeDays(jsStartDate,jsEndDate);}
case TIME_UNIT.MONTH_WITHOUT_WHOLE_YEARS:{return(getTimeDifferenceInWholeMonths(jsStartDate,jsEndDate)-
getTimeDifferenceInWholeYears(jsStartDate,jsEndDate)*12);}
case TIME_UNIT.DAYS_WITHOUT_WHOLE_MONTHS:let days=jsEndDate.getDate()-jsStartDate.getDate();if(days<0){const monthBeforeEndMonth=new DateTime(jsEndDate.getFullYear(),jsEndDate.getMonth()-1,1);const daysInMonthBeforeEndMonth=getDaysInMonth(monthBeforeEndMonth);days=daysInMonthBeforeEndMonth-Math.abs(days);}
return days;case TIME_UNIT.DAYS_BETWEEN_NO_MORE_THAN_ONE_YEAR:{if(areTwoDatesWithinOneYear(_startDate,_endDate)){return getTimeDifferenceInWholeDays(jsStartDate,jsEndDate);}
const endDateWithinOneYear=new DateTime(jsStartDate.getFullYear(),jsEndDate.getMonth(),jsEndDate.getDate());let days=getTimeDifferenceInWholeDays(jsStartDate,endDateWithinOneYear);if(days<0){endDateWithinOneYear.setFullYear(jsStartDate.getFullYear()+1);days=getTimeDifferenceInWholeDays(jsStartDate,endDateWithinOneYear);}
return days;}}},isExported:true,};const DATEVALUE={description:_t("Converts a date string to a date value."),args:[arg("date_string (string)",_t("The string representing the date."))],returns:["NUMBER"],compute:function(dateString){const _dateString=toString(dateString);const internalDate=parseDateTime(_dateString,this.locale);assert(()=>internalDate!==null,_t("The date_string (%s) cannot be parsed to date/time.",_dateString.toString()));return Math.trunc(internalDate.value);},isExported:true,};const DAY={description:_t("Day of the month that a specific date falls on."),args:[arg("date (string)",_t("The date from which to extract the day."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getDate();},isExported:true,};const DAYS={description:_t("Number of days between two dates."),args:[arg("end_date (date)",_t("The end of the date range.")),arg("start_date (date)",_t("The start of the date range.")),],returns:["NUMBER"],compute:function(endDate,startDate){const _endDate=toJsDate(endDate,this.locale);const _startDate=toJsDate(startDate,this.locale);const dateDif=_endDate.getTime()-_startDate.getTime();return Math.round(dateDif/MS_PER_DAY);},isExported:true,};const DEFAULT_DAY_COUNT_METHOD=0;const DAYS360={description:_t("Number of days between two dates on a 360-day year (months of 30 days)."),args:[arg("start_date (date)",_t("The start date to consider in the calculation.")),arg("end_date (date)",_t("The end date to consider in the calculation.")),arg(`method (number, default=${DEFAULT_DAY_COUNT_METHOD})`,_t("An indicator of what day count method to use. (0) US NASD method (1) European method")),],returns:["NUMBER"],compute:function(startDate,endDate,method=DEFAULT_DAY_COUNT_METHOD){const _startDate=toNumber(startDate,this.locale);const _endDate=toNumber(endDate,this.locale);const dayCountConvention=toBoolean(method)?4:0;const yearFrac=YEARFRAC.compute.bind(this)(startDate,endDate,dayCountConvention);return Math.sign(_endDate-_startDate)*Math.round(yearFrac*360);},isExported:true,};const EDATE={description:_t("Date a number of months before/after another date."),args:[arg("start_date (date)",_t("The date from which to calculate the result.")),arg("months (number)",_t("The number of months before (negative) or after (positive) 'start_date' to calculate.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,months){const _startDate=toJsDate(startDate,this.locale);const _months=Math.trunc(toNumber(months,this.locale));const jsDate=addMonthsToDate(_startDate,_months,false);return jsDateToRoundNumber(jsDate);},isExported:true,};const EOMONTH={description:_t("Last day of a month before or after a date."),args:[arg("start_date (date)",_t("The date from which to calculate the result.")),arg("months (number)",_t("The number of months before (negative) or after (positive) 'start_date' to consider.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,months){const _startDate=toJsDate(startDate,this.locale);const _months=Math.trunc(toNumber(months,this.locale));const yStart=_startDate.getFullYear();const mStart=_startDate.getMonth();const jsDate=new DateTime(yStart,mStart+_months+1,0);return jsDateToRoundNumber(jsDate);},isExported:true,};const HOUR={description:_t("Hour component of a specific time."),args:[arg("time (date)",_t("The time from which to calculate the hour component."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getHours();},isExported:true,};const ISOWEEKNUM={description:_t("ISO week number of the year."),args:[arg("date (date)",_t("The date for which to determine the ISO week number. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),],returns:["NUMBER"],compute:function(date){const _date=toJsDate(date,this.locale);const y=_date.getFullYear();let firstThursday=1;while(new DateTime(y,0,firstThursday).getDay()!==4){firstThursday+=1;}
const firstDayOfFirstWeek=new DateTime(y,0,firstThursday-3);let lastThursday=31;while(new DateTime(y,11,lastThursday).getDay()!==4){lastThursday-=1;}
const lastDayOfLastWeek=new DateTime(y,11,lastThursday+3);let offsetYear;if(firstDayOfFirstWeek.getTime()<=_date.getTime()){if(_date.getTime()<=lastDayOfLastWeek.getTime()){offsetYear=0;}
else{offsetYear=1;}}
else{offsetYear=-1;}
let firstDay;switch(offsetYear){case 0:firstDay=firstDayOfFirstWeek;break;case 1:firstDay=new DateTime(y,11,lastThursday+3+1);break;case-1:let firstThursdayPreviousYear=1;while(new DateTime(y-1,0,firstThursdayPreviousYear).getDay()!==4){firstThursdayPreviousYear+=1;}
firstDay=new DateTime(y-1,0,firstThursdayPreviousYear-3);break;}
const diff=(_date.getTime()-firstDay.getTime())/MS_PER_DAY;return Math.floor(diff/7)+1;},isExported:true,};const MINUTE={description:_t("Minute component of a specific time."),args:[arg("time (date)",_t("The time from which to calculate the minute component."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getMinutes();},isExported:true,};const MONTH={description:_t("Month of the year a specific date falls in"),args:[arg("date (date)",_t("The date from which to extract the month."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getMonth()+1;},isExported:true,};const NETWORKDAYS={description:_t("Net working days between two provided days."),args:[arg("start_date (date)",_t("The start date of the period from which to calculate the number of net working days.")),arg("end_date (date)",_t("The end date of the period from which to calculate the number of net working days.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the date serial numbers to consider holidays.")),],returns:["NUMBER"],compute:function(startDate,endDate,holidays){return NETWORKDAYS_INTL.compute.bind(this)(startDate,endDate,1,holidays);},isExported:true,};function weekendToDayNumber(weekend){if(typeof weekend==="string"){assert(()=>{if(weekend.length!==7){return false;}
for(let day of weekend){if(day!=="0"&&day!=="1"){return false;}}
return true;},_t('When weekend is a string (%s) it must be composed of "0" or "1".',weekend));let result=[];for(let i=0;i<7;i++){if(weekend[i]==="1"){result.push((i+1)%7);}}
return result;}
if(typeof weekend==="number"){assert(()=>(1<=weekend&&weekend<=7)||(11<=weekend&&weekend<=17),_t("The weekend (%s) must be a string or a number in the range 1-7 or 11-17.",weekend.toString()));if(weekend<=7){return[weekend-2===-1?6:weekend-2,weekend-1];}
return[weekend-11];}
throw Error(_t("The weekend must be a number or a string."));}
const NETWORKDAYS_INTL={description:_t("Net working days between two dates (specifying weekends)."),args:[arg("start_date (date)",_t("The start date of the period from which to calculate the number of net working days.")),arg("end_date (date)",_t("The end date of the period from which to calculate the number of net working days.")),arg(`weekend (any, default=${DEFAULT_WEEKEND})`,_t("A number or string representing which days of the week are considered weekends.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the dates to consider as holidays.")),],returns:["NUMBER"],compute:function(startDate,endDate,weekend=DEFAULT_WEEKEND,holidays){const _startDate=toJsDate(startDate,this.locale);const _endDate=toJsDate(endDate,this.locale);const daysWeekend=weekendToDayNumber(weekend);let timesHoliday=new Set();if(holidays!==undefined){visitAny([holidays],(h)=>{const holiday=toJsDate(h,this.locale);timesHoliday.add(holiday.getTime());});}
const invertDate=_startDate.getTime()>_endDate.getTime();const stopDate=DateTime.fromTimestamp((invertDate?_startDate:_endDate).getTime());let stepDate=DateTime.fromTimestamp((invertDate?_endDate:_startDate).getTime());const timeStopDate=stopDate.getTime();let timeStepDate=stepDate.getTime();let netWorkingDay=0;while(timeStepDate<=timeStopDate){if(!daysWeekend.includes(stepDate.getDay())&&!timesHoliday.has(timeStepDate)){netWorkingDay+=1;}
stepDate.setDate(stepDate.getDate()+1);timeStepDate=stepDate.getTime();}
return invertDate?-netWorkingDay:netWorkingDay;},isExported:true,};const NOW={description:_t("Current date and time as a date value."),args:[],returns:["DATE"],computeFormat:function(){return getDateTimeFormat(this.locale);},compute:function(){let today=DateTime.now();const delta=today.getTime()-INITIAL_1900_DAY.getTime();const time=today.getHours()/24+today.getMinutes()/1440+today.getSeconds()/86400;return Math.floor(delta/MS_PER_DAY)+time;},isExported:true,};const SECOND={description:_t("Minute component of a specific time."),args:[arg("time (date)",_t("The time from which to calculate the second component."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getSeconds();},isExported:true,};const TIME={description:_t("Converts hour/minute/second into a time."),args:[arg("hour (number)",_t("The hour component of the time.")),arg("minute (number)",_t("The minute component of the time.")),arg("second (number)",_t("The second component of the time.")),],returns:["DATE"],computeFormat:function(){return this.locale.timeFormat;},compute:function(hour,minute,second){let _hour=Math.trunc(toNumber(hour,this.locale));let _minute=Math.trunc(toNumber(minute,this.locale));let _second=Math.trunc(toNumber(second,this.locale));_minute+=Math.floor(_second/60);_second=(_second%60)+(_second<0?60:0);_hour+=Math.floor(_minute/60);_minute=(_minute%60)+(_minute<0?60:0);_hour%=24;assert(()=>_hour>=0,_t("The function [[FUNCTION_NAME]] result cannot be negative"));return _hour/24+_minute/(24*60)+_second/(24*60*60);},isExported:true,};const TIMEVALUE={description:_t("Converts a time string into its serial number representation."),args:[arg("time_string (string)",_t("The string that holds the time representation."))],returns:["NUMBER"],compute:function(timeString){const _timeString=toString(timeString);const internalDate=parseDateTime(_timeString,this.locale);assert(()=>internalDate!==null,_t("The time_string (%s) cannot be parsed to date/time.",_timeString));const result=internalDate.value-Math.trunc(internalDate.value);return result<0?1+result:result;},isExported:true,};const TODAY={description:_t("Current date as a date value."),args:[],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(){const today=DateTime.now();const jsDate=new DateTime(today.getFullYear(),today.getMonth(),today.getDate());return jsDateToRoundNumber(jsDate);},isExported:true,};const WEEKDAY={description:_t("Day of the week of the date provided (as number)."),args:[arg("date (date)",_t("The date for which to determine the day of the week. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg(`type (number, default=${DEFAULT_TYPE})`,_t("A number indicating which numbering system to use to represent weekdays. By default, counts starting with Sunday = 1.")),],returns:["NUMBER"],compute:function(date,type=DEFAULT_TYPE){const _date=toJsDate(date,this.locale);const _type=Math.round(toNumber(type,this.locale));const m=_date.getDay();assert(()=>[1,2,3].includes(_type),_t("The type (%s) must be 1, 2 or 3.",_type.toString()));if(_type===1)
return m+1;if(_type===2)
return m===0?7:m;return m===0?6:m-1;},isExported:true,};const WEEKNUM={description:_t("Week number of the year."),args:[arg("date (date)",_t("The date for which to determine the week number. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg(`type (number, default=${DEFAULT_TYPE})`,_t("A number representing the day that a week starts on. Sunday = 1.")),],returns:["NUMBER"],compute:function(date,type=DEFAULT_TYPE){const _date=toJsDate(date,this.locale);const _type=Math.round(toNumber(type,this.locale));assert(()=>_type===1||_type===2||(11<=_type&&_type<=17)||_type===21,_t("The type (%s) is out of range.",_type.toString()));if(_type===21){return ISOWEEKNUM.compute.bind(this)(date);}
let startDayOfWeek;if(_type===1||_type===2){startDayOfWeek=_type-1;}
else{startDayOfWeek=_type-10===7?0:_type-10;}
const y=_date.getFullYear();let dayStart=1;let startDayOfFirstWeek=new DateTime(y,0,dayStart);while(startDayOfFirstWeek.getDay()!==startDayOfWeek){dayStart+=1;startDayOfFirstWeek=new DateTime(y,0,dayStart);}
const dif=(_date.getTime()-startDayOfFirstWeek.getTime())/MS_PER_DAY;if(dif<0){return 1;}
return Math.floor(dif/7)+(dayStart===1?1:2);},isExported:true,};const WORKDAY={description:_t("Date after a number of workdays."),args:[arg("start_date (date)",_t("The date from which to begin counting.")),arg("num_days (number)",_t("The number of working days to advance from start_date. If negative, counts backwards.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the dates to consider holidays.")),],returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,numDays,holidays=undefined){return WORKDAY_INTL.compute.bind(this)(startDate,numDays,1,holidays??null);},isExported:true,};const WORKDAY_INTL={description:_t("Date after a number of workdays (specifying weekends)."),args:[arg("start_date (date)",_t("The date from which to begin counting.")),arg("num_days (number)",_t("The number of working days to advance from start_date. If negative, counts backwards.")),arg(`weekend (any, default=${DEFAULT_WEEKEND})`,_t("A number or string representing which days of the week are considered weekends.")),arg("holidays (date, range<date>, optional)",_t("A range or array constant containing the dates to consider holidays.")),],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(startDate,numDays,weekend=DEFAULT_WEEKEND,holidays){let _startDate=toJsDate(startDate,this.locale);let _numDays=Math.trunc(toNumber(numDays,this.locale));if(typeof weekend==="string"){assert(()=>weekend!=="1111111",_t("The weekend (%s) must be different from '1111111'.",weekend));}
const daysWeekend=weekendToDayNumber(weekend);let timesHoliday=new Set();if(holidays!==undefined){visitAny([holidays],(h)=>{const holiday=toJsDate(h,this.locale);timesHoliday.add(holiday.getTime());});}
let stepDate=DateTime.fromTimestamp(_startDate.getTime());let timeStepDate=stepDate.getTime();const unitDay=Math.sign(_numDays);let stepDay=Math.abs(_numDays);while(stepDay>0){stepDate.setDate(stepDate.getDate()+unitDay);timeStepDate=stepDate.getTime();if(!daysWeekend.includes(stepDate.getDay())&&!timesHoliday.has(timeStepDate)){stepDay-=1;}}
const delta=timeStepDate-INITIAL_1900_DAY.getTime();return Math.round(delta/MS_PER_DAY);},isExported:true,};const YEAR={description:_t("Year specified by a given date."),args:[arg("date (date)",_t("The date from which to extract the year."))],returns:["NUMBER"],compute:function(date){return toJsDate(date,this.locale).getFullYear();},isExported:true,};const DEFAULT_DAY_COUNT_CONVENTION$1=0;const YEARFRAC={description:_t("Exact number of years between two dates."),args:[arg("start_date (date)",_t("The start date to consider in the calculation. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg("end_date (date)",_t("The end date to consider in the calculation. Must be a reference to a cell containing a date, a function returning a date type, or a number.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION$1})`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(startDate,endDate,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION$1){let _startDate=Math.trunc(toNumber(startDate,this.locale));let _endDate=Math.trunc(toNumber(endDate,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assert(()=>_startDate>=0,_t("The start_date (%s) must be positive or null.",_startDate.toString()));assert(()=>_endDate>=0,_t("The end_date (%s) must be positive or null.",_endDate.toString()));assert(()=>0<=_dayCountConvention&&_dayCountConvention<=4,_t("The day_count_convention (%s) must be between 0 and 4 inclusive.",_dayCountConvention.toString()));return getYearFrac(_startDate,_endDate,_dayCountConvention);},};const MONTH_START={description:_t("First day of the month preceding a date."),args:[arg("date (date)",_t("The date from which to calculate the result."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const _startDate=toJsDate(date,this.locale);const yStart=_startDate.getFullYear();const mStart=_startDate.getMonth();const jsDate=new DateTime(yStart,mStart,1);return jsDateToRoundNumber(jsDate);},};const MONTH_END={description:_t("Last day of the month following a date."),args:[arg("date (date)",_t("The date from which to calculate the result."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){return EOMONTH.compute.bind(this)(date,0);},};const QUARTER={description:_t("Quarter of the year a specific date falls in"),args:[arg("date (date)",_t("The date from which to extract the quarter."))],returns:["NUMBER"],compute:function(date){return Math.ceil((toJsDate(date,this.locale).getMonth()+1)/3);},};const QUARTER_START={description:_t("First day of the quarter of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the start of quarter."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const quarter=QUARTER.compute.bind(this)(date);const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year,(quarter-1)*3,1);return jsDateToRoundNumber(jsDate);},};const QUARTER_END={description:_t("Last day of the quarter of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the end of quarter."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const quarter=QUARTER.compute.bind(this)(date);const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year,quarter*3,0);return jsDateToRoundNumber(jsDate);},};const YEAR_START={description:_t("First day of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the start of the year."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year,0,1);return jsDateToRoundNumber(jsDate);},};const YEAR_END={description:_t("Last day of the year a specific date falls in."),args:[arg("date (date)",_t("The date from which to calculate the end of the year."))],returns:["DATE"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date){const year=YEAR.compute.bind(this)(date);const jsDate=new DateTime(year+1,0,0);return jsDateToRoundNumber(jsDate);},};var date=Object.freeze({__proto__:null,DATE:DATE,DATEDIF:DATEDIF,DATEVALUE:DATEVALUE,DAY:DAY,DAYS:DAYS,DAYS360:DAYS360,EDATE:EDATE,EOMONTH:EOMONTH,HOUR:HOUR,ISOWEEKNUM:ISOWEEKNUM,MINUTE:MINUTE,MONTH:MONTH,MONTH_END:MONTH_END,MONTH_START:MONTH_START,NETWORKDAYS:NETWORKDAYS,NETWORKDAYS_INTL:NETWORKDAYS_INTL,NOW:NOW,QUARTER:QUARTER,QUARTER_END:QUARTER_END,QUARTER_START:QUARTER_START,SECOND:SECOND,TIME:TIME,TIMEVALUE:TIMEVALUE,TODAY:TODAY,WEEKDAY:WEEKDAY,WEEKNUM:WEEKNUM,WORKDAY:WORKDAY,WORKDAY_INTL:WORKDAY_INTL,YEAR:YEAR,YEARFRAC:YEARFRAC,YEAR_END:YEAR_END,YEAR_START:YEAR_START});const DEFAULT_DELTA_ARG=0;const DELTA={description:_t("Compare two numeric values, returning 1 if they're equal."),args:[arg("number1 (number)",_t("The first number to compare.")),arg(`number2 (number, default=${DEFAULT_DELTA_ARG})`,_t("The second number to compare.")),],returns:["NUMBER"],compute:function(number1,number2=DEFAULT_DELTA_ARG){const _number1=toNumber(number1,this.locale);const _number2=toNumber(number2,this.locale);return _number1===_number2?1:0;},isExported:true,};var engineering=Object.freeze({__proto__:null,DELTA:DELTA});const SORT_TYPES=[CellValueType.number,CellValueType.error,CellValueType.text,CellValueType.boolean,];function cellsSortingCriterion(sortingOrder){const inverse=sortingOrder==="ascending"?1:-1;return(left,right)=>{if(left.type===CellValueType.empty){return right.type===CellValueType.empty?0:1;}
else if(right.type===CellValueType.empty){return-1;}
let typeOrder=SORT_TYPES.indexOf(left.type)-SORT_TYPES.indexOf(right.type);if(typeOrder===0){if(left.type===CellValueType.text||left.type===CellValueType.error){typeOrder=left.value.localeCompare(right.value);}
else{typeOrder=left.value-right.value;}}
return inverse*typeOrder;};}
function sortCells(cells,sortDirection,emptyCellAsZero){const cellsWithIndex=cells.map((cell,index)=>({index,type:cell.type,value:cell.value,}));const cellsToSort=emptyCellAsZero?cellsWithIndex.map((cell)=>cell.type===CellValueType.empty?{...cell,type:CellValueType.number,value:0}:cell):cellsWithIndex;return cellsToSort.sort(cellsSortingCriterion(sortDirection));}
function interactiveSortSelection(env,sheetId,anchor,zone,sortDirection){let result=DispatchResult.Success;let multiColumns=zone.right>zone.left;if(env.model.getters.doesIntersectMerge(sheetId,zone)){multiColumns=false;let table;for(let row=zone.top;row<=zone.bottom;row++){table=[];for(let col=zone.left;col<=zone.right;col++){let merge=env.model.getters.getMerge({sheetId,col,row});if(merge&&!table.includes(merge.id.toString())){table.push(merge.id.toString());}}
if(table.length>=2){multiColumns=true;break;}}}
const{col,row}=anchor;if(multiColumns){result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection});}
else{const contiguousZone=env.model.getters.getContiguousZone(sheetId,zone);if(isEqual(contiguousZone,zone)){result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection,});}
else{env.askConfirmation(_t("We found data next to your selection. Since this data was not selected, it will not be sorted. Do you want to extend your selection?"),()=>{zone=contiguousZone;result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection,});},()=>{result=env.model.dispatch("SORT_CELLS",{sheetId,col,row,zone,sortDirection,});});}}
if(result.isCancelledBecause("InvalidSortZone")){const{col,row}=anchor;env.model.selection.selectZone({cell:{col,row},zone});env.raiseError(_t("Cannot sort. To sort, select only cells or only merges that have the same size."));}}
function sortMatrix(matrix,locale,...criteria){for(const[i,value]of criteria.entries()){assert(()=>value!==undefined,_t("Value for parameter %d is missing, while the function [[FUNCTION_NAME]] expect a number or a range.",i+1));}
const sortingOrders=[];const sortColumns=[];const nRows=matrix.length;for(let i=0;i<criteria.length;i+=2){sortingOrders.push(toBoolean(toScalar(criteria[i+1])?.value)?"ascending":"descending");const sortColumn=criteria[i];if(isMatrix(sortColumn)&&(sortColumn.length>1||sortColumn[0].length>1)){assert(()=>sortColumn.length===1&&sortColumn[0].length===nRows,_t("Wrong size for %s. Expected a range of size 1x%s. Got %sx%s.",`sort_column${i + 1}`,nRows,sortColumn.length,sortColumn[0].length));sortColumns.push(sortColumn.flat().map((c)=>c.value));}
else{const colIndex=toNumber(toScalar(sortColumn)?.value,locale);if(colIndex<1||colIndex>matrix[0].length){return matrix;}
sortColumns.push(matrix.map((row)=>row[colIndex-1].value));}}
if(sortColumns.length===0){for(let i=0;i<matrix[0].length;i++){sortColumns.push(matrix.map((row)=>row[i].value));sortingOrders.push("ascending");}}
const sortingCriteria={descending:cellsSortingCriterion("descending"),ascending:cellsSortingCriterion("ascending"),};const indexes=range(0,matrix.length);indexes.sort((a,b)=>{for(const[i,sortColumn]of sortColumns.entries()){const left=sortColumn[a];const right=sortColumn[b];const leftCell={value:left,type:left===null?CellValueType.empty:typeof left==="string"?CellValueType.text:typeof left,};const rightCell={value:right,type:right===null?CellValueType.empty:typeof right==="string"?CellValueType.text:typeof right,};const result=sortingCriteria[sortingOrders[i]](leftCell,rightCell);if(result!==0){return result;}}
return 0;});return indexes.map((i)=>matrix[i]);}
const FILTER={description:_t("Returns a filtered version of the source range, returning only rows or columns that meet the specified conditions."),args:[arg("range (any, range<any>)",_t("The data to be filtered.")),arg("condition1 (boolean, range<boolean>)",_t("A column or row containing true or false values corresponding to the first column or row of range.")),arg("condition2 (boolean, range<boolean>, repeating)",_t("Additional column or row containing true or false values.")),],returns:["RANGE<ANY>"],computeValueAndFormat:function(range,...conditions){let _array=toMatrix(range);const _conditionsMatrices=conditions.map((cond)=>matrixMap(toMatrix(cond),(data)=>data.value));_conditionsMatrices.map((c)=>assertSingleColOrRow(_t("The arguments condition must be a single column or row."),c));assertSameDimensions(_t("The arguments conditions must have the same dimensions."),..._conditionsMatrices);const _conditions=_conditionsMatrices.map((c)=>c.flat());const mode=_conditionsMatrices[0].length===1?"row":"col";_array=mode==="row"?transposeMatrix(_array):_array;assert(()=>_conditions.every((cond)=>cond.length===_array.length),_t("FILTER has mismatched sizes on the range and conditions."));const result=[];for(let i=0;i<_array.length;i++){const row=_array[i];if(_conditions.every((c)=>c[i])){result.push(row);}}
if(!result.length){throw new NotAvailableError(_t("No match found in FILTER evaluation"));}
return mode==="row"?transposeMatrix(result):result;},isExported:true,};const SORT={description:_t("Sorts the rows of a given array or range by the values in one or more columns."),args:[arg("range (range)",_t("The data to be sorted.")),arg("sort_column (any, range<number>, repeating)",_t("The index of the column in range or a range outside of range containing the values by which to sort.")),arg("is_ascending (boolean, repeating)",_t("TRUE or FALSE indicating whether to sort sort_column in ascending order. FALSE sorts in descending order.")),],returns:["RANGE"],computeValueAndFormat:function(range,...sortingCriteria){const _range=transposeMatrix(range);return transposeMatrix(sortMatrix(_range,this.locale,...sortingCriteria));},isExported:true,};const SORTN={description:_t("Returns the first n items in a data set after performing a sort."),args:[arg("range (range)",_t("The data to be sorted.")),arg("n (number, default=1)",_t("The number of items to return.")),arg("display_ties_mode (number, default=0)",_t("A number representing the way to display ties.")),arg("sort_column (number, range<number>, repeating)",_t("The index of the column in range or a range outside of range containing the values by which to sort.")),arg("is_ascending (boolean, repeating)",_t("TRUE or FALSE indicating whether to sort sort_column in ascending order. FALSE sorts in descending order.")),],returns:["RANGE"],computeValueAndFormat:function(range,n,displayTiesMode,...sortingCriteria){const _n=toNumber(n?.value??1,this.locale);assert(()=>_n>=0,_t("Wrong value of 'n'. Expected a positive number. Got %s.",_n));const _displayTiesMode=toNumber(displayTiesMode?.value??0,this.locale);assert(()=>_displayTiesMode>=0&&_displayTiesMode<=3,_t("Wrong value of 'display_ties_mode'. Expected a positive number between 0 and 3. Got %s.",_displayTiesMode));const sortedData=sortMatrix(transposeMatrix(range),this.locale,...sortingCriteria);const sameRows=(i,j)=>JSON.stringify(sortedData[i].map((c)=>c.value))===JSON.stringify(sortedData[j].map((c)=>c.value));switch(_displayTiesMode){case 0:return transposeMatrix(sortedData.slice(0,_n));case 1:for(let i=_n;i<sortedData.length;i++){if(!sameRows(i,_n-1)){return transposeMatrix(sortedData.slice(0,i));}}
return transposeMatrix(sortedData);case 2:{const uniques=[sortedData[0]];for(let i=1;i<sortedData.length;i++){for(let j=0;j<i;j++){if(sameRows(i,j)){break;}
if(j===i-1){uniques.push(sortedData[i]);}}}
return transposeMatrix(uniques.slice(0,_n));}
case 3:{const uniques=[sortedData[0]];let counter=1;for(let i=1;i<sortedData.length;i++){if(!sameRows(i,i-1)){counter++;}
if(counter>_n){break;}
uniques.push(sortedData[i]);}
return transposeMatrix(uniques);}}},isExported:true,};const UNIQUE={description:_t("Unique rows in the provided source range."),args:[arg("range (any, range<any>)",_t("The data to filter by unique entries.")),arg("by_column (boolean, default=FALSE)",_t("Whether to filter the data by columns or by rows.")),arg("exactly_once (boolean, default=FALSE)",_t("Whether to return only entries with no duplicates.")),],returns:["RANGE<NUMBER>"],computeValueAndFormat:function(range={value:""},byColumn,exactlyOnce){if(!isMatrix(range)){return[[range]];}
const _byColumn=toBoolean(byColumn?.value)||false;const _exactlyOnce=toBoolean(exactlyOnce?.value)||false;if(!_byColumn){range=transposeMatrix(range);}
const map=new Map();for(const data of range){const key=JSON.stringify(data.map((item)=>item.value));const occurrence=map.get(key);if(!occurrence){map.set(key,{data,count:1});}
else{occurrence.count++;}}
const result=[];for(const row of map.values()){if(_exactlyOnce&&row.count>1){continue;}
result.push(row.data);}
if(!result.length)
throw new Error(_t("No unique values found"));return _byColumn?result:transposeMatrix(result);},isExported:true,};var filter=Object.freeze({__proto__:null,FILTER:FILTER,SORT:SORT,SORTN:SORTN,UNIQUE:UNIQUE});function assertMaturityAndSettlementDatesAreValid(settlement,maturity){assert(()=>settlement<maturity,_t("The maturity (%s) must be strictly greater than the settlement (%s).",maturity.toString(),settlement.toString()));}
function assertSettlementAndIssueDatesAreValid(settlement,issue){assert(()=>issue<settlement,_t("The settlement date (%s) must be strictly greater than the issue date (%s).",settlement.toString(),issue.toString()));}
function assertCouponFrequencyIsValid(frequency){assert(()=>[1,2,4].includes(frequency),_t("The frequency (%s) must be one of %s",frequency.toString(),[1,2,4].toString()));}
function assertDayCountConventionIsValid(dayCountConvention){assert(()=>0<=dayCountConvention&&dayCountConvention<=4,_t("The day_count_convention (%s) must be between 0 and 4 inclusive.",dayCountConvention.toString()));}
function assertRedemptionStrictlyPositive(redemption){assert(()=>redemption>0,_t("The redemption (%s) must be strictly positive.",redemption.toString()));}
function assertPriceStrictlyPositive(price){assert(()=>price>0,_t("The price (%s) must be strictly positive.",price.toString()));}
function assertNumberOfPeriodsStrictlyPositive(nPeriods){assert(()=>nPeriods>0,_t("The number_of_periods (%s) must be greater than 0.",nPeriods.toString()));}
function assertRateStrictlyPositive(rate){assert(()=>rate>0,_t("The rate (%s) must be strictly positive.",rate.toString()));}
function assertLifeStrictlyPositive(life){assert(()=>life>0,_t("The life (%s) must be strictly positive.",life.toString()));}
function assertCostStrictlyPositive(cost){assert(()=>cost>0,_t("The cost (%s) must be strictly positive.",cost.toString()));}
function assertCostPositiveOrZero(cost){assert(()=>cost>=0,_t("The cost (%s) must be positive or null.",cost.toString()));}
function assertPeriodStrictlyPositive(period){assert(()=>period>0,_t("The period (%s) must be strictly positive.",period.toString()));}
function assertPeriodPositiveOrZero(period){assert(()=>period>=0,_t("The period (%s) must be positive or null.",period.toString()));}
function assertSalvagePositiveOrZero(salvage){assert(()=>salvage>=0,_t("The salvage (%s) must be positive or null.",salvage.toString()));}
function assertSalvageSmallerOrEqualThanCost(salvage,cost){assert(()=>salvage<=cost,_t("The salvage (%s) must be smaller or equal than the cost (%s).",salvage.toString(),cost.toString()));}
function assertPresentValueStrictlyPositive(pv){assert(()=>pv>0,_t("The present value (%s) must be strictly positive.",pv.toString()));}
function assertPeriodSmallerOrEqualToLife(period,life){assert(()=>period<=life,_t("The period (%s) must be less than or equal life (%s).",period.toString(),life.toString()));}
function assertInvestmentStrictlyPositive(investment){assert(()=>investment>0,_t("The investment (%s) must be strictly positive.",investment.toString()));}
function assertDiscountStrictlyPositive(discount){assert(()=>discount>0,_t("The discount (%s) must be strictly positive.",discount.toString()));}
function assertDiscountStrictlySmallerThanOne(discount){assert(()=>discount<1,_t("The discount (%s) must be smaller than 1.",discount.toString()));}
function assertDeprecationFactorStrictlyPositive(factor){assert(()=>factor>0,_t("The depreciation factor (%s) must be strictly positive.",factor.toString()));}
function assertSettlementLessThanOneYearBeforeMaturity(settlement,maturity,locale){const startDate=toJsDate(settlement,locale);const endDate=toJsDate(maturity,locale);const startDatePlusOneYear=toJsDate(settlement,locale);startDatePlusOneYear.setFullYear(startDate.getFullYear()+1);assert(()=>endDate.getTime()<=startDatePlusOneYear.getTime(),_t("The settlement date (%s) must at most one year after the maturity date (%s).",settlement.toString(),maturity.toString()));}
function assertFirstAndLastPeriodsAreValid(firstPeriod,lastPeriod,numberOfPeriods){assertNumberOfPeriodsStrictlyPositive(numberOfPeriods);assert(()=>firstPeriod>0,_t("The first_period (%s) must be strictly positive.",firstPeriod.toString()));assert(()=>lastPeriod>0,_t("The last_period (%s) must be strictly positive.",lastPeriod.toString()));assert(()=>firstPeriod<=lastPeriod,_t("The first_period (%s) must be smaller or equal to the last_period (%s).",firstPeriod.toString(),lastPeriod.toString()));assert(()=>lastPeriod<=numberOfPeriods,_t("The last_period (%s) must be smaller or equal to the number_of_periods (%s).",firstPeriod.toString(),numberOfPeriods.toString()));}
function assertStartAndEndPeriodAreValid(startPeriod,endPeriod,life){assertLifeStrictlyPositive(life);assert(()=>startPeriod>=0,_t("The start_period (%s) must be greater or equal than 0.",startPeriod.toString()));assert(()=>endPeriod>=0,_t("The end_period (%s) must be greater or equal than 0.",endPeriod.toString()));assert(()=>startPeriod<=endPeriod,_t("The start_period (%s) must be smaller or equal to the end_period (%s).",startPeriod.toString(),endPeriod.toString()));assert(()=>endPeriod<=life,_t("The end_period (%s) must be smaller or equal to the life (%s).",startPeriod.toString(),life.toString()));}
function assertRateGuessStrictlyGreaterThanMinusOne(guess){assert(()=>guess>-1,_t("The rate_guess (%s) must be strictly greater than -1.",guess.toString()));}
function assertCashFlowsAndDatesHaveSameDimension(cashFlows,dates){assert(()=>cashFlows.length===dates.length&&cashFlows[0].length===dates[0].length,_t("The cashflow_amounts and cashflow_dates ranges must have the same dimensions."));}
function assertCashFlowsHavePositiveAndNegativesValues(cashFlow){assert(()=>cashFlow.some((val)=>val>0)&&cashFlow.some((val)=>val<0),_t("There must be both positive and negative values in cashflow_amounts."));}
function assertEveryDateGreaterThanFirstDateOfCashFlowDates(dates){assert(()=>dates.every((date)=>date>=dates[0]),_t("All the dates should be greater or equal to the first date in cashflow_dates (%s).",dates[0].toString()));}
const DEFAULT_DAY_COUNT_CONVENTION=0;const DEFAULT_END_OR_BEGINNING=0;const DEFAULT_FUTURE_VALUE=0;const COUPON_FUNCTION_ARGS=[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),];function newtonMethod(func,derivFunc,startValue,maxIterations,epsMax=1e-10,nanFallback){let x=startValue;let newX;let xDelta;let y;let yEqual0=false;let count=0;let previousFallback=undefined;do{y=func(x);if(isNaN(y)){assert(()=>count<maxIterations&&nanFallback!==undefined,_t("Function [[FUNCTION_NAME]] didn't find any result."));count++;x=nanFallback(previousFallback);previousFallback=x;continue;}
newX=x-y/derivFunc(x);xDelta=Math.abs(newX-x);x=newX;yEqual0=xDelta<epsMax||Math.abs(y)<epsMax;assert(()=>count<maxIterations,_t("Function [[FUNCTION_NAME]] didn't find any result."));count++;}while(!yEqual0);return x;}
const ACCRINTM={description:_t("Accrued interest of security paying at maturity."),args:[arg("issue (date)",_t("The date the security was initially issued.")),arg("maturity (date)",_t("The maturity date of the security.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(issue,maturity,rate,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(issue,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _redemption=toNumber(redemption,this.locale);const _rate=toNumber(rate,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertSettlementAndIssueDatesAreValid(end,start);assertDayCountConventionIsValid(_dayCountConvention);assertRedemptionStrictlyPositive(_redemption);assertRateStrictlyPositive(_rate);const yearFrac=YEARFRAC.compute.bind(this)(start,end,dayCountConvention);return _redemption*_rate*yearFrac;},isExported:true,};const AMORLINC={description:_t("Depreciation for an accounting period."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("purchase_date (date)",_t("The date the asset was purchased.")),arg("first_period_end (date)",_t("The date the first period ended.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),arg("rate (number)",_t("The deprecation rate.")),arg("day_count_convention (number, optional)",_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(cost,purchaseDate,firstPeriodEnd,salvage,period,rate,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _cost=toNumber(cost,this.locale);const _purchaseDate=Math.trunc(toNumber(purchaseDate,this.locale));const _firstPeriodEnd=Math.trunc(toNumber(firstPeriodEnd,this.locale));const _salvage=toNumber(salvage,this.locale);const _period=toNumber(period,this.locale);const _rate=toNumber(rate,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertCostStrictlyPositive(_cost);assertSalvagePositiveOrZero(_salvage);assertSalvageSmallerOrEqualThanCost(_salvage,_cost);assertPeriodPositiveOrZero(_period);assertRateStrictlyPositive(_rate);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_purchaseDate<=_firstPeriodEnd,_t("The purchase_date (%s) must be before the first_period_end (%s).",_purchaseDate.toString(),_firstPeriodEnd.toString()));const roundedPeriod=_period<1&&_period>0?1:Math.trunc(_period);const deprec=_cost*_rate;const yearFrac=YEARFRAC.compute.bind(this)(_purchaseDate,_firstPeriodEnd,_dayCountConvention);const firstDeprec=_purchaseDate===_firstPeriodEnd?deprec:deprec*yearFrac;const valueAtPeriod=_cost-firstDeprec-deprec*roundedPeriod;if(valueAtPeriod>=_salvage){return roundedPeriod===0?firstDeprec:deprec;}
return _salvage-valueAtPeriod<deprec?deprec-(_salvage-valueAtPeriod):0;},isExported:true,};const COUPDAYS={description:_t("Days in coupon period containing settlement date."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);if(_dayCountConvention===1){const before=COUPPCD.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);const after=COUPNCD.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);return after-before;}
const daysInYear=_dayCountConvention===3?365:360;return daysInYear/_frequency;},isExported:true,};const COUPDAYBS={description:_t("Days from settlement until next coupon."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const couponBeforeStart=COUPPCD.compute.bind(this)(start,end,frequency,dayCountConvention);if([1,2,3].includes(_dayCountConvention)){return start-couponBeforeStart;}
if(_dayCountConvention===4){const yearFrac=getYearFrac(couponBeforeStart,start,_dayCountConvention);return Math.round(yearFrac*360);}
const startDate=toJsDate(start,this.locale);const dateCouponBeforeStart=toJsDate(couponBeforeStart,this.locale);const y1=dateCouponBeforeStart.getFullYear();const y2=startDate.getFullYear();const m1=dateCouponBeforeStart.getMonth()+1;const m2=startDate.getMonth()+1;let d1=dateCouponBeforeStart.getDate();let d2=startDate.getDate();if(m1===2&&m2===2&&isLastDayOfMonth(dateCouponBeforeStart)&&isLastDayOfMonth(startDate)){d2=30;}
if(d2===31&&(d1===30||d1===31)){d2=30;}
if(m1===2&&isLastDayOfMonth(dateCouponBeforeStart)){d1=30;}
if(d1===31){d1=30;}
return(y2-y1)*360+(m2-m1)*30+(d2-d1);},isExported:true,};const COUPDAYSNC={description:_t("Days from settlement until next coupon."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const couponAfterStart=COUPNCD.compute.bind(this)(start,end,frequency,dayCountConvention);if([1,2,3].includes(_dayCountConvention)){return couponAfterStart-start;}
if(_dayCountConvention===4){const yearFrac=getYearFrac(start,couponAfterStart,_dayCountConvention);return Math.round(yearFrac*360);}
const coupDayBs=COUPDAYBS.compute.bind(this)(settlement,maturity,frequency,_dayCountConvention);const coupDays=COUPDAYS.compute.bind(this)(settlement,maturity,frequency,_dayCountConvention);return coupDays-coupDayBs;},isExported:true,};const COUPNCD={description:_t("Next coupon date after the settlement date."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const monthsPerPeriod=12/_frequency;const coupNum=COUPNUM.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);const date=addMonthsToDate(toJsDate(end,this.locale),-(coupNum-1)*monthsPerPeriod,true);return jsDateToRoundNumber(date);},isExported:true,};const COUPNUM={description:_t("Number of coupons between settlement and maturity."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);let num=1;let currentDate=end;const monthsPerPeriod=12/_frequency;while(currentDate>start){currentDate=jsDateToRoundNumber(addMonthsToDate(toJsDate(currentDate,this.locale),-monthsPerPeriod,false));num++;}
return num-1;},isExported:true,};const COUPPCD={description:_t("Last coupon date prior to or on the settlement date."),args:COUPON_FUNCTION_ARGS,returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(settlement,maturity,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);const monthsPerPeriod=12/_frequency;const coupNum=COUPNUM.compute.bind(this)(settlement,maturity,frequency,dayCountConvention);const date=addMonthsToDate(toJsDate(end,this.locale),-coupNum*monthsPerPeriod,true);return jsDateToRoundNumber(date);},isExported:true,};const CUMIPMT={description:_t("Cumulative interest paid over a set of periods."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg("first_period (number)",_t("The number of the payment period to begin the cumulative calculation.")),arg("last_period (number)",_t("The number of the payment period to end the cumulative calculation.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],compute:function(rate,numberOfPeriods,presentValue,firstPeriod,lastPeriod,endOrBeginning=DEFAULT_END_OR_BEGINNING){const first=toNumber(firstPeriod,this.locale);const last=toNumber(lastPeriod,this.locale);const _rate=toNumber(rate,this.locale);const pv=toNumber(presentValue,this.locale);const nOfPeriods=toNumber(numberOfPeriods,this.locale);assertFirstAndLastPeriodsAreValid(first,last,nOfPeriods);assertRateStrictlyPositive(_rate);assertPresentValueStrictlyPositive(pv);let cumSum=0;for(let i=first;i<=last;i++){const impt=IPMT.compute.bind(this)(rate,i,nOfPeriods,presentValue,0,endOrBeginning);cumSum+=impt;}
return cumSum;},isExported:true,};const CUMPRINC={description:_t("Cumulative principal paid over a set of periods."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg("first_period (number)",_t("The number of the payment period to begin the cumulative calculation.")),arg("last_period (number)",_t("The number of the payment period to end the cumulative calculation.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],compute:function(rate,numberOfPeriods,presentValue,firstPeriod,lastPeriod,endOrBeginning=DEFAULT_END_OR_BEGINNING){const first=toNumber(firstPeriod,this.locale);const last=toNumber(lastPeriod,this.locale);const _rate=toNumber(rate,this.locale);const pv=toNumber(presentValue,this.locale);const nOfPeriods=toNumber(numberOfPeriods,this.locale);assertFirstAndLastPeriodsAreValid(first,last,nOfPeriods);assertRateStrictlyPositive(_rate);assertPresentValueStrictlyPositive(pv);let cumSum=0;for(let i=first;i<=last;i++){const ppmt=PPMT.compute.bind(this)(rate,i,nOfPeriods,presentValue,0,endOrBeginning);cumSum+=ppmt;}
return cumSum;},isExported:true,};const DB={description:_t("Depreciation via declining balance method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),arg("month (number, optional)",_t("The number of months in the first year of depreciation.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life,period,...args){const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _period=Math.trunc(toNumber(period,this.locale));const _month=args.length?Math.trunc(toNumber(args[0],this.locale)):12;const lifeLimit=_life+(_month===12?0:1);assertCostPositiveOrZero(_cost);assertSalvagePositiveOrZero(_salvage);assertPeriodStrictlyPositive(_period);assertLifeStrictlyPositive(_life);assert(()=>1<=_month&&_month<=12,_t("The month (%s) must be between 1 and 12 inclusive.",_month.toString()));assert(()=>_period<=lifeLimit,_t("The period (%s) must be less than or equal to %s.",_period.toString(),lifeLimit.toString()));const monthPart=_month/12;let rate=1-Math.pow(_salvage/_cost,1/_life);rate=Math.round(rate*1000)/1000;let before=_cost;let after=_cost*(1-rate*monthPart);for(let i=1;i<_period;i++){before=after;after=before*(1-rate);if(i===_life){after=before*(1-rate*(1-monthPart));}}
return before-after;},isExported:true,};const DEFAULT_DDB_DEPRECIATION_FACTOR=2;const DDB={description:_t("Depreciation via double-declining balance method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),arg(`factor (number, default=${DEFAULT_DDB_DEPRECIATION_FACTOR})`,_t("The factor by which depreciation decreases.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life,period,factor=DEFAULT_DDB_DEPRECIATION_FACTOR){factor=factor||0;const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _period=toNumber(period,this.locale);const _factor=toNumber(factor,this.locale);assertCostPositiveOrZero(_cost);assertSalvagePositiveOrZero(_salvage);assertPeriodStrictlyPositive(_period);assertLifeStrictlyPositive(_life);assertPeriodSmallerOrEqualToLife(_period,_life);assertDeprecationFactorStrictlyPositive(_factor);if(_cost===0||_salvage>=_cost)
return 0;const deprecFactor=_factor/_life;if(deprecFactor>1){return period===1?_cost-_salvage:0;}
if(_period<=1){return _cost*deprecFactor;}
const previousCost=_cost*Math.pow(1-deprecFactor,_period-1);const nextCost=_cost*Math.pow(1-deprecFactor,_period);const deprec=nextCost<_salvage?previousCost-_salvage:previousCost-nextCost;return Math.max(deprec,0);},isExported:true,};const DISC={description:_t("Discount rate of a security based on price."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,price,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _price=toNumber(price,this.locale);const _redemption=toNumber(redemption,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertPriceStrictlyPositive(_price);assertRedemptionStrictlyPositive(_redemption);const yearsFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);return(_redemption-_price)/_redemption/yearsFrac;},isExported:true,};const DOLLARDE={description:_t("Convert a decimal fraction to decimal value."),args:[arg("fractional_price (number)",_t("The price quotation given using fractional decimal conventions.")),arg("unit (number)",_t("The units of the fraction, e.g. 8 for 1/8ths or 32 for 1/32nds.")),],returns:["NUMBER"],compute:function(fractionalPrice,unit){const price=toNumber(fractionalPrice,this.locale);const _unit=Math.trunc(toNumber(unit,this.locale));assert(()=>_unit>0,_t("The unit (%s) must be strictly positive.",_unit.toString()));const truncatedPrice=Math.trunc(price);const priceFractionalPart=price-truncatedPrice;const frac=10**Math.ceil(Math.log10(_unit))/_unit;return truncatedPrice+priceFractionalPart*frac;},isExported:true,};const DOLLARFR={description:_t("Convert a decimal value to decimal fraction."),args:[arg("decimal_price (number)",_t("The price quotation given as a decimal value.")),arg("unit (number)",_t("The units of the desired fraction, e.g. 8 for 1/8ths or 32 for 1/32nds.")),],returns:["NUMBER"],compute:function(decimalPrice,unit){const price=toNumber(decimalPrice,this.locale);const _unit=Math.trunc(toNumber(unit,this.locale));assert(()=>_unit>0,_t("The unit (%s) must be strictly positive.",_unit.toString()));const truncatedPrice=Math.trunc(price);const priceFractionalPart=price-truncatedPrice;const frac=_unit/10**Math.ceil(Math.log10(_unit));return truncatedPrice+priceFractionalPart*frac;},isExported:true,};const DURATION={description:_t("Number of periods for an investment to reach a value."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,securityYield,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const _rate=toNumber(rate,this.locale);const _yield=toNumber(securityYield,this.locale);const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(start,end);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assert(()=>_yield>=0,_t("The yield (%s) must be positive or null.",_yield.toString()));const years=YEARFRAC.compute.bind(this)(start,end,_dayCountConvention);const timeFirstYear=years-Math.trunc(years)||1/_frequency;const nbrCoupons=Math.ceil(years*_frequency);const cashFlowFromCoupon=_rate/_frequency;const yieldPerPeriod=_yield/_frequency;let count=0;let sum=0;for(let i=1;i<=nbrCoupons;i++){const cashFlowPerPeriod=cashFlowFromCoupon+(i===nbrCoupons?1:0);const presentValuePerPeriod=cashFlowPerPeriod/(1+yieldPerPeriod)**i;sum+=(timeFirstYear+(i-1)/_frequency)*presentValuePerPeriod;count+=presentValuePerPeriod;}
return count===0?0:sum/count;},isExported:true,};const EFFECT={description:_t("Annual effective interest rate."),args:[arg("nominal_rate (number)",_t("The nominal interest rate per year.")),arg("periods_per_year (number)",_t("The number of compounding periods per year.")),],returns:["NUMBER"],compute:function(nominal_rate,periods_per_year){const nominal=toNumber(nominal_rate,this.locale);const periods=Math.trunc(toNumber(periods_per_year,this.locale));assert(()=>nominal>0,_t("The nominal rate (%s) must be strictly greater than 0.",nominal.toString()));assert(()=>periods>0,_t("The number of periods by year (%s) must strictly greater than 0.",periods.toString()));return Math.pow(1+nominal/periods,periods)-1;},isExported:true,};const DEFAULT_PRESENT_VALUE=0;const FV={description:_t("Future value of an annuity investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("payment_amount (number)",_t("The amount per period to be paid.")),arg(`present_value (number, default=${DEFAULT_PRESENT_VALUE})`,_t("The current value of the annuity.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,numberOfPeriods,paymentAmount,presentValue=DEFAULT_PRESENT_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){presentValue=presentValue||0;endOrBeginning=endOrBeginning||0;const r=toNumber(rate,this.locale);const n=toNumber(numberOfPeriods,this.locale);const p=toNumber(paymentAmount,this.locale);const pv=toNumber(presentValue,this.locale);const type=toBoolean(endOrBeginning)?1:0;return r?-pv*(1+r)**n-(p*(1+r*type)*((1+r)**n-1))/r:-(pv+p*n);},isExported:true,};const FVSCHEDULE={description:_t("Future value of principal from series of rates."),args:[arg("principal (number)",_t("The amount of initial capital or value to compound against.")),arg("rate_schedule (number, range<number>)",_t("A series of interest rates to compound against the principal.")),],returns:["NUMBER"],compute:function(principalAmount,rateSchedule){const principal=toNumber(principalAmount,this.locale);return reduceAny([rateSchedule],(acc,rate)=>acc*(1+toNumber(rate,this.locale)),principal);},isExported:true,};const INTRATE={description:_t("Calculates effective interest rate."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("investment (number)",_t("The amount invested in the security.")),arg("redemption (number)",_t("The amount to be received at maturity.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,investment,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _redemption=toNumber(redemption,this.locale);const _investment=toNumber(investment,this.locale);assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertInvestmentStrictlyPositive(_investment);assertRedemptionStrictlyPositive(_redemption);const yearFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,dayCountConvention);return(_redemption-_investment)/_investment/yearFrac;},isExported:true,};const IPMT={description:_t("Payment on the principal of an investment."),args:[arg("rate (number)",_t("The annualized rate of interest.")),arg("period (number)",_t("The amortization period, in terms of number of periods.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,currentPeriod,numberOfPeriods,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){const payment=PMT.compute.bind(this)(rate,numberOfPeriods,presentValue,futureValue,endOrBeginning);const ppmt=PPMT.compute.bind(this)(rate,currentPeriod,numberOfPeriods,presentValue,futureValue,endOrBeginning);return payment-ppmt;},isExported:true,};const DEFAULT_RATE_GUESS=0.1;const IRR={description:_t("Internal rate of return given periodic cashflows."),args:[arg("cashflow_amounts (number, range<number>)",_t("An array or range containing the income or payments associated with the investment.")),arg(`rate_guess (number, default=${DEFAULT_RATE_GUESS})`,_t("An estimate for what the internal rate of return will be.")),],returns:["NUMBER"],computeFormat:()=>"0%",compute:function(cashFlowAmounts,rateGuess=DEFAULT_RATE_GUESS){const _rateGuess=toNumber(rateGuess,this.locale);assertRateGuessStrictlyGreaterThanMinusOne(_rateGuess);let positive=false;let negative=false;let amounts=[];visitNumbers([cashFlowAmounts],(amount)=>{if(amount>0)
positive=true;if(amount<0)
negative=true;amounts.push(amount);},this.locale);assert(()=>positive&&negative,_t("The cashflow_amounts must include negative and positive values."));const firstAmount=amounts.shift();function npvNumerator(rate,startValue,values){const nbrValue=values.length;let i=0;return values.reduce((acc,v)=>{i++;return acc+v*rate**(nbrValue-i);},startValue*rate**nbrValue);}
function npvNumeratorDeriv(rate,startValue,values){const nbrValue=values.length;let i=0;return values.reduce((acc,v)=>{i++;return acc+v*(nbrValue-i)*rate**(nbrValue-i-1);},startValue*nbrValue*rate**(nbrValue-1));}
function func(x){return npvNumerator(x,firstAmount,amounts);}
function derivFunc(x){return npvNumeratorDeriv(x,firstAmount,amounts);}
return newtonMethod(func,derivFunc,_rateGuess+1,20,1e-5)-1;},isExported:true,};const ISPMT={description:_t("Returns the interest paid at a particular period of an investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("period (number)",_t("The period for which you want to view the interest payment.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),],returns:["NUMBER"],compute:function(rate,currentPeriod,numberOfPeriods,presentValue){const interestRate=toNumber(rate,this.locale);const period=toNumber(currentPeriod,this.locale);const nOfPeriods=toNumber(numberOfPeriods,this.locale);const investment=toNumber(presentValue,this.locale);assert(()=>nOfPeriods!==0,_t("The number of periods must be different than 0.",nOfPeriods.toString()));const currentInvestment=investment-investment*(period/nOfPeriods);return-1*currentInvestment*interestRate;},isExported:true,};const MDURATION={description:_t("Modified Macaulay duration."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,securityYield,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){const duration=DURATION.compute.bind(this)(settlement,maturity,rate,securityYield,frequency,dayCountConvention);const y=toNumber(securityYield,this.locale);const k=Math.trunc(toNumber(frequency,this.locale));return duration/(1+y/k);},isExported:true,};const MIRR={description:_t("Modified internal rate of return."),args:[arg("cashflow_amounts (range<number>)",_t("A range containing the income or payments associated with the investment. The array should contain bot payments and incomes.")),arg("financing_rate (number)",_t("The interest rate paid on funds invested.")),arg("reinvestment_return_rate (number)",_t("The return (as a percentage) earned on reinvestment of income received from the investment.")),],returns:["NUMBER"],compute:function(cashflowAmount,financingRate,reinvestmentRate){const fRate=toNumber(financingRate,this.locale);const rRate=toNumber(reinvestmentRate,this.locale);const cashFlow=transposeMatrix(cashflowAmount).flat().filter((t)=>t!==null).map((val)=>toNumber(val,this.locale));const n=cashFlow.length;let fv=0;let pv=0;for(const i of range(0,n)){const amount=cashFlow[i];if(amount>=0){fv+=amount*(rRate+1)**(n-i-1);}
else{pv+=amount/(fRate+1)**i;}}
assert(()=>pv!==0&&fv!==0,_t("There must be both positive and negative values in cashflow_amounts."));const exponent=1/(n-1);return(-fv/pv)**exponent-1;},isExported:true,};const NOMINAL={description:_t("Annual nominal interest rate."),args:[arg("effective_rate (number)",_t("The effective interest rate per year.")),arg("periods_per_year (number)",_t("The number of compounding periods per year.")),],returns:["NUMBER"],compute:function(effective_rate,periods_per_year){const effective=toNumber(effective_rate,this.locale);const periods=Math.trunc(toNumber(periods_per_year,this.locale));assert(()=>effective>0,_t("The effective rate (%s) must must strictly greater than 0.",effective.toString()));assert(()=>periods>0,_t("The number of periods by year (%s) must strictly greater than 0.",periods.toString()));return(Math.pow(effective+1,1/periods)-1)*periods;},isExported:true,};const NPER={description:_t("Number of payment periods for an investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("payment_amount (number)",_t("The amount of each payment made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],compute:function(rate,paymentAmount,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const r=toNumber(rate,this.locale);const p=toNumber(paymentAmount,this.locale);const pv=toNumber(presentValue,this.locale);const fv=toNumber(futureValue,this.locale);const t=toBoolean(endOrBeginning)?1:0;if(r===0){return-(fv+pv)/p;}
const c=(p*(1+r*t))/r;return Math.log((c-fv)/(pv+c))/Math.log(1+r);},isExported:true,};function npvResult(r,startValue,values,locale){let i=0;return reduceNumbers(values,(acc,v)=>{i++;return acc+v/(1+r)**i;},startValue,locale);}
const NPV={description:_t("The net present value of an investment based on a series of periodic cash flows and a discount rate."),args:[arg("discount (number)",_t("The discount rate of the investment over one period.")),arg("cashflow1 (number, range<number>)",_t("The first future cash flow.")),arg("cashflow2 (number, range<number>, repeating)",_t("Additional future cash flows.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(discount,...values){const _discount=toNumber(discount,this.locale);assert(()=>_discount!==-1,_t("The discount (%s) must be different from -1.",_discount.toString()));return npvResult(_discount,0,values,this.locale);},isExported:true,};const PDURATION={description:_t("Computes the number of periods needed for an investment to reach a value."),args:[arg("rate (number)",_t("The rate at which the investment grows each period.")),arg("present_value (number)",_t("The investment's current value.")),arg("future_value (number)",_t("The investment's desired future value.")),],returns:["NUMBER"],compute:function(rate,presentValue,futureValue){const _rate=toNumber(rate,this.locale);const _presentValue=toNumber(presentValue,this.locale);const _futureValue=toNumber(futureValue,this.locale);assertRateStrictlyPositive(_rate);assert(()=>_presentValue>0,_t("The present_value (%s) must be strictly positive.",_presentValue.toString()));assert(()=>_futureValue>0,_t("The future_value (%s) must be strictly positive.",_futureValue.toString()));return(Math.log(_futureValue)-Math.log(_presentValue))/Math.log(1+_rate);},isExported:true,};const PMT={description:_t("Periodic payment for an annuity investment."),args:[arg("rate (number)",_t("The annualized rate of interest.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,numberOfPeriods,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const n=toNumber(numberOfPeriods,this.locale);const r=toNumber(rate,this.locale);const t=toBoolean(endOrBeginning)?1:0;let fv=toNumber(futureValue,this.locale);let pv=toNumber(presentValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);if(r===0){return-(fv+pv)/n;}
let payment=-(pv*(1+r)**n+fv);payment=(payment*r)/((1+r*t)*((1+r)**n-1));return payment;},isExported:true,};const PPMT={description:_t("Payment on the principal of an investment."),args:[arg("rate (number)",_t("The annualized rate of interest.")),arg("period (number)",_t("The amortization period, in terms of number of periods.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,currentPeriod,numberOfPeriods,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const n=toNumber(numberOfPeriods,this.locale);const r=toNumber(rate,this.locale);const period=toNumber(currentPeriod,this.locale);const type=toBoolean(endOrBeginning)?1:0;const fv=toNumber(futureValue,this.locale);const pv=toNumber(presentValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);assert(()=>period>0&&period<=n,_t("The period must be between 1 and number_of_periods",n.toString()));const payment=PMT.compute.bind(this)(r,n,pv,fv,endOrBeginning);if(type===1&&period===1)
return payment;const eqPeriod=type===0?period-1:period-2;const eqPv=pv+payment*type;const capitalAtPeriod=-FV.compute.bind(this)(r,eqPeriod,payment,eqPv,0);const currentInterest=capitalAtPeriod*r;return payment+currentInterest;},isExported:true,};const PV={description:_t("Present value of an annuity investment."),args:[arg("rate (number)",_t("The interest rate.")),arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("payment_amount (number)",_t("The amount per period to be paid.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(rate,numberOfPeriods,paymentAmount,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;const r=toNumber(rate,this.locale);const n=toNumber(numberOfPeriods,this.locale);const p=toNumber(paymentAmount,this.locale);const fv=toNumber(futureValue,this.locale);const type=toBoolean(endOrBeginning)?1:0;return r?-((p*(1+r*type)*((1+r)**n-1))/r+fv)/(1+r)**n:-(fv+p*n);},isExported:true,};const PRICE={description:_t("Price of a security paying periodic interest."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,securityYield,redemption,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _rate=toNumber(rate,this.locale);const _yield=toNumber(securityYield,this.locale);const _redemption=toNumber(redemption,this.locale);const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assert(()=>_yield>=0,_t("The yield (%s) must be positive or null.",_yield.toString()));assertRedemptionStrictlyPositive(_redemption);const years=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);const nbrRealCoupons=years*_frequency;const nbrFullCoupons=Math.ceil(nbrRealCoupons);const timeFirstCoupon=nbrRealCoupons-Math.floor(nbrRealCoupons)||1;const yieldFactorPerPeriod=1+_yield/_frequency;const cashFlowFromCoupon=(100*_rate)/_frequency;if(nbrFullCoupons===1){return((cashFlowFromCoupon+_redemption)/((timeFirstCoupon*_yield)/_frequency+1)-
cashFlowFromCoupon*(1-timeFirstCoupon));}
let cashFlowsPresentValue=0;for(let i=1;i<=nbrFullCoupons;i++){cashFlowsPresentValue+=cashFlowFromCoupon/yieldFactorPerPeriod**(i-1+timeFirstCoupon);}
const redemptionPresentValue=_redemption/yieldFactorPerPeriod**(nbrFullCoupons-1+timeFirstCoupon);return(redemptionPresentValue+cashFlowsPresentValue-cashFlowFromCoupon*(1-timeFirstCoupon));},isExported:true,};const PRICEDISC={description:_t("Price of a discount security."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("discount (number)",_t("The discount rate of the security at time of purchase.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,discount,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _discount=toNumber(discount,this.locale);const _redemption=toNumber(redemption,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertDiscountStrictlyPositive(_discount);assertRedemptionStrictlyPositive(_redemption);const yearsFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);return _redemption-_discount*_redemption*yearsFrac;},isExported:true,};const PRICEMAT={description:_t("Calculates the price of a security paying interest at maturity, based on expected yield."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("issue (date)",_t("The date the security was initially issued.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("yield (number)",_t("The expected annual yield of the security.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,issue,rate,securityYield,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _issue=Math.trunc(toNumber(issue,this.locale));const _rate=toNumber(rate,this.locale);const _yield=toNumber(securityYield,this.locale);const _dayCount=Math.trunc(toNumber(dayCountConvention,this.locale));assertSettlementAndIssueDatesAreValid(_settlement,_issue);assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCount);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assert(()=>_yield>=0,_t("The yield (%s) must be positive or null.",_yield.toString()));const settlementToMaturity=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCount);const issueToSettlement=YEARFRAC.compute.bind(this)(_settlement,_issue,_dayCount);const issueToMaturity=YEARFRAC.compute.bind(this)(_issue,_maturity,_dayCount);const numerator=100+issueToMaturity*_rate*100;const denominator=1+settlementToMaturity*_yield;const term2=issueToSettlement*_rate*100;return numerator/denominator-term2;},isExported:true,};const RATE_GUESS_DEFAULT=0.1;const RATE={description:_t("Interest rate of an annuity investment."),args:[arg("number_of_periods (number)",_t("The number of payments to be made.")),arg("payment_per_period (number)",_t("The amount per period to be paid.")),arg("present_value (number)",_t("The current value of the annuity.")),arg(`future_value (number, default=${DEFAULT_FUTURE_VALUE})`,_t("The future value remaining after the final payment has been made.")),arg(`end_or_beginning (number, default=${DEFAULT_END_OR_BEGINNING})`,_t("Whether payments are due at the end (0) or beginning (1) of each period.")),arg(`rate_guess (number, default=${RATE_GUESS_DEFAULT})`,_t("An estimate for what the interest rate will be.")),],returns:["NUMBER"],computeFormat:()=>"0%",compute:function(numberOfPeriods,paymentPerPeriod,presentValue,futureValue=DEFAULT_FUTURE_VALUE,endOrBeginning=DEFAULT_END_OR_BEGINNING,rateGuess=RATE_GUESS_DEFAULT){futureValue=futureValue||0;endOrBeginning=endOrBeginning||0;rateGuess=rateGuess||RATE_GUESS_DEFAULT;const n=toNumber(numberOfPeriods,this.locale);const payment=toNumber(paymentPerPeriod,this.locale);const type=toBoolean(endOrBeginning)?1:0;const guess=toNumber(rateGuess,this.locale);let fv=toNumber(futureValue,this.locale);let pv=toNumber(presentValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);assert(()=>[payment,pv,fv].some((val)=>val>0)&&[payment,pv,fv].some((val)=>val<0),_t("There must be both positive and negative values in [payment_amount, present_value, future_value].",n.toString()));assertRateGuessStrictlyGreaterThanMinusOne(guess);fv-=payment*type;pv+=payment*type;const func=(rate)=>{const powN=Math.pow(1+rate,n);const intResult=(powN-1)/rate;return fv+pv*powN+payment*intResult;};const derivFunc=(rate)=>{const powNMinus1=Math.pow(1+rate,n-1);const powN=Math.pow(1+rate,n);const intResult=(powN-1)/rate;const intResultDeriv=(n*powNMinus1)/rate-intResult/rate;const fTermDerivation=pv*n*powNMinus1+payment*intResultDeriv;return fTermDerivation;};return newtonMethod(func,derivFunc,guess,40,1e-5);},isExported:true,};const RECEIVED={description:_t("Amount received at maturity for a security."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("investment (number)",_t("The amount invested (irrespective of face value of each security).")),arg("discount (number)",_t("The discount rate of the security invested in.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,investment,discount,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _investment=toNumber(investment,this.locale);const _discount=toNumber(discount,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertInvestmentStrictlyPositive(_investment);assertDiscountStrictlyPositive(_discount);const yearsFrac=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);return _investment/(1-_discount*yearsFrac);},isExported:true,};const RRI={description:_t("Computes the rate needed for an investment to reach a specific value within a specific number of periods."),args:[arg("number_of_periods (number)",_t("The number of periods.")),arg("present_value (number)",_t("The present value of the investment.")),arg("future_value (number)",_t("The future value of the investment.")),],returns:["NUMBER"],compute:function(numberOfPeriods,presentValue,futureValue){const n=toNumber(numberOfPeriods,this.locale);const pv=toNumber(presentValue,this.locale);const fv=toNumber(futureValue,this.locale);assertNumberOfPeriodsStrictlyPositive(n);return(fv/pv)**(1/n)-1;},isExported:true,};const SLN={description:_t("Depreciation of an asset using the straight-line method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life){const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);return(_cost-_salvage)/_life;},isExported:true,};const SYD={description:_t("Depreciation via sum of years digit method."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("period (number)",_t("The single period within life for which to calculate depreciation.")),],returns:["NUMBER"],computeFormat:()=>"#,##0.00",compute:function(cost,salvage,life,period){const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _period=toNumber(period,this.locale);assertPeriodStrictlyPositive(_period);assertLifeStrictlyPositive(_life);assertPeriodSmallerOrEqualToLife(_period,_life);const deprecFactor=(_life*(_life+1))/2;const remainingPeriods=_life-_period+1;return(_cost-_salvage)*(remainingPeriods/deprecFactor);},isExported:true,};const TBILLPRICE={description:_t("Price of a US Treasury bill."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("discount (number)",_t("The discount rate of the bill at time of purchase.")),],returns:["NUMBER"],compute:function(settlement,maturity,discount){const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const disc=toNumber(discount,this.locale);assertMaturityAndSettlementDatesAreValid(start,end);assertSettlementLessThanOneYearBeforeMaturity(start,end,this.locale);assertDiscountStrictlyPositive(disc);assertDiscountStrictlySmallerThanOne(disc);const yearFrac=YEARFRAC.compute.bind(this)(start,end,2);return 100*(1-disc*yearFrac);},isExported:true,};const TBILLEQ={description:_t("Equivalent rate of return for a US Treasury bill."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("discount (number)",_t("The discount rate of the bill at time of purchase.")),],returns:["NUMBER"],compute:function(settlement,maturity,discount){const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const disc=toNumber(discount,this.locale);assertMaturityAndSettlementDatesAreValid(start,end);assertSettlementLessThanOneYearBeforeMaturity(start,end,this.locale);assertDiscountStrictlyPositive(disc);assertDiscountStrictlySmallerThanOne(disc);const nDays=DAYS.compute.bind(this)(end,start);if(nDays<=182){return(365*disc)/(360-disc*nDays);}
const p=TBILLPRICE.compute.bind(this)(start,end,disc)/100;const daysInYear=nDays===366?366:365;const x=nDays/daysInYear;const num=-2*x+2*Math.sqrt(x**2-(2*x-1)*(1-1/p));const denom=2*x-1;return num/denom;},isExported:true,};const TBILLYIELD={description:_t("The yield of a US Treasury bill based on price."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),],returns:["NUMBER"],compute:function(settlement,maturity,price){const start=Math.trunc(toNumber(settlement,this.locale));const end=Math.trunc(toNumber(maturity,this.locale));const p=toNumber(price,this.locale);assertMaturityAndSettlementDatesAreValid(start,end);assertSettlementLessThanOneYearBeforeMaturity(start,end,this.locale);assertPriceStrictlyPositive(p);const yearFrac=YEARFRAC.compute.bind(this)(start,end,2);return((100-p)/p)*(1/yearFrac);},isExported:true,};const DEFAULT_VDB_NO_SWITCH=false;const VDB={description:_t("Variable declining balance. WARNING : does not handle decimal periods."),args:[arg("cost (number)",_t("The initial cost of the asset.")),arg("salvage (number)",_t("The value of the asset at the end of depreciation.")),arg("life (number)",_t("The number of periods over which the asset is depreciated.")),arg("start (number)",_t("Starting period to calculate depreciation.")),arg("end (number)",_t("Ending period to calculate depreciation.")),arg(`factor (number, default=${DEFAULT_DDB_DEPRECIATION_FACTOR})`,_t("The number of months in the first year of depreciation.")),arg(`no_switch (number, default=${DEFAULT_VDB_NO_SWITCH})`,_t("Whether to switch to straight-line depreciation when the depreciation is greater than the declining balance calculation.")),],returns:["NUMBER"],compute:function(cost,salvage,life,startPeriod,endPeriod,factor=DEFAULT_DDB_DEPRECIATION_FACTOR,noSwitch=DEFAULT_VDB_NO_SWITCH){factor=factor||0;const _cost=toNumber(cost,this.locale);const _salvage=toNumber(salvage,this.locale);const _life=toNumber(life,this.locale);const _startPeriod=Math.trunc(toNumber(startPeriod,this.locale));const _endPeriod=Math.trunc(toNumber(endPeriod,this.locale));const _factor=toNumber(factor,this.locale);const _noSwitch=toBoolean(noSwitch);assertCostPositiveOrZero(_cost);assertSalvagePositiveOrZero(_salvage);assertStartAndEndPeriodAreValid(_startPeriod,_endPeriod,_life);assertDeprecationFactorStrictlyPositive(_factor);if(_cost===0)
return 0;if(_salvage>=_cost){return _startPeriod<1?_cost-_salvage:0;}
const doubleDeprecFactor=_factor/_life;if(doubleDeprecFactor>=1){return _startPeriod<1?_cost-_salvage:0;}
let previousCost=_cost;let currentDeprec=0;let resultDeprec=0;let isLinearDeprec=false;for(let i=0;i<_endPeriod;i++){if(!isLinearDeprec||_noSwitch){const doubleDeprec=previousCost*doubleDeprecFactor;const remainingPeriods=_life-i;const linearDeprec=(previousCost-_salvage)/remainingPeriods;if(!_noSwitch&&linearDeprec>doubleDeprec){isLinearDeprec=true;currentDeprec=linearDeprec;}
else{currentDeprec=doubleDeprec;}}
const nextCost=Math.max(previousCost-currentDeprec,_salvage);if(i>=_startPeriod){resultDeprec+=previousCost-nextCost;}
previousCost=nextCost;}
return resultDeprec;},isExported:true,};const XIRR={description:_t("Internal rate of return given non-periodic cash flows."),args:[arg("cashflow_amounts (range<number>)",_t("An range containing the income or payments associated with the investment.")),arg("cashflow_dates (range<number>)",_t("An range with dates corresponding to the cash flows in cashflow_amounts.")),arg(`rate_guess (number, default=${RATE_GUESS_DEFAULT})`,_t("An estimate for what the internal rate of return will be.")),],returns:["NUMBER"],compute:function(cashflowAmounts,cashflowDates,rateGuess=RATE_GUESS_DEFAULT){rateGuess=rateGuess||0;const guess=toNumber(rateGuess,this.locale);const _cashFlows=cashflowAmounts.flat().map((val)=>toNumber(val,this.locale));const _dates=cashflowDates.flat().map((val)=>toNumber(val,this.locale));assertCashFlowsAndDatesHaveSameDimension(cashflowAmounts,cashflowDates);assertCashFlowsHavePositiveAndNegativesValues(_cashFlows);assertEveryDateGreaterThanFirstDateOfCashFlowDates(_dates);assertRateGuessStrictlyGreaterThanMinusOne(guess);const map=new Map();for(const i of range(0,_dates.length)){const date=_dates[i];if(map.has(date))
map.set(date,map.get(date)+_cashFlows[i]);else
map.set(date,_cashFlows[i]);}
const dates=Array.from(map.keys());const values=dates.map((date)=>map.get(date));const func=(rate)=>{let value=values[0];for(const i of range(1,values.length)){const dateDiff=(dates[0]-dates[i])/365;value+=values[i]*(1+rate)**dateDiff;}
return value;};const derivFunc=(rate)=>{let deriv=0;for(const i of range(1,values.length)){const dateDiff=(dates[0]-dates[i])/365;deriv+=dateDiff*values[i]*(1+rate)**(dateDiff-1);}
return deriv;};const nanFallback=(previousFallback)=>{if(!previousFallback)
return-0.9;return previousFallback/10-0.9;};return newtonMethod(func,derivFunc,guess,40,1e-5,nanFallback);},isExported:true,};const XNPV={description:_t("Net present value given to non-periodic cash flows.."),args:[arg("discount (number)",_t("The discount rate of the investment over one period.")),arg("cashflow_amounts (number, range<number>)",_t("An range containing the income or payments associated with the investment.")),arg("cashflow_dates (number, range<number>)",_t("An range with dates corresponding to the cash flows in cashflow_amounts.")),],returns:["NUMBER"],compute:function(discount,cashflowAmounts,cashflowDates){const rate=toNumber(discount,this.locale);const _cashFlows=isMatrix(cashflowAmounts)?cashflowAmounts.flat().map((val)=>strictToNumber(val,this.locale)):[strictToNumber(cashflowAmounts,this.locale)];const _dates=isMatrix(cashflowDates)?cashflowDates.flat().map((val)=>strictToNumber(val,this.locale)):[strictToNumber(cashflowDates,this.locale)];if(isMatrix(cashflowDates)&&isMatrix(cashflowAmounts)){assertCashFlowsAndDatesHaveSameDimension(cashflowAmounts,cashflowDates);}
else{assert(()=>_cashFlows.length===_dates.length,_t("There must be the same number of values in cashflow_amounts and cashflow_dates."));}
assertEveryDateGreaterThanFirstDateOfCashFlowDates(_dates);assertRateStrictlyPositive(rate);if(_cashFlows.length===1)
return _cashFlows[0];const map=new Map();for(const i of range(0,_dates.length)){const date=_dates[i];if(map.has(date))
map.set(date,map.get(date)+_cashFlows[i]);else
map.set(date,_cashFlows[i]);}
const dates=Array.from(map.keys());const values=dates.map((date)=>map.get(date));let pv=values[0];for(const i of range(1,values.length)){const dateDiff=(dates[0]-dates[i])/365;pv+=values[i]*(1+rate)**dateDiff;}
return pv;},isExported:true,};const YIELD={description:_t("Annual yield of a security paying periodic interest."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg("frequency (number)",_t("The number of interest or coupon payments per year (1, 2, or 4).")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,rate,price,redemption,frequency,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _rate=toNumber(rate,this.locale);const _price=toNumber(price,this.locale);const _redemption=toNumber(redemption,this.locale);const _frequency=Math.trunc(toNumber(frequency,this.locale));const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertCouponFrequencyIsValid(_frequency);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assertPriceStrictlyPositive(_price);assertRedemptionStrictlyPositive(_redemption);const years=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);const nbrRealCoupons=years*_frequency;const nbrFullCoupons=Math.ceil(nbrRealCoupons);const timeFirstCoupon=nbrRealCoupons-Math.floor(nbrRealCoupons)||1;const cashFlowFromCoupon=(100*_rate)/_frequency;if(nbrFullCoupons===1){const subPart=_price+cashFlowFromCoupon*(1-timeFirstCoupon);return(((_redemption+cashFlowFromCoupon-subPart)*_frequency*(1/timeFirstCoupon))/subPart);}
function priceNumerator(price,timeFirstCoupon,nbrFullCoupons,yieldFactorPerPeriod,cashFlowFromCoupon,redemption){let result=redemption-
(price+cashFlowFromCoupon*(1-timeFirstCoupon))*yieldFactorPerPeriod**(nbrFullCoupons-1+timeFirstCoupon);for(let i=1;i<=nbrFullCoupons;i++){result+=cashFlowFromCoupon*yieldFactorPerPeriod**(i-1);}
return result;}
function priceNumeratorDeriv(price,timeFirstCoupon,nbrFullCoupons,yieldFactorPerPeriod,cashFlowFromCoupon){let result=-(price+cashFlowFromCoupon*(1-timeFirstCoupon))*(nbrFullCoupons-1+timeFirstCoupon)*yieldFactorPerPeriod**(nbrFullCoupons-2+timeFirstCoupon);for(let i=1;i<=nbrFullCoupons;i++){result+=cashFlowFromCoupon*(i-1)*yieldFactorPerPeriod**(i-2);}
return result;}
function func(x){return priceNumerator(_price,timeFirstCoupon,nbrFullCoupons,x,cashFlowFromCoupon,_redemption);}
function derivFunc(x){return priceNumeratorDeriv(_price,timeFirstCoupon,nbrFullCoupons,x,cashFlowFromCoupon);}
const initYield=_rate+1;const initYieldFactorPerPeriod=1+initYield/_frequency;const methodResult=newtonMethod(func,derivFunc,initYieldFactorPerPeriod,100,1e-5);return(methodResult-1)*_frequency;},isExported:true,};const YIELDDISC={description:_t("Annual yield of a discount security."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("price (number)",_t("The price at which the security is bought per 100 face value.")),arg("redemption (number)",_t("The redemption amount per 100 face value, or par.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,price,redemption,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _price=toNumber(price,this.locale);const _redemption=toNumber(redemption,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assertPriceStrictlyPositive(_price);assertRedemptionStrictlyPositive(_redemption);const yearFrac=YEARFRAC.compute.bind(this)(settlement,maturity,dayCountConvention);return(_redemption/_price-1)/yearFrac;},isExported:true,};const YIELDMAT={description:_t("Annual yield of a security paying interest at maturity."),args:[arg("settlement (date)",_t("The settlement date of the security, the date after issuance when the security is delivered to the buyer.")),arg("maturity (date)",_t("The maturity or end date of the security, when it can be redeemed at face, or par value.")),arg("issue (date)",_t("The date the security was initially issued.")),arg("rate (number)",_t("The annualized rate of interest.")),arg("price (number)",_t("The price at which the security is bought.")),arg(`day_count_convention (number, default=${DEFAULT_DAY_COUNT_CONVENTION} )`,_t("An indicator of what day count method to use.")),],returns:["NUMBER"],compute:function(settlement,maturity,issue,rate,price,dayCountConvention=DEFAULT_DAY_COUNT_CONVENTION){dayCountConvention=dayCountConvention||0;const _settlement=Math.trunc(toNumber(settlement,this.locale));const _maturity=Math.trunc(toNumber(maturity,this.locale));const _issue=Math.trunc(toNumber(issue,this.locale));const _rate=toNumber(rate,this.locale);const _price=toNumber(price,this.locale);const _dayCountConvention=Math.trunc(toNumber(dayCountConvention,this.locale));assertMaturityAndSettlementDatesAreValid(_settlement,_maturity);assertDayCountConventionIsValid(_dayCountConvention);assert(()=>_settlement>=_issue,_t("The settlement (%s) must be greater than or equal to the issue (%s).",_settlement.toString(),_issue.toString()));assert(()=>_rate>=0,_t("The rate (%s) must be positive or null.",_rate.toString()));assertPriceStrictlyPositive(_price);const issueToMaturity=YEARFRAC.compute.bind(this)(_issue,_maturity,_dayCountConvention);const issueToSettlement=YEARFRAC.compute.bind(this)(_issue,_settlement,_dayCountConvention);const settlementToMaturity=YEARFRAC.compute.bind(this)(_settlement,_maturity,_dayCountConvention);const numerator=(100*(1+_rate*issueToMaturity))/(_price+100*_rate*issueToSettlement)-1;return numerator/settlementToMaturity;},isExported:true,};var financial=Object.freeze({__proto__:null,ACCRINTM:ACCRINTM,AMORLINC:AMORLINC,COUPDAYBS:COUPDAYBS,COUPDAYS:COUPDAYS,COUPDAYSNC:COUPDAYSNC,COUPNCD:COUPNCD,COUPNUM:COUPNUM,COUPPCD:COUPPCD,CUMIPMT:CUMIPMT,CUMPRINC:CUMPRINC,DB:DB,DDB:DDB,DISC:DISC,DOLLARDE:DOLLARDE,DOLLARFR:DOLLARFR,DURATION:DURATION,EFFECT:EFFECT,FV:FV,FVSCHEDULE:FVSCHEDULE,INTRATE:INTRATE,IPMT:IPMT,IRR:IRR,ISPMT:ISPMT,MDURATION:MDURATION,MIRR:MIRR,NOMINAL:NOMINAL,NPER:NPER,NPV:NPV,PDURATION:PDURATION,PMT:PMT,PPMT:PPMT,PRICE:PRICE,PRICEDISC:PRICEDISC,PRICEMAT:PRICEMAT,PV:PV,RATE:RATE,RECEIVED:RECEIVED,RRI:RRI,SLN:SLN,SYD:SYD,TBILLEQ:TBILLEQ,TBILLPRICE:TBILLPRICE,TBILLYIELD:TBILLYIELD,VDB:VDB,XIRR:XIRR,XNPV:XNPV,YIELD:YIELD,YIELDDISC:YIELDDISC,YIELDMAT:YIELDMAT});const ISERR={description:_t("Whether a value is an error other than #N/A."),args:[arg("value (any, lazy)",_t("The value to be verified as an error type."))],returns:["BOOLEAN"],compute:function(value){try{value();return false;}
catch(e){return e?.errorType!=CellErrorType.NotAvailable;}},isExported:true,};const ISERROR={description:_t("Whether a value is an error."),args:[arg("value (any, lazy)",_t("The value to be verified as an error type."))],returns:["BOOLEAN"],compute:function(value){try{value();return false;}
catch(e){return true;}},isExported:true,};const ISLOGICAL={description:_t("Whether a value is `true` or `false`."),args:[arg("value (any, lazy)",_t("The value to be verified as a logical TRUE or FALSE."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()==="boolean";}
catch(e){return false;}},isExported:true,};const ISNA={description:_t("Whether a value is the error #N/A."),args:[arg("value (any, lazy)",_t("The value to be verified as an error type."))],returns:["BOOLEAN"],compute:function(value){try{value();return false;}
catch(e){return e?.errorType===CellErrorType.NotAvailable;}},isExported:true,};const ISNONTEXT={description:_t("Whether a value is non-textual."),args:[arg("value (any, lazy)",_t("The value to be checked."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()!=="string";}
catch(e){return true;}},isExported:true,};const ISNUMBER={description:_t("Whether a value is a number."),args:[arg("value (any, lazy)",_t("The value to be verified as a number."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()==="number";}
catch(e){return false;}},isExported:true,};const ISTEXT={description:_t("Whether a value is text."),args:[arg("value (any, lazy)",_t("The value to be verified as text."))],returns:["BOOLEAN"],compute:function(value){try{return typeof value()==="string";}
catch(e){return false;}},isExported:true,};const ISBLANK={description:_t("Whether the referenced cell is empty"),args:[arg("value (any, lazy)",_t("Reference to the cell that will be checked for emptiness."))],returns:["BOOLEAN"],compute:function(value){try{const val=value();return val===null;}
catch(e){return false;}},isExported:true,};const NA={description:_t("Returns the error value #N/A."),args:[],returns:["BOOLEAN"],compute:function(value){throw new NotAvailableError();},isExported:true,};var info=Object.freeze({__proto__:null,ISBLANK:ISBLANK,ISERR:ISERR,ISERROR:ISERROR,ISLOGICAL:ISLOGICAL,ISNA:ISNA,ISNONTEXT:ISNONTEXT,ISNUMBER:ISNUMBER,ISTEXT:ISTEXT,NA:NA});const AND={description:_t("Logical `and` operator."),args:[arg("logical_expression1 (boolean, range<boolean>)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE, or an expression that can be coerced to a logical value.")),arg("logical_expression2 (boolean, range<boolean>, repeating)",_t("More expressions that represent logical values.")),],returns:["BOOLEAN"],compute:function(...logicalExpressions){let foundBoolean=false;let acc=true;conditionalVisitBoolean(logicalExpressions,(arg)=>{foundBoolean=true;acc=acc&&arg;return acc;});assert(()=>foundBoolean,_t("[[FUNCTION_NAME]] has no valid input data."));return acc;},isExported:true,};const FALSE={description:_t("Logical value `false`."),args:[],returns:["BOOLEAN"],compute:function(){return false;},isExported:true,};const IF={description:_t("Returns value depending on logical expression."),args:[arg("logical_expression (boolean)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE.")),arg("value_if_true (any, lazy)",_t("The value the function returns if logical_expression is TRUE.")),arg("value_if_false (any, lazy, default=FALSE)",_t("The value the function returns if logical_expression is FALSE.")),],returns:["ANY"],computeValueAndFormat:function(logicalExpression,valueIfTrue,valueIfFalse=()=>({value:false})){const result=toBoolean(logicalExpression?.value)?valueIfTrue():valueIfFalse();if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;},isExported:true,};const IFERROR={description:_t("Value if it is not an error, otherwise 2nd argument."),args:[arg("value (any, lazy)",_t("The value to return if value itself is not an error.")),arg(`value_if_error (any, lazy, default="empty")`,_t("The value the function returns if value is an error.")),],returns:["ANY"],computeValueAndFormat:function(value,valueIfError=()=>({value:""})){let result;try{result=value();}
catch(e){result=valueIfError();}
if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;},isExported:true,};const IFNA={description:_t("Value if it is not an #N/A error, otherwise 2nd argument."),args:[arg("value (any, lazy)",_t("The value to return if value itself is not #N/A an error.")),arg(`value_if_error (any, lazy, default="empty")`,_t("The value the function returns if value is an #N/A error.")),],returns:["ANY"],computeValueAndFormat:function(value,valueIfError=()=>({value:""})){let result;try{result=value();}
catch(e){if(e.errorType===CellErrorType.NotAvailable){result=valueIfError();}
else{result=value();}}
if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;},isExported:true,};const IFS={description:_t("Returns a value depending on multiple logical expressions."),args:[arg("condition1 (boolean, lazy)",_t("The first condition to be evaluated. This can be a boolean, a number, an array, or a reference to any of those.")),arg("value1 (any, lazy)",_t("The returned value if condition1 is TRUE.")),arg("condition2 (boolean, lazy, repeating)",_t("Additional conditions to be evaluated if the previous ones are FALSE.")),arg("value2 (any, lazy, repeating)",_t("Additional values to be returned if their corresponding conditions are TRUE.")),],returns:["ANY"],computeValueAndFormat:function(...values){assert(()=>values.length%2===0,_t("Wrong number of arguments. Expected an even number of arguments."));for(let n=0;n<values.length-1;n+=2){if(toBoolean(values[n]()?.value)){const result=values[n+1]();if(result===undefined){return{value:""};}
if(result.value===null){result.value="";}
return result;}}
throw new Error(_t("No match."));},isExported:true,};const NOT={description:_t("Returns opposite of provided logical value."),args:[arg("logical_expression (boolean)",_t("An expression or reference to a cell holding an expression that represents some logical value.")),],returns:["BOOLEAN"],compute:function(logicalExpression){return!toBoolean(logicalExpression);},isExported:true,};const OR={description:_t("Logical `or` operator."),args:[arg("logical_expression1 (boolean, range<boolean>)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE, or an expression that can be coerced to a logical value.")),arg("logical_expression2 (boolean, range<boolean>, repeating)",_t("More expressions that evaluate to logical values.")),],returns:["BOOLEAN"],compute:function(...logicalExpressions){let foundBoolean=false;let acc=false;conditionalVisitBoolean(logicalExpressions,(arg)=>{foundBoolean=true;acc=acc||arg;return!acc;});assert(()=>foundBoolean,_t("[[FUNCTION_NAME]] has no valid input data."));return acc;},isExported:true,};const TRUE={description:_t("Logical value `true`."),args:[],returns:["BOOLEAN"],compute:function(){return true;},isExported:true,};const XOR={description:_t("Logical `xor` operator."),args:[arg("logical_expression1 (boolean, range<boolean>)",_t("An expression or reference to a cell containing an expression that represents some logical value, i.e. TRUE or FALSE, or an expression that can be coerced to a logical value.")),arg("logical_expression2 (boolean, range<boolean>, repeating)",_t("More expressions that evaluate to logical values.")),],returns:["BOOLEAN"],compute:function(...logicalExpressions){let foundBoolean=false;let acc=false;conditionalVisitBoolean(logicalExpressions,(arg)=>{foundBoolean=true;acc=acc?!arg:arg;return true;});assert(()=>foundBoolean,_t("[[FUNCTION_NAME]] has no valid input data."));return acc;},isExported:true,};var logical=Object.freeze({__proto__:null,AND:AND,FALSE:FALSE,IF:IF,IFERROR:IFERROR,IFNA:IFNA,IFS:IFS,NOT:NOT,OR:OR,TRUE:TRUE,XOR:XOR});const DEFAULT_IS_SORTED=true;const DEFAULT_MATCH_MODE=0;const DEFAULT_SEARCH_MODE=1;const DEFAULT_ABSOLUTE_RELATIVE_MODE=1;function assertAvailable(variable,searchKey){if(variable===undefined){throw new NotAvailableError(_t("Did not find value '%s' in [[FUNCTION_NAME]] evaluation.",toString(searchKey)));}}
const ADDRESS={description:_t("Returns a cell reference as a string. "),args:[arg("row (number)",_t("The row number of the cell reference. ")),arg("column (number)",_t("The column number (not name) of the cell reference. A is column number 1. ")),arg(`absolute_relative_mode (number, default=${DEFAULT_ABSOLUTE_RELATIVE_MODE})`,_t("An indicator of whether the reference is row/column absolute. 1 is row and column absolute (e.g. $A$1), 2 is row absolute and column relative (e.g. A$1), 3 is row relative and column absolute (e.g. $A1), and 4 is row and column relative (e.g. A1).")),arg("use_a1_notation (boolean, default=TRUE)",_t("A boolean indicating whether to use A1 style notation (TRUE) or R1C1 style notation (FALSE).")),arg("sheet (string, optional)",_t("A string indicating the name of the sheet into which the address points.")),],returns:["STRING"],compute:function(row,column,absoluteRelativeMode=DEFAULT_ABSOLUTE_RELATIVE_MODE,useA1Notation=true,sheet){const rowNumber=strictToInteger(row,this.locale);const colNumber=strictToInteger(column,this.locale);assertNumberGreaterThanOrEqualToOne(rowNumber);assertNumberGreaterThanOrEqualToOne(colNumber);const _absoluteRelativeMode=strictToInteger(absoluteRelativeMode,this.locale);assert(()=>[1,2,3,4].includes(_absoluteRelativeMode),expectNumberRangeError(1,4,_absoluteRelativeMode));const _useA1Notation=toBoolean(useA1Notation);let cellReference;if(_useA1Notation){const rangePart={rowFixed:[1,2].includes(_absoluteRelativeMode)?true:false,colFixed:[1,3].includes(_absoluteRelativeMode)?true:false,};cellReference=toXC(colNumber-1,rowNumber-1,rangePart);}
else{const rowPart=[1,2].includes(_absoluteRelativeMode)?`R${rowNumber}`:`R[${rowNumber}]`;const colPart=[1,3].includes(_absoluteRelativeMode)?`C${colNumber}`:`C[${colNumber}]`;cellReference=rowPart+colPart;}
if(sheet!==undefined){return`${getCanonicalSheetName(toString(sheet))}!${cellReference}`;}
return cellReference;},isExported:true,};const COLUMN={description:_t("Column number of a specified cell."),args:[arg("cell_reference (meta, default='this cell')",_t("The cell whose column number will be returned. Column A corresponds to 1. By default, the function use the cell in which the formula is entered.")),],returns:["NUMBER"],compute:function(cellReference){const _cellReference=cellReference||this.__originCellXC?.();assert(()=>!!_cellReference,"In this context, the function [[FUNCTION_NAME]] needs to have a cell or range in parameter.");const zone=toZone(_cellReference);return zone.left+1;},isExported:true,};const COLUMNS={description:_t("Number of columns in a specified array or range."),args:[arg("range (meta)",_t("The range whose column count will be returned."))],returns:["NUMBER"],compute:function(range){const zone=toZone(range);return zone.right-zone.left+1;},isExported:true,};const HLOOKUP={description:_t("Horizontal lookup"),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("range (range)",_t("The range to consider for the search. The first row in the range is searched for the key specified in search_key.")),arg("index (number)",_t("The row index of the value to be returned, where the first row in range is numbered 1.")),arg(`is_sorted (boolean, default=${DEFAULT_IS_SORTED})`,_t("Indicates whether the row to be searched (the first row of the specified range) is sorted, in which case the closest match for search_key will be returned.")),],returns:["ANY"],computeValueAndFormat:function(searchKey,range,index,isSorted={value:DEFAULT_IS_SORTED}){const _index=Math.trunc(toNumber(index?.value,this.locale));assert(()=>1<=_index&&_index<=range[0].length,_t("[[FUNCTION_NAME]] evaluates to an out of bounds range."));const getValueFromRange=(range,index)=>range[index][0].value;const _isSorted=toBoolean(isSorted.value);const colIndex=_isSorted?dichotomicSearch(range,searchKey?.value,"nextSmaller","asc",range.length,getValueFromRange):linearSearch(range,searchKey?.value,"strict",range.length,getValueFromRange);const col=range[colIndex];assertAvailable(col,searchKey?.value);return col[_index-1];},isExported:true,};const INDEX={description:_t("Returns the content of a cell, specified by row and column offset."),args:[arg("reference (any, range)",_t("The range of cells from which the values are returned.")),arg("row (number, default=0)",_t("The index of the row to be returned from within the reference range of cells.")),arg("column (number, default=0)",_t("The index of the column to be returned from within the reference range of cells.")),],returns:["ANY"],computeValueAndFormat:function(reference,row={value:0},column={value:0}){const _reference=isMatrix(reference)?reference:[[reference]];const _row=toNumber(row.value,this.locale);const _column=toNumber(column.value,this.locale);assert(()=>_column>=0&&_column-1<_reference.length&&_row>=0&&_row-1<_reference[0].length,_t("Index out of range."));if(_row===0&&_column===0){return _reference;}
if(_row===0){return[_reference[_column-1]];}
if(_column===0){return _reference.map((col)=>[col[_row-1]]);}
return _reference[_column-1][_row-1];},isExported:true,};const LOOKUP={description:_t("Look up a value."),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("search_array (range)",_t("One method of using this function is to provide a single sorted row or column search_array to look through for the search_key with a second argument result_range. The other way is to combine these two arguments into one search_array where the first row or column is searched and a value is returned from the last row or column in the array. If search_key is not found, a non-exact match may be returned.")),arg("result_range (range, optional)",_t("The range from which to return a result. The value returned corresponds to the location where search_key is found in search_range. This range must be only a single row or column and should not be used if using the search_result_array method.")),],returns:["ANY"],computeValueAndFormat:function(searchKey,searchArray,resultRange){let nbCol=searchArray.length;let nbRow=searchArray[0].length;const verticalSearch=nbRow>=nbCol;const getElement=verticalSearch?(range,index)=>range[0][index].value:(range,index)=>range[index][0].value;const rangeLength=verticalSearch?nbRow:nbCol;const index=dichotomicSearch(searchArray,searchKey?.value,"nextSmaller","asc",rangeLength,getElement);if(index===-1)
assertAvailable(undefined,searchKey?.value);verticalSearch?assertAvailable(searchArray[0][index],searchKey?.value):assertAvailable(searchArray[index][nbRow-1],searchKey?.value);if(resultRange===undefined){return verticalSearch?searchArray[nbCol-1][index]:searchArray[index][nbRow-1];}
nbCol=resultRange.length;nbRow=resultRange[0].length;assert(()=>nbCol===1||nbRow===1,_t("The result_range must be a single row or a single column."));if(nbCol>1){assert(()=>index<=nbCol-1,_t("[[FUNCTION_NAME]] evaluates to an out of range row value %s.",(index+1).toString()));return resultRange[index][0];}
assert(()=>index<=nbRow-1,_t("[[FUNCTION_NAME]] evaluates to an out of range column value %s.",(index+1).toString()));return resultRange[0][index];},isExported:true,};const DEFAULT_SEARCH_TYPE=1;const MATCH={description:_t("Position of item in range that matches value."),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("range (any, range)",_t("The one-dimensional array to be searched.")),arg(`search_type (number, default=${DEFAULT_SEARCH_TYPE})`,_t("The search method. 1 (default) finds the largest value less than or equal to search_key when range is sorted in ascending order. 0 finds the exact value when range is unsorted. -1 finds the smallest value greater than or equal to search_key when range is sorted in descending order.")),],returns:["NUMBER"],compute:function(searchKey,range,searchType=DEFAULT_SEARCH_TYPE){let _searchType=toNumber(searchType,this.locale);const nbCol=range.length;const nbRow=range[0].length;assert(()=>nbCol===1||nbRow===1,_t("The range must be a single row or a single column."));let index=-1;const getElement=nbCol===1?(range,index)=>range[0][index]:(range,index)=>range[index][0];const rangeLen=nbCol===1?range[0].length:range.length;_searchType=Math.sign(_searchType);switch(_searchType){case 1:index=dichotomicSearch(range,searchKey,"nextSmaller","asc",rangeLen,getElement);break;case 0:index=linearSearch(range,searchKey,"strict",rangeLen,getElement);break;case-1:index=dichotomicSearch(range,searchKey,"nextGreater","desc",rangeLen,getElement);break;}
assertAvailable(nbCol===1?range[0][index]:range[index],searchKey);return index+1;},isExported:true,};const ROW={description:_t("Row number of a specified cell."),args:[arg("cell_reference (meta, default='this cell')",_t("The cell whose row number will be returned. By default, this function uses the cell in which the formula is entered.")),],returns:["NUMBER"],compute:function(cellReference){cellReference=cellReference||this.__originCellXC?.();assert(()=>!!cellReference,"In this context, the function [[FUNCTION_NAME]] needs to have a cell or range in parameter.");const zone=toZone(cellReference);return zone.top+1;},isExported:true,};const ROWS={description:_t("Number of rows in a specified array or range."),args:[arg("range (meta)",_t("The range whose row count will be returned."))],returns:["NUMBER"],compute:function(range){const zone=toZone(range);return zone.bottom-zone.top+1;},isExported:true,};const VLOOKUP={description:_t("Vertical lookup."),args:[arg("search_key (any)",_t("The value to search for. For example, 42, 'Cats', or I24.")),arg("range (any, range)",_t("The range to consider for the search. The first column in the range is searched for the key specified in search_key.")),arg("index (number)",_t("The column index of the value to be returned, where the first column in range is numbered 1.")),arg(`is_sorted (boolean, default=${DEFAULT_IS_SORTED})`,_t("Indicates whether the column to be searched (the first column of the specified range) is sorted, in which case the closest match for search_key will be returned.")),],returns:["ANY"],computeValueAndFormat:function(searchKey,range,index,isSorted={value:DEFAULT_IS_SORTED}){const _index=Math.trunc(toNumber(index?.value,this.locale));assert(()=>1<=_index&&_index<=range.length,_t("[[FUNCTION_NAME]] evaluates to an out of bounds range."));const getValueFromRange=(range,index)=>range[0][index].value;const _isSorted=toBoolean(isSorted.value);const rowIndex=_isSorted?dichotomicSearch(range,searchKey?.value,"nextSmaller","asc",range[0].length,getValueFromRange):linearSearch(range,searchKey?.value,"strict",range[0].length,getValueFromRange);const value=range[_index-1][rowIndex];assertAvailable(value,searchKey);return value;},isExported:true,};const XLOOKUP={description:_t("Search a range for a match and return the corresponding item from a second range."),args:[arg("search_key (any)",_t("The value to search for.")),arg("lookup_range (any, range)",_t("The range to consider for the search. Should be a single column or a single row.")),arg("return_range (any, range)",_t("The range containing the return value. Should have the same dimensions as lookup_range.")),arg("if_not_found (any, lazy, optional)",_t("If a valid match is not found, return this value.")),arg(`match_mode (any, default=${DEFAULT_MATCH_MODE})`,_t("(0) Exact match. (-1) Return next smaller item if no match. (1) Return next greater item if no match.")),arg(`search_mode (any, default=${DEFAULT_SEARCH_MODE})`,_t("(1) Search starting at first item. \
      (-1) Search starting at last item. \
      (2) Perform a binary search that relies on lookup_array being sorted in ascending order. If not sorted, invalid results will be returned. \
      (-2) Perform a binary search that relies on lookup_array being sorted in descending order. If not sorted, invalid results will be returned.\
      ")),],returns:["ANY"],computeValueAndFormat:function(searchKey,lookupRange,returnRange,defaultValue,matchMode={value:DEFAULT_MATCH_MODE},searchMode={value:DEFAULT_SEARCH_MODE}){const _matchMode=Math.trunc(toNumber(matchMode.value,this.locale));const _searchMode=Math.trunc(toNumber(searchMode.value,this.locale));assert(()=>lookupRange.length===1||lookupRange[0].length===1,_t("lookup_range should be either a single row or single column."));assert(()=>[-1,1,-2,2].includes(_searchMode),_t("searchMode should be a value in [-1, 1, -2, 2]."));assert(()=>[-1,0,1].includes(_matchMode),_t("matchMode should be a value in [-1, 0, 1]."));const lookupDirection=lookupRange.length===1?"col":"row";assert(()=>lookupDirection==="col"?returnRange[0].length===lookupRange[0].length:returnRange.length===lookupRange.length,_t("return_range should have the same dimensions as lookup_range."));const getElement=lookupDirection==="col"?(range,index)=>range[0][index].value:(range,index)=>range[index][0].value;const rangeLen=lookupDirection==="col"?lookupRange[0].length:lookupRange.length;const mode=_matchMode===0?"strict":_matchMode===1?"nextGreater":"nextSmaller";const reverseSearch=_searchMode===-1;const index=_searchMode===2||_searchMode===-2?dichotomicSearch(lookupRange,searchKey?.value,mode,_searchMode===2?"asc":"desc",rangeLen,getElement):linearSearch(lookupRange,searchKey?.value,mode,rangeLen,getElement,reverseSearch);if(index!==-1){return lookupDirection==="col"?returnRange.map((col)=>[col[index]]):[returnRange[index]];}
const _defaultValue=defaultValue?.();assertAvailable(_defaultValue,searchKey);return[[_defaultValue]];},isExported:true,};var lookup=Object.freeze({__proto__:null,ADDRESS:ADDRESS,COLUMN:COLUMN,COLUMNS:COLUMNS,HLOOKUP:HLOOKUP,INDEX:INDEX,LOOKUP:LOOKUP,MATCH:MATCH,ROW:ROW,ROWS:ROWS,VLOOKUP:VLOOKUP,XLOOKUP:XLOOKUP});const ADD={description:_t("Sum of two numbers."),args:[arg("value1 (number)",_t("The first addend.")),arg("value2 (number)",_t("The second addend.")),],returns:["NUMBER"],computeFormat:(value1,value2)=>value1?.format||value2?.format,compute:function(value1,value2){return toNumber(value1,this.locale)+toNumber(value2,this.locale);},};const CONCAT={description:_t("Concatenation of two values."),args:[arg("value1 (string)",_t("The value to which value2 will be appended.")),arg("value2 (string)",_t("The value to append to value1.")),],returns:["STRING"],compute:function(value1,value2){return toString(value1)+toString(value2);},isExported:true,};const DIVIDE={description:_t("One number divided by another."),args:[arg("dividend (number)",_t("The number to be divided.")),arg("divisor (number)",_t("The number to divide by.")),],returns:["NUMBER"],computeFormat:(dividend,divisor)=>dividend?.format||divisor?.format,compute:function(dividend,divisor){const _divisor=toNumber(divisor,this.locale);assert(()=>_divisor!==0,_t("The divisor must be different from zero."));return toNumber(dividend,this.locale)/_divisor;},};function isEmpty(value){return value===null||value===undefined;}
const getNeutral={number:0,string:"",boolean:false};const EQ={description:_t("Equal."),args:[arg("value1 (any)",_t("The first value.")),arg("value2 (any)",_t("The value to test against value1 for equality.")),],returns:["BOOLEAN"],compute:function(value1,value2){value1=isEmpty(value1)?getNeutral[typeof value2]:value1;value2=isEmpty(value2)?getNeutral[typeof value1]:value2;if(typeof value1==="string"){value1=value1.toUpperCase();}
if(typeof value2==="string"){value2=value2.toUpperCase();}
return value1===value2;},};function applyRelationalOperator(value1,value2,cb){value1=isEmpty(value1)?getNeutral[typeof value2]:value1;value2=isEmpty(value2)?getNeutral[typeof value1]:value2;if(typeof value1!=="number"){value1=toString(value1).toUpperCase();}
if(typeof value2!=="number"){value2=toString(value2).toUpperCase();}
const tV1=typeof value1;const tV2=typeof value2;if(tV1==="string"&&tV2==="number"){return true;}
if(tV2==="string"&&tV1==="number"){return false;}
return cb(value1,value2);}
const GT={description:_t("Strictly greater than."),args:[arg("value1 (any)",_t("The value to test as being greater than value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return applyRelationalOperator(value1,value2,(v1,v2)=>{return v1>v2;});},};const GTE={description:_t("Greater than or equal to."),args:[arg("value1 (any)",_t("The value to test as being greater than or equal to value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return applyRelationalOperator(value1,value2,(v1,v2)=>{return v1>=v2;});},};const LT={description:_t("Less than."),args:[arg("value1 (any)",_t("The value to test as being less than value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return!GTE.compute.bind(this)(value1,value2);},};const LTE={description:_t("Less than or equal to."),args:[arg("value1 (any)",_t("The value to test as being less than or equal to value2.")),arg("value2 (any)",_t("The second value.")),],returns:["BOOLEAN"],compute:function(value1,value2){return!GT.compute.bind(this)(value1,value2);},};const MINUS={description:_t("Difference of two numbers."),args:[arg("value1 (number)",_t("The minuend, or number to be subtracted from.")),arg("value2 (number)",_t("The subtrahend, or number to subtract from value1.")),],returns:["NUMBER"],computeFormat:(value1,value2)=>value1?.format||value2?.format,compute:function(value1,value2){return toNumber(value1,this.locale)-toNumber(value2,this.locale);},};const MULTIPLY={description:_t("Product of two numbers"),args:[arg("factor1 (number)",_t("The first multiplicand.")),arg("factor2 (number)",_t("The second multiplicand.")),],returns:["NUMBER"],computeFormat:(factor1,factor2)=>factor1?.format||factor2?.format,compute:function(factor1,factor2){return toNumber(factor1,this.locale)*toNumber(factor2,this.locale);},};const NE={description:_t("Not equal."),args:[arg("value1 (any)",_t("The first value.")),arg("value2 (any)",_t("The value to test against value1 for inequality.")),],returns:["BOOLEAN"],compute:function(value1,value2){return!EQ.compute.bind(this)(value1,value2);},};const POW={description:_t("A number raised to a power."),args:[arg("base (number)",_t("The number to raise to the exponent power.")),arg("exponent (number)",_t("The exponent to raise base to.")),],returns:["NUMBER"],compute:function(base,exponent){return POWER.compute.bind(this)(base,exponent);},};const UMINUS={description:_t("A number with the sign reversed."),args:[arg("value (number)",_t("The number to have its sign reversed. Equivalently, the number to multiply by -1.")),],computeFormat:(value)=>value?.format,returns:["NUMBER"],compute:function(value){return-toNumber(value,this.locale);},};const UNARY_PERCENT={description:_t("Value interpreted as a percentage."),args:[arg("percentage (number)",_t("The value to interpret as a percentage."))],returns:["NUMBER"],compute:function(percentage){return toNumber(percentage,this.locale)/100;},};const UPLUS={description:_t("A specified number, unchanged."),args:[arg("value (any)",_t("The number to return."))],returns:["ANY"],computeFormat:(value)=>value?.format,compute:function(value=""){return value===null?"":value;},};var operators=Object.freeze({__proto__:null,ADD:ADD,CONCAT:CONCAT,DIVIDE:DIVIDE,EQ:EQ,GT:GT,GTE:GTE,LT:LT,LTE:LTE,MINUS:MINUS,MULTIPLY:MULTIPLY,NE:NE,POW:POW,UMINUS:UMINUS,UNARY_PERCENT:UNARY_PERCENT,UPLUS:UPLUS});const DEFAULT_STARTING_AT=1;const wordRegex=/[A-Za-zÀ-ÖØ-öø-ÿ]+/g;const CHAR={description:_t("Gets character associated with number."),args:[arg("table_number (number)",_t("The number of the character to look up from the current Unicode table in decimal format.")),],returns:["STRING"],compute:function(tableNumber){const _tableNumber=Math.trunc(toNumber(tableNumber,this.locale));assert(()=>_tableNumber>=1,_t("The table_number (%s) is out of range.",_tableNumber.toString()));return String.fromCharCode(_tableNumber);},isExported:true,};const CLEAN={description:_t("Remove non-printable characters from a piece of text."),args:[arg("text (string)",_t("The text whose non-printable characters are to be removed."))],returns:["STRING"],compute:function(text){const _text=toString(text);let cleanedStr="";for(const char of _text){if(char&&char.charCodeAt(0)>31){cleanedStr+=char;}}
return cleanedStr;},isExported:true,};const CONCATENATE={description:_t("Appends strings to one another."),args:[arg("string1 (string, range<string>)",_t("The initial string.")),arg("string2 (string, range<string>, repeating)",_t("More strings to append in sequence.")),],returns:["STRING"],compute:function(...values){return reduceAny(values,(acc,a)=>acc+toString(a),"");},isExported:true,};const EXACT={description:_t("Tests whether two strings are identical."),args:[arg("string1 (string)",_t("The first string to compare.")),arg("string2 (string)",_t("The second string to compare.")),],returns:["BOOLEAN"],compute:function(string1,string2){return toString(string1)===toString(string2);},isExported:true,};const FIND={description:_t("First position of string found in text, case-sensitive."),args:[arg("search_for (string)",_t("The string to look for within text_to_search.")),arg("text_to_search (string)",_t("The text to search for the first occurrence of search_for.")),arg(`starting_at (number, default=${DEFAULT_STARTING_AT})`,_t("The character within text_to_search at which to start the search.")),],returns:["NUMBER"],compute:function(searchFor,textToSearch,startingAt=DEFAULT_STARTING_AT){const _searchFor=toString(searchFor);const _textToSearch=toString(textToSearch);const _startingAt=toNumber(startingAt,this.locale);assert(()=>_textToSearch!=="",_t("The text_to_search must be non-empty."));assert(()=>_startingAt>=1,_t("The starting_at (%s) must be greater than or equal to 1.",_startingAt.toString()));const result=_textToSearch.indexOf(_searchFor,_startingAt-1);assert(()=>result>=0,_t("In [[FUNCTION_NAME]] evaluation, cannot find '%s' within '%s'.",_searchFor.toString(),_textToSearch));return result+1;},isExported:true,};const JOIN={description:_t("Concatenates elements of arrays with delimiter."),args:[arg("delimiter (string)",_t("The character or string to place between each concatenated value.")),arg("value_or_array1 (string, range<string>)",_t("The value or values to be appended using delimiter.")),arg("value_or_array2 (string, range<string>, repeating)",_t("More values to be appended using delimiter.")),],returns:["STRING"],compute:function(delimiter,...valuesOrArrays){const _delimiter=toString(delimiter);return reduceAny(valuesOrArrays,(acc,a)=>(acc?acc+_delimiter:"")+toString(a),"");},};const LEFT={description:_t("Substring from beginning of specified string."),args:[arg("text (string)",_t("The string from which the left portion will be returned.")),arg("number_of_characters (number, optional)",_t("The number of characters to return from the left side of string.")),],returns:["STRING"],compute:function(text,...args){const _numberOfCharacters=args.length?toNumber(args[0],this.locale):1;assert(()=>_numberOfCharacters>=0,_t("The number_of_characters (%s) must be positive or null.",_numberOfCharacters.toString()));return toString(text).substring(0,_numberOfCharacters);},isExported:true,};const LEN={description:_t("Length of a string."),args:[arg("text (string)",_t("The string whose length will be returned."))],returns:["NUMBER"],compute:function(text){return toString(text).length;},isExported:true,};const LOWER={description:_t("Converts a specified string to lowercase."),args:[arg("text (string)",_t("The string to convert to lowercase."))],returns:["STRING"],compute:function(text){return toString(text).toLowerCase();},isExported:true,};const MID={description:_t("A segment of a string."),args:[arg("text (string)",_t("The string to extract a segment from.")),arg("starting_at (number)",_t("The index from the left of string from which to begin extracting. The first character in string has the index 1.")),arg("extract_length (number)",_t("The length of the segment to extract.")),],returns:["STRING"],compute:function(text,starting_at,extract_length){const _text=toString(text);const _starting_at=toNumber(starting_at,this.locale);const _extract_length=toNumber(extract_length,this.locale);assert(()=>_starting_at>=1,_t("The starting_at argument (%s) must be positive greater than one.",_starting_at.toString()));assert(()=>_extract_length>=0,_t("The extract_length argument (%s) must be positive or null.",_extract_length.toString()));return _text.slice(_starting_at-1,_starting_at+_extract_length-1);},isExported:true,};const PROPER={description:_t("Capitalizes each word in a specified string."),args:[arg("text_to_capitalize (string)",_t("The text which will be returned with the first letter of each word in uppercase and all other letters in lowercase.")),],returns:["STRING"],compute:function(text){const _text=toString(text);return _text.replace(wordRegex,(word)=>{return word.charAt(0).toUpperCase()+word.slice(1).toLowerCase();});},isExported:true,};const REPLACE={description:_t("Replaces part of a text string with different text."),args:[arg("text (string)",_t("The text, a part of which will be replaced.")),arg("position (number)",_t("The position where the replacement will begin (starting from 1).")),arg("length (number)",_t("The number of characters in the text to be replaced.")),arg("new_text (string)",_t("The text which will be inserted into the original text.")),],returns:["STRING"],compute:function(text,position,length,newText){const _position=toNumber(position,this.locale);assert(()=>_position>=1,_t("The position (%s) must be greater than or equal to 1.",_position.toString()));const _text=toString(text);const _length=toNumber(length,this.locale);const _newText=toString(newText);return _text.substring(0,_position-1)+_newText+_text.substring(_position-1+_length);},isExported:true,};const RIGHT={description:_t("A substring from the end of a specified string."),args:[arg("text (string)",_t("The string from which the right portion will be returned.")),arg("number_of_characters (number, optional)",_t("The number of characters to return from the right side of string.")),],returns:["STRING"],compute:function(text,...args){const _numberOfCharacters=args.length?toNumber(args[0],this.locale):1;assert(()=>_numberOfCharacters>=0,_t("The number_of_characters (%s) must be positive or null.",_numberOfCharacters.toString()));const _text=toString(text);const stringLength=_text.length;return _text.substring(stringLength-_numberOfCharacters,stringLength);},isExported:true,};const SEARCH={description:_t("First position of string found in text, ignoring case."),args:[arg("search_for (string)",_t("The string to look for within text_to_search.")),arg("text_to_search (string)",_t("The text to search for the first occurrence of search_for.")),arg(`starting_at (number, default=${DEFAULT_STARTING_AT})`,_t("The character within text_to_search at which to start the search.")),],returns:["NUMBER"],compute:function(searchFor,textToSearch,startingAt=DEFAULT_STARTING_AT){const _searchFor=toString(searchFor).toLowerCase();const _textToSearch=toString(textToSearch).toLowerCase();const _startingAt=toNumber(startingAt,this.locale);assert(()=>_textToSearch!=="",_t("The text_to_search must be non-empty."));assert(()=>_startingAt>=1,_t("The starting_at (%s) must be greater than or equal to 1.",_startingAt.toString()));const result=_textToSearch.indexOf(_searchFor,_startingAt-1);assert(()=>result>=0,_t("In [[FUNCTION_NAME]] evaluation, cannot find '%s' within '%s'.",_searchFor,_textToSearch));return result+1;},isExported:true,};const SPLIT_DEFAULT_SPLIT_BY_EACH=true;const SPLIT_DEFAULT_REMOVE_EMPTY_TEXT=true;const SPLIT={description:_t("Split text by specific character delimiter(s)."),args:[arg("text (string)",_t("The text to divide.")),arg("delimiter (string)",_t("The character or characters to use to split text.")),arg(`split_by_each (boolean, default=${SPLIT_DEFAULT_SPLIT_BY_EACH}})`,_t("Whether or not to divide text around each character contained in delimiter.")),arg(`remove_empty_text (boolean, default=${SPLIT_DEFAULT_REMOVE_EMPTY_TEXT})`,_t("Whether or not to remove empty text messages from the split results. The default behavior is to treat \
        consecutive delimiters as one (if TRUE). If FALSE, empty cells values are added between consecutive delimiters.")),],returns:["RANGE<STRING>"],compute:function(text,delimiter,splitByEach=SPLIT_DEFAULT_SPLIT_BY_EACH,removeEmptyText=SPLIT_DEFAULT_REMOVE_EMPTY_TEXT){const _text=toString(text);const _delimiter=escapeRegExp(toString(delimiter));const _splitByEach=toBoolean(splitByEach);const _removeEmptyText=toBoolean(removeEmptyText);assert(()=>_delimiter.length>0,_t("The _delimiter (%s) must be not be empty.",_delimiter));const regex=_splitByEach?new RegExp(`[${_delimiter}]`,"g"):new RegExp(_delimiter,"g");let result=_text.split(regex);if(_removeEmptyText){result=result.filter((text)=>text!=="");}
return transposeMatrix([result]);},isExported:true,};const SUBSTITUTE={description:_t("Replaces existing text with new text in a string."),args:[arg("text_to_search (string)",_t("The text within which to search and replace.")),arg("search_for (string)",_t("The string to search for within text_to_search.")),arg("replace_with (string)",_t("The string that will replace search_for.")),arg("occurrence_number (number, optional)",_t("The instance of search_for within text_to_search to replace with replace_with. By default, all occurrences of search_for are replaced; however, if occurrence_number is specified, only the indicated instance of search_for is replaced.")),],returns:["NUMBER"],compute:function(textToSearch,searchFor,replaceWith,occurrenceNumber){const _occurrenceNumber=toNumber(occurrenceNumber,this.locale);assert(()=>_occurrenceNumber>=0,_t("The occurrenceNumber (%s) must be positive or null.",_occurrenceNumber.toString()));const _textToSearch=toString(textToSearch);const _searchFor=toString(searchFor);if(_searchFor===""){return _textToSearch;}
const _replaceWith=toString(replaceWith);const reg=new RegExp(escapeRegExp(_searchFor),"g");if(_occurrenceNumber===0){return _textToSearch.replace(reg,_replaceWith);}
let n=0;return _textToSearch.replace(reg,(text)=>(++n===_occurrenceNumber?_replaceWith:text));},isExported:true,};const TEXTJOIN={description:_t("Combines text from multiple strings and/or arrays."),args:[arg("delimiter (string)",_t(" A string, possible empty, or a reference to a valid string. If empty, the text will be simply concatenated.")),arg("ignore_empty (boolean)",_t("A boolean; if TRUE, empty cells selected in the text arguments won't be included in the result.")),arg("text1 (string, range<string>)",_t("Any text item. This could be a string, or an array of strings in a range.")),arg("text2 (string, range<string>, repeating)",_t("Additional text item(s).")),],returns:["STRING"],compute:function(delimiter,ignoreEmpty,...textsOrArrays){const _delimiter=toString(delimiter);const _ignoreEmpty=toBoolean(ignoreEmpty);let n=0;return reduceAny(textsOrArrays,(acc,a)=>!(_ignoreEmpty&&toString(a)==="")?(n++?acc+_delimiter:"")+toString(a):acc,"");},isExported:true,};const TRIM={description:_t("Removes space characters."),args:[arg("text (string)",_t("The text or reference to a cell containing text to be trimmed.")),],returns:["STRING"],compute:function(text){return trimContent(toString(text));},isExported:true,};const UPPER={description:_t("Converts a specified string to uppercase."),args:[arg("text (string)",_t("The string to convert to uppercase."))],returns:["STRING"],compute:function(text){return toString(text).toUpperCase();},isExported:true,};const TEXT={description:_t("Converts a number to text according to a specified format."),args:[arg("number (number)",_t("The number, date or time to format.")),arg("format (string)",_t("The pattern by which to format the number, enclosed in quotation marks.")),],returns:["STRING"],compute:function(number,format){const _number=toNumber(number,this.locale);return formatValue(_number,{format:toString(format),locale:this.locale});},isExported:true,};var text=Object.freeze({__proto__:null,CHAR:CHAR,CLEAN:CLEAN,CONCATENATE:CONCATENATE,EXACT:EXACT,FIND:FIND,JOIN:JOIN,LEFT:LEFT,LEN:LEN,LOWER:LOWER,MID:MID,PROPER:PROPER,REPLACE:REPLACE,RIGHT:RIGHT,SEARCH:SEARCH,SPLIT:SPLIT,SUBSTITUTE:SUBSTITUTE,TEXT:TEXT,TEXTJOIN:TEXTJOIN,TRIM:TRIM,UPPER:UPPER});const HYPERLINK={description:_t("Creates a hyperlink in a cell."),args:[arg("url (string)",_t("The full URL of the link enclosed in quotation marks.")),arg("link_label (string, optional)",_t("The text to display in the cell, enclosed in quotation marks.")),],returns:["STRING"],compute:function(url,linkLabel){const processedUrl=toString(url).trim();const processedLabel=toString(linkLabel)||processedUrl;if(processedUrl==="")
return processedLabel;return markdownLink(processedLabel,processedUrl);},isExported:true,};var web=Object.freeze({__proto__:null,HYPERLINK:HYPERLINK});const categories=[{name:_t("Array"),functions:array},{name:_t("Database"),functions:database},{name:_t("Date"),functions:date},{name:_t("Filter"),functions:filter},{name:_t("Financial"),functions:financial},{name:_t("Info"),functions:info},{name:_t("Lookup"),functions:lookup},{name:_t("Logical"),functions:logical},{name:_t("Math"),functions:math},{name:_t("Misc"),functions:misc},{name:_t("Operator"),functions:operators},{name:_t("Statistical"),functions:statistical},{name:_t("Text"),functions:text},{name:_t("Engineering"),functions:engineering},{name:_t("Web"),functions:web},];const functionNameRegex=/^[A-Z0-9\_\.]+$/;class FunctionRegistry extends Registry{mapping={};add(name,addDescr){name=name.toUpperCase();if(!functionNameRegex.test(name)){throw new Error(_t("Invalid function name %s. Function names can exclusively contain alphanumerical values separated by dots (.) or underscore (_)",name));}
const descr=addMetaInfoFromArg(addDescr);validateArguments(descr.args);this.mapping[name]=addInputHandling(descr,createComputeFunctionFromDescription(descr));super.add(name,descr);return this;}}
function addInputHandling(descr,computeFunction){function computeWithInputHandling(...args){for(let i=0;i<args.length;i++){const argDefinition=descr.args[descr.getArgToFocus(i+1)-1];const arg=args[i];if(isMatrix(arg)&&!argDefinition.acceptMatrix){if(arg.length!==1||arg[0].length!==1){throw new EvaluationError(CellErrorType.GenericError,_t("Function [[FUNCTION_NAME]] expects the parameter '%s' to be a single value or a single cell reference, not a range.",argDefinition.name));}
args[i]=arg[0][0];}}
return computeFunction.apply(this,args);}
return computeWithInputHandling;}
function createComputeFunctionFromDescription(descr){const computeValueAndFormat="computeValueAndFormat"in descr;const computeValue="compute"in descr;const computeFormat="computeFormat"in descr;if(!computeValueAndFormat&&!computeValue){throw new Error("Invalid function description, need at least one 'compute' or 'computeValueAndFormat' function");}
if(computeValueAndFormat&&(computeValue||computeFormat)){throw new Error("Invalid function description, cannot have both 'computeValueAndFormat' and 'compute'/'computeFormat' functions");}
if(computeValueAndFormat){return descr.computeValueAndFormat;}
return buildComputeFunctionFromDescription(descr);}
function buildComputeFunctionFromDescription(descr){return function(...args){const value=descr.compute.apply(this,extractArgValuesFromArgs(args));const format=descr.computeFormat?.apply(this,args);if(isMatrix(value)){if(format===undefined||isMatrix(format)){return value.map((col,i)=>col.map((row,j)=>({value:row,format:format?.[i]?.[j]})));}}
else{if(format===undefined||!isMatrix(format)){return{value,format};}}
throw new Error("A format matrix should never be associated with a scalar value");};}
function extractArgValuesFromArgs(args){return args.map((arg)=>{if(arg===undefined){return undefined;}
if(typeof arg==="function"){return()=>extractArgValueFromArg(arg());}
return extractArgValueFromArg(arg);});}
function extractArgValueFromArg(arg){if(isMatrix(arg)){return matrixMap(arg,(data)=>data.value);}
return arg?.value;}
const functionRegistry=new FunctionRegistry();for(let category of categories){const fns=category.functions;for(let name in fns){const addDescr=fns[name];addDescr.category=addDescr.category||category.name;name=name.replace(/_/g,".");functionRegistry.add(name,{isExported:false,...addDescr});}}
const insertRow={name:(env)=>{const number=getRowsNumber(env);return number===1?_t("Insert row"):_t("Insert %s rows",number.toString());},isVisible:(env)=>CAN_INSERT_HEADER(env,"ROW"),icon:"o-spreadsheet-Icon.INSERT_ROW",};const rowInsertRowBefore={name:(env)=>{const number=getRowsNumber(env);return number===1?_t("Insert row above"):_t("Insert %s rows above",number.toString());},execute:INSERT_ROWS_BEFORE_ACTION,isVisible:(env)=>CAN_INSERT_HEADER(env,"ROW"),icon:"o-spreadsheet-Icon.INSERT_ROW_BEFORE",};const topBarInsertRowsBefore={...rowInsertRowBefore,name:(env)=>{const number=getRowsNumber(env);if(number===1){return _t("Row above");}
return _t("%s Rows above",number.toString());},};const cellInsertRowsBefore={...rowInsertRowBefore,name:(env)=>{const number=getRowsNumber(env);if(number===1){return _t("Insert row");}
return _t("Insert %s rows",number.toString());},isVisible:IS_ONLY_ONE_RANGE,icon:"o-spreadsheet-Icon.INSERT_ROW_BEFORE",};const rowInsertRowsAfter={execute:INSERT_ROWS_AFTER_ACTION,name:(env)=>{const number=getRowsNumber(env);return number===1?_t("Insert row below"):_t("Insert %s rows below",number.toString());},isVisible:(env)=>CAN_INSERT_HEADER(env,"ROW"),icon:"o-spreadsheet-Icon.INSERT_ROW_AFTER",};const topBarInsertRowsAfter={...rowInsertRowsAfter,name:(env)=>{const number=getRowsNumber(env);if(number===1){return _t("Row below");}
return _t("%s Rows below",number.toString());},};const insertCol={name:(env)=>{const number=getColumnsNumber(env);return number===1?_t("Insert column"):_t("Insert %s columns",number.toString());},isVisible:(env)=>CAN_INSERT_HEADER(env,"COL"),icon:"o-spreadsheet-Icon.INSERT_COL",};const colInsertColsBefore={name:(env)=>{const number=getColumnsNumber(env);return number===1?_t("Insert column left"):_t("Insert %s columns left",number.toString());},execute:INSERT_COLUMNS_BEFORE_ACTION,isVisible:(env)=>CAN_INSERT_HEADER(env,"COL"),icon:"o-spreadsheet-Icon.INSERT_COL_BEFORE",};const topBarInsertColsBefore={...colInsertColsBefore,name:(env)=>{const number=getColumnsNumber(env);if(number===1){return _t("Column left");}
return _t("%s Columns left",number.toString());},};const cellInsertColsBefore={...colInsertColsBefore,name:(env)=>{const number=getColumnsNumber(env);if(number===1){return _t("Insert column");}
return _t("Insert %s columns",number.toString());},isVisible:IS_ONLY_ONE_RANGE,icon:"o-spreadsheet-Icon.INSERT_COL_BEFORE",};const colInsertColsAfter={name:(env)=>{const number=getColumnsNumber(env);return number===1?_t("Insert column right"):_t("Insert %s columns right",number.toString());},execute:INSERT_COLUMNS_AFTER_ACTION,isVisible:(env)=>CAN_INSERT_HEADER(env,"COL"),icon:"o-spreadsheet-Icon.INSERT_COL_AFTER",};const topBarInsertColsAfter={...colInsertColsAfter,name:(env)=>{const number=getColumnsNumber(env);if(number===1){return _t("Column right");}
return _t("%s Columns right",number.toString());},execute:INSERT_COLUMNS_AFTER_ACTION,};const insertCell={name:_t("Insert cells"),isVisible:(env)=>IS_ONLY_ONE_RANGE(env)&&env.model.getters.getActiveCols().size===0&&env.model.getters.getActiveRows().size===0,icon:"o-spreadsheet-Icon.INSERT_CELL",};const insertCellShiftDown={name:_t("Insert cells and shift down"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("INSERT_CELL",{zone,shiftDimension:"ROW"});handlePasteResult(env,result);},isVisible:(env)=>env.model.getters.getActiveRows().size===0&&env.model.getters.getActiveCols().size===0,icon:"o-spreadsheet-Icon.INSERT_CELL_SHIFT_DOWN",};const insertCellShiftRight={name:_t("Insert cells and shift right"),execute:(env)=>{const zone=env.model.getters.getSelectedZone();const result=env.model.dispatch("INSERT_CELL",{zone,shiftDimension:"COL"});handlePasteResult(env,result);},isVisible:(env)=>env.model.getters.getActiveRows().size===0&&env.model.getters.getActiveCols().size===0,icon:"o-spreadsheet-Icon.INSERT_CELL_SHIFT_RIGHT",};const insertChart={name:_t("Chart"),execute:CREATE_CHART,icon:"o-spreadsheet-Icon.INSERT_CHART",};const insertImage={name:_t("Image"),description:"Ctrl+O",execute:CREATE_IMAGE,isVisible:(env)=>env.imageProvider!==undefined,icon:"o-spreadsheet-Icon.INSERT_IMAGE",};const insertFunction={name:_t("Function"),icon:"o-spreadsheet-Icon.SHOW_HIDE_FORMULA",};const insertFunctionSum={name:_t("SUM"),execute:(env)=>env.startCellEdition(`=SUM(`),};const insertFunctionAverage={name:_t("AVERAGE"),execute:(env)=>env.startCellEdition(`=AVERAGE(`),};const insertFunctionCount={name:_t("COUNT"),execute:(env)=>env.startCellEdition(`=COUNT(`),};const insertFunctionMax={name:_t("MAX"),execute:(env)=>env.startCellEdition(`=MAX(`),};const insertFunctionMin={name:_t("MIN"),execute:(env)=>env.startCellEdition(`=MIN(`),};const categorieFunctionAll={name:_t("All"),children:[allFunctionListMenuBuilder],};function allFunctionListMenuBuilder(){const fnNames=functionRegistry.getKeys().filter((key)=>!functionRegistry.get(key).hidden);return createFormulaFunctions(fnNames);}
const categoriesFunctionListMenuBuilder=()=>{const functions=functionRegistry.content;const categories=[...new Set(functionRegistry.getAll().filter((fn)=>!fn.hidden).map((fn)=>fn.category)),].filter(isDefined$1);return categories.sort().map((category,i)=>{const functionsInCategory=Object.keys(functions).filter((key)=>functions[key].category===category&&!functions[key].hidden);return{name:category,children:createFormulaFunctions(functionsInCategory),};});};const insertLink={name:_t("Link"),execute:INSERT_LINK,icon:"o-spreadsheet-Icon.INSERT_LINK",};const insertSheet={name:_t("Insert sheet"),execute:(env)=>{const activeSheetId=env.model.getters.getActiveSheetId();const position=env.model.getters.getSheetIds().indexOf(activeSheetId)+1;const sheetId=env.model.uuidGenerator.uuidv4();env.model.dispatch("CREATE_SHEET",{sheetId,position});env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:activeSheetId,sheetIdTo:sheetId});},icon:"o-spreadsheet-Icon.INSERT_SHEET",};function createFormulaFunctions(fnNames){return fnNames.sort().map((fnName,i)=>{return{name:fnName,sequence:i*10,execute:(env)=>env.startCellEdition(`=${fnName}(`),};});}
function getRowsNumber(env){const activeRows=env.model.getters.getActiveRows();if(activeRows.size){return activeRows.size;}
else{const zone=env.model.getters.getSelectedZones()[0];return zone.bottom-zone.top+1;}}
function getColumnsNumber(env){const activeCols=env.model.getters.getActiveCols();if(activeCols.size){return activeCols.size;}
else{const zone=env.model.getters.getSelectedZones()[0];return zone.right-zone.left+1;}}
const cellMenuRegistry=new MenuItemRegistry();cellMenuRegistry.add("cut",{...cut,sequence:10,}).add("copy",{...copy,sequence:20,}).add("paste",{...paste,sequence:30,}).add("paste_special",{...pasteSpecial,sequence:40,separator:true,}).addChild("paste_value_only",["paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_format_only",["paste_special"],{...pasteSpecialFormat,sequence:20,}).add("add_row_before",{...cellInsertRowsBefore,sequence:70,}).add("add_column_before",{...cellInsertColsBefore,sequence:90,}).add("insert_cell",{...insertCell,sequence:100,separator:true,}).addChild("insert_cell_down",["insert_cell"],{...insertCellShiftDown,name:_t("Shift down"),sequence:10,}).addChild("insert_cell_right",["insert_cell"],{...insertCellShiftRight,name:_t("Shift right"),sequence:20,}).add("delete_row",{...deleteRow,sequence:110,icon:"o-spreadsheet-Icon.DELETE",}).add("delete_column",{...deleteCol,sequence:120,icon:"o-spreadsheet-Icon.DELETE",}).add("delete_cell",{...deleteCells,sequence:130,separator:true,icon:"o-spreadsheet-Icon.DELETE",}).addChild("delete_cell_up",["delete_cell"],{...deleteCellShiftUp,name:_t("Shift up"),sequence:10,icon:"o-spreadsheet-Icon.DELETE_CELL_SHIFT_UP",}).addChild("delete_cell_left",["delete_cell"],{...deleteCellShiftLeft,name:_t("Shift left"),sequence:20,icon:"o-spreadsheet-Icon.DELETE_CELL_SHIFT_LEFT",}).add("insert_link",{...insertLink,name:INSERT_LINK_NAME,sequence:150,separator:true,});const AddFilterInteractiveContent={filterOverlap:_t("You cannot create overlapping filters."),nonContinuousTargets:_t("A filter can only be created on a continuous selection."),mergeInFilter:_t("You can't create a filter over a range that contains a merge."),};function interactiveAddFilter(env,sheetId,target){const result=env.model.dispatch("CREATE_FILTER_TABLE",{target,sheetId});if(result.isCancelledBecause("FilterOverlap")){env.raiseError(AddFilterInteractiveContent.filterOverlap);}
else if(result.isCancelledBecause("MergeInFilter")){env.raiseError(AddFilterInteractiveContent.mergeInFilter);}
else if(result.isCancelledBecause("NonContinuousTargets")){env.raiseError(AddFilterInteractiveContent.nonContinuousTargets);}}
function interactiveFreezeColumnsRows(env,dimension,base){const sheetId=env.model.getters.getActiveSheetId();const cmd=dimension==="COL"?"FREEZE_COLUMNS":"FREEZE_ROWS";const result=env.model.dispatch(cmd,{sheetId,quantity:base});if(result.isCancelledBecause("MergeOverlap")){env.raiseError(MergeErrorMessage);}}
const hideCols={name:HIDE_COLUMNS_NAME,execute:(env)=>{const columns=env.model.getters.getElementsFromSelection("COL");env.model.dispatch("HIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});},isVisible:NOT_ALL_VISIBLE_COLS_SELECTED,icon:"o-spreadsheet-Icon.HIDE_COL",};const unhideCols={name:_t("Unhide columns"),execute:(env)=>{const columns=env.model.getters.getElementsFromSelection("COL");env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});},isVisible:(env)=>{const hiddenCols=env.model.getters.getHiddenColsGroups(env.model.getters.getActiveSheetId()).flat();const currentCols=env.model.getters.getElementsFromSelection("COL");return currentCols.some((col)=>hiddenCols.includes(col));},};const unhideAllCols={name:_t("Unhide all columns"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId,dimension:"COL",elements:Array.from(Array(env.model.getters.getNumberCols(sheetId)).keys()),});},isVisible:(env)=>env.model.getters.getHiddenColsGroups(env.model.getters.getActiveSheetId()).length>0,};const hideRows={name:HIDE_ROWS_NAME,execute:(env)=>{const rows=env.model.getters.getElementsFromSelection("ROW");env.model.dispatch("HIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"ROW",elements:rows,});},isVisible:NOT_ALL_VISIBLE_ROWS_SELECTED,icon:"o-spreadsheet-Icon.HIDE_ROW",};const unhideRows={name:_t("Unhide rows"),execute:(env)=>{const columns=env.model.getters.getElementsFromSelection("ROW");env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),dimension:"ROW",elements:columns,});},isVisible:(env)=>{const hiddenRows=env.model.getters.getHiddenRowsGroups(env.model.getters.getActiveSheetId()).flat();const currentRows=env.model.getters.getElementsFromSelection("ROW");return currentRows.some((col)=>hiddenRows.includes(col));},};const unhideAllRows={name:_t("Unhide all rows"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId,dimension:"ROW",elements:Array.from(Array(env.model.getters.getNumberRows(sheetId)).keys()),});},isVisible:(env)=>env.model.getters.getHiddenRowsGroups(env.model.getters.getActiveSheetId()).length>0,};const unFreezePane={name:_t("Unfreeze"),isVisible:(env)=>{const{xSplit,ySplit}=env.model.getters.getPaneDivisions(env.model.getters.getActiveSheetId());return xSplit+ySplit>0;},execute:(env)=>env.model.dispatch("UNFREEZE_COLUMNS_ROWS",{sheetId:env.model.getters.getActiveSheetId(),}),icon:"o-spreadsheet-Icon.UNFREEZE",};const freezePane={name:_t("Freeze"),icon:"o-spreadsheet-Icon.FREEZE",};const unFreezeRows={name:_t("No rows"),execute:(env)=>env.model.dispatch("UNFREEZE_ROWS",{sheetId:env.model.getters.getActiveSheetId(),}),isReadonlyAllowed:true,isVisible:(env)=>!!env.model.getters.getPaneDivisions(env.model.getters.getActiveSheetId()).ySplit,};const freezeFirstRow={name:_t("1 row"),execute:(env)=>interactiveFreezeColumnsRows(env,"ROW",1),isReadonlyAllowed:true,};const freezeSecondRow={name:_t("2 rows"),execute:(env)=>interactiveFreezeColumnsRows(env,"ROW",2),isReadonlyAllowed:true,};const freezeCurrentRow={name:_t("Up to current row"),execute:(env)=>{const{bottom}=env.model.getters.getSelectedZone();interactiveFreezeColumnsRows(env,"ROW",bottom+1);},isReadonlyAllowed:true,};const unFreezeCols={name:_t("No columns"),execute:(env)=>env.model.dispatch("UNFREEZE_COLUMNS",{sheetId:env.model.getters.getActiveSheetId(),}),isReadonlyAllowed:true,isVisible:(env)=>!!env.model.getters.getPaneDivisions(env.model.getters.getActiveSheetId()).xSplit,};const freezeFirstCol={name:_t("1 column"),execute:(env)=>interactiveFreezeColumnsRows(env,"COL",1),isReadonlyAllowed:true,};const freezeSecondCol={name:_t("2 columns"),execute:(env)=>interactiveFreezeColumnsRows(env,"COL",2),isReadonlyAllowed:true,};const freezeCurrentCol={name:_t("Up to current column"),execute:(env)=>{const{right}=env.model.getters.getSelectedZone();interactiveFreezeColumnsRows(env,"COL",right+1);},isReadonlyAllowed:true,};const viewGridlines={name:(env)=>env.model.getters.getGridLinesVisibility(env.model.getters.getActiveSheetId())?_t("Hide gridlines"):_t("Show gridlines"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("SET_GRID_LINES_VISIBILITY",{sheetId,areGridLinesVisible:!env.model.getters.getGridLinesVisibility(sheetId),});},icon:"o-spreadsheet-Icon.SHOW_HIDE_GRID",};const viewFormulas={name:(env)=>env.model.getters.shouldShowFormulas()?"Hide formulas":_t("Show formulas"),execute:(env)=>env.model.dispatch("SET_FORMULA_VISIBILITY",{show:!env.model.getters.shouldShowFormulas()}),isReadonlyAllowed:true,icon:"o-spreadsheet-Icon.SHOW_HIDE_FORMULA",};const createRemoveFilter={name:(env)=>selectionContainsFilter(env)?_t("Remove selected filters"):_t("Create filter"),isActive:(env)=>selectionContainsFilter(env),isEnabled:(env)=>!cannotCreateFilter(env),execute:(env)=>createRemoveFilterAction(env),icon:"o-spreadsheet-Icon.FILTER_ICON_INACTIVE",};const groupColumns={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.left===selection.right){return _t("Group column %s",numberToLetters(selection.left));}
return _t("Group columns %s - %s",numberToLetters(selection.left),numberToLetters(selection.right));},execute:(env)=>groupHeadersAction(env,"COL"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZone();const groups=env.model.getters.getHeaderGroupsInZone(sheetId,"COL",selection);return(IS_ONLY_ONE_RANGE(env)&&!groups.some((group)=>group.start===selection.left&&group.end===selection.right));},icon:"o-spreadsheet-Icon.GROUP_COLUMNS",};const groupRows={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.top===selection.bottom){return _t("Group row %s",String(selection.top+1));}
return _t("Group rows %s - %s",String(selection.top+1),String(selection.bottom+1));},execute:(env)=>groupHeadersAction(env,"ROW"),isVisible:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZone();const groups=env.model.getters.getHeaderGroupsInZone(sheetId,"ROW",selection);return(IS_ONLY_ONE_RANGE(env)&&!groups.some((group)=>group.start===selection.top&&group.end===selection.bottom));},icon:"o-spreadsheet-Icon.GROUP_ROWS",};const ungroupColumns={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.left===selection.right){return _t("Ungroup column %s",numberToLetters(selection.left));}
return _t("Ungroup columns %s - %s",numberToLetters(selection.left),numberToLetters(selection.right));},execute:(env)=>ungroupHeaders(env,"COL"),icon:"o-spreadsheet-Icon.UNGROUP_COLUMNS",};const ungroupRows={name:(env)=>{const selection=env.model.getters.getSelectedZone();if(selection.top===selection.bottom){return _t("Ungroup row %s",String(selection.top+1));}
return _t("Ungroup rows %s - %s",String(selection.top+1),String(selection.bottom+1));},execute:(env)=>ungroupHeaders(env,"ROW"),icon:"o-spreadsheet-Icon.UNGROUP_ROWS",};function selectionContainsFilter(env){const sheetId=env.model.getters.getActiveSheetId();const selectedZones=env.model.getters.getSelectedZones();return env.model.getters.doesZonesContainFilter(sheetId,selectedZones);}
function cannotCreateFilter(env){return!areZonesContinuous(...env.model.getters.getSelectedZones());}
function createRemoveFilterAction(env){if(selectionContainsFilter(env)){env.model.dispatch("REMOVE_FILTER_TABLE",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),});return;}
if(cannotCreateFilter(env)){return;}
env.model.selection.selectTableAroundSelection();const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZones();interactiveAddFilter(env,sheetId,selection);}
function groupHeadersAction(env,dim){const selection=env.model.getters.getSelectedZone();const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("GROUP_HEADERS",{sheetId,dimension:dim,start:dim==="COL"?selection.left:selection.top,end:dim==="COL"?selection.right:selection.bottom,});}
function ungroupHeaders(env,dim){const selection=env.model.getters.getSelectedZone();const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNGROUP_HEADERS",{sheetId,dimension:dim,start:dim==="COL"?selection.left:selection.top,end:dim==="COL"?selection.right:selection.bottom,});}
function canUngroupHeaders(env,dimension){const sheetId=env.model.getters.getActiveSheetId();const selection=env.model.getters.getSelectedZones();return(selection.length===1&&env.model.getters.getHeaderGroupsInZone(sheetId,dimension,selection[0]).length>0);}
var ACTION_VIEW=Object.freeze({__proto__:null,canUngroupHeaders:canUngroupHeaders,createRemoveFilter:createRemoveFilter,createRemoveFilterAction:createRemoveFilterAction,freezeCurrentCol:freezeCurrentCol,freezeCurrentRow:freezeCurrentRow,freezeFirstCol:freezeFirstCol,freezeFirstRow:freezeFirstRow,freezePane:freezePane,freezeSecondCol:freezeSecondCol,freezeSecondRow:freezeSecondRow,groupColumns:groupColumns,groupRows:groupRows,hideCols:hideCols,hideRows:hideRows,unFreezeCols:unFreezeCols,unFreezePane:unFreezePane,unFreezeRows:unFreezeRows,ungroupColumns:ungroupColumns,ungroupRows:ungroupRows,unhideAllCols:unhideAllCols,unhideAllRows:unhideAllRows,unhideCols:unhideCols,unhideRows:unhideRows,viewFormulas:viewFormulas,viewGridlines:viewGridlines});const sortRange={name:_t("Sort range"),isVisible:IS_ONLY_ONE_RANGE,icon:"o-spreadsheet-Icon.SORT_RANGE",};const sortAscending={name:_t("Ascending (A ⟶ Z)"),execute:(env)=>{const{anchor,zones}=env.model.getters.getSelection();const sheetId=env.model.getters.getActiveSheetId();interactiveSortSelection(env,sheetId,anchor.cell,zones[0],"ascending");},icon:"o-spreadsheet-Icon.SORT_ASCENDING",};const dataCleanup={name:_t("Data cleanup"),icon:"o-spreadsheet-Icon.DATA_CLEANUP",};const removeDuplicates={name:_t("Remove duplicates"),execute:(env)=>{if(getZoneArea(env.model.getters.getSelectedZone())===1){env.model.selection.selectTableAroundSelection();}
env.openSidePanel("RemoveDuplicates",{});},};const trimWhitespace={name:_t("Trim whitespace"),execute:(env)=>{env.model.dispatch("TRIM_WHITESPACE");},};const sortDescending={name:_t("Descending (Z ⟶ A)"),execute:(env)=>{const{anchor,zones}=env.model.getters.getSelection();const sheetId=env.model.getters.getActiveSheetId();interactiveSortSelection(env,sheetId,anchor.cell,zones[0],"descending");},icon:"o-spreadsheet-Icon.SORT_DESCENDING",};const addRemoveDataFilter={name:(env)=>SELECTION_CONTAINS_FILTER(env)?_t("Remove filter"):_t("Create filter"),execute:(env)=>createRemoveFilterAction(env),isEnabled:(env)=>{const selectedZones=env.model.getters.getSelectedZones();return areZonesContinuous(...selectedZones);},icon:"o-spreadsheet-Icon.MENU_FILTER_ICON",};const splitToColumns={name:_t("Split text to columns"),sequence:1,execute:(env)=>env.openSidePanel("SplitToColumns",{}),isEnabled:(env)=>env.model.getters.isSingleColSelected(),icon:"o-spreadsheet-Icon.SPLIT_TEXT",};function createFormatActionSpec({name,format,descriptionValue,}){const formatCallback=typeof format==="function"?format:()=>format;return{name,description:(env)=>formatValue(descriptionValue,{format:formatCallback(env),locale:env.model.getters.getLocale(),}),execute:(env)=>setFormatter(env,formatCallback(env)),isActive:(env)=>isFormatSelected(env,formatCallback(env)),};}
const formatNumberAutomatic={name:_t("Automatic"),execute:(env)=>setFormatter(env,""),isActive:(env)=>isAutomaticFormatSelected(env),};const formatNumberNumber=createFormatActionSpec({name:_t("Number"),descriptionValue:1000.12,format:"#,##0.00",});const formatPercent={name:_t("Format as percent"),execute:FORMAT_PERCENT_ACTION,icon:"o-spreadsheet-Icon.PERCENT",};const formatNumberPercent=createFormatActionSpec({name:_t("Percent"),descriptionValue:0.1012,format:"0.00%",});const formatNumberCurrency=createFormatActionSpec({name:_t("Currency"),descriptionValue:1000.12,format:(env)=>env.model.config.defaultCurrencyFormat??DEFAULT_CURRENCY_FORMAT,});const formatNumberCurrencyRounded={...createFormatActionSpec({name:_t("Currency rounded"),descriptionValue:1000,format:(env)=>roundFormat(env.model.config.defaultCurrencyFormat??DEFAULT_CURRENCY_FORMAT),}),isVisible:(env)=>{const currencyFormat=env.model.config.defaultCurrencyFormat;return currencyFormat!==roundFormat(currencyFormat??DEFAULT_CURRENCY_FORMAT);},};const DEFAULT_CURRENCY_FORMAT="[$$]#,##0.00";const EXAMPLE_DATE=parseLiteral("2023/09/26 10:43:00 PM",DEFAULT_LOCALE);const formatCustomCurrency={name:_t("Custom currency"),isVisible:(env)=>env.loadCurrencies!==undefined,execute:(env)=>env.openSidePanel("CustomCurrency",{}),};const formatNumberDate=createFormatActionSpec({name:_t("Date"),descriptionValue:EXAMPLE_DATE,format:(env)=>env.model.getters.getLocale().dateFormat,});const formatNumberTime=createFormatActionSpec({name:_t("Time"),descriptionValue:EXAMPLE_DATE,format:(env)=>env.model.getters.getLocale().timeFormat,});const formatNumberDateTime=createFormatActionSpec({name:_t("Date time"),descriptionValue:EXAMPLE_DATE,format:(env)=>{const locale=env.model.getters.getLocale();return getDateTimeFormat(locale);},});const formatNumberDuration=createFormatActionSpec({name:_t("Duration"),descriptionValue:"27:51:38",format:"hhhh:mm:ss",});const moreFormats={name:_t("More date formats"),execute:(env)=>env.openSidePanel("MoreFormats",{}),};const formatNumberFullDateTime=createFormatActionSpec({name:_t("Full date time"),format:"dddd d mmmm yyyy hh:mm:ss a",descriptionValue:EXAMPLE_DATE,});const formatNumberFullWeekDayAndMonth=createFormatActionSpec({name:_t("Full week day and month"),format:"dddd d mmmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberDayAndFullMonth=createFormatActionSpec({name:_t("Day and full month"),format:"d mmmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberShortWeekDay=createFormatActionSpec({name:_t("Short week day"),format:"ddd d mmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberDayAndShortMonth=createFormatActionSpec({name:_t("Day and short month"),format:"d mmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberFullMonth=createFormatActionSpec({name:_t("Full month"),format:"mmmm yyyy",descriptionValue:EXAMPLE_DATE,});const formatNumberShortMonth=createFormatActionSpec({name:_t("Short month"),format:"mmm yyyy",descriptionValue:EXAMPLE_DATE,});const incraseDecimalPlaces={name:_t("Increase decimal places"),icon:"o-spreadsheet-Icon.INCREASE_DECIMAL",execute:(env)=>env.model.dispatch("SET_DECIMAL",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),step:1,}),};const decraseDecimalPlaces={name:_t("Decrease decimal places"),icon:"o-spreadsheet-Icon.DECRASE_DECIMAL",execute:(env)=>env.model.dispatch("SET_DECIMAL",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),step:-1,}),};const formatBold={name:_t("Bold"),description:"Ctrl+B",execute:(env)=>setStyle(env,{bold:!env.model.getters.getCurrentStyle().bold}),icon:"o-spreadsheet-Icon.BOLD",isActive:(env)=>!!env.model.getters.getCurrentStyle().bold,};const formatItalic={name:_t("Italic"),description:"Ctrl+I",execute:(env)=>setStyle(env,{italic:!env.model.getters.getCurrentStyle().italic}),icon:"o-spreadsheet-Icon.ITALIC",isActive:(env)=>!!env.model.getters.getCurrentStyle().italic,};const formatUnderline={name:_t("Underline"),description:"Ctrl+U",execute:(env)=>setStyle(env,{underline:!env.model.getters.getCurrentStyle().underline}),icon:"o-spreadsheet-Icon.UNDERLINE",isActive:(env)=>!!env.model.getters.getCurrentStyle().underline,};const formatStrikethrough={name:_t("Strikethrough"),execute:(env)=>setStyle(env,{strikethrough:!env.model.getters.getCurrentStyle().strikethrough}),icon:"o-spreadsheet-Icon.STRIKE",isActive:(env)=>!!env.model.getters.getCurrentStyle().strikethrough,};const formatFontSize={name:_t("Font size"),children:fontSizeMenuBuilder(),icon:"o-spreadsheet-Icon.FONT_SIZE",};const formatAlignment={name:_t("Alignment"),icon:"o-spreadsheet-Icon.ALIGN_LEFT",};const formatAlignmentHorizontal={name:_t("Horizontal align"),icon:(env)=>getHorizontalAlignmentIcon(env),};const formatAlignmentLeft={name:_t("Left"),description:"Ctrl+Shift+L",execute:(env)=>setStyle(env,{align:"left"}),isActive:(env)=>getHorizontalAlign(env)==="left",icon:"o-spreadsheet-Icon.ALIGN_LEFT",};const formatAlignmentCenter={name:_t("Center"),description:"Ctrl+Shift+E",execute:(env)=>setStyle(env,{align:"center"}),isActive:(env)=>getHorizontalAlign(env)==="center",icon:"o-spreadsheet-Icon.ALIGN_CENTER",};const formatAlignmentRight={name:_t("Right"),description:"Ctrl+Shift+R",execute:(env)=>setStyle(env,{align:"right"}),isActive:(env)=>getHorizontalAlign(env)==="right",icon:"o-spreadsheet-Icon.ALIGN_RIGHT",};const formatAlignmentVertical={name:_t("Vertical align"),icon:(env)=>getVerticalAlignmentIcon(env),};const formatAlignmentTop={name:_t("Top"),execute:(env)=>setStyle(env,{verticalAlign:"top"}),isActive:(env)=>getVerticalAlign(env)==="top",icon:"o-spreadsheet-Icon.ALIGN_TOP",};const formatAlignmentMiddle={name:_t("Middle"),execute:(env)=>setStyle(env,{verticalAlign:"middle"}),isActive:(env)=>getVerticalAlign(env)==="middle",icon:"o-spreadsheet-Icon.ALIGN_MIDDLE",};const formatAlignmentBottom={name:_t("Bottom"),execute:(env)=>setStyle(env,{verticalAlign:"bottom"}),isActive:(env)=>getVerticalAlign(env)==="bottom",icon:"o-spreadsheet-Icon.ALIGN_BOTTOM",};const formatWrappingIcon={name:_t("Wrapping"),icon:"o-spreadsheet-Icon.WRAPPING_OVERFLOW",};const formatWrapping={name:_t("Wrapping"),icon:(env)=>getWrapModeIcon(env),};const formatWrappingOverflow={name:_t("Overflow"),execute:(env)=>setStyle(env,{wrapping:"overflow"}),isActive:(env)=>getWrappingMode(env)==="overflow",icon:"o-spreadsheet-Icon.WRAPPING_OVERFLOW",};const formatWrappingWrap={name:_t("Wrap"),execute:(env)=>setStyle(env,{wrapping:"wrap"}),isActive:(env)=>getWrappingMode(env)==="wrap",icon:"o-spreadsheet-Icon.WRAPPING_WRAP",};const formatWrappingClip={name:_t("Clip"),execute:(env)=>setStyle(env,{wrapping:"clip"}),isActive:(env)=>getWrappingMode(env)==="clip",icon:"o-spreadsheet-Icon.WRAPPING_CLIP",};const textColor={name:_t("Text Color"),icon:"o-spreadsheet-Icon.TEXT_COLOR",};const fillColor={name:_t("Fill Color"),icon:"o-spreadsheet-Icon.FILL_COLOR",};const formatCF={name:_t("Conditional formatting"),execute:OPEN_CF_SIDEPANEL_ACTION,icon:"o-spreadsheet-Icon.CONDITIONAL_FORMAT",};const clearFormat={name:_t("Clear formatting"),description:"Ctrl+<",execute:(env)=>env.model.dispatch("CLEAR_FORMATTING",{sheetId:env.model.getters.getActiveSheetId(),target:env.model.getters.getSelectedZones(),}),icon:"o-spreadsheet-Icon.CLEAR_FORMAT",};function fontSizeMenuBuilder(){return FONT_SIZES.map((fs)=>{return{name:fs.toString(),sequence:fs,id:`font_size_${fs}`,execute:(env)=>setStyle(env,{fontSize:fs}),isActive:(env)=>isFontSizeSelected(env,fs),};});}
function isAutomaticFormatSelected(env){const activeCell=env.model.getters.getCell(env.model.getters.getActivePosition());return!activeCell||!activeCell.format;}
function isFormatSelected(env,format){const activeCell=env.model.getters.getCell(env.model.getters.getActivePosition());return activeCell?.format===format;}
function isFontSizeSelected(env,fontSize){const currentFontSize=env.model.getters.getCurrentStyle().fontSize||DEFAULT_FONT_SIZE;return currentFontSize===fontSize;}
function getHorizontalAlign(env){const style=env.model.getters.getCurrentStyle();if(style.align){return style.align;}
const cell=env.model.getters.getActiveCell();return cell.defaultAlign;}
function getVerticalAlign(env){const style=env.model.getters.getCurrentStyle();if(style.verticalAlign){return style.verticalAlign;}
return DEFAULT_VERTICAL_ALIGN;}
function getWrappingMode(env){const style=env.model.getters.getCurrentStyle();if(style.wrapping){return style.wrapping;}
return DEFAULT_WRAPPING_MODE;}
function getHorizontalAlignmentIcon(env){const horizontalAlign=getHorizontalAlign(env);switch(horizontalAlign){case"right":return"o-spreadsheet-Icon.ALIGN_RIGHT";case"center":return"o-spreadsheet-Icon.ALIGN_CENTER";default:return"o-spreadsheet-Icon.ALIGN_LEFT";}}
function getVerticalAlignmentIcon(env){const verticalAlign=getVerticalAlign(env);switch(verticalAlign){case"top":return"o-spreadsheet-Icon.ALIGN_TOP";case"middle":return"o-spreadsheet-Icon.ALIGN_MIDDLE";default:return"o-spreadsheet-Icon.ALIGN_BOTTOM";}}
function getWrapModeIcon(env){const wrapMode=getWrappingMode(env);switch(wrapMode){case"wrap":return"o-spreadsheet-Icon.WRAPPING_WRAP";case"clip":return"o-spreadsheet-Icon.WRAPPING_CLIP";default:return"o-spreadsheet-Icon.WRAPPING_OVERFLOW";}}
var ACTION_FORMAT=Object.freeze({__proto__:null,clearFormat:clearFormat,decraseDecimalPlaces:decraseDecimalPlaces,fillColor:fillColor,formatAlignment:formatAlignment,formatAlignmentBottom:formatAlignmentBottom,formatAlignmentCenter:formatAlignmentCenter,formatAlignmentHorizontal:formatAlignmentHorizontal,formatAlignmentLeft:formatAlignmentLeft,formatAlignmentMiddle:formatAlignmentMiddle,formatAlignmentRight:formatAlignmentRight,formatAlignmentTop:formatAlignmentTop,formatAlignmentVertical:formatAlignmentVertical,formatBold:formatBold,formatCF:formatCF,formatCustomCurrency:formatCustomCurrency,formatFontSize:formatFontSize,formatItalic:formatItalic,formatNumberAutomatic:formatNumberAutomatic,formatNumberCurrency:formatNumberCurrency,formatNumberCurrencyRounded:formatNumberCurrencyRounded,formatNumberDate:formatNumberDate,formatNumberDateTime:formatNumberDateTime,formatNumberDayAndFullMonth:formatNumberDayAndFullMonth,formatNumberDayAndShortMonth:formatNumberDayAndShortMonth,formatNumberDuration:formatNumberDuration,formatNumberFullDateTime:formatNumberFullDateTime,formatNumberFullMonth:formatNumberFullMonth,formatNumberFullWeekDayAndMonth:formatNumberFullWeekDayAndMonth,formatNumberNumber:formatNumberNumber,formatNumberPercent:formatNumberPercent,formatNumberShortMonth:formatNumberShortMonth,formatNumberShortWeekDay:formatNumberShortWeekDay,formatNumberTime:formatNumberTime,formatPercent:formatPercent,formatStrikethrough:formatStrikethrough,formatUnderline:formatUnderline,formatWrapping:formatWrapping,formatWrappingClip:formatWrappingClip,formatWrappingIcon:formatWrappingIcon,formatWrappingOverflow:formatWrappingOverflow,formatWrappingWrap:formatWrappingWrap,incraseDecimalPlaces:incraseDecimalPlaces,moreFormats:moreFormats,textColor:textColor});const colMenuRegistry=new MenuItemRegistry();colMenuRegistry.add("cut",{...cut,sequence:10,}).add("copy",{...copy,sequence:20,}).add("paste",{...paste,sequence:30,}).add("paste_special",{...pasteSpecial,sequence:40,separator:true,}).addChild("paste_value_only",["paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_format_only",["paste_special"],{...pasteSpecialFormat,sequence:20,}).add("sort_columns",{...sortRange,name:(env)=>env.model.getters.getActiveCols().size>1?_t("Sort columns"):_t("Sort column"),sequence:50,separator:true,}).addChild("sort_ascending",["sort_columns"],{...sortAscending,sequence:10,}).addChild("sort_descending",["sort_columns"],{...sortDescending,sequence:20,}).add("add_column_before",{...colInsertColsBefore,sequence:70,}).add("add_column_after",{...colInsertColsAfter,sequence:80,}).add("delete_column",{...deleteCols,sequence:90,icon:"o-spreadsheet-Icon.DELETE",}).add("clear_column",{...clearCols,sequence:100,icon:"o-spreadsheet-Icon.CLEAR",}).add("hide_columns",{...hideCols,sequence:105,separator:true,}).add("unhide_columns",{...unhideCols,sequence:106,separator:true,}).add("conditional_formatting",{...formatCF,sequence:110,separator:true,}).add("group_columns",{sequence:120,...groupColumns,}).add("ungroup_columns",{sequence:130,...ungroupColumns,isVisible:(env)=>canUngroupHeaders(env,"COL"),});const numberFormatMenuRegistry=new MenuItemRegistry();numberFormatMenuRegistry.add("format_number_automatic",{...formatNumberAutomatic,sequence:10,separator:true,}).add("format_number_number",{...formatNumberNumber,sequence:20,}).add("format_number_percent",{...formatNumberPercent,sequence:30,separator:true,}).add("format_number_currency",{...formatNumberCurrency,sequence:40,}).add("format_number_currency_rounded",{...formatNumberCurrencyRounded,sequence:50,}).add("format_custom_currency",{...formatCustomCurrency,sequence:60,separator:true,}).add("format_number_date",{...formatNumberDate,sequence:70,}).add("format_number_time",{...formatNumberTime,sequence:80,}).add("format_number_date_time",{...formatNumberDateTime,sequence:90,}).add("format_number_duration",{...formatNumberDuration,sequence:100,separator:true,}).add("more_formats",{...moreFormats,sequence:110,});const formatNumberMenuItemSpec={name:_t("More formats"),icon:"o-spreadsheet-Icon.NUMBER_FORMATS",children:[()=>numberFormatMenuRegistry.getAll()],};const rowMenuRegistry=new MenuItemRegistry();rowMenuRegistry.add("cut",{...cut,sequence:10,}).add("copy",{...copy,sequence:20,}).add("paste",{...paste,sequence:30,}).add("paste_special",{...pasteSpecial,sequence:40,separator:true,}).addChild("paste_value_only",["paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_format_only",["paste_special"],{...pasteSpecialFormat,sequence:20,}).add("add_row_before",{...rowInsertRowBefore,sequence:50,}).add("add_row_after",{...rowInsertRowsAfter,sequence:60,}).add("delete_row",{...deleteRows,sequence:70,icon:"o-spreadsheet-Icon.DELETE",}).add("clear_row",{...clearRows,sequence:80,icon:"o-spreadsheet-Icon.CLEAR",}).add("hide_rows",{...hideRows,sequence:85,separator:true,}).add("unhide_rows",{...unhideRows,sequence:86,separator:true,}).add("conditional_formatting",{...formatCF,sequence:90,separator:true,}).add("group_rows",{sequence:100,...groupRows,}).add("ungroup_rows",{sequence:110,...ungroupRows,isVisible:(env)=>canUngroupHeaders(env,"ROW"),});function getSheetMenuRegistry(args){const sheetMenuRegistry=new MenuItemRegistry();sheetMenuRegistry.add("delete",{...deleteSheet,sequence:10,}).add("duplicate",{...duplicateSheet,sequence:20,}).add("rename",{...renameSheet(args),sequence:30,}).add("move_right",{...sheetMoveRight,sequence:40,}).add("move_left",{...sheetMoveLeft,sequence:50,}).add("hide_sheet",{...hideSheet,sequence:60,});return sheetMenuRegistry;}
const topbarMenuRegistry=new MenuItemRegistry();topbarMenuRegistry.add("file",{name:_t("File"),sequence:10,}).addChild("settings",["file"],{name:_t("Settings"),sequence:100,execute:(env)=>env.openSidePanel("Settings"),icon:"o-spreadsheet-Icon.COG",}).add("edit",{name:_t("Edit"),sequence:20,}).addChild("undo",["edit"],{...undo,sequence:10,}).addChild("redo",["edit"],{...redo,sequence:20,separator:true,}).addChild("copy",["edit"],{...copy,sequence:30,}).addChild("cut",["edit"],{...cut,sequence:40,}).addChild("paste",["edit"],{...paste,sequence:50,}).addChild("paste_special",["edit"],{...pasteSpecial,sequence:60,separator:true,}).addChild("paste_special_value",["edit","paste_special"],{...pasteSpecialValue,sequence:10,}).addChild("paste_special_format",["edit","paste_special"],{...pasteSpecialFormat,sequence:20,}).addChild("find_and_replace",["edit"],{...findAndReplace,sequence:65,separator:true,}).addChild("delete",["edit"],{name:_t("Delete"),icon:"o-spreadsheet-Icon.DELETE",sequence:70,}).addChild("edit_delete_cell_values",["edit","delete"],{...deleteValues,sequence:10,}).addChild("edit_delete_row",["edit","delete"],{...deleteRows,sequence:20,}).addChild("edit_delete_column",["edit","delete"],{...deleteCols,sequence:30,}).addChild("edit_delete_cell_shift_up",["edit","delete"],{...deleteCellShiftUp,sequence:40,}).addChild("edit_delete_cell_shift_left",["edit","delete"],{...deleteCellShiftLeft,sequence:50,}).addChild("edit_unhide_columns",["edit"],{...unhideAllCols,sequence:80,}).addChild("edit_unhide_rows",["edit"],{...unhideAllRows,sequence:80,}).add("view",{name:_t("View"),sequence:30,}).addChild("unfreeze_panes",["view"],{...unFreezePane,sequence:4,}).addChild("freeze_panes",["view"],{...freezePane,sequence:5,}).addChild("unfreeze_rows",["view","freeze_panes"],{...unFreezeRows,sequence:5,}).addChild("freeze_first_row",["view","freeze_panes"],{...freezeFirstRow,sequence:10,}).addChild("freeze_second_row",["view","freeze_panes"],{...freezeSecondRow,sequence:15,}).addChild("freeze_current_row",["view","freeze_panes"],{...freezeCurrentRow,sequence:20,separator:true,}).addChild("unfreeze_columns",["view","freeze_panes"],{...unFreezeCols,sequence:25,}).addChild("freeze_first_col",["view","freeze_panes"],{...freezeFirstCol,sequence:30,}).addChild("freeze_second_col",["view","freeze_panes"],{...freezeSecondCol,sequence:35,}).addChild("freeze_current_col",["view","freeze_panes"],{...freezeCurrentCol,sequence:40,}).addChild("group_headers",["view"],{name:_t("Group"),sequence:15,separator:true,icon:"o-spreadsheet-Icon.PLUS_IN_BOX",isVisible:IS_ONLY_ONE_RANGE,}).addChild("group_columns",["view","group_headers"],{...groupColumns,sequence:5,}).addChild("ungroup_columns",["view","group_headers"],{...ungroupColumns,isVisible:(env)=>canUngroupHeaders(env,"COL"),sequence:10,}).addChild("group_rows",["view","group_headers"],{...groupRows,sequence:15,}).addChild("ungroup_rows",["view","group_headers"],{...ungroupRows,isVisible:(env)=>canUngroupHeaders(env,"ROW"),sequence:20,}).addChild("view_gridlines",["view"],{...viewGridlines,sequence:15,}).addChild("view_formulas",["view"],{...viewFormulas,sequence:20,}).add("insert",{name:_t("Insert"),sequence:40,}).addChild("insert_row",["insert"],{...insertRow,sequence:10,}).addChild("insert_row_before",["insert","insert_row"],{...topBarInsertRowsBefore,sequence:10,}).addChild("insert_row_after",["insert","insert_row"],{...topBarInsertRowsAfter,sequence:20,}).addChild("insert_column",["insert"],{...insertCol,sequence:20,}).addChild("insert_column_before",["insert","insert_column"],{...topBarInsertColsBefore,sequence:10,}).addChild("insert_column_after",["insert","insert_column"],{...topBarInsertColsAfter,sequence:20,}).addChild("insert_cell",["insert"],{...insertCell,sequence:43,}).addChild("insert_cell_down",["insert","insert_cell"],{...insertCellShiftDown,name:_t("Shift down"),sequence:10,}).addChild("insert_cell_right",["insert","insert_cell"],{...insertCellShiftRight,name:_t("Shift right"),sequence:20,}).addChild("insert_sheet",["insert"],{...insertSheet,sequence:80,separator:true,}).addChild("insert_chart",["insert"],{...insertChart,sequence:50,}).addChild("insert_image",["insert"],{...insertImage,sequence:55,}).addChild("insert_function",["insert"],{...insertFunction,sequence:60,}).addChild("insert_function_sum",["insert","insert_function"],{...insertFunctionSum,sequence:0,}).addChild("insert_function_average",["insert","insert_function"],{...insertFunctionAverage,sequence:10,}).addChild("insert_function_count",["insert","insert_function"],{...insertFunctionCount,sequence:20,}).addChild("insert_function_max",["insert","insert_function"],{...insertFunctionMax,sequence:30,}).addChild("insert_function_min",["insert","insert_function"],{...insertFunctionMin,sequence:40,separator:true,}).addChild("categorie_function_all",["insert","insert_function"],{...categorieFunctionAll,sequence:50,}).addChild("categories_function_list",["insert","insert_function"],categoriesFunctionListMenuBuilder).addChild("insert_link",["insert"],{...insertLink,separator:true,sequence:70,}).add("format",{name:_t("Format"),sequence:50}).addChild("format_number",["format"],{...formatNumberMenuItemSpec,name:_t("Number"),sequence:10,separator:true,}).addChild("format_bold",["format"],{...formatBold,sequence:20,}).addChild("format_italic",["format"],{...formatItalic,sequence:30,}).addChild("format_underline",["format"],{...formatUnderline,sequence:40,}).addChild("format_strikethrough",["format"],{...formatStrikethrough,sequence:50,separator:true,}).addChild("format_font_size",["format"],{...formatFontSize,sequence:60,separator:true,}).addChild("format_alignment",["format"],{...formatAlignment,sequence:70,}).addChild("format_alignment_left",["format","format_alignment"],{...formatAlignmentLeft,sequence:10,}).addChild("format_alignment_center",["format","format_alignment"],{...formatAlignmentCenter,sequence:20,}).addChild("format_alignment_right",["format","format_alignment"],{...formatAlignmentRight,sequence:30,separator:true,}).addChild("format_alignment_top",["format","format_alignment"],{...formatAlignmentTop,sequence:40,}).addChild("format_alignment_middle",["format","format_alignment"],{...formatAlignmentMiddle,sequence:50,}).addChild("format_alignment_bottom",["format","format_alignment"],{...formatAlignmentBottom,sequence:60,separator:true,}).addChild("format_wrapping",["format"],{...formatWrappingIcon,sequence:80,separator:true,}).addChild("format_wrapping_overflow",["format","format_wrapping"],{...formatWrappingOverflow,sequence:10,}).addChild("format_wrapping_wrap",["format","format_wrapping"],{...formatWrappingWrap,sequence:20,}).addChild("format_wrapping_clip",["format","format_wrapping"],{...formatWrappingClip,sequence:30,}).addChild("format_cf",["format"],{...formatCF,sequence:90,separator:true,}).addChild("format_clearFormat",["format"],{...clearFormat,sequence:100,separator:true,}).add("data",{name:_t("Data"),sequence:60,}).addChild("sort_range",["data"],{...sortRange,sequence:10,separator:true,}).addChild("sort_ascending",["data","sort_range"],{...sortAscending,sequence:10,}).addChild("sort_descending",["data","sort_range"],{...sortDescending,sequence:20,}).addChild("data_cleanup",["data"],{...dataCleanup,sequence:15,}).addChild("remove_duplicates",["data","data_cleanup"],{...removeDuplicates,sequence:10,}).addChild("trim_whitespace",["data","data_cleanup"],{...trimWhitespace,sequence:20,}).addChild("split_to_columns",["data"],{...splitToColumns,sequence:20,}).addChild("data_validation",["data"],{name:_t("Data Validation"),execute:(env)=>{env.openSidePanel("DataValidation");},icon:"o-spreadsheet-Icon.DATA_VALIDATION",sequence:30,separator:true,}).addChild("add_remove_data_filter",["data"],{...addRemoveDataFilter,sequence:40,separator:true,});class OTRegistry extends Registry{addTransformation(executed,toTransforms,fn){for(let toTransform of toTransforms){if(!this.content[toTransform]){this.content[toTransform]=new Map();}
this.content[toTransform].set(executed,fn);}
return this;}
getTransformation(toTransform,executed){return this.content[toTransform]&&this.content[toTransform].get(executed);}}
const otRegistry=new OTRegistry();const arrowMap={ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",};function updateSelectionWithArrowKeys(ev,selection){const direction=arrowMap[ev.key];if(ev.shiftKey){selection.resizeAnchorZone(direction,isCtrlKey(ev)?"end":1);}
else{selection.moveAnchorCell(direction,isCtrlKey(ev)?"end":1);}}
const uuidGenerator$1=new UuidGenerator();css`
  .o-selection {
    .o-selection-input {
      padding: 2px 0px;

      input {
        padding: 4px 6px;
        border-radius: 4px;
        box-sizing: border-box;
      }
      input:focus {
        outline: none;
      }
      input.o-required,
      input.o-focused {
        border: 1px solid;
      }
      input.o-focused {
        border-width: 2px;
        padding: 3px 5px;
      }
      input.o-invalid {
        /* The background-color is similar to the bootstrap alert-danger class but, because of the commit 0358a76d,
         * which avoids being parasitized by the dark-mode in spreadsheet, we cannot use this class.
         * TODO: Replace with the bootstrap alert-danger class when we support dark mode
         */
        background-color: #ffdddd;
        border-width: 2px;
      }
      button.o-btn {
        color: #333;
      }
      button.o-btn-action {
        margin: 8px 1px;
        border-radius: 4px;
        border: 1px solid #dadce0;
        color: #188038;
        font-size: 14px;
        height: 25px;
      }
      .error-icon {
        right: 7px;
        top: 7px;
      }
    }
    /** Make the character a bit bigger
    compared to its neighbor INPUT box  */
    .o-remove-selection {
      font-size: calc(100% + 4px);
    }
  }
`;class SelectionInput extends owl.Component{static template="o-spreadsheet-SelectionInput";id=uuidGenerator$1.uuidv4();previousRanges=this.props.ranges()||[];originSheet=this.env.model.getters.getActiveSheetId();state=owl.useState({isMissing:false,mode:"select-range",});focusedInput=owl.useRef("focusedInput");get ranges(){const existingSelectionRanges=this.env.model.getters.getSelectionInput(this.id);const ranges=existingSelectionRanges.length?existingSelectionRanges:this.props.ranges().map((xc,id)=>({xc,id:id+1,isFocused:false,}));return ranges.map((range)=>({...range,isValidRange:range.xc===""||this.env.model.getters.isRangeValid(range.xc),}));}
get hasFocus(){return this.ranges.filter((i)=>i.isFocused).length>0;}
get canAddRange(){return!this.props.hasSingleRange;}
get isInvalid(){return this.props.isInvalid||this.state.isMissing;}
get isConfirmable(){return this.hasFocus&&this.ranges.every((range)=>range.isValidRange);}
get isResettable(){return this.previousRanges.join()!==this.ranges.map((r)=>r.xc).join();}
setup(){owl.useEffect(()=>this.focusedInput.el?.focus(),()=>[this.focusedInput.el]);owl.onMounted(()=>this.enableNewSelectionInput());owl.onWillUnmount(async()=>this.disableNewSelectionInput());owl.onPatched(()=>this.checkChange());}
enableNewSelectionInput(){this.env.model.dispatch("ENABLE_NEW_SELECTION_INPUT",{id:this.id,initialRanges:this.props.ranges(),hasSingleRange:this.props.hasSingleRange,});}
disableNewSelectionInput(){this.env.model.dispatch("DISABLE_SELECTION_INPUT",{id:this.id});}
checkChange(){const value=this.env.model.getters.getSelectionInputValue(this.id);const valid=!this.isInvalid&&this.ranges.every((range)=>range.isValidRange);if(valid&&this.previousRanges.join()!==value.join()){this.triggerChange();}}
getColor(range){const color=range.color||"#000";return"color: "+color+";";}
triggerChange(){const ranges=this.env.model.getters.getSelectionInputValue(this.id);this.props.onSelectionChanged?.(ranges);}
onKeydown(ev){if(ev.key==="F2"){ev.preventDefault();ev.stopPropagation();this.state.mode=this.state.mode==="select-range"?"text-edit":"select-range";}
else if(ev.key.startsWith("Arrow")){ev.stopPropagation();if(this.state.mode==="select-range"){ev.preventDefault();updateSelectionWithArrowKeys(ev,this.env.model.selection);}}
else if(ev.key==="Enter"){const target=ev.target;target.blur();this.confirm();}}
extractRanges(value){return this.props.hasSingleRange?value.split(",")[0]:value;}
focus(rangeId){this.state.isMissing=false;this.state.mode="select-range";this.env.model.dispatch("FOCUS_RANGE",{id:this.id,rangeId,});}
addEmptyInput(){this.env.model.dispatch("ADD_EMPTY_RANGE",{id:this.id});}
removeInput(rangeId){this.env.model.dispatch("REMOVE_RANGE",{id:this.id,rangeId});this.triggerChange();this.props.onSelectionConfirmed?.();}
onInputChanged(rangeId,ev){const target=ev.target;const value=this.extractRanges(target.value);this.env.model.dispatch("CHANGE_RANGE",{id:this.id,rangeId,value,});this.triggerChange();}
reset(){this.env.model.dispatch("ENABLE_NEW_SELECTION_INPUT",{id:this.id,initialRanges:this.previousRanges,hasSingleRange:this.props.hasSingleRange,});this.confirm();}
confirm(){let anyValidInput=false;const existingSelectionRanges=this.env.model.getters.getSelectionInput(this.id);const existingSelectionXcs=[];for(const range of existingSelectionRanges){if(range.xc===""){const result=this.env.model.dispatch("REMOVE_RANGE",{id:this.id,rangeId:range.id,});if(result.isSuccessful){continue;}}
existingSelectionXcs.push(range.xc);if(this.env.model.getters.isRangeValid(range.xc)){anyValidInput=true;}}
if(this.props.required&&!anyValidInput){this.state.isMissing=true;}
const activeSheetId=this.env.model.getters.getActiveSheetId();if(this.originSheet!==activeSheetId){this.env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:activeSheetId,sheetIdTo:this.originSheet,});}
this.props.onSelectionChanged?.(existingSelectionXcs);this.props.onSelectionConfirmed?.();this.previousRanges=this.props.ranges();if(existingSelectionXcs.join()!==this.previousRanges.join()){this.enableNewSelectionInput();}
this.env.model.dispatch("UNFOCUS_SELECTION_INPUT");}}
SelectionInput.props={ranges:Function,hasSingleRange:{type:Boolean,optional:true},required:{type:Boolean,optional:true},isInvalid:{type:Boolean,optional:true},class:{type:String,optional:true},onSelectionChanged:{type:Function,optional:true},onSelectionConfirmed:{type:Function,optional:true},};css`
  .o-validation-error,
  .o-validation-warning {
    margin-top: 10px;

    .o-icon {
      margin-right: 5px;
      height: 1.2em;
      width: 1.2em;
    }
  }
`;class ValidationMessages extends owl.Component{static template="o-spreadsheet-ValidationMessages";get divClasses(){if(this.props.msgType==="warning"){return"o-validation-warning text-warning";}
return"o-validation-error text-danger";}}
ValidationMessages.props={messages:Array,msgType:String,};class LineBarPieConfigPanel extends owl.Component{static template="o-spreadsheet-LineBarPieConfigPanel";static components={SelectionInput,ValidationMessages};state=owl.useState({datasetDispatchResult:undefined,labelsDispatchResult:undefined,});dataSeriesRanges=[];labelRange;setup(){this.dataSeriesRanges=this.props.definition.dataSets;this.labelRange=this.props.definition.labelRange;}
get errorMessages(){const cancelledReasons=[...(this.state.datasetDispatchResult?.reasons||[]),...(this.state.labelsDispatchResult?.reasons||[]),];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
get isDatasetInvalid(){return!!this.state.datasetDispatchResult?.isCancelledBecause("InvalidDataSet");}
get isLabelInvalid(){return!!this.state.labelsDispatchResult?.isCancelledBecause("InvalidLabelRange");}
onUpdateDataSetsHaveTitle(ev){this.props.updateChart(this.props.figureId,{dataSetsHaveTitle:ev.target.checked,});}
onDataSeriesRangesChanged(ranges){this.dataSeriesRanges=ranges;this.state.datasetDispatchResult=this.props.canUpdateChart(this.props.figureId,{dataSets:this.dataSeriesRanges,});}
onDataSeriesConfirmed(){this.dataSeriesRanges=spreadRange(this.env.model.getters,this.dataSeriesRanges);this.state.datasetDispatchResult=this.props.updateChart(this.props.figureId,{dataSets:this.dataSeriesRanges,});}
getDataSeriesRanges(){return this.dataSeriesRanges;}
onLabelRangeChanged(ranges){this.labelRange=ranges[0];this.state.labelsDispatchResult=this.props.canUpdateChart(this.props.figureId,{labelRange:this.labelRange,});}
onLabelRangeConfirmed(){this.state.labelsDispatchResult=this.props.updateChart(this.props.figureId,{labelRange:this.labelRange,});}
getLabelRange(){return this.labelRange||"";}
onUpdateAggregated(ev){this.props.updateChart(this.props.figureId,{aggregated:ev.target.checked,});}
calculateHeaderPosition(){if(this.isDatasetInvalid||this.isLabelInvalid){return undefined;}
const getters=this.env.model.getters;const sheetId=getters.getActiveSheetId();const labelRange=createValidRange(getters,sheetId,this.labelRange);const dataSets=createDataSets(getters,this.dataSeriesRanges,sheetId,this.props.definition.dataSetsHaveTitle);if(dataSets.length){return dataSets[0].dataRange.zone.top+1;}
else if(labelRange){return labelRange.zone.top+1;}
return undefined;}}
LineBarPieConfigPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class BarConfigPanel extends LineBarPieConfigPanel{static template="o-spreadsheet-BarConfigPanel";onUpdateStacked(ev){this.props.updateChart(this.props.figureId,{stacked:ev.target.checked,});}
onUpdateAggregated(ev){this.props.updateChart(this.props.figureId,{aggregated:ev.target.checked,});}}
function startDnd(onMouseMove,onMouseUp,onMouseDown=()=>{}){const _onMouseUp=(ev)=>{onMouseUp(ev);window.removeEventListener("mousedown",onMouseDown);window.removeEventListener("mouseup",_onMouseUp);window.removeEventListener("dragstart",_onDragStart);window.removeEventListener("mousemove",onMouseMove);window.removeEventListener("wheel",onMouseMove);};function _onDragStart(ev){ev.preventDefault();}
window.addEventListener("mousedown",onMouseDown);window.addEventListener("mouseup",_onMouseUp);window.addEventListener("dragstart",_onDragStart);window.addEventListener("mousemove",onMouseMove);window.addEventListener("wheel",onMouseMove,{passive:false});}
function dragAndDropBeyondTheViewport(env,cbMouseMove,cbMouseUp,only=false){let timeOutId=null;let currentEv;let previousEv;let startingEv;let startingX;let startingY;const getters=env.model.getters;const sheetId=getters.getActiveSheetId();const position=gridOverlayPosition();let colIndex;let rowIndex;const onMouseDown=(ev)=>{previousEv=ev;startingEv=ev;startingX=startingEv.clientX-position.left;startingY=startingEv.clientY-position.top;};const onMouseMove=(ev)=>{currentEv=ev;if(timeOutId){return;}
const{x:offsetCorrectionX,y:offsetCorrectionY}=getters.getMainViewportCoordinates();let{top,left,bottom,right}=getters.getActiveMainViewport();let{scrollX,scrollY}=getters.getActiveSheetDOMScrollInfo();const{xSplit,ySplit}=getters.getPaneDivisions(sheetId);let canEdgeScroll=false;let timeoutDelay=MAX_DELAY;const x=currentEv.clientX-position.left;colIndex=getters.getColIndex(x);if(only!=="vertical"){const previousX=previousEv.clientX-position.left;const edgeScrollInfoX=getters.getEdgeScrollCol(x,previousX,startingX);if(edgeScrollInfoX.canEdgeScroll){canEdgeScroll=true;timeoutDelay=Math.min(timeoutDelay,edgeScrollInfoX.delay);let newTarget;switch(edgeScrollInfoX.direction){case"reset":colIndex=xSplit;newTarget=xSplit;break;case 1:colIndex=right;newTarget=left+1;break;case-1:colIndex=left-1;while(env.model.getters.isColHidden(sheetId,colIndex)){colIndex--;}
newTarget=colIndex;break;}
scrollX=getters.getColDimensions(sheetId,newTarget).start-offsetCorrectionX;}}
const y=currentEv.clientY-position.top;rowIndex=getters.getRowIndex(y);if(only!=="horizontal"){const previousY=previousEv.clientY-position.top;const edgeScrollInfoY=getters.getEdgeScrollRow(y,previousY,startingY);if(edgeScrollInfoY.canEdgeScroll){canEdgeScroll=true;timeoutDelay=Math.min(timeoutDelay,edgeScrollInfoY.delay);let newTarget;switch(edgeScrollInfoY.direction){case"reset":rowIndex=ySplit;newTarget=ySplit;break;case 1:rowIndex=bottom;newTarget=top+edgeScrollInfoY.direction;break;case-1:rowIndex=top-1;while(env.model.getters.isRowHidden(sheetId,rowIndex)){rowIndex--;}
newTarget=rowIndex;break;}
scrollY=env.model.getters.getRowDimensions(sheetId,newTarget).start-offsetCorrectionY;}}
if(!canEdgeScroll){if(rowIndex===-1){rowIndex=y<0?0:getters.getNumberRows(sheetId)-1;}
if(colIndex===-1&&x<0){colIndex=x<0?0:getters.getNumberCols(sheetId)-1;}}
cbMouseMove(colIndex,rowIndex,currentEv);if(canEdgeScroll){env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX,offsetY:scrollY});timeOutId=setTimeout(()=>{timeOutId=null;onMouseMove(currentEv);},Math.round(timeoutDelay));}
previousEv=currentEv;};const onMouseUp=()=>{clearTimeout(timeOutId);cbMouseUp();};startDnd(onMouseMove,onMouseUp,onMouseDown);}
const LINE_VERTICAL_PADDING=1;const PICKER_PADDING=8;const ITEM_BORDER_WIDTH=1;const ITEM_EDGE_LENGTH=18;const ITEMS_PER_LINE=10;const MAGNIFIER_EDGE=16;const ITEM_GAP=2;const CONTENT_WIDTH=ITEMS_PER_LINE*(ITEM_EDGE_LENGTH+2*ITEM_BORDER_WIDTH)+(ITEMS_PER_LINE-1)*ITEM_GAP;const INNER_GRADIENT_WIDTH=CONTENT_WIDTH-2*ITEM_BORDER_WIDTH;const INNER_GRADIENT_HEIGHT=CONTENT_WIDTH-30-2*ITEM_BORDER_WIDTH;const CONTAINER_WIDTH=CONTENT_WIDTH+2*PICKER_PADDING;css`
  .o-color-picker {
    padding: ${PICKER_PADDING}px 0;
    /** FIXME: this is useless, overiden by the popover container */
    box-shadow: 1px 2px 5px 2px rgba(51, 51, 51, 0.15);
    background-color: white;
    line-height: 1.2;
    overflow-y: auto;
    overflow-x: hidden;
    width: ${CONTAINER_WIDTH}px;

    .o-color-picker-section-name {
      margin: 0px ${ITEM_BORDER_WIDTH}px;
      padding: 4px ${PICKER_PADDING}px;
    }
    .colors-grid {
      display: grid;
      padding: ${LINE_VERTICAL_PADDING}px ${PICKER_PADDING}px;
      grid-template-columns: repeat(${ITEMS_PER_LINE}, 1fr);
      grid-gap: ${ITEM_GAP}px;
    }
    .o-color-picker-toggler-button {
      display: flex;
      .o-color-picker-toggler-sign {
        display: flex;
        margin: auto auto;
        width: 55%;
        height: 55%;
        .o-icon {
          width: 100%;
          height: 100%;
        }
      }
    }
    .o-color-picker-line-item {
      width: ${ITEM_EDGE_LENGTH}px;
      height: ${ITEM_EDGE_LENGTH}px;
      margin: 0px;
      border-radius: 50px;
      border: ${ITEM_BORDER_WIDTH}px solid #666666;
      padding: 0px;
      font-size: 16px;
      background: white;
      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
        outline: 1px solid gray;
        cursor: pointer;
      }
    }
    .o-buttons {
      padding: ${PICKER_PADDING}px;
      display: flex;
      .o-cancel {
        border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
        width: 100%;
        padding: 5px;
        font-size: 14px;
        background: white;
        border-radius: 4px;
        box-sizing: border-box;
        &:hover:enabled {
          background-color: rgba(0, 0, 0, 0.08);
        }
      }
    }
    .o-add-button {
      border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
      padding: 4px;
      background: white;
      border-radius: 4px;
      &:hover:enabled {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
    .o-separator {
      border-bottom: ${MENU_SEPARATOR_BORDER_WIDTH}px solid ${SEPARATOR_COLOR};
      margin-top: ${MENU_SEPARATOR_PADDING}px;
      margin-bottom: ${MENU_SEPARATOR_PADDING}px;
    }

    .o-custom-selector {
      padding: ${PICKER_PADDING + 2}px ${PICKER_PADDING}px;
      position: relative;
      .o-gradient {
        margin-bottom: ${MAGNIFIER_EDGE / 2}px;
        border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
        box-sizing: border-box;
        width: ${INNER_GRADIENT_WIDTH + 2 * ITEM_BORDER_WIDTH}px;
        height: ${INNER_GRADIENT_HEIGHT + 2 * ITEM_BORDER_WIDTH}px;
        position: relative;
      }

      .magnifier {
        height: ${MAGNIFIER_EDGE}px;
        width: ${MAGNIFIER_EDGE}px;
        box-sizing: border-box;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0px 0px 3px #c0c0c0;
        position: absolute;
        z-index: 2;
      }
      .saturation {
        background: linear-gradient(to right, #fff 0%, transparent 100%);
      }
      .lightness {
        background: linear-gradient(to top, #000 0%, transparent 100%);
      }
      .o-hue-picker {
        border: ${ITEM_BORDER_WIDTH}px solid #c0c0c0;
        box-sizing: border-box;
        width: 100%;
        height: 12px;
        border-radius: 4px;
        background: linear-gradient(
          to right,
          hsl(0 100% 50%) 0%,
          hsl(0.2turn 100% 50%) 20%,
          hsl(0.3turn 100% 50%) 30%,
          hsl(0.4turn 100% 50%) 40%,
          hsl(0.5turn 100% 50%) 50%,
          hsl(0.6turn 100% 50%) 60%,
          hsl(0.7turn 100% 50%) 70%,
          hsl(0.8turn 100% 50%) 80%,
          hsl(0.9turn 100% 50%) 90%,
          hsl(1turn 100% 50%) 100%
        );
        position: relative;
        cursor: crosshair;
      }
      .o-hue-slider {
        margin-top: -3px;
      }
      .o-custom-input-preview {
        padding: 2px 0px;
        display: flex;
        input {
          box-sizing: border-box;
          width: 50%;
          border-radius: 4px;
          padding: 4px 23px 4px 10px;
          height: 24px;
          border: 1px solid #c0c0c0;
          margin-right: 2px;
        }
        .o-wrong-color {
          /** FIXME bootstrap class instead? */
          outline-color: red;
          border-color: red;
          &:focus {
            outline-style: solid;
            outline-width: 1px;
          }
        }
      }
      .o-custom-input-buttons {
        padding: 2px 0px;
        display: flex;
        justify-content: end;
      }
      .o-color-preview {
        border: 1px solid #c0c0c0;
        border-radius: 4px;
        width: 50%;
      }
    }
  }
`;class ColorPicker extends owl.Component{static template="o-spreadsheet-ColorPicker";static defaultProps={currentColor:""};static components={Popover};COLORS=COLOR_PICKER_DEFAULTS;state=owl.useState({showGradient:false,currentHslaColor:isColorValid(this.props.currentColor)?{...hexToHSLA(this.props.currentColor),a:1}:{h:0,s:100,l:100,a:1},customHexColor:isColorValid(this.props.currentColor)?toHex(this.props.currentColor):"",});get colorPickerStyle(){if(this.props.maxHeight!==undefined&&this.props.maxHeight<=0){return cssPropertiesToCss({display:"none"});}
return"";}
get popoverProps(){return{anchorRect:this.props.anchorRect,maxHeight:this.props.maxHeight,positioning:"BottomLeft",verticalOffset:0,};}
get gradientHueStyle(){const hue=this.state.currentHslaColor?.h||0;return cssPropertiesToCss({background:`hsl(${hue} 100% 50%)`,});}
get sliderStyle(){const hue=this.state.currentHslaColor?.h||0;const delta=Math.round((hue/360)*INNER_GRADIENT_WIDTH);const left=clip(delta,1,INNER_GRADIENT_WIDTH)-ICON_EDGE_LENGTH/2;return cssPropertiesToCss({"margin-left":`${left}px`,});}
get pointerStyle(){const{s,l}=this.state.currentHslaColor||{s:0,l:0};const left=Math.round(INNER_GRADIENT_WIDTH*clip(s/100,0,1));const top=Math.round(INNER_GRADIENT_HEIGHT*clip(1-(2*l)/(200-s),0,1));return cssPropertiesToCss({left:`${-MAGNIFIER_EDGE / 2 + left}px`,top:`${-MAGNIFIER_EDGE / 2 + top}px`,background:hslaToHex(this.state.currentHslaColor),});}
get colorPreviewStyle(){return cssPropertiesToCss({"background-color":hslaToHex(this.state.currentHslaColor),});}
get checkmarkColor(){return chartFontColor(this.props.currentColor);}
get isHexColorInputValid(){return!this.state.customHexColor||isColorValid(this.state.customHexColor);}
setCustomGradient({x,y}){const offsetX=clip(x,0,INNER_GRADIENT_WIDTH);const offsetY=clip(y,0,INNER_GRADIENT_HEIGHT);const deltaX=offsetX/INNER_GRADIENT_WIDTH;const deltaY=offsetY/INNER_GRADIENT_HEIGHT;const s=100*deltaX;const l=100*(1-deltaY)*(1-0.5*deltaX);this.updateColor({s,l});}
setCustomHue(x){const h=Math.round(clip((360*x)/INNER_GRADIENT_WIDTH,0,359));this.updateColor({h});}
updateColor(newHsl){this.state.currentHslaColor={...this.state.currentHslaColor,...newHsl};this.state.customHexColor=hslaToHex(this.state.currentHslaColor);}
onColorClick(color){if(color){this.props.onColorPicked(toHex(color));}}
resetColor(){this.props.onColorPicked("");}
toggleColorPicker(){this.state.showGradient=!this.state.showGradient;}
dragGradientPointer(ev){const initialGradientCoordinates={x:ev.offsetX,y:ev.offsetY};this.setCustomGradient(initialGradientCoordinates);const initialMousePosition={x:ev.clientX,y:ev.clientY};const onMouseMove=(ev)=>{const currentMousePosition={x:ev.clientX,y:ev.clientY};const deltaX=currentMousePosition.x-initialMousePosition.x;const deltaY=currentMousePosition.y-initialMousePosition.y;const currentGradientCoordinates={x:initialGradientCoordinates.x+deltaX,y:initialGradientCoordinates.y+deltaY,};this.setCustomGradient(currentGradientCoordinates);};startDnd(onMouseMove,()=>{});}
dragHuePointer(ev){const initialX=ev.offsetX;const initialMouseX=ev.clientX;this.setCustomHue(initialX);const onMouseMove=(ev)=>{const currentMouseX=ev.clientX;const deltaX=currentMouseX-initialMouseX;const x=initialX+deltaX;this.setCustomHue(x);};startDnd(onMouseMove,()=>{});}
setHexColor(ev){const val=ev.target.value.slice(0,7);this.state.customHexColor=val;if(!isColorValid(val));else{this.state.currentHslaColor={...hexToHSLA(val),a:1};}}
addCustomColor(ev){if(!isHSLAValid(this.state.currentHslaColor)||!isColorValid(this.state.customHexColor)){return;}
this.props.onColorPicked(toHex(this.state.customHexColor));}
isSameColor(color1,color2){return isSameColor(color1,color2);}}
ColorPicker.props={onColorPicked:Function,currentColor:{type:String,optional:true},maxHeight:{type:Number,optional:true},anchorRect:Object,};css`
  .o-color-picker-widget {
    display: flex;
    position: relative;
    align-items: center;

    .o-color-picker-button-style {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 2px;
      padding: 3px;
      border-radius: 2px;
      cursor: pointer;
      &:not([disabled]):hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    .o-color-picker-button {
      height: 30px;
      > span {
        border-bottom: 4px solid;
        height: 16px;
        margin-top: 2px;
      }

      &[disabled] {
        pointer-events: none;
        opacity: 0.3;
      }
    }
  }
`;class ColorPickerWidget extends owl.Component{static template="o-spreadsheet-ColorPickerWidget";static components={ColorPicker};colorPickerButtonRef=owl.useRef("colorPickerButton");get iconStyle(){return this.props.currentColor?`border-color: ${this.props.currentColor}`:"border-bottom-style: hidden";}
get colorPickerAnchorRect(){const button=this.colorPickerButtonRef.el;const buttonRect=button.getBoundingClientRect();return{x:buttonRect.x,y:buttonRect.y,width:buttonRect.width,height:buttonRect.height,};}}
ColorPickerWidget.props={currentColor:{type:String,optional:true},toggleColorPicker:Function,showColorPicker:Boolean,onColorPicked:Function,icon:String,title:{type:String,optional:true},disabled:{type:Boolean,optional:true},dropdownMaxHeight:{type:Number,optional:true},class:{type:String,optional:true},};class LineBarPieDesignPanel extends owl.Component{static template="o-spreadsheet-LineBarPieDesignPanel";static components={ColorPickerWidget};state=owl.useState({title:"",fillColorTool:false,});onClick(ev){this.state.fillColorTool=false;}
setup(){this.state.title=_t(this.props.definition.title);owl.useExternalListener(window,"click",this.onClick);}
toggleColorPicker(){this.state.fillColorTool=!this.state.fillColorTool;}
updateBackgroundColor(color){this.props.updateChart(this.props.figureId,{background:color,});}
updateTitle(){this.props.updateChart(this.props.figureId,{title:this.state.title,});}
updateSelect(attr,ev){this.props.updateChart(this.props.figureId,{[attr]:ev.target.value,});}}
LineBarPieDesignPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class BarChartDesignPanel extends LineBarPieDesignPanel{static template="o-spreadsheet-BarChartDesignPanel";}
class GaugeChartConfigPanel extends owl.Component{static template="o-spreadsheet-GaugeChartConfigPanel";static components={SelectionInput,ValidationMessages};state=owl.useState({dataRangeDispatchResult:undefined,});dataRange=this.props.definition.dataRange;get configurationErrorMessages(){const cancelledReasons=[...(this.state.dataRangeDispatchResult?.reasons||[])];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
get isDataRangeInvalid(){return!!this.state.dataRangeDispatchResult?.isCancelledBecause("InvalidGaugeDataRange");}
onDataRangeChanged(ranges){this.dataRange=ranges[0];this.state.dataRangeDispatchResult=this.props.canUpdateChart(this.props.figureId,{dataRange:this.dataRange,});}
updateDataRange(){this.state.dataRangeDispatchResult=this.props.updateChart(this.props.figureId,{dataRange:this.dataRange,});}
getDataRange(){return this.dataRange||"";}}
GaugeChartConfigPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};css`
  .o-gauge-color-set {
    table {
      table-layout: fixed;
      margin-top: 2%;
      display: table;
      text-align: left;
      font-size: 12px;
      line-height: 18px;
      width: 100%;
    }
    th.o-gauge-color-set-colorPicker {
      width: 8%;
    }
    th.o-gauge-color-set-text {
      width: 40%;
    }
    th.o-gauge-color-set-value {
      width: 22%;
    }
    th.o-gauge-color-set-type {
      width: 30%;
    }
    input,
    select {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }
  }
`;class GaugeChartDesignPanel extends owl.Component{static template="o-spreadsheet-GaugeChartDesignPanel";static components={ColorPickerWidget,ValidationMessages};state=owl.useState({title:"",openedMenu:undefined,sectionRuleDispatchResult:undefined,sectionRule:deepCopy(this.props.definition.sectionRule),});setup(){this.state.title=_t(this.props.definition.title);owl.useExternalListener(window,"click",this.closeMenus);}
get designErrorMessages(){const cancelledReasons=[...(this.state.sectionRuleDispatchResult?.reasons||[])];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
updateBackgroundColor(color){this.state.openedMenu=undefined;this.props.updateChart(this.props.figureId,{background:color,});}
updateTitle(){this.props.updateChart(this.props.figureId,{title:this.state.title,});}
isRangeMinInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("EmptyGaugeRangeMin")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMinNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMinBiggerThanRangeMax"));}
isRangeMaxInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("EmptyGaugeRangeMax")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMaxNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeRangeMinBiggerThanRangeMax"));}
get isLowerInflectionPointInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeLowerInflectionPointNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeLowerBiggerThanUpper"));}
get isUpperInflectionPointInvalid(){return!!(this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeUpperInflectionPointNaN")||this.state.sectionRuleDispatchResult?.isCancelledBecause("GaugeLowerBiggerThanUpper"));}
updateSectionColor(target,color){const sectionRule=deepCopy(this.state.sectionRule);sectionRule.colors[target]=color;this.updateSectionRule(sectionRule);this.closeMenus();}
toggleMenu(menu){const isSelected=this.state.openedMenu===menu;this.closeMenus();if(!isSelected){this.state.openedMenu=menu;}}
updateSectionRule(sectionRule){this.state.sectionRuleDispatchResult=this.props.updateChart(this.props.figureId,{sectionRule,});}
canUpdateSectionRule(sectionRule){this.state.sectionRuleDispatchResult=this.props.canUpdateChart(this.props.figureId,{sectionRule,});}
closeMenus(){this.state.openedMenu=undefined;}}
GaugeChartDesignPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class LineConfigPanel extends LineBarPieConfigPanel{static template="o-spreadsheet-LineConfigPanel";get canTreatLabelsAsText(){const chart=this.env.model.getters.getChart(this.props.figureId);if(chart&&chart instanceof LineChart){return canChartParseLabels(chart.labelRange,this.env.model.getters);}
return false;}
onUpdateLabelsAsText(ev){this.props.updateChart(this.props.figureId,{labelsAsText:ev.target.checked,});}
onUpdateStacked(ev){this.props.updateChart(this.props.figureId,{stacked:ev.target.checked,});}
onUpdateAggregated(ev){this.props.updateChart(this.props.figureId,{aggregated:ev.target.checked,});}
onUpdateCumulative(ev){this.props.updateChart(this.props.figureId,{cumulative:ev.target.checked,});}}
class LineChartDesignPanel extends LineBarPieDesignPanel{static template="o-spreadsheet-LineChartDesignPanel";}
class ScorecardChartConfigPanel extends owl.Component{static template="o-spreadsheet-ScorecardChartConfigPanel";static components={SelectionInput,ValidationMessages};state=owl.useState({keyValueDispatchResult:undefined,baselineDispatchResult:undefined,});keyValue=this.props.definition.keyValue;baseline=this.props.definition.baseline;get errorMessages(){const cancelledReasons=[...(this.state.keyValueDispatchResult?.reasons||[]),...(this.state.baselineDispatchResult?.reasons||[]),];return cancelledReasons.map((error)=>ChartTerms.Errors[error]||ChartTerms.Errors.Unexpected);}
get isKeyValueInvalid(){return!!this.state.keyValueDispatchResult?.isCancelledBecause("InvalidScorecardKeyValue");}
get isBaselineInvalid(){return!!this.state.keyValueDispatchResult?.isCancelledBecause("InvalidScorecardBaseline");}
onKeyValueRangeChanged(ranges){this.keyValue=ranges[0];this.state.keyValueDispatchResult=this.props.canUpdateChart(this.props.figureId,{keyValue:this.keyValue,});}
updateKeyValueRange(){this.state.keyValueDispatchResult=this.props.updateChart(this.props.figureId,{keyValue:this.keyValue,});}
getKeyValueRange(){return this.keyValue||"";}
onBaselineRangeChanged(ranges){this.baseline=ranges[0];this.state.baselineDispatchResult=this.props.canUpdateChart(this.props.figureId,{baseline:this.baseline,});}
updateBaselineRange(){this.state.baselineDispatchResult=this.props.updateChart(this.props.figureId,{baseline:this.baseline,});}
getBaselineRange(){return this.baseline||"";}
updateBaselineMode(ev){this.props.updateChart(this.props.figureId,{baselineMode:ev.target.value});}}
ScorecardChartConfigPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};class ScorecardChartDesignPanel extends owl.Component{static template="o-spreadsheet-ScorecardChartDesignPanel";static components={ColorPickerWidget};state=owl.useState({title:"",openedColorPicker:undefined,});setup(){this.state.title=_t(this.props.definition.title);owl.useExternalListener(window,"click",this.closeMenus);}
updateTitle(){this.props.updateChart(this.props.figureId,{title:this.state.title,});}
translate(term){return _t(term);}
updateBaselineDescr(ev){this.props.updateChart(this.props.figureId,{baselineDescr:ev.target.value});}
toggleColorPicker(colorPickerId){if(this.state.openedColorPicker===colorPickerId){this.state.openedColorPicker=undefined;}
else{this.state.openedColorPicker=colorPickerId;}}
setColor(color,colorPickerId){switch(colorPickerId){case"backgroundColor":this.props.updateChart(this.props.figureId,{background:color});break;case"baselineColorDown":this.props.updateChart(this.props.figureId,{baselineColorDown:color});break;case"baselineColorUp":this.props.updateChart(this.props.figureId,{baselineColorUp:color});break;}
this.closeMenus();}
closeMenus(){this.state.openedColorPicker=undefined;}}
ScorecardChartDesignPanel.props={figureId:String,definition:Object,updateChart:Function,canUpdateChart:Function,};const chartSidePanelComponentRegistry=new Registry();chartSidePanelComponentRegistry.add("line",{configuration:LineConfigPanel,design:LineChartDesignPanel,}).add("bar",{configuration:BarConfigPanel,design:BarChartDesignPanel,}).add("pie",{configuration:LineBarPieConfigPanel,design:LineBarPieDesignPanel,}).add("gauge",{configuration:GaugeChartConfigPanel,design:GaugeChartDesignPanel,}).add("scorecard",{configuration:ScorecardChartConfigPanel,design:ScorecardChartDesignPanel,});css`
  .o-chart {
    .o-panel {
      display: flex;
      .o-panel-element {
        flex: 1 0 auto;
        padding: 8px 0px;
        text-align: center;
        cursor: pointer;
        border-right: 1px solid darkgray;
        &.inactive {
          background-color: ${BACKGROUND_HEADER_COLOR};
          border-bottom: 1px solid darkgray;
        }
        .fa {
          margin-right: 4px;
        }
      }
      .o-panel-element:last-child {
        border-right: none;
      }
    }
  }
`;class ChartPanel extends owl.Component{static template="o-spreadsheet-ChartPanel";state;get figureId(){return this.state.figureId;}
setup(){const selectedFigureId=this.env.model.getters.getSelectedFigureId();if(!selectedFigureId){this.props.onCloseSidePanel();return;}
this.state=owl.useState({panel:"configuration",figureId:selectedFigureId,});owl.onWillUpdateProps(()=>{const selectedFigureId=this.env.model.getters.getSelectedFigureId();if(selectedFigureId&&selectedFigureId!==this.state.figureId){this.state.figureId=selectedFigureId;}
if(!this.env.model.getters.isChartDefined(this.figureId)){this.props.onCloseSidePanel();return;}});}
updateChart(figureId,updateDefinition){if(figureId!==this.figureId){return;}
const definition={...this.getChartDefinition(),...updateDefinition,};return this.env.model.dispatch("UPDATE_CHART",{definition,id:figureId,sheetId:this.env.model.getters.getFigureSheetId(figureId),});}
canUpdateChart(figureId,updateDefinition){if(figureId!==this.figureId||!this.env.model.getters.isChartDefined(figureId)){return;}
const definition={...this.getChartDefinition(),...updateDefinition,};return this.env.model.canDispatch("UPDATE_CHART",{definition,id:figureId,sheetId:this.env.model.getters.getFigureSheetId(figureId),});}
onTypeChange(type){const context=this.env.model.getters.getContextCreationChart(this.figureId);if(!context){throw new Error("Chart not defined.");}
const definition=getChartDefinitionFromContextCreation(context,type);this.env.model.dispatch("UPDATE_CHART",{definition,id:this.figureId,sheetId:this.env.model.getters.getFigureSheetId(this.figureId),});}
get chartPanel(){const type=this.env.model.getters.getChartType(this.figureId);if(!type){throw new Error("Chart not defined.");}
const chartPanel=chartSidePanelComponentRegistry.get(type);if(!chartPanel){throw new Error(`Component is not defined for type ${type}`);}
return chartPanel;}
getChartDefinition(figureId=this.figureId){return this.env.model.getters.getChartDefinition(figureId);}
get chartTypes(){return getChartTypes();}
activatePanel(panel){this.state.panel=panel;}}
ChartPanel.props={onCloseSidePanel:Function,};css`
  .o-spreadsheet {
    .o-icon {
      .small-text {
        font: bold 9px sans-serif;
      }
      .heavy-text {
        font: bold 16px sans-serif;
      }
    }
  }
`;const ARROW_DOWN='<svg class="o-cf-icon arrow-down" width="10" height="10" focusable="false" viewBox="0 0 448 512"><path fill="#DC6965" d="M413.1 222.5l22.2 22.2c9.4 9.4 9.4 24.6 0 33.9L241 473c-9.4 9.4-24.6 9.4-33.9 0L12.7 278.6c-9.4-9.4-9.4-24.6 0-33.9l22.2-22.2c9.5-9.5 25-9.3 34.3.4L184 343.4V56c0-13.3 10.7-24 24-24h32c13.3 0 24 10.7 24 24v287.4l114.8-120.5c9.3-9.8 24.8-10 34.3-.4z"></path></svg>';const ARROW_UP='<svg class="o-cf-icon arrow-up" width="10" height="10" focusable="false" viewBox="0 0 448 512"><path fill="#00A04A" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>';const ARROW_RIGHT='<svg class="o-cf-icon arrow-right" width="10" height="10" focusable="false" viewBox="0 0 448 512"><path fill="#F0AD4E" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"></path></svg>';const SMILE='<svg class="o-cf-icon smile" width="10" height="10" focusable="false" viewBox="0 0 496 512"><path fill="#00A04A" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm4 72.6c-20.8 25-51.5 39.4-84 39.4s-63.2-14.3-84-39.4c-8.5-10.2-23.7-11.5-33.8-3.1-10.2 8.5-11.5 23.6-3.1 33.8 30 36 74.1 56.6 120.9 56.6s90.9-20.6 120.9-56.6c8.5-10.2 7.1-25.3-3.1-33.8-10.1-8.4-25.3-7.1-33.8 3.1z"></path></svg>';const MEH='<svg class="o-cf-icon meh" width="10" height="10" focusable="false" viewBox="0 0 496 512"><path fill="#F0AD4E" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm8 144H160c-13.2 0-24 10.8-24 24s10.8 24 24 24h176c13.2 0 24-10.8 24-24s-10.8-24-24-24z"></path></svg>';const FROWN='<svg class="o-cf-icon frown" width="10" height="10" focusable="false" viewBox="0 0 496 512"><path fill="#DC6965" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm-80 128c-40.2 0-78 17.7-103.8 48.6-8.5 10.2-7.1 25.3 3.1 33.8 10.2 8.4 25.3 7.1 33.8-3.1 16.6-19.9 41-31.4 66.9-31.4s50.3 11.4 66.9 31.4c8.1 9.7 23.1 11.9 33.8 3.1 10.2-8.5 11.5-23.6 3.1-33.8C326 321.7 288.2 304 248 304z"></path></svg>';const GREEN_DOT='<svg class="o-cf-icon green-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512"><path fill="#00A04A" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path></svg>';const YELLOW_DOT='<svg class="o-cf-icon yellow-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512"><path fill="#F0AD4E" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path></svg>';const RED_DOT='<svg class="o-cf-icon red-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512"><path fill="#DC6965" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path></svg>';function loadIconImage(svg){svg=`<svg xmlns="http://www.w3.org/2000/svg" ${svg.slice(4)}`;const image=new Image();image.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(svg);return image;}
const ICONS={arrowGood:{template:"ARROW_UP",img:loadIconImage(ARROW_UP),},arrowNeutral:{template:"ARROW_RIGHT",img:loadIconImage(ARROW_RIGHT),},arrowBad:{template:"ARROW_DOWN",img:loadIconImage(ARROW_DOWN),},smileyGood:{template:"SMILE",img:loadIconImage(SMILE),},smileyNeutral:{template:"MEH",img:loadIconImage(MEH),},smileyBad:{template:"FROWN",img:loadIconImage(FROWN),},dotGood:{template:"GREEN_DOT",img:loadIconImage(GREEN_DOT),},dotNeutral:{template:"YELLOW_DOT",img:loadIconImage(YELLOW_DOT),},dotBad:{template:"RED_DOT",img:loadIconImage(RED_DOT),},};const ICON_SETS={arrows:{good:"arrowGood",neutral:"arrowNeutral",bad:"arrowBad",},smiley:{good:"smileyGood",neutral:"smileyNeutral",bad:"smileyBad",},dots:{good:"dotGood",neutral:"dotNeutral",bad:"dotBad",},};css`
  .o-icon-picker {
    position: absolute;
    z-index: ${ComponentsImportance.IconPicker};
    box-shadow: 1px 2px 5px 2px rgba(51, 51, 51, 0.15);
    background-color: white;
    padding: 2px 1px;
  }
  .o-cf-icon-line {
    display: flex;
    padding: 3px 6px;
  }
  .o-icon-picker-item {
    margin: 0px 2px;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08);
      outline: 1px solid gray;
    }
  }
`;class IconPicker extends owl.Component{static template="o-spreadsheet-IconPicker";icons=ICONS;iconSets=ICON_SETS;onIconClick(icon){if(icon){this.props.onIconPicked(icon);}}}
IconPicker.props={onIconPicked:Function,};function useDragAndDropListItems(){let dndHelper;const previousCursor=document.body.style.cursor;let cleanupFns=[];const cleanUp=()=>{dndHelper=undefined;document.body.style.cursor=previousCursor;cleanupFns.forEach((fn)=>fn());cleanupFns=[];};const start=(direction,args)=>{const onChange=()=>{document.body.style.cursor="move";if(!dndHelper)
return;Object.assign(state.itemsStyle,dndHelper.getItemStyles());args.onChange?.();};state.cancel=()=>{state.draggedItemId=undefined;state.itemsStyle={};document.body.style.cursor=previousCursor;args.onCancel?.();};const onDragEnd=(itemId,indexAtEnd)=>{state.draggedItemId=undefined;state.itemsStyle={};document.body.style.cursor=previousCursor;args.onDragEnd?.(itemId,indexAtEnd);cleanUp();};document.body.style.cursor="move";state.draggedItemId=args.draggedItemId;const container=direction==="horizontal"?new HorizontalContainer(args.containerEl):new VerticalContainer(args.containerEl);dndHelper=new DOMDndHelper({...args,container,onChange,onDragEnd,onCancel:state.cancel,});startDnd(dndHelper.onMouseMove.bind(dndHelper),dndHelper.onMouseUp.bind(dndHelper));const onScroll=dndHelper.onScroll.bind(dndHelper);args.containerEl.addEventListener("scroll",onScroll);cleanupFns.push(()=>args.containerEl.removeEventListener("scroll",onScroll));cleanupFns.push(dndHelper.destroy.bind(dndHelper));};owl.onWillUnmount(()=>{cleanUp();});const state=owl.useState({itemsStyle:{},draggedItemId:undefined,start,cancel:()=>{},});return state;}
class DOMDndHelper{draggedItemId;items;container;initialMousePosition;currentMousePosition;initialScroll;minPosition;maxPosition;edgeScrollIntervalId;onChange;onCancel;onDragEnd;deadZone;constructor(args){this.items=args.items.map((item)=>({...item,positionAtStart:item.position}));this.draggedItemId=args.draggedItemId;this.container=args.container;this.onChange=args.onChange;this.onCancel=args.onCancel;this.onDragEnd=args.onDragEnd;this.initialMousePosition=args.initialMousePosition;this.currentMousePosition=args.initialMousePosition;this.initialScroll=this.container.scroll;this.minPosition=this.items[0].position;this.maxPosition=this.items[this.items.length-1].position+this.items[this.items.length-1].size;}
getItemStyles(){const styles={};for(let item of this.items){styles[item.id]=this.getItemStyle(item.id);}
return styles;}
getItemStyle(itemId){const position=this.container.cssPositionProperty;const style={};style.position="relative";style[position]=(this.getItemsPositions()[itemId]||0)+"px";style.transition=`${position} 0.5s`;style["pointer-events"]="none";if(this.draggedItemId===itemId){style.transition=`${position} 0s`;style["z-index"]="1000";}
return cssPropertiesToCss(style);}
onScroll(){this.moveDraggedItemToPosition(this.currentMousePosition+this.scrollOffset);}
onMouseMove(ev){if(ev.button!==0){this.onCancel();return;}
const mousePosition=this.container.getMousePosition(ev);this.currentMousePosition=mousePosition;if(mousePosition<this.container.start||mousePosition>this.container.end){this.startEdgeScroll(mousePosition<this.container.start?-1:1);return;}
else{this.stopEdgeScroll();}
this.moveDraggedItemToPosition(mousePosition+this.scrollOffset);}
moveDraggedItemToPosition(position){const hoveredItemIndex=this.getHoveredItemIndex(position,this.items);const draggedItemIndex=this.items.findIndex((item)=>item.id===this.draggedItemId);const draggedItem=this.items[draggedItemIndex];if(this.deadZone&&this.isInZone(position,this.deadZone)){this.onChange(this.getItemsPositions());return;}
else if(this.isInZone(position,{start:draggedItem.position,end:draggedItem.position+draggedItem.size,})){this.deadZone=undefined;}
if(draggedItemIndex===hoveredItemIndex){this.onChange(this.getItemsPositions());return;}
const startIndex=Math.min(draggedItemIndex,hoveredItemIndex);const endIndex=Math.max(draggedItemIndex,hoveredItemIndex);const direction=Math.sign(hoveredItemIndex-draggedItemIndex);let draggedItemMoveSize=0;for(let i=startIndex;i<=endIndex;i++){if(i===draggedItemIndex){continue;}
this.items[i].position-=direction*draggedItem.size;draggedItemMoveSize+=this.items[i].size;}
draggedItem.position+=direction*draggedItemMoveSize;this.items.sort((item1,item2)=>item1.position-item2.position);this.deadZone=direction>0?{start:position,end:draggedItem.position}:{start:draggedItem.position+draggedItem.size,end:position};this.onChange(this.getItemsPositions());}
onMouseUp(ev){if(ev.button!==0){this.onCancel();}
ev.stopPropagation();ev.preventDefault();const targetItemIndex=this.items.findIndex((item)=>item.id===this.draggedItemId);this.onDragEnd(this.draggedItemId,targetItemIndex);this.stopEdgeScroll();return false;}
startEdgeScroll(direction){if(this.edgeScrollIntervalId)
return;this.edgeScrollIntervalId=window.setInterval(()=>{const offset=direction*3;let newPosition=this.currentMousePosition+offset;if(newPosition<Math.min(this.container.start,this.minPosition)){newPosition=Math.min(this.container.start,this.minPosition);}
else if(newPosition>Math.max(this.container.end,this.maxPosition)){newPosition=Math.max(this.container.end,this.maxPosition);}
this.container.scroll+=offset;},5);}
stopEdgeScroll(){window.clearInterval(this.edgeScrollIntervalId);this.edgeScrollIntervalId=undefined;}
getHoveredItemIndex(mousePosition,items){if(mousePosition<=this.minPosition)
return 0;if(mousePosition>=this.maxPosition)
return items.length-1;return items.findIndex((item)=>item.position+item.size>=mousePosition);}
getItemsPositions(){const positions={};for(let item of this.items){if(item.id!==this.draggedItemId){positions[item.id]=item.position-item.positionAtStart;continue;}
const mouseOffset=this.currentMousePosition-this.initialMousePosition;let start=mouseOffset+this.scrollOffset;start=Math.max(this.minPosition-item.positionAtStart,start);start=Math.min(this.maxPosition-item.positionAtStart-item.size,start);positions[item.id]=start;}
return positions;}
isInZone(position,zone){return position>=zone.start&&position<=zone.end;}
get scrollOffset(){return this.container.scroll-this.initialScroll;}
destroy(){this.stopEdgeScroll();}}
class ContainerWrapper{el;constructor(el){this.el=el;}
get containerRect(){return this.el.getBoundingClientRect();}}
class VerticalContainer extends ContainerWrapper{get start(){return this.containerRect.top;}
get end(){return this.containerRect.bottom;}
get cssPositionProperty(){return"top";}
get scroll(){return this.el.scrollTop;}
set scroll(scroll){this.el.scrollTop=scroll;}
getMousePosition(ev){return ev.clientY;}}
class HorizontalContainer extends ContainerWrapper{get start(){return this.containerRect.left;}
get end(){return this.containerRect.right;}
get cssPositionProperty(){return"left";}
get scroll(){return this.el.scrollLeft;}
set scroll(scroll){this.el.scrollLeft=scroll;}
getMousePosition(ev){return ev.clientX;}}
css`
  .o-cf-preview-list {
    .o-cf-preview {
      &.o-cf-cursor-ptr {
        cursor: pointer;
      }

      border-bottom: 1px solid #ccc;
      height: 60px;
      padding: 10px;
      position: relative;
      cursor: pointer;
      &:hover,
      &.o-cf-dragging {
        background-color: #ebebeb;
      }

      &:not(:hover) .o-cf-delete-button {
        display: none;
      }
      .o-cf-preview-icon {
        border: 1px solid lightgrey;
        position: absolute;
        height: 50px;
        width: 50px;
      }
      .o-cf-preview-description {
        left: 65px;
        margin-bottom: auto;
        margin-right: 8px;
        margin-top: auto;
        position: relative;
        width: 142px;
        .o-cf-preview-description-rule {
          margin-bottom: 4px;
          font-weight: 600;
          color: #303030;
          max-height: 2.8em;
          line-height: 1.4em;
        }
        .o-cf-preview-range {
          font-size: 12px;
        }
      }
      .o-cf-delete {
        left: 90%;
        top: 39%;
        position: absolute;
      }
      &:not(:hover):not(.o-cf-dragging) .o-cf-drag-handle {
        display: none !important;
      }
      .o-cf-drag-handle {
        left: -8px;
        cursor: move;
        .o-icon {
          width: 6px;
          height: 30px;
        }
      }
    }
  }
`;class ConditionalFormatPreviewList extends owl.Component{static template="o-spreadsheet-ConditionalFormatPreviewList";icons=ICONS;dragAndDrop=useDragAndDropListItems();cfListRef=owl.useRef("cfList");setup(){owl.onWillUpdateProps((nextProps)=>{if(!deepEquals(this.props.conditionalFormats,nextProps.conditionalFormats)){this.dragAndDrop.cancel();}});}
getPreviewDivStyle(cf){return this.dragAndDrop.itemsStyle[cf.id]||"";}
getPreviewImageStyle(rule){if(rule.type==="CellIsRule"){return cssPropertiesToCss(cellStyleToCss(rule.style));}
else if(rule.type==="ColorScaleRule"){const minColor=colorNumberString(rule.minimum.color);const midColor=rule.midpoint?colorNumberString(rule.midpoint.color):null;const maxColor=colorNumberString(rule.maximum.color);const baseString="background-image: linear-gradient(to right, ";return midColor?baseString+minColor+", "+midColor+", "+maxColor+")":baseString+minColor+", "+maxColor+")";}
return"";}
getDescription(cf){switch(cf.rule.type){case"CellIsRule":const description=CellIsOperators[cf.rule.operator];if(cf.rule.values.length===1){return`${description} ${cf.rule.values[0]}`;}
if(cf.rule.values.length===2){return _t("%s %s and %s",description,cf.rule.values[0],cf.rule.values[1]);}
return description;case"ColorScaleRule":return CfTerms.ColorScale;case"IconSetRule":return CfTerms.IconSet;}}
deleteConditionalFormat(cf){this.env.model.dispatch("REMOVE_CONDITIONAL_FORMAT",{id:cf.id,sheetId:this.env.model.getters.getActiveSheetId(),});}
onMouseDown(cf,event){if(event.button!==0)
return;const previewRects=Array.from(this.cfListRef.el.children).map((previewEl)=>getBoundingRectAsPOJO(previewEl));const items=this.props.conditionalFormats.map((cf,index)=>({id:cf.id,size:previewRects[index].height,position:previewRects[index].y,}));this.dragAndDrop.start("vertical",{draggedItemId:cf.id,initialMousePosition:event.clientY,items:items,containerEl:this.cfListRef.el,onDragEnd:(cfId,finalIndex)=>this.onDragEnd(cfId,finalIndex),});}
onDragEnd(cfId,finalIndex){const originalIndex=this.props.conditionalFormats.findIndex((sheet)=>sheet.id===cfId);const delta=originalIndex-finalIndex;if(delta!==0){this.env.model.dispatch("CHANGE_CONDITIONAL_FORMAT_PRIORITY",{cfId,delta,sheetId:this.env.model.getters.getActiveSheetId(),});}}}
ConditionalFormatPreviewList.props={conditionalFormats:Array,onPreviewClick:Function,onAddConditionalFormat:Function,};css`
  label {
    vertical-align: middle;
  }
  .o_cf_radio_item {
    margin-right: 10%;
  }
  .radio input:checked {
    color: #e9ecef;
    border-color: #00a09d;
    background-color: #00a09d;
  }
  .o-cf-editor {
    border-bottom: solid;
    border-color: lightgrey;
  }
  .o-cf {
    .o-cf-type-selector {
      *,
      ::after,
      ::before {
        box-sizing: border-box;
      }
      margin-top: 10px;
      display: flex;
    }
    .o-section-subtitle:first-child {
      margin-top: 0px;
    }
    .o-cf-ruleEditor {
      font-size: 12px;
      line-height: 1.5;
      .o-selection-cf {
        margin-bottom: 3%;
      }
      .o-cell-content {
        font-size: 12px;
        font-weight: 500;
        padding: 0 12px;
        margin: 0;
        line-height: 35px;
      }
    }
    .o-cf-error {
      color: red;
      margin-top: 10px;
    }
  }
  .o-cf-cell-is-rule {
    .o-cf-preview-line {
      border: 1px solid darkgrey;
      padding: 10px;
    }
    .o-cell-is-operator {
      margin-bottom: 5px;
    }
    .o-cell-is-value {
      margin-bottom: 5px;
    }
    .o-color-picker-widget .o-color-picker-button {
      pointer-events: all;
      cursor: default;
    }
  }
  .o-cf-color-scale-editor {
    .o-threshold {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      select {
        width: 100%;
      }
      .o-threshold-value {
        margin-left: 2%;
        width: 20%;
        min-width: 0px; // input overflows in Firefox otherwise
      }
      .o-threshold-value:disabled {
        background-color: #edebed;
      }
    }
    .o-cf-preview-gradient {
      border: 1px solid darkgrey;
      padding: 10px;
      border-radius: 4px;
    }
  }
  .o-cf-iconset-rule {
    font-size: 12;
    .o-cf-iconsets {
      display: flex;
      justify-content: space-between;
      .o-cf-iconset {
        border: 1px solid #dadce0;
        border-radius: 4px;
        display: inline-flex;
        padding: 5px 8px;
        width: 25%;
        cursor: pointer;
        justify-content: space-between;
        .o-cf-icon {
          display: inline;
          margin-left: 1%;
          margin-right: 1%;
        }
        svg {
          vertical-align: baseline;
        }
      }
      .o-cf-iconset:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
    .o-inflection {
      .o-cf-icon-button {
        display: inline-block;
        border: 1px solid #dadce0;
        border-radius: 4px;
        cursor: pointer;
        padding: 1px 2px;
      }
      .o-cf-icon-button:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
      table {
        table-layout: fixed;
        margin-top: 2%;
        display: table;
        text-align: left;
        font-size: 12px;
        line-height: 18px;
        width: 100%;
      }
      th.o-cf-iconset-icons {
        width: 8%;
      }
      th.o-cf-iconset-text {
        width: 28%;
      }
      th.o-cf-iconset-operator {
        width: 14%;
      }
      th.o-cf-iconset-type {
        width: 28%;
      }
      th.o-cf-iconset-value {
        width: 26%;
      }
      input,
      select {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }
    }
    .o-cf-iconset-reverse {
      margin-bottom: 2%;
      margin-top: 2%;
      .o-cf-label {
        display: inline-block;
        vertical-align: bottom;
        margin-bottom: 2px;
      }
    }
  }
`;class ConditionalFormattingEditor extends owl.Component{static template="o-spreadsheet-ConditionalFormattingEditor";static components={SelectionInput,IconPicker,ColorPickerWidget,ConditionalFormatPreviewList,};icons=ICONS;cellIsOperators=CellIsOperators;iconSets=ICON_SETS;getTextDecoration=getTextDecoration;colorNumberString=colorNumberString;state;setup(){const cf=this.props.editedCf||{id:this.env.model.uuidGenerator.uuidv4(),ranges:this.env.model.getters.getSelectedZones().map((zone)=>this.env.model.getters.zoneToXC(this.env.model.getters.getActiveSheetId(),zone)),};this.state=owl.useState({currentCF:cf,currentCFType:this.props.editedCf?.rule.type||"CellIsRule",errors:[],rules:this.getDefaultRules(),});if(this.props.editedCf){switch(this.props.editedCf.rule.type){case"CellIsRule":this.state.rules.cellIs=this.props.editedCf.rule;break;case"ColorScaleRule":this.state.rules.colorScale=this.props.editedCf.rule;break;case"IconSetRule":this.state.rules.iconSet=this.props.editedCf.rule;break;}}
owl.useExternalListener(window,"click",this.closeMenus);}
get isRangeValid(){return this.state.errors.includes("EmptyRange");}
errorMessage(error){return CfTerms.Errors[error]||CfTerms.Errors.Unexpected;}
saveConditionalFormat(){if(this.state.currentCF){const invalidRanges=this.state.currentCF.ranges.some((xc)=>!xc.match(rangeReference));if(invalidRanges){this.state.errors=["InvalidRange"];return;}
const sheetId=this.env.model.getters.getActiveSheetId();const locale=this.env.model.getters.getLocale();const result=this.env.model.dispatch("ADD_CONDITIONAL_FORMAT",{cf:{rule:canonicalizeCFRule(this.getEditorRule(),locale),id:this.state.currentCF.id,},ranges:this.state.currentCF.ranges.map((xc)=>this.env.model.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});if(!result.isSuccessful){this.state.errors=result.reasons;}
else{this.props.onExitEdition();}}}
getEditorRule(){switch(this.state.currentCFType){case"CellIsRule":return this.state.rules.cellIs;case"ColorScaleRule":return this.state.rules.colorScale;case"IconSetRule":return this.state.rules.iconSet;}}
getDefaultRules(){return{cellIs:{type:"CellIsRule",operator:"IsNotEmpty",values:[],style:{fillColor:"#b6d7a8"},},colorScale:{type:"ColorScaleRule",minimum:{type:"value",color:0xffffff},midpoint:undefined,maximum:{type:"value",color:0x6aa84f},},iconSet:{type:"IconSetRule",icons:{upper:"arrowGood",middle:"arrowNeutral",lower:"arrowBad",},upperInflectionPoint:{type:"percentage",value:"66",operator:"gt",},lowerInflectionPoint:{type:"percentage",value:"33",operator:"gt",},},};}
changeRuleType(ruleType){if(this.state.currentCFType===ruleType||!this.state.rules){return;}
this.state.errors=[];this.state.currentCFType=ruleType;}
onRangesChanged(ranges){if(this.state.currentCF){this.state.currentCF.ranges=ranges;}}
toggleMenu(menu){const isSelected=this.state.openedMenu===menu;this.closeMenus();if(!isSelected){this.state.openedMenu=menu;}}
closeMenus(){this.state.openedMenu=undefined;}
get isValue1Invalid(){return!!this.state.errors?.includes("FirstArgMissing");}
get isValue2Invalid(){return!!this.state.errors?.includes("SecondArgMissing");}
toggleStyle(tool){const style=this.state.rules.cellIs.style;style[tool]=!style[tool];this.closeMenus();}
onKeydown(event){if(event.key==="F4"){const target=event.target;const update=this.env.model.getters.getCycledReference({start:target.selectionStart??0,end:target.selectionEnd??0},target.value);if(!update){return;}
target.value=update.content;target.setSelectionRange(update.selection.start,update.selection.end);target.dispatchEvent(new Event("input"));}}
setColor(target,color){this.state.rules.cellIs.style[target]=color;this.closeMenus();}
isValueInvalid(threshold){switch(threshold){case"minimum":return(this.state.errors.includes("MinInvalidFormula")||this.state.errors.includes("MinBiggerThanMid")||this.state.errors.includes("MinBiggerThanMax")||this.state.errors.includes("MinNaN"));case"midpoint":return(this.state.errors.includes("MidInvalidFormula")||this.state.errors.includes("MidNaN")||this.state.errors.includes("MidBiggerThanMax"));case"maximum":return(this.state.errors.includes("MaxInvalidFormula")||this.state.errors.includes("MaxNaN"));default:return false;}}
setColorScaleColor(target,color){const point=this.state.rules.colorScale[target];if(point){point.color=Number.parseInt(color.substr(1),16);}
this.closeMenus();}
getPreviewGradient(){const rule=this.state.rules.colorScale;const minColor=colorNumberString(rule.minimum.color);const midColor=colorNumberString(rule.midpoint?.color||DEFAULT_COLOR_SCALE_MIDPOINT_COLOR);const maxColor=colorNumberString(rule.maximum.color);const baseString="background-image: linear-gradient(to right, ";return rule.midpoint===undefined?baseString+minColor+", "+maxColor+")":baseString+minColor+", "+midColor+", "+maxColor+")";}
getThresholdColor(threshold){return threshold?colorNumberString(threshold.color):colorNumberString(DEFAULT_COLOR_SCALE_MIDPOINT_COLOR);}
onMidpointChange(ev){const type=ev.target.value;const rule=this.state.rules.colorScale;if(type==="none"){rule.midpoint=undefined;}
else{rule.midpoint={color:DEFAULT_COLOR_SCALE_MIDPOINT_COLOR,value:"",...rule.midpoint,type,};}}
isInflectionPointInvalid(inflectionPoint){switch(inflectionPoint){case"lowerInflectionPoint":return(this.state.errors.includes("ValueLowerInflectionNaN")||this.state.errors.includes("ValueLowerInvalidFormula")||this.state.errors.includes("LowerBiggerThanUpper"));case"upperInflectionPoint":return(this.state.errors.includes("ValueUpperInflectionNaN")||this.state.errors.includes("ValueUpperInvalidFormula")||this.state.errors.includes("LowerBiggerThanUpper"));default:return true;}}
reverseIcons(){const icons=this.state.rules.iconSet.icons;const upper=icons.upper;icons.upper=icons.lower;icons.lower=upper;}
setIconSet(iconSet){const icons=this.state.rules.iconSet.icons;icons.upper=this.iconSets[iconSet].good;icons.middle=this.iconSets[iconSet].neutral;icons.lower=this.iconSets[iconSet].bad;}
setIcon(target,icon){this.state.rules.iconSet.icons[target]=icon;}}
ConditionalFormattingEditor.props={editedCf:{type:Object,optional:true},onExitEdition:Function,};class ConditionalFormattingPanel extends owl.Component{static template="o-spreadsheet-ConditionalFormattingPanel";static components={ConditionalFormatPreviewList,ConditionalFormattingEditor,};activeSheetId;state=owl.useState({mode:"list",});setup(){this.activeSheetId=this.env.model.getters.getActiveSheetId();const sheetId=this.env.model.getters.getActiveSheetId();const rules=this.env.model.getters.getRulesSelection(sheetId,this.props.selection||[]);if(rules.length===1){const cf=this.conditionalFormats.find((c)=>c.id===rules[0]);if(cf){this.editConditionalFormat(cf);}}
owl.onWillUpdateProps((nextProps)=>{const newActiveSheetId=this.env.model.getters.getActiveSheetId();if(newActiveSheetId!==this.activeSheetId){this.activeSheetId=newActiveSheetId;this.switchToList();}
else if(nextProps.selection!==this.props.selection){const sheetId=this.env.model.getters.getActiveSheetId();const rules=this.env.model.getters.getRulesSelection(sheetId,nextProps.selection||[]);if(rules.length===1){const cf=this.conditionalFormats.find((c)=>c.id===rules[0]);if(cf){this.editConditionalFormat(cf);}}
else{this.switchToList();}}});}
get conditionalFormats(){const cfs=this.env.model.getters.getConditionalFormats(this.env.model.getters.getActiveSheetId());return cfs.map((cf)=>({...cf,rule:localizeCFRule(cf.rule,this.env.model.getters.getLocale()),}));}
switchToList(){this.state.mode="list";this.state.editedCf=undefined;}
addConditionalFormat(){this.state.mode="edit";}
editConditionalFormat(cf){this.state.mode="edit";this.state.editedCf=cf;}}
ConditionalFormattingPanel.props={selection:{type:Object,optional:true},onCloseSidePanel:Function,};css`
  .o-custom-currency {
    .o-format-proposals {
      color: black;
    }
  }
`;class CustomCurrencyPanel extends owl.Component{static template="o-spreadsheet-CustomCurrencyPanel";availableCurrencies;state;setup(){this.availableCurrencies=[];this.state=owl.useState({selectedCurrencyIndex:0,currencyCode:"",currencySymbol:"",selectedFormatIndex:0,});owl.onWillStart(()=>this.updateAvailableCurrencies());}
get formatProposals(){const currency=this.availableCurrencies[this.state.selectedCurrencyIndex];const position=currency.position;const opposite=currency.position==="before"?"after":"before";const symbol=this.state.currencySymbol.trim()?this.state.currencySymbol:"";const code=this.state.currencyCode.trim()?this.state.currencyCode:"";const decimalPlaces=currency.decimalPlaces;if(!symbol&&!code){return[];}
const simple=symbol?createCurrencyFormat({symbol,position,decimalPlaces}):"";const rounded=simple?roundFormat(simple):"";const simpleWithCode=createCurrencyFormat({symbol,position,decimalPlaces,code});const roundedWithCode=roundFormat(simpleWithCode);const simpleOpposite=symbol?createCurrencyFormat({symbol,position:opposite,decimalPlaces}):"";const roundedOpposite=simpleOpposite?roundFormat(simpleOpposite):"";const simpleOppositeWithCode=createCurrencyFormat({symbol,position:opposite,decimalPlaces,code,});const roundedOppositeWithCode=roundFormat(simpleOppositeWithCode);const formats=new Set([rounded,simple,roundedWithCode,simpleWithCode,roundedOpposite,simpleOpposite,roundedOppositeWithCode,simpleOppositeWithCode,]);return[...formats].filter((format)=>format!=="").map((format)=>({format,example:formatValue(1000.0,{format,locale:this.env.model.getters.getLocale()}),}));}
get isSameFormat(){const selectedFormat=this.formatProposals[this.state.selectedFormatIndex];return selectedFormat?selectedFormat.format===this.getCommonFormat():false;}
async updateAvailableCurrencies(){if(currenciesRegistry.getAll().length===0){const currencies=(await this.env.loadCurrencies?.())||[];currencies.forEach((currency,index)=>{currenciesRegistry.add(index.toString(),currency);});}
const emptyCurrency={name:_t(CustomCurrencyTerms.Custom),code:"",symbol:"",decimalPlaces:2,position:"after",};this.availableCurrencies=[emptyCurrency,...currenciesRegistry.getAll()];}
updateSelectCurrency(ev){const target=ev.target;this.state.selectedCurrencyIndex=parseInt(target.value,10);const currency=this.availableCurrencies[this.state.selectedCurrencyIndex];this.state.currencyCode=currency.code;this.state.currencySymbol=currency.symbol;}
updateCode(ev){const target=ev.target;this.state.currencyCode=target.value;this.initAvailableCurrencies();}
updateSymbol(ev){const target=ev.target;this.state.currencySymbol=target.value;this.initAvailableCurrencies();}
updateSelectFormat(ev){const target=ev.target;this.state.selectedFormatIndex=parseInt(target.value,10);}
apply(){const selectedFormat=this.formatProposals[this.state.selectedFormatIndex];this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),format:selectedFormat.format,});}
initAvailableCurrencies(){this.state.selectedCurrencyIndex=0;}
getCommonFormat(){const selectedZones=this.env.model.getters.getSelectedZones();const sheetId=this.env.model.getters.getActiveSheetId();const cells=selectedZones.map((zone)=>this.env.model.getters.getEvaluatedCellsInZone(sheetId,zone)).flat();const firstFormat=cells[0].format;return cells.every((cell)=>cell.format===firstFormat)?firstFormat:undefined;}
currencyDisplayName(currency){return currency.name+(currency.code?` (${currency.code})`:"");}}
CustomCurrencyPanel.props={onCloseSidePanel:Function,};css`
  .o-find-and-replace {
    outline: none;
    height: 100%;
    .o-input-search-container {
      display: flex;
      .o-input-with-count {
        flex-grow: 1;
        width: auto;
      }
      .o-input-without-count {
        width: 100%;
      }
      .o-input-count {
        width: fit-content;
        padding: 4px 0 4px 4px;
      }
    }
  }
`;class FindAndReplacePanel extends owl.Component{static template="o-spreadsheet-FindAndReplacePanel";state=owl.useState(this.initialState());debounceTimeoutId;showFormulaState=false;searchInput=owl.useRef("searchInput");get hasSearchResult(){return this.env.model.getters.getCurrentSelectedMatchIndex()!==null;}
get pendingSearch(){return this.debounceTimeoutId!==undefined;}
setup(){this.showFormulaState=this.env.model.getters.shouldShowFormulas();owl.onMounted(()=>this.searchInput.el?.focus());owl.onWillUnmount(()=>{clearTimeout(this.debounceTimeoutId);this.env.model.dispatch("CLEAR_SEARCH");this.env.model.dispatch("SET_FORMULA_VISIBILITY",{show:this.showFormulaState});});owl.useEffect(()=>{this.state.searchOptions.searchFormulas=this.env.model.getters.shouldShowFormulas();this.searchFormulas();},()=>[this.env.model.getters.shouldShowFormulas()]);}
onInput(ev){this.state.toSearch=ev.target.value;this.debouncedUpdateSearch();}
onKeydownSearch(ev){if(ev.key==="Enter"){ev.preventDefault();ev.stopPropagation();this.onSelectNextCell();}}
onKeydownReplace(ev){if(ev.key==="Enter"){ev.preventDefault();ev.stopPropagation();this.replace();}}
searchFormulas(){this.env.model.dispatch("SET_FORMULA_VISIBILITY",{show:this.state.searchOptions.searchFormulas,});this.updateSearch();}
onSelectPreviousCell(){this.env.model.dispatch("SELECT_SEARCH_PREVIOUS_MATCH");}
onSelectNextCell(){this.env.model.dispatch("SELECT_SEARCH_NEXT_MATCH");}
updateSearch(){this.env.model.dispatch("UPDATE_SEARCH",{toSearch:this.state.toSearch,searchOptions:this.state.searchOptions,});}
debouncedUpdateSearch(){clearTimeout(this.debounceTimeoutId);this.debounceTimeoutId=setTimeout(()=>{this.updateSearch();this.debounceTimeoutId=undefined;},200);}
replace(){this.env.model.dispatch("REPLACE_SEARCH",{replaceWith:this.state.replaceWith,});}
replaceAll(){this.env.model.dispatch("REPLACE_ALL_SEARCH",{replaceWith:this.state.replaceWith,});}
initialState(){return{toSearch:"",replaceWith:"",searchOptions:{matchCase:false,exactMatch:false,searchFormulas:false,},};}}
FindAndReplacePanel.props={onCloseSidePanel:Function,};css`
  .o-more-formats-panel {
    .format-preview {
      height: 48px;
      background-color: white;

      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
    .check-icon {
      width: 24px;
    }
  }
`;const DATE_FORMAT_ACTIONS=createActions([formatNumberFullDateTime,formatNumberFullWeekDayAndMonth,formatNumberDayAndFullMonth,formatNumberShortWeekDay,formatNumberDayAndShortMonth,formatNumberFullMonth,formatNumberShortMonth,formatNumberDate,formatNumberTime,formatNumberDateTime,formatNumberDuration,]);class MoreFormatsPanel extends owl.Component{static template="o-spreadsheet-MoreFormatsPanel";get dateFormatsActions(){return DATE_FORMAT_ACTIONS;}}
MoreFormatsPanel.props={onCloseSidePanel:Function,};css`
  .o-checkbox-selection {
    height: 150px;
  }
`;class RemoveDuplicatesPanel extends owl.Component{static template="o-spreadsheet-RemoveDuplicatesPanel";static components={ValidationMessages};state=owl.useState({hasHeader:false,columns:{},});setup(){owl.onWillUpdateProps(()=>this.updateColumns());}
toggleHasHeader(){this.state.hasHeader=!this.state.hasHeader;}
toggleAllColumns(){const newState=!this.isEveryColumnSelected;for(const index in this.state.columns){this.state.columns[index]=newState;}}
toggleColumn(colIndex){this.state.columns[colIndex]=!this.state.columns[colIndex];}
onRemoveDuplicates(){this.env.model.dispatch("REMOVE_DUPLICATES",{hasHeader:this.state.hasHeader,columns:this.getColsToAnalyze(),});}
getColLabel(colKey){const col=parseInt(colKey);let colLabel=_t("Column %s",numberToLetters(col));if(this.state.hasHeader){const sheetId=this.env.model.getters.getActiveSheetId();const row=this.env.model.getters.getSelectedZone().top;const colHeader=this.env.model.getters.getEvaluatedCell({sheetId,col,row});if(colHeader.type!=="empty"){colLabel+=` - ${colHeader.value}`;}}
return colLabel;}
get isEveryColumnSelected(){return Object.values(this.state.columns).every((value)=>value===true);}
get errorMessages(){const cancelledReasons=this.env.model.canDispatch("REMOVE_DUPLICATES",{hasHeader:this.state.hasHeader,columns:this.getColsToAnalyze(),}).reasons;const errors=new Set();for(const reason of cancelledReasons){errors.add(RemoveDuplicateTerms.Errors[reason]||RemoveDuplicateTerms.Errors.Unexpected);}
return Array.from(errors);}
get selectionStatisticalInformation(){const dimension=zoneToDimension(this.env.model.getters.getSelectedZone());return _t("%(row_count)s rows and %(column_count)s columns selected",{row_count:dimension.numberOfRows,column_count:dimension.numberOfCols,});}
get canConfirm(){return this.errorMessages.length===0;}
updateColumns(){const zone=this.env.model.getters.getSelectedZone();const oldColumns=this.state.columns;const newColumns={};for(let i=zone.left;i<=zone.right;i++){newColumns[i]=i in oldColumns?oldColumns[i]:true;}
this.state.columns=newColumns;}
getColsToAnalyze(){return Object.keys(this.state.columns).filter((colIndex)=>this.state.columns[colIndex]).map((colIndex)=>parseInt(colIndex));}}
css`
  .o-locale-preview {
    color: dimgrey;
  }
`;class SettingsPanel extends owl.Component{static template="o-spreadsheet-SettingsPanel";loadedLocales=[];setup(){owl.onWillStart(()=>this.loadLocales());}
onLocaleChange(code){const locale=this.loadedLocales.find((l)=>l.code===code);if(!locale)
return;this.env.model.dispatch("UPDATE_LOCALE",{locale});}
async loadLocales(){this.loadedLocales=(await this.env.loadLocales()).filter(isValidLocale).sort((a,b)=>a.name.localeCompare(b.name));}
get numberFormatPreview(){const locale=this.env.model.getters.getLocale();return formatValue(1234567.89,{format:"#,##0.00",locale});}
get dateFormatPreview(){const locale=this.env.model.getters.getLocale();return formatValue(1.6,{format:locale.dateFormat,locale});}
get dateTimeFormatPreview(){const locale=this.env.model.getters.getLocale();const dateTimeFormat=getDateTimeFormat(locale);return formatValue(1.6,{format:dateTimeFormat,locale});}
get currentLocale(){return this.env.model.getters.getLocale();}
get supportedLocales(){const currentLocale=this.currentLocale;const localeInLoadedLocales=this.loadedLocales.find((l)=>l.code===currentLocale.code);if(!localeInLoadedLocales){const locales=[...this.loadedLocales,currentLocale].sort((a,b)=>a.name.localeCompare(b.name));return locales;}
else if(!deepEquals(currentLocale,localeInLoadedLocales)){const index=this.loadedLocales.indexOf(localeInLoadedLocales);const locales=[...this.loadedLocales];locales[index]=currentLocale;locales.sort((a,b)=>a.name.localeCompare(b.name));return locales;}
return this.loadedLocales;}}
SettingsPanel.props={onCloseSidePanel:Function,};const SplitToColumnsInteractiveContent={SplitIsDestructive:_t("This will overwrite data in the subsequent columns. Split anyway?"),};function interactiveSplitToColumns(env,separator,addNewColumns){let result=env.model.dispatch("SPLIT_TEXT_INTO_COLUMNS",{separator,addNewColumns});if(result.isCancelledBecause("SplitWillOverwriteContent")){env.askConfirmation(SplitToColumnsInteractiveContent.SplitIsDestructive,()=>{result=env.model.dispatch("SPLIT_TEXT_INTO_COLUMNS",{separator,addNewColumns,force:true,});});}
return result;}
const dataValidationEvaluatorRegistry=new Registry();dataValidationEvaluatorRegistry.add("textContains",{type:"textContains",isValueValid:(value,criterion)=>{const strValue=String(value);return strValue.toLowerCase().includes(criterion.values[0].toLowerCase());},getErrorString:(criterion)=>{return _t('The value must be a text that contains "%s"',criterion.values[0]);},isCriterionValueValid:(value)=>!!value,criterionValueErrorString:DVTerms.CriterionError.notEmptyValue,numberOfValues:()=>1,name:_t("Text contains"),getPreview:(criterion)=>_t('Text contains "%s"',criterion.values[0]),});dataValidationEvaluatorRegistry.add("textNotContains",{type:"textNotContains",isValueValid:(value,criterion)=>{const strValue=String(value);return!strValue.toLowerCase().includes(criterion.values[0].toLowerCase());},getErrorString:(criterion)=>{return _t('The value must be a text that does not contain "%s"',criterion.values[0]);},isCriterionValueValid:(value)=>!!value,criterionValueErrorString:DVTerms.CriterionError.notEmptyValue,numberOfValues:()=>1,name:_t("Text does not contains"),getPreview:(criterion)=>_t('Text does not contain "%s"',criterion.values[0]),});dataValidationEvaluatorRegistry.add("textIs",{type:"textIs",isValueValid:(value,criterion)=>{const strValue=String(value);return strValue.toLowerCase()===criterion.values[0].toLowerCase();},getErrorString:(criterion)=>{return _t('The value must be exactly "%s"',criterion.values[0]);},isCriterionValueValid:(value)=>!!value,criterionValueErrorString:DVTerms.CriterionError.notEmptyValue,numberOfValues:()=>1,name:_t("Text is exactly"),getPreview:(criterion)=>_t('Text is exactly "%s"',criterion.values[0]),});const emailRegex=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,63}$/;dataValidationEvaluatorRegistry.add("textIsEmail",{type:"textIsEmail",isValueValid:(value)=>typeof value==="string"&&emailRegex.test(value),getErrorString:()=>_t("The value must be a valid email address"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Text is valid email"),getPreview:()=>_t("Text is valid email"),});dataValidationEvaluatorRegistry.add("textIsLink",{type:"textIsLink",isValueValid:(value)=>detectLink(value)!==undefined,getErrorString:()=>_t("The value must be a valid link"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Text is valid link"),getPreview:()=>_t("Text is valid link"),});dataValidationEvaluatorRegistry.add("dateIs",{type:"dateIs",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);if(dateValue===undefined||criterionValue===undefined){return false;}
if(["lastWeek","lastMonth","lastYear"].includes(criterion.dateValue)){const today=jsDateToRoundNumber(DateTime.now());return isDateBetween(dateValue,today,criterionValue);}
return areDatesSameDay(dateValue,criterionValue);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be the date %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be %s",DVTerms.DateIs[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is %s",DVTerms.DateIs[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsBefore",{type:"dateIsBefore",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateStrictlyBefore(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date before %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date before %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is before"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is before %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is before %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsOnOrBefore",{type:"dateIsOnOrBefore",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateBefore(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date on or before %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date on or before %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is on or before"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is on or before %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is on or before %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsAfter",{type:"dateIsAfter",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateStrictlyAfter(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date after %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date after %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is after"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is after %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is after %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsOnOrAfter",{type:"dateIsOnOrAfter",isValueValid:(value,criterion)=>{const criterionValue=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE)[0];const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);return(dateValue!==undefined&&criterionValue!==undefined&&isDateAfter(dateValue,criterionValue));},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();return criterion.dateValue==="exactDate"?_t("The value must be a date on or after %s",getDateCriterionLocalizedValues(criterion,locale)[0]):_t("The value must be a date on or after %s",DVTerms.DateIsBefore[criterion.dateValue]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:(criterion)=>(criterion.dateValue==="exactDate"?1:0),name:_t("Date is on or after"),getPreview:(criterion,getters)=>{return criterion.dateValue==="exactDate"?_t("Date is on or after %s",getDateCriterionFormattedValues(criterion,getters)[0]):_t("Date is on or after %s",DVTerms.DateIsBefore[criterion.dateValue]);},});dataValidationEvaluatorRegistry.add("dateIsBetween",{type:"dateIsBetween",isValueValid:(value,criterion)=>{const criterionValues=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE);const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);if(dateValue===undefined||criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return isDateBetween(dateValue,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const criterionValues=getDateCriterionLocalizedValues(criterion,locale);return _t("The value must be a date between %s and %s",criterionValues[0],criterionValues[1]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:()=>2,name:_t("Date is between"),getPreview:(criterion,getters)=>{const values=getDateCriterionFormattedValues(criterion,getters);return _t("Date is between %s and %s",values[0],values[1]);},});dataValidationEvaluatorRegistry.add("dateIsNotBetween",{type:"dateIsNotBetween",isValueValid:(value,criterion)=>{const criterionValues=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE);const dateValue=valueToDateNumber(value,DEFAULT_LOCALE);if(dateValue===undefined||criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return!isDateBetween(dateValue,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const criterionValues=getDateCriterionLocalizedValues(criterion,locale);return _t("The value must be a date not between %s and %s",criterionValues[0],criterionValues[1]);},isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:DVTerms.CriterionError.dateValue,numberOfValues:()=>2,name:_t("Date is not between"),getPreview:(criterion,getters)=>{const values=getDateCriterionFormattedValues(criterion,getters);return _t("Date is not between %s and %s",values[0],values[1]);},});dataValidationEvaluatorRegistry.add("dateIsValid",{type:"dateIsValid",isValueValid:(value)=>{return valueToDateNumber(value,DEFAULT_LOCALE)!==undefined;},getErrorString:()=>_t("The value must be a valid date"),isCriterionValueValid:(value)=>checkValueIsDate(value),criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Is valid date"),getPreview:()=>_t("Date is valid"),});dataValidationEvaluatorRegistry.add("isEqual",{type:"isEqual",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value===criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is equal to"),getPreview:(criterion)=>_t("Value is equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isNotEqual",{type:"isNotEqual",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value!==criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must not be equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is not equal to"),getPreview:(criterion)=>_t("Value is not equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isGreaterThan",{type:"isGreaterThan",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value>criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be greater than %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is greater than"),getPreview:(criterion)=>_t("Value is greater than %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isGreaterOrEqualTo",{type:"isGreaterOrEqualTo",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value>=criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be greater or equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is greater or equal to"),getPreview:(criterion)=>_t("Value is greater or equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isLessThan",{type:"isLessThan",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value<criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be less than %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is less than"),getPreview:(criterion)=>_t("Value is less than %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isLessOrEqualTo",{type:"isLessOrEqualTo",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValue=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE)[0];if(criterionValue===undefined){return false;}
return value<=criterionValue;},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be less or equal to %s",values[0]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>1,name:_t("Is less or equal to"),getPreview:(criterion)=>_t("Value is less or equal to %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("isBetween",{type:"isBetween",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValues=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE);if(criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return isNumberBetween(value,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must be between %s and %s",values[0],values[1]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>2,name:_t("Is between"),getPreview:(criterion)=>_t("Value is between %s and %s",criterion.values[0],criterion.values[1]),});dataValidationEvaluatorRegistry.add("isNotBetween",{type:"isNotBetween",isValueValid:(value,criterion)=>{if(typeof value!=="number"){return false;}
const criterionValues=getCriterionValuesAsNumber(criterion,DEFAULT_LOCALE);if(criterionValues[0]===undefined||criterionValues[1]===undefined){return false;}
return!isNumberBetween(value,criterionValues[0],criterionValues[1]);},getErrorString:(criterion,getters)=>{const locale=getters.getLocale();const values=getNumberCriterionlocalizedValues(criterion,locale);return _t("The value must not be between %s and %s",values[0],values[1]);},isCriterionValueValid:(value)=>checkValueIsNumber(value),criterionValueErrorString:DVTerms.CriterionError.numberValue,numberOfValues:()=>2,name:_t("Is not between"),getPreview:(criterion)=>_t("Value is not between %s and %s",criterion.values[0],criterion.values[1]),});dataValidationEvaluatorRegistry.add("isBoolean",{type:"isBoolean",isValueValid:(value)=>value===""||typeof value==="boolean",getErrorString:()=>_t("The value must be a boolean"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>0,name:_t("Checkbox"),getPreview:()=>_t("Checkbox"),});dataValidationEvaluatorRegistry.add("isValueInList",{type:"isValueInList",isValueValid:(value,criterion)=>{if(value===null){return false;}
return criterion.values.map((str)=>str.toLowerCase()).includes(value.toString().toLowerCase());},getErrorString:(criterion)=>_t("The value must be one of: %s",criterion.values.join(", ")),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>undefined,allowedValues:"onlyLiterals",name:_t("Value in list"),getPreview:(criterion)=>_t("Value one of: %s",criterion.values.join(", ")),});dataValidationEvaluatorRegistry.add("isValueInRange",{type:"isValueInList",isValueValid:(value,criterion,getters,sheetId)=>{if(!value){return false;}
const range=getters.getRangeFromSheetXC(sheetId,criterion.values[0]);const criterionValues=getters.getRangeValues(range);return criterionValues.filter(isNotNull).map((value)=>value.toString().toLowerCase()).includes(value.toString().toLowerCase());},getErrorString:(criterion)=>_t("The value must be a value in the range %s",criterion.values[0]),isCriterionValueValid:(value)=>rangeReference.test(value),criterionValueErrorString:DVTerms.CriterionError.validRange,numberOfValues:()=>1,allowedValues:"onlyLiterals",name:_t("Value in range"),getPreview:(criterion)=>_t("Value in range %s",criterion.values[0]),});dataValidationEvaluatorRegistry.add("customFormula",{type:"customFormula",isValueValid:(value,criterion)=>{const parsedValue=parseLiteral(criterion.values[0],DEFAULT_LOCALE);if(typeof parsedValue==="number"||typeof parsedValue==="boolean"){return!!parsedValue;}
return false;},getErrorString:()=>_t("The value does not match the custom formula data validation rule"),isCriterionValueValid:()=>true,criterionValueErrorString:"",numberOfValues:()=>1,allowedValues:"onlyFormulas",name:_t("Custom formula"),getPreview:(criterion)=>_t("Custom formula %s",criterion.values[0]),});function getNumberCriterionlocalizedValues(criterion,locale){return criterion.values.map((value)=>value!==undefined?localizeContent(value,locale):CellErrorType.InvalidReference);}
function getDateCriterionLocalizedValues(criterion,locale){const values=getDateNumberCriterionValues(criterion,DEFAULT_LOCALE);return values.map((value)=>value!==undefined?formatValue(value,{locale,format:locale.dateFormat}):CellErrorType.InvalidReference);}
function checkValueIsDate(value){const valueAsNumber=valueToDateNumber(value,DEFAULT_LOCALE);return valueAsNumber!==undefined;}
function checkValueIsNumber(value){const valueAsNumber=tryToNumber(value,DEFAULT_LOCALE);return valueAsNumber!==undefined;}
function getDateCriterionFormattedValues(criterion,getters){const locale=getters.getLocale();return criterion.values.map((valueStr)=>{if(valueStr.startsWith("=")){return valueStr;}
const value=parseLiteral(valueStr,locale);if(typeof value==="number"){return formatValue(value,{format:locale.dateFormat,locale});}
return"";});}
function interactiveStopEdition(env){const result=env.model.dispatch("STOP_EDITION");if(result.isCancelledBecause("BlockingValidationRule")){const editedCell=env.model.getters.getCurrentEditedCell();const cellXc=toXC(editedCell.col,editedCell.row);const rule=env.model.getters.getValidationRuleForCell(editedCell);if(!rule){return;}
const evaluator=dataValidationEvaluatorRegistry.get(rule.criterion.type);const errorStr=evaluator.getErrorString(rule.criterion,env.model.getters,editedCell.sheetId);env.raiseError(_t("The data you entered in %s violates the data validation rule set on the cell:\n%s",cellXc,errorStr));env.model.dispatch("CANCEL_EDITION");}}
const SEPARATORS=[{name:_t("Detect automatically"),value:"auto"},{name:_t("Custom separator"),value:"custom"},{name:_t("Space"),value:" "},{name:_t("Comma"),value:","},{name:_t("Semicolon"),value:";"},{name:_t("Line Break"),value:NEWLINE},];class SplitIntoColumnsPanel extends owl.Component{static template="o-spreadsheet-SplitIntoColumnsPanel";static components={ValidationMessages};state=owl.useState({separatorValue:"auto",addNewColumns:false,customSeparator:""});setup(){owl.onWillUpdateProps(()=>{if(this.env.model.getters.getEditionMode()!=="inactive"){this.props.onCloseSidePanel();}});owl.onMounted(()=>{interactiveStopEdition(this.env);});}
onSeparatorChange(value){this.state.separatorValue=value;}
updateCustomSeparator(ev){if(!ev.target)
return;this.state.customSeparator=ev.target.value;}
updateAddNewColumnsCheckbox(ev){if(!ev.target)
return;this.state.addNewColumns=ev.target.checked;}
confirm(){const result=interactiveSplitToColumns(this.env,this.separatorValue,this.state.addNewColumns);if(result.isSuccessful){this.props.onCloseSidePanel();}}
get errorMessages(){const cancelledReasons=this.env.model.canDispatch("SPLIT_TEXT_INTO_COLUMNS",{separator:this.separatorValue,addNewColumns:this.state.addNewColumns,force:true,}).reasons;const errors=new Set();for(const reason of cancelledReasons){switch(reason){case"SplitWillOverwriteContent":case"EmptySplitSeparator":break;default:errors.add(SplitToColumnsTerms.Errors[reason]||SplitToColumnsTerms.Errors.Unexpected);}}
return Array.from(errors);}
get warningMessages(){const warnings=[];const cancelledReasons=this.env.model.canDispatch("SPLIT_TEXT_INTO_COLUMNS",{separator:this.separatorValue,addNewColumns:this.state.addNewColumns,force:false,}).reasons;if(cancelledReasons.includes("SplitWillOverwriteContent")){warnings.push(SplitToColumnsTerms.Errors["SplitWillOverwriteContent"]);}
return warnings;}
get separatorValue(){if(this.state.separatorValue==="custom"){return this.state.customSeparator;}
else if(this.state.separatorValue==="auto"){return this.env.model.getters.getAutomaticSeparator();}
return this.state.separatorValue;}
get separators(){return SEPARATORS;}
get isConfirmDisabled(){return!this.separatorValue||this.errorMessages.length>0;}}
SplitIntoColumnsPanel.props={onCloseSidePanel:Function,};class SelectMenu extends owl.Component{static template="o-spreadsheet-SelectMenu";static components={Menu};menuId=new UuidGenerator().uuidv4();selectRef=owl.useRef("select");selectRect=useAbsoluteBoundingRect(this.selectRef);state=owl.useState({isMenuOpen:false,});onClick(ev){if(ev.closedMenuId===this.menuId){return;}
this.state.isMenuOpen=!this.state.isMenuOpen;}
onMenuClosed(){this.state.isMenuOpen=false;}
get menuPosition(){return{x:this.selectRect.x,y:this.selectRect.y+this.selectRect.height,};}}
SelectMenu.props={menuItems:Array,selectedValue:String,class:{type:String,optional:true},};class DataValidationCriterionForm extends owl.Component{setup(){owl.onMounted(()=>{interactiveStopEdition(this.env);});}
updateCriterion(criterion){const filteredCriterion={...this.props.criterion,...criterion,};this.props.onCriterionChanged(filteredCriterion);}}
DataValidationCriterionForm.props={criterion:Object,onCriterionChanged:Function,};css`
  .o-dv-input {
    .o-invalid {
      background-color: #ffdddd;
    }
    .error-icon {
      right: 7px;
      top: 7px;
    }
  }
`;class DataValidationInput extends owl.Component{static template="o-spreadsheet-DataValidationInput";static defaultProps={value:"",onKeyDown:()=>{},focused:false,onBlur:()=>{},};inputRef=owl.useRef("input");setup(){owl.useEffect(()=>{if(this.props.focused){this.inputRef.el.focus();}},()=>[this.props.focused,this.inputRef.el]);}
state=owl.useState({shouldDisplayError:!!this.props.value,});onValueChanged(ev){this.state.shouldDisplayError=true;this.props.onValueChanged(ev.target.value);}
get placeholder(){const evaluator=dataValidationEvaluatorRegistry.get(this.props.criterionType);if(evaluator.allowedValues==="onlyFormulas"){return _t("Formula");}
else if(evaluator.allowedValues==="onlyLiterals"){return _t("Value");}
return _t("Value or formula");}
get errorMessage(){if(!this.state.shouldDisplayError){return undefined;}
return this.env.model.getters.getDataValidationInvalidCriterionValueMessage(this.props.criterionType,canonicalizeContent(this.props.value,this.env.model.getters.getLocale()));}}
DataValidationInput.props={value:{type:String,optional:true},criterionType:String,onValueChanged:Function,onKeyDown:{type:Function,optional:true},focused:{type:Boolean,optional:true},onBlur:{type:Function,optional:true},onFocus:{type:Function,optional:true},};const DATES_VALUES={today:_t("today"),yesterday:_t("yesterday"),tomorrow:_t("tomorrow"),lastWeek:_t("in the past week"),lastMonth:_t("in the past month"),lastYear:_t("in the past year"),exactDate:_t("exact date"),};class DataValidationDateCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationDateCriterion";static components={DataValidationInput};setup(){super.setup();const setupDefault=(props)=>{if(props.criterion.dateValue===undefined){this.updateCriterion({dateValue:"exactDate"});}};owl.onWillUpdateProps(setupDefault);owl.onWillStart(()=>setupDefault(this.props));}
onValueChanged(value){this.updateCriterion({values:[value]});}
onDateValueChanged(ev){const dateValue=ev.target.value;this.updateCriterion({dateValue});}
get dateValues(){return Object.keys(DATES_VALUES).map((key)=>({value:key,title:DATES_VALUES[key],}));}}
class DataValidationDoubleInputCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationDoubleInput";static components={DataValidationInput};onFirstValueChanged(value){const values=this.props.criterion.values;this.updateCriterion({values:[value,values[1]],});}
onSecondValueChanged(value){const values=this.props.criterion.values;this.updateCriterion({values:[values[0],value],});}}
class DataValidationSingleInputCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationSingleInput";static components={DataValidationInput};onValueChanged(value){const criterion=deepCopy(this.props.criterion);criterion.values[0]=value;this.updateCriterion(criterion);}}
css`
  .o-dv-list-item-delete {
    color: #666666;
    cursor: pointer;
  }
`;class DataValidationListCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationListCriterionForm";static components={DataValidationInput};state=owl.useState({numberOfValues:Math.max(this.props.criterion.values.length,2),});setup(){super.setup();const setupDefault=(props)=>{if(props.criterion.displayStyle===undefined){this.updateCriterion({displayStyle:"arrow"});}};owl.onWillUpdateProps(setupDefault);owl.onWillStart(()=>setupDefault(this.props));}
onValueChanged(value,index){const values=[...this.displayedValues];values[index]=value;this.updateCriterion({values});}
onAddAnotherValue(){this.state.numberOfValues++;}
removeItem(index){const values=[...this.displayedValues];values.splice(index,1);this.state.numberOfValues--;this.updateCriterion({values});}
onChangedDisplayStyle(ev){const displayStyle=ev.target.value;this.updateCriterion({displayStyle});}
onKeyDown(ev,index){if((ev.key==="Enter"||ev.key==="Tab")&&index===this.state.numberOfValues-1){this.onAddAnotherValue();this.state.focusedValueIndex=index+1;ev.preventDefault();}
else if(ev.key==="Enter"){this.state.focusedValueIndex=index+1;}}
onBlurInput(){this.state.focusedValueIndex=undefined;}
get displayedValues(){const values=[];for(let i=0;i<this.state.numberOfValues;i++){values.push(this.props.criterion.values[i]||"");}
return values;}}
class DataValidationValueInRangeCriterionForm extends DataValidationCriterionForm{static template="o-spreadsheet-DataValidationValueInRangeCriterionForm";static components={SelectionInput};setup(){super.setup();const setupDefault=(props)=>{if(props.criterion.displayStyle===undefined){this.updateCriterion({displayStyle:"arrow"});}};owl.onWillUpdateProps(setupDefault);owl.onWillStart(()=>setupDefault(this.props));}
onRangeChanged(rangeXc){this.updateCriterion({values:[rangeXc]});}
onChangedDisplayStyle(ev){const displayStyle=ev.target.value;this.updateCriterion({displayStyle});}}
const dvCriterionCategoriesSequences={list:10,text:20,date:30,number:40,misc:50,};const dataValidationPanelCriteriaRegistry=new Registry();dataValidationPanelCriteriaRegistry.add("textContains",{type:"textContains",component:DataValidationSingleInputCriterionForm,category:"text",sequence:10,});dataValidationPanelCriteriaRegistry.add("textNotContains",{type:"textNotContains",component:DataValidationSingleInputCriterionForm,category:"text",sequence:20,});dataValidationPanelCriteriaRegistry.add("textIs",{type:"textIs",component:DataValidationSingleInputCriterionForm,category:"text",sequence:30,});dataValidationPanelCriteriaRegistry.add("textIsEmail",{type:"textIsEmail",component:undefined,category:"text",sequence:40,});dataValidationPanelCriteriaRegistry.add("textIsLink",{type:"textIsLink",component:undefined,category:"text",sequence:50,});dataValidationPanelCriteriaRegistry.add("dateIs",{type:"dateIs",component:DataValidationDateCriterionForm,category:"date",sequence:20,});dataValidationPanelCriteriaRegistry.add("dateIsBefore",{type:"dateIsBefore",component:DataValidationDateCriterionForm,category:"date",sequence:30,});dataValidationPanelCriteriaRegistry.add("dateIsOnOrBefore",{type:"dateIsOnOrBefore",component:DataValidationDateCriterionForm,category:"date",sequence:40,});dataValidationPanelCriteriaRegistry.add("dateIsAfter",{type:"dateIsAfter",component:DataValidationDateCriterionForm,category:"date",sequence:50,});dataValidationPanelCriteriaRegistry.add("dateIsOnOrAfter",{type:"dateIsOnOrAfter",component:DataValidationDateCriterionForm,category:"date",sequence:60,});dataValidationPanelCriteriaRegistry.add("dateIsBetween",{type:"dateIsBetween",component:DataValidationDoubleInputCriterionForm,category:"date",sequence:70,});dataValidationPanelCriteriaRegistry.add("dateIsNotBetween",{type:"dateIsNotBetween",component:DataValidationDoubleInputCriterionForm,category:"date",sequence:80,});dataValidationPanelCriteriaRegistry.add("dateIsValid",{type:"dateIsValid",component:undefined,category:"date",sequence:10,});dataValidationPanelCriteriaRegistry.add("isEqual",{type:"isEqual",component:DataValidationSingleInputCriterionForm,category:"number",sequence:10,});dataValidationPanelCriteriaRegistry.add("isNotEqual",{type:"isNotEqual",component:DataValidationSingleInputCriterionForm,category:"number",sequence:20,});dataValidationPanelCriteriaRegistry.add("isGreaterThan",{type:"isGreaterThan",component:DataValidationSingleInputCriterionForm,category:"number",sequence:50,});dataValidationPanelCriteriaRegistry.add("isGreaterOrEqualTo",{type:"isGreaterOrEqualTo",component:DataValidationSingleInputCriterionForm,category:"number",sequence:60,});dataValidationPanelCriteriaRegistry.add("isLessThan",{type:"isLessThan",component:DataValidationSingleInputCriterionForm,category:"number",sequence:30,});dataValidationPanelCriteriaRegistry.add("isLessOrEqualTo",{type:"isLessOrEqualTo",component:DataValidationSingleInputCriterionForm,category:"number",sequence:40,});dataValidationPanelCriteriaRegistry.add("isBetween",{type:"isBetween",component:DataValidationDoubleInputCriterionForm,category:"number",sequence:70,});dataValidationPanelCriteriaRegistry.add("isNotBetween",{type:"isNotBetween",component:DataValidationDoubleInputCriterionForm,category:"number",sequence:80,});dataValidationPanelCriteriaRegistry.add("isBoolean",{type:"isBoolean",component:undefined,category:"misc",sequence:10,});dataValidationPanelCriteriaRegistry.add("isValueInList",{type:"isValueInList",component:DataValidationListCriterionForm,category:"list",sequence:10,});dataValidationPanelCriteriaRegistry.add("isValueInRange",{type:"isValueInRange",component:DataValidationValueInRangeCriterionForm,category:"list",sequence:20,});dataValidationPanelCriteriaRegistry.add("customFormula",{type:"customFormula",component:DataValidationSingleInputCriterionForm,category:"misc",sequence:20,});function getDataValidationCriterionMenuItems(callback){const items=dataValidationPanelCriteriaRegistry.getAll().sort((a,b)=>{if(a.category===b.category){return a.sequence-b.sequence;}
return dvCriterionCategoriesSequences[a.category]-dvCriterionCategoriesSequences[b.category];});const actionSpecs=items.map((item,index)=>{const evaluator=dataValidationEvaluatorRegistry.get(item.type);return{name:evaluator.name,id:item.type,separator:item.category!==items[index+1]?.category,execute:()=>callback(item.type),};});return createActions(actionSpecs);}
css`
  .o-sidePanel .o-sidePanelBody .o-dv-form {
    .o-section {
      padding: 16px 16px 0 16px;
    }
  }
`;class DataValidationEditor extends owl.Component{static template="o-spreadsheet-DataValidationEditor";static components={SelectionInput,SelectMenu};state=owl.useState({rule:this.defaultDataValidationRule});setup(){if(this.props.rule){const sheetId=this.env.model.getters.getActiveSheetId();this.state.rule={...this.props.rule,ranges:this.props.rule.ranges.map((range)=>this.env.model.getters.getRangeString(range,sheetId)),};this.state.rule.criterion.type=this.props.rule.criterion.type;}}
onCriterionTypeChanged(type){this.state.rule.criterion.type=type;}
onRangesChanged(ranges){this.state.rule.ranges=ranges;}
onCriterionChanged(criterion){this.state.rule.criterion=criterion;}
changeRuleIsBlocking(ev){const isBlocking=ev.target.value;this.state.rule.isBlocking=isBlocking==="true";}
onSave(){if(!this.canSave){return;}
this.env.model.dispatch("ADD_DATA_VALIDATION_RULE",this.dispatchPayload);this.props.onExit();}
get canSave(){return this.env.model.canDispatch("ADD_DATA_VALIDATION_RULE",this.dispatchPayload).isSuccessful;}
get dispatchPayload(){const rule={...this.state.rule,ranges:undefined};const locale=this.env.model.getters.getLocale();const criterion=rule.criterion;const criterionEvaluator=dataValidationEvaluatorRegistry.get(criterion.type);const sheetId=this.env.model.getters.getActiveSheetId();const values=criterion.values.slice(0,criterionEvaluator.numberOfValues(criterion)).map((value)=>value?.trim()).filter((value)=>value!==""&&value!==undefined).map((value)=>canonicalizeContent(value,locale));rule.criterion={...criterion,values};return{sheetId,ranges:this.state.rule.ranges.map((xc)=>this.env.model.getters.getRangeDataFromXc(sheetId,xc)),rule,};}
get dvCriterionMenuItems(){return getDataValidationCriterionMenuItems((type)=>this.onCriterionTypeChanged(type));}
get selectedCriterionName(){const selectedType=this.state.rule.criterion.type;return dataValidationEvaluatorRegistry.get(selectedType).name;}
get defaultDataValidationRule(){const sheetId=this.env.model.getters.getActiveSheetId();const ranges=this.env.model.getters.getSelectedZones().map((zone)=>zoneToXc(this.env.model.getters.getUnboundedZone(sheetId,zone)));return{id:this.env.model.uuidGenerator.uuidv4(),criterion:{type:"textContains",values:[""]},ranges,};}
get criterionComponent(){return dataValidationPanelCriteriaRegistry.get(this.state.rule.criterion.type).component;}}
DataValidationEditor.props={rule:{type:Object,optional:true},onExit:Function,};css`
  .o-sidePanel {
    .o-dv-preview {
      height: 70px;
      box-sizing: border-box;
      cursor: pointer;
      border-bottom: 1px solid ${FIGURE_BORDER_COLOR};

      .o-dv-container {
        min-width: 0; // otherwise flex won't shrink correctly
      }

      .o-dv-preview-description {
        font-size: 13px;
      }

      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }

      &:not(:hover) .o-dv-preview-delete {
        display: none !important;
      }
    }
  }
`;class DataValidationPreview extends owl.Component{static template="o-spreadsheet-DataValidationPreview";deleteDataValidation(){const sheetId=this.env.model.getters.getActiveSheetId();this.env.model.dispatch("REMOVE_DATA_VALIDATION_RULE",{sheetId,id:this.props.rule.id});}
get rangesString(){const sheetId=this.env.model.getters.getActiveSheetId();return this.props.rule.ranges.map((range)=>this.env.model.getters.getRangeString(range,sheetId)).join(", ");}
get descriptionString(){return dataValidationEvaluatorRegistry.get(this.props.rule.criterion.type).getPreview(this.props.rule.criterion,this.env.model.getters);}}
DataValidationPreview.props={onClick:Function,rule:Object,};class DataValidationPanel extends owl.Component{static template="o-spreadsheet-DataValidationPanel";static components={DataValidationPreview,DataValidationEditor};state=owl.useState({mode:"list",activeRule:undefined});onPreviewClick(id){const sheetId=this.env.model.getters.getActiveSheetId();const rule=this.env.model.getters.getDataValidationRule(sheetId,id);if(rule){this.state.mode="edit";this.state.activeRule=rule;}}
addDataValidationRule(){this.state.mode="edit";this.state.activeRule=undefined;}
onExitEditMode(){this.state.mode="list";this.state.activeRule=undefined;}
localizeDVRule(rule){if(!rule)
return rule;const locale=this.env.model.getters.getLocale();return localizeDataValidationRule(rule,locale);}
get validationRules(){const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getDataValidationRules(sheetId);}}
DataValidationPanel.props={onCloseSidePanel:Function,};const sidePanelRegistry=new Registry();sidePanelRegistry.add("ConditionalFormatting",{title:_t("Conditional formatting"),Body:ConditionalFormattingPanel,});sidePanelRegistry.add("ChartPanel",{title:_t("Chart"),Body:ChartPanel,});sidePanelRegistry.add("FindAndReplace",{title:_t("Find and Replace"),Body:FindAndReplacePanel,});sidePanelRegistry.add("CustomCurrency",{title:_t("Custom currency format"),Body:CustomCurrencyPanel,});sidePanelRegistry.add("SplitToColumns",{title:_t("Split text into columns"),Body:SplitIntoColumnsPanel,});sidePanelRegistry.add("Settings",{title:_t("Spreadsheet settings"),Body:SettingsPanel,});sidePanelRegistry.add("RemoveDuplicates",{title:_t("Remove duplicates"),Body:RemoveDuplicatesPanel,});sidePanelRegistry.add("DataValidation",{title:_t("Data validation"),Body:DataValidationPanel,});sidePanelRegistry.add("MoreFormats",{title:_t("More date formats"),Body:MoreFormatsPanel,});class TopBarComponentRegistry extends Registry{mapping={};uuidGenerator=new UuidGenerator();add(name,value){const component={...value,id:this.uuidGenerator.uuidv4()};return super.add(name,component);}}
const topbarComponentRegistry=new TopBarComponentRegistry();const ANCHOR_SIZE=8;const BORDER_WIDTH=1;const ACTIVE_BORDER_WIDTH=2;css`
  div.o-figure {
    box-sizing: border-box;
    position: absolute;
    width: 100%;
    height: 100%;
    user-select: none;

    &:focus {
      outline: none;
    }
  }

  div.o-figure-border {
    box-sizing: border-box;
    z-index: 1;
  }

  .o-figure-wrapper {
    position: absolute;
    box-sizing: content-box;

    .o-fig-anchor {
      z-index: ${ComponentsImportance.FigureAnchor};
      position: absolute;
      width: ${ANCHOR_SIZE}px;
      height: ${ANCHOR_SIZE}px;
      background-color: #1a73e8;
      outline: ${BORDER_WIDTH}px solid white;

      &.o-top {
        cursor: n-resize;
      }
      &.o-topRight {
        cursor: ne-resize;
      }
      &.o-right {
        cursor: e-resize;
      }
      &.o-bottomRight {
        cursor: se-resize;
      }
      &.o-bottom {
        cursor: s-resize;
      }
      &.o-bottomLeft {
        cursor: sw-resize;
      }
      &.o-left {
        cursor: w-resize;
      }
      &.o-topLeft {
        cursor: nw-resize;
      }
    }

    .o-figure-menu {
      right: 0px;
      top: 0px;
      display: none;
    }

    .o-figure-menu-item {
      cursor: pointer;
    }

    .o-figure.active:focus,
    .o-figure:hover {
      .o-figure-menu {
        display: flex;
      }
    }
  }
`;class FigureComponent extends owl.Component{static template="o-spreadsheet-FigureComponent";static components={Menu};static defaultProps={onFigureDeleted:()=>{},onMouseDown:()=>{},onClickAnchor:()=>{},};menuState=owl.useState({isOpen:false,position:null,menuItems:[]});figureRef=owl.useRef("figure");menuButtonRef=owl.useRef("menuButton");menuButtonRect=useAbsoluteBoundingRect(this.menuButtonRef);borderWidth;get isSelected(){return this.env.model.getters.getSelectedFigureId()===this.props.figure.id;}
get figureRegistry(){return figureRegistry;}
getBorderWidth(){if(this.env.isDashboard())
return 0;return this.isSelected?ACTIVE_BORDER_WIDTH:this.borderWidth;}
get borderStyle(){const borderWidth=this.getBorderWidth();const borderColor=this.isSelected?SELECTION_BORDER_COLOR:FIGURE_BORDER_COLOR;return`border: ${borderWidth}px solid ${borderColor};`;}
get wrapperStyle(){const{x,y,width,height}=this.props.figure;return cssPropertiesToCss({left:`${x}px`,top:`${y}px`,width:`${width}px`,height:`${height}px`,"z-index":String(ComponentsImportance.Figure+(this.isSelected?1:0)),});}
getResizerPosition(resizer){const anchorCenteringOffset=(ANCHOR_SIZE-ACTIVE_BORDER_WIDTH)/2;let style={};if(resizer.includes("top")){style.top=`${-anchorCenteringOffset}px`;}
else if(resizer.includes("bottom")){style.bottom=`${-anchorCenteringOffset}px`;}
else{style.bottom=`calc(50% - ${anchorCenteringOffset}px)`;}
if(resizer.includes("left")){style.left=`${-anchorCenteringOffset}px`;}
else if(resizer.includes("right")){style.right=`${-anchorCenteringOffset}px`;}
else{style.right=`calc(50% - ${anchorCenteringOffset}px)`;}
return cssPropertiesToCss(style);}
setup(){const borderWidth=figureRegistry.get(this.props.figure.tag).borderWidth;this.borderWidth=borderWidth!==undefined?borderWidth:BORDER_WIDTH;owl.useEffect((selectedFigureId,thisFigureId,el)=>{if(selectedFigureId===thisFigureId){el?.focus({preventScroll:true});}},()=>[this.env.model.getters.getSelectedFigureId(),this.props.figure.id,this.figureRef.el]);owl.onWillUnmount(()=>{this.props.onFigureDeleted();});}
clickAnchor(dirX,dirY,ev){this.props.onClickAnchor(dirX,dirY,ev);}
onMouseDown(ev){this.props.onMouseDown(ev);}
onKeyDown(ev){const figure=this.props.figure;const keyDownShortcut=keyboardEventToShortcutString(ev);switch(keyDownShortcut){case"Delete":this.env.model.dispatch("DELETE_FIGURE",{sheetId:this.env.model.getters.getActiveSheetId(),id:figure.id,});this.props.onFigureDeleted();ev.preventDefault();ev.stopPropagation();break;case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"ArrowUp":const deltaMap={ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0],ArrowUp:[0,-1],};const delta=deltaMap[ev.key];this.env.model.dispatch("UPDATE_FIGURE",{sheetId:this.env.model.getters.getActiveSheetId(),id:figure.id,x:figure.x+delta[0],y:figure.y+delta[1],});ev.preventDefault();ev.stopPropagation();break;case"Ctrl+A":ev.preventDefault();ev.stopPropagation();break;case"Ctrl+Y":case"Ctrl+Z":if(keyDownShortcut==="Ctrl+Y"){this.env.model.dispatch("REQUEST_REDO");}
else if(keyDownShortcut==="Ctrl+Z"){this.env.model.dispatch("REQUEST_UNDO");}
ev.preventDefault();ev.stopPropagation();break;}}
onContextMenu(ev){if(this.env.isDashboard())
return;const position={x:ev.clientX,y:ev.clientY,};this.openContextMenu(position);}
showMenu(){const{x,y,width}=this.menuButtonRect;const menuPosition={x:x>=MENU_WIDTH?x-MENU_WIDTH:x+width,y:y,};this.openContextMenu(menuPosition);}
openContextMenu(position){this.menuState.isOpen=true;this.menuState.position=position;this.menuState.menuItems=figureRegistry.get(this.props.figure.tag).menuBuilder(this.props.figure.id,this.props.onFigureDeleted,this.env);}}
FigureComponent.props={figure:Object,style:{type:String,optional:true},onFigureDeleted:{type:Function,optional:true},onMouseDown:{type:Function,optional:true},onClickAnchor:{type:Function,optional:true},};const ToggleGroupInteractiveContent={CannotHideAllRows:_t("Cannot hide all the rows of a sheet."),CannotHideAllColumns:_t("Cannot hide all the columns of a sheet."),};function interactiveToggleGroup(env,sheetId,dimension,start,end){const group=env.model.getters.getHeaderGroup(sheetId,dimension,start,end);if(!group){return;}
const command=group.isFolded?"UNFOLD_HEADER_GROUP":"FOLD_HEADER_GROUP";const result=env.model.dispatch(command,{sheetId,dimension,start:group.start,end:group.end,});if(!result.isSuccessful){if(result.isCancelledBecause("NotEnoughElements")){const errorMessage=dimension==="ROW"?ToggleGroupInteractiveContent.CannotHideAllRows:ToggleGroupInteractiveContent.CannotHideAllColumns;env.raiseError(errorMessage);}}}
function createHeaderGroupContainerContextMenu(sheetId,dimension){return createActions([{id:"unfold_all",name:dimension==="ROW"?_t("Expand all row groups"):_t("Expand all column groups"),execute:(env)=>{env.model.dispatch("UNFOLD_ALL_HEADER_GROUPS",{sheetId,dimension});},},{id:"fold_all",name:dimension==="ROW"?_t("Collapse all row groups"):_t("Collapse all column groups"),execute:(env)=>{env.model.dispatch("FOLD_ALL_HEADER_GROUPS",{sheetId,dimension});},},]);}
function getHeaderGroupContextMenu(sheetId,dimension,start,end){const groupActions=createActions([{id:"toggle_group",name:(env)=>{const sheetId=env.model.getters.getActiveSheetId();const groupIsFolded=env.model.getters.isGroupFolded(sheetId,dimension,start,end);if(groupIsFolded){return dimension==="ROW"?_t("Expand row group"):_t("Expand column group");}
else{return dimension==="ROW"?_t("Collapse row group"):_t("Collapse column group");}},execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();interactiveToggleGroup(env,sheetId,dimension,start,end);},},{id:"remove_group",name:dimension==="ROW"?_t("Remove row group"):_t("Remove column group"),execute:(env)=>{const sheetId=env.model.getters.getActiveSheetId();env.model.dispatch("UNGROUP_HEADERS",{sheetId,dimension,start,end});},separator:true,},]);return[...groupActions,...createHeaderGroupContainerContextMenu(sheetId,dimension)];}
const groupHeadersMenuRegistry=new MenuItemRegistry();groupHeadersMenuRegistry.add("group_columns",{sequence:10,...groupColumns,isVisible:()=>true,isEnabled:groupColumns.isVisible,}).add("group_rows",{sequence:20,...groupRows,isVisible:()=>true,isEnabled:groupRows.isVisible,});const unGroupHeadersMenuRegistry=new MenuItemRegistry();unGroupHeadersMenuRegistry.add("ungroup_columns",{sequence:10,...ungroupColumns,isEnabled:(env)=>canUngroupHeaders(env,"COL"),}).add("ungroup_rows",{sequence:20,...ungroupRows,isEnabled:(env)=>canUngroupHeaders(env,"ROW"),});css`
  .o-autofill {
    position: absolute;
    height: ${AUTOFILL_EDGE_LENGTH}px;
    width: ${AUTOFILL_EDGE_LENGTH}px;
    border: 1px solid white;
    box-sizing: border-box !important;
    background-color: #1a73e8;
  }

  .o-autofill-handler {
    position: absolute;
    height: ${AUTOFILL_EDGE_LENGTH}px;
    width: ${AUTOFILL_EDGE_LENGTH}px;
    &:hover {
      cursor: crosshair;
    }
  }

  .o-autofill-nextvalue {
    position: absolute;
    background-color: #ffffff;
    border: 1px solid black;
    padding: 5px;
    font-size: 12px;
    pointer-events: none;
    white-space: nowrap;
  }
`;class Autofill extends owl.Component{static template="o-spreadsheet-Autofill";state=owl.useState({position:{left:0,top:0},handler:false,});get style(){const{left,top}=this.props.position;return cssPropertiesToCss({top:`${top}px`,left:`${left}px`,visibility:this.props.isVisible?"visible":"hidden",});}
get handlerStyle(){const{left,top}=this.state.handler?this.state.position:this.props.position;return cssPropertiesToCss({top:`${top}px`,left:`${left}px`,});}
get styleNextValue(){const{left,top}=this.state.position;return cssPropertiesToCss({top:`${top + 5}px`,left:`${left + 15}px`,});}
getTooltip(){const tooltip=this.env.model.getters.getAutofillTooltip();if(tooltip&&!tooltip.component){tooltip.component=TooltipComponent;}
return tooltip;}
onMouseDown(ev){this.state.handler=true;let lastCol;let lastRow;const start={left:ev.clientX-this.props.position.left,top:ev.clientY-this.props.position.top,};const onMouseUp=()=>{this.state.handler=false;this.state.position={...this.props.position};this.env.model.dispatch("AUTOFILL");};const onMouseMove=(col,row,ev)=>{this.state.position={left:ev.clientX-start.left,top:ev.clientY-start.top,};if(lastCol!==col||lastRow!==row){const activeSheetId=this.env.model.getters.getActiveSheetId();const numberOfCols=this.env.model.getters.getNumberCols(activeSheetId);const numberOfRows=this.env.model.getters.getNumberRows(activeSheetId);lastCol=col===-1?lastCol:clip(col,0,numberOfCols);lastRow=row===-1?lastRow:clip(row,0,numberOfRows);if(lastCol!==undefined&&lastRow!==undefined){this.env.model.dispatch("AUTOFILL_SELECT",{col:lastCol,row:lastRow});}}};dragAndDropBeyondTheViewport(this.env,onMouseMove,onMouseUp);}
onDblClick(){this.env.model.dispatch("AUTOFILL_AUTO");}}
Autofill.props={position:Object,isVisible:Boolean,};class TooltipComponent extends owl.Component{static template=owl.xml`
    <div t-esc="props.content"/>
  `;}
TooltipComponent.props={content:String,};css`
  .o-client-tag {
    position: absolute;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
    font-size: ${DEFAULT_FONT_SIZE};
    color: white;
    pointer-events: none;
  }
`;class ClientTag extends owl.Component{static template="o-spreadsheet-ClientTag";get tagStyle(){const{col,row,color}=this.props;const{height}=this.env.model.getters.getSheetViewDimensionWithHeaders();const{x,y}=this.env.model.getters.getVisibleRect({left:col,top:row,right:col,bottom:row,});return cssPropertiesToCss({bottom:`${height - y + 15}px`,left:`${x - 1}px`,border:`1px solid ${color}`,"background-color":color,});}}
ClientTag.props={active:Boolean,name:String,color:String,col:Number,row:Number,};function getHtmlContentFromPattern(pattern,value,highlightColor,className){const pendingHtmlContent=[];pattern=pattern.toLowerCase();for(const patternChar of pattern){const index=value.toLocaleLowerCase().indexOf(patternChar);if(index===-1){continue;}
pendingHtmlContent.push({value:value.slice(0,index),color:""},{value:value[index],color:highlightColor,class:className});value=value.slice(index+1);}
pendingHtmlContent.push({value});const htmlContent=pendingHtmlContent.filter((content)=>content.value);return htmlContent;}
css`
  .o-autocomplete-dropdown {
    pointer-events: auto;
    cursor: pointer;
    background-color: #fff;
    max-width: 400px;

    .o-autocomplete-value-focus {
      background-color: #f2f2f2;
    }

    & > div {
      padding: 1px 5px 5px 5px;
      .o-autocomplete-description {
        padding-left: 5px;
        font-size: 11px;
      }
    }
  }
`;class TextValueProvider extends owl.Component{static template="o-spreadsheet-TextValueProvider";autoCompleteListRef=owl.useRef("autoCompleteList");setup(){owl.useEffect(()=>{const selectedIndex=this.props.selectedIndex;if(selectedIndex===undefined){return;}
const selectedElement=this.autoCompleteListRef.el?.children[selectedIndex];selectedElement?.scrollIntoView?.({block:"nearest"});},()=>[this.props.selectedIndex,this.autoCompleteListRef.el]);}}
TextValueProvider.props={values:Array,selectedIndex:{type:Number,optional:true},getHtmlContent:Function,onValueSelected:Function,onValueHovered:Function,};class ContentEditableHelper{el;constructor(el){this.el=el;}
updateEl(el){this.el=el;}
selectRange(start,end){let selection=window.getSelection();const{start:currentStart,end:currentEnd}=this.getCurrentSelection();if(currentStart===start&&currentEnd===end){return;}
const currentRange=selection.getRangeAt(0);let range;if(this.el.contains(currentRange.startContainer)){range=currentRange;}
else{range=document.createRange();selection.removeAllRanges();selection.addRange(range);}
if(start===end&&start===0){range.setStart(this.el,0);range.setEnd(this.el,0);}
else{const textLength=this.getText().length;if(start<0||end>textLength){console.warn(`wrong selection asked start ${start}, end ${end}, text content length ${textLength}`);if(start<0)
start=0;if(end>textLength)
end=textLength;if(start>textLength)
start=textLength;}
let startNode=this.findChildAtCharacterIndex(start);let endNode=this.findChildAtCharacterIndex(end);range.setStart(startNode.node,startNode.offset);selection.extend(endNode.node,endNode.offset);}}
findChildAtCharacterIndex(offset){let it=iterateChildren(this.el);let current,previous;let usedCharacters=offset;let isFirstParagraph=true;do{current=it.next();if(!current.done&&!current.value.hasChildNodes()){if(current.value.textContent&&current.value.textContent.length<usedCharacters){usedCharacters-=current.value.textContent.length;}
else if(current.value.textContent&&current.value.textContent.length>=usedCharacters){it.return(current.value);}
previous=current.value;}
if(!current.done&&current.value.nodeName==="P"){if(isFirstParagraph){isFirstParagraph=false;}
else{usedCharacters--;}}}while(!current.done&&usedCharacters);if(current.value){return{node:current.value,offset:usedCharacters};}
return{node:previous,offset:usedCharacters};}
setText(contents){if(contents.length===0){this.removeAll();return;}
const childElements=Array.from(this.el.childNodes);const contentLength=contents.length;for(let i=0;i<contentLength;i++){const line=contents[i];const childElement=childElements[i];let newChild=false;let p;if(childElement&&childElement.nodeName==="P"){p=childElement;}
else{newChild=true;p=document.createElement("p");}
const lineLength=line.length;const existingChildren=Array.from(p.childNodes);for(let j=0;j<lineLength;j++){const content=line[j];const child=existingChildren[j];const childIsSpan=child&&"tagName"in child&&child.tagName==="SPAN";if(childIsSpan&&compareContentToSpanElement(content,child)){continue;}
if(!content.value&&!content.class){if(child)
p.removeChild(child);continue;}
const span=document.createElement("span");span.innerText=content.value;span.style.color=content.color||"";if(content.class){span.classList.add(content.class);}
if(child){p.replaceChild(span,child);}
else{p.appendChild(span);}}
if(existingChildren.length>lineLength){for(let i=lineLength;i<existingChildren.length;i++){p.removeChild(existingChildren[i]);}}
if(!p.hasChildNodes()){const span=document.createElement("span");span.appendChild(document.createElement("br"));p.appendChild(span);}
if(newChild){if(childElement){this.el.replaceChild(p,childElement);}
else{this.el.appendChild(p);}}}
if(childElements.length>contentLength){for(let i=contentLength;i<childElements.length;i++){this.el.removeChild(childElements[i]);}}}
scrollSelectionIntoView(){const focusedNode=document.getSelection()?.focusNode;if(!focusedNode||!this.el.contains(focusedNode))
return;const element=focusedNode instanceof HTMLElement?focusedNode:focusedNode.parentElement;element?.scrollIntoView({block:"nearest"});}
removeSelection(){let selection=window.getSelection();selection.removeAllRanges();}
removeAll(){if(this.el){while(this.el.firstChild){this.el.removeChild(this.el.firstChild);}}}
getCurrentSelection(){let{startElement,endElement,startSelectionOffset,endSelectionOffset}=this.getStartAndEndSelection();let startSizeBefore=this.findSelectionIndex(startElement,startSelectionOffset);let endSizeBefore=this.findSelectionIndex(endElement,endSelectionOffset);return{start:startSizeBefore,end:endSizeBefore,};}
findSelectionIndex(nodeToFind,nodeOffset){let usedCharacters=0;let it=iterateChildren(this.el);let current=it.next();let isFirstParagraph=true;while(!current.done&&current.value!==nodeToFind){if(!current.value.hasChildNodes()){if(current.value.textContent){usedCharacters+=current.value.textContent.length;}}
if(current.value.nodeName==="P"||(current.value.nodeName==="DIV"&&current.value!==this.el)){if(isFirstParagraph){isFirstParagraph=false;}
else{usedCharacters++;}}
current=it.next();}
if(current.value!==nodeToFind){return 0;}
else{if(!current.value.hasChildNodes()){usedCharacters+=nodeOffset;}
else{const children=[...current.value.childNodes].slice(0,nodeOffset);usedCharacters+=children.reduce((acc,child,index)=>{if(child.textContent!==null){let chars=child.textContent.length;if(child.nodeName==="P"&&index!==children.length-1){chars++;}
return acc+chars;}
else{return acc;}},0);}}
if(nodeToFind.nodeName==="P"&&!isFirstParagraph&&nodeToFind.textContent===""){usedCharacters++;}
return usedCharacters;}
getStartAndEndSelection(){const selection=document.getSelection();return{startElement:selection.anchorNode||this.el,startSelectionOffset:selection.anchorOffset,endElement:selection.focusNode||this.el,endSelectionOffset:selection.focusOffset,};}
getText(){let text="";let it=iterateChildren(this.el);let current=it.next();let isFirstParagraph=true;while(!current.done){if(!current.value.hasChildNodes()){text+=current.value.textContent;}
if(current.value.nodeName==="P"||(current.value.nodeName==="DIV"&&current.value!==this.el)){if(isFirstParagraph){isFirstParagraph=false;}
else{text+=NEWLINE;}}
current=it.next();}
return text;}}
function compareContentToSpanElement(content,node){const contentColor=content.color?toHex(content.color):"";const nodeColor=node.style?.color?toHex(node.style.color):"";const sameColor=contentColor===nodeColor;const sameClass=deepEquals([content.class],[...node.classList]);const sameContent=node.innerText===content.value;return sameColor&&sameClass&&sameContent;}
css`
  .o-formula-assistant {
    background: #ffffff;
    .o-formula-assistant-head {
      background-color: #f2f2f2;
      padding: 10px;
    }
    .o-formula-assistant-core {
      border-bottom: 1px solid gray;
    }
    .o-formula-assistant-arg-description {
      font-size: 85%;
    }
    .o-formula-assistant-focus {
      div:first-child,
      span {
        color: ${COMPOSER_ASSISTANT_COLOR};
        text-shadow: 0px 0px 1px ${COMPOSER_ASSISTANT_COLOR};
      }
      div:last-child {
        color: black;
      }
    }
    .o-formula-assistant-gray {
      color: gray;
    }
  }
`;class FunctionDescriptionProvider extends owl.Component{static template="o-spreadsheet-FunctionDescriptionProvider";assistantState=owl.useState({allowCellSelectionBehind:false,});timeOutId=0;setup(){owl.onWillUnmount(()=>{if(this.timeOutId){clearTimeout(this.timeOutId);}});}
getContext(){return this.props;}
onMouseMove(){this.assistantState.allowCellSelectionBehind=true;if(this.timeOutId){clearTimeout(this.timeOutId);}
this.timeOutId=setTimeout(()=>{this.assistantState.allowCellSelectionBehind=false;},2000);}
get formulaArgSeparator(){return this.env.model.getters.getLocale().formulaArgSeparator+" ";}}
FunctionDescriptionProvider.props={functionName:String,functionDescription:Object,argToFocus:Number,};const functions$2=functionRegistry.content;const ASSISTANT_WIDTH=300;const AUTOCOMPLETE_ENTRIES=10;const selectionIndicatorClass="selector-flag";const selectionIndicatorColor="#a9a9a9";const selectionIndicator="␣";const functionColor="#4a4e4d";const operatorColor="#3da4ab";const tokenColors={OPERATOR:operatorColor,NUMBER:"#02c39a",STRING:"#00a82d",FUNCTION:functionColor,DEBUGGER:operatorColor,LEFT_PAREN:functionColor,RIGHT_PAREN:functionColor,ARG_SEPARATOR:functionColor,MATCHING_PAREN:"#000000",};css`
  .o-composer-container {
    .o-composer {
      overflow-y: auto;
      overflow-x: hidden;
      word-break: break-all;
      padding-right: 2px;

      box-sizing: border-box;
      font-family: ${DEFAULT_FONT};

      caret-color: black;
      padding-left: 3px;
      padding-right: 3px;
      outline: none;

      p {
        margin-bottom: 0px;

        span {
          white-space: pre-wrap;
          &.${selectionIndicatorClass}:after {
            content: "${selectionIndicator}";
            color: ${selectionIndicatorColor};
          }
        }
      }
    }

    .o-composer-assistant {
      position: absolute;
      margin: 1px 4px;
      pointer-events: none;
      overflow: auto;

      .o-semi-bold {
        /** FIXME: to remove in favor of Bootstrap
        * 'fw-semibold' when we upgrade to Bootstrap 5.2
        */
        font-weight: 600 !important;
      }
    }
  }
`;class Composer extends owl.Component{static template="o-spreadsheet-Composer";static components={TextValueProvider,FunctionDescriptionProvider};static defaultProps={inputStyle:"",isDefaultFocus:false,};composerRef=owl.useRef("o_composer");contentHelper=new ContentEditableHelper(this.composerRef.el);composerState=owl.useState({positionStart:0,positionEnd:0,});autoCompleteState=owl.useState({showProvider:false,values:[],selectedIndex:undefined,type:"function",getHtmlContent:()=>[],});functionDescriptionState=owl.useState({showDescription:false,functionName:"",functionDescription:{},argToFocus:0,});compositionActive=false;get assistantStyle(){const assistantStyle={};assistantStyle["min-width"]=`${this.props.rect?.width || ASSISTANT_WIDTH}px`;if(this.autoCompleteState.type==="function"){assistantStyle.width=`${ASSISTANT_WIDTH}px`;}
if(this.props.delimitation&&this.props.rect){const{x:cellX,y:cellY,height:cellHeight}=this.props.rect;const remainingHeight=this.props.delimitation.height-(cellY+cellHeight);assistantStyle["max-height"]=`${remainingHeight}px`;if(cellY>remainingHeight){const availableSpaceAbove=cellY;assistantStyle["max-height"]=`${availableSpaceAbove}px`;assistantStyle.top=`-3px`;assistantStyle.transform=`translate(0, -100%)`;}
if(cellX+ASSISTANT_WIDTH>this.props.delimitation.width){assistantStyle.right=`0px`;}}
return cssPropertiesToCss(assistantStyle);}
shouldProcessInputEvents=false;tokens=[];keyMapping={ArrowUp:this.processArrowKeys,ArrowDown:this.processArrowKeys,ArrowLeft:this.processArrowKeys,ArrowRight:this.processArrowKeys,Enter:this.processEnterKey,Escape:this.processEscapeKey,F2:()=>console.warn("Not implemented"),F4:(ev)=>this.processF4Key(ev),Tab:(ev)=>this.processTabKey(ev),};keyCodeMapping={NumpadDecimal:this.processNumpadDecimal,};setup(){owl.onMounted(()=>{const el=this.composerRef.el;if(this.props.isDefaultFocus){this.env.focusableElement.setFocusableElement(el);}
this.contentHelper.updateEl(el);});owl.useEffect(()=>{this.processContent();});owl.useEffect(()=>{this.processTokenAtCursor();},()=>[this.env.model.getters.getEditionMode()!=="inactive"]);}
processArrowKeys(ev){if(this.env.model.getters.isSelectingForComposer()||this.env.model.getters.getEditionMode()==="inactive"){this.functionDescriptionState.showDescription=false;ev.preventDefault();ev.stopPropagation();updateSelectionWithArrowKeys(ev,this.env.model.selection);return;}
const content=this.env.model.getters.getCurrentContent();if(this.props.focus==="cellFocus"&&!this.autoCompleteState.showProvider&&!content.startsWith("=")){interactiveStopEdition(this.env);return;}
ev.stopPropagation();this.handleArrowKeysForAutocomplete(ev);}
handleArrowKeysForAutocomplete(ev){if(["ArrowUp","ArrowDown"].includes(ev.key)&&this.autoCompleteState.showProvider){ev.preventDefault();if(this.autoCompleteState.selectedIndex===undefined){this.autoCompleteState.selectedIndex=0;return;}
if(ev.key==="ArrowUp"){this.autoCompleteState.selectedIndex--;if(this.autoCompleteState.selectedIndex<0){this.autoCompleteState.selectedIndex=this.autoCompleteState.values.length-1;}}
else{this.autoCompleteState.selectedIndex=(this.autoCompleteState.selectedIndex+1)%this.autoCompleteState.values.length;}}}
processTabKey(ev){ev.preventDefault();ev.stopPropagation();if(this.env.model.getters.getEditionMode()!=="inactive"){const state=this.autoCompleteState;if(state.showProvider&&state.selectedIndex!==undefined){const autoCompleteValue=this.autoCompleteState.values[state.selectedIndex]?.text;if(autoCompleteValue){this.autoComplete(autoCompleteValue);return;}}
interactiveStopEdition(this.env);}
const direction=ev.shiftKey?"left":"right";this.env.model.selection.moveAnchorCell(direction,1);}
processEnterKey(ev){ev.preventDefault();ev.stopPropagation();if(ev.altKey||ev.ctrlKey){this.composerRef.el?.dispatchEvent(new InputEvent("input",{inputType:"insertParagraph",bubbles:true,isComposing:false}));return;}
const state=this.autoCompleteState;if(state.showProvider&&state.selectedIndex!==undefined){const autoCompleteValue=this.autoCompleteState.values[state.selectedIndex]?.text;if(autoCompleteValue){this.autoComplete(autoCompleteValue);return;}}
interactiveStopEdition(this.env);const direction=ev.shiftKey?"up":"down";this.env.model.selection.moveAnchorCell(direction,1);}
processEscapeKey(){this.env.model.dispatch("CANCEL_EDITION");}
processF4Key(ev){this.env.model.dispatch("CYCLE_EDITION_REFERENCES");this.processContent();ev.stopPropagation();}
processNumpadDecimal(ev){ev.stopPropagation();ev.preventDefault();const locale=this.env.model.getters.getLocale();const selection=this.contentHelper.getCurrentSelection();const currentContent=this.env.model.getters.getCurrentContent();const content=currentContent.slice(0,selection.start)+
locale.decimalSeparator+
currentContent.slice(selection.end);this.env.model.dispatch("SET_CURRENT_CONTENT",{content,selection:{start:selection.start+1,end:selection.start+1},});this.processContent();}
onCompositionStart(){this.compositionActive=true;}
onCompositionEnd(){this.compositionActive=false;}
onKeydown(ev){if(this.env.model.getters.getEditionMode()==="inactive"){return;}
let handler=this.keyMapping[ev.key]||this.keyCodeMapping[ev.code];if(handler){handler.call(this,ev);}
else{ev.stopPropagation();}}
onPaste(ev){if(this.env.model.getters.getEditionMode()!=="inactive"){ev.stopPropagation();}
else{ev.preventDefault();}}
onInput(ev){if(!this.shouldProcessInputEvents){return;}
ev.stopPropagation();let content;if(this.env.model.getters.getEditionMode()==="inactive"){content=ev.data||"";}
else{content=this.contentHelper.getText();}
if(this.props.focus==="inactive"){return this.props.onComposerCellFocused?.(content);}
let selection=this.contentHelper.getCurrentSelection();if(ev.inputType==="insertParagraph"){const start=Math.min(selection.start,selection.end);const end=Math.max(selection.start,selection.end);content=content.slice(0,start)+NEWLINE+content.slice(end);selection={start:start+1,end:start+1};}
this.env.model.dispatch("STOP_COMPOSER_RANGE_SELECTION");this.env.model.dispatch("SET_CURRENT_CONTENT",{content,selection,});this.processTokenAtCursor();}
onKeyup(ev){if(this.contentHelper.el===document.activeElement){if(this.autoCompleteState.showProvider&&["ArrowUp","ArrowDown"].includes(ev.key)){return;}
if(this.env.model.getters.isSelectingForComposer()&&ev.key?.startsWith("Arrow")){return;}
const{start:oldStart,end:oldEnd}=this.env.model.getters.getComposerSelection();const{start,end}=this.contentHelper.getCurrentSelection();if(start!==oldStart||end!==oldEnd){this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",{start,end});}
this.processTokenAtCursor();}}
showFunctionAutocomplete(searchTerm){const searchTermUpperCase=searchTerm.toUpperCase();if(!this.env.model.getters.getCurrentContent().startsWith("=")||searchTermUpperCase==="TRUE"||searchTermUpperCase==="FALSE"){return;}
this.autoCompleteState.showProvider=true;this.autoCompleteState.type="function";let values=Object.entries(functionRegistry.content).filter(([_,{hidden}])=>!hidden).map(([text,{description}])=>{return{text,description,};}).sort((a,b)=>{return a.text.length-b.text.length||a.text.localeCompare(b.text);});if(searchTerm){values=fuzzyLookup(searchTerm,values,(t)=>t.text).slice(0,AUTOCOMPLETE_ENTRIES);}
this.autoCompleteState.values=values.slice(0,AUTOCOMPLETE_ENTRIES);this.autoCompleteState.getHtmlContent=(value)=>getHtmlContentFromPattern(searchTerm,value,COMPOSER_ASSISTANT_COLOR,"o-semi-bold");this.autoCompleteState.selectedIndex=0;}
updateAutoCompleteIndex(index){this.autoCompleteState.selectedIndex=clip(0,index,10);}
onMousedown(ev){if(ev.button>0){return;}
this.contentHelper.removeSelection();}
onClick(){if(this.env.model.getters.isReadonly()){return;}
const newSelection=this.contentHelper.getCurrentSelection();this.env.model.dispatch("STOP_COMPOSER_RANGE_SELECTION");this.props.onComposerContentFocused();if(this.props.focus==="inactive");this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",newSelection);this.processTokenAtCursor();}
onDblClick(){if(this.env.model.getters.isReadonly()){return;}
const composerContent=this.env.model.getters.getCurrentContent();const isValidFormula=composerContent.startsWith("=");if(isValidFormula){const tokens=this.env.model.getters.getCurrentTokens();const currentSelection=this.contentHelper.getCurrentSelection();if(currentSelection.start===currentSelection.end)
return;const currentSelectedText=composerContent.substring(currentSelection.start,currentSelection.end);const token=tokens.filter((token)=>token.value.includes(currentSelectedText)&&token.start<=currentSelection.start&&token.end>=currentSelection.end)[0];if(!token){return;}
if(token.type==="REFERENCE"){this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",{start:token.start,end:token.end,});}}}
onContextMenu(ev){if(this.env.model.getters.getEditionMode()==="inactive"){this.props.onInputContextMenu?.(ev);}}
processContent(){if(this.compositionActive){return;}
this.shouldProcessInputEvents=false;if(this.props.focus!=="inactive"){this.contentHelper.el.focus();}
const content=this.getContentLines();this.contentHelper.setText(content);if(content.length!==0&&content.length[0]!==0){if(this.props.focus!=="inactive"){const{start,end}=this.env.model.getters.getComposerSelection();this.contentHelper.selectRange(start,end);}
this.contentHelper.scrollSelectionIntoView();}
this.shouldProcessInputEvents=true;}
getContentLines(){let value=this.env.model.getters.getCurrentContent();const isValidFormula=value.startsWith("=");if(value===""){return[];}
else if(isValidFormula&&this.props.focus!=="inactive"){return this.splitHtmlContentIntoLines(this.getColoredTokens());}
return this.splitHtmlContentIntoLines([{value}]);}
getColoredTokens(){const tokens=this.env.model.getters.getCurrentTokens();const tokenAtCursor=this.env.model.getters.getTokenAtCursor();const result=[];const{end,start}=this.env.model.getters.getComposerSelection();for(const token of tokens){switch(token.type){case"OPERATOR":case"NUMBER":case"ARG_SEPARATOR":case"STRING":result.push({value:token.value,color:tokenColors[token.type]||"#000"});break;case"REFERENCE":const{xc,sheetName}=splitReference(token.value);result.push({value:token.value,color:this.rangeColor(xc,sheetName)||"#000"});break;case"SYMBOL":const value=token.value;const upperCaseValue=value.toUpperCase();if(upperCaseValue==="TRUE"||upperCaseValue==="FALSE"){result.push({value:token.value,color:tokenColors.NUMBER});}
else if(upperCaseValue in functionRegistry.content){result.push({value:token.value,color:tokenColors.FUNCTION});}
else{result.push({value:token.value,color:"#000"});}
break;case"LEFT_PAREN":case"RIGHT_PAREN":if(tokenAtCursor&&["LEFT_PAREN","RIGHT_PAREN"].includes(tokenAtCursor.type)&&tokenAtCursor.parenIndex&&tokenAtCursor.parenIndex===token.parenIndex){result.push({value:token.value,color:tokenColors.MATCHING_PAREN});}
else{result.push({value:token.value,color:tokenColors[token.type]||"#000"});}
break;default:result.push({value:token.value,color:"#000"});break;}
if(this.env.model.getters.showSelectionIndicator()&&end===start&&end===token.end){result[result.length-1].class=selectionIndicatorClass;}}
return result;}
splitHtmlContentIntoLines(contents){const contentSplitInLines=[];let currentLine=[];for(const content of contents){if(content.value.includes(NEWLINE)){const lines=content.value.split(NEWLINE);const lastLine=lines.pop();for(const line of lines){currentLine.push({color:content.color,value:line});contentSplitInLines.push(currentLine);currentLine=[];}
currentLine.push({...content,value:lastLine});}
else{currentLine.push(content);}}
if(currentLine.length){contentSplitInLines.push(currentLine);}
const filteredLines=[];for(const line of contentSplitInLines){if(line.every(this.isContentEmpty)){filteredLines.push([line[0]]);}
else{filteredLines.push(line.filter((content)=>!this.isContentEmpty(content)));}}
return filteredLines;}
isContentEmpty(content){return!(content.value||content.class);}
rangeColor(xc,sheetName){if(this.props.focus==="inactive"){return undefined;}
const highlights=this.env.model.getters.getHighlights();const refSheet=sheetName?this.env.model.getters.getSheetIdByName(sheetName):this.env.model.getters.getCurrentEditedCell()?.sheetId;const highlight=highlights.find((highlight)=>{if(highlight.sheetId!==refSheet)
return false;const range=this.env.model.getters.getRangeFromSheetXC(refSheet,xc);let zone=range.zone;zone=getZoneArea(zone)===1?this.env.model.getters.expandZone(refSheet,zone):zone;return isEqual(zone,highlight.zone);});return highlight&&highlight.color?highlight.color:undefined;}
processTokenAtCursor(){let content=this.env.model.getters.getCurrentContent();this.autoCompleteState.showProvider=false;this.functionDescriptionState.showDescription=false;const dataValidationAutocompleteValues=this.env.model.getters.getAutoCompleteDataValidationValues();if(!content.startsWith("=")&&dataValidationAutocompleteValues.length){this.showDataValidationAutocomplete(dataValidationAutocompleteValues);return;}
if(content.startsWith("=")){const token=this.env.model.getters.getTokenAtCursor();if(!token){return;}
if(token.type==="SYMBOL"){this.showFunctionAutocomplete(token.value);return;}
const tokenContext=token.functionContext;const parentFunction=tokenContext?.parent.toUpperCase();if(tokenContext&&parentFunction&&parentFunction in functions$2&&token.type!=="UNKNOWN"){const description=functions$2[parentFunction];const argPosition=tokenContext.argPosition;this.functionDescriptionState.functionName=parentFunction;this.functionDescriptionState.functionDescription=description;this.functionDescriptionState.argToFocus=description.getArgToFocus(argPosition+1)-1;this.functionDescriptionState.showDescription=true;}}}
autoComplete(value){if(!value){return;}
if(this.autoCompleteState.type==="function"){const tokenAtCursor=this.env.model.getters.getTokenAtCursor();if(tokenAtCursor){let start=tokenAtCursor.end;let end=tokenAtCursor.end;if(["SYMBOL","FUNCTION"].includes(tokenAtCursor.type)){start=tokenAtCursor.start;}
const tokens=this.env.model.getters.getCurrentTokens();if(tokens.length){value+="(";const currentTokenIndex=tokens.map((token)=>token.start).indexOf(tokenAtCursor.start);if(currentTokenIndex+1<tokens.length){const nextToken=tokens[currentTokenIndex+1];if(nextToken.type==="LEFT_PAREN"){end++;}}}
this.env.model.dispatch("CHANGE_COMPOSER_CURSOR_SELECTION",{start,end});}
this.env.model.dispatch("REPLACE_COMPOSER_CURSOR_SELECTION",{text:value});}
else{this.env.model.dispatch("SET_CURRENT_CONTENT",{content:value});this.env.model.dispatch("STOP_EDITION");}
this.processTokenAtCursor();}
showDataValidationAutocomplete(values){this.autoCompleteState.showProvider=true;this.autoCompleteState.type="dataValidation";this.autoCompleteState.selectedIndex=undefined;this.autoCompleteState.values=values.map((value)=>({text:value,description:""}));this.autoCompleteState.getHtmlContent=(value)=>[{value}];}}
Composer.props={inputStyle:{type:String,optional:true},rect:{type:Object,optional:true},delimitation:{type:Object,optional:true},focus:{validate:(value)=>["inactive","cellFocus","contentFocus"].includes(value)},onComposerCellFocused:{type:Function,optional:true},onComposerContentFocused:Function,isDefaultFocus:{type:Boolean,optional:true},onInputContextMenu:{type:Function,optional:true},};const COMPOSER_BORDER_WIDTH=3*0.4*window.devicePixelRatio||1;const GRID_CELL_REFERENCE_TOP_OFFSET=28;css`
  div.o-grid-composer {
    z-index: ${ComponentsImportance.GridComposer};
    box-sizing: border-box;
    position: absolute;
    border: ${COMPOSER_BORDER_WIDTH}px solid ${SELECTION_BORDER_COLOR};

    display: flex;
    align-items: center;
  }

  div.o-cell-reference {
    position: absolute;
    z-index: ${ComponentsImportance.GridComposer};
    background: ${SELECTION_BORDER_COLOR};
    color: white;
    font-size: 12px;
    line-height: 14px;
    padding: 6px 7px;
    border-radius: 4px;
  }
`;class GridComposer extends owl.Component{static template="o-spreadsheet-GridComposer";static components={Composer};rect=this.defaultRect;isEditing=false;isCellReferenceVisible;get defaultRect(){return{x:0,y:0,width:0,height:0};}
setup(){owl.onWillUpdateProps(()=>{this.updateComponentPosition();this.updateCellReferenceVisibility();});}
get shouldDisplayCellReference(){return this.isCellReferenceVisible;}
get cellReference(){if(!this.env.model.getters.getCurrentEditedCell()){return"";}
const{col,row,sheetId}=this.env.model.getters.getCurrentEditedCell();const prefixSheet=sheetId!==this.env.model.getters.getActiveSheetId();return`${prefixSheet ? getCanonicalSheetName(this.env.model.getters.getSheetName(sheetId)) + "!" : ""}${toXC(col, row)}`;}
get cellReferenceStyle(){const{x:left,y:top}=this.rect;return cssPropertiesToCss({left:`${left - COMPOSER_BORDER_WIDTH}px`,top:`${top - GRID_CELL_REFERENCE_TOP_OFFSET}px`,});}
get composerProps(){const{width,height}=this.env.model.getters.getSheetViewDimensionWithHeaders();return{rect:{...this.rect},delimitation:{width,height,},focus:this.props.focus,isDefaultFocus:true,onComposerContentFocused:this.props.onComposerContentFocused,onComposerCellFocused:this.props.onComposerCellFocused,onInputContextMenu:this.props.onInputContextMenu,};}
get containerStyle(){if(this.env.model.getters.getEditionMode()==="inactive"||!this.rect){return`z-index: -1000;`;}
const isFormula=this.env.model.getters.getCurrentContent().startsWith("=");const cell=this.env.model.getters.getActiveCell();const position=this.env.model.getters.getActivePosition();const style=this.env.model.getters.getCellComputedStyle(position);const{x:left,y:top,width,height}=this.rect;const background=(!isFormula&&style.fillColor)||"#ffffff";const color=(!isFormula&&style.textColor)||"#000000";const fontSize=(!isFormula&&style.fontSize)||10;const fontWeight=!isFormula&&style.bold?"bold":undefined;const fontStyle=!isFormula&&style.italic?"italic":"normal";const textDecoration=!isFormula?getTextDecoration(style):"none";let textAlign="left";if(!isFormula){textAlign=style.align||cell.defaultAlign;}
const maxHeight=this.props.gridDims.height-this.rect.y;const maxWidth=this.props.gridDims.width-this.rect.x;return cssPropertiesToCss({left:`${left - 1}px`,top:`${top}px`,"min-width":`${width + 1}px`,"min-height":`${height + 1}px`,"max-width":`${maxWidth}px`,"max-height":`${maxHeight}px`,background,color,"font-size":`${fontSizeInPixels(fontSize)}px`,"font-weight":fontWeight,"font-style":fontStyle,"text-decoration":textDecoration,"text-align":textAlign,});}
updateComponentPosition(){const isEditing=this.env.model.getters.getEditionMode()!=="inactive";if(this.isEditing!==isEditing){this.isEditing=isEditing;if(!isEditing){this.rect=this.defaultRect;this.env.focusableElement.focus();return;}
const position=this.env.model.getters.getActivePosition();const zone=this.env.model.getters.expandZone(position.sheetId,positionToZone(position));this.rect=this.env.model.getters.getVisibleRect(zone);}}
updateCellReferenceVisibility(){if(this.env.model.getters.getEditionMode()==="inactive"){this.isCellReferenceVisible=false;return;}
if(this.isCellReferenceVisible){return;}
const sheetId=this.env.model.getters.getActiveSheetId();const zone=this.env.model.getters.getSelectedZone();const rect=this.env.model.getters.getVisibleRect(zone);if(!deepEquals(rect,this.rect)||sheetId!==this.env.model.getters.getCurrentEditedCell().sheetId){this.isCellReferenceVisible=true;}}}
GridComposer.props={focus:{validate:(value)=>["inactive","cellFocus","contentFocus"].includes(value)},onComposerContentFocused:Function,gridDims:Object,onComposerCellFocused:Function,onInputContextMenu:Function,};const CSS$1=css`
  .o-grid-cell-icon {
    width: ${GRID_ICON_EDGE_LENGTH}px;
    height: ${GRID_ICON_EDGE_LENGTH}px;
  }
`;class GridCellIcon extends owl.Component{static style=CSS$1;static template="o-spreadsheet-GridCellIcon";get iconStyle(){const cellPosition=this.props.cellPosition;const merge=this.env.model.getters.getMerge(cellPosition);const zone=merge||positionToZone(cellPosition);const rect=this.env.model.getters.getVisibleRectWithoutHeaders(zone);const x=this.getIconHorizontalPosition(rect,cellPosition);const y=this.getIconVerticalPosition(rect,cellPosition);return cssPropertiesToCss({top:`${y + (this.props.offset?.y || 0)}px`,left:`${x + (this.props.offset?.x || 0)}px`,});}
getIconVerticalPosition(rect,cellPosition){const start=rect.y;const end=rect.y+rect.height;const cell=this.env.model.getters.getCell(cellPosition);const align=this.props.verticalAlign||cell?.style?.verticalAlign||DEFAULT_VERTICAL_ALIGN;switch(align){case"bottom":return end-GRID_ICON_MARGIN-GRID_ICON_EDGE_LENGTH;case"top":return start+GRID_ICON_MARGIN;default:const centeringOffset=Math.floor((end-start-GRID_ICON_EDGE_LENGTH)/2);return end-GRID_ICON_EDGE_LENGTH-centeringOffset;}}
getIconHorizontalPosition(rect,cellPosition){const start=rect.x;const end=rect.x+rect.width;const cell=this.env.model.getters.getCell(cellPosition);const evaluatedCell=this.env.model.getters.getEvaluatedCell(cellPosition);const align=this.props.horizontalAlign||cell?.style?.align||evaluatedCell.defaultAlign;switch(align){case"right":return end-GRID_ICON_MARGIN-GRID_ICON_EDGE_LENGTH;case"left":return start+GRID_ICON_MARGIN;default:const centeringOffset=Math.floor((end-start-GRID_ICON_EDGE_LENGTH)/2);return end-GRID_ICON_EDGE_LENGTH-centeringOffset;}}
isPositionVisible(position){const rect=this.env.model.getters.getVisibleRect(positionToZone(position));return!(rect.width===0||rect.height===0);}}
GridCellIcon.props={cellPosition:Object,horizontalAlign:{type:String,optional:true},verticalAlign:{type:String,optional:true},offset:{type:Object,optional:true},slots:Object,};const CSS=css`
  .o-filter-icon {
    color: ${FILTERS_COLOR};
    display: flex;
    align-items: center;
    justify-content: center;
    width: ${GRID_ICON_EDGE_LENGTH}px;
    height: ${GRID_ICON_EDGE_LENGTH}px;
  }
  .o-filter-icon:hover {
    background: ${FILTERS_COLOR};
    color: #fff;
  }
`;class FilterIcon extends owl.Component{static style=CSS;static template="o-spreadsheet-FilterIcon";onClick(){const position=this.props.cellPosition;const activePopoverType=this.env.model.getters.getPersistentPopoverTypeAtPosition(position);if(activePopoverType&&activePopoverType==="FilterMenu"){this.env.model.dispatch("CLOSE_CELL_POPOVER");return;}
const{col,row}=position;this.env.model.dispatch("OPEN_CELL_POPOVER",{col,row,popoverType:"FilterMenu",});}
get isFilterActive(){return this.env.model.getters.isFilterActive(this.props.cellPosition);}}
FilterIcon.props={cellPosition:Object,};class FilterIconsOverlay extends owl.Component{static template="o-spreadsheet-FilterIconsOverlay";static components={GridCellIcon,FilterIcon,};static defaultProps={gridPosition:{x:0,y:0},};getFilterHeadersPositions(){const sheetId=this.env.model.getters.getActiveSheetId();const headerPositions=this.env.model.getters.getFilterHeaders(sheetId);return headerPositions.map((position)=>({sheetId,...position}));}}
FilterIconsOverlay.props={gridPosition:{type:Object,optional:true},};const CHECKBOX_WIDTH=15;const MARGIN=(GRID_ICON_EDGE_LENGTH-CHECKBOX_WIDTH)/2;css`
  .o-dv-checkbox {
    box-sizing: border-box !important;
    width: ${CHECKBOX_WIDTH}px;
    height: ${CHECKBOX_WIDTH}px;
    accent-color: #808080;
    margin: ${MARGIN}px;
    /** required to prevent the checkbox position to be sensible to the font-size (affects Firefox) */
    position: absolute;
  }
`;class DataValidationCheckbox extends owl.Component{static template="o-spreadsheet-DataValidationCheckbox";onCheckboxChange(ev){const newValue=ev.target.checked;const{sheetId,col,row}=this.props.cellPosition;const cellContent=newValue?"TRUE":"FALSE";this.env.model.dispatch("UPDATE_CELL",{sheetId,col,row,content:cellContent});}
get checkBoxValue(){return!!this.env.model.getters.getEvaluatedCell(this.props.cellPosition).value;}
get isDisabled(){const cell=this.env.model.getters.getCell(this.props.cellPosition);return this.env.model.getters.isReadonly()||!!cell?.isFormula;}}
DataValidationCheckbox.props={cellPosition:Object,};const ICON_WIDTH=13;css`
  .o-dv-list-icon {
    color: #808080;
    border-radius: 1px;
    height: ${GRID_ICON_EDGE_LENGTH}px;
    width: ${GRID_ICON_EDGE_LENGTH}px;

    &:hover {
      color: #ffffff;
      background-color: #808080;
    }

    svg {
      width: ${ICON_WIDTH}px;
      height: ${ICON_WIDTH}px;
    }
  }
`;class DataValidationListIcon extends owl.Component{static template="o-spreadsheet-DataValidationListIcon";onClick(){const{col,row}=this.props.cellPosition;this.env.model.selection.selectCell(col,row);this.env.startCellEdition();}}
DataValidationListIcon.props={cellPosition:Object,};class DataValidationOverlay extends owl.Component{static template="o-spreadsheet-DataValidationOverlay";static components={GridCellIcon,DataValidationCheckbox,DataValidationListIcon};get checkBoxCellPositions(){return this.env.model.getters.getVisibleCellPositions().filter((position)=>this.env.model.getters.isCellValidCheckbox(position)&&!this.env.model.getters.isFilterHeader(position));}
get listIconsCellPositions(){if(this.env.model.getters.isReadonly()){return[];}
return this.env.model.getters.getVisibleCellPositions().filter((position)=>this.env.model.getters.cellHasListDataValidationIcon(position)&&!this.env.model.getters.isFilterHeader(position));}}
DataValidationOverlay.props={};function internalFigureToScreen(getters,fig){return{...fig,...internalToScreenCoordinates(getters,{x:fig.x,y:fig.y})};}
function screenFigureToInternal(getters,fig){return{...fig,...screenCoordinatesToInternal(getters,{x:fig.x,y:fig.y})};}
function internalToScreenCoordinates(getters,{x,y}){const{x:viewportX,y:viewportY}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();x=x<viewportX?x:x-scrollX;y=y<viewportY?y:y-scrollY;return{x,y};}
function screenCoordinatesToInternal(getters,{x,y}){const{x:viewportX,y:viewportY}=getters.getMainViewportCoordinates();const{scrollX,scrollY}=getters.getActiveSheetScrollInfo();x=viewportX&&x<viewportX?x:x+scrollX;y=viewportY&&y<viewportY?y:y+scrollY;return{x,y};}
function dragFigureForMove({x:mouseX,y:mouseY},{x:mouseInitialX,y:mouseInitialY},initialFigure,{x:viewportX,y:viewportY},{maxX,maxY},{scrollX,scrollY}){const minX=viewportX?0:-scrollX;const minY=viewportY?0:-scrollY;const deltaX=mouseX-mouseInitialX;const newX=clamp(initialFigure.x+deltaX,minX,maxX-initialFigure.width-scrollX);const deltaY=mouseY-mouseInitialY;const newY=clamp(initialFigure.y+deltaY,minY,maxY-initialFigure.height-scrollY);return{...initialFigure,x:newX,y:newY};}
function clamp(value,min,max){return Math.min(Math.max(value,min),max);}
function dragFigureForResize(initialFigure,dirX,dirY,{x:mouseX,y:mouseY},{x:mouseInitialX,y:mouseInitialY},keepRatio,minFigSize,{scrollX,scrollY}){let{x,y,width,height}=initialFigure;if(keepRatio&&dirX!=0&&dirY!=0){const deltaX=Math.min(dirX*(mouseInitialX-mouseX),initialFigure.width-minFigSize);const deltaY=Math.min(dirY*(mouseInitialY-mouseY),initialFigure.height-minFigSize);const fraction=Math.min(deltaX/initialFigure.width,deltaY/initialFigure.height);width=initialFigure.width*(1-fraction);height=initialFigure.height*(1-fraction);if(dirX<0){x=initialFigure.x+initialFigure.width*fraction;}
if(dirY<0){y=initialFigure.y+initialFigure.height*fraction;}}
else{const deltaX=Math.max(dirX*(mouseX-mouseInitialX),minFigSize-initialFigure.width);const deltaY=Math.max(dirY*(mouseY-mouseInitialY),minFigSize-initialFigure.height);width=initialFigure.width+deltaX;height=initialFigure.height+deltaY;if(dirX<0){x=initialFigure.x-deltaX;}
if(dirY<0){y=initialFigure.y-deltaY;}}
if(x+scrollX<=0){width=width+x+scrollX;x=-scrollX;}
if(y+scrollY<=0){height=height+y+scrollY;y=-scrollY;}
return{...initialFigure,x,y,width,height};}
const SNAP_MARGIN=5;function snapForMove(getters,figureToSnap,otherFigures){const snappedFigure={...figureToSnap};const verticalSnapLine=getSnapLine(getters,snappedFigure,["hCenter","right","left"],otherFigures,["hCenter","right","left"]);const horizontalSnapLine=getSnapLine(getters,snappedFigure,["vCenter","bottom","top"],otherFigures,["vCenter","bottom","top"]);const{y:viewportY,x:viewportX}=getters.getMainViewportCoordinates();const{scrollY,scrollX}=getters.getActiveSheetScrollInfo();if(horizontalSnapLine){snappedFigure.y-=horizontalSnapLine.snapOffset;const isBaseFigFrozenY=figureToSnap.y<viewportY;const isSnappedFrozenY=snappedFigure.y<viewportY;if(isBaseFigFrozenY&&!isSnappedFrozenY)
snappedFigure.y+=scrollY;else if(!isBaseFigFrozenY&&isSnappedFrozenY)
snappedFigure.y-=scrollY;}
if(verticalSnapLine){snappedFigure.x-=verticalSnapLine.snapOffset;const isBaseFigFrozenX=figureToSnap.x<viewportX;const isSnappedFrozenX=snappedFigure.x<viewportX;if(isBaseFigFrozenX&&!isSnappedFrozenX)
snappedFigure.x+=scrollX;else if(!isBaseFigFrozenX&&isSnappedFrozenX)
snappedFigure.x-=scrollX;}
return{snappedFigure,verticalSnapLine,horizontalSnapLine};}
function snapForResize(getters,resizeDirX,resizeDirY,figureToSnap,otherFigures){const snappedFigure={...figureToSnap};const verticalSnapLine=getSnapLine(getters,snappedFigure,[resizeDirX===-1?"left":"right"],otherFigures,["right","left"]);if(verticalSnapLine){if(resizeDirX===1){snappedFigure.width-=verticalSnapLine.snapOffset;}
else if(resizeDirX===-1){snappedFigure.x-=verticalSnapLine.snapOffset;snappedFigure.width+=verticalSnapLine.snapOffset;}}
const horizontalSnapLine=getSnapLine(getters,snappedFigure,[resizeDirY===-1?"top":"bottom"],otherFigures,["bottom","top"]);if(horizontalSnapLine){if(resizeDirY===1){snappedFigure.height-=horizontalSnapLine.snapOffset;}
else if(resizeDirY===-1){snappedFigure.y-=horizontalSnapLine.snapOffset;snappedFigure.height+=horizontalSnapLine.snapOffset;}}
snappedFigure.x=Math.round(snappedFigure.x);snappedFigure.y=Math.round(snappedFigure.y);snappedFigure.height=Math.round(snappedFigure.height);snappedFigure.width=Math.round(snappedFigure.width);return{snappedFigure,verticalSnapLine,horizontalSnapLine};}
function getVisibleAxes(getters,figure,axesTypes){const axes=axesTypes.map((axisType)=>getAxis(figure,axisType));return axes.filter((axis)=>isAxisVisible(getters,figure,axis)).map((axis)=>getAxisScreenPosition(getters,figure,axis));}
function getAxisScreenPosition(getters,figure,figureAxis){const screenFigure=internalFigureToScreen(getters,figure);return getAxis(screenFigure,figureAxis.axisType);}
function isAxisVisible(getters,figure,axis){const{x:mainViewportX,y:mainViewportY}=getters.getMainViewportCoordinates();const axisStartEndPositions=[];switch(axis.axisType){case"top":case"bottom":case"vCenter":if(figure.y<mainViewportY)
return true;axisStartEndPositions.push({x:figure.x,y:axis.position});axisStartEndPositions.push({x:figure.x+figure.width,y:axis.position});break;case"left":case"right":case"hCenter":if(figure.x<mainViewportX)
return true;axisStartEndPositions.push({x:axis.position,y:figure.y});axisStartEndPositions.push({x:axis.position,y:figure.y+figure.height});break;}
return axisStartEndPositions.some(getters.isPositionVisible);}
function getSnapLine(getters,figureToSnap,figAxesTypes,otherFigures,otherAxesTypes){const axesOfFigure=getVisibleAxes(getters,figureToSnap,figAxesTypes);let closestMatch=undefined;for(const otherFigure of otherFigures){const axesOfOtherFig=getVisibleAxes(getters,otherFigure,otherAxesTypes);for(const axisOfFigure of axesOfFigure){for(const axisOfOtherFig of axesOfOtherFig){if(!canSnap(axisOfFigure.position,axisOfOtherFig.position))
continue;const snapOffset=axisOfFigure.position-axisOfOtherFig.position;if(closestMatch&&snapOffset===closestMatch.snapOffset){closestMatch.matchedFigIds.push(otherFigure.id);}
else if(!closestMatch||Math.abs(snapOffset)<=Math.abs(closestMatch.snapOffset)){closestMatch={matchedFigIds:[otherFigure.id],snapOffset,snappedAxisType:axisOfFigure.axisType,position:axisOfOtherFig.position,};}}}}
return closestMatch;}
function canSnap(axisPosition1,axisPosition2){return Math.abs(axisPosition1-axisPosition2)<=SNAP_MARGIN;}
function getAxis(fig,axisType){let position=0;switch(axisType){case"top":position=fig.y;break;case"bottom":position=fig.y+fig.height-FIGURE_BORDER_WIDTH;break;case"vCenter":position=fig.y+Math.floor(fig.height/2)-FIGURE_BORDER_WIDTH;break;case"left":position=fig.x;break;case"right":position=fig.x+fig.width-FIGURE_BORDER_WIDTH;break;case"hCenter":position=fig.x+Math.floor(fig.width/2)-FIGURE_BORDER_WIDTH;break;}
return{position,axisType:axisType};}
css`
  .o-figure-snap-line {
    position: relative;
    z-index: ${ComponentsImportance.FigureSnapLine};
    &.vertical {
      width: 0px;
      border-left: 1px dashed black;
    }
    &.horizontal {
      border-top: 1px dashed black;
      height: 0px;
    }
  }
  .o-figure-container {
    -webkit-user-select: none; // safari
    user-select: none;
  }
`;class FiguresContainer extends owl.Component{static template="o-spreadsheet-FiguresContainer";static components={FigureComponent};dnd=owl.useState({draggedFigure:undefined,horizontalSnap:undefined,verticalSnap:undefined,});setup(){owl.onMounted(()=>{this.render();});}
getVisibleFigures(){const visibleFigures=this.env.model.getters.getVisibleFigures();if(this.dnd.draggedFigure&&!visibleFigures.some((figure)=>figure.id===this.dnd.draggedFigure?.id)){visibleFigures.push(this.env.model.getters.getFigure(this.env.model.getters.getActiveSheetId(),this.dnd.draggedFigure?.id));}
return visibleFigures;}
get containers(){const visibleFigures=this.getVisibleFigures();const containers=[];for(const containerType of["topLeft","topRight","bottomLeft","bottomRight",]){const containerFigures=visibleFigures.filter((figure)=>this.getFigureContainer(figure)===containerType);if(containerFigures.length>0){containers.push({type:containerType,figures:containerFigures,style:this.getContainerStyle(containerType),inverseViewportStyle:this.getInverseViewportPositionStyle(containerType),});}}
if(this.dnd.draggedFigure){containers.push({type:"dnd",figures:[this.getDndFigure()],style:this.getContainerStyle("dnd"),inverseViewportStyle:this.getInverseViewportPositionStyle("dnd"),});}
return containers;}
getContainerStyle(container){return this.rectToCss(this.getContainerRect(container));}
rectToCss(rect){return cssPropertiesToCss({left:`${rect.x}px`,top:`${rect.y}px`,width:`${rect.width}px`,height:`${rect.height}px`,});}
getContainerRect(container){const{width:viewWidth,height:viewHeight}=this.env.model.getters.getSheetViewDimension();const{x:viewportX,y:viewportY}=this.env.model.getters.getMainViewportCoordinates();const x=["bottomRight","topRight"].includes(container)?viewportX:0;const width=viewWidth-x;const y=["bottomRight","bottomLeft"].includes(container)?viewportY:0;const height=viewHeight-y;return{x,y,width,height};}
getInverseViewportPositionStyle(container){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetScrollInfo();const{x:viewportX,y:viewportY}=this.env.model.getters.getMainViewportCoordinates();const left=["bottomRight","topRight"].includes(container)?-(viewportX+scrollX):0;const top=["bottomRight","bottomLeft"].includes(container)?-(viewportY+scrollY):0;return cssPropertiesToCss({left:`${left}px`,top:`${top}px`,});}
getFigureContainer(figure){const{x:viewportX,y:viewportY}=this.env.model.getters.getMainViewportCoordinates();if(figure.id===this.dnd.draggedFigure?.id){return"dnd";}
else if(figure.x<viewportX&&figure.y<viewportY){return"topLeft";}
else if(figure.x<viewportX){return"bottomLeft";}
else if(figure.y<viewportY){return"topRight";}
else{return"bottomRight";}}
startDraggingFigure(figure,ev){if(ev.button>0||this.env.model.getters.isReadonly()){return;}
const selectResult=this.env.model.dispatch("SELECT_FIGURE",{id:figure.id});if(!selectResult.isSuccessful){return;}
const sheetId=this.env.model.getters.getActiveSheetId();const initialMousePosition={x:ev.clientX,y:ev.clientY};const maxDimensions={maxX:this.env.model.getters.getColDimensions(sheetId,this.env.model.getters.getNumberCols(sheetId)-1).end,maxY:this.env.model.getters.getRowDimensions(sheetId,this.env.model.getters.getNumberRows(sheetId)-1).end,};const{x,y}=internalFigureToScreen(this.env.model.getters,figure);const initialFig={...figure,x,y};const onMouseMove=(ev)=>{const getters=this.env.model.getters;const currentMousePosition={x:ev.clientX,y:ev.clientY};const draggedFigure=dragFigureForMove(currentMousePosition,initialMousePosition,initialFig,this.env.model.getters.getMainViewportCoordinates(),maxDimensions,getters.getActiveSheetScrollInfo());const otherFigures=this.getOtherFigures(figure.id);const internalDragged=screenFigureToInternal(getters,draggedFigure);const snapResult=snapForMove(getters,internalDragged,otherFigures);this.dnd.draggedFigure=internalFigureToScreen(getters,snapResult.snappedFigure);this.dnd.horizontalSnap=this.getSnap(snapResult.horizontalSnapLine);this.dnd.verticalSnap=this.getSnap(snapResult.verticalSnapLine);};const onMouseUp=(ev)=>{if(!this.dnd.draggedFigure){return;}
let{x,y}=screenFigureToInternal(this.env.model.getters,this.dnd.draggedFigure);this.dnd.draggedFigure=undefined;this.dnd.horizontalSnap=undefined;this.dnd.verticalSnap=undefined;this.env.model.dispatch("UPDATE_FIGURE",{sheetId,id:figure.id,x,y});};startDnd(onMouseMove,onMouseUp);}
startResize(figure,dirX,dirY,ev){ev.stopPropagation();const initialMousePosition={x:ev.clientX,y:ev.clientY};const{x,y}=internalFigureToScreen(this.env.model.getters,figure);const initialFig={...figure,x,y};const keepRatio=figureRegistry.get(figure.tag).keepRatio||false;const minFigSize=figureRegistry.get(figure.tag).minFigSize||MIN_FIG_SIZE;const onMouseMove=(ev)=>{const currentMousePosition={x:ev.clientX,y:ev.clientY};const draggedFigure=dragFigureForResize(initialFig,dirX,dirY,currentMousePosition,initialMousePosition,keepRatio,minFigSize,this.env.model.getters.getActiveSheetScrollInfo());const otherFigures=this.getOtherFigures(figure.id);const snapResult=snapForResize(this.env.model.getters,dirX,dirY,draggedFigure,otherFigures);this.dnd.draggedFigure=snapResult.snappedFigure;this.dnd.horizontalSnap=this.getSnap(snapResult.horizontalSnapLine);this.dnd.verticalSnap=this.getSnap(snapResult.verticalSnapLine);};const onMouseUp=(ev)=>{if(!this.dnd.draggedFigure){return;}
let{x,y}=screenFigureToInternal(this.env.model.getters,this.dnd.draggedFigure);const update={x,y};if(dirX){update.width=this.dnd.draggedFigure.width;}
if(dirY){update.height=this.dnd.draggedFigure.height;}
this.env.model.dispatch("UPDATE_FIGURE",{sheetId:this.env.model.getters.getActiveSheetId(),id:figure.id,...update,});this.dnd.draggedFigure=undefined;this.dnd.horizontalSnap=undefined;this.dnd.verticalSnap=undefined;};startDnd(onMouseMove,onMouseUp);}
getOtherFigures(figId){return this.getVisibleFigures().filter((f)=>f.id!==figId);}
getDndFigure(){const figure=this.getVisibleFigures().find((fig)=>fig.id===this.dnd.draggedFigure?.id);if(!figure)
throw new Error("Dnd figure not found");return{...figure,...this.dnd.draggedFigure,};}
getFigureStyle(figure){if(figure.id!==this.dnd.draggedFigure?.id)
return"";return cssPropertiesToCss({opacity:"0.9",cursor:"grabbing",});}
getSnap(snapLine){if(!snapLine||!this.dnd.draggedFigure)
return undefined;const figureVisibleRects=snapLine.matchedFigIds.map((id)=>this.getVisibleFigures().find((fig)=>fig.id===id)).filter(isDefined$1).map((fig)=>{const figOnSCreen=internalFigureToScreen(this.env.model.getters,fig);const container=this.getFigureContainer(fig);return rectIntersection(figOnSCreen,this.getContainerRect(container));}).filter(isDefined$1);const containerRect=rectUnion(this.dnd.draggedFigure,...figureVisibleRects);return{line:snapLine,containerStyle:this.rectToCss(containerRect),lineStyle:this.getSnapLineStyle(snapLine,containerRect),};}
getSnapLineStyle(snapLine,containerRect){if(!snapLine)
return"";if(["top","vCenter","bottom"].includes(snapLine.snappedAxisType)){return cssPropertiesToCss({top:`${snapLine.position - containerRect.y}px`,left:`0px`,width:`100%`,});}
else{return cssPropertiesToCss({top:`0px`,left:`${snapLine.position - containerRect.x}px`,height:`100%`,});}}}
FiguresContainer.props={onFigureDeleted:Function,};css`
  .o-grid-add-rows {
    input {
      box-sizing: border-box;
      width: 60px;
      height: 30px;
    }

    .o-validation-error {
      display: inline-block !important;
      margin-top: 0;
      margin-left: 8px;
    }
  }
`;class GridAddRowsFooter extends owl.Component{static template="o-spreadsheet-GridAddRowsFooter";static components={ValidationMessages};inputRef=owl.useRef("inputRef");state=owl.useState({inputValue:"100",errorFlag:false,});setup(){owl.useExternalListener(window,"click",this.onExternalClick,{capture:true});}
get addRowsPosition(){const activeSheetId=this.env.model.getters.getActiveSheetId();const{numberOfRows}=this.env.model.getters.getSheetSize(activeSheetId);const{scrollY}=this.env.model.getters.getActiveSheetScrollInfo();const rowDimensions=this.env.model.getters.getRowDimensions(activeSheetId,numberOfRows-1);const top=rowDimensions.end-scrollY;return cssPropertiesToCss({top:`${top}px`,});}
get errorMessages(){return[_t("Please enter a number between 0 and 10000.")];}
onKeydown(ev){if(ev.key.toUpperCase()==="ESCAPE"){this.props.focusGrid();}
else if(ev.key.toUpperCase()==="ENTER"){this.onConfirm();}}
onInput(ev){const value=ev.target.value;this.state.inputValue=value;const quantity=Number(value);this.state.errorFlag=Number.isNaN(quantity)||quantity<=0||quantity>10000;}
onConfirm(){if(this.state.errorFlag){return;}
const quantity=Number(this.state.inputValue);const activeSheetId=this.env.model.getters.getActiveSheetId();const rowNumber=this.env.model.getters.getNumberRows(activeSheetId);this.env.model.dispatch("ADD_COLUMNS_ROWS",{sheetId:activeSheetId,position:"after",base:rowNumber-1,quantity,dimension:"ROW",});this.props.focusGrid();const{scrollX}=this.env.model.getters.getActiveSheetDOMScrollInfo();const{end}=this.env.model.getters.getRowDimensions(activeSheetId,rowNumber+quantity-1);this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX,offsetY:end,});}
onExternalClick(ev){if(this.inputRef.el!==document.activeElement||ev.target===this.inputRef.el){return;}
this.props.focusGrid();}}
GridAddRowsFooter.props={focusGrid:Function,};function useRefListener(ref,...listener){owl.useEffect((el)=>{el?.addEventListener(...listener);return()=>el?.removeEventListener(...listener);},()=>[ref.el]);}
function useInterval(callback,delay){let intervalId;const{setInterval,clearInterval}=window;owl.useEffect(()=>{intervalId=setInterval(callback,delay);return()=>clearInterval(intervalId);},()=>[delay]);return{pause:()=>{clearInterval(intervalId);intervalId=undefined;},resume:()=>{if(intervalId===undefined){intervalId=setInterval(callback,delay);}},};}
const CURSOR_SVG=`
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="16"><path d="M6.5.4c1.3-.8 2.9-.1 3.8 1.4l2.9 5.1c.2.4.9 1.6-.4 2.3l-1.6.9 1.8 3.1c.2.4.1 1-.2 1.2l-1.6 1c-.3.1-.9 0-1.1-.4l-1.8-3.1-1.6 1c-.6.4-1.7 0-2.2-.8L0 4.3"/><path fill="#fff" d="M9.1 2a1.4 1.1 60 0 0-1.7-.6L5.5 2.5l.9 1.6-1 .6-.9-1.6-.6.4 1.8 3.1-1.3.7-1.8-3.1-1 .6 3.8 6.6 6.8-3.98M3.9 8.8 10.82 5l.795 1.4-6.81 3.96"/></svg>
`;css`
  .o-paint-format-cursor {
    cursor: url("data:image/svg+xml,${encodeURIComponent(CURSOR_SVG)}"), auto;
  }
`;function useCellHovered(env,gridRef,callback){let hoveredPosition={col:undefined,row:undefined,};const{Date}=window;let x=0;let y=0;let lastMoved=0;function getPosition(){const col=env.model.getters.getColIndex(x);const row=env.model.getters.getRowIndex(y);return{col,row};}
const{pause,resume}=useInterval(checkTiming,200);function checkTiming(){const{col,row}=getPosition();const delta=Date.now()-lastMoved;if(delta>300&&(col!==hoveredPosition.col||row!==hoveredPosition.row)){setPosition(undefined,undefined);}
if(delta>300){if(col<0||row<0){return;}
setPosition(col,row);}}
function updateMousePosition(e){if(gridRef.el===e.target){x=e.offsetX;y=e.offsetY;lastMoved=Date.now();}}
function recompute(){const{col,row}=getPosition();if(col!==hoveredPosition.col||row!==hoveredPosition.row){setPosition(undefined,undefined);}}
function onMouseLeave(e){const x=e.offsetX;const y=e.offsetY;const gridRect=getBoundingRectAsPOJO(gridRef.el);if(y<0||y>gridRect.height||x<0||x>gridRect.width){return updateMousePosition(e);}
else{return pause();}}
useRefListener(gridRef,"mousemove",updateMousePosition);useRefListener(gridRef,"mouseleave",onMouseLeave);useRefListener(gridRef,"mouseenter",resume);useRefListener(gridRef,"mousedown",recompute);owl.useExternalListener(window,"click",handleGlobalClick);function handleGlobalClick(e){const target=e.target;const grid=gridRef.el;if(!grid.contains(target)){setPosition(undefined,undefined);}}
function setPosition(col,row){if(col!==hoveredPosition.col||row!==hoveredPosition.row){hoveredPosition.col=col;hoveredPosition.row=row;callback({col,row});}}
return hoveredPosition;}
function useTouchMove(gridRef,handler,canMoveUp){let x=null;let y=null;function onTouchStart(ev){if(ev.touches.length!==1)
return;x=ev.touches[0].clientX;y=ev.touches[0].clientY;}
function onTouchEnd(){x=null;y=null;}
function onTouchMove(ev){if(ev.touches.length!==1)
return;if(canMoveUp()){ev.preventDefault();ev.stopPropagation();}
const currentX=ev.touches[0].clientX;const currentY=ev.touches[0].clientY;handler(x-currentX,y-currentY);x=currentX;y=currentY;}
useRefListener(gridRef,"touchstart",onTouchStart);useRefListener(gridRef,"touchend",onTouchEnd);useRefListener(gridRef,"touchmove",onTouchMove);}
class GridOverlay extends owl.Component{static template="o-spreadsheet-GridOverlay";static components={FiguresContainer,DataValidationOverlay,GridAddRowsFooter};static defaultProps={onCellHovered:()=>{},onCellDoubleClicked:()=>{},onCellClicked:()=>{},onCellRightClicked:()=>{},onGridResized:()=>{},onFigureDeleted:()=>{},};gridOverlay=owl.useRef("gridOverlay");gridOverlayRect=useAbsoluteBoundingRect(this.gridOverlay);setup(){useCellHovered(this.env,this.gridOverlay,this.props.onCellHovered);const resizeObserver=new ResizeObserver(()=>{const boundingRect=this.gridOverlayEl.getBoundingClientRect();this.props.onGridResized({x:boundingRect.left,y:boundingRect.top,height:this.gridOverlayEl.clientHeight,width:this.gridOverlayEl.clientWidth,});});owl.onMounted(()=>{resizeObserver.observe(this.gridOverlayEl);});owl.onWillUnmount(()=>{resizeObserver.disconnect();});useTouchMove(this.gridOverlay,this.props.onGridMoved,()=>{const{scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();return scrollY>0;});}
get gridOverlayEl(){if(!this.gridOverlay.el){throw new Error("GridOverlay el is not defined.");}
return this.gridOverlay.el;}
get style(){return this.props.gridOverlayDimensions;}
get isPaintingFormat(){return this.env.model.getters.isPaintingFormat();}
onMouseDown(ev){if(ev.button>0){return;}
const[col,row]=this.getCartesianCoordinates(ev);this.props.onCellClicked(col,row,{expandZone:ev.shiftKey,addZone:isCtrlKey(ev),});}
onDoubleClick(ev){const[col,row]=this.getCartesianCoordinates(ev);this.props.onCellDoubleClicked(col,row);}
onContextMenu(ev){const[col,row]=this.getCartesianCoordinates(ev);this.props.onCellRightClicked(col,row,{x:ev.clientX,y:ev.clientY});}
getCartesianCoordinates(ev){const x=ev.clientX-this.gridOverlayRect.x;const y=ev.clientY-this.gridOverlayRect.y;const colIndex=this.env.model.getters.getColIndex(x);const rowIndex=this.env.model.getters.getRowIndex(y);return[colIndex,rowIndex];}}
GridOverlay.props={onCellHovered:{type:Function,optional:true},onCellDoubleClicked:{type:Function,optional:true},onCellClicked:{type:Function,optional:true},onCellRightClicked:{type:Function,optional:true},onGridResized:{type:Function,optional:true},onFigureDeleted:{type:Function,optional:true},onGridMoved:Function,gridOverlayDimensions:String,};class GridPopover extends owl.Component{static template="o-spreadsheet-GridPopover";static components={Popover};zIndex=ComponentsImportance.GridPopover;get cellPopover(){const popover=this.env.model.getters.getCellPopover(this.props.hoveredCell);if(!popover.isOpen){return{isOpen:false};}
const anchorRect=popover.anchorRect;return{...popover,anchorRect:{...anchorRect,x:anchorRect.x+this.props.gridRect.x,y:anchorRect.y+this.props.gridRect.y,},};}}
GridPopover.props={hoveredCell:Object,onClosePopover:Function,onMouseWheel:Function,gridRect:Object,};class AbstractResizer extends owl.Component{PADDING=0;MAX_SIZE_MARGIN=0;MIN_ELEMENT_SIZE=0;lastSelectedElementIndex=null;state=owl.useState({resizerIsActive:false,isResizing:false,isMoving:false,isSelecting:false,waitingForMove:false,activeElement:0,draggerLinePosition:0,draggerShadowPosition:0,draggerShadowThickness:0,delta:0,base:0,position:"before",});_computeHandleDisplay(ev){const position=this._getEvOffset(ev);const elementIndex=this._getElementIndex(position);if(elementIndex<0){return;}
const dimensions=this._getDimensionsInViewport(elementIndex);if(position-dimensions.start<this.PADDING&&elementIndex!==this._getViewportOffset()){this.state.resizerIsActive=true;this.state.draggerLinePosition=dimensions.start;this.state.activeElement=this._getPreviousVisibleElement(elementIndex);}
else if(dimensions.end-position<this.PADDING){this.state.resizerIsActive=true;this.state.draggerLinePosition=dimensions.end;this.state.activeElement=elementIndex;}
else{this.state.resizerIsActive=false;}}
_computeGrabDisplay(ev){const index=this._getElementIndex(this._getEvOffset(ev));const activeElements=this._getActiveElements();const selectedZoneStart=this._getSelectedZoneStart();const selectedZoneEnd=this._getSelectedZoneEnd();if(activeElements.has(selectedZoneStart)){if(selectedZoneStart<=index&&index<=selectedZoneEnd){this.state.waitingForMove=true;return;}}
this.state.waitingForMove=false;}
onMouseMove(ev){if(this.state.isResizing||this.state.isMoving||this.state.isSelecting){return;}
this._computeHandleDisplay(ev);this._computeGrabDisplay(ev);}
onMouseLeave(){this.state.resizerIsActive=this.state.isResizing;this.state.waitingForMove=false;}
onDblClick(ev){this._fitElementSize(this.state.activeElement);this.state.isResizing=false;this._computeHandleDisplay(ev);this._computeGrabDisplay(ev);}
onMouseDown(ev){this.state.isResizing=true;this.state.delta=0;const initialPosition=this._getClientPosition(ev);const styleValue=this.state.draggerLinePosition;const size=this._getElementSize(this.state.activeElement);const minSize=styleValue-size+this.MIN_ELEMENT_SIZE;const maxSize=this._getMaxSize();const onMouseUp=(ev)=>{this.state.isResizing=false;if(this.state.delta!==0){this._updateSize();}};const onMouseMove=(ev)=>{this.state.delta=this._getClientPosition(ev)-initialPosition;this.state.draggerLinePosition=styleValue+this.state.delta;if(this.state.draggerLinePosition<minSize){this.state.draggerLinePosition=minSize;this.state.delta=this.MIN_ELEMENT_SIZE-size;}
if(this.state.draggerLinePosition>maxSize){this.state.draggerLinePosition=maxSize;this.state.delta=maxSize-styleValue;}};startDnd(onMouseMove,onMouseUp);}
select(ev){if(ev.button>0){return;}
const index=this._getElementIndex(this._getEvOffset(ev));if(index<0){return;}
if(this.state.waitingForMove===true){if(!this.env.model.getters.isGridSelectionActive()){this._selectElement(index,false);}
else{this.startMovement(ev);}
return;}
if(this.env.model.getters.getEditionMode()==="editing"){this.env.model.selection.getBackToDefault();}
this.startSelection(ev,index);}
startMovement(ev){this.state.waitingForMove=false;this.state.isMoving=true;const startDimensions=this._getDimensionsInViewport(this._getSelectedZoneStart());const endDimensions=this._getDimensionsInViewport(this._getSelectedZoneEnd());const defaultPosition=startDimensions.start;this.state.draggerLinePosition=defaultPosition;this.state.base=this._getSelectedZoneStart();this.state.draggerShadowPosition=defaultPosition;this.state.draggerShadowThickness=endDimensions.end-startDimensions.start;const mouseMoveMovement=(col,row)=>{let elementIndex=this._getType()==="COL"?col:row;if(elementIndex>=0){const dimensions=this._getDimensionsInViewport(elementIndex);if(elementIndex<=this._getSelectedZoneStart()){this.state.draggerLinePosition=dimensions.start;this.state.draggerShadowPosition=dimensions.start;this.state.base=elementIndex;this.state.position="before";}
else if(this._getSelectedZoneEnd()<elementIndex){this.state.draggerLinePosition=dimensions.end;this.state.draggerShadowPosition=dimensions.end-this.state.draggerShadowThickness;this.state.base=elementIndex;this.state.position="after";}
else{this.state.draggerLinePosition=startDimensions.start;this.state.draggerShadowPosition=startDimensions.start;this.state.base=this._getSelectedZoneStart();}}};const mouseUpMovement=()=>{this.state.isMoving=false;if(this.state.base!==this._getSelectedZoneStart()){this._moveElements();}
this._computeGrabDisplay(ev);};dragAndDropBeyondTheViewport(this.env,mouseMoveMovement,mouseUpMovement);}
startSelection(ev,index){this.state.isSelecting=true;if(ev.shiftKey){this._increaseSelection(index);}
else{this._selectElement(index,isCtrlKey(ev));}
this.lastSelectedElementIndex=index;const mouseMoveSelect=(col,row)=>{let newIndex=this._getType()==="COL"?col:row;if(newIndex!==this.lastSelectedElementIndex&&newIndex!==-1){this._increaseSelection(newIndex);this.lastSelectedElementIndex=newIndex;}};const mouseUpSelect=()=>{this.state.isSelecting=false;this.lastSelectedElementIndex=null;this._computeGrabDisplay(ev);};dragAndDropBeyondTheViewport(this.env,mouseMoveSelect,mouseUpSelect);}
onMouseUp(ev){this.lastSelectedElementIndex=null;}
onContextMenu(ev){ev.preventDefault();const index=this._getElementIndex(this._getEvOffset(ev));if(index<0)
return;if(!this._getActiveElements().has(index)){this._selectElement(index,false);}
const type=this._getType();this.props.onOpenContextMenu(type,ev.clientX,ev.clientY);}}
css`
  .o-col-resizer {
    position: absolute;
    top: 0;
    left: ${HEADER_WIDTH}px;
    right: 0;
    height: ${HEADER_HEIGHT}px;
    &.o-dragging {
      cursor: grabbing;
    }
    &.o-grab {
      cursor: grab;
    }
    .dragging-col-line {
      top: ${HEADER_HEIGHT}px;
      position: absolute;
      width: 2px;
      height: 10000px;
      background-color: black;
    }
    .dragging-col-shadow {
      top: ${HEADER_HEIGHT}px;
      position: absolute;
      height: 10000px;
      background-color: black;
      opacity: 0.1;
    }
    .o-handle {
      position: absolute;
      height: ${HEADER_HEIGHT}px;
      width: 4px;
      cursor: e-resize;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .dragging-resizer {
      top: ${HEADER_HEIGHT}px;
      position: absolute;
      margin-left: 2px;
      width: 1px;
      height: 10000px;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .o-unhide {
      width: ${UNHIDE_ICON_EDGE_LENGTH}px;
      height: ${UNHIDE_ICON_EDGE_LENGTH}px;
      position: absolute;
      overflow: hidden;
      border-radius: 2px;
      top: calc(${HEADER_HEIGHT}px / 2 - ${UNHIDE_ICON_EDGE_LENGTH}px / 2);
    }
    .o-unhide:hover {
      z-index: ${ComponentsImportance.Grid + 1};
      background-color: lightgrey;
    }
    .o-unhide > svg {
      position: relative;
      top: calc(${UNHIDE_ICON_EDGE_LENGTH}px / 2 - ${ICON_EDGE_LENGTH}px / 2);
    }
  }
`;AbstractResizer.props={onOpenContextMenu:Function,};class ColResizer extends AbstractResizer{static template="o-spreadsheet-ColResizer";colResizerRef;setup(){super.setup();this.colResizerRef=owl.useRef("colResizer");this.PADDING=15;this.MAX_SIZE_MARGIN=90;this.MIN_ELEMENT_SIZE=MIN_COL_WIDTH;}
_getEvOffset(ev){return ev.offsetX;}
_getViewportOffset(){return this.env.model.getters.getActiveMainViewport().left;}
_getClientPosition(ev){return ev.clientX;}
_getElementIndex(position){return this.env.model.getters.getColIndex(position);}
_getSelectedZoneStart(){return this.env.model.getters.getSelectedZone().left;}
_getSelectedZoneEnd(){return this.env.model.getters.getSelectedZone().right;}
_getEdgeScroll(position){return this.env.model.getters.getEdgeScrollCol(position,position,position);}
_getDimensionsInViewport(index){return this.env.model.getters.getColDimensionsInViewport(this.env.model.getters.getActiveSheetId(),index);}
_getElementSize(index){return this.env.model.getters.getColSize(this.env.model.getters.getActiveSheetId(),index);}
_getMaxSize(){return this.colResizerRef.el.clientWidth;}
_updateSize(){const index=this.state.activeElement;const size=this.state.delta+this._getElementSize(index);const cols=this.env.model.getters.getActiveCols();this.env.model.dispatch("RESIZE_COLUMNS_ROWS",{dimension:"COL",sheetId:this.env.model.getters.getActiveSheetId(),elements:cols.has(index)?[...cols]:[index],size,});}
_moveElements(){const elements=[];const start=this._getSelectedZoneStart();const end=this._getSelectedZoneEnd();for(let colIndex=start;colIndex<=end;colIndex++){elements.push(colIndex);}
const result=this.env.model.dispatch("MOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"COL",base:this.state.base,elements,position:this.state.position,});if(!result.isSuccessful&&result.reasons.includes("WillRemoveExistingMerge")){this.env.raiseError(MergeErrorMessage);}}
_selectElement(index,addDistinctHeader){this.env.model.selection.selectColumn(index,addDistinctHeader?"newAnchor":"overrideSelection");}
_increaseSelection(index){this.env.model.selection.selectColumn(index,"updateAnchor");}
_fitElementSize(index){const cols=this.env.model.getters.getActiveCols();this.env.model.dispatch("AUTORESIZE_COLUMNS",{sheetId:this.env.model.getters.getActiveSheetId(),cols:cols.has(index)?[...cols]:[index],});}
_getType(){return"COL";}
_getActiveElements(){return this.env.model.getters.getActiveCols();}
_getPreviousVisibleElement(index){const sheetId=this.env.model.getters.getActiveSheetId();let row;for(row=index-1;row>=0;row--){if(!this.env.model.getters.isColHidden(sheetId,row)){break;}}
return row;}
unhide(hiddenElements){this.env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),elements:hiddenElements,dimension:"COL",});}
unhideStyleValue(hiddenIndex){return this._getDimensionsInViewport(hiddenIndex).start;}}
css`
  .o-row-resizer {
    position: absolute;
    top: ${HEADER_HEIGHT}px;
    left: 0;
    right: 0;
    width: ${HEADER_WIDTH}px;
    height: 100%;
    &.o-dragging {
      cursor: grabbing;
    }
    &.o-grab {
      cursor: grab;
    }
    .dragging-row-line {
      left: ${HEADER_WIDTH}px;
      position: absolute;
      width: 10000px;
      height: 2px;
      background-color: black;
    }
    .dragging-row-shadow {
      left: ${HEADER_WIDTH}px;
      position: absolute;
      width: 10000px;
      background-color: black;
      opacity: 0.1;
    }
    .o-handle {
      position: absolute;
      height: 4px;
      width: ${HEADER_WIDTH}px;
      cursor: n-resize;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .dragging-resizer {
      left: ${HEADER_WIDTH}px;
      position: absolute;
      margin-top: 2px;
      width: 10000px;
      height: 1px;
      background-color: ${SELECTION_BORDER_COLOR};
    }
    .o-unhide {
      width: ${UNHIDE_ICON_EDGE_LENGTH}px;
      height: ${UNHIDE_ICON_EDGE_LENGTH}px;
      position: absolute;
      overflow: hidden;
      border-radius: 2px;
      left: calc(${HEADER_WIDTH}px - ${UNHIDE_ICON_EDGE_LENGTH}px - 2px);
    }
    .o-unhide > svg {
      position: relative;
      left: calc(${UNHIDE_ICON_EDGE_LENGTH}px / 2 - ${ICON_EDGE_LENGTH}px / 2);
      top: calc(${UNHIDE_ICON_EDGE_LENGTH}px / 2 - ${ICON_EDGE_LENGTH}px / 2);
    }
    .o-unhide:hover {
      z-index: ${ComponentsImportance.Grid + 1};
      background-color: lightgrey;
    }
  }
`;ColResizer.props={onOpenContextMenu:Function,};class RowResizer extends AbstractResizer{static template="o-spreadsheet-RowResizer";setup(){super.setup();this.rowResizerRef=owl.useRef("rowResizer");this.PADDING=5;this.MAX_SIZE_MARGIN=60;this.MIN_ELEMENT_SIZE=MIN_ROW_HEIGHT;}
rowResizerRef;_getEvOffset(ev){return ev.offsetY;}
_getViewportOffset(){return this.env.model.getters.getActiveMainViewport().top;}
_getClientPosition(ev){return ev.clientY;}
_getElementIndex(position){return this.env.model.getters.getRowIndex(position);}
_getSelectedZoneStart(){return this.env.model.getters.getSelectedZone().top;}
_getSelectedZoneEnd(){return this.env.model.getters.getSelectedZone().bottom;}
_getEdgeScroll(position){return this.env.model.getters.getEdgeScrollRow(position,position,position);}
_getDimensionsInViewport(index){return this.env.model.getters.getRowDimensionsInViewport(this.env.model.getters.getActiveSheetId(),index);}
_getElementSize(index){return this.env.model.getters.getRowSize(this.env.model.getters.getActiveSheetId(),index);}
_getMaxSize(){return this.rowResizerRef.el.clientHeight;}
_updateSize(){const index=this.state.activeElement;const size=this.state.delta+this._getElementSize(index);const rows=this.env.model.getters.getActiveRows();this.env.model.dispatch("RESIZE_COLUMNS_ROWS",{dimension:"ROW",sheetId:this.env.model.getters.getActiveSheetId(),elements:rows.has(index)?[...rows]:[index],size,});}
_moveElements(){const elements=[];const start=this._getSelectedZoneStart();const end=this._getSelectedZoneEnd();for(let rowIndex=start;rowIndex<=end;rowIndex++){elements.push(rowIndex);}
const result=this.env.model.dispatch("MOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"ROW",base:this.state.base,elements,position:this.state.position,});if(!result.isSuccessful&&result.reasons.includes("WillRemoveExistingMerge")){this.env.raiseError(MergeErrorMessage);}}
_selectElement(index,addDistinctHeader){this.env.model.selection.selectRow(index,addDistinctHeader?"newAnchor":"overrideSelection");}
_increaseSelection(index){this.env.model.selection.selectRow(index,"updateAnchor");}
_fitElementSize(index){const rows=this.env.model.getters.getActiveRows();this.env.model.dispatch("AUTORESIZE_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),rows:rows.has(index)?[...rows]:[index],});}
_getType(){return"ROW";}
_getActiveElements(){return this.env.model.getters.getActiveRows();}
_getPreviousVisibleElement(index){const sheetId=this.env.model.getters.getActiveSheetId();let row;for(row=index-1;row>=0;row--){if(!this.env.model.getters.isRowHidden(sheetId,row)){break;}}
return row;}
unhide(hiddenElements){this.env.model.dispatch("UNHIDE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"ROW",elements:hiddenElements,});}
unhideStyleValue(hiddenIndex){return this._getDimensionsInViewport(hiddenIndex).start;}}
css`
  .o-overlay {
    .all {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      width: ${HEADER_WIDTH}px;
      height: ${HEADER_HEIGHT}px;
    }
  }
`;RowResizer.props={onOpenContextMenu:Function,};class HeadersOverlay extends owl.Component{static template="o-spreadsheet-HeadersOverlay";static components={ColResizer,RowResizer};selectAll(){this.env.model.selection.selectAll();}}
HeadersOverlay.props={onOpenContextMenu:Function,};function useGridDrawing(refName,model,canvasSize){const canvasRef=owl.useRef(refName);owl.useEffect(drawGrid);function drawGrid(){const canvas=canvasRef.el;const dpr=window.devicePixelRatio||1;const ctx=canvas.getContext("2d",{alpha:false});const thinLineWidth=0.4*dpr;const renderingContext={ctx,dpr,thinLineWidth,};const{width,height}=canvasSize();canvas.style.width=`${width}px`;canvas.style.height=`${height}px`;canvas.width=width*dpr;canvas.height=height*dpr;canvas.setAttribute("style",`width:${width}px;height:${height}px;`);ctx.translate(-CANVAS_SHIFT,-CANVAS_SHIFT);ctx.scale(dpr,dpr);model.drawGrid(renderingContext);}}
function useWheelHandler(handler){function normalize(val,deltaMode){return val*(deltaMode===0?1:DEFAULT_CELL_HEIGHT);}
const onMouseWheel=(ev)=>{const deltaX=normalize(ev.shiftKey&&!isMacOS()?ev.deltaY:ev.deltaX,ev.deltaMode);const deltaY=normalize(ev.shiftKey&&!isMacOS()?ev.deltaX:ev.deltaY,ev.deltaMode);handler(deltaX,deltaY);};return onMouseWheel;}
css`
  .o-border {
    position: absolute;
    &:hover {
      cursor: grab;
    }
  }
  .o-moving {
    cursor: grabbing;
  }
`;class Border extends owl.Component{static template="o-spreadsheet-Border";get style(){const isTop=["n","w","e"].includes(this.props.orientation);const isLeft=["n","w","s"].includes(this.props.orientation);const isHorizontal=["n","s"].includes(this.props.orientation);const isVertical=["w","e"].includes(this.props.orientation);const z=this.props.zone;const margin=2;const rect=this.env.model.getters.getVisibleRect(z);const left=rect.x;const right=rect.x+rect.width-2*margin;const top=rect.y;const bottom=rect.y+rect.height-2*margin;const lineWidth=4;const leftValue=isLeft?left:right;const topValue=isTop?top:bottom;const widthValue=isHorizontal?right-left:lineWidth;const heightValue=isVertical?bottom-top:lineWidth;return cssPropertiesToCss({left:`${leftValue}px`,top:`${topValue}px`,width:`${widthValue}px`,height:`${heightValue}px`,});}
onMouseDown(ev){this.props.onMoveHighlight(ev.clientX,ev.clientY);}}
Border.props={zone:Object,orientation:String,isMoving:Boolean,onMoveHighlight:Function,};css`
  .o-corner {
    position: absolute;
    height: 6px;
    width: 6px;
    border: 1px solid white;
  }
  .o-corner-nw,
  .o-corner-se {
    &:hover {
      cursor: nwse-resize;
    }
  }
  .o-corner-ne,
  .o-corner-sw {
    &:hover {
      cursor: nesw-resize;
    }
  }
  .o-resizing {
    cursor: grabbing;
  }
`;class Corner extends owl.Component{static template="o-spreadsheet-Corner";isTop=this.props.orientation[0]==="n";isLeft=this.props.orientation[1]==="w";get style(){const z=this.props.zone;const col=this.isLeft?z.left:z.right;const row=this.isTop?z.top:z.bottom;const rect=this.env.model.getters.getVisibleRect({left:col,right:col,top:row,bottom:row,});if(rect.width*rect.height===0){return`display:none`;}
const leftValue=this.isLeft?rect.x:rect.x+rect.width;const topValue=this.isTop?rect.y:rect.y+rect.height;return cssPropertiesToCss({left:`${leftValue - AUTOFILL_EDGE_LENGTH / 2}px`,top:`${topValue - AUTOFILL_EDGE_LENGTH / 2}px`,"background-color":this.props.color,});}
onMouseDown(ev){this.props.onResizeHighlight(this.isLeft,this.isTop);}}
Corner.props={zone:Object,color:String,orientation:String,isResizing:Boolean,onResizeHighlight:Function,};css`
  .o-highlight {
    z-index: ${ComponentsImportance.Highlight};
  }
`;class Highlight extends owl.Component{static template="o-spreadsheet-Highlight";static components={Corner,Border,};highlightState=owl.useState({shiftingMode:"none",});onResizeHighlight(isLeft,isTop){const activeSheetId=this.env.model.getters.getActiveSheetId();this.highlightState.shiftingMode="isResizing";const z=this.props.zone;const pivotCol=isLeft?z.right:z.left;const pivotRow=isTop?z.bottom:z.top;let lastCol=isLeft?z.left:z.right;let lastRow=isTop?z.top:z.bottom;let currentZone=z;this.env.model.dispatch("START_CHANGE_HIGHLIGHT",{zone:currentZone});const mouseMove=(col,row)=>{if(lastCol!==col||lastRow!==row){lastCol=clip(col===-1?lastCol:col,0,this.env.model.getters.getNumberCols(activeSheetId)-1);lastRow=clip(row===-1?lastRow:row,0,this.env.model.getters.getNumberRows(activeSheetId)-1);let newZone={left:Math.min(pivotCol,lastCol),top:Math.min(pivotRow,lastRow),right:Math.max(pivotCol,lastCol),bottom:Math.max(pivotRow,lastRow),};if(!isEqual(newZone,currentZone)){this.env.model.selection.selectZone({cell:{col:newZone.left,row:newZone.top},zone:newZone,},{unbounded:true});currentZone=newZone;}}};const mouseUp=()=>{this.highlightState.shiftingMode="none";};dragAndDropBeyondTheViewport(this.env,mouseMove,mouseUp);}
onMoveHighlight(clientX,clientY){this.highlightState.shiftingMode="isMoving";const z=this.props.zone;const position=gridOverlayPosition();const activeSheetId=this.env.model.getters.getActiveSheetId();const initCol=this.env.model.getters.getColIndex(clientX-position.left);const initRow=this.env.model.getters.getRowIndex(clientY-position.top);const deltaColMin=-z.left;const deltaColMax=this.env.model.getters.getNumberCols(activeSheetId)-z.right-1;const deltaRowMin=-z.top;const deltaRowMax=this.env.model.getters.getNumberRows(activeSheetId)-z.bottom-1;let currentZone=z;this.env.model.dispatch("START_CHANGE_HIGHLIGHT",{zone:currentZone});let lastCol=initCol;let lastRow=initRow;const mouseMove=(col,row)=>{if(lastCol!==col||lastRow!==row){lastCol=col===-1?lastCol:col;lastRow=row===-1?lastRow:row;const deltaCol=clip(lastCol-initCol,deltaColMin,deltaColMax);const deltaRow=clip(lastRow-initRow,deltaRowMin,deltaRowMax);let newZone={left:z.left+deltaCol,top:z.top+deltaRow,right:z.right+deltaCol,bottom:z.bottom+deltaRow,};if(!isEqual(newZone,currentZone)){this.env.model.selection.selectZone({cell:{col:newZone.left,row:newZone.top},zone:newZone,},{unbounded:true});currentZone=newZone;}}};const mouseUp=()=>{this.highlightState.shiftingMode="none";};dragAndDropBeyondTheViewport(this.env,mouseMove,mouseUp);}}
Highlight.props={zone:Object,color:String,};let ScrollBar$1=class ScrollBar{direction;el;constructor(el,direction){this.el=el;this.direction=direction;}
get scroll(){return this.direction==="horizontal"?this.el.scrollLeft:this.el.scrollTop;}
set scroll(value){if(this.direction==="horizontal"){this.el.scrollLeft=value;}
else{this.el.scrollTop=value;}}};css`
  .o-scrollbar {
    position: absolute;
    overflow: auto;
    z-index: ${ComponentsImportance.ScrollBar};
    background-color: ${BACKGROUND_GRAY_COLOR};

    &.corner {
      right: 0px;
      bottom: 0px;
      height: ${SCROLLBAR_WIDTH}px;
      width: ${SCROLLBAR_WIDTH}px;
      border-top: 1px solid #e2e3e3;
      border-left: 1px solid #e2e3e3;
    }
  }
`;class ScrollBar extends owl.Component{static template=owl.xml`
    <div
        t-attf-class="o-scrollbar {{props.direction}}"
        t-on-scroll="onScroll"
        t-ref="scrollbar"
        t-att-style="positionCss">
      <div t-att-style="sizeCss"/>
    </div>
  `;static defaultProps={width:1,height:1,};scrollbarRef;scrollbar;setup(){this.scrollbarRef=owl.useRef("scrollbar");this.scrollbar=new ScrollBar$1(this.scrollbarRef.el,this.props.direction);owl.onMounted(()=>{this.scrollbar.el=this.scrollbarRef.el;});owl.useEffect(()=>{if(this.scrollbar.scroll!==this.props.offset){this.scrollbar.scroll=this.props.offset;}},()=>[this.scrollbar.scroll,this.props.offset]);}
get sizeCss(){return cssPropertiesToCss({width:`${this.props.width}px`,height:`${this.props.height}px`,});}
get positionCss(){return cssPropertiesToCss(this.props.position);}
onScroll(ev){if(this.props.offset!==this.scrollbar.scroll){this.props.onScroll(this.scrollbar.scroll);}}}
ScrollBar.props={width:{type:Number,optional:true},height:{type:Number,optional:true},direction:String,position:Object,offset:Number,onScroll:Function,};class HorizontalScrollBar extends owl.Component{static components={ScrollBar};static template=owl.xml`
      <ScrollBar
        t-if="isDisplayed"
        width="width"
        position="position"
        offset="offset"
        direction="'horizontal'"
        onScroll.bind="onScroll"
      />`;static defaultProps={leftOffset:0,};get offset(){return this.env.model.getters.getActiveSheetDOMScrollInfo().scrollX;}
get width(){return this.env.model.getters.getMainViewportRect().width;}
get isDisplayed(){const{xRatio}=this.env.model.getters.getFrozenSheetViewRatio(this.env.model.getters.getActiveSheetId());return xRatio<1;}
get position(){const{x}=this.env.model.getters.getMainViewportRect();return{left:`${this.props.leftOffset + x}px`,bottom:"0px",height:`${SCROLLBAR_WIDTH}px`,right:`0px`,};}
onScroll(offset){const{scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:offset,offsetY:scrollY,});}}
HorizontalScrollBar.props={leftOffset:{type:Number,optional:true},};class VerticalScrollBar extends owl.Component{static components={ScrollBar};static template=owl.xml`
    <ScrollBar
      t-if="isDisplayed"
      height="height"
      position="position"
      offset="offset"
      direction="'vertical'"
      onScroll.bind="onScroll"
    />`;static defaultProps={topOffset:0,};get offset(){return this.env.model.getters.getActiveSheetDOMScrollInfo().scrollY;}
get height(){return this.env.model.getters.getMainViewportRect().height;}
get isDisplayed(){const{yRatio}=this.env.model.getters.getFrozenSheetViewRatio(this.env.model.getters.getActiveSheetId());return yRatio<1;}
get position(){const{y}=this.env.model.getters.getMainViewportRect();return{top:`${this.props.topOffset + y}px`,right:"0px",width:`${SCROLLBAR_WIDTH}px`,bottom:`0px`,};}
onScroll(offset){const{scrollX}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX,offsetY:offset,});}}
VerticalScrollBar.props={topOffset:{type:Number,optional:true},};const registries$1={ROW:rowMenuRegistry,COL:colMenuRegistry,CELL:cellMenuRegistry,GROUP_HEADERS:groupHeadersMenuRegistry,UNGROUP_HEADERS:unGroupHeadersMenuRegistry,};const MODIFIER_KEYS=["Shift","Control","Alt","Meta"];class Grid extends owl.Component{static template="o-spreadsheet-Grid";static components={GridComposer,GridOverlay,GridPopover,HeadersOverlay,Menu,Autofill,ClientTag,Highlight,Popover,VerticalScrollBar,HorizontalScrollBar,FilterIconsOverlay,};HEADER_HEIGHT=HEADER_HEIGHT;HEADER_WIDTH=HEADER_WIDTH;menuState;gridRef;onMouseWheel;canvasPosition;hoveredCell;setup(){this.menuState=owl.useState({isOpen:false,position:null,menuItems:[],});this.gridRef=owl.useRef("grid");this.canvasPosition=useAbsoluteBoundingRect(this.gridRef);this.hoveredCell=owl.useState({col:undefined,row:undefined});owl.useChildSubEnv({getPopoverContainerRect:()=>this.getGridRect()});owl.useExternalListener(document.body,"cut",this.copy.bind(this,true));owl.useExternalListener(document.body,"copy",this.copy.bind(this,false));owl.useExternalListener(document.body,"paste",this.paste);owl.onMounted(()=>this.focusDefaultElement());this.props.exposeFocus(()=>this.focusDefaultElement());useGridDrawing("canvas",this.env.model,()=>this.env.model.getters.getSheetViewDimensionWithHeaders());owl.useEffect(()=>this.focusDefaultElement(),()=>[this.env.model.getters.getActiveSheetId()]);this.onMouseWheel=useWheelHandler((deltaX,deltaY)=>{this.moveCanvas(deltaX,deltaY);this.hoveredCell.col=undefined;this.hoveredCell.row=undefined;});}
onCellHovered({col,row}){this.hoveredCell.col=col;this.hoveredCell.row=row;}
get gridOverlayDimensions(){return cssPropertiesToCss({top:`${HEADER_HEIGHT}px`,left:`${HEADER_WIDTH}px`,height:`calc(100% - ${HEADER_HEIGHT + SCROLLBAR_WIDTH}px)`,width:`calc(100% - ${HEADER_WIDTH + SCROLLBAR_WIDTH}px)`,});}
onClosePopover(){if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
this.focusDefaultElement();}
keyDownMapping={ENTER:()=>{const cell=this.env.model.getters.getActiveCell();cell.type===CellValueType.empty?this.props.onGridComposerCellFocused():this.props.onComposerContentFocused();},TAB:()=>this.env.model.selection.moveAnchorCell("right",1),"SHIFT+TAB":()=>this.env.model.selection.moveAnchorCell("left",1),F2:()=>{const cell=this.env.model.getters.getActiveCell();cell.type===CellValueType.empty?this.props.onGridComposerCellFocused():this.props.onComposerContentFocused();},DELETE:()=>{this.env.model.dispatch("DELETE_CONTENT",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),});},BACKSPACE:()=>{this.env.model.dispatch("DELETE_CONTENT",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),});},ESCAPE:()=>{if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
else if(this.menuState.isOpen){this.closeMenu();}
else if(this.env.model.getters.isPaintingFormat()){this.env.model.dispatch("CANCEL_PAINT_FORMAT");}
else{this.env.model.dispatch("CLEAN_CLIPBOARD_HIGHLIGHT");}},"CTRL+A":()=>this.env.model.selection.loopSelection(),"CTRL+Z":()=>this.env.model.dispatch("REQUEST_UNDO"),"CTRL+Y":()=>this.env.model.dispatch("REQUEST_REDO"),F4:()=>this.env.model.dispatch("REQUEST_REDO"),"CTRL+B":()=>this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{bold:!this.env.model.getters.getCurrentStyle().bold},}),"CTRL+I":()=>this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{italic:!this.env.model.getters.getCurrentStyle().italic},}),"CTRL+U":()=>this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{underline:!this.env.model.getters.getCurrentStyle().underline},}),"CTRL+O":()=>CREATE_IMAGE(this.env),"ALT+=":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const mainSelectedZone=this.env.model.getters.getSelectedZone();const{anchor}=this.env.model.getters.getSelection();const sums=this.env.model.getters.getAutomaticSums(sheetId,mainSelectedZone,anchor.cell);if(this.env.model.getters.isSingleCellOrMerge(sheetId,mainSelectedZone)||(this.env.model.getters.isEmpty(sheetId,mainSelectedZone)&&sums.length<=1)){const zone=sums[0]?.zone;const zoneXc=zone?this.env.model.getters.zoneToXC(sheetId,sums[0].zone):"";const formula=`=SUM(${zoneXc})`;this.props.onGridComposerCellFocused(formula,{start:5,end:5+zoneXc.length});}
else{this.env.model.dispatch("SUM_SELECTION");}},"ALT+ENTER":()=>{const cell=this.env.model.getters.getActiveCell();if(cell.link){openLink(cell.link,this.env);}},"CTRL+HOME":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const{col,row}=this.env.model.getters.getNextVisibleCellPosition({sheetId,col:0,row:0,});this.env.model.selection.selectCell(col,row);},"CTRL+END":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const col=this.env.model.getters.findVisibleHeader(sheetId,"COL",this.env.model.getters.getNumberCols(sheetId)-1,0);const row=this.env.model.getters.findVisibleHeader(sheetId,"ROW",this.env.model.getters.getNumberRows(sheetId)-1,0);this.env.model.selection.selectCell(col,row);},"SHIFT+ ":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const newZone={...this.env.model.getters.getSelectedZone(),left:0,right:this.env.model.getters.getNumberCols(sheetId)-1,};const position=this.env.model.getters.getActivePosition();this.env.model.selection.selectZone({cell:position,zone:newZone});},"CTRL+ ":()=>{const sheetId=this.env.model.getters.getActiveSheetId();const newZone={...this.env.model.getters.getSelectedZone(),top:0,bottom:this.env.model.getters.getNumberRows(sheetId)-1,};const position=this.env.model.getters.getActivePosition();this.env.model.selection.selectZone({cell:position,zone:newZone});},"CTRL+D":async()=>this.env.model.dispatch("COPY_PASTE_CELLS_ABOVE"),"CTRL+R":async()=>this.env.model.dispatch("COPY_PASTE_CELLS_ON_LEFT"),"CTRL+SHIFT+E":()=>this.setHorizontalAlign("center"),"CTRL+SHIFT+L":()=>this.setHorizontalAlign("left"),"CTRL+SHIFT+R":()=>this.setHorizontalAlign("right"),"CTRL+SHIFT+V":()=>PASTE_VALUE_ACTION(this.env),"CTRL+SHIFT+<":()=>this.clearFormatting(),"CTRL+<":()=>this.clearFormatting(),"CTRL+SHIFT+ ":()=>{this.env.model.selection.selectAll();},"CTRL+ALT+=":()=>{const activeCols=this.env.model.getters.getActiveCols();const activeRows=this.env.model.getters.getActiveRows();const isSingleSelection=this.env.model.getters.getSelectedZones().length===1;const areFullCols=activeCols.size>0&&isSingleSelection;const areFullRows=activeRows.size>0&&isSingleSelection;if(areFullCols&&!areFullRows){INSERT_COLUMNS_BEFORE_ACTION(this.env);}
else if(areFullRows&&!areFullCols){INSERT_ROWS_BEFORE_ACTION(this.env);}},"CTRL+ALT+-":()=>{const columns=[...this.env.model.getters.getActiveCols()];const rows=[...this.env.model.getters.getActiveRows()];if(columns.length>0&&rows.length===0){this.env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"COL",elements:columns,});}
else if(rows.length>0&&columns.length===0){this.env.model.dispatch("REMOVE_COLUMNS_ROWS",{sheetId:this.env.model.getters.getActiveSheetId(),dimension:"ROW",elements:rows,});}},"SHIFT+PAGEDOWN":()=>{this.env.model.dispatch("ACTIVATE_NEXT_SHEET");},"SHIFT+PAGEUP":()=>{this.env.model.dispatch("ACTIVATE_PREVIOUS_SHEET");},PAGEDOWN:()=>this.env.model.dispatch("SHIFT_VIEWPORT_DOWN"),PAGEUP:()=>this.env.model.dispatch("SHIFT_VIEWPORT_UP"),"CTRL+K":()=>INSERT_LINK(this.env),"ALT+SHIFT+ARROWRIGHT":()=>this.processHeaderGroupingKey("right"),"ALT+SHIFT+ARROWLEFT":()=>this.processHeaderGroupingKey("left"),"ALT+SHIFT+ARROWUP":()=>this.processHeaderGroupingKey("up"),"ALT+SHIFT+ARROWDOWN":()=>this.processHeaderGroupingKey("down"),};focusDefaultElement(){if(!this.env.model.getters.getSelectedFigureId()&&this.env.model.getters.getEditionMode()==="inactive"){this.env.focusableElement.focus();}}
get gridEl(){if(!this.gridRef.el){throw new Error("Grid el is not defined.");}
return this.gridRef.el;}
getAutofillPosition(){const zone=this.env.model.getters.getSelectedZone();const rect=this.env.model.getters.getVisibleRect(zone);return{left:rect.x+rect.width-AUTOFILL_EDGE_LENGTH/2,top:rect.y+rect.height-AUTOFILL_EDGE_LENGTH/2,};}
get isAutofillVisible(){const zone=this.env.model.getters.getSelectedZone();const rect=this.env.model.getters.getVisibleRect({left:zone.right,right:zone.right,top:zone.bottom,bottom:zone.bottom,});return!(rect.width===0||rect.height===0);}
onGridResized({height,width}){this.env.model.dispatch("RESIZE_SHEETVIEW",{width:width,height:height,gridOffsetX:HEADER_WIDTH,gridOffsetY:HEADER_HEIGHT,});}
moveCanvas(deltaX,deltaY){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX+deltaX,offsetY:scrollY+deltaY,});}
getClientPositionKey(client){return`${client.id}-${client.position?.sheetId}-${client.position?.col}-${client.position?.row}`;}
isCellHovered(col,row){return this.hoveredCell.col===col&&this.hoveredCell.row===row;}
getGridRect(){return{...this.canvasPosition,...this.env.model.getters.getSheetViewDimensionWithHeaders()};}
onCellClicked(col,row,{addZone,expandZone}){if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
if(this.env.model.getters.getEditionMode()==="editing"){interactiveStopEdition(this.env);}
if(expandZone){this.env.model.selection.setAnchorCorner(col,row);}
else if(addZone){this.env.model.selection.addCellToSelection(col,row);}
else{this.env.model.selection.selectCell(col,row);}
let prevCol=col;let prevRow=row;const onMouseMove=(col,row,ev)=>{ev.preventDefault();if((col!==prevCol&&col!=-1)||(row!==prevRow&&row!=-1)){prevCol=col===-1?prevCol:col;prevRow=row===-1?prevRow:row;this.env.model.selection.setAnchorCorner(prevCol,prevRow);}};const onMouseUp=()=>{if(this.env.model.getters.isPaintingFormat()){this.env.model.dispatch("PASTE",{target:this.env.model.getters.getSelectedZones(),});}};dragAndDropBeyondTheViewport(this.env,onMouseMove,onMouseUp);}
onCellDoubleClicked(col,row){const sheetId=this.env.model.getters.getActiveSheetId();({col,row}=this.env.model.getters.getMainCellPosition({sheetId,col,row}));const cell=this.env.model.getters.getEvaluatedCell({sheetId,col,row});if(cell.type===CellValueType.empty){this.props.onGridComposerCellFocused();}
else{this.props.onComposerContentFocused();}}
closeOpenedPopover(){this.env.model.dispatch("CLOSE_CELL_POPOVER");}
processArrows(ev){ev.preventDefault();ev.stopPropagation();if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
updateSelectionWithArrowKeys(ev,this.env.model.selection);if(this.env.model.getters.isPaintingFormat()){this.env.model.dispatch("PASTE",{target:this.env.model.getters.getSelectedZones(),});}}
onKeydown(ev){let keyDownString="";if(!MODIFIER_KEYS.includes(ev.key)){if(isCtrlKey(ev))
keyDownString+="CTRL+";if(ev.altKey)
keyDownString+="ALT+";if(ev.shiftKey)
keyDownString+="SHIFT+";}
keyDownString+=ev.key.toUpperCase();let handler=this.keyDownMapping[keyDownString];if(handler){ev.preventDefault();ev.stopPropagation();handler();return;}
if(ev.key.startsWith("Arrow")){this.processArrows(ev);return;}}
onInputContextMenu(ev){ev.preventDefault();const lastZone=this.env.model.getters.getSelectedZone();const{left:col,top:row}=lastZone;let type="CELL";interactiveStopEdition(this.env);if(this.env.model.getters.getActiveCols().has(col)){type="COL";}
else if(this.env.model.getters.getActiveRows().has(row)){type="ROW";}
const{x,y,width}=this.env.model.getters.getVisibleRect(lastZone);const gridRect=this.getGridRect();this.toggleContextMenu(type,gridRect.x+x+width,gridRect.y+y);}
onCellRightClicked(col,row,{x,y}){const zones=this.env.model.getters.getSelectedZones();const lastZone=zones[zones.length-1];let type="CELL";if(!isInside(col,row,lastZone)){this.env.model.selection.getBackToDefault();this.env.model.selection.selectCell(col,row);}
else{if(this.env.model.getters.getActiveCols().has(col)){type="COL";}
else if(this.env.model.getters.getActiveRows().has(row)){type="ROW";}}
this.toggleContextMenu(type,x,y);}
toggleContextMenu(type,x,y){if(this.env.model.getters.hasOpenedPopover()){this.closeOpenedPopover();}
this.menuState.isOpen=true;this.menuState.position={x,y};this.menuState.menuItems=registries$1[type].getMenuItems();}
copy(cut,ev){if(!this.gridEl.contains(document.activeElement)){return;}
const clipboardData=ev.clipboardData;if(!clipboardData){this.displayWarningCopyPasteNotSupported();return;}
if(this.env.model.getters.getEditionMode()!=="inactive"){return;}
if(cut){interactiveCut(this.env);}
else{this.env.model.dispatch("COPY");}
const content=this.env.model.getters.getClipboardContent();for(const type in content){clipboardData.setData(type,content[type]);}
ev.preventDefault();}
async paste(ev){if(!this.gridEl.contains(document.activeElement)){return;}
const clipboardData=ev.clipboardData;if(!clipboardData){this.displayWarningCopyPasteNotSupported();return;}
if(clipboardData.types.indexOf(ClipboardMIMEType.PlainText)>-1){const content=clipboardData.getData(ClipboardMIMEType.PlainText);const target=this.env.model.getters.getSelectedZones();const clipboardString=this.env.model.getters.getClipboardTextContent();const isCutOperation=this.env.model.getters.isCutOperation();if(clipboardString===content){interactivePaste(this.env,target);}
else{interactivePasteFromOS(this.env,target,content);}
if(isCutOperation){await this.env.clipboard.write({[ClipboardMIMEType.PlainText]:""});}}}
displayWarningCopyPasteNotSupported(){this.env.raiseError(_t("Copy/Paste is not supported in this browser."));}
clearFormatting(){this.env.model.dispatch("CLEAR_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),});}
setHorizontalAlign(align){this.env.model.dispatch("SET_FORMATTING",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),style:{align},});}
closeMenu(){this.menuState.isOpen=false;this.focusDefaultElement();}
processHeaderGroupingKey(direction){if(this.env.model.getters.getSelectedZones().length!==1){return;}
const selectingRows=this.env.model.getters.getActiveRows().size>0;const selectingCols=this.env.model.getters.getActiveCols().size>0;if(selectingCols&&selectingRows){this.processHeaderGroupingEventOnWholeSheet(direction);}
else if(selectingCols){this.processHeaderGroupingEventOnHeaders(direction,"COL");}
else if(selectingRows){this.processHeaderGroupingEventOnHeaders(direction,"ROW");}
else{this.processHeaderGroupingEventOnGrid(direction);}}
processHeaderGroupingEventOnHeaders(direction,dimension){const sheetId=this.env.model.getters.getActiveSheetId();const zone=this.env.model.getters.getSelectedZone();const start=dimension==="COL"?zone.left:zone.top;const end=dimension==="COL"?zone.right:zone.bottom;switch(direction){case"right":this.env.model.dispatch("GROUP_HEADERS",{sheetId,dimension:dimension,start,end});break;case"left":this.env.model.dispatch("UNGROUP_HEADERS",{sheetId,dimension:dimension,start,end});break;case"down":this.env.model.dispatch("UNFOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension,zone});break;case"up":this.env.model.dispatch("FOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension,zone});break;}}
processHeaderGroupingEventOnWholeSheet(direction){const sheetId=this.env.model.getters.getActiveSheetId();if(direction==="up"){this.env.model.dispatch("FOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"ROW"});this.env.model.dispatch("FOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"COL"});}
else if(direction==="down"){this.env.model.dispatch("UNFOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"ROW"});this.env.model.dispatch("UNFOLD_ALL_HEADER_GROUPS",{sheetId,dimension:"COL"});}}
processHeaderGroupingEventOnGrid(direction){const sheetId=this.env.model.getters.getActiveSheetId();const zone=this.env.model.getters.getSelectedZone();switch(direction){case"down":this.env.model.dispatch("UNFOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"ROW",zone:zone,});this.env.model.dispatch("UNFOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"COL",zone:zone,});break;case"up":this.env.model.dispatch("FOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"ROW",zone:zone,});this.env.model.dispatch("FOLD_HEADER_GROUPS_IN_ZONE",{sheetId,dimension:"COL",zone:zone,});break;case"right":{const{x,y,width}=this.env.model.getters.getVisibleRect(zone);const gridRect=this.getGridRect();this.toggleContextMenu("GROUP_HEADERS",x+width+gridRect.x,y+gridRect.y);break;}
case"left":{if(!canUngroupHeaders(this.env,"COL")&&!canUngroupHeaders(this.env,"ROW")){return;}
const{x,y,width}=this.env.model.getters.getVisibleRect(zone);const gridRect=this.getGridRect();this.toggleContextMenu("UNGROUP_HEADERS",x+width+gridRect.x,y+gridRect.y);break;}}}}
Grid.props={sidePanelIsOpen:Boolean,exposeFocus:Function,focusComposer:String,onComposerContentFocused:Function,onGridComposerCellFocused:Function,};class XMLString{xmlString;constructor(xmlString){this.xmlString=xmlString;}
toString(){return this.xmlString;}}
const XLSX_CHART_TYPES=["areaChart","area3DChart","lineChart","line3DChart","stockChart","radarChart","scatterChart","pieChart","pie3DChart","doughnutChart","barChart","bar3DChart","ofPieChart","surfaceChart","surface3DChart","bubbleChart",];const AUTO_COLOR="000000";const XLSX_ICONSET_MAP={arrow:"3Arrows",smiley:"3Symbols",dot:"3TrafficLights1",};const NAMESPACE={styleSheet:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",sst:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",Relationships:"http://schemas.openxmlformats.org/package/2006/relationships",Types:"http://schemas.openxmlformats.org/package/2006/content-types",worksheet:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",workbook:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",drawing:"http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing",table:"http://schemas.openxmlformats.org/spreadsheetml/2006/main",revision:"http://schemas.microsoft.com/office/spreadsheetml/2014/revision",revision3:"http://schemas.microsoft.com/office/spreadsheetml/2016/revision3",markupCompatibility:"http://schemas.openxmlformats.org/markup-compatibility/2006",};const DRAWING_NS_A="http://schemas.openxmlformats.org/drawingml/2006/main";const DRAWING_NS_C="http://schemas.openxmlformats.org/drawingml/2006/chart";const CONTENT_TYPES={workbook:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml",sheet:"application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml",sharedStrings:"application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml",styles:"application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml",drawing:"application/vnd.openxmlformats-officedocument.drawing+xml",chart:"application/vnd.openxmlformats-officedocument.drawingml.chart+xml",themes:"application/vnd.openxmlformats-officedocument.theme+xml",table:"application/vnd.openxmlformats-officedocument.spreadsheetml.table+xml",pivot:"application/vnd.openxmlformats-officedocument.spreadsheetml.pivotTable+xml",externalLink:"application/vnd.openxmlformats-officedocument.spreadsheetml.externalLink+xml",};const XLSX_RELATION_TYPE={document:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument",sheet:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet",sharedStrings:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings",styles:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles",drawing:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing",chart:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/chart",theme:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme",table:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/table",hyperlink:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink",image:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/image",};const RELATIONSHIP_NSR="http://schemas.openxmlformats.org/officeDocument/2006/relationships";const HEIGHT_FACTOR=0.75;const WIDTH_FACTOR=0.143;const EXCEL_DEFAULT_COL_WIDTH=8.43;const EXCEL_DEFAULT_ROW_HEIGHT=12.75;const EXCEL_IMPORT_DEFAULT_NUMBER_OF_COLS=30;const EXCEL_IMPORT_DEFAULT_NUMBER_OF_ROWS=100;const FIRST_NUMFMT_ID=164;const FORCE_DEFAULT_ARGS_FUNCTIONS={FLOOR:[{type:"NUMBER",value:1}],CEILING:[{type:"NUMBER",value:1}],ROUND:[{type:"NUMBER",value:0}],ROUNDUP:[{type:"NUMBER",value:0}],ROUNDDOWN:[{type:"NUMBER",value:0}],};const NON_RETROCOMPATIBLE_FUNCTIONS=["ACOT","ACOTH","AGGREGATE","ARABIC","BASE","BETA.DIST","BETA.INV","BINOM.DIST","BINOM.DIST.RANGE","BINOM.INV","BITAND","BITLSHIFT","BITOR","BITRSHIFT","BITXOR","CEILING.MATH","CEILING.PRECISE","CHISQ.DIST","CHISQ.DIST.RT","CHISQ.INV","CHISQ.INV.RT","CHISQ.TEST","COMBINA","CONCAT","CONFIDENCE.NORM","CONFIDENCE.T","COT","COTH","COVARIANCE.P","COVARIANCE.S","CSC","CSCH","DAYS","DECIMAL","ERF.PRECISE","ERFC.PRECISE","EXPON.DIST","F.DIST","F.DIST.RT","F.INV","F.INV.RT","F.TEST","FILTERXML","FLOOR.MATH","FLOOR.PRECISE","FORECAST.ETS","FORECAST.ETS.CONFINT","FORECAST.ETS.SEASONALITY","FORECAST.ETS.STAT","FORECAST.LINEAR","FORMULATEXT","GAMMA","GAMMA.DIST","GAMMA.INV","GAMMALN.PRECISE","GAUSS","HYPGEOM.DIST","IFNA","IFS","IMCOSH","IMCOT","IMCSC","IMCSCH","IMSEC","IMSECH","IMSINH","IMTAN","ISFORMULA","ISOWEEKNUM","LOGNORM.DIST","LOGNORM.INV","MAXIFS","MINIFS","MODE.MULT","MODE.SNGL","MUNIT","NEGBINOM.DIST","NORM.DIST","NORM.INV","NORM.S.DIST","NORM.S.INV","NUMBERVALUE","PDURATION","PERCENTILE.EXC","PERCENTILE.INC","PERCENTRANK.EXC","PERCENTRANK.INC","PERMUTATIONA","PHI","POISSON.DIST","QUARTILE.EXC","QUARTILE.INC","QUERYSTRING","RANK.AVG","RANK.EQ","RRI","SEC","SECH","SHEET","SHEETS","SKEW.P","STDEV.P","STDEV.S","SWITCH","T.DIST","T.DIST.2T","T.DIST.RT","T.INV","T.INV.2T","T.TEST","TEXTJOIN","UNICHAR","UNICODE","VAR.P","VAR.S","WEBSERVICE","WEIBULL.DIST","XOR","Z.TEST",];const CONTENT_TYPES_FILE="[Content_Types].xml";var WarningTypes;(function(WarningTypes){WarningTypes["DiagonalBorderNotSupported"]="Diagonal Borders";WarningTypes["BorderStyleNotSupported"]="Border style";WarningTypes["FillStyleNotSupported"]="Fill Style";WarningTypes["FontNotSupported"]="Font";WarningTypes["HorizontalAlignmentNotSupported"]="Horizontal Alignment";WarningTypes["VerticalAlignmentNotSupported"]="Vertical Alignments";WarningTypes["MultipleRulesCfNotSupported"]="Multiple rules conditional formats";WarningTypes["CfTypeNotSupported"]="Conditional format type";WarningTypes["CfFormatBorderNotSupported"]="Borders in conditional formats";WarningTypes["CfFormatAlignmentNotSupported"]="Alignment in conditional formats";WarningTypes["CfFormatNumFmtNotSupported"]="Num formats in conditional formats";WarningTypes["CfIconSetEmptyIconNotSupported"]="IconSets with empty icons";WarningTypes["BadlyFormattedHyperlink"]="Badly formatted hyperlink";WarningTypes["NumFmtIdNotSupported"]="Number format";})(WarningTypes||(WarningTypes={}));class XLSXImportWarningManager{_parsingWarnings=new Set();_conversionWarnings=new Set();addParsingWarning(warning){this._parsingWarnings.add(warning);}
addConversionWarning(warning){this._conversionWarnings.add(warning);}
get warnings(){return[...this._parsingWarnings,...this._conversionWarnings];}
generateNotSupportedWarning(type,name,supported){let warning=`${type} ${name ? '"' + name + '" is' : "are"} not yet supported. `;if(supported){warning+=`Only ${supported.join(", ")} are currently supported.`;}
if(!this._conversionWarnings.has(warning)){this._conversionWarnings.add(warning);}}}
const SUPPORTED_BORDER_STYLES=["thin"];const SUPPORTED_HORIZONTAL_ALIGNMENTS=["general","left","center","right",];const SUPPORTED_VERTICAL_ALIGNMENTS=["top","center","bottom"];const SUPPORTED_FONTS=["Arial"];const SUPPORTED_FILL_PATTERNS=["solid"];const SUPPORTED_CF_TYPES=["expression","cellIs","colorScale","iconSet","containsText","notContainsText","beginsWith","endsWith","containsBlanks","notContainsBlanks",];const CELL_TYPE_CONVERSION_MAP={b:"boolean",d:"date",e:"error",inlineStr:"inlineStr",n:"number",s:"sharedString",str:"str",};const BORDER_STYLE_CONVERSION_MAP={dashDot:"thin",dashDotDot:"thin",dashed:"dashed",dotted:"dotted",double:"thin",hair:"thin",medium:"medium",mediumDashDot:"thin",mediumDashDotDot:"thin",mediumDashed:"thin",none:undefined,slantDashDot:"thin",thick:"thick",thin:"thin",};const H_ALIGNMENT_CONVERSION_MAP={general:undefined,left:"left",center:"center",right:"right",fill:"left",justify:"left",centerContinuous:"center",distributed:"center",};const V_ALIGNMENT_CONVERSION_MAP={top:"top",center:"middle",bottom:"bottom",justify:"middle",distributed:"middle",};const V_ALIGNMENT_EXPORT_CONVERSION_MAP={top:"top",middle:"center",bottom:"bottom",};function convertCFCellIsOperator(xlsxCfOperator){return(xlsxCfOperator.slice(0,1).toUpperCase()+
xlsxCfOperator.slice(1));}
const CF_TYPE_CONVERSION_MAP={aboveAverage:undefined,expression:undefined,cellIs:undefined,colorScale:undefined,dataBar:undefined,iconSet:undefined,top10:undefined,uniqueValues:undefined,duplicateValues:undefined,containsText:"ContainsText",notContainsText:"NotContains",beginsWith:"BeginsWith",endsWith:"EndsWith",containsBlanks:"IsEmpty",notContainsBlanks:"IsNotEmpty",containsErrors:undefined,notContainsErrors:undefined,timePeriod:undefined,};const CF_THRESHOLD_CONVERSION_MAP={num:"number",percent:"percentage",max:"value",min:"value",percentile:"percentile",formula:"formula",};const ICON_SET_CONVERSION_MAP={NoIcons:undefined,"3Arrows":"arrows","3ArrowsGray":"arrows","3Symbols":"smiley","3Symbols2":"smiley","3Signs":"dots","3Flags":"dots","3TrafficLights1":"dots","3TrafficLights2":"dots","4Arrows":"arrows","4ArrowsGray":"arrows","4RedToBlack":"dots","4Rating":"smiley","4TrafficLights":"dots","5Arrows":"arrows","5ArrowsGray":"arrows","5Rating":"smiley","5Quarters":"dots","3Stars":"smiley","3Triangles":"arrows","5Boxes":"dots",};const DRAWING_LEGEND_POSITION_CONVERSION_MAP={b:"bottom",t:"top",l:"left",r:"right",tr:"right",};const CHART_TYPE_CONVERSION_MAP={areaChart:undefined,area3DChart:undefined,lineChart:"line",line3DChart:undefined,stockChart:undefined,radarChart:undefined,scatterChart:undefined,pieChart:"pie",pie3DChart:undefined,doughnutChart:"pie",barChart:"bar",bar3DChart:undefined,ofPieChart:undefined,surfaceChart:undefined,surface3DChart:undefined,bubbleChart:undefined,};const SUBTOTAL_FUNCTION_CONVERSION_MAP={"1":"AVERAGE","2":"COUNT","3":"COUNTA","4":"MAX","5":"MIN","6":"PRODUCT","7":"STDEV","8":"STDEVP","9":"SUM","10":"VAR","11":"VARP","101":"AVERAGE","102":"COUNT","103":"COUNTA","104":"MAX","105":"MIN","106":"PRODUCT","107":"STDEV","108":"STDEVP","109":"SUM","110":"VAR","111":"VARP",};const XLSX_FORMATS_CONVERSION_MAP={0:"",1:"0",2:"0.00",3:"#,#00",4:"#,##0.00",9:"0%",10:"0.00%",11:undefined,12:undefined,13:undefined,14:"m/d/yyyy",15:"m/d/yyyy",16:"m/d/yyyy",17:"m/d/yyyy",18:"hh:mm:ss a",19:"hh:mm:ss a",20:"hhhh:mm:ss",21:"hhhh:mm:ss",22:"m/d/yy h:mm",37:undefined,38:undefined,39:undefined,40:undefined,45:"hhhh:mm:ss",46:"hhhh:mm:ss",47:"hhhh:mm:ss",48:undefined,49:undefined,};const XLSX_FORMAT_MAP={"0":1,"0.00":2,"#,#00":3,"#,##0.00":4,"0%":9,"0.00%":10,"0.00E+00":11,"# ?/?":12,"# ??/??":13,"mm-dd-yy":14,"d-mm-yy":15,"mm-yy":16,"mmm-yy":17,"h:mm AM/PM":18,"h:mm:ss AM/PM":19,"h:mm":20,"h:mm:ss":21,"m/d/yy h:mm":22,"#,##0 ;(#,##0)":37,"#,##0 ;[Red](#,##0)":38,"#,##0.00;(#,##0.00)":39,"#,##0.00;[Red](#,##0.00)":40,"mm:ss":45,"[h]:mm:ss":46,"mmss.0":47,"##0.0E+0":48,"@":49,"hh:mm:ss a":19,};const XLSX_INDEXED_COLORS={0:"000000",1:"FFFFFF",2:"FF0000",3:"00FF00",4:"0000FF",5:"FFFF00",6:"FF00FF",7:"00FFFF",8:"000000",9:"FFFFFF",10:"FF0000",11:"00FF00",12:"0000FF",13:"FFFF00",14:"FF00FF",15:"00FFFF",16:"800000",17:"008000",18:"000080",19:"808000",20:"800080",21:"008080",22:"C0C0C0",23:"808080",24:"9999FF",25:"993366",26:"FFFFCC",27:"CCFFFF",28:"660066",29:"FF8080",30:"0066CC",31:"CCCCFF",32:"000080",33:"FF00FF",34:"FFFF00",35:"00FFFF",36:"800080",37:"800000",38:"008080",39:"0000FF",40:"00CCFF",41:"CCFFFF",42:"CCFFCC",43:"FFFF99",44:"99CCFF",45:"FF99CC",46:"CC99FF",47:"FFCC99",48:"3366FF",49:"33CCCC",50:"99CC00",51:"FFCC00",52:"FF9900",53:"FF6600",54:"666699",55:"969696",56:"003366",57:"339966",58:"003300",59:"333300",60:"993300",61:"993366",62:"333399",63:"333333",64:"000000",65:"FFFFFF",};const IMAGE_MIMETYPE_TO_EXTENSION_MAPPING={"image/avif":"avif","image/bmp":"bmp","image/gif":"gif","image/vnd.microsoft.icon":"ico","image/jpeg":"jpeg","image/png":"png","image/tiff":"tiff","image/webp":"webp",};const IMAGE_EXTENSION_TO_MIMETYPE_MAPPING={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",ico:"image/vnd.microsoft.icon",jpeg:"image/jpeg",png:"image/png",tiff:"image/tiff",webp:"image/webp",jpg:"image/jpeg",};function convertColor(xlsxColor){if(!xlsxColor){return undefined;}
let rgb;if(xlsxColor.rgb){rgb=xlsxColor.rgb;}
else if(xlsxColor.auto){rgb=AUTO_COLOR;}
else if(xlsxColor.indexed){rgb=XLSX_INDEXED_COLORS[xlsxColor.indexed];}
else{return undefined;}
rgb=xlsxColorToHEXA(rgb);if(xlsxColor.tint){rgb=applyTint(rgb,xlsxColor.tint);}
rgb=rgb.toUpperCase();if(rgb.length===9&&rgb.endsWith("FF")){rgb=rgb.slice(0,7);}
return rgb;}
function xlsxColorToHEXA(color){if(color.length===6)
return"#"+color+"FF";return"#"+color.slice(2)+color.slice(0,2);}
function applyTint(color,tint){const rgba=colorToRGBA(color);const hsla=rgbaToHSLA(rgba);if(tint<0){hsla.l=hsla.l*(1+tint);}
if(tint>0){hsla.l=hsla.l*(1-tint)+(100-100*(1-tint));}
return rgbaToHex(hslaToRGBA(hsla));}
function hexaToInt(hex){if(hex.length===9){hex=hex.slice(0,7);}
return parseInt(hex.replace("#",""),16);}
function getRelativePath(from,to){const fromPathParts=from.split("/");const toPathParts=to.split("/");let relPath="";let startIndex=0;for(let i=0;i<fromPathParts.length-1;i++){if(fromPathParts[i]===toPathParts[i]){startIndex++;}
else{relPath+="../";}}
relPath+=toPathParts.slice(startIndex).join("/");return relPath;}
function arrayToObject(array,indexOffset=0){const obj={};for(let i=0;i<array.length;i++){if(array[i]){obj[i+indexOffset]=array[i];}}
return obj;}
function objectToArray(obj){const arr=[];for(let key of Object.keys(obj).map(Number)){arr[key]=obj[key];}
return arr;}
function fixXlsxUnicode(str){return str.replace(/_x([0-9a-zA-Z]{4})_/g,(match,code)=>{return String.fromCharCode(parseInt(code,16));});}
const XLSX_DATE_FORMAT_REGEX=/^(yy|yyyy|m{1,5}|d{1,4}|h{1,2}|s{1,2}|am\/pm|a\/m|\s|-|\/|\.|:)+$/i;function convertXlsxFormat(numFmtId,formats,warningManager){if(numFmtId===0){return undefined;}
let format=XLSX_FORMATS_CONVERSION_MAP[numFmtId]||formats.find((f)=>f.id===numFmtId)?.format;if(format){try{let convertedFormat=format.replace(/(.*?);.*/,"$1");convertedFormat=convertedFormat.replace(/\[(.*)-[A-Z0-9]{3}\]/g,"[$1]");convertedFormat=convertedFormat.replace(/\[\$\]/g,"");const numberOfQuotes=convertedFormat.match(/"/g)?.length||0;const numberOfOpenBrackets=convertedFormat.match(/\[/g)?.length||0;if(numberOfQuotes/2+numberOfOpenBrackets>1){throw new Error("Multiple escaped blocks in format");}
convertedFormat=convertedFormat.replace(/"(.*)"/g,"[$$$1]");convertedFormat=convertedFormat.replace(/_.{1}/g,"");convertedFormat=convertedFormat.replace(/\*.{1}/g,"");convertedFormat=convertedFormat.replace(/\\ /g," ");convertedFormat=convertedFormat.replace(/\\./g,(match)=>match[1]);if(isXlsxDateFormat(convertedFormat)){convertedFormat=convertDateFormat$1(convertedFormat);}
if(isFormatSupported(convertedFormat)){return convertedFormat;}}
catch(e){}}
warningManager.generateNotSupportedWarning(WarningTypes.NumFmtIdNotSupported,format||`nmFmtId ${numFmtId}`);return undefined;}
function isFormatSupported(format){try{formatValue(0,{format,locale:DEFAULT_LOCALE});return true;}
catch(e){return false;}}
function isXlsxDateFormat(format){return XLSX_DATE_FORMAT_REGEX.test(format);}
function convertDateFormat$1(format){format=format.toLowerCase();format=format.replace(/mmmmm/g,"mmm");format=format.replace(/am\/pm|a\/m/g,"a");format=format.replace(/hhhh/g,"hh");format=format.replace(/\bh\b/g,"hh");return format;}
function convertBorders(data,warningManager){const borderArray=data.borders.map((border)=>{addBorderWarnings(border,warningManager);const b={top:convertBorderDescr$1(border.top,warningManager),bottom:convertBorderDescr$1(border.bottom,warningManager),left:convertBorderDescr$1(border.left,warningManager),right:convertBorderDescr$1(border.right,warningManager),};Object.keys(b).forEach((key)=>b[key]===undefined&&delete b[key]);return b;});return arrayToObject(borderArray,1);}
function convertBorderDescr$1(borderDescr,warningManager){if(!borderDescr)
return undefined;addBorderDescrWarnings(borderDescr,warningManager);const style=BORDER_STYLE_CONVERSION_MAP[borderDescr.style];return style?{style,color:convertColor(borderDescr.color)}:undefined;}
function convertStyles(data,warningManager){const stylesArray=data.styles.map((style)=>{return convertStyle({fontStyle:data.fonts[style.fontId],fillStyle:data.fills[style.fillId],alignment:style.alignment,},warningManager);});return arrayToObject(stylesArray,1);}
function convertStyle(styleStruct,warningManager){addStyleWarnings(styleStruct?.fontStyle,styleStruct?.fillStyle,warningManager);addHorizontalAlignmentWarnings(styleStruct?.alignment?.horizontal,warningManager);addVerticalAlignmentWarnings(styleStruct?.alignment?.vertical,warningManager);return{bold:styleStruct.fontStyle?.bold,italic:styleStruct.fontStyle?.italic,strikethrough:styleStruct.fontStyle?.strike,underline:styleStruct.fontStyle?.underline,verticalAlign:styleStruct.alignment?.vertical?V_ALIGNMENT_CONVERSION_MAP[styleStruct.alignment.vertical]:undefined,align:styleStruct.alignment?.horizontal?H_ALIGNMENT_CONVERSION_MAP[styleStruct.alignment.horizontal]:undefined,fillColor:styleStruct.fillStyle?.patternType==="solid"?convertColor(styleStruct.fillStyle?.fgColor):convertColor(styleStruct.fillStyle?.bgColor),textColor:convertColor(styleStruct.fontStyle?.color),fontSize:styleStruct.fontStyle?.size,wrapping:styleStruct.alignment?.wrapText?"wrap":"overflow",};}
function convertFormats(data,warningManager){const formats=[];for(let style of data.styles){const format=convertXlsxFormat(style.numFmtId,data.numFmts,warningManager);if(format){formats[style.numFmtId]=format;}}
return arrayToObject(formats,1);}
function addStyleWarnings(font,fill,warningManager){if(font&&font.name&&!SUPPORTED_FONTS.includes(font.name)){warningManager.generateNotSupportedWarning(WarningTypes.FontNotSupported,font.name,SUPPORTED_FONTS);}
if(fill&&fill.patternType&&!SUPPORTED_FILL_PATTERNS.includes(fill.patternType)){warningManager.generateNotSupportedWarning(WarningTypes.FillStyleNotSupported,fill.patternType,SUPPORTED_FILL_PATTERNS);}}
function addBorderDescrWarnings(borderDescr,warningManager){if(!SUPPORTED_BORDER_STYLES.includes(borderDescr.style)){warningManager.generateNotSupportedWarning(WarningTypes.BorderStyleNotSupported,borderDescr.style,SUPPORTED_BORDER_STYLES);}}
function addBorderWarnings(border,warningManager){if(border.diagonal){warningManager.generateNotSupportedWarning(WarningTypes.DiagonalBorderNotSupported);}}
function addHorizontalAlignmentWarnings(alignment,warningManager){if(alignment&&!SUPPORTED_HORIZONTAL_ALIGNMENTS.includes(alignment)){warningManager.generateNotSupportedWarning(WarningTypes.HorizontalAlignmentNotSupported,alignment,SUPPORTED_HORIZONTAL_ALIGNMENTS);}}
function addVerticalAlignmentWarnings(alignment,warningManager){if(alignment&&!SUPPORTED_VERTICAL_ALIGNMENTS.includes(alignment)){warningManager.generateNotSupportedWarning(WarningTypes.VerticalAlignmentNotSupported,alignment,SUPPORTED_VERTICAL_ALIGNMENTS);}}
function convertConditionalFormats(xlsxCfs,dxfs,warningManager){const cfs=[];let cfId=1;for(let cf of xlsxCfs){if(cf.cfRules.length===0)
continue;addCfConversionWarnings(cf,dxfs,warningManager);const rule=cf.cfRules[0];let operator;const values=[];if(rule.dxfId===undefined&&!(rule.type==="colorScale"||rule.type==="iconSet"))
continue;switch(rule.type){case"aboveAverage":case"containsErrors":case"notContainsErrors":case"dataBar":case"duplicateValues":case"expression":case"top10":case"uniqueValues":case"timePeriod":continue;case"colorScale":const colorScale=convertColorScale(cfId++,cf);if(colorScale){cfs.push(colorScale);}
continue;case"iconSet":const iconSet=convertIconSet(cfId++,cf,warningManager);if(iconSet){cfs.push(iconSet);}
continue;case"containsText":case"notContainsText":case"beginsWith":case"endsWith":if(!rule.text)
continue;operator=CF_TYPE_CONVERSION_MAP[rule.type];values.push(rule.text);break;case"containsBlanks":case"notContainsBlanks":operator=CF_TYPE_CONVERSION_MAP[rule.type];break;case"cellIs":if(!rule.operator||!rule.formula||rule.formula.length===0)
continue;operator=convertCFCellIsOperator(rule.operator);values.push(rule.formula[0]);if(rule.formula.length===2){values.push(rule.formula[1]);}
break;}
if(operator&&rule.dxfId!==undefined){cfs.push({id:(cfId++).toString(),ranges:cf.sqref,stopIfTrue:rule.stopIfTrue,rule:{type:"CellIsRule",operator:operator,values:values,style:convertStyle({fontStyle:dxfs[rule.dxfId].font,fillStyle:dxfs[rule.dxfId].fill},warningManager),},});}}
return cfs;}
function convertColorScale(id,xlsxCf){const scale=xlsxCf.cfRules[0].colorScale;if(!scale||scale.cfvos.length!==scale.colors.length||scale.cfvos.length<2||scale.cfvos.length>3){return undefined;}
const thresholds=[];for(let i=0;i<scale.cfvos.length;i++){thresholds.push({color:hexaToInt(convertColor(scale.colors[i])||"#FFFFFF"),type:CF_THRESHOLD_CONVERSION_MAP[scale.cfvos[i].type],value:scale.cfvos[i].value,});}
const minimum=thresholds[0];const maximum=thresholds.length===2?thresholds[1]:thresholds[2];const midpoint=thresholds.length===3?thresholds[1]:undefined;return{id:id.toString(),stopIfTrue:xlsxCf.cfRules[0].stopIfTrue,ranges:xlsxCf.sqref,rule:{type:"ColorScaleRule",minimum,midpoint,maximum},};}
function convertIconSet(id,xlsxCf,warningManager){const xlsxIconSet=xlsxCf.cfRules[0].iconSet;if(!xlsxIconSet)
return undefined;let cfVos=xlsxIconSet.cfvos;let cfIcons=xlsxIconSet.cfIcons;if(cfVos.length<3||(cfIcons&&cfIcons.length<3)){return undefined;}
if(cfVos.length>3){cfVos=[cfVos[0],cfVos[Math.floor(cfVos.length/2)],cfVos[cfVos.length-1]];}
if(cfIcons&&cfIcons.length>3){cfIcons=[cfIcons[0],cfIcons[Math.floor(cfIcons.length/2)],cfIcons[cfIcons.length-1]];}
const thresholds=[];for(let i=1;i<=2;i++){const type=CF_THRESHOLD_CONVERSION_MAP[cfVos[i].type];if(type==="value"){return undefined;}
thresholds.push({value:cfVos[i].value||"",operator:cfVos[i].gte?"ge":"gt",type:type,});}
let icons={lower:cfIcons?convertIcons(cfIcons[0].iconSet,cfIcons[0].iconId):convertIcons(xlsxIconSet.iconSet,0),middle:cfIcons?convertIcons(cfIcons[1].iconSet,cfIcons[1].iconId):convertIcons(xlsxIconSet.iconSet,1),upper:cfIcons?convertIcons(cfIcons[2].iconSet,cfIcons[2].iconId):convertIcons(xlsxIconSet.iconSet,2),};if(xlsxIconSet.reverse){icons={upper:icons.lower,middle:icons.middle,lower:icons.upper};}
for(let key of Object.keys(icons)){if(!icons[key]){warningManager.generateNotSupportedWarning(WarningTypes.CfIconSetEmptyIconNotSupported);switch(key){case"upper":icons[key]=ICON_SETS.dots.good;break;case"middle":icons[key]=ICON_SETS.dots.neutral;break;case"lower":icons[key]=ICON_SETS.dots.bad;break;}}}
return{id:id.toString(),stopIfTrue:xlsxCf.cfRules[0].stopIfTrue,ranges:xlsxCf.sqref,rule:{type:"IconSetRule",icons:icons,upperInflectionPoint:thresholds[1],lowerInflectionPoint:thresholds[0],},};}
function convertIcons(xlsxIconSet,index){const iconSet=ICON_SET_CONVERSION_MAP[xlsxIconSet];if(!iconSet)
return"";return index===0?ICON_SETS[iconSet].bad:index===1?ICON_SETS[iconSet].neutral:ICON_SETS[iconSet].good;}
function addCfConversionWarnings(cf,dxfs,warningManager){if(cf.cfRules.length>1){warningManager.generateNotSupportedWarning(WarningTypes.MultipleRulesCfNotSupported);}
if(!SUPPORTED_CF_TYPES.includes(cf.cfRules[0].type)){warningManager.generateNotSupportedWarning(WarningTypes.CfTypeNotSupported,cf.cfRules[0].type);}
if(cf.cfRules[0].dxfId){const dxf=dxfs[cf.cfRules[0].dxfId];if(dxf.border){warningManager.generateNotSupportedWarning(WarningTypes.CfFormatBorderNotSupported);}
if(dxf.alignment){warningManager.generateNotSupportedWarning(WarningTypes.CfFormatAlignmentNotSupported);}
if(dxf.numFmt){warningManager.generateNotSupportedWarning(WarningTypes.CfFormatNumFmtNotSupported);}}}
function convertOperator(operator){switch(operator){case"IsNotEmpty":return"notContainsBlanks";case"IsEmpty":return"containsBlanks";case"NotContains":return"notContainsBlanks";default:return operator.charAt(0).toLowerCase()+operator.slice(1);}}
function convertHeightToExcel(height){return Math.round(HEIGHT_FACTOR*height*100)/100;}
function convertWidthToExcel(width){return Math.round(WIDTH_FACTOR*width*100)/100;}
function convertHeightFromExcel(height){if(!height)
return height;return Math.round((height/HEIGHT_FACTOR)*100)/100;}
function convertWidthFromExcel(width){if(!width)
return width;return Math.round((width/WIDTH_FACTOR)*100)/100;}
function extractStyle(cell,data){let style={};if(cell.style){style=data.styles[cell.style];}
const format=extractFormat(cell,data);const styles={font:{size:style?.fontSize||DEFAULT_FONT_SIZE,color:{rgb:style?.textColor?style.textColor:"000000"},family:2,name:"Arial",},fill:style?.fillColor?{fgColor:{rgb:style.fillColor},}:{reservedAttribute:"none"},numFmt:format?{format:format,id:0}:undefined,border:cell.border||0,alignment:{horizontal:style.align,vertical:style.verticalAlign?V_ALIGNMENT_EXPORT_CONVERSION_MAP[style.verticalAlign]:undefined,wrapText:style.wrapping==="wrap",},};styles.font["strike"]=!!style?.strikethrough||undefined;styles.font["underline"]=!!style?.underline||undefined;styles.font["bold"]=!!style?.bold||undefined;styles.font["italic"]=!!style?.italic||undefined;return styles;}
function extractFormat(cell,data){if(cell.format){return data.formats[cell.format];}
return undefined;}
function normalizeStyle(construct,styles){const numFmtId=convertFormat(styles["numFmt"],construct.numFmts);const style={fontId:pushElement(styles.font,construct.fonts),fillId:pushElement(styles.fill,construct.fills),borderId:styles.border,numFmtId,alignment:{vertical:styles.alignment.vertical,horizontal:styles.alignment.horizontal,wrapText:styles.alignment.wrapText,},};return pushElement(style,construct.styles);}
function convertFormat(format,numFmtStructure){if(!format){return 0;}
let formatId=XLSX_FORMAT_MAP[format.format];if(!formatId){formatId=pushElement(format,numFmtStructure)+FIRST_NUMFMT_ID;}
return formatId;}
function addRelsToFile(relsFiles,path,rel){let relsFile=relsFiles.find((file)=>file.path===path);let id;if(!relsFile){id="rId1";relsFiles.push({path,rels:[{...rel,id}]});}
else{id=`rId${(relsFile.rels.length + 1).toString()}`;relsFile.rels.push({...rel,id,});}
return id;}
function pushElement(property,propertyList){let len=propertyList.length;const operator=typeof property==="object"?deepEquals:(a,b)=>a===b;for(let i=0;i<len;i++){if(operator(property,propertyList[i])){return i;}}
propertyList[propertyList.length]=property;return propertyList.length-1;}
const chartIds=[];function convertChartId(chartId){const xlsxId=chartIds.findIndex((id)=>id===chartId);if(xlsxId===-1){chartIds.push(chartId);return chartIds.length;}
return xlsxId+1;}
const imageIds=[];function convertImageId(imageId){const xlsxId=imageIds.findIndex((id)=>id===imageId);if(xlsxId===-1){imageIds.push(imageId);return imageIds.length;}
return xlsxId+1;}
function convertDotValueToEMU(value){const DPI=96;return Math.round((value*914400)/DPI);}
function getRangeSize(reference,defaultSheetIndex,data){let xc=reference;let sheetName=undefined;({xc,sheetName}=splitReference(reference));let rangeSheetIndex;if(sheetName){const index=data.sheets.findIndex((sheet)=>sheet.name===sheetName);if(index<0){throw new Error("Unable to find a sheet with the name "+sheetName);}
rangeSheetIndex=index;}
else{rangeSheetIndex=Number(defaultSheetIndex);}
const zone=toUnboundedZone(xc);if(zone.right===undefined){zone.right=data.sheets[rangeSheetIndex].colNumber;}
if(zone.bottom===undefined){zone.bottom=data.sheets[rangeSheetIndex].rowNumber;}
return(zone.right-zone.left+1)*(zone.bottom-zone.top+1);}
function convertEMUToDotValue(value){const DPI=96;return Math.round((value*DPI)/914400);}
function getColPosition(colIndex,sheetData){let position=0;for(let i=0;i<colIndex;i++){const colAtIndex=sheetData.cols.find((col)=>i>=col.min&&i<=col.max);if(colAtIndex?.width){position+=colAtIndex.width;}
else if(sheetData.sheetFormat?.defaultColWidth){position+=sheetData.sheetFormat.defaultColWidth;}
else{position+=EXCEL_DEFAULT_COL_WIDTH;}}
return position/WIDTH_FACTOR;}
function getRowPosition(rowIndex,sheetData){let position=0;for(let i=0;i<rowIndex;i++){const rowAtIndex=sheetData.rows[i];if(rowAtIndex?.height){position+=rowAtIndex.height;}
else if(sheetData.sheetFormat?.defaultRowHeight){position+=sheetData.sheetFormat.defaultRowHeight;}
else{position+=EXCEL_DEFAULT_ROW_HEIGHT;}}
return position/HEIGHT_FACTOR;}
function convertFigures(sheetData){let id=1;return sheetData.figures.map((figure)=>convertFigure(figure,(id++).toString(),sheetData)).filter(isDefined$1);}
function convertFigure(figure,id,sheetData){const x1=getColPosition(figure.anchors[0].col,sheetData)+
convertEMUToDotValue(figure.anchors[0].colOffset);const x2=getColPosition(figure.anchors[1].col,sheetData)+
convertEMUToDotValue(figure.anchors[1].colOffset);const y1=getRowPosition(figure.anchors[0].row,sheetData)+
convertEMUToDotValue(figure.anchors[0].rowOffset);const y2=getRowPosition(figure.anchors[1].row,sheetData)+
convertEMUToDotValue(figure.anchors[1].rowOffset);const figureData={id,x:x1,y:y1};if(isChartData(figure.data)){return{...figureData,width:x2-x1,height:y2-y1,tag:"chart",data:convertChartData(figure.data),};}
else if(isImageData(figure.data)){return{...figureData,width:convertEMUToDotValue(figure.data.size.cx),height:convertEMUToDotValue(figure.data.size.cy),tag:"image",data:{path:figure.data.imageSrc,mimetype:figure.data.mimetype,},};}
return undefined;}
function isChartData(data){return"dataSets"in data;}
function isImageData(data){return"imageSrc"in data;}
function convertChartData(chartData){const dataSetsHaveTitle=chartData.dataSets[0].label!==undefined;const labelRange=chartData.labelRange?convertExcelRangeToSheetXC(chartData.labelRange,dataSetsHaveTitle):undefined;let dataSets=chartData.dataSets.map((data)=>convertExcelRangeToSheetXC(data.range,dataSetsHaveTitle));if(chartData.type==="pie"){dataSets.reverse();}
return{dataSets,dataSetsHaveTitle,labelRange,title:chartData.title||"",type:chartData.type,background:convertColor({rgb:chartData.backgroundColor})||"#FFFFFF",verticalAxisPosition:chartData.verticalAxisPosition,legendPosition:chartData.legendPosition,stacked:chartData.stacked||false,aggregated:false,cumulative:chartData.cumulative||false,labelsAsText:false,};}
function convertExcelRangeToSheetXC(range,dataSetsHaveTitle){let{sheetName,xc}=splitReference(range);if(sheetName){sheetName=getCanonicalSheetName(sheetName)+"!";}
else{sheetName="";}
let zone=toUnboundedZone(xc);if(dataSetsHaveTitle&&zone.bottom!==undefined&&zone.right!==undefined){const height=zone.bottom-zone.top+1;const width=zone.right-zone.left+1;if(height===1){zone={...zone,left:zone.left-1};}
else if(width===1){zone={...zone,top:zone.top-1};}}
const dataXC=zoneToXc(zone);return sheetName+dataXC;}
const externalReferenceRegex=new RegExp(/'?\[([0-9]*)\](.*)'?!(\$?[a-zA-Z]*\$?[0-9]*)/g);const subtotalRegex=new RegExp(/SUBTOTAL\(([0-9]*),/g);const cellRegex=new RegExp(cellReference.source,"ig");function convertFormulasContent(sheet,data){const sfMap=getSharedFormulasMap(sheet);for(let cell of sheet.rows.map((row)=>row.cells).flat()){if(cell?.formula){cell.formula.content=cell.formula.sharedIndex!==undefined&&!cell.formula.content?"="+adaptFormula(cell.xc,sfMap[cell.formula.sharedIndex]):"="+cell.formula.content;cell.formula.content=convertFormula(cell.formula.content,data);}}}
function getSharedFormulasMap(sheet){const formulas={};for(let row of sheet.rows){for(let cell of row.cells){if(cell.formula&&cell.formula.sharedIndex!==undefined&&cell.formula.content){formulas[cell.formula.sharedIndex]={refCellXc:cell.xc,formula:cell.formula.content};}}}
return formulas;}
function convertFormula(formula,data){formula=formula.replace("_xlfn.","");formula=formula.replace(/#REF!/g,"#REF");formula=formula.replace(subtotalRegex,(match,functionId)=>{const convertedFunction=SUBTOTAL_FUNCTION_CONVERSION_MAP[functionId];return convertedFunction?convertedFunction+"(":match;});formula=formula.replace(externalReferenceRegex,(match,externalRefId,sheetName,cellRef)=>{externalRefId=Number(externalRefId)-1;cellRef=cellRef.replace(/\$/g,"");const sheetIndex=data.externalBooks[externalRefId].sheetNames.findIndex((name)=>name===sheetName);if(sheetIndex===-1){return match;}
const externalDataset=data.externalBooks[externalRefId].datasets.find((dataset)=>dataset.sheetId===sheetIndex)?.data;if(!externalDataset){return match;}
const datasetValue=externalDataset&&externalDataset[cellRef];const convertedValue=Number(datasetValue)?datasetValue:`"${datasetValue}"`;return convertedValue||match;});return formula;}
function adaptFormula(targetCell,sf){const refPosition=toCartesian(sf.refCellXc);let newFormula=sf.formula.slice();let match;do{match=cellRegex.exec(newFormula);if(match){const formulaPosition=toCartesian(match[0].replace("$",""));const targetPosition=toCartesian(targetCell);const rangePart={colFixed:match[0].startsWith("$"),rowFixed:match[0].includes("$",1),};const offset={col:targetPosition.col-refPosition.col,row:targetPosition.row-refPosition.row,};const offsettedPosition={col:rangePart.colFixed?formulaPosition.col:formulaPosition.col+offset.col,row:rangePart.rowFixed?formulaPosition.row:formulaPosition.row+offset.row,};newFormula=newFormula.slice(0,match.index)+
toXC(offsettedPosition.col,offsettedPosition.row,rangePart)+
newFormula.slice(match.index+match[0].length);}}while(match);return newFormula;}
function convertSheets(data,warningManager){return data.sheets.map((sheet)=>{convertFormulasContent(sheet,data);const sheetDims=getSheetDims(sheet);const sheetOptions=sheet.sheetViews[0];return{id:sheet.sheetName,areGridLinesVisible:sheetOptions?sheetOptions.showGridLines:true,name:sheet.sheetName,colNumber:sheetDims[0],rowNumber:sheetDims[1],cells:convertCells(sheet,data,sheetDims,warningManager),merges:sheet.merges,cols:convertCols(sheet,sheetDims[0]),rows:convertRows(sheet,sheetDims[1]),conditionalFormats:convertConditionalFormats(sheet.cfs,data.dxfs,warningManager),figures:convertFigures(sheet),isVisible:sheet.isVisible,panes:sheetOptions?{xSplit:sheetOptions.pane.xSplit,ySplit:sheetOptions.pane.ySplit}:{xSplit:0,ySplit:0},filterTables:[],};});}
function convertCols(sheet,numberOfCols){const cols={};for(let i=1;i<numberOfCols+1;i++){const col=sheet.cols.find((col)=>col.min<=i&&i<=col.max);let colSize;if(col&&col.width)
colSize=col.width;else if(sheet.sheetFormat?.defaultColWidth)
colSize=sheet.sheetFormat.defaultColWidth;else
colSize=EXCEL_DEFAULT_COL_WIDTH;cols[i-1]={size:convertWidthFromExcel(colSize),isHidden:col?.hidden};}
return cols;}
function convertRows(sheet,numberOfRows){const rows={};for(let i=1;i<numberOfRows+1;i++){const row=sheet.rows.find((row)=>row.index===i);let rowSize;if(row&&row.height)
rowSize=row.height;else if(sheet.sheetFormat?.defaultRowHeight)
rowSize=sheet.sheetFormat.defaultRowHeight;else
rowSize=EXCEL_DEFAULT_ROW_HEIGHT;rows[i-1]={size:convertHeightFromExcel(rowSize),isHidden:row?.hidden};}
return rows;}
function convertSharedStrings(xlsxSharedStrings){return xlsxSharedStrings.map((str)=>str.replace(/\n/g,""));}
function convertCells(sheet,data,sheetDims,warningManager){const cells={};const sharedStrings=convertSharedStrings(data.sharedStrings);const hyperlinkMap=sheet.hyperlinks.reduce((map,link)=>{map[link.xc]=link;return map;},{});for(let row of sheet.rows){for(let cell of row.cells){cells[cell.xc]={content:getCellValue(cell,hyperlinkMap,sharedStrings,warningManager),style:cell.styleIndex?cell.styleIndex+1:undefined,border:cell.styleIndex?data.styles[cell.styleIndex].borderId+1:undefined,format:cell.styleIndex?data.styles[cell.styleIndex].numFmtId+1:undefined,};}}
for(let row of sheet.rows.filter((row)=>row.styleIndex)){for(let colIndex=1;colIndex<=sheetDims[0];colIndex++){const xc=toXC(colIndex-1,row.index-1);let cell=cells[xc];if(!cell){cell={};cells[xc]=cell;}
cell.style=cell.style?cell.style:row.styleIndex+1;cell.border=cell.border?cell.border:data.styles[row.styleIndex].borderId+1;cell.format=cell.format?cell.format:data.styles[row.styleIndex].numFmtId+1;}}
for(let col of sheet.cols.filter((col)=>col.styleIndex)){for(let colIndex=col.min;colIndex<=Math.min(col.max,sheetDims[0]);colIndex++){for(let rowIndex=1;rowIndex<=sheetDims[1];rowIndex++){const xc=toXC(colIndex-1,rowIndex-1);let cell=cells[xc];if(!cell){cell={};cells[xc]=cell;}
cell.style=cell.style?cell.style:col.styleIndex+1;cell.border=cell.border?cell.border:data.styles[col.styleIndex].borderId+1;cell.format=cell.format?cell.format:data.styles[col.styleIndex].numFmtId+1;}}}
return cells;}
function getCellValue(cell,hyperLinksMap,sharedStrings,warningManager){let cellValue;switch(cell.type){case"sharedString":const ssIndex=parseInt(cell.value,10);cellValue=sharedStrings[ssIndex];break;case"boolean":cellValue=Number(cell.value)?"TRUE":"FALSE";break;case"date":case"error":case"inlineStr":case"number":case"str":cellValue=cell.value;break;}
if(cellValue&&hyperLinksMap[cell.xc]){cellValue=convertHyperlink(hyperLinksMap[cell.xc],cellValue,warningManager);}
if(cell.formula){cellValue=cell.formula.content;}
return cellValue;}
function convertHyperlink(link,cellValue,warningManager){const label=link.display||cellValue;if(!link.relTarget&&!link.location){warningManager.generateNotSupportedWarning(WarningTypes.BadlyFormattedHyperlink);}
const url=link.relTarget?link.relTarget:buildSheetLink(splitReference(link.location).sheetName);return markdownLink(label,url);}
function getSheetDims(sheet){const dims=[0,0];for(let row of sheet.rows){dims[0]=Math.max(dims[0],largeMax(row.cells.map((cell)=>toCartesian(cell.xc).col)));dims[1]=Math.max(dims[1],row.index);}
dims[0]=Math.max(dims[0],EXCEL_IMPORT_DEFAULT_NUMBER_OF_COLS);dims[1]=Math.max(dims[1],EXCEL_IMPORT_DEFAULT_NUMBER_OF_ROWS);return dims;}
const TABLE_HEADER_STYLE={fillColor:"#000000",textColor:"#ffffff",bold:true,};const TABLE_HIGHLIGHTED_CELL_STYLE={bold:true,};const TABLE_BORDER_STYLE={style:"thin",color:"#000000FF"};function convertTables(convertedData,xlsxData){for(const xlsxSheet of xlsxData.sheets){for(const table of xlsxSheet.tables){const sheet=convertedData.sheets.find((sheet)=>sheet.name===xlsxSheet.sheetName);if(!sheet||!table.autoFilter)
continue;if(!sheet.filterTables)
sheet.filterTables=[];sheet.filterTables.push({range:table.ref});}}
applyTableStyle(convertedData,xlsxData);convertTableFormulaReferences(convertedData.sheets,xlsxData.sheets);}
function applyTableStyle(convertedData,xlsxData){const styles=objectToArray(convertedData.styles);const borders=objectToArray(convertedData.borders);for(let xlsxSheet of xlsxData.sheets){for(let table of xlsxSheet.tables){const sheet=convertedData.sheets.find((sheet)=>sheet.name===xlsxSheet.sheetName);if(!sheet)
continue;const tableZone=toZone(table.ref);for(let i=0;i<table.headerRowCount;i++){applyStyleToZone(TABLE_HEADER_STYLE,{...tableZone,bottom:tableZone.top+i},sheet.cells,styles);}
for(let i=0;i<table.totalsRowCount;i++){applyStyleToZone(TABLE_HIGHLIGHTED_CELL_STYLE,{...tableZone,top:tableZone.bottom-i},sheet.cells,styles);}
if(table.style?.showFirstColumn){applyStyleToZone(TABLE_HIGHLIGHTED_CELL_STYLE,{...tableZone,right:tableZone.left},sheet.cells,styles);}
if(table.style?.showLastColumn){applyStyleToZone(TABLE_HIGHLIGHTED_CELL_STYLE,{...tableZone,left:tableZone.right},sheet.cells,styles);}
for(let col=tableZone.left;col<=tableZone.right;col++){for(let row=tableZone.top;row<=tableZone.bottom;row++){const xc=toXC(col,row);const cell=sheet.cells[xc];const border={left:col===tableZone.left||table.style?.showColumnStripes?TABLE_BORDER_STYLE:undefined,right:col===tableZone.right?TABLE_BORDER_STYLE:undefined,top:row===tableZone.top||table.style?.showRowStripes||row>tableZone.bottom-table.totalsRowCount?TABLE_BORDER_STYLE:undefined,bottom:row===tableZone.bottom?TABLE_BORDER_STYLE:undefined,};const newBorder=cell?.border?{...borders[cell.border],...border}:border;let borderIndex=borders.findIndex((border)=>deepEquals(border,newBorder));if(borderIndex===-1){borderIndex=borders.length;borders.push(newBorder);}
if(cell){cell.border=borderIndex;}
else{sheet.cells[xc]={border:borderIndex};}}}}}
convertedData.styles=arrayToObject(styles);convertedData.borders=arrayToObject(borders);}
function applyStyleToZone(appliedStyle,zone,cells,styles){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){const xc=toXC(col,row);const cell=cells[xc];const newStyle=cell?.style?{...styles[cell.style],...appliedStyle}:appliedStyle;let styleIndex=styles.findIndex((style)=>deepEquals(style,newStyle));if(styleIndex===-1){styleIndex=styles.length;styles.push(newStyle);}
if(cell){cell.style=styleIndex;}
else{cells[xc]={style:styleIndex};}}}}
function convertTableFormulaReferences(convertedSheets,xlsxSheets){for(let sheet of convertedSheets){const tables=xlsxSheets.find((s)=>s.sheetName===sheet.name).tables;for(let table of tables){const tabRef=table.name+"[";for(let position of positions(toZone(table.ref))){const xc=toXC(position.col,position.row);const cell=sheet.cells[xc];if(cell&&cell.content&&cell.content.startsWith("=")){let refIndex;while((refIndex=cell.content.indexOf(tabRef))!==-1){let reference=cell.content.slice(refIndex+tabRef.length);let endIndex=reference.indexOf("]");if(reference.startsWith(`[`)){endIndex=reference.indexOf("]",endIndex+1);endIndex=reference.indexOf("]",endIndex+1);}
reference=reference.slice(0,endIndex);const convertedRef=convertTableReference(reference,table,xc);cell.content=cell.content.slice(0,refIndex)+
convertedRef+
cell.content.slice(tabRef.length+refIndex+endIndex+1);}}}}}}
function convertTableReference(expr,table,cellXc){const refElements=expr.split(",");const tableZone=toZone(table.ref);const refZone={...tableZone};let isReferencedZoneValid=true;if(refElements.length===1){const colRelativeIndex=table.cols.findIndex((col)=>col.name===refElements[0]);refZone.left=refZone.right=colRelativeIndex+tableZone.left;if(table.headerRowCount){refZone.top+=table.headerRowCount;}
if(table.totalsRowCount){refZone.bottom-=1;}}
else{switch(refElements[0].slice(1,refElements[0].length-1)){case"#All":refZone.top=table.headerRowCount?tableZone.top+table.headerRowCount:tableZone.top;refZone.bottom=tableZone.bottom;break;case"#Data":refZone.top=table.headerRowCount?tableZone.top+table.headerRowCount:tableZone.top;refZone.bottom=table.totalsRowCount?tableZone.bottom+1:tableZone.bottom;break;case"#This Row":refZone.top=refZone.bottom=toCartesian(cellXc).row;break;case"#Headers":refZone.top=refZone.bottom=tableZone.top;if(!table.headerRowCount){isReferencedZoneValid=false;}
break;case"#Totals":refZone.top=refZone.bottom=tableZone.bottom;if(!table.totalsRowCount){isReferencedZoneValid=false;}
break;}
const colRef=refElements[1].slice(1,refElements[1].length-1);const colRelativeIndex=table.cols.findIndex((col)=>col.name===colRef);refZone.left=refZone.right=colRelativeIndex+tableZone.left;}
if(!isReferencedZoneValid){return INCORRECT_RANGE_STRING;}
return refZone.top!==refZone.bottom?zoneToXc(refZone):toXC(refZone.left,refZone.top);}
function createXMLFile(doc,path,contentType){return{content:new XMLSerializer().serializeToString(doc),path,contentType,};}
function xmlEscape(str){return(String(str).replace(/\&/g,"&amp;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,""));}
function formatAttributes(attrs){return new XMLString(attrs.map(([key,val])=>`${key}="${xmlEscape(val)}"`).join(" "));}
function parseXML(xmlString,mimeType="text/xml"){const document=new DOMParser().parseFromString(xmlString.toString(),mimeType);const parserError=document.querySelector("parsererror");if(parserError){const errorString=parserError.innerHTML;const lineNumber=parseInt(errorString.split(":")[0],10);const xmlStringArray=xmlString.toString().trim().split("\n");const xmlPreview=xmlStringArray.slice(Math.max(lineNumber-3,0),Math.min(lineNumber+2,xmlStringArray.length)).join("\n");throw new Error(`XML string could not be parsed: ${errorString}\n${xmlPreview}`);}
return document;}
function convertBorderDescr(descr){if(!descr){return undefined;}
return{style:descr.style,color:{rgb:descr.color},};}
function getDefaultXLSXStructure(data){const xlsxBorders=Object.values(data.borders).map((border)=>{return{left:convertBorderDescr(border.left),right:convertBorderDescr(border.right),bottom:convertBorderDescr(border.bottom),top:convertBorderDescr(border.top),};});const borders=[{},...xlsxBorders];return{relsFiles:[],sharedStrings:[],styles:[{fontId:0,fillId:0,numFmtId:0,borderId:0,alignment:{vertical:"bottom"},},],fonts:[{size:DEFAULT_FONT_SIZE,family:2,color:{rgb:"000000"},name:"Calibri",},],fills:[{reservedAttribute:"none"},{reservedAttribute:"gray125"}],borders,numFmts:[],dxfs:[],};}
function createOverride(partName,contentType){return escapeXml`
    <Override ContentType="${contentType}" PartName="${partName}" />
  `;}
function createDefaultXMLElement(extension,contentType){return escapeXml`
    <Default Extension="${extension}" ContentType="${contentType}" />
  `;}
function joinXmlNodes(xmlNodes){return new XMLString(xmlNodes.join("\n"));}
function escapeXml(strings,...expressions){let str=[strings[0]];for(let i=0;i<expressions.length;i++){const value=expressions[i]instanceof XMLString?expressions[i]:xmlEscape(expressions[i]);str.push(value+strings[i+1]);}
return new XMLString(concat(str));}
function removeTagEscapedNamespaces(tag){return tag.replace(/NAMESPACE.*NAMESPACE(.*)/,"$1");}
function escapeTagNamespaces(str){return str.replaceAll(/(<\/?)([a-zA-Z0-9]+):([a-zA-Z0-9]+)/g,"$1"+"NAMESPACE"+"$2"+"NAMESPACE"+"$3");}
function escapeQueryNameSpaces(query){return query.replaceAll(/([a-zA-Z0-9]+):([a-zA-Z0-9]+)/g,"NAMESPACE"+"$1"+"NAMESPACE"+"$2");}
class AttributeValue{value;constructor(value){this.value=value;}
asString(){return fixXlsxUnicode(String(this.value));}
asBool(){if(this.value==="true")
return true;if(this.value==="false")
return false;return Boolean(Number(this.value));}
asNum(){return Number(this.value);}}
class XlsxBaseExtractor{rootFile;xlsxFileStructure;warningManager;relationships;currentFile=undefined;constructor(rootFile,xlsxStructure,warningManager){this.rootFile=rootFile;this.currentFile=rootFile.file.fileName;this.xlsxFileStructure=xlsxStructure;this.warningManager=warningManager;this.relationships={};if(rootFile.rels){this.extractRelationships(rootFile.rels).map((rel)=>{this.relationships[rel.id]=rel;});}}
extractRelationships(relFile){return this.mapOnElements({parent:relFile.xml,query:"Relationship"},(relationshipElement)=>{return{id:this.extractAttr(relationshipElement,"Id",{required:true}).asString(),target:this.extractAttr(relationshipElement,"Target",{required:true}).asString(),type:this.extractAttr(relationshipElement,"Type",{required:true}).asString(),};});}
getListOfXMLFiles(){const XMLFiles=Object.entries(this.xlsxFileStructure).filter(([key])=>key!=="images").map(([_,value])=>value).flat().filter(isDefined$1);return XMLFiles;}
mapOnElements(args,fct){const ret=[];const oldWorkingDocument=this.currentFile;let elements;if(args.children){const children=this.querySelector(args.parent,args.query)?.children;elements=children?children:[];}
else{elements=this.querySelectorAll(args.parent,args.query);}
if(elements){for(let element of elements){try{ret.push(fct(element));}
catch(e){this.catchErrorOnElement(e,element);}}}
this.currentFile=oldWorkingDocument;return ret;}
catchErrorOnElement(error,onElement){const errorMsg=onElement?`Error when parsing an element <${onElement.tagName}> of file ${this.currentFile}, skip this element. \n${error.stack}`:`Error when parsing file ${this.currentFile}.`;this.warningManager.addParsingWarning([errorMsg,error.message].join("\n"));}
extractAttr(e,attName,optionalArgs){const attribute=e.attributes[attName];if(!attribute)
this.handleMissingValue(e,`attribute "${attName}"`,optionalArgs);const value=attribute?.value?attribute.value:optionalArgs?.default;return(value===undefined?undefined:new AttributeValue(value));}
extractTextContent(element,optionalArgs){if(optionalArgs?.default!==undefined&&typeof optionalArgs.default!=="string"){throw new Error("extractTextContent default value should be a string");}
const shouldPreserveSpaces=element?.attributes["xml:space"]?.value==="preserve";let textContent=element?.textContent;if(!element||textContent===null){this.handleMissingValue(element,`text content`,optionalArgs);}
if(textContent){textContent=shouldPreserveSpaces?textContent:textContent.trim();}
return(textContent?fixXlsxUnicode(textContent):optionalArgs?.default);}
extractChildAttr(e,childRef,attName,optionalArgs){let child;if(typeof childRef==="number"){child=e.children[childRef];}
else{child=this.querySelector(e,childRef);}
if(!child){this.handleMissingValue(e,typeof childRef==="number"?`child at index ${childRef}`:`child <${childRef}>`,optionalArgs);}
const value=child?this.extractAttr(child,attName,optionalArgs)?.asString():optionalArgs?.default;return(value!==undefined?new AttributeValue(value):undefined);}
extractChildTextContent(e,childRef,optionalArgs){if(optionalArgs?.default!==undefined&&typeof optionalArgs.default!=="string"){throw new Error("extractTextContent default value should be a string");}
let child=this.querySelector(e,childRef);if(!child){this.handleMissingValue(e,`child <${childRef}>`,optionalArgs);}
return(child?this.extractTextContent(child,optionalArgs):optionalArgs?.default);}
handleMissingValue(parentElement,missingElementName,optionalArgs){if(optionalArgs?.required){if(optionalArgs?.default){this.warningManager.addParsingWarning(`Missing required ${missingElementName} in element <${parentElement.tagName}> of ${this.currentFile}, replacing it by the default value ${optionalArgs.default}`);}
else{throw new Error(`Missing required ${missingElementName} in element <${parentElement.tagName}> of ${this.currentFile}, and no default value was set`);}}}
extractColor(colorElement,theme,defaultColor){if(!colorElement){return defaultColor?{rgb:defaultColor}:undefined;}
const themeIndex=this.extractAttr(colorElement,"theme")?.asString();let rgb;if(themeIndex!==undefined){if(!theme||!theme.clrScheme){throw new Error("Color referencing a theme but no theme was provided");}
rgb=this.getThemeColor(themeIndex,theme.clrScheme);}
else{rgb=this.extractAttr(colorElement,"rgb")?.asString();}
const color={rgb,auto:this.extractAttr(colorElement,"auto")?.asBool(),indexed:this.extractAttr(colorElement,"indexed")?.asNum(),tint:this.extractAttr(colorElement,"tint")?.asNum(),};return color;}
getTargetXmlFile(relationship){if(!relationship)
throw new Error("Undefined target file");const target=this.processRelationshipTargetName(relationship.target);const f=this.getListOfXMLFiles().find((f)=>f.file.fileName.endsWith(target));if(!f||!f.file)
throw new Error("Cannot find target file");return f;}
getTargetImageFile(relationship){if(!relationship)
throw new Error("Undefined target file");const target=this.processRelationshipTargetName(relationship.target);const f=this.xlsxFileStructure.images.find((f)=>f.fileName.endsWith(target));if(!f)
throw new Error("Cannot find target file");return f;}
querySelector(element,query){const escapedQuery=escapeQueryNameSpaces(query);return element.querySelector(escapedQuery);}
querySelectorAll(element,query){const escapedQuery=escapeQueryNameSpaces(query);return element.querySelectorAll(escapedQuery);}
getThemeColor(colorId,clrScheme){switch(colorId){case"0":return"FFFFFF";case"1":return"000000";case"2":return clrScheme["3"].value;case"3":return clrScheme["2"].value;default:return clrScheme[colorId].value;}}
processRelationshipTargetName(targetName){return targetName.replace(/\.+\//,"");}}
class XlsxMiscExtractor extends XlsxBaseExtractor{getTheme(){const clrScheme=this.mapOnElements({query:"a:clrScheme",parent:this.rootFile.file.xml,children:true},(element)=>{return{name:element.tagName,value:this.extractChildAttr(element,0,"val",{required:true,default:AUTO_COLOR,}).asString(),lastClr:this.extractChildAttr(element,0,"lastClr",{default:AUTO_COLOR,}).asString(),};});return{clrScheme};}
getSharedStrings(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"si"},(ssElement)=>{if(ssElement.children[0].tagName==="t"){return this.extractTextContent(ssElement)||"";}
else{return this.mapOnElements({parent:ssElement,query:"t"},(textElement)=>{return this.extractTextContent(textElement)||"";}).join("");}});}}
class XlsxCfExtractor extends XlsxBaseExtractor{theme;constructor(sheetFile,xlsxStructure,warningManager,theme){super(sheetFile,xlsxStructure,warningManager);this.theme=theme;}
extractConditionalFormattings(){const cfs=this.mapOnElements({parent:this.rootFile.file.xml,query:"worksheet > conditionalFormatting"},(cfElement)=>{return{sqref:this.extractAttr(cfElement,"sqref",{required:true}).asString().split(" "),pivot:this.extractAttr(cfElement,"pivot")?.asBool(),cfRules:this.extractCFRules(cfElement,this.theme),};});cfs.push(...this.mapOnElements({parent:this.rootFile.file.xml,query:"extLst x14:conditionalFormatting"},(cfElement)=>{return{sqref:this.extractChildTextContent(cfElement,"xm:sqref",{required:true}).split(" "),pivot:this.extractAttr(cfElement,"xm:pivot")?.asBool(),cfRules:this.extractCFRules(cfElement,this.theme),};}));return cfs;}
extractCFRules(cfElement,theme){return this.mapOnElements({parent:cfElement,query:"cfRule, x14:cfRule"},(cfRuleElement)=>{const cfType=this.extractAttr(cfRuleElement,"type",{required:true,}).asString();if(cfType==="dataBar"){throw new Error("Databars conditional formats are not supported.");}
return{type:cfType,priority:this.extractAttr(cfRuleElement,"priority",{required:true}).asNum(),colorScale:this.extractCfColorScale(cfRuleElement,theme),formula:this.extractCfFormula(cfRuleElement),iconSet:this.extractCfIconSet(cfRuleElement),dxfId:this.extractAttr(cfRuleElement,"dxfId")?.asNum(),stopIfTrue:this.extractAttr(cfRuleElement,"stopIfTrue")?.asBool(),aboveAverage:this.extractAttr(cfRuleElement,"aboveAverage")?.asBool(),percent:this.extractAttr(cfRuleElement,"percent")?.asBool(),bottom:this.extractAttr(cfRuleElement,"bottom")?.asBool(),operator:this.extractAttr(cfRuleElement,"operator")?.asString(),text:this.extractAttr(cfRuleElement,"text")?.asString(),timePeriod:this.extractAttr(cfRuleElement,"timePeriod")?.asString(),rank:this.extractAttr(cfRuleElement,"rank")?.asNum(),stdDev:this.extractAttr(cfRuleElement,"stdDev")?.asNum(),equalAverage:this.extractAttr(cfRuleElement,"equalAverage")?.asBool(),};});}
extractCfFormula(cfRulesElement){return this.mapOnElements({parent:cfRulesElement,query:"formula"},(cfFormulaElements)=>{return this.extractTextContent(cfFormulaElements,{required:true});});}
extractCfColorScale(cfRulesElement,theme){const colorScaleElement=this.querySelector(cfRulesElement,"colorScale");if(!colorScaleElement)
return undefined;return{colors:this.mapOnElements({parent:colorScaleElement,query:"color"},(colorElement)=>{return this.extractColor(colorElement,theme,"ffffff");}),cfvos:this.extractCFVos(colorScaleElement),};}
extractCfIconSet(cfRulesElement){const iconSetElement=this.querySelector(cfRulesElement,"iconSet, x14:iconSet");if(!iconSetElement)
return undefined;return{iconSet:this.extractAttr(iconSetElement,"iconSet",{default:"3TrafficLights1",}).asString(),showValue:this.extractAttr(iconSetElement,"showValue",{default:true}).asBool(),percent:this.extractAttr(iconSetElement,"percent",{default:true}).asBool(),reverse:this.extractAttr(iconSetElement,"reverse")?.asBool(),custom:this.extractAttr(iconSetElement,"custom")?.asBool(),cfvos:this.extractCFVos(iconSetElement),cfIcons:this.extractCfIcons(iconSetElement),};}
extractCfIcons(iconSetElement){const icons=this.mapOnElements({parent:iconSetElement,query:"cfIcon, x14:cfIcon"},(cfIconElement)=>{return{iconSet:this.extractAttr(cfIconElement,"iconSet",{required:true,}).asString(),iconId:this.extractAttr(cfIconElement,"iconId",{required:true}).asNum(),};});return icons.length===0?undefined:icons;}
extractCFVos(parent){return this.mapOnElements({parent,query:"cfvo, x14:cfvo"},(cfVoElement)=>{return{type:this.extractAttr(cfVoElement,"type",{required:true,}).asString(),gte:this.extractAttr(cfVoElement,"gte",{default:true})?.asBool(),value:cfVoElement.attributes["val"]?this.extractAttr(cfVoElement,"val")?.asString():this.extractChildTextContent(cfVoElement,"f, xm:f"),};});}}
class XlsxChartExtractor extends XlsxBaseExtractor{extractChart(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"c:chartSpace"},(rootChartElement)=>{const chartType=this.getChartType(rootChartElement);if(!CHART_TYPE_CONVERSION_MAP[chartType]){throw new Error(`Unsupported chart type ${chartType}`);}
const chartTitle=this.mapOnElements({parent:rootChartElement,query:"c:title a:t"},(textElement)=>{return textElement.textContent||"";}).join("");const barChartGrouping=this.extractChildAttr(rootChartElement,"c:grouping","val",{default:"clustered",}).asString();return{title:chartTitle,type:CHART_TYPE_CONVERSION_MAP[chartType],dataSets:this.extractChartDatasets(this.querySelector(rootChartElement,`c:${chartType}`)),labelRange:this.extractChildTextContent(rootChartElement,"c:ser c:cat c:f"),backgroundColor:this.extractChildAttr(rootChartElement,"c:chartSpace > c:spPr a:srgbClr","val",{default:"ffffff",}).asString(),verticalAxisPosition:this.extractChildAttr(rootChartElement,"c:valAx > c:axPos","val",{default:"l",}).asString()==="r"?"right":"left",legendPosition:DRAWING_LEGEND_POSITION_CONVERSION_MAP[this.extractChildAttr(rootChartElement,"c:legendPos","val",{default:"b",}).asString()],stacked:barChartGrouping==="stacked",fontColor:"000000",};})[0];}
extractChartDatasets(chartElement){return this.mapOnElements({parent:chartElement,query:"c:ser"},(chartDataElement)=>{return{label:this.extractChildTextContent(chartDataElement,"c:tx c:f"),range:this.extractChildTextContent(chartDataElement,"c:val c:f",{required:true}),};});}
getChartType(chartElement){const plotAreaElement=this.querySelector(chartElement,"c:plotArea");if(!plotAreaElement){throw new Error("Missing plot area in the chart definition.");}
for(let child of plotAreaElement.children){const tag=removeTagEscapedNamespaces(child.tagName);if(XLSX_CHART_TYPES.some((chartType)=>chartType===tag)){return tag;}}
throw new Error("Unknown chart type");}}
class XlsxFigureExtractor extends XlsxBaseExtractor{extractFigures(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"xdr:wsDr",children:true},(figureElement)=>{const anchorType=removeTagEscapedNamespaces(figureElement.tagName);if(anchorType!=="twoCellAnchor"){throw new Error("Only twoCellAnchor are supported for xlsx drawings.");}
const chartElement=this.querySelector(figureElement,"c:chart");const imageElement=this.querySelector(figureElement,"a:blip");if(!chartElement&&!imageElement){throw new Error("Only chart and image figures are currently supported.");}
return{anchors:[this.extractFigureAnchor("xdr:from",figureElement),this.extractFigureAnchor("xdr:to",figureElement),],data:chartElement?this.extractChart(chartElement):this.extractImage(figureElement),};});}
extractFigureAnchor(anchorTag,figureElement){const anchor=this.querySelector(figureElement,anchorTag);if(!anchor){throw new Error(`Missing anchor element ${anchorTag}`);}
return{col:Number(this.extractChildTextContent(anchor,"xdr:col",{required:true})),colOffset:Number(this.extractChildTextContent(anchor,"xdr:colOff",{required:true})),row:Number(this.extractChildTextContent(anchor,"xdr:row",{required:true})),rowOffset:Number(this.extractChildTextContent(anchor,"xdr:rowOff",{required:true})),};}
extractChart(chartElement){const chartId=this.extractAttr(chartElement,"r:id",{required:true}).asString();const chartFile=this.getTargetXmlFile(this.relationships[chartId]);const chartDefinition=new XlsxChartExtractor(chartFile,this.xlsxFileStructure,this.warningManager).extractChart();if(!chartDefinition){throw new Error("Unable to extract chart definition");}
return chartDefinition;}
extractImage(figureElement){const imageElement=this.querySelector(figureElement,"a:blip");const imageId=this.extractAttr(imageElement,"r:embed",{required:true}).asString();const image=this.getTargetImageFile(this.relationships[imageId]);if(!image){throw new Error("Unable to extract image");}
const shapePropertyElement=this.querySelector(figureElement,"a:xfrm");const extension=image.fileName.split(".").at(-1);return{imageSrc:image.imageSrc,mimetype:extension?IMAGE_EXTENSION_TO_MIMETYPE_MAPPING[extension]:undefined,size:{cx:this.extractChildAttr(shapePropertyElement,"a:ext","cx",{required:true}).asNum(),cy:this.extractChildAttr(shapePropertyElement,"a:ext","cy",{required:true}).asNum(),},};}}
class XlsxPivotExtractor extends XlsxBaseExtractor{getPivotTable(){return this.mapOnElements({query:":root",parent:this.rootFile.file.xml},(pivotElement)=>{return{displayName:this.extractAttr(pivotElement,"name",{required:true}).asString(),id:this.extractAttr(pivotElement,"name",{required:true}).asString(),ref:this.extractChildAttr(pivotElement,"location","ref",{required:true,}).asString(),headerRowCount:this.extractChildAttr(pivotElement,"location","firstDataRow",{default:0,}).asNum(),totalsRowCount:1,cols:[],style:{showFirstColumn:true,showRowStripes:true,},};})[0];}}
class XlsxTableExtractor extends XlsxBaseExtractor{getTable(){return this.mapOnElements({query:"table",parent:this.rootFile.file.xml},(tableElement)=>{return{displayName:this.extractAttr(tableElement,"displayName",{required:true,}).asString(),name:this.extractAttr(tableElement,"name")?.asString(),id:this.extractAttr(tableElement,"id",{required:true}).asString(),ref:this.extractAttr(tableElement,"ref",{required:true}).asString(),headerRowCount:this.extractAttr(tableElement,"headerRowCount",{default:1,}).asNum(),totalsRowCount:this.extractAttr(tableElement,"totalsRowCount",{default:0,}).asNum(),cols:this.extractTableCols(tableElement),style:this.extractTableStyleInfo(tableElement),autoFilter:this.extractTableAutoFilter(tableElement),};})[0];}
extractTableCols(tableElement){return this.mapOnElements({query:"tableColumn",parent:tableElement},(tableColElement)=>{return{id:this.extractAttr(tableColElement,"id",{required:true}).asString(),name:this.extractAttr(tableColElement,"name",{required:true}).asString(),colFormula:this.extractChildTextContent(tableColElement,"calculatedColumnFormula"),};});}
extractTableStyleInfo(tableElement){return this.mapOnElements({query:"tableStyleInfo",parent:tableElement},(tableStyleElement)=>{return{name:this.extractAttr(tableStyleElement,"name")?.asString(),showFirstColumn:this.extractAttr(tableStyleElement,"showFirstColumn")?.asBool(),showLastColumn:this.extractAttr(tableStyleElement,"showLastColumn")?.asBool(),showRowStripes:this.extractAttr(tableStyleElement,"showRowStripes")?.asBool(),showColumnStripes:this.extractAttr(tableStyleElement,"showColumnStripes")?.asBool(),};})[0];}
extractTableAutoFilter(tableElement){return this.mapOnElements({query:"autoFilter",parent:tableElement},(autoFilterElement)=>{return{columns:this.extractFilterColumns(autoFilterElement),zone:this.extractAttr(autoFilterElement,"ref",{required:true}).asString(),};})[0];}
extractFilterColumns(autoFilterElement){return this.mapOnElements({query:"tableColumn",parent:autoFilterElement},(filterColumnElement)=>{return{colId:this.extractAttr(autoFilterElement,"colId",{required:true}).asNum(),hiddenButton:this.extractAttr(autoFilterElement,"hiddenButton",{default:false,}).asBool(),filters:this.extractSimpleFilter(filterColumnElement),};});}
extractSimpleFilter(filterColumnElement){return this.mapOnElements({query:"filter",parent:filterColumnElement},(filterColumnElement)=>{return{val:this.extractAttr(filterColumnElement,"val",{required:true}).asString(),};});}}
class XlsxSheetExtractor extends XlsxBaseExtractor{theme;constructor(sheetFile,xlsxStructure,warningManager,theme){super(sheetFile,xlsxStructure,warningManager);this.theme=theme;}
getSheet(){return this.mapOnElements({query:"worksheet",parent:this.rootFile.file.xml},(sheetElement)=>{const sheetWorkbookInfo=this.getSheetWorkbookInfo();return{sheetName:this.extractSheetName(),sheetViews:this.extractSheetViews(sheetElement),sheetFormat:this.extractSheetFormat(sheetElement),cols:this.extractCols(sheetElement),rows:this.extractRows(sheetElement),sharedFormulas:this.extractSharedFormulas(sheetElement),merges:this.extractMerges(sheetElement),cfs:this.extractConditionalFormats(),figures:this.extractFigures(sheetElement),hyperlinks:this.extractHyperLinks(sheetElement),tables:[...this.extractTables(sheetElement),...this.extractPivotTables()],isVisible:sheetWorkbookInfo.state==="visible"?true:false,};})[0];}
extractSheetViews(worksheet){return this.mapOnElements({parent:worksheet,query:"sheetView"},(sheetViewElement)=>{const paneElement=this.querySelector(sheetViewElement,"pane");return{tabSelected:this.extractAttr(sheetViewElement,"tabSelected",{default:false,}).asBool(),showFormulas:this.extractAttr(sheetViewElement,"showFormulas",{default:false,}).asBool(),showGridLines:this.extractAttr(sheetViewElement,"showGridLines",{default:true,}).asBool(),showRowColHeaders:this.extractAttr(sheetViewElement,"showRowColHeaders",{default:true,}).asBool(),pane:{xSplit:paneElement?this.extractAttr(paneElement,"xSplit",{default:0}).asNum():0,ySplit:paneElement?this.extractAttr(paneElement,"ySplit",{default:0}).asNum():0,},};});}
extractSheetName(){const relativePath=getRelativePath(this.xlsxFileStructure.workbook.file.fileName,this.rootFile.file.fileName);const workbookRels=this.extractRelationships(this.xlsxFileStructure.workbook.rels);const relId=workbookRels.find((rel)=>rel.target===relativePath).id;for(let sheetElement of this.querySelectorAll(this.xlsxFileStructure.workbook.file.xml,"sheet")){if(sheetElement.attributes["r:id"].value===relId){return sheetElement.attributes["name"].value;}}
throw new Error("Missing sheet name");}
getSheetWorkbookInfo(){const relativePath=getRelativePath(this.xlsxFileStructure.workbook.file.fileName,this.rootFile.file.fileName);const workbookRels=this.extractRelationships(this.xlsxFileStructure.workbook.rels);const relId=workbookRels.find((rel)=>rel.target===relativePath).id;const workbookSheets=this.mapOnElements({parent:this.xlsxFileStructure.workbook.file.xml,query:"sheet"},(sheetElement)=>{return{relationshipId:this.extractAttr(sheetElement,"r:id",{required:true}).asString(),sheetId:this.extractAttr(sheetElement,"sheetId",{required:true}).asString(),sheetName:this.extractAttr(sheetElement,"name",{required:true}).asString(),state:this.extractAttr(sheetElement,"state",{default:"visible",}).asString(),};});const info=workbookSheets.find((info)=>info.relationshipId===relId);if(!info){throw new Error("Cannot find corresponding workbook sheet");}
return info;}
extractConditionalFormats(){return new XlsxCfExtractor(this.rootFile,this.xlsxFileStructure,this.warningManager,this.theme).extractConditionalFormattings();}
extractFigures(worksheet){const figures=this.mapOnElements({parent:worksheet,query:"drawing"},(drawingElement)=>{const drawingId=this.extractAttr(drawingElement,"r:id",{required:true})?.asString();const drawingFile=this.getTargetXmlFile(this.relationships[drawingId]);const figures=new XlsxFigureExtractor(drawingFile,this.xlsxFileStructure,this.warningManager).extractFigures();return figures;})[0];return figures||[];}
extractTables(worksheet){return this.mapOnElements({query:"tablePart",parent:worksheet},(tablePartElement)=>{const tableId=this.extractAttr(tablePartElement,"r:id",{required:true})?.asString();const tableFile=this.getTargetXmlFile(this.relationships[tableId]);const tableExtractor=new XlsxTableExtractor(tableFile,this.xlsxFileStructure,this.warningManager);return tableExtractor.getTable();});}
extractPivotTables(){try{return Object.values(this.relationships).filter((relationship)=>relationship.type.endsWith("pivotTable")).map((pivotRelationship)=>{const pivotFile=this.getTargetXmlFile(pivotRelationship);const pivot=new XlsxPivotExtractor(pivotFile,this.xlsxFileStructure,this.warningManager).getPivotTable();return pivot;});}
catch(e){this.catchErrorOnElement(e);return[];}}
extractMerges(worksheet){return this.mapOnElements({parent:worksheet,query:"mergeCell"},(mergeElement)=>{return this.extractAttr(mergeElement,"ref",{required:true}).asString();});}
extractSheetFormat(worksheet){const formatElement=this.querySelector(worksheet,"sheetFormatPr");if(!formatElement)
return undefined;return{defaultColWidth:this.extractAttr(formatElement,"defaultColWidth",{default:EXCEL_DEFAULT_COL_WIDTH.toString(),}).asNum(),defaultRowHeight:this.extractAttr(formatElement,"defaultRowHeight",{default:EXCEL_DEFAULT_ROW_HEIGHT.toString(),}).asNum(),};}
extractCols(worksheet){return this.mapOnElements({parent:worksheet,query:"cols col"},(colElement)=>{return{width:this.extractAttr(colElement,"width")?.asNum(),customWidth:this.extractAttr(colElement,"customWidth")?.asBool(),bestFit:this.extractAttr(colElement,"bestFit")?.asBool(),hidden:this.extractAttr(colElement,"hidden")?.asBool(),min:this.extractAttr(colElement,"min",{required:true})?.asNum(),max:this.extractAttr(colElement,"max",{required:true})?.asNum(),styleIndex:this.extractAttr(colElement,"style")?.asNum(),};});}
extractRows(worksheet){return this.mapOnElements({parent:worksheet,query:"sheetData row"},(rowElement)=>{return{index:this.extractAttr(rowElement,"r",{required:true})?.asNum(),cells:this.extractCells(rowElement),height:this.extractAttr(rowElement,"ht")?.asNum(),customHeight:this.extractAttr(rowElement,"customHeight")?.asBool(),hidden:this.extractAttr(rowElement,"hidden")?.asBool(),styleIndex:this.extractAttr(rowElement,"s")?.asNum(),};});}
extractCells(row){return this.mapOnElements({parent:row,query:"c"},(cellElement)=>{return{xc:this.extractAttr(cellElement,"r",{required:true})?.asString(),styleIndex:this.extractAttr(cellElement,"s")?.asNum(),type:CELL_TYPE_CONVERSION_MAP[this.extractAttr(cellElement,"t",{default:"n"})?.asString()],value:this.extractChildTextContent(cellElement,"v"),formula:this.extractCellFormula(cellElement),};});}
extractCellFormula(cellElement){const formulaElement=this.querySelector(cellElement,"f");if(!formulaElement)
return undefined;return{content:this.extractTextContent(formulaElement),sharedIndex:this.extractAttr(formulaElement,"si")?.asNum(),ref:this.extractAttr(formulaElement,"ref")?.asString(),};}
extractHyperLinks(worksheet){return this.mapOnElements({parent:worksheet,query:"hyperlink"},(linkElement)=>{const relId=this.extractAttr(linkElement,"r:id")?.asString();return{xc:this.extractAttr(linkElement,"ref",{required:true})?.asString(),location:this.extractAttr(linkElement,"location")?.asString(),display:this.extractAttr(linkElement,"display")?.asString(),relTarget:relId?this.relationships[relId].target:undefined,};});}
extractSharedFormulas(worksheet){const sfElements=this.querySelectorAll(worksheet,`f[si][ref]`);const sfMap={};for(let sfElement of sfElements){const index=this.extractAttr(sfElement,"si",{required:true}).asNum();const formula=this.extractTextContent(sfElement,{required:true});sfMap[index]=formula;}
const sfs=[];for(let i=0;i<Object.keys(sfMap).length;i++){if(!sfMap[i]){this.warningManager.addParsingWarning(`Missing shared formula ${i}, replacing it by empty formula`);sfs.push("");}
else{sfs.push(sfMap[i]);}}
return sfs;}}
class XlsxStyleExtractor extends XlsxBaseExtractor{theme;constructor(xlsxStructure,warningManager,theme){super(xlsxStructure.styles,xlsxStructure,warningManager);this.theme=theme;}
getNumFormats(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"numFmt"},(numFmtElement)=>{return this.extractNumFormats(numFmtElement);});}
extractNumFormats(numFmtElement){return{id:this.extractAttr(numFmtElement,"numFmtId",{required:true,}).asNum(),format:this.extractAttr(numFmtElement,"formatCode",{required:true,default:"",}).asString(),};}
getFonts(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"font"},(font)=>{return this.extractFont(font);});}
extractFont(fontElement){const name=this.extractChildAttr(fontElement,"name","val",{default:"Arial",}).asString();const size=this.extractChildAttr(fontElement,"sz","val",{default:DEFAULT_FONT_SIZE.toString(),}).asNum();const color=this.extractColor(this.querySelector(fontElement,`color`),this.theme);const italicElement=this.querySelector(fontElement,`i`)||undefined;const italic=italicElement&&italicElement.attributes["val"]?.value!=="0";const boldElement=this.querySelector(fontElement,`b`)||undefined;const bold=boldElement&&boldElement.attributes["val"]?.value!=="0";const strikeElement=this.querySelector(fontElement,`strike`)||undefined;const strike=strikeElement&&strikeElement.attributes["val"]?.value!=="0";const underlineElement=this.querySelector(fontElement,`u`)||undefined;const underline=underlineElement&&underlineElement.attributes["val"]?.value!=="none";return{name,size,color,italic,bold,underline,strike};}
getFills(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"fill"},(fillElement)=>{return this.extractFill(fillElement);});}
extractFill(fillElement){const fillChild=fillElement.children[0];if(fillChild.tagName==="patternFill"){return{patternType:fillChild.attributes["patternType"]?.value,bgColor:this.extractColor(this.querySelector(fillChild,"bgColor"),this.theme),fgColor:this.extractColor(this.querySelector(fillChild,"fgColor"),this.theme),};}
else{return{patternType:"solid",fgColor:this.extractColor(this.querySelectorAll(fillChild,"color")[1],this.theme),};}}
getBorders(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"border"},(borderElement)=>{return this.extractBorder(borderElement);});}
extractBorder(borderElement){const border={left:this.extractSingleBorder(borderElement,"left",this.theme),right:this.extractSingleBorder(borderElement,"right",this.theme),top:this.extractSingleBorder(borderElement,"top",this.theme),bottom:this.extractSingleBorder(borderElement,"bottom",this.theme),diagonal:this.extractSingleBorder(borderElement,"diagonal",this.theme),};if(border.diagonal){border.diagonalUp=this.extractAttr(borderElement,"diagonalUp")?.asBool();border.diagonalDown=this.extractAttr(borderElement,"diagonalDown")?.asBool();}
return border;}
extractSingleBorder(borderElement,direction,theme){const directionElement=this.querySelector(borderElement,direction);if(!directionElement||!directionElement.attributes["style"])
return undefined;return{style:this.extractAttr(directionElement,"style",{required:true,default:"thin",}).asString(),color:this.extractColor(directionElement.children[0],theme,"000000"),};}
extractAlignment(alignmentElement){return{horizontal:this.extractAttr(alignmentElement,"horizontal",{default:"general",}).asString(),vertical:this.extractAttr(alignmentElement,"vertical",{default:"bottom",}).asString(),textRotation:this.extractAttr(alignmentElement,"textRotation")?.asNum(),wrapText:this.extractAttr(alignmentElement,"wrapText")?.asBool(),indent:this.extractAttr(alignmentElement,"indent")?.asNum(),relativeIndent:this.extractAttr(alignmentElement,"relativeIndent")?.asNum(),justifyLastLine:this.extractAttr(alignmentElement,"justifyLastLine")?.asBool(),shrinkToFit:this.extractAttr(alignmentElement,"shrinkToFit")?.asBool(),readingOrder:this.extractAttr(alignmentElement,"readingOrder")?.asNum(),};}
getDxfs(){return this.mapOnElements({query:"dxf",parent:this.rootFile.file.xml},(dxfElement)=>{const fontElement=this.querySelector(dxfElement,"font");const fillElement=this.querySelector(dxfElement,"fill");const borderElement=this.querySelector(dxfElement,"border");const numFmtElement=this.querySelector(dxfElement,"numFmt");const alignmentElement=this.querySelector(dxfElement,"alignment");return{font:fontElement?this.extractFont(fontElement):undefined,fill:fillElement?this.extractFill(fillElement):undefined,numFmt:numFmtElement?this.extractNumFormats(numFmtElement):undefined,alignment:alignmentElement?this.extractAlignment(alignmentElement):undefined,border:borderElement?this.extractBorder(borderElement):undefined,};});}
getStyles(){return this.mapOnElements({query:"cellXfs xf",parent:this.rootFile.file.xml},(styleElement)=>{const alignmentElement=this.querySelector(styleElement,"alignment");return{fontId:this.extractAttr(styleElement,"fontId",{required:true,default:0,}).asNum(),fillId:this.extractAttr(styleElement,"fillId",{required:true,default:0,}).asNum(),borderId:this.extractAttr(styleElement,"borderId",{required:true,default:0,}).asNum(),numFmtId:this.extractAttr(styleElement,"numFmtId",{required:true,default:0,}).asNum(),alignment:alignmentElement?this.extractAlignment(alignmentElement):undefined,};});}}
class XlsxExternalBookExtractor extends XlsxBaseExtractor{getExternalBook(){return this.mapOnElements({parent:this.rootFile.file.xml,query:"externalBook"},(bookElement)=>{return{rId:this.extractAttr(bookElement,"r:id",{required:true}).asString(),sheetNames:this.mapOnElements({parent:bookElement,query:"sheetName"},(sheetNameElement)=>{return this.extractAttr(sheetNameElement,"val",{required:true}).asString();}),datasets:this.extractExternalSheetData(bookElement),};})[0];}
extractExternalSheetData(externalBookElement){return this.mapOnElements({parent:externalBookElement,query:"sheetData"},(sheetDataElement)=>{const cellsData=this.mapOnElements({parent:sheetDataElement,query:"cell"},(cellElement)=>{return{xc:this.extractAttr(cellElement,"r",{required:true}).asString(),value:this.extractChildTextContent(cellElement,"v",{required:true}),};});const dataMap={};for(let cell of cellsData){dataMap[cell.xc]=cell.value;}
return{sheetId:this.extractAttr(sheetDataElement,"sheetId",{required:true}).asNum(),data:dataMap,};});}}
function getXLSXFilesOfType(contentType,xmls){const paths=getPathsOfContent(contentType,xmls);return getXlsxFile(paths,xmls);}
function getXlsxFile(files,xmls){const ret=[];for(let file of files){const rels=getRelationFile(file,xmls);ret.push({file:{fileName:file,xml:xmls[file]},rels:rels?{fileName:rels,xml:xmls[rels]}:undefined,});}
return ret;}
function getPathsOfContent(contentType,xmls){const xml=xmls[CONTENT_TYPES_FILE];const sheetItems=xml.querySelectorAll(`Override[ContentType="${contentType}"]`);const paths=[];for(let item of sheetItems){const file=item?.attributes["PartName"].value;paths.push(file.substring(1));}
return paths;}
function getRelationFile(file,xmls){if(file===CONTENT_TYPES_FILE){return"_rels/.rels";}
let relsFile="";const pathParts=file.split("/");for(let i=0;i<pathParts.length-1;i++){relsFile+=pathParts[i]+"/";}
relsFile+="_rels/";relsFile+=pathParts[pathParts.length-1]+".rels";if(!xmls[relsFile]){relsFile=undefined;}
return relsFile;}
const EXCEL_IMPORT_VERSION=12;class XlsxReader{warningManager;xmls;images;constructor(files){this.warningManager=new XLSXImportWarningManager();this.xmls={};this.images=[];for(let key of Object.keys(files)){if(key.endsWith(".xml")||key.endsWith(".rels")){const contentString=escapeTagNamespaces(files[key]);this.xmls[key]=parseXML(new XMLString(contentString));}
else if(key.includes("media/image")){this.images.push({fileName:key,imageSrc:files[key]["imageSrc"],});}}}
convertXlsx(){const xlsxData=this.getXlsxData();const convertedData=this.convertImportedData(xlsxData);return convertedData;}
getXlsxData(){const xlsxFileStructure=this.buildXlsxFileStructure();const theme=xlsxFileStructure.theme?new XlsxMiscExtractor(xlsxFileStructure.theme,xlsxFileStructure,this.warningManager).getTheme():undefined;const sharedStrings=xlsxFileStructure.sharedStrings?new XlsxMiscExtractor(xlsxFileStructure.sharedStrings,xlsxFileStructure,this.warningManager).getSharedStrings():[];const sheets=xlsxFileStructure.sheets.sort((a,b)=>a.file.fileName.localeCompare(b.file.fileName,undefined,{numeric:true})).map((sheetFile)=>{return new XlsxSheetExtractor(sheetFile,xlsxFileStructure,this.warningManager,theme).getSheet();});const externalBooks=xlsxFileStructure.externalLinks.map((externalLinkFile)=>{return new XlsxExternalBookExtractor(externalLinkFile,xlsxFileStructure,this.warningManager).getExternalBook();});const styleExtractor=new XlsxStyleExtractor(xlsxFileStructure,this.warningManager,theme);return{fonts:styleExtractor.getFonts(),fills:styleExtractor.getFills(),borders:styleExtractor.getBorders(),dxfs:styleExtractor.getDxfs(),numFmts:styleExtractor.getNumFormats(),styles:styleExtractor.getStyles(),sheets:sheets,sharedStrings,externalBooks,};}
buildXlsxFileStructure(){const xlsxFileStructure={sheets:getXLSXFilesOfType(CONTENT_TYPES.sheet,this.xmls),workbook:getXLSXFilesOfType(CONTENT_TYPES.workbook,this.xmls)[0],styles:getXLSXFilesOfType(CONTENT_TYPES.styles,this.xmls)[0],sharedStrings:getXLSXFilesOfType(CONTENT_TYPES.sharedStrings,this.xmls)[0],theme:getXLSXFilesOfType(CONTENT_TYPES.themes,this.xmls)[0],charts:getXLSXFilesOfType(CONTENT_TYPES.chart,this.xmls),figures:getXLSXFilesOfType(CONTENT_TYPES.drawing,this.xmls),tables:getXLSXFilesOfType(CONTENT_TYPES.table,this.xmls),pivots:getXLSXFilesOfType(CONTENT_TYPES.pivot,this.xmls),externalLinks:getXLSXFilesOfType(CONTENT_TYPES.externalLink,this.xmls),images:this.images,};if(!xlsxFileStructure.workbook.rels){throw Error(_t("Cannot find workbook relations file"));}
return xlsxFileStructure;}
convertImportedData(data){const convertedData={version:EXCEL_IMPORT_VERSION,sheets:convertSheets(data,this.warningManager),styles:convertStyles(data,this.warningManager),formats:convertFormats(data,this.warningManager),borders:convertBorders(data,this.warningManager),entities:{},revisionId:DEFAULT_REVISION_ID,};convertTables(convertedData,data);Object.keys(data.styles).map((key)=>{data.styles[key]=removeFalsyAttributes(data.styles[key]);});return convertedData;}}
var State;(function(State){State[State["LeftRef"]=0]="LeftRef";State[State["RightRef"]=1]="RightRef";State[State["Separator"]=2]="Separator";State[State["FullColumnSeparator"]=3]="FullColumnSeparator";State[State["FullRowSeparator"]=4]="FullRowSeparator";State[State["RightColumnRef"]=5]="RightColumnRef";State[State["RightRowRef"]=6]="RightRowRef";State[State["Found"]=7]="Found";})(State||(State={}));const goTo=(state,guard=()=>true)=>[{goTo:state,guard,},];const goToMulti=(state,guard=()=>true)=>({goTo:state,guard,});const machine={[State.LeftRef]:{REFERENCE:goTo(State.Separator),NUMBER:goTo(State.FullRowSeparator),SYMBOL:[goToMulti(State.FullColumnSeparator,(token)=>isColReference(token.value)),goToMulti(State.FullRowSeparator,(token)=>isRowReference(token.value)),],},[State.FullColumnSeparator]:{SPACE:goTo(State.FullColumnSeparator),OPERATOR:goTo(State.RightColumnRef,(token)=>token.value===":"),},[State.FullRowSeparator]:{SPACE:goTo(State.FullRowSeparator),OPERATOR:goTo(State.RightRowRef,(token)=>token.value===":"),},[State.Separator]:{SPACE:goTo(State.Separator),OPERATOR:goTo(State.RightRef,(token)=>token.value===":"),},[State.RightRef]:{SPACE:goTo(State.RightRef),NUMBER:goTo(State.Found),REFERENCE:goTo(State.Found,(token)=>isSingleCellReference(token.value)),SYMBOL:goTo(State.Found,(token)=>isColHeader(token.value)||isRowHeader(token.value)),},[State.RightColumnRef]:{SPACE:goTo(State.RightColumnRef),SYMBOL:goTo(State.Found,(token)=>isColHeader(token.value)),REFERENCE:goTo(State.Found,(token)=>isSingleCellReference(token.value)),},[State.RightRowRef]:{SPACE:goTo(State.RightRowRef),NUMBER:goTo(State.Found),REFERENCE:goTo(State.Found,(token)=>isSingleCellReference(token.value)),SYMBOL:goTo(State.Found,(token)=>isRowHeader(token.value)),},[State.Found]:{},};function matchReference(tokens){let head=0;let transitions=machine[State.LeftRef];let matchedTokens="";while(transitions!==undefined){const token=tokens[head++];if(!token){return null;}
const transition=transitions[token.type]?.find((transition)=>transition.guard(token));const nextState=transition?transition.goTo:undefined;switch(nextState){case undefined:return null;case State.Found:matchedTokens+=token.value;tokens.splice(0,head);return{type:"REFERENCE",value:matchedTokens,};default:transitions=machine[nextState];matchedTokens+=token.value;break;}}
return null;}
function rangeTokenize(formula,locale=DEFAULT_LOCALE){const tokens=tokenize(formula,locale);const result=[];while(tokens.length){result.push(matchReference(tokens)||tokens.shift());}
return result;}
function normalizeV9(formula){const tokens=rangeTokenize(formula);let dependencies=[];let noRefFormula="".concat(...tokens.map((token)=>{if(token.type==="REFERENCE"&&cellReference.test(token.value)){const value=token.value.trim();if(!dependencies.includes(value)){dependencies.push(value);}
return`${FORMULA_REF_IDENTIFIER}${dependencies.indexOf(value)}${FORMULA_REF_IDENTIFIER}`;}
else{return token.value;}}));return{text:noRefFormula,dependencies};}
const CURRENT_VERSION=14;const INITIAL_SHEET_ID="Sheet1";function load(data,verboseImport){if(!data){return createEmptyWorkbookData();}
if(data["[Content_Types].xml"]){const reader=new XlsxReader(data);data=reader.convertXlsx();if(verboseImport){for(let parsingError of reader.warningManager.warnings.sort()){console.warn(parsingError);}}}
if("version"in data){if(data.version<CURRENT_VERSION){data=migrate(data);}}
data=repairData(data);return data;}
function migrate(data){const index=MIGRATIONS.findIndex((m)=>m.from===data.version);for(let i=index;i<MIGRATIONS.length;i++){data=MIGRATIONS[i].applyMigration(data);}
return data;}
const MIGRATIONS=[{description:"add the `activeSheet` field on data",from:1,to:2,applyMigration(data){if(data.sheets&&data.sheets[0]){data.activeSheet=data.sheets[0].name;}
return data;},},{description:"add an id field in each sheet",from:2,to:3,applyMigration(data){if(data.sheets&&data.sheets.length){for(let sheet of data.sheets){sheet.id=sheet.id||sheet.name;}}
return data;},},{description:"activeSheet is now an id, not the name of a sheet",from:3,to:4,applyMigration(data){if(data.sheets&&data.activeSheet){const activeSheet=data.sheets.find((s)=>s.name===data.activeSheet);data.activeSheet=activeSheet.id;}
return data;},},{description:"add figures object in each sheets",from:4,to:5,applyMigration(data){for(let sheet of data.sheets||[]){sheet.figures=sheet.figures||[];}
return data;},},{description:"normalize the content of the cell if it is a formula to avoid parsing all the formula that vary only by the cells they use",from:5,to:6,applyMigration(data){for(let sheet of data.sheets||[]){for(let xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.content&&cell.content.startsWith("=")){cell.formula=normalizeV9(cell.content);}}}
return data;},},{description:"transform chart data structure",from:6,to:7,applyMigration(data){for(let sheet of data.sheets||[]){for(let f in sheet.figures||[]){const{dataSets,...newData}=sheet.figures[f].data;const newDataSets=[];for(let ds of dataSets){if(ds.labelCell){const dataRange=toZone(ds.dataRange);const newRange=ds.labelCell+":"+toXC(dataRange.right,dataRange.bottom);newDataSets.push(newRange);}
else{newDataSets.push(ds.dataRange);}}
newData.dataSetsHaveTitle=Boolean(dataSets[0].labelCell);newData.dataSets=newDataSets;sheet.figures[f].data=newData;}}
return data;},},{description:"remove single quotes in sheet names",from:7,to:8,applyMigration(data){const namesTaken=[];const globalForbiddenInExcel=new RegExp(FORBIDDEN_IN_EXCEL_REGEX,"g");for(let sheet of data.sheets||[]){if(!sheet.name){continue;}
const oldName=sheet.name;const escapedName=oldName.replace(globalForbiddenInExcel,"_");let i=1;let newName=escapedName;while(namesTaken.includes(newName)){newName=`${escapedName}${i}`;i++;}
sheet.name=newName;namesTaken.push(newName);const replaceName=(str)=>{if(str===undefined){return str;}
let newString=str.replace(oldName,newName);let currentString=str;while(currentString!==newString){currentString=newString;newString=currentString.replace(oldName,newName);}
return currentString;};for(let xc in sheet.cells){const cell=sheet.cells[xc];if(cell.formula){cell.formula.dependencies=cell.formula.dependencies.map(replaceName);}}
for(let figure of sheet.figures||[]){if(figure.type==="chart"){const dataSets=figure.data.dataSets.map(replaceName);const labelRange=replaceName(figure.data.labelRange);figure.data={...figure.data,dataSets,labelRange};}}
for(let cf of sheet.conditionalFormats||[]){cf.ranges=cf.ranges.map(replaceName);for(const thresholdName of["minimum","maximum","midpoint","upperInflectionPoint","lowerInflectionPoint",]){if(cf.rule[thresholdName]?.type==="formula"){cf.rule[thresholdName].value=replaceName(cf.rule[thresholdName].value);}}}}
return data;},},{description:"transform chart data structure with design attributes",from:8,to:9,applyMigration(data){for(const sheet of data.sheets||[]){for(const chart of sheet.figures||[]){chart.data.background=BACKGROUND_CHART_COLOR;chart.data.verticalAxisPosition="left";chart.data.legendPosition="top";chart.data.stacked=false;}}
return data;},},{description:"de-normalize formula to reduce exported json size (~30%)",from:9,to:10,applyMigration(data){for(let sheet of data.sheets||[]){for(let xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.formula){let{text,dependencies}=cell.formula;for(let[index,d]of Object.entries(dependencies)){const stringPosition=`\\${FORMULA_REF_IDENTIFIER}${index}\\${FORMULA_REF_IDENTIFIER}`;text=text.replace(new RegExp(stringPosition,"g"),d);}
cell.content=text;delete cell.formula;}}}
return data;},},{description:"normalize the formats of the cells",from:10,to:11,applyMigration(data){const formats={};for(let sheet of data.sheets||[]){for(let xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.format){cell.format=getItemId(cell.format,formats);}}}
data.formats=formats;return data;},},{description:"Add isVisible to sheets",from:11,to:12,applyMigration(data){for(let sheet of data.sheets||[]){sheet.isVisible=true;}
return data;},},{description:"Fix datafilter duplication",from:12,to:12.5,applyMigration(data){return fixOverlappingFilters(data);},},{description:"Change Border description structure",from:12.5,to:13,applyMigration(data){for(const borderId in data.borders){const border=data.borders[borderId];for(const position in border){if(Array.isArray(border[position])){border[position]={style:border[position][0],color:border[position][1],};}}}
return data;},},{description:"Add locale to spreadsheet settings",from:13,to:14,applyMigration(data){if(!data.settings){data.settings={};}
if(!data.settings.locale){data.settings.locale=DEFAULT_LOCALE;}
return data;},},{description:"Fix datafilter duplication (post saas-16.4)",from:14,to:14.5,applyMigration(data){return fixOverlappingFilters(data);},},];function repairData(data){data=forceUnicityOfFigure(data);data=setDefaults(data);return data;}
function forceUnicityOfFigure(data){if(data.uniqueFigureIds){return data;}
const figureIds=new Set();const uuidGenerator=new UuidGenerator();for(const sheet of data.sheets||[]){for(const figure of sheet.figures||[]){if(figureIds.has(figure.id)){figure.id+=uuidGenerator.uuidv4();}
figureIds.add(figure.id);}}
data.uniqueFigureIds=true;return data;}
function setDefaults(partialData){const data=Object.assign(createEmptyWorkbookData(),partialData,{version:CURRENT_VERSION,});data.sheets=data.sheets?data.sheets.map((s,i)=>Object.assign(createEmptySheet(`Sheet${i + 1}`,`Sheet${i + 1}`),s)):[];if(data.sheets.length===0){data.sheets.push(createEmptySheet(INITIAL_SHEET_ID,"Sheet1"));}
if(!isValidLocale(data.settings.locale)){data.settings.locale=DEFAULT_LOCALE;}
return data;}
function repairInitialMessages(data,initialMessages){initialMessages=fixTranslatedSheetIds(data,initialMessages);initialMessages=dropCommands(initialMessages,"SORT_CELLS");initialMessages=dropCommands(initialMessages,"SET_DECIMAL");initialMessages=fixChartDefinitions(data,initialMessages);return initialMessages;}
function fixTranslatedSheetIds(data,initialMessages){if(Object.keys(data).length!==0){return initialMessages;}
const sheetIds=[];const messages=[];const fixSheetId=(cmd)=>{if(cmd.type==="CREATE_SHEET"){sheetIds.push(cmd.sheetId);}
else if("sheetId"in cmd&&!sheetIds.includes(cmd.sheetId)){return{...cmd,sheetId:INITIAL_SHEET_ID};}
return cmd;};for(const message of initialMessages){if(message.type==="REMOTE_REVISION"){messages.push({...message,commands:message.commands.map(fixSheetId),});}
else{messages.push(message);}}
return messages;}
function dropCommands(initialMessages,commandType){const messages=[];for(const message of initialMessages){if(message.type==="REMOTE_REVISION"){messages.push({...message,commands:message.commands.filter((command)=>command.type!==commandType),});}
else{messages.push(message);}}
return messages;}
function fixChartDefinitions(data,initialMessages){const messages=[];const map={};for(const sheet of data.sheets||[]){sheet.figures?.forEach((figure)=>{if(figure.tag==="chart"){map[figure.id]=figure.data;}});}
for(const message of initialMessages){if(message.type==="REMOTE_REVISION"){const commands=[];for(const cmd of message.commands){let command=cmd;switch(cmd.type){case"CREATE_CHART":map[cmd.id]=cmd.definition;break;case"UPDATE_CHART":if(!map[cmd.id]){console.log(`Fix chart definition: chart with id ${cmd.id} not found.`);continue;}
const definition=map[cmd.id];const newDefinition={...definition,...cmd.definition};command={...cmd,definition:newDefinition};map[cmd.id]=newDefinition;break;}
commands.push(command);}
messages.push({...message,commands,});}
else{messages.push(message);}}
return messages;}
function fixOverlappingFilters(data){for(let sheet of data.sheets||[]){let knownDataFilterZones=[];for(let filterTable of sheet.filterTables||[]){const zone=toZone(filterTable.range);const intersectZoneIndex=knownDataFilterZones.findIndex((knownZone)=>overlap(knownZone,zone));if(intersectZoneIndex!==-1){knownDataFilterZones[intersectZoneIndex]=zone;}
else{knownDataFilterZones.push(zone);}}
sheet.filterTables=knownDataFilterZones.map((zone)=>({range:zoneToXc(zone),}));}
return data;}
function createEmptySheet(sheetId,name){return{id:sheetId,name,colNumber:26,rowNumber:100,cells:{},cols:{},rows:{},merges:[],conditionalFormats:[],figures:[],filterTables:[],isVisible:true,};}
function createEmptyWorkbookData(sheetName="Sheet1"){const data={version:CURRENT_VERSION,sheets:[createEmptySheet(INITIAL_SHEET_ID,sheetName)],entities:{},styles:{},formats:{},borders:{},revisionId:DEFAULT_REVISION_ID,uniqueFigureIds:true,settings:{locale:DEFAULT_LOCALE},};return data;}
function createEmptyExcelSheet(sheetId,name){return{...createEmptySheet(sheetId,name),charts:[],images:[],};}
function createEmptyExcelWorkbookData(){return{...createEmptyWorkbookData(),sheets:[createEmptyExcelSheet(INITIAL_SHEET_ID,"Sheet1")],};}
class BasePlugin{static getters=[];history;dispatch;constructor(stateObserver,dispatch){this.history=Object.assign(Object.create(stateObserver),{update:stateObserver.addChange.bind(stateObserver,this),selectCell:()=>{},});this.dispatch=dispatch;}
exportForExcel(data){}
allowDispatch(command){return"Success";}
beforeHandle(command){}
handle(command){}
finalize(){}
batchValidations(...validations){return(toValidate)=>validations.map((validation)=>validation.call(this,toValidate)).flat();}
chainValidations(...validations){return(toValidate)=>{for(const validation of validations){let results=validation.call(this,toValidate);if(!Array.isArray(results)){results=[results];}
const cancelledReasons=results.filter((result)=>result!=="Success");if(cancelledReasons.length){return cancelledReasons;}}
return"Success";};}
checkValidations(command,...validations){return this.batchValidations(...validations)(command);}}
class CorePlugin extends BasePlugin{getters;uuidGenerator;constructor({getters,stateObserver,range,dispatch,uuidGenerator}){super(stateObserver,dispatch);range.addRangeProvider(this.adaptRanges.bind(this));this.getters=getters;this.uuidGenerator=uuidGenerator;}
import(data){}
export(data){}
adaptRanges(applyChange,sheetId){}
garbageCollectExternalResources(){}}
class BordersPlugin extends CorePlugin{static getters=["getCellBorder","getBordersColors"];borders={};allowDispatch(cmd){switch(cmd.type){case"SET_BORDER":return this.checkBordersUnchanged(cmd);default:return"Success";}}
handle(cmd){switch(cmd.type){case"ADD_MERGE":for(const zone of cmd.target){this.addBordersToMerge(cmd.sheetId,zone);}
break;case"DUPLICATE_SHEET":const borders=this.borders[cmd.sheetId];if(borders){const bordersCopy=borders.slice().map((col)=>col?.slice().map((border)=>({...border})));this.history.update("borders",cmd.sheetIdTo,bordersCopy);}
break;case"DELETE_SHEET":const allBorders={...this.borders};delete allBorders[cmd.sheetId];this.history.update("borders",allBorders);break;case"SET_BORDER":this.setBorder(cmd.sheetId,cmd.col,cmd.row,cmd.border);break;case"SET_ZONE_BORDERS":if(cmd.border){const target=cmd.target.map((zone)=>this.getters.expandZone(cmd.sheetId,zone));this.setBorders(cmd.sheetId,target,cmd.border.position,cmd.border.color===""?undefined:{style:cmd.border.style||DEFAULT_BORDER_DESC.style,color:cmd.border.color||DEFAULT_BORDER_DESC.color,});}
break;case"CLEAR_FORMATTING":this.clearBorders(cmd.sheetId,cmd.target);break;case"REMOVE_COLUMNS_ROWS":for(let el of[...cmd.elements].sort((a,b)=>b-a)){if(cmd.dimension==="COL"){this.shiftBordersHorizontally(cmd.sheetId,el+1,-1);}
else{this.shiftBordersVertically(cmd.sheetId,el+1,-1);}}
break;case"ADD_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.handleAddColumns(cmd);}
else{this.handleAddRows(cmd);}
break;}}
handleAddColumns(cmd){let colLeftOfInsertion;let colRightOfInsertion;if(cmd.position==="before"){this.shiftBordersHorizontally(cmd.sheetId,cmd.base,cmd.quantity,{moveFirstLeftBorder:true,});colLeftOfInsertion=cmd.base-1;colRightOfInsertion=cmd.base+cmd.quantity;}
else{this.shiftBordersHorizontally(cmd.sheetId,cmd.base+1,cmd.quantity,{moveFirstLeftBorder:false,});colLeftOfInsertion=cmd.base;colRightOfInsertion=cmd.base+cmd.quantity+1;}
this.ensureColumnBorderContinuity(cmd.sheetId,colLeftOfInsertion,colRightOfInsertion);}
handleAddRows(cmd){let rowAboveInsertion;let rowBelowInsertion;if(cmd.position==="before"){this.shiftBordersVertically(cmd.sheetId,cmd.base,cmd.quantity,{moveFirstTopBorder:true,});rowAboveInsertion=cmd.base-1;rowBelowInsertion=cmd.base+cmd.quantity;}
else{this.shiftBordersVertically(cmd.sheetId,cmd.base+1,cmd.quantity,{moveFirstTopBorder:false,});rowAboveInsertion=cmd.base;rowBelowInsertion=cmd.base+cmd.quantity+1;}
this.ensureRowBorderContinuity(cmd.sheetId,rowAboveInsertion,rowBelowInsertion);}
getCellBorder({sheetId,col,row}){const border={top:this.borders[sheetId]?.[col]?.[row]?.horizontal,bottom:this.borders[sheetId]?.[col]?.[row+1]?.horizontal,left:this.borders[sheetId]?.[col]?.[row]?.vertical,right:this.borders[sheetId]?.[col+1]?.[row]?.vertical,};if(!border.bottom&&!border.left&&!border.right&&!border.top){return null;}
return border;}
getBordersColors(sheetId){const colors=[];const sheetBorders=this.borders[sheetId];if(sheetBorders){for(const borders of sheetBorders.filter(isDefined$1)){for(const cellBorder of borders){if(cellBorder?.horizontal){colors.push(cellBorder.horizontal.color);}
if(cellBorder?.vertical){colors.push(cellBorder.vertical.color);}}}}
return colors;}
ensureColumnBorderContinuity(sheetId,leftColumn,rightColumn){const targetCols=range(leftColumn+1,rightColumn);for(let row=0;row<this.getters.getNumberRows(sheetId);row++){const leftBorder=this.getCellBorder({sheetId,col:leftColumn,row});const rightBorder=this.getCellBorder({sheetId,col:rightColumn,row});if(leftBorder&&rightBorder){const commonSides=this.getCommonSides(leftBorder,rightBorder);for(let col of targetCols){this.addBorder(sheetId,col,row,commonSides);}}}}
ensureRowBorderContinuity(sheetId,topRow,bottomRow){const targetRows=range(topRow+1,bottomRow);for(let col=0;col<this.getters.getNumberCols(sheetId);col++){const aboveBorder=this.getCellBorder({sheetId,col,row:topRow});const belowBorder=this.getCellBorder({sheetId,col,row:bottomRow});if(aboveBorder&&belowBorder){const commonSides=this.getCommonSides(aboveBorder,belowBorder);for(let row of targetRows){this.addBorder(sheetId,col,row,commonSides);}}}}
getCommonSides(border1,border2){const commonBorder={};for(let side of["top","bottom","left","right"]){if(border1[side]&&border1[side]===border2[side]){commonBorder[side]=border1[side];}}
return commonBorder;}
getColumnsWithBorders(sheetId){const sheetBorders=this.borders[sheetId];if(!sheetBorders)
return[];return Object.keys(sheetBorders).map((index)=>parseInt(index,10));}
getRowsRange(sheetId){const sheetBorders=this.borders[sheetId];if(!sheetBorders)
return[];return range(0,this.getters.getNumberRows(sheetId)+1);}
shiftBordersHorizontally(sheetId,start,delta,{moveFirstLeftBorder}={}){const borders=this.borders[sheetId];if(!borders)
return;if(delta<0){this.moveBordersOfColumn(sheetId,start,delta,"vertical",{destructive:false,});}
this.getColumnsWithBorders(sheetId).filter((col)=>col>=start).sort((a,b)=>(delta<0?a-b:b-a)).forEach((col)=>{if((col===start&&moveFirstLeftBorder)||col!==start){this.moveBordersOfColumn(sheetId,col,delta,"vertical");}
this.moveBordersOfColumn(sheetId,col,delta,"horizontal");});}
shiftBordersVertically(sheetId,start,delta,{moveFirstTopBorder}={}){const borders=this.borders[sheetId];if(!borders)
return;if(delta<0){this.moveBordersOfRow(sheetId,start,delta,"horizontal",{destructive:false,});}
this.getRowsRange(sheetId).filter((row)=>row>=start).sort((a,b)=>(delta<0?a-b:b-a)).forEach((row)=>{if((row===start&&moveFirstTopBorder)||row!==start){this.moveBordersOfRow(sheetId,row,delta,"horizontal");}
this.moveBordersOfRow(sheetId,row,delta,"vertical");});}
moveBordersOfRow(sheetId,row,delta,borderDirection,{destructive}={destructive:true}){const borders=this.borders[sheetId];if(!borders)
return;this.getColumnsWithBorders(sheetId).forEach((col)=>{const targetBorder=borders[col]?.[row+delta]?.[borderDirection];const movedBorder=borders[col]?.[row]?.[borderDirection];this.history.update("borders",sheetId,col,row+delta,borderDirection,destructive?movedBorder:movedBorder||targetBorder);this.history.update("borders",sheetId,col,row,borderDirection,undefined);});}
moveBordersOfColumn(sheetId,col,delta,borderDirection,{destructive}={destructive:true}){const borders=this.borders[sheetId];if(!borders)
return;this.getRowsRange(sheetId).forEach((row)=>{const targetBorder=borders[col+delta]?.[row]?.[borderDirection];const movedBorder=borders[col]?.[row]?.[borderDirection];this.history.update("borders",sheetId,col+delta,row,borderDirection,destructive?movedBorder:movedBorder||targetBorder);this.history.update("borders",sheetId,col,row,borderDirection,undefined);});}
setBorder(sheetId,col,row,border,override=true){if(override||!this.borders?.[sheetId]?.[col]?.[row]?.vertical){this.history.update("borders",sheetId,col,row,"vertical",border?.left);}
if(override||!this.borders?.[sheetId]?.[col]?.[row]?.horizontal){this.history.update("borders",sheetId,col,row,"horizontal",border?.top);}
if(override||!this.borders?.[sheetId]?.[col+1]?.[row]?.vertical){this.history.update("borders",sheetId,col+1,row,"vertical",border?.right);}
if(override||!this.borders?.[sheetId]?.[col]?.[row+1]?.horizontal){this.history.update("borders",sheetId,col,row+1,"horizontal",border?.bottom);}}
clearBorders(sheetId,zones){for(let zone of zones){for(let row=zone.top;row<=zone.bottom;row++){this.history.update("borders",sheetId,zone.right+1,row,"vertical",undefined);for(let col=zone.left;col<=zone.right;col++){this.history.update("borders",sheetId,col,row,undefined);}}
for(let col=zone.left;col<=zone.right;col++){this.history.update("borders",sheetId,col,zone.bottom+1,"horizontal",undefined);}}}
addBorder(sheetId,col,row,border){this.setBorder(sheetId,col,row,{...this.getCellBorder({sheetId,col,row}),...border,});}
setBorders(sheetId,zones,position,border){if(position==="clear"){return this.clearBorders(sheetId,zones);}
for(let zone of zones){if(position==="h"||position==="hv"||position==="all"){for(let row=zone.top+1;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){this.addBorder(sheetId,col,row,{top:border});}}}
if(position==="v"||position==="hv"||position==="all"){for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left+1;col<=zone.right;col++){this.addBorder(sheetId,col,row,{left:border});}}}
if(position==="left"||position==="all"||position==="external"){for(let row=zone.top;row<=zone.bottom;row++){this.addBorder(sheetId,zone.left,row,{left:border});}}
if(position==="right"||position==="all"||position==="external"){for(let row=zone.top;row<=zone.bottom;row++){this.addBorder(sheetId,zone.right+1,row,{left:border});}}
if(position==="top"||position==="all"||position==="external"){for(let col=zone.left;col<=zone.right;col++){this.addBorder(sheetId,col,zone.top,{top:border});}}
if(position==="bottom"||position==="all"||position==="external"){for(let col=zone.left;col<=zone.right;col++){this.addBorder(sheetId,col,zone.bottom+1,{top:border});}}}}
addBordersToMerge(sheetId,zone){const{left,right,top,bottom}=zone;const bordersTopLeft=this.getCellBorder({sheetId,col:left,row:top});const bordersBottomRight=this.getCellBorder({sheetId,col:right,row:bottom});this.clearBorders(sheetId,[zone]);if(bordersTopLeft?.top){this.setBorders(sheetId,[{...zone,bottom:top}],"top",bordersTopLeft.top);}
if(bordersTopLeft?.left){this.setBorders(sheetId,[{...zone,right:left}],"left",bordersTopLeft.left);}
if(bordersBottomRight?.bottom){this.setBorders(sheetId,[{...zone,top:bottom}],"bottom",bordersBottomRight.bottom);}
else if(bordersTopLeft?.bottom){this.setBorders(sheetId,[{...zone,top:bottom}],"bottom",bordersTopLeft.bottom);}
if(bordersBottomRight?.right){this.setBorders(sheetId,[{...zone,left:right}],"right",bordersBottomRight.right);}
else if(bordersTopLeft?.right){this.setBorders(sheetId,[{...zone,left:right}],"right",bordersTopLeft.right);}}
checkBordersUnchanged(cmd){const currentBorder=this.getCellBorder(cmd);const areAllNewBordersUndefined=!cmd.border?.bottom&&!cmd.border?.left&&!cmd.border?.right&&!cmd.border?.top;if((!currentBorder&&areAllNewBordersUndefined)||deepEquals(currentBorder,cmd.border)){return"NoChanges";}
return"Success";}
import(data){if(Object.keys(data.borders||{}).length){for(let sheet of data.sheets){for(const xc in sheet.cells){const cell=sheet.cells[xc];if(cell?.border){const border=data.borders[cell.border];const{col,row}=toCartesian(xc);this.setBorder(sheet.id,col,row,border,false);}}}}
for(let sheetData of data.sheets){if(sheetData.merges){for(let merge of sheetData.merges){this.addBordersToMerge(sheetData.id,toZone(merge));}}}}
export(data){const borders={};for(let sheet of data.sheets){for(let col=0;col<sheet.colNumber;col++){for(let row=0;row<sheet.rowNumber;row++){const border=this.getCellBorder({sheetId:sheet.id,col,row});if(border){const xc=toXC(col,row);const cell=sheet.cells[xc];const borderId=getItemId(border,borders);if(cell){cell.border=borderId;}
else{sheet.cells[xc]={border:borderId};}}}}}
data.borders=borders;}
exportForExcel(data){this.export(data);}}
class FunctionCodeBuilder{scope;code="";constructor(scope=new Scope()){this.scope=scope;}
append(...lines){this.code+=lines.map((line)=>line.toString()).join("\n")+"\n";}
return(expression){return new FunctionCodeImpl(this.scope,this.code,expression);}
toString(){return indentCode(this.code);}}
class FunctionCodeImpl{scope;returnExpression;code;constructor(scope,code,returnExpression){this.scope=scope;this.returnExpression=returnExpression;this.code=indentCode(code);}
toString(){return this.code;}
wrapInClosure(){const closureName=this.scope.nextVariableName();const code=new FunctionCodeBuilder(this.scope);code.append(`const ${closureName} = () => {`);code.append(this.code);code.append(`return ${this.returnExpression};`);code.append(`}`);return code.return(closureName);}
assignResultToVariable(){if(this.scope.isAlreadyDeclared(this.returnExpression)){return this;}
const variableName=this.scope.nextVariableName();const code=new FunctionCodeBuilder(this.scope);code.append(this.code);code.append(`const ${variableName} = ${this.returnExpression};`);return code.return(variableName);}}
class Scope{nextId=1;declaredVariables=new Set();nextVariableName(){const name=`_${this.nextId++}`;this.declaredVariables.add(name);return name;}
isAlreadyDeclared(name){return this.declaredVariables.has(name);}}
function splitLines(str){return str.split("\n").map((line)=>line.trim()).filter((line)=>line!=="");}
function indentCode(code){let result="";let indentLevel=0;const lines=splitLines(code);for(const line of lines){if(line.startsWith("}")){indentLevel--;}
result+="\t".repeat(indentLevel)+line+"\n";if(line.endsWith("{")){indentLevel++;}}
return result.trim();}
const functionRegex=/[a-zA-Z0-9\_]+(\.[a-zA-Z0-9\_]+)*/;const UNARY_OPERATORS_PREFIX=["-","+"];const UNARY_OPERATORS_POSTFIX=["%"];const ASSOCIATIVE_OPERATORS=["*","+","&"];const OP_PRIORITY={"^":30,"%":30,"*":20,"/":20,"+":15,"-":15,"&":13,">":10,"<>":10,">=":10,"<":10,"<=":10,"=":10,};function parseOperand(tokens){const current=tokens.shift();if(!current){throw new BadExpressionError(DEFAULT_ERROR_MESSAGE);}
switch(current.type){case"DEBUGGER":const next=parseExpression(tokens,1000);next.debug=true;return next;case"NUMBER":return{type:"NUMBER",value:parseNumber(current.value,DEFAULT_LOCALE)};case"STRING":return{type:"STRING",value:removeStringQuotes(current.value)};case"INVALID_REFERENCE":throw new InvalidReferenceError();case"REFERENCE":if(tokens[0]?.value===":"&&tokens[1]?.type==="REFERENCE"){tokens.shift();const rightReference=tokens.shift();return{type:"REFERENCE",value:`${current.value}:${rightReference?.value}`,};}
return{type:"REFERENCE",value:current.value,};case"SYMBOL":const value=current.value;const nextToken=tokens[0];if(nextToken?.type==="LEFT_PAREN"&&functionRegex.test(current.value)){const args=parseFunctionArgs(tokens);return{type:"FUNCALL",value:value,args};}
const upperCaseValue=value.toUpperCase();if(upperCaseValue==="TRUE"||upperCaseValue==="FALSE"){return{type:"BOOLEAN",value:upperCaseValue==="TRUE"};}
throw new BadExpressionError(_t("Invalid formula"));case"LEFT_PAREN":const result=parseExpression(tokens);consumeOrThrow(tokens,"RIGHT_PAREN",_t("Missing closing parenthesis"));return result;case"OPERATOR":const operator=current.value;if(UNARY_OPERATORS_PREFIX.includes(operator)){return{type:"UNARY_OPERATION",value:operator,operand:parseExpression(tokens,OP_PRIORITY[operator]),};}
throw new BadExpressionError(_t("Unexpected token: %s",current.value));default:throw new BadExpressionError(_t("Unexpected token: %s",current.value));}}
function parseFunctionArgs(tokens){consumeOrThrow(tokens,"LEFT_PAREN",_t("Missing opening parenthesis"));const nextToken=tokens[0];if(nextToken?.type==="RIGHT_PAREN"){consumeOrThrow(tokens,"RIGHT_PAREN");return[];}
const args=[];args.push(parseOneFunctionArg(tokens));while(tokens[0]?.type!=="RIGHT_PAREN"){consumeOrThrow(tokens,"ARG_SEPARATOR",_t("Wrong function call"));args.push(parseOneFunctionArg(tokens));}
consumeOrThrow(tokens,"RIGHT_PAREN");return args;}
function parseOneFunctionArg(tokens){const nextToken=tokens[0];if(nextToken?.type==="ARG_SEPARATOR"||nextToken?.type==="RIGHT_PAREN"){return{type:"EMPTY",value:""};}
return parseExpression(tokens);}
function consumeOrThrow(tokens,type,message=DEFAULT_ERROR_MESSAGE){const token=tokens.shift();if(!token||token.type!==type){throw new BadExpressionError(message);}}
function parseExpression(tokens,parent_priority=0){if(tokens.length===0){throw new BadExpressionError(DEFAULT_ERROR_MESSAGE);}
let left=parseOperand(tokens);while(tokens[0]?.type==="OPERATOR"&&OP_PRIORITY[tokens[0].value]>parent_priority){const operator=tokens.shift().value;if(UNARY_OPERATORS_POSTFIX.includes(operator)){left={type:"UNARY_OPERATION",value:operator,operand:left,postfix:true,};}
else{const right=parseExpression(tokens,OP_PRIORITY[operator]);left={type:"BIN_OPERATION",value:operator,left,right,};}}
return left;}
function parse(str){return parseTokens(tokenize(str));}
function parseTokens(tokens){tokens=tokens.filter((x)=>x.type!=="SPACE");if(tokens[0].value==="="){tokens.splice(0,1);}
const result=parseExpression(tokens);if(tokens.length){throw new BadExpressionError(DEFAULT_ERROR_MESSAGE);}
return result;}
function convertAstNodes(ast,type,fn){return mapAst(ast,(ast)=>{if(ast.type===type){return fn(ast);}
return ast;});}
function iterateAstNodes(ast){return Array.from(astIterator(ast));}
function*astIterator(ast){yield ast;switch(ast.type){case"FUNCALL":for(const arg of ast.args){yield*astIterator(arg);}
break;case"UNARY_OPERATION":yield*astIterator(ast.operand);break;case"BIN_OPERATION":yield*astIterator(ast.left);yield*astIterator(ast.right);break;}}
function mapAst(ast,fn){ast=fn(ast);switch(ast.type){case"FUNCALL":return{...ast,args:ast.args.map((child)=>mapAst(child,fn)),};case"UNARY_OPERATION":return{...ast,operand:mapAst(ast.operand,fn),};case"BIN_OPERATION":return{...ast,right:mapAst(ast.right,fn),left:mapAst(ast.left,fn),};default:return ast;}}
function astToFormula(ast){switch(ast.type){case"FUNCALL":const args=ast.args.map((arg)=>astToFormula(arg));return`${ast.value}(${args.join(",")})`;case"NUMBER":return ast.value.toString();case"REFERENCE":return ast.value;case"STRING":return`"${ast.value}"`;case"BOOLEAN":return ast.value?"TRUE":"FALSE";case"UNARY_OPERATION":return ast.postfix?leftOperandToFormula(ast)+ast.value:ast.value+rightOperandToFormula(ast);case"BIN_OPERATION":return leftOperandToFormula(ast)+ast.value+rightOperandToFormula(ast);default:return ast.value;}}
function leftOperandToFormula(operationAST){const mainOperator=operationAST.value;const leftOperation="left"in operationAST?operationAST.left:operationAST.operand;const leftOperator=leftOperation.value;const needParenthesis=leftOperation.type==="BIN_OPERATION"&&OP_PRIORITY[leftOperator]<OP_PRIORITY[mainOperator];return needParenthesis?`(${astToFormula(leftOperation)})`:astToFormula(leftOperation);}
function rightOperandToFormula(operationAST){const mainOperator=operationAST.value;const rightOperation="right"in operationAST?operationAST.right:operationAST.operand;const rightPriority=OP_PRIORITY[rightOperation.value];const mainPriority=OP_PRIORITY[mainOperator];let needParenthesis=false;if(rightOperation.type!=="BIN_OPERATION"){needParenthesis=false;}
else if(rightPriority<mainPriority){needParenthesis=true;}
else if(rightPriority===mainPriority&&!ASSOCIATIVE_OPERATORS.includes(mainOperator)){needParenthesis=true;}
return needParenthesis?`(${astToFormula(rightOperation)})`:astToFormula(rightOperation);}
const functions$1=functionRegistry.content;const OPERATOR_MAP={"=":"EQ","+":"ADD","-":"MINUS","*":"MULTIPLY","/":"DIVIDE",">=":"GTE","<>":"NE",">":"GT","<=":"LTE","<":"LT","^":"POWER","&":"CONCATENATE",};const UNARY_OPERATOR_MAP={"-":"UMINUS","+":"UPLUS","%":"UNARY.PERCENT",};const functionCache={};function compile(formula){const tokens=rangeTokenize(formula);return compileTokens(tokens);}
function compileTokens(tokens){const{dependencies,constantValues}=formulaArguments(tokens);const cacheKey=compilationCacheKey(tokens,dependencies,constantValues);if(!functionCache[cacheKey]){const ast=parseTokens([...tokens]);const scope=new Scope();if(ast.type==="BIN_OPERATION"&&ast.value===":"){throw new BadExpressionError(_t("Invalid formula"));}
if(ast.type==="EMPTY"){throw new BadExpressionError(_t("Invalid formula"));}
const compiledAST=compileAST(ast);const code=new FunctionCodeBuilder();code.append(`// ${cacheKey}`);code.append(compiledAST);code.append(`return ${compiledAST.returnExpression};`);let baseFunction=new Function("deps","ref","range","ctx",code.toString());functionCache[cacheKey]={execute:baseFunction,};function compileFunctionArgs(ast){const{args}=ast;const functionName=ast.value.toUpperCase();const functionDefinition=functions$1[functionName];if(!functionDefinition){throw new UnknownFunctionError(ast.value);}
assertEnoughArgs(ast);const compiledArgs=[];for(let i=0;i<args.length;i++){const argToFocus=functionDefinition.getArgToFocus(i+1)-1;const argDefinition=functionDefinition.args[argToFocus];const currentArg=args[i];const argTypes=argDefinition.type||[];const isMeta=argTypes.includes("META");const isLazy=argDefinition.lazy;const hasRange=argTypes.some((t)=>isRangeType(t));const isRangeOnly=argTypes.every((t)=>isRangeType(t));if(isRangeOnly){if(!isRangeInput(currentArg)){throw new BadExpressionError(_t("Function %s expects the parameter %s to be reference to a cell or range, not a %s.",functionName,(i+1).toString(),currentArg.type.toLowerCase()));}}
const compiledAST=compileAST(currentArg,isMeta,hasRange,{functionName,paramIndex:i+1,});compiledArgs.push(isLazy?compiledAST.wrapInClosure():compiledAST);}
return compiledArgs;}
function compileAST(ast,isMeta=false,hasRange=false,referenceVerification={}){const code=new FunctionCodeBuilder(scope);if(ast.type!=="REFERENCE"&&!(ast.type==="BIN_OPERATION"&&ast.value===":")){if(isMeta){throw new BadExpressionError(_t("Argument must be a reference to a cell or range."));}}
if(ast.debug){code.append("debugger;");}
switch(ast.type){case"BOOLEAN":return code.return(`{ value: ${ast.value} }`);case"NUMBER":return code.return(`{ value: this.constantValues.numbers[${constantValues.numbers.indexOf(ast.value)}] }`);case"STRING":return code.return(`{ value: this.constantValues.strings[${constantValues.strings.indexOf(ast.value)}] }`);case"REFERENCE":const referenceIndex=dependencies.indexOf(ast.value);if(hasRange){return code.return(`range(deps[${referenceIndex}])`);}
else{return code.return(`ref(deps[${referenceIndex}], ${isMeta ? "true" : "false"}, "${referenceVerification.functionName || OPERATOR_MAP["="]}",  ${referenceVerification.paramIndex})`);}
case"FUNCALL":const args=compileFunctionArgs(ast).map((arg)=>arg.assignResultToVariable());code.append(...args);const fnName=ast.value.toUpperCase();code.append(`ctx.__lastFnCalled = '${fnName}';`);return code.return(`ctx['${fnName}'](${args.map((arg) => arg.returnExpression)})`);case"UNARY_OPERATION":{const fnName=UNARY_OPERATOR_MAP[ast.value];const operand=compileAST(ast.operand,false,false,{functionName:fnName,}).assignResultToVariable();code.append(operand);code.append(`ctx.__lastFnCalled = '${fnName}';`);return code.return(`ctx['${fnName}'](${operand.returnExpression})`);}
case"BIN_OPERATION":{const fnName=OPERATOR_MAP[ast.value];const left=compileAST(ast.left,false,false,{functionName:fnName,}).assignResultToVariable();const right=compileAST(ast.right,false,false,{functionName:fnName,}).assignResultToVariable();code.append(left);code.append(right);code.append(`ctx.__lastFnCalled = '${fnName}';`);return code.return(`ctx['${fnName}'](${left.returnExpression}, ${right.returnExpression})`);}
case"EMPTY":return code.return("undefined");}}}
const compiledFormula={execute:functionCache[cacheKey].execute,dependencies,constantValues,tokens,};return compiledFormula;}
function compilationCacheKey(tokens,dependencies,constantValues){return concat(tokens.map((token)=>{switch(token.type){case"STRING":const value=removeStringQuotes(token.value);return`|S${constantValues.strings.indexOf(value)}|`;case"NUMBER":return`|N${constantValues.numbers.indexOf(parseNumber(token.value, DEFAULT_LOCALE))}|`;case"REFERENCE":case"INVALID_REFERENCE":return`|${dependencies.indexOf(token.value)}|`;case"SPACE":return"";default:return token.value;}}));}
function formulaArguments(tokens){const constantValues={numbers:[],strings:[],};const dependencies=[];for(const token of tokens){switch(token.type){case"INVALID_REFERENCE":case"REFERENCE":dependencies.push(token.value);break;case"STRING":const value=removeStringQuotes(token.value);if(!constantValues.strings.includes(value)){constantValues.strings.push(value);}
break;case"NUMBER":{const value=parseNumber(token.value,DEFAULT_LOCALE);if(!constantValues.numbers.includes(value)){constantValues.numbers.push(value);}
break;}}}
return{dependencies,constantValues,};}
function assertEnoughArgs(ast){const nbrArg=ast.args.length;const functionName=ast.value.toUpperCase();const functionDefinition=functions$1[functionName];if(nbrArg<functionDefinition.minArgRequired){throw new BadExpressionError(_t("Invalid number of arguments for the %s function. Expected %s minimum, but got %s instead.",functionName,functionDefinition.minArgRequired.toString(),nbrArg.toString()));}
if(nbrArg>functionDefinition.maxArgPossible){throw new BadExpressionError(_t("Invalid number of arguments for the %s function. Expected %s maximum, but got %s instead.",functionName,functionDefinition.maxArgPossible.toString(),nbrArg.toString()));}
const repeatableArgs=functionDefinition.nbrArgRepeating;if(repeatableArgs>1){const unrepeatableArgs=functionDefinition.args.length-repeatableArgs;const repeatingArgs=nbrArg-unrepeatableArgs;if(repeatingArgs%repeatableArgs!==0){throw new BadExpressionError(_t("Invalid number of arguments for the %s function. Expected all arguments after position %s to be supplied by groups of %s arguments",functionName,unrepeatableArgs.toString(),repeatableArgs.toString()));}}}
function isRangeType(type){return type.startsWith("RANGE");}
function isRangeInput(arg){if(arg.type==="REFERENCE"){return true;}
if(arg.type==="FUNCALL"){const fnDef=functions$1[arg.value.toUpperCase()];return fnDef&&isRangeType(fnDef.returns[0]);}
return false;}
function enrichTokens(tokens){let current=0;return tokens.map((x)=>{const len=x.value.toString().length;const token=Object.assign({},x,{start:current,end:current+len,length:len,});current=token.end;return token;});}
function mapParenthesis(tokens){let maxParen=1;const stack=[];return tokens.map((token)=>{if(token.type==="LEFT_PAREN"){stack.push(maxParen);token.parenIndex=maxParen;maxParen++;}
else if(token.type==="RIGHT_PAREN"){token.parenIndex=stack.pop();}
return token;});}
function mapParentFunction(tokens){let stack=[];let functionStarted="";const res=tokens.map((token,i)=>{if(!["SPACE","LEFT_PAREN"].includes(token.type)){functionStarted="";}
switch(token.type){case"SYMBOL":functionStarted=token.value;break;case"LEFT_PAREN":stack.push({parent:functionStarted,argPosition:0});functionStarted="";break;case"RIGHT_PAREN":stack.pop();break;case"ARG_SEPARATOR":if(stack.length){stack[stack.length-1].argPosition++;}
break;}
if(stack.length){const functionContext=stack[stack.length-1];if(functionContext.parent){token.functionContext=Object.assign({},functionContext);}}
return token;});return res;}
function composerTokenize(formula,locale){const tokens=rangeTokenize(formula,locale);return mapParentFunction(mapParenthesis(enrichTokens(tokens)));}
const functions=functionRegistry.content;function isExportableToExcel(tokens){try{const nonExportableFunctions=iterateAstNodes(parseTokens(tokens)).filter((ast)=>ast.type==="FUNCALL"&&!functions[ast.value.toUpperCase()]?.isExported);return nonExportableFunctions.length===0;}
catch(error){return false;}}
class CellPlugin extends CorePlugin{static getters=["zoneToXC","getCells","getFormulaCellContent","getTranslatedCellFormula","getCellStyle","getCellById",];nextId=1;cells={};adaptRanges(applyChange,sheetId){for(const sheet of Object.keys(this.cells)){for(const cell of Object.values(this.cells[sheet]||{})){if(cell.isFormula){for(const range of cell.compiledFormula.dependencies){if(!sheetId||range.sheetId===sheetId){const change=applyChange(range);if(change.changeType!=="NONE"){this.history.update("cells",sheet,cell.id,"compiledFormula","dependencies",cell.compiledFormula.dependencies.indexOf(range),change.range);}}}}}}}
allowDispatch(cmd){switch(cmd.type){case"UPDATE_CELL":return this.checkValidations(cmd,this.checkCellOutOfSheet,this.checkUselessUpdateCell);case"CLEAR_CELL":return this.checkValidations(cmd,this.checkCellOutOfSheet,this.checkUselessClearCell);default:return"Success";}}
handle(cmd){switch(cmd.type){case"SET_FORMATTING":if("style"in cmd){this.setStyle(cmd.sheetId,cmd.target,cmd.style);}
if("format"in cmd&&cmd.format!==undefined){this.setFormatter(cmd.sheetId,cmd.target,cmd.format);}
break;case"CLEAR_FORMATTING":this.clearFormatting(cmd.sheetId,cmd.target);break;case"ADD_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.handleAddColumnsRows(cmd,this.copyColumnStyle.bind(this));}
else{this.handleAddColumnsRows(cmd,this.copyRowStyle.bind(this));}
break;case"UPDATE_CELL":this.updateCell(cmd.sheetId,cmd.col,cmd.row,cmd);break;case"CLEAR_CELL":this.dispatch("UPDATE_CELL",{sheetId:cmd.sheetId,col:cmd.col,row:cmd.row,content:"",style:null,format:"",});break;}}
setFormatter(sheetId,zones,format){for(let zone of zones){for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){this.dispatch("UPDATE_CELL",{sheetId,col,row,format,});}}}}
clearFormatting(sheetId,zones){for(let zone of zones){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){this.dispatch("UPDATE_CELL",{sheetId,col,row,style:null,format:"",});}}}}
handleAddColumnsRows(cmd,fn){let insertedElements;let styleReference;if(cmd.position==="before"){insertedElements=range(cmd.base,cmd.base+cmd.quantity);styleReference=cmd.base+cmd.quantity;}
else{insertedElements=range(cmd.base+1,cmd.base+cmd.quantity+1);styleReference=cmd.base;}
fn(cmd.sheetId,styleReference,insertedElements);}
import(data){for(let sheet of data.sheets){for(let xc in sheet.cells){const cellData=sheet.cells[xc];const{col,row}=toCartesian(xc);if(cellData?.content||cellData?.format||cellData?.style){const cell=this.importCell(sheet.id,cellData,data.styles,data.formats);this.history.update("cells",sheet.id,cell.id,cell);this.dispatch("UPDATE_CELL_POSITION",{cellId:cell.id,col,row,sheetId:sheet.id,});}}}}
export(data){const styles={};const formats={};for(let _sheet of data.sheets){const cells={};const positions=Object.keys(this.cells[_sheet.id]||{}).map((cellId)=>this.getters.getCellPosition(cellId)).sort((a,b)=>(a.col===b.col?a.row-b.row:a.col-b.col));for(const position of positions){const cell=this.getters.getCell(position);const xc=toXC(position.col,position.row);const style=this.removeDefaultStyleValues(cell.style);cells[xc]={style:Object.keys(style).length?getItemId(style,styles):undefined,format:cell.format?getItemId(cell.format,formats):undefined,content:cell.content||undefined,};}
_sheet.cells=cells;}
data.styles=styles;data.formats=formats;}
importCell(sheetId,cellData,normalizedStyles,normalizedFormats){const style=(cellData.style&&normalizedStyles[cellData.style])||undefined;const format=(cellData.format&&normalizedFormats[cellData.format])||undefined;const cellId=this.getNextUid();return this.createCell(cellId,cellData?.content||"",format,style,sheetId);}
exportForExcel(data){this.export(data);}
removeDefaultStyleValues(style){const cleanedStyle={...style};for(const property in DEFAULT_STYLE){if(cleanedStyle[property]===DEFAULT_STYLE[property]){delete cleanedStyle[property];}}
return cleanedStyle;}
getCells(sheetId){return this.cells[sheetId]||{};}
getCellById(cellId){const position=this.getters.getCellPosition(cellId);const sheet=this.cells[position.sheetId];return sheet[cellId];}
getFormulaCellContent(sheetId,compiledFormula,dependencies,useFixedReference=false){const ranges=dependencies||compiledFormula.dependencies;let rangeIndex=0;return concat(compiledFormula.tokens.map((token)=>{if(token.type==="REFERENCE"){const range=ranges[rangeIndex++];return this.getters.getRangeString(range,sheetId,{useFixedReference});}
return token.value;}));}
getTranslatedCellFormula(sheetId,offsetX,offsetY,compiledFormula){const adaptedDependencies=this.getters.createAdaptedRanges(compiledFormula.dependencies,offsetX,offsetY,sheetId);return this.getFormulaCellContent(sheetId,compiledFormula,adaptedDependencies);}
getCellStyle(position){return this.getters.getCell(position)?.style||{};}
zoneToXC(sheetId,zone,fixedParts=[{colFixed:false,rowFixed:false}]){zone=this.getters.expandZone(sheetId,zone);const topLeft=toXC(zone.left,zone.top,fixedParts[0]);const botRight=toXC(zone.right,zone.bottom,fixedParts.length>1?fixedParts[1]:fixedParts[0]);const cellTopLeft=this.getters.getMainCellPosition({sheetId,col:zone.left,row:zone.top,});const cellBotRight=this.getters.getMainCellPosition({sheetId,col:zone.right,row:zone.bottom,});const sameCell=cellTopLeft.col===cellBotRight.col&&cellTopLeft.row===cellBotRight.row;if(topLeft!=botRight&&!sameCell){return topLeft+":"+botRight;}
return topLeft;}
setStyle(sheetId,target,style){for(let zone of target){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){const cell=this.getters.getCell({sheetId,col,row});this.dispatch("UPDATE_CELL",{sheetId,col,row,style:style?{...cell?.style,...style}:undefined,});}}}}
copyColumnStyle(sheetId,refColumn,targetCols){for(let row=0;row<this.getters.getNumberRows(sheetId);row++){const format=this.getFormat(sheetId,refColumn,row);if(format.style||format.format){for(let col of targetCols){this.dispatch("UPDATE_CELL",{sheetId,col,row,...format});}}}}
copyRowStyle(sheetId,refRow,targetRows){for(let col=0;col<this.getters.getNumberCols(sheetId);col++){const format=this.getFormat(sheetId,col,refRow);if(format.style||format.format){for(let row of targetRows){this.dispatch("UPDATE_CELL",{sheetId,col,row,...format});}}}}
getFormat(sheetId,col,row){const format={};const position=this.getters.getMainCellPosition({sheetId,col,row});const cell=this.getters.getCell(position);if(cell){if(cell.style){format["style"]=cell.style;}
if(cell.format){format["format"]=cell.format;}}
return format;}
getNextUid(){const id=this.nextId.toString();this.history.update("nextId",this.nextId+1);return id;}
updateCell(sheetId,col,row,after){const before=this.getters.getCell({sheetId,col,row});const hasContent="content"in after||"formula"in after;const afterContent=hasContent?replaceSpecialSpaces(after?.content):before?.content||"";let style;if(after.style!==undefined){style=after.style||undefined;}
else{style=before?before.style:undefined;}
const format="format"in after?after.format:before&&before.format;if(((hasContent&&!afterContent&&!after.formula)||(!hasContent&&(!before||before.content==="")))&&!style&&!format){if(before){this.history.update("cells",sheetId,before.id,undefined);this.dispatch("UPDATE_CELL_POSITION",{cellId:undefined,col,row,sheetId,});}
return;}
const cellId=before?.id||this.getNextUid();const cell=this.createCell(cellId,afterContent,format,style,sheetId);this.history.update("cells",sheetId,cell.id,cell);this.dispatch("UPDATE_CELL_POSITION",{cellId:cell.id,col,row,sheetId});}
createCell(id,content,format,style,sheetId){if(!content.startsWith("=")){return this.createLiteralCell(id,content,format,style);}
try{return this.createFormulaCell(id,content,format,style,sheetId);}
catch(error){return this.createErrorFormula(id,content,format,style,error);}}
createLiteralCell(id,content,format,style){const locale=this.getters.getLocale();return{id,content:parseLiteral(content,locale).toString(),style,format:format||detectDateFormat(content,locale)||detectNumberFormat(content),isFormula:false,};}
createFormulaCell(id,content,format,style,sheetId){const compiledFormula=compile(content);if(compiledFormula.dependencies.length){return this.createFormulaCellWithDependencies(id,compiledFormula,format,style,sheetId);}
return{id,content,style,format,isFormula:true,compiledFormula:{...compiledFormula,dependencies:[],},};}
createFormulaCellWithDependencies(id,compiledFormula,format,style,sheetId){const dependencies=[];for(const xc of compiledFormula.dependencies){dependencies.push(this.getters.getRangeFromSheetXC(sheetId,xc));}
return new FormulaCellWithDependencies(id,compiledFormula,format,style,dependencies,sheetId,this.getters.getRangeString);}
createErrorFormula(id,content,format,style,error){return{id,content,style,format,isFormula:true,compiledFormula:{tokens:tokenize(content),dependencies:[],execute:function(){throw error;},},};}
checkCellOutOfSheet(cmd){const{sheetId,col,row}=cmd;const sheet=this.getters.tryGetSheet(sheetId);if(!sheet)
return"InvalidSheetId";const sheetZone=this.getters.getSheetZone(sheetId);return isInside(col,row,sheetZone)?"Success":"TargetOutOfSheet";}
checkUselessClearCell(cmd){const cell=this.getters.getCell(cmd);if(!cell)
return"NoChanges";if(!cell.content&&!cell.style&&!cell.format){return"NoChanges";}
return"Success";}
checkUselessUpdateCell(cmd){const cell=this.getters.getCell(cmd);const hasContent="content"in cmd||"formula"in cmd;const hasStyle="style"in cmd;const hasFormat="format"in cmd;if((!hasContent||cell?.content===cmd.content)&&(!hasStyle||deepEquals(cell?.style,cmd.style))&&(!hasFormat||cell?.format===cmd.format)){return"NoChanges";}
return"Success";}}
class FormulaCellWithDependencies{id;format;style;sheetId;getRangeString;isFormula=true;compiledFormula;constructor(id,compiledFormula,format,style,dependencies,sheetId,getRangeString){this.id=id;this.format=format;this.style=style;this.sheetId=sheetId;this.getRangeString=getRangeString;let rangeIndex=0;const tokens=compiledFormula.tokens.map((token)=>{if(token.type==="REFERENCE"){const index=rangeIndex++;return new RangeReferenceToken(dependencies,index,this.sheetId,this.getRangeString);}
return token;});this.compiledFormula={...compiledFormula,dependencies,tokens,};}
get content(){return concat(this.compiledFormula.tokens.map((token)=>token.value));}
get contentWithFixedReferences(){let rangeIndex=0;return concat(this.compiledFormula.tokens.map((token)=>{if(token.type==="REFERENCE"){const index=rangeIndex++;return this.getRangeString(this.compiledFormula.dependencies[index],this.sheetId,{useFixedReference:true,});}
return token.value;}));}}
class RangeReferenceToken{ranges;rangeIndex;sheetId;getRangeString;type="REFERENCE";constructor(ranges,rangeIndex,sheetId,getRangeString){this.ranges=ranges;this.rangeIndex=rangeIndex;this.sheetId=sheetId;this.getRangeString=getRangeString;}
get value(){const range=this.ranges[this.rangeIndex];return this.getRangeString(range,this.sheetId);}}
class ChartPlugin extends CorePlugin{static getters=["isChartDefined","getChartDefinition","getChartType","getChartIds","getChart","getContextCreationChart",];charts={};createChart=chartFactory(this.getters);validateChartDefinition=(cmd)=>validateChartDefinition(this,cmd.definition);adaptRanges(applyChange){for(const[chartId,chart]of Object.entries(this.charts)){this.history.update("charts",chartId,chart?.updateRanges(applyChange));}}
allowDispatch(cmd){switch(cmd.type){case"CREATE_CHART":return this.checkValidations(cmd,this.chainValidations(this.validateChartDefinition,this.checkChartDuplicate));case"UPDATE_CHART":return this.checkValidations(cmd,this.chainValidations(this.validateChartDefinition,this.checkChartExists));default:return"Success";}}
handle(cmd){switch(cmd.type){case"CREATE_CHART":this.addFigure(cmd.id,cmd.sheetId,cmd.position,cmd.size);this.addChart(cmd.id,cmd.definition);break;case"UPDATE_CHART":{this.addChart(cmd.id,cmd.definition);break;}
case"DUPLICATE_SHEET":{const sheetFiguresFrom=this.getters.getFigures(cmd.sheetId);for(const fig of sheetFiguresFrom){if(fig.tag==="chart"){const figureIdBase=fig.id.split(FIGURE_ID_SPLITTER).pop();const duplicatedFigureId=`${cmd.sheetIdTo}${FIGURE_ID_SPLITTER}${figureIdBase}`;const chart=this.charts[fig.id]?.copyForSheetId(cmd.sheetIdTo);if(chart){this.dispatch("CREATE_CHART",{id:duplicatedFigureId,position:{x:fig.x,y:fig.y},size:{width:fig.width,height:fig.height},definition:chart.getDefinition(),sheetId:cmd.sheetIdTo,});}}}
break;}
case"DELETE_FIGURE":this.history.update("charts",cmd.id,undefined);break;case"DELETE_SHEET":for(let id of this.getChartIds(cmd.sheetId)){this.history.update("charts",id,undefined);}
break;}}
getContextCreationChart(figureId){return this.charts[figureId]?.getContextCreation();}
getChart(figureId){return this.charts[figureId];}
getChartType(figureId){const type=this.charts[figureId]?.type;if(!type){throw new Error("Chart not defined.");}
return type;}
isChartDefined(figureId){return figureId in this.charts&&this.charts!==undefined;}
getChartIds(sheetId){return Object.entries(this.charts).filter(([,chart])=>chart?.sheetId===sheetId).map(([id])=>id);}
getChartDefinition(figureId){const definition=this.charts[figureId]?.getDefinition();if(!definition){throw new Error(`There is no chart with the given figureId: ${figureId}`);}
return definition;}
import(data){for(let sheet of data.sheets){if(sheet.figures){for(let figure of sheet.figures){if(figure.tag==="chart"){this.charts[figure.id]=this.createChart(figure.id,figure.data,sheet.id);}}}}}
export(data){if(data.sheets){for(let sheet of data.sheets){const sheetFigures=this.getters.getFigures(sheet.id);const figures=[];for(let sheetFigure of sheetFigures){const figure=sheetFigure;if(figure&&figure.tag==="chart"){const data=this.charts[figure.id]?.getDefinition();if(data){figure.data=data;figures.push(figure);}}
else{figures.push(figure);}}
sheet.figures=figures;}}}
addFigure(id,sheetId,position={x:0,y:0},size={width:DEFAULT_FIGURE_WIDTH,height:DEFAULT_FIGURE_HEIGHT,}){if(this.getters.getFigure(sheetId,id)){return;}
const figure={id,x:position.x,y:position.y,width:size.width,height:size.height,tag:"chart",};this.dispatch("CREATE_FIGURE",{sheetId,figure});}
addChart(id,definition){const sheetId=this.getters.getFigureSheetId(id);if(sheetId){this.history.update("charts",id,this.createChart(id,definition,sheetId));}}
checkChartDuplicate(cmd){return this.getters.getFigureSheetId(cmd.id)?"DuplicatedChartId":"Success";}
checkChartExists(cmd){return this.getters.getFigureSheetId(cmd.id)?"Success":"ChartDoesNotExist";}}
function stringToNumber(value){return value===""?NaN:Number(value);}
class ConditionalFormatPlugin extends CorePlugin{static getters=["getConditionalFormats","getRulesSelection","getRulesByCell","getAdaptedCfRanges",];cfRules={};loopThroughRangesOfSheet(sheetId,applyChange){for(const rule of this.cfRules[sheetId]){for(const range of rule.ranges){const change=applyChange(range);switch(change.changeType){case"REMOVE":let copy=rule.ranges.slice();copy.splice(rule.ranges.indexOf(range),1);if(copy.length>=1){this.history.update("cfRules",sheetId,this.cfRules[sheetId].indexOf(rule),"ranges",copy);}
else{this.removeConditionalFormatting(rule.id,sheetId);}
break;case"RESIZE":case"MOVE":case"CHANGE":this.history.update("cfRules",sheetId,this.cfRules[sheetId].indexOf(rule),"ranges",rule.ranges.indexOf(range),change.range);break;}}}}
adaptRanges(applyChange,sheetId){if(sheetId){this.loopThroughRangesOfSheet(sheetId,applyChange);}
else{for(const sheetId of Object.keys(this.cfRules)){this.loopThroughRangesOfSheet(sheetId,applyChange);}}}
allowDispatch(cmd){switch(cmd.type){case"ADD_CONDITIONAL_FORMAT":return this.checkValidations(cmd,this.checkCFRule,this.checkEmptyRange);case"CHANGE_CONDITIONAL_FORMAT_PRIORITY":return this.checkValidPriorityChange(cmd.cfId,cmd.delta,cmd.sheetId);}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.cfRules[cmd.sheetId]=[];break;case"DUPLICATE_SHEET":this.history.update("cfRules",cmd.sheetIdTo,[]);for(const cf of this.getConditionalFormats(cmd.sheetId)){this.addConditionalFormatting(cf,cmd.sheetIdTo);}
break;case"DELETE_SHEET":const cfRules=Object.assign({},this.cfRules);delete cfRules[cmd.sheetId];this.history.update("cfRules",cfRules);break;case"ADD_CONDITIONAL_FORMAT":const cf={...cmd.cf,ranges:cmd.ranges.map((rangeData)=>this.getters.getRangeString(this.getters.getRangeFromRangeData(rangeData),cmd.sheetId)),};this.addConditionalFormatting(cf,cmd.sheetId);break;case"REMOVE_CONDITIONAL_FORMAT":this.removeConditionalFormatting(cmd.id,cmd.sheetId);break;case"CHANGE_CONDITIONAL_FORMAT_PRIORITY":this.changeCFPriority(cmd.cfId,cmd.delta,cmd.sheetId);break;}}
import(data){for(let sheet of data.sheets){this.cfRules[sheet.id]=sheet.conditionalFormats.map((rule)=>this.mapToConditionalFormatInternal(sheet.id,rule));}}
export(data){if(data.sheets){for(let sheet of data.sheets){if(this.cfRules[sheet.id]){sheet.conditionalFormats=this.cfRules[sheet.id].map((rule)=>this.mapToConditionalFormat(sheet.id,rule));}}}}
exportForExcel(data){if(data.sheets){for(let sheet of data.sheets){if(this.cfRules[sheet.id]){sheet.conditionalFormats=this.cfRules[sheet.id].map((rule)=>this.mapToConditionalFormat(sheet.id,rule,{useFixedReference:true}));}}}}
getConditionalFormats(sheetId){return this.cfRules[sheetId]?.map((cf)=>this.mapToConditionalFormat(sheetId,cf))||[];}
getRulesSelection(sheetId,selection){const ruleIds=new Set();selection.forEach((zone)=>{const zoneRuleId=this.getRulesByZone(sheetId,zone);zoneRuleId.forEach((ruleId)=>{ruleIds.add(ruleId);});});return Array.from(ruleIds);}
getRulesByZone(sheetId,zone){const ruleIds=new Set();for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const cellRules=this.getRulesByCell(sheetId,col,row);cellRules.forEach((rule)=>{ruleIds.add(rule.id);});}}
return ruleIds;}
getRulesByCell(sheetId,cellCol,cellRow){const rules=[];for(let cf of this.cfRules[sheetId]){for(let range of cf.ranges){if(isInside(cellCol,cellRow,range.zone)){rules.push(cf);}}}
return new Set(rules.map((rule)=>{return this.mapToConditionalFormat(sheetId,rule);}));}
getAdaptedCfRanges(sheetId,cf,toAdd,toRemove){if(toAdd.length===0&&toRemove.length===0){return;}
const rules=this.getters.getConditionalFormats(sheetId);const replaceIndex=rules.findIndex((c)=>c.id===cf.id);let currentRanges=[];if(replaceIndex>-1){currentRanges=rules[replaceIndex].ranges;}
currentRanges=currentRanges.concat(toAdd);return recomputeZones(currentRanges,toRemove);}
mapToConditionalFormat(sheetId,cf,{useFixedReference}={useFixedReference:false}){return{...cf,ranges:cf.ranges.map((range)=>{return this.getters.getRangeString(range,sheetId,{useFixedReference});}),};}
mapToConditionalFormatInternal(sheet,cf){const conditionalFormat={...cf,ranges:cf.ranges.map((range)=>{return this.getters.getRangeFromSheetXC(sheet,range);}),};return conditionalFormat;}
addConditionalFormatting(cf,sheet){const currentCF=this.cfRules[sheet].slice();const replaceIndex=currentCF.findIndex((c)=>c.id===cf.id);const newCF=this.mapToConditionalFormatInternal(sheet,cf);if(replaceIndex>-1){currentCF.splice(replaceIndex,1,newCF);}
else{currentCF.push(newCF);}
this.history.update("cfRules",sheet,currentCF);}
checkValidPriorityChange(cfId,delta,sheetId){if(!this.cfRules[sheetId])
return"InvalidSheetId";const ruleIndex=this.cfRules[sheetId].findIndex((cf)=>cf.id===cfId);if(ruleIndex===-1)
return"InvalidConditionalFormatId";const cfIndex2=ruleIndex-delta;if(cfIndex2<0||cfIndex2>=this.cfRules[sheetId].length){return"InvalidConditionalFormatId";}
return"Success";}
checkEmptyRange(cmd){return cmd.ranges.length?"Success":"EmptyRange";}
checkCFRule(cmd){const rule=cmd.cf.rule;switch(rule.type){case"CellIsRule":return this.checkValidations(rule,this.checkOperatorArgsNumber(2,["Between","NotBetween"]),this.checkOperatorArgsNumber(1,["BeginsWith","ContainsText","EndsWith","GreaterThan","GreaterThanOrEqual","LessThan","LessThanOrEqual","NotContains",]),this.checkOperatorArgsNumber(0,["IsEmpty","IsNotEmpty"]));case"ColorScaleRule":{return this.checkValidations(rule,this.chainValidations(this.checkThresholds(this.checkFormulaCompilation)),this.chainValidations(this.checkThresholds(this.checkNaN),this.batchValidations(this.checkMinBiggerThanMax,this.checkMinBiggerThanMid,this.checkMidBiggerThanMax)));}
case"IconSetRule":{return this.checkValidations(rule,this.chainValidations(this.checkInflectionPoints(this.checkNaN),this.checkLowerBiggerThanUpper),this.chainValidations(this.checkInflectionPoints(this.checkFormulaCompilation)));}}
return"Success";}
checkOperatorArgsNumber(expectedNumber,operators){if(expectedNumber>2){throw new Error("Checking more than 2 arguments is currently not supported. Add the appropriate CommandResult if you want to.");}
return(rule)=>{if(operators.includes(rule.operator)){const errors=[];const isEmpty=(value)=>value===undefined||value==="";if(expectedNumber>=1&&isEmpty(rule.values[0])){errors.push("FirstArgMissing");}
if(expectedNumber>=2&&isEmpty(rule.values[1])){errors.push("SecondArgMissing");}
return errors.length?errors:"Success";}
return"Success";};}
checkNaN(threshold,thresholdName){if(["number","percentage","percentile"].includes(threshold.type)&&(threshold.value===""||isNaN(threshold.value))){switch(thresholdName){case"min":return"MinNaN";case"max":return"MaxNaN";case"mid":return"MidNaN";case"upperInflectionPoint":return"ValueUpperInflectionNaN";case"lowerInflectionPoint":return"ValueLowerInflectionNaN";}}
return"Success";}
checkFormulaCompilation(threshold,thresholdName){if(threshold.type!=="formula")
return"Success";try{compile(threshold.value||"");}
catch(error){switch(thresholdName){case"min":return"MinInvalidFormula";case"max":return"MaxInvalidFormula";case"mid":return"MidInvalidFormula";case"upperInflectionPoint":return"ValueUpperInvalidFormula";case"lowerInflectionPoint":return"ValueLowerInvalidFormula";}}
return"Success";}
checkThresholds(check){return this.batchValidations((rule)=>check(rule.minimum,"min"),(rule)=>check(rule.maximum,"max"),(rule)=>(rule.midpoint?check(rule.midpoint,"mid"):"Success"));}
checkInflectionPoints(check){return this.batchValidations((rule)=>check(rule.lowerInflectionPoint,"lowerInflectionPoint"),(rule)=>check(rule.upperInflectionPoint,"upperInflectionPoint"));}
checkLowerBiggerThanUpper(rule){const minValue=rule.lowerInflectionPoint.value;const maxValue=rule.upperInflectionPoint.value;if(["number","percentage","percentile"].includes(rule.lowerInflectionPoint.type)&&rule.lowerInflectionPoint.type===rule.upperInflectionPoint.type&&Number(minValue)>Number(maxValue)){return"LowerBiggerThanUpper";}
return"Success";}
checkMinBiggerThanMax(rule){const minValue=rule.minimum.value;const maxValue=rule.maximum.value;if(["number","percentage","percentile"].includes(rule.minimum.type)&&rule.minimum.type===rule.maximum.type&&stringToNumber(minValue)>=stringToNumber(maxValue)){return"MinBiggerThanMax";}
return"Success";}
checkMidBiggerThanMax(rule){const midValue=rule.midpoint?.value;const maxValue=rule.maximum.value;if(rule.midpoint&&["number","percentage","percentile"].includes(rule.midpoint.type)&&rule.midpoint.type===rule.maximum.type&&stringToNumber(midValue)>=stringToNumber(maxValue)){return"MidBiggerThanMax";}
return"Success";}
checkMinBiggerThanMid(rule){const minValue=rule.minimum.value;const midValue=rule.midpoint?.value;if(rule.midpoint&&["number","percentage","percentile"].includes(rule.midpoint.type)&&rule.minimum.type===rule.midpoint.type&&stringToNumber(minValue)>=stringToNumber(midValue)){return"MinBiggerThanMid";}
return"Success";}
removeConditionalFormatting(id,sheet){const cfIndex=this.cfRules[sheet].findIndex((s)=>s.id===id);if(cfIndex!==-1){const currentCF=this.cfRules[sheet].slice();currentCF.splice(cfIndex,1);this.history.update("cfRules",sheet,currentCF);}}
changeCFPriority(cfId,delta,sheetId){const currentIndex=this.cfRules[sheetId].findIndex((s)=>s.id===cfId);const cf=this.cfRules[sheetId][currentIndex];const targetIndex=currentIndex-delta;const cfRules=[...this.cfRules[sheetId]];cfRules.splice(currentIndex,1);cfRules.splice(targetIndex,0,cf);this.history.update("cfRules",sheetId,cfRules);}}
class DataValidationPlugin extends CorePlugin{static getters=["cellHasListDataValidationIcon","getDataValidationRule","getDataValidationRules","getValidationRuleForCell",];rules={};adaptRanges(applyChange,sheetId){const sheetIds=sheetId?[sheetId]:Object.keys(this.rules);for(const sheetId of sheetIds){this.loopThroughRangesOfSheet(sheetId,applyChange);}}
loopThroughRangesOfSheet(sheetId,applyChange){const rules=this.rules[sheetId];for(let ruleIndex=rules.length-1;ruleIndex>=0;ruleIndex--){const rule=this.rules[sheetId][ruleIndex];for(let rangeIndex=rule.ranges.length-1;rangeIndex>=0;rangeIndex--){const range=rule.ranges[rangeIndex];const change=applyChange(range);switch(change.changeType){case"REMOVE":if(rule.ranges.length===1){this.removeDataValidationRule(sheetId,rule.id);}
else{const copy=rule.ranges.slice();copy.splice(rangeIndex,1);this.history.update("rules",sheetId,ruleIndex,"ranges",copy);}
break;case"RESIZE":case"MOVE":case"CHANGE":this.history.update("rules",sheetId,ruleIndex,"ranges",rangeIndex,change.range);break;}}}}
allowDispatch(cmd){switch(cmd.type){case"ADD_DATA_VALIDATION_RULE":return this.checkValidations(cmd,this.chainValidations(this.checkCriterionTypeIsValid,this.checkCriterionHasValidNumberOfValues,this.checkCriterionValuesAreValid));case"REMOVE_DATA_VALIDATION_RULE":if(!this.rules[cmd.sheetId].find((rule)=>rule.id===cmd.id)){return"UnknownDataValidationRule";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("rules",cmd.sheetId,[]);break;case"DUPLICATE_SHEET":{const rules=deepCopy(this.rules[cmd.sheetId]).map((rule)=>({...rule,ranges:rule.ranges.map((range)=>copyRangeWithNewSheetId(cmd.sheetId,cmd.sheetIdTo,range)),}));this.history.update("rules",cmd.sheetIdTo,rules);break;}
case"DELETE_SHEET":{const rules={...this.rules};delete rules[cmd.sheetId];this.history.update("rules",rules);break;}
case"REMOVE_DATA_VALIDATION_RULE":{this.removeDataValidationRule(cmd.sheetId,cmd.id);break;}
case"ADD_DATA_VALIDATION_RULE":{const ranges=cmd.ranges.map((range)=>this.getters.getRangeFromRangeData(range));this.addDataValidationRule(cmd.sheetId,{...cmd.rule,ranges});break;}}}
getDataValidationRules(sheetId){return this.rules[sheetId];}
getDataValidationRule(sheetId,id){return this.rules[sheetId].find((rule)=>rule.id===id);}
getValidationRuleForCell({sheetId,col,row}){if(!this.rules[sheetId]){return undefined;}
for(const rule of this.rules[sheetId]){for(const range of rule.ranges){if(isInside(col,row,range.zone)){return rule;}}}
return undefined;}
cellHasListDataValidationIcon(cellPosition){const rule=this.getValidationRuleForCell(cellPosition);if(!rule)
return false;return((rule.criterion.type==="isValueInList"||rule.criterion.type==="isValueInRange")&&rule.criterion.displayStyle==="arrow");}
addDataValidationRule(sheetId,newRule){const rules=this.rules[sheetId];if(newRule.criterion.type==="isBoolean"){this.setCenterStyleToBooleanCells(newRule);}
else if(newRule.criterion.type==="isValueInList"){newRule.criterion.values=Array.from(new Set(newRule.criterion.values));}
const adaptedRules=this.removeRangesFromRules(sheetId,newRule.ranges,rules);const ruleIndex=adaptedRules.findIndex((rule)=>rule.id===newRule.id);if(ruleIndex!==-1){adaptedRules[ruleIndex]=newRule;this.history.update("rules",sheetId,adaptedRules);}
else{this.history.update("rules",sheetId,[...adaptedRules,newRule]);}}
removeRangesFromRules(sheetId,ranges,rules){rules=deepCopy(rules);const rangesXcs=ranges.map((range)=>this.getters.getRangeString(range,sheetId));for(const rule of rules){const ruleRanges=rule.ranges.map((range)=>this.getters.getRangeString(range,sheetId));rule.ranges=recomputeZones(ruleRanges,rangesXcs).map((xc)=>this.getters.getRangeFromSheetXC(sheetId,xc));}
return rules.filter((rule)=>rule.ranges.length>0);}
removeDataValidationRule(sheetId,ruleId){const rules=this.rules[sheetId];const newRules=rules.filter((rule)=>rule.id!==ruleId);this.history.update("rules",sheetId,newRules);}
setCenterStyleToBooleanCells(rule){for(const position of getCellPositionsInRanges(rule.ranges)){const cell=this.getters.getCell(position);const{sheetId,col,row}=position;const style={...cell?.style,align:cell?.style?.align??"center",verticalAlign:cell?.style?.verticalAlign??"middle",};this.dispatch("UPDATE_CELL",{sheetId,col,row,style});}}
import(data){for(const sheet of data.sheets){this.rules[sheet.id]=[];if(!sheet.dataValidationRules){continue;}
for(const rule of sheet.dataValidationRules){this.rules[sheet.id].push({...rule,ranges:rule.ranges.map((range)=>this.getters.getRangeFromSheetXC(sheet.id,range)),});}}}
export(data){if(!data.sheets){return;}
for(const sheet of data.sheets){sheet.dataValidationRules=[];for(const rule of this.rules[sheet.id]){sheet.dataValidationRules.push({...rule,ranges:rule.ranges.map((range)=>this.getters.getRangeString(range,sheet.id)),});}}}
checkCriterionTypeIsValid(cmd){return dataValidationEvaluatorRegistry.contains(cmd.rule.criterion.type)?"Success":"UnknownDataValidationCriterionType";}
checkCriterionHasValidNumberOfValues(cmd){const criterion=cmd.rule.criterion;const evaluator=dataValidationEvaluatorRegistry.get(criterion.type);const expectedNumberOfValues=evaluator.numberOfValues(criterion);if(expectedNumberOfValues!==undefined&&criterion.values.length!==expectedNumberOfValues){return"InvalidNumberOfCriterionValues";}
return"Success";}
checkCriterionValuesAreValid(cmd){const criterion=cmd.rule.criterion;const evaluator=dataValidationEvaluatorRegistry.get(criterion.type);if(criterion.values.some((value)=>{if(value.startsWith("=")){return evaluator.allowedValues==="onlyLiterals";}
else if(evaluator.allowedValues==="onlyFormulas"){return true;}
else{return!evaluator.isCriterionValueValid(value);}})){return"InvalidDataValidationCriterionValue";}
return"Success";}}
class FigurePlugin extends CorePlugin{static getters=["getFigures","getFigure","getFigureSheetId"];figures={};allowDispatch(cmd){switch(cmd.type){case"CREATE_FIGURE":return this.checkFigureDuplicate(cmd.figure.id);case"UPDATE_FIGURE":case"DELETE_FIGURE":return this.checkFigureExists(cmd.sheetId,cmd.id);default:return"Success";}}
beforeHandle(cmd){switch(cmd.type){case"DELETE_SHEET":this.getters.getFigures(cmd.sheetId).forEach((figure)=>{this.dispatch("DELETE_FIGURE",{id:figure.id,sheetId:cmd.sheetId});});break;}}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.figures[cmd.sheetId]={};break;case"DELETE_SHEET":this.deleteSheet(cmd.sheetId);break;case"CREATE_FIGURE":this.addFigure(cmd.figure,cmd.sheetId);break;case"UPDATE_FIGURE":const{type,sheetId,...update}=cmd;const figure=update;this.updateFigure(sheetId,figure);break;case"DELETE_FIGURE":this.removeFigure(cmd.id,cmd.sheetId);break;case"REMOVE_COLUMNS_ROWS":this.onRowColDelete(cmd.sheetId,cmd.dimension);}}
onRowColDelete(sheetId,dimension){dimension==="ROW"?this.onRowDeletion(sheetId):this.onColDeletion(sheetId);}
onRowDeletion(sheetId){const numHeader=this.getters.getNumberRows(sheetId);let gridHeight=0;for(let i=0;i<numHeader;i++){gridHeight+=this.getters.getUserRowSize(sheetId,i)||DEFAULT_CELL_HEIGHT;}
const figures=this.getters.getFigures(sheetId);for(const figure of figures){const newY=Math.min(figure.y,gridHeight-figure.height);if(newY!==figure.y){this.dispatch("UPDATE_FIGURE",{sheetId,id:figure.id,y:newY});}}}
onColDeletion(sheetId){const numHeader=this.getters.getNumberCols(sheetId);let gridWidth=0;for(let i=0;i<numHeader;i++){gridWidth+=this.getters.getColSize(sheetId,i);}
const figures=this.getters.getFigures(sheetId);for(const figure of figures){const newX=Math.min(figure.x,gridWidth-figure.width);if(newX!==figure.x){this.dispatch("UPDATE_FIGURE",{sheetId,id:figure.id,x:newX});}}}
updateFigure(sheetId,figure){if(!("id"in figure)){return;}
for(const[key,value]of Object.entries(figure)){switch(key){case"x":case"y":if(value!==undefined){this.history.update("figures",sheetId,figure.id,key,Math.max(value,0));}
break;case"width":case"height":if(value!==undefined){this.history.update("figures",sheetId,figure.id,key,value);}
break;}}}
addFigure(figure,sheetId){this.history.update("figures",sheetId,figure.id,figure);}
deleteSheet(sheetId){this.history.update("figures",sheetId,undefined);}
removeFigure(id,sheetId){this.history.update("figures",sheetId,id,undefined);}
checkFigureExists(sheetId,figureId){if(this.figures[sheetId]?.[figureId]===undefined){return"FigureDoesNotExist";}
return"Success";}
checkFigureDuplicate(figureId){if(Object.values(this.figures).find((sheet)=>sheet?.[figureId])){return"DuplicatedFigureId";}
return"Success";}
getFigures(sheetId){return Object.values(this.figures[sheetId]||{}).filter(isDefined$1);}
getFigure(sheetId,figureId){return this.figures[sheetId]?.[figureId];}
getFigureSheetId(figureId){return Object.keys(this.figures).find((sheetId)=>this.figures[sheetId]?.[figureId]!==undefined);}
import(data){for(let sheet of data.sheets){const figures={};sheet.figures.forEach((figure)=>{figures[figure.id]=figure;});this.figures[sheet.id]=figures;}}
export(data){for(const sheet of data.sheets){for(const figure of this.getFigures(sheet.id)){const data=undefined;sheet.figures.push({...figure,data});}}}
exportForExcel(data){this.export(data);}}
class FilterTable{id;zone;filters;constructor(zone){this.filters=[];this.zone=zone;const uuid=new UuidGenerator();this.id=uuid.uuidv4();for(const i of range(zone.left,zone.right+1)){const filterZone={...this.zone,left:i,right:i};this.filters.push(new Filter(uuid.uuidv4(),filterZone));}}
get contentZone(){if(this.zone.bottom===this.zone.top){return undefined;}
return{...this.zone,top:this.zone.top+1};}
getFilterId(col){return this.filters.find((filter)=>filter.col===col)?.id;}
clone(){return new FilterTable(this.zone);}}
class Filter{id;zoneWithHeaders;constructor(id,zone){if(zone.left!==zone.right){throw new Error("Can only define a filter on a single column");}
this.id=id;this.zoneWithHeaders=zone;}
get col(){return this.zoneWithHeaders.left;}
get filteredZone(){const zone=this.zoneWithHeaders;if(zone.bottom===zone.top){return undefined;}
return{...zone,top:zone.top+1};}}
class FiltersPlugin extends CorePlugin{static getters=["doesZonesContainFilter","getFilter","getFilters","getFilterTable","getFilterTables","getFilterTablesInZone","getFilterId","getFilterHeaders","isFilterHeader",];tables={};allowDispatch(cmd){switch(cmd.type){case"CREATE_FILTER_TABLE":if(!areZonesContinuous(...cmd.target)){return"NonContinuousTargets";}
const zone=union(...cmd.target);const checkFilterOverlap=()=>{if(this.getFilterTables(cmd.sheetId).some((filter)=>overlap(filter.zone,zone))){return"FilterOverlap";}
return"Success";};const checkMergeInFilter=()=>{const mergesInTarget=this.getters.getMergesInZone(cmd.sheetId,zone);for(let merge of mergesInTarget){if(overlap(zone,merge)){return"MergeInFilter";}}
return"Success";};return this.checkValidations(cmd,checkFilterOverlap,checkMergeInFilter);case"ADD_MERGE":for(let merge of cmd.target){for(let filterTable of this.getFilterTables(cmd.sheetId)){if(overlap(filterTable.zone,merge)){return"MergeInFilter";}}}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("tables",cmd.sheetId,{});break;case"DELETE_SHEET":const filterTables={...this.tables};delete filterTables[cmd.sheetId];this.history.update("tables",filterTables);break;case"DUPLICATE_SHEET":const tables={};for(const filterTable of Object.values(this.tables[cmd.sheetId]||{})){if(filterTable){const newFilterTable=deepCopy(filterTable);tables[newFilterTable.id]=newFilterTable;}}
this.history.update("tables",cmd.sheetIdTo,tables);break;case"ADD_COLUMNS_ROWS":this.onAddColumnsRows(cmd);break;case"REMOVE_COLUMNS_ROWS":this.onDeleteColumnsRows(cmd);break;case"CREATE_FILTER_TABLE":{const zone=union(...cmd.target);const newFilterTable=this.createFilterTable(zone);this.history.update("tables",cmd.sheetId,newFilterTable.id,newFilterTable);break;}
case"REMOVE_FILTER_TABLE":{const tables={};for(const filterTable of this.getFilterTables(cmd.sheetId)){if(cmd.target.every((zone)=>!intersection(zone,filterTable.zone))){tables[filterTable.id]=filterTable;}}
this.history.update("tables",cmd.sheetId,tables);break;}
case"UPDATE_CELL":{const sheetId=cmd.sheetId;for(let table of this.getFilterTables(sheetId)){if(this.canUpdateCellCmdExtendTable(cmd,table)){this.extendTableDown(sheetId,table);}}
break;}}}
getFilters(sheetId){return this.getFilterTables(sheetId).map((filterTable)=>filterTable.filters).flat();}
getFilterTables(sheetId){return this.tables[sheetId]?Object.values(this.tables[sheetId]).filter(isDefined$1):[];}
getFilter(position){return this.getFilterTable(position)?.filters.find((filter)=>filter.col===position.col);}
getFilterId(position){return this.getFilter(position)?.id;}
getFilterTable({sheetId,col,row}){return this.getFilterTables(sheetId).find((filterTable)=>isInside(col,row,filterTable.zone));}
getFilterTablesInZone(sheetId,zone){return this.getFilterTables(sheetId).filter((filterTable)=>isZoneInside(filterTable.zone,zone));}
doesZonesContainFilter(sheetId,zones){for(const zone of zones){for(const filterTable of this.getFilterTables(sheetId)){if(intersection(zone,filterTable.zone)){return true;}}}
return false;}
getFilterHeaders(sheetId){const headers=[];for(let filterTable of this.getFilterTables(sheetId)){const zone=filterTable.zone;const row=zone.top;for(let col=zone.left;col<=zone.right;col++){headers.push({col,row});}}
return headers;}
isFilterHeader({sheetId,col,row}){const headers=this.getFilterHeaders(sheetId);return headers.some((header)=>header.col===col&&header.row===row);}
onAddColumnsRows(cmd){for(const filterTable of this.getFilterTables(cmd.sheetId)){const zone=expandZoneOnInsertion(filterTable.zone,cmd.dimension==="COL"?"left":"top",cmd.base,cmd.position,cmd.quantity);const filters=[];for(const filter of filterTable.filters){const filterZone=expandZoneOnInsertion(filter.zoneWithHeaders,cmd.dimension==="COL"?"left":"top",cmd.base,cmd.position,cmd.quantity);filters.push(new Filter(filter.id,filterZone));}
if(filters.length<zoneToDimension(zone).numberOfCols){for(let col=zone.left;col<=zone.right;col++){if(!filters.find((filter)=>filter.col===col)){filters.push(new Filter(this.uuidGenerator.uuidv4(),{...zone,left:col,right:col}));}}
filters.sort((f1,f2)=>f1.col-f2.col);}
this.history.update("tables",cmd.sheetId,filterTable.id,"zone",zone);this.history.update("tables",cmd.sheetId,filterTable.id,"filters",filters);}}
onDeleteColumnsRows(cmd){for(const table of this.getFilterTables(cmd.sheetId)){if(cmd.dimension==="ROW"&&cmd.elements.includes(table.zone.top)){const tables={...this.tables[cmd.sheetId]};delete tables[table.id];this.history.update("tables",cmd.sheetId,tables);continue;}
const zone=reduceZoneOnDeletion(table.zone,cmd.dimension==="COL"?"left":"top",cmd.elements);if(!zone){const tables={...this.tables[cmd.sheetId]};delete tables[table.id];this.history.update("tables",cmd.sheetId,tables);}
else{if(zoneToXc(zone)!==zoneToXc(table.zone)){const filters=[];for(const filter of table.filters){const newFilterZone=reduceZoneOnDeletion(filter.zoneWithHeaders,cmd.dimension==="COL"?"left":"top",cmd.elements);if(newFilterZone){filters.push(new Filter(filter.id,newFilterZone));}}
this.history.update("tables",cmd.sheetId,table.id,"zone",zone);this.history.update("tables",cmd.sheetId,table.id,"filters",filters);}}}}
createFilterTable(zone){return new FilterTable(zone);}
extendTableDown(sheetId,table){const newZone={...table.zone,bottom:table.zone.bottom+1};this.history.update("tables",sheetId,table.id,"zone",newZone);for(let filterIndex=0;filterIndex<table.filters.length;filterIndex++){const filter=table.filters[filterIndex];const newFilterZone={...filter.zoneWithHeaders,bottom:filter.zoneWithHeaders.bottom+1,};this.history.update("tables",sheetId,table.id,"filters",filterIndex,"zoneWithHeaders",newFilterZone);}
return;}
canUpdateCellCmdExtendTable({content:newCellContent,sheetId,col,row},table){if(!newCellContent){return;}
const zone=table.zone;if(!(zone.bottom+1===row&&col>=zone.left&&col<=zone.right)){return false;}
for(const col of range(zone.left,zone.right+1)){const position={sheetId,col,row};const cellContent=this.getters.getCell(position)?.content;if(cellContent){return false;}
if(this.getters.getFilter(position)){return false;}
if(this.getters.isInMerge(position)){return false;}}
return true;}
import(data){for(const sheet of data.sheets){for(const filterTableData of sheet.filterTables||[]){const table=this.createFilterTable(toZone(filterTableData.range));this.history.update("tables",sheet.id,table.id,table);}}}
export(data){for(const sheet of data.sheets){for(const filterTable of this.getFilterTables(sheet.id)){sheet.filterTables.push({range:zoneToXc(filterTable.zone),});}}}
exportForExcel(data){for(const sheet of data.sheets){for(const filterTable of this.getFilterTables(sheet.id)){if(zoneToDimension(filterTable.zone).numberOfRows===1){continue;}
sheet.filterTables.push({range:zoneToXc(filterTable.zone),filters:[],});}}}}
class HeaderSizePlugin extends CorePlugin{static getters=["getUserRowSize","getColSize"];sizes={};handle(cmd){switch(cmd.type){case"CREATE_SHEET":{this.history.update("sizes",cmd.sheetId,{COL:[],ROW:[]});break;}
case"DUPLICATE_SHEET":this.history.update("sizes",cmd.sheetIdTo,deepCopy(this.sizes[cmd.sheetId]));break;case"DELETE_SHEET":const sizes={...this.sizes};delete sizes[cmd.sheetId];this.history.update("sizes",sizes);break;case"REMOVE_COLUMNS_ROWS":{const arr=this.sizes[cmd.sheetId][cmd.dimension];const sizes=removeIndexesFromArray(arr,cmd.elements);this.history.update("sizes",cmd.sheetId,cmd.dimension,sizes);break;}
case"ADD_COLUMNS_ROWS":{let sizes=[...this.sizes[cmd.sheetId][cmd.dimension]];const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);const baseSize=sizes[cmd.base];sizes.splice(addIndex,0,...Array(cmd.quantity).fill(baseSize));this.history.update("sizes",cmd.sheetId,cmd.dimension,sizes);break;}
case"RESIZE_COLUMNS_ROWS":if(cmd.dimension==="ROW"){for(const el of cmd.elements){this.history.update("sizes",cmd.sheetId,cmd.dimension,el,cmd.size||undefined);}}
else{for(const el of cmd.elements){this.history.update("sizes",cmd.sheetId,cmd.dimension,el,cmd.size||undefined);}}
break;}
return;}
getColSize(sheetId,index){return Math.round(this.sizes[sheetId]?.["COL"][index]||DEFAULT_CELL_WIDTH);}
getUserRowSize(sheetId,index){const rowSize=this.sizes[sheetId]?.["ROW"][index];return rowSize?Math.round(rowSize):undefined;}
import(data){for(let sheet of data.sheets){const sizes={COL:Array(sheet.colNumber).fill(undefined),ROW:Array(sheet.rowNumber).fill(undefined),};for(let[rowIndex,row]of Object.entries(sheet.rows)){if(row.size){sizes["ROW"][rowIndex]=row.size;}}
for(let[colIndex,col]of Object.entries(sheet.cols)){if(col.size){sizes["COL"][colIndex]=col.size;}}
this.sizes[sheet.id]=sizes;}
return;}
exportForExcel(data){this.exportData(data,true);}
export(data){this.exportData(data);}
exportData(data,exportDefaults=false){for(let sheet of data.sheets){if(sheet.rows===undefined){sheet.rows={};}
for(const row of range(0,this.getters.getNumberRows(sheet.id))){if(exportDefaults||this.sizes[sheet.id]["ROW"][row]){sheet.rows[row]={...sheet.rows[row],size:this.getUserRowSize(sheet.id,row)??DEFAULT_CELL_HEIGHT,};}}
if(sheet.cols===undefined){sheet.cols={};}
for(let col of range(0,this.getters.getNumberCols(sheet.id))){if(exportDefaults||this.sizes[sheet.id]["COL"][col]){sheet.cols[col]={...sheet.cols[col],size:this.getColSize(sheet.id,col)};}}}}}
class HeaderVisibilityPlugin extends CorePlugin{static getters=["checkElementsIncludeAllVisibleHeaders","getHiddenColsGroups","getHiddenRowsGroups","isHeaderHiddenByUser","isRowHiddenByUser","isColHiddenByUser",];hiddenHeaders={};allowDispatch(cmd){switch(cmd.type){case"HIDE_COLUMNS_ROWS":{if(!this.getters.tryGetSheet(cmd.sheetId)){return"InvalidSheetId";}
const hiddenGroup=cmd.dimension==="COL"?this.getHiddenColsGroups(cmd.sheetId):this.getHiddenRowsGroups(cmd.sheetId);const elements=cmd.dimension==="COL"?this.getters.getNumberCols(cmd.sheetId):this.getters.getNumberRows(cmd.sheetId);const hiddenElements=new Set((hiddenGroup||[]).flat().concat(cmd.elements));if(hiddenElements.size>=elements){return"TooManyHiddenElements";}
else if(largeMin(cmd.elements)<0||largeMax(cmd.elements)>elements){return"InvalidHeaderIndex";}
else{return"Success";}}
case"REMOVE_COLUMNS_ROWS":if(!this.getters.tryGetSheet(cmd.sheetId)){return"InvalidSheetId";}
if(this.checkElementsIncludeAllVisibleHeaders(cmd.sheetId,cmd.dimension,cmd.elements)){return"NotEnoughElements";}
return"Success";}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":const hiddenHeaders={COL:Array(this.getters.getNumberCols(cmd.sheetId)).fill(false),ROW:Array(this.getters.getNumberRows(cmd.sheetId)).fill(false),};this.history.update("hiddenHeaders",cmd.sheetId,hiddenHeaders);break;case"DUPLICATE_SHEET":this.history.update("hiddenHeaders",cmd.sheetIdTo,deepCopy(this.hiddenHeaders[cmd.sheetId]));break;case"DELETE_SHEET":this.history.update("hiddenHeaders",cmd.sheetId,undefined);break;case"REMOVE_COLUMNS_ROWS":{const hiddenHeaders=[...this.hiddenHeaders[cmd.sheetId][cmd.dimension]];for(let el of[...cmd.elements].sort((a,b)=>b-a)){hiddenHeaders.splice(el,1);}
this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,hiddenHeaders);break;}
case"ADD_COLUMNS_ROWS":{const hiddenHeaders=[...this.hiddenHeaders[cmd.sheetId][cmd.dimension]];const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);hiddenHeaders.splice(addIndex,0,...Array(cmd.quantity).fill(false));this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,hiddenHeaders);break;}
case"HIDE_COLUMNS_ROWS":for(let el of cmd.elements){this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,el,true);}
break;case"UNHIDE_COLUMNS_ROWS":for(let el of cmd.elements){this.history.update("hiddenHeaders",cmd.sheetId,cmd.dimension,el,false);}
break;}
return;}
checkElementsIncludeAllVisibleHeaders(sheetId,dimension,elements){const visibleHeaders=this.getAllVisibleHeaders(sheetId,dimension);return includesAll(elements,visibleHeaders);}
isHeaderHiddenByUser(sheetId,dimension,index){return dimension==="COL"?this.isColHiddenByUser(sheetId,index):this.isRowHiddenByUser(sheetId,index);}
isRowHiddenByUser(sheetId,index){return this.hiddenHeaders[sheetId].ROW[index]||this.getters.isRowFolded(sheetId,index);}
isColHiddenByUser(sheetId,index){return this.hiddenHeaders[sheetId].COL[index]||this.getters.isColFolded(sheetId,index);}
getHiddenColsGroups(sheetId){const consecutiveIndexes=[[]];const hiddenCols=this.hiddenHeaders[sheetId].COL;for(let col=0;col<hiddenCols.length;col++){const isColHidden=hiddenCols[col];if(isColHidden){consecutiveIndexes[consecutiveIndexes.length-1].push(col);}
else{if(consecutiveIndexes[consecutiveIndexes.length-1].length!==0){consecutiveIndexes.push([]);}}}
if(consecutiveIndexes[consecutiveIndexes.length-1].length===0){consecutiveIndexes.pop();}
return consecutiveIndexes;}
getHiddenRowsGroups(sheetId){const consecutiveIndexes=[[]];const hiddenCols=this.hiddenHeaders[sheetId].ROW;for(let row=0;row<hiddenCols.length;row++){const isRowHidden=hiddenCols[row];if(isRowHidden){consecutiveIndexes[consecutiveIndexes.length-1].push(row);}
else{if(consecutiveIndexes[consecutiveIndexes.length-1].length!==0){consecutiveIndexes.push([]);}}}
if(consecutiveIndexes[consecutiveIndexes.length-1].length===0){consecutiveIndexes.pop();}
return consecutiveIndexes;}
getAllVisibleHeaders(sheetId,dimension){const headers=range(0,this.getters.getNumberHeaders(sheetId,dimension));const foldedHeaders=[];this.getters.getHeaderGroups(sheetId,dimension).forEach((group)=>{if(group.isFolded){foldedHeaders.push(...range(group.start,group.end+1));}});return headers.filter((i)=>{return!this.hiddenHeaders[sheetId][dimension][i]&&!foldedHeaders.includes(i);});}
import(data){for(let sheet of data.sheets){this.hiddenHeaders[sheet.id]={COL:[],ROW:[]};for(let row=0;row<sheet.rowNumber;row++){this.hiddenHeaders[sheet.id].ROW[row]=Boolean(sheet.rows[row]?.isHidden);}
for(let col=0;col<sheet.colNumber;col++){this.hiddenHeaders[sheet.id].COL[col]=Boolean(sheet.cols[col]?.isHidden);}}
return;}
exportForExcel(data){this.exportData(data,true);}
export(data){this.exportData(data);}
exportData(data,exportDefaults=false){for(let sheet of data.sheets){if(sheet.rows===undefined){sheet.rows={};}
for(let row=0;row<this.getters.getNumberRows(sheet.id);row++){if(exportDefaults||this.hiddenHeaders[sheet.id]["ROW"][row]){if(sheet.rows[row]===undefined){sheet.rows[row]={};}
sheet.rows[row].isHidden=this.hiddenHeaders[sheet.id]["ROW"][row];}}
if(sheet.cols===undefined){sheet.cols={};}
for(let col=0;col<this.getters.getNumberCols(sheet.id);col++){if(exportDefaults||this.hiddenHeaders[sheet.id]["COL"][col]){if(sheet.cols[col]===undefined){sheet.cols[col]={};}
sheet.cols[col].isHidden=this.hiddenHeaders[sheet.id]["COL"][col];}}}}}
class ImagePlugin extends CorePlugin{static getters=["getImage","getImagePath","getImageSize"];fileStore;images={};syncedImages=new Set();constructor(config){super(config);this.fileStore=config.external.fileStore;}
allowDispatch(cmd){switch(cmd.type){case"CREATE_IMAGE":if(this.getters.getFigure(cmd.sheetId,cmd.figureId)){return"InvalidFigureId";}
return"Success";default:return"Success";}}
handle(cmd){switch(cmd.type){case"CREATE_IMAGE":this.addImage(cmd.figureId,cmd.sheetId,cmd.position,cmd.size);this.history.update("images",cmd.sheetId,cmd.figureId,cmd.definition);this.syncedImages.add(cmd.definition.path);break;case"DUPLICATE_SHEET":{const sheetFiguresFrom=this.getters.getFigures(cmd.sheetId);for(const fig of sheetFiguresFrom){if(fig.tag==="image"){const figureIdBase=fig.id.split(FIGURE_ID_SPLITTER).pop();const duplicatedFigureId=`${cmd.sheetIdTo}${FIGURE_ID_SPLITTER}${figureIdBase}`;const image=this.getImage(fig.id);if(image){const size={width:fig.width,height:fig.height};this.dispatch("CREATE_IMAGE",{sheetId:cmd.sheetIdTo,figureId:duplicatedFigureId,position:{x:fig.x,y:fig.y},size,definition:deepCopy(image),});}}}
break;}
case"DELETE_FIGURE":this.history.update("images",cmd.sheetId,cmd.id,undefined);break;case"DELETE_SHEET":this.history.update("images",cmd.sheetId,undefined);break;}}
garbageCollectExternalResources(){const images=new Set(this.getAllImages().map((image)=>image.path));for(const path of this.syncedImages){if(!images.has(path)){this.fileStore?.delete(path);}}}
getImage(figureId){for(const sheet of Object.values(this.images)){if(sheet&&sheet[figureId]){return sheet[figureId];}}
throw new Error(`There is no image with the given figureId: ${figureId}`);}
getImagePath(figureId){return this.getImage(figureId).path;}
getImageSize(figureId){return this.getImage(figureId).size;}
addImage(id,sheetId,position,size){const figure={id,x:position.x,y:position.y,width:size.width,height:size.height,tag:"image",};this.dispatch("CREATE_FIGURE",{sheetId,figure});}
import(data){for(const sheet of data.sheets){const images=(sheet.figures||[]).filter((figure)=>figure.tag==="image");for(const image of images){this.history.update("images",sheet.id,image.id,image.data);this.syncedImages.add(image.data.path);}}}
export(data){for(const sheet of data.sheets){const images=sheet.figures.filter((figure)=>figure.tag==="image");for(const image of images){image.data=this.images[sheet.id]?.[image.id];}}}
exportForExcel(data){for(const sheet of data.sheets){if(!sheet.images){sheet.images=[];}
const figures=this.getters.getFigures(sheet.id);const images=[];for(const figure of figures){if(figure?.tag==="image"){const image=this.getImage(figure.id);if(image){images.push({...figure,data:deepCopy(image),});}}}
sheet.images=[...sheet.images,...images];}}
getAllImages(){const images=[];for(const sheetId in this.images){images.push(...Object.values(this.images[sheetId]||{}).filter(isDefined$1));}
return images;}}
class MergePlugin extends CorePlugin{static getters=["isInMerge","isInSameMerge","isMergeHidden","getMainCellPosition","getBottomLeftCell","expandZone","doesIntersectMerge","doesColumnsHaveCommonMerges","doesRowsHaveCommonMerges","getMerges","getMerge","getMergesInZone","isSingleCellOrMerge","getSelectionRangeString","isMainCellPosition",];nextId=1;merges={};mergeCellMap={};allowDispatch(cmd){const force="force"in cmd?!!cmd.force:false;switch(cmd.type){case"ADD_MERGE":if(force){return this.checkValidations(cmd,this.checkFrozenPanes);}
return this.checkValidations(cmd,this.checkDestructiveMerge,this.checkOverlap,this.checkFrozenPanes);case"UPDATE_CELL":return this.checkMergedContentUpdate(cmd);case"REMOVE_MERGE":return this.checkMergeExists(cmd);default:return"Success";}}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("merges",cmd.sheetId,{});this.history.update("mergeCellMap",cmd.sheetId,{});break;case"DELETE_SHEET":this.history.update("merges",cmd.sheetId,{});this.history.update("mergeCellMap",cmd.sheetId,{});break;case"DUPLICATE_SHEET":const merges=this.merges[cmd.sheetId];if(!merges)
break;for(const range of Object.values(merges).filter(isDefined$1)){this.addMerge(cmd.sheetIdTo,range.zone);}
break;case"ADD_MERGE":for(const zone of cmd.target){this.addMerge(cmd.sheetId,zone);}
break;case"REMOVE_MERGE":for(const zone of cmd.target){this.removeMerge(cmd.sheetId,zone);}
break;}}
adaptRanges(applyChange,sheetId){const sheetIds=sheetId?[sheetId]:Object.keys(this.merges);for(const sheetId of sheetIds){this.applyRangeChangeOnSheet(sheetId,applyChange);}}
getMerges(sheetId){return Object.keys(this.merges[sheetId]||{}).map((mergeId)=>this.getMergeById(sheetId,parseInt(mergeId,10))).filter(isDefined$1);}
getMerge({sheetId,col,row}){const sheetMap=this.mergeCellMap[sheetId];const mergeId=sheetMap?col in sheetMap&&sheetMap[col]?.[row]:undefined;return mergeId?this.getMergeById(sheetId,mergeId):undefined;}
getMergesInZone(sheetId,zone){const sheetMap=this.mergeCellMap[sheetId];if(!sheetMap)
return[];const mergeIds=new Set();for(const{col,row}of positions(zone)){const mergeId=sheetMap[col]?.[row];if(mergeId){mergeIds.add(mergeId);}}
return Array.from(mergeIds).map((mergeId)=>this.getMergeById(sheetId,mergeId)).filter(isDefined$1);}
getSelectionRangeString(range,forSheetId){const rangeImpl=RangeImpl.fromRange(range,this.getters);const expandedZone=this.getters.expandZone(rangeImpl.sheetId,rangeImpl.zone);const expandedRange=rangeImpl.clone({zone:{...expandedZone,bottom:rangeImpl.isFullCol?undefined:expandedZone.bottom,right:rangeImpl.isFullRow?undefined:expandedZone.right,},});const rangeString=this.getters.getRangeString(expandedRange,forSheetId);if(this.isSingleCellOrMerge(rangeImpl.sheetId,rangeImpl.zone)){const{sheetName,xc}=splitReference(rangeString);return`${sheetName !== undefined ? getCanonicalSheetName(sheetName) + "!" : ""}${xc.split(":")[0]}`;}
return rangeString;}
doesIntersectMerge(sheetId,zone){for(const merge of this.getMerges(sheetId)){if(overlap(zone,merge)){return true;}}
return false;}
doesColumnsHaveCommonMerges(sheetId,colA,colB){const sheet=this.getters.getSheet(sheetId);for(let row=0;row<this.getters.getNumberRows(sheetId);row++){if(this.isInSameMerge(sheet.id,colA,row,colB,row)){return true;}}
return false;}
doesRowsHaveCommonMerges(sheetId,rowA,rowB){const sheet=this.getters.getSheet(sheetId);for(let col=0;col<=this.getters.getNumberCols(sheetId);col++){if(this.isInSameMerge(sheet.id,col,rowA,col,rowB)){return true;}}
return false;}
expandZone(sheetId,zone){let{left,right,top,bottom}=zone;let result={left,right,top,bottom};for(let id in this.merges[sheetId]){const merge=this.getMergeById(sheetId,parseInt(id));if(merge&&overlap(merge,result)){result=union(merge,result);}}
return isEqual(result,zone)?result:this.expandZone(sheetId,result);}
isInSameMerge(sheetId,colA,rowA,colB,rowB){const mergeA=this.getMerge({sheetId,col:colA,row:rowA});const mergeB=this.getMerge({sheetId,col:colB,row:rowB});if(!mergeA||!mergeB){return false;}
return isEqual(mergeA,mergeB);}
isInMerge({sheetId,col,row}){const sheetMap=this.mergeCellMap[sheetId];return sheetMap?col in sheetMap&&Boolean(sheetMap[col]?.[row]):false;}
getMainCellPosition(position){if(!this.isInMerge(position)){return position;}
const mergeTopLeftPos=this.getMerge(position).topLeft;return{sheetId:position.sheetId,col:mergeTopLeftPos.col,row:mergeTopLeftPos.row};}
getBottomLeftCell(position){if(!this.isInMerge(position)){return position;}
const{bottom,left}=this.getMerge(position);return{sheetId:position.sheetId,col:left,row:bottom};}
isMergeHidden(sheetId,merge){const hiddenColsGroups=this.getters.getHiddenColsGroups(sheetId);const hiddenRowsGroups=this.getters.getHiddenRowsGroups(sheetId);for(let group of hiddenColsGroups){if(merge.left>=group[0]&&merge.right<=group[group.length-1]){return true;}}
for(let group of hiddenRowsGroups){if(merge.top>=group[0]&&merge.bottom<=group[group.length-1]){return true;}}
return false;}
isSingleCellOrMerge(sheetId,zone){const merge=this.getMerge({sheetId,col:zone.left,row:zone.top});if(merge){return isEqual(zone,merge);}
const{numberOfCols,numberOfRows}=zoneToDimension(zone);return numberOfCols===1&&numberOfRows===1;}
isMainCellPosition(position){return deepEquals(this.getMainCellPosition(position),position);}
isMergeDestructive(sheetId,zone){let{left,right,top,bottom}=zone;right=clip(right,0,this.getters.getNumberCols(sheetId)-1);bottom=clip(bottom,0,this.getters.getNumberRows(sheetId)-1);for(let row=top;row<=bottom;row++){for(let col=left;col<=right;col++){if(col!==left||row!==top){const cell=this.getters.getCell({sheetId,col,row});if(cell&&cell.content!==""){return true;}}}}
return false;}
getMergeById(sheetId,mergeId){const range=this.merges[sheetId]?.[mergeId];return range!==undefined?rangeToMerge(mergeId,range):undefined;}
checkDestructiveMerge({sheetId,target}){const sheet=this.getters.tryGetSheet(sheetId);if(!sheet)
return"Success";const isDestructive=target.some((zone)=>this.isMergeDestructive(sheetId,zone));return isDestructive?"MergeIsDestructive":"Success";}
checkOverlap({target}){for(const zone of target){for(const zone2 of target){if(zone!==zone2&&overlap(zone,zone2)){return"MergeOverlap";}}}
return"Success";}
checkFrozenPanes({sheetId,target}){const sheet=this.getters.tryGetSheet(sheetId);if(!sheet)
return"Success";const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);for(const zone of target){if((zone.left<xSplit&&zone.right>=xSplit)||(zone.top<ySplit&&zone.bottom>=ySplit)){return"FrozenPaneOverlap";}}
return"Success";}
checkMergedContentUpdate(cmd){const{col,row,content}=cmd;if(content===undefined){return"Success";}
const{col:mainCol,row:mainRow}=this.getMainCellPosition(cmd);if(mainCol===col&&mainRow===row){return"Success";}
return"CellIsMerged";}
checkMergeExists(cmd){const{sheetId,target}=cmd;for(const zone of target){const{left,top}=zone;const merge=this.getMerge({sheetId,col:left,row:top});if(merge===undefined||!isEqual(zone,merge)){return"InvalidTarget";}}
return"Success";}
addMerge(sheetId,zone){let{left,right,top,bottom}=zone;right=clip(right,0,this.getters.getNumberCols(sheetId)-1);bottom=clip(bottom,0,this.getters.getNumberRows(sheetId)-1);const tl=toXC(left,top);const br=toXC(right,bottom);if(tl===br){return;}
const topLeft=this.getters.getCell({sheetId,col:left,row:top});let id=this.nextId++;this.history.update("merges",sheetId,id,this.getters.getRangeFromSheetXC(sheetId,zoneToXc({left,top,right,bottom})));let previousMerges=new Set();for(let row=top;row<=bottom;row++){for(let col=left;col<=right;col++){if(col!==left||row!==top){this.dispatch("UPDATE_CELL",{sheetId,col,row,style:topLeft?topLeft.style:null,content:"",});}
const merge=this.getMerge({sheetId,col,row});if(merge){previousMerges.add(merge.id);}
this.history.update("mergeCellMap",sheetId,col,row,id);}}
for(let mergeId of previousMerges){const{top,bottom,left,right}=this.getMergeById(sheetId,mergeId);for(let row=top;row<=bottom;row++){for(let col=left;col<=right;col++){const position={sheetId,col,row};const merge=this.getMerge(position);if(!merge||merge.id!==id){this.history.update("mergeCellMap",sheetId,col,row,undefined);this.dispatch("CLEAR_CELL",position);}}}
this.history.update("merges",sheetId,mergeId,undefined);}}
removeMerge(sheetId,zone){const{left,top,bottom,right}=zone;const merge=this.getMerge({sheetId,col:left,row:top});if(merge===undefined||!isEqual(zone,merge)){return;}
this.history.update("merges",sheetId,merge.id,undefined);for(let r=top;r<=bottom;r++){for(let c=left;c<=right;c++){this.history.update("mergeCellMap",sheetId,c,r,undefined);}}}
applyRangeChangeOnSheet(sheetId,applyChange){const merges=Object.entries(this.merges[sheetId]||{});for(const[mergeId,range]of merges){if(range){const currentZone=range.zone;const result=applyChange(range);switch(result.changeType){case"NONE":break;case"REMOVE":this.removeMerge(sheetId,currentZone);break;default:const{numberOfCols,numberOfRows}=zoneToDimension(result.range.zone);if(numberOfCols===1&&numberOfRows===1){this.removeMerge(sheetId,currentZone);}
else{this.history.update("merges",sheetId,parseInt(mergeId,10),result.range);}
break;}}}
this.history.update("mergeCellMap",sheetId,{});for(const merge of this.getMerges(sheetId)){for(const{col,row}of positions(merge)){this.history.update("mergeCellMap",sheetId,col,row,merge.id);}}}
import(data){const sheets=data.sheets||[];for(let sheetData of sheets){this.history.update("merges",sheetData.id,{});this.history.update("mergeCellMap",sheetData.id,{});if(sheetData.merges){this.importMerges(sheetData.id,sheetData.merges);}}}
importMerges(sheetId,merges){for(let merge of merges){this.addMerge(sheetId,toZone(merge));}}
export(data){for(let sheetData of data.sheets){const merges=this.merges[sheetData.id];if(merges){sheetData.merges.push(...exportMerges(merges));}}}
exportForExcel(data){this.export(data);}}
function exportMerges(merges){return Object.entries(merges).map(([mergeId,range])=>(range?rangeToMerge(parseInt(mergeId,10),range):undefined)).filter(isDefined$1).map((merge)=>toXC(merge.left,merge.top)+":"+toXC(merge.right,merge.bottom));}
function rangeToMerge(mergeId,range){return{...range.zone,topLeft:{col:range.zone.left,row:range.zone.top},id:mergeId,};}
class RangeAdapter{getters;providers=[];constructor(getters){this.getters=getters;}
static getters=["getRangeString","getRangeFromSheetXC","createAdaptedRanges","getRangeDataFromXc","getRangeDataFromZone","getRangeFromRangeData","getRangeFromZone",];allowDispatch(cmd){if(cmd.type==="MOVE_RANGES"){return cmd.target.length===1?"Success":"InvalidZones";}
return"Success";}
beforeHandle(command){}
handle(cmd){switch(cmd.type){case"REMOVE_COLUMNS_ROWS":{let start=cmd.dimension==="COL"?"left":"top";let end=cmd.dimension==="COL"?"right":"bottom";let dimension=cmd.dimension==="COL"?"columns":"rows";const elements=[...cmd.elements];elements.sort((a,b)=>b-a);const groups=groupConsecutive(elements);this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId){return{changeType:"NONE"};}
let newRange=range;let changeType="NONE";for(let group of groups){const min=largeMin(group);const max=largeMax(group);if(range.zone[start]<=min&&min<=range.zone[end]){const toRemove=Math.min(range.zone[end],max)-min+1;changeType="RESIZE";newRange=this.createAdaptedRange(newRange,dimension,changeType,-toRemove);}
else if(range.zone[start]>=min&&range.zone[end]<=max){changeType="REMOVE";newRange=range.clone({...this.getInvalidRange()});}
else if(range.zone[start]<=max&&range.zone[end]>=max){const toRemove=max-range.zone[start]+1;changeType="RESIZE";newRange=this.createAdaptedRange(newRange,dimension,changeType,-toRemove);newRange=this.createAdaptedRange(newRange,dimension,"MOVE",-(range.zone[start]-min));}
else if(min<range.zone[start]){changeType="MOVE";newRange=this.createAdaptedRange(newRange,dimension,changeType,-(max-min+1));}}
if(changeType!=="NONE"){return{changeType,range:newRange};}
return{changeType:"NONE"};},cmd.sheetId);break;}
case"ADD_COLUMNS_ROWS":{let start=cmd.dimension==="COL"?"left":"top";let end=cmd.dimension==="COL"?"right":"bottom";let dimension=cmd.dimension==="COL"?"columns":"rows";this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId){return{changeType:"NONE"};}
if(cmd.position==="after"){if(range.zone[start]<=cmd.base&&cmd.base<range.zone[end]){return{changeType:"RESIZE",range:this.createAdaptedRange(range,dimension,"RESIZE",cmd.quantity),};}
if(cmd.base<range.zone[start]){return{changeType:"MOVE",range:this.createAdaptedRange(range,dimension,"MOVE",cmd.quantity),};}}
else{if(range.zone[start]<cmd.base&&cmd.base<=range.zone[end]){return{changeType:"RESIZE",range:this.createAdaptedRange(range,dimension,"RESIZE",cmd.quantity),};}
if(cmd.base<=range.zone[start]){return{changeType:"MOVE",range:this.createAdaptedRange(range,dimension,"MOVE",cmd.quantity),};}}
return{changeType:"NONE"};},cmd.sheetId);break;}
case"DELETE_SHEET":{this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId){return{changeType:"NONE"};}
const invalidSheetName=this.getters.getSheetName(cmd.sheetId);range=range.clone({...this.getInvalidRange(),invalidSheetName,});return{changeType:"REMOVE",range};},cmd.sheetId);break;}
case"RENAME_SHEET":{this.executeOnAllRanges((range)=>{if(range.sheetId===cmd.sheetId){return{changeType:"CHANGE",range};}
if(cmd.name&&range.invalidSheetName===cmd.name){const invalidSheetName=undefined;const sheetId=cmd.sheetId;const newRange=range.clone({sheetId,invalidSheetName});return{changeType:"CHANGE",range:newRange};}
return{changeType:"NONE"};});break;}
case"MOVE_RANGES":{const originZone=cmd.target[0];this.executeOnAllRanges((range)=>{if(range.sheetId!==cmd.sheetId||!isZoneInside(range.zone,originZone)){return{changeType:"NONE"};}
const targetSheetId=cmd.targetSheetId;const offsetX=cmd.col-originZone.left;const offsetY=cmd.row-originZone.top;const adaptedRange=this.createAdaptedRange(range,"both","MOVE",[offsetX,offsetY]);const prefixSheet=cmd.sheetId===targetSheetId?adaptedRange.prefixSheet:true;return{changeType:"MOVE",range:adaptedRange.clone({sheetId:targetSheetId,prefixSheet}),};});break;}}}
finalize(){}
verifyRangeRemoved(adaptRange){return(range)=>{const result=adaptRange(range);if(result.changeType!=="NONE"&&!isZoneValid(result.range.zone)){return{range:result.range,changeType:"REMOVE"};}
return result;};}
createAdaptedRange(range,dimension,operation,by){const zone=createAdaptedZone(range.unboundedZone,dimension,operation,by);const adaptedRange=range.clone({zone});return adaptedRange;}
executeOnAllRanges(adaptRange,sheetId){const func=this.verifyRangeRemoved(adaptRange);for(const provider of this.providers){provider(func,sheetId);}}
addRangeProvider(provider){this.providers.push(provider);}
createAdaptedRanges(ranges,offsetX,offsetY,sheetId){const rangesImpl=ranges.map((range)=>RangeImpl.fromRange(range,this.getters));return rangesImpl.map((range)=>{if(!isZoneValid(range.zone)){return range;}
const copySheetId=range.prefixSheet?range.sheetId:sheetId;const unboundZone={...range.unboundedZone,left:range.isFullRow&&!range.unboundedZone.hasHeader?range.unboundedZone.left:range.unboundedZone.left+(range.parts[0].colFixed?0:offsetX),right:range.isFullRow?range.unboundedZone.right:range.unboundedZone.right+
((range.parts[1]||range.parts[0]).colFixed?0:offsetX),top:range.isFullCol&&!range.unboundedZone.hasHeader?range.unboundedZone.top:range.unboundedZone.top+(range.parts[0].rowFixed?0:offsetY),bottom:range.isFullCol?range.unboundedZone.bottom:range.unboundedZone.bottom+
((range.parts[1]||range.parts[0]).rowFixed?0:offsetY),};return range.clone({sheetId:copySheetId,zone:unboundZone}).orderZone();});}
getRangeFromSheetXC(defaultSheetId,sheetXC){if(!rangeReference.test(sheetXC)){return new RangeImpl({sheetId:"",zone:{left:-1,top:-1,right:-1,bottom:-1},parts:[],invalidXc:sheetXC,prefixSheet:false,},this.getters.getSheetSize);}
let sheetName;let xc=sheetXC;let prefixSheet=false;if(sheetXC.includes("!")){({xc,sheetName}=splitReference(sheetXC));if(sheetName){prefixSheet=true;}}
const zone=toUnboundedZone(xc);const parts=RangeImpl.getRangeParts(xc,zone);const invalidSheetName=sheetName&&!this.getters.getSheetIdByName(sheetName)?sheetName:undefined;const sheetId=this.getters.getSheetIdByName(sheetName)||defaultSheetId;const rangeInterface={prefixSheet,zone,sheetId,invalidSheetName,parts};return new RangeImpl(rangeInterface,this.getters.getSheetSize).orderZone();}
getRangeString(range,forSheetId,options={useFixedReference:false}){if(!range){return INCORRECT_RANGE_STRING;}
if(range.invalidXc){return range.invalidXc;}
if(!this.getters.tryGetSheet(range.sheetId)){return INCORRECT_RANGE_STRING;}
if(range.zone.bottom-range.zone.top<0||range.zone.right-range.zone.left<0){return INCORRECT_RANGE_STRING;}
if(range.zone.left<0||range.zone.top<0){return INCORRECT_RANGE_STRING;}
const rangeImpl=RangeImpl.fromRange(range,this.getters);let prefixSheet=rangeImpl.sheetId!==forSheetId||rangeImpl.invalidSheetName||rangeImpl.prefixSheet;let sheetName="";if(prefixSheet){if(rangeImpl.invalidSheetName){sheetName=rangeImpl.invalidSheetName;}
else{sheetName=getCanonicalSheetName(this.getters.getSheetName(rangeImpl.sheetId));}}
if(prefixSheet&&!sheetName){return INCORRECT_RANGE_STRING;}
let rangeString=this.getRangePartString(rangeImpl,0,options);if(rangeImpl.parts&&rangeImpl.parts.length===2){if(rangeImpl.zone.top!==rangeImpl.zone.bottom||rangeImpl.zone.left!==rangeImpl.zone.right||rangeImpl.parts[0].rowFixed||rangeImpl.parts[0].colFixed||rangeImpl.parts[1].rowFixed||rangeImpl.parts[1].colFixed){rangeString+=":";rangeString+=this.getRangePartString(rangeImpl,1,options);}}
return`${prefixSheet ? sheetName + "!" : ""}${rangeString}`;}
getRangeDataFromXc(sheetId,xc){return this.getters.getRangeFromSheetXC(sheetId,xc).rangeData;}
getRangeDataFromZone(sheetId,zone){return{_sheetId:sheetId,_zone:zone};}
getRangeFromZone(sheetId,zone){return new RangeImpl({sheetId,zone,parts:[{colFixed:false,rowFixed:false},{colFixed:false,rowFixed:false},],prefixSheet:false,},this.getters.getSheetSize);}
getRangeFromRangeData(data){const rangeInterface={prefixSheet:false,zone:data._zone,sheetId:data._sheetId,invalidSheetName:undefined,parts:[{colFixed:false,rowFixed:false},{colFixed:false,rowFixed:false},],};return new RangeImpl(rangeInterface,this.getters.getSheetSize);}
getRangePartString(range,part,options={useFixedReference:false}){const colFixed=range.parts&&range.parts[part]?.colFixed?"$":"";const col=part===0?numberToLetters(range.zone.left):numberToLetters(range.zone.right);const rowFixed=range.parts&&range.parts[part]?.rowFixed?"$":"";const row=part===0?String(range.zone.top+1):String(range.zone.bottom+1);let str="";if(range.isFullCol&&!options.useFixedReference){if(part===0&&range.unboundedZone.hasHeader){str=colFixed+col+rowFixed+row;}
else{str=colFixed+col;}}
else if(range.isFullRow&&!options.useFixedReference){if(part===0&&range.unboundedZone.hasHeader){str=colFixed+col+rowFixed+row;}
else{str=rowFixed+row;}}
else{str=colFixed+col+rowFixed+row;}
return str;}
getInvalidRange(){return{parts:[],prefixSheet:false,zone:{left:-1,top:-1,right:-1,bottom:-1},sheetId:"",invalidXc:INCORRECT_RANGE_STRING,};}}
class SheetPlugin extends CorePlugin{static getters=["getSheetName","tryGetSheetName","getSheet","tryGetSheet","getSheetIdByName","getSheetIds","getVisibleSheetIds","isSheetVisible","getEvaluationSheets","doesHeaderExist","doesHeadersExist","getCell","getCellPosition","getColsZone","getRowCells","getRowsZone","getNumberCols","getNumberRows","getNumberHeaders","getGridLinesVisibility","getNextSheetName","getSheetSize","getSheetZone","getPaneDivisions","checkZonesExistInSheet","getCommandZones","getUnboundedZone","checkElementsIncludeAllNonFrozenHeaders",];sheetIdsMapName={};orderedSheetIds=[];sheets={};cellPosition={};allowDispatch(cmd){const genericChecks=this.chainValidations(this.checkSheetExists,this.checkZonesAreInSheet)(cmd);if(genericChecks!=="Success"){return genericChecks;}
switch(cmd.type){case"HIDE_SHEET":{if(this.getVisibleSheetIds().length===1){return"NotEnoughSheets";}
return"Success";}
case"CREATE_SHEET":{return this.checkValidations(cmd,this.checkSheetName,this.checkSheetPosition);}
case"MOVE_SHEET":try{const currentIndex=this.orderedSheetIds.findIndex((id)=>id===cmd.sheetId);this.findIndexOfTargetSheet(currentIndex,cmd.delta);return"Success";}
catch(e){return"WrongSheetMove";}
case"RENAME_SHEET":return this.isRenameAllowed(cmd);case"DELETE_SHEET":return this.orderedSheetIds.length>1?"Success":"NotEnoughSheets";case"ADD_COLUMNS_ROWS":if(!this.doesHeaderExist(cmd.sheetId,cmd.dimension,cmd.base)){return"InvalidHeaderIndex";}
else if(cmd.quantity<=0){return"InvalidQuantity";}
return"Success";case"REMOVE_COLUMNS_ROWS":{const min=largeMin(cmd.elements);const max=largeMax(cmd.elements);if(min<0||!this.doesHeaderExist(cmd.sheetId,cmd.dimension,max)){return"InvalidHeaderIndex";}
else if(this.checkElementsIncludeAllNonFrozenHeaders(cmd.sheetId,cmd.dimension,cmd.elements)){return"NotEnoughElements";}
else{return"Success";}}
case"FREEZE_ROWS":{return this.checkValidations(cmd,this.checkRowFreezeQuantity,this.checkRowFreezeOverlapMerge);}
case"FREEZE_COLUMNS":{return this.checkValidations(cmd,this.checkColFreezeQuantity,this.checkColFreezeOverlapMerge);}
default:return"Success";}}
handle(cmd){switch(cmd.type){case"SET_GRID_LINES_VISIBILITY":this.setGridLinesVisibility(cmd.sheetId,cmd.areGridLinesVisible);break;case"DELETE_CONTENT":this.clearZones(cmd.sheetId,cmd.target);break;case"CREATE_SHEET":const sheet=this.createSheet(cmd.sheetId,cmd.name||this.getNextSheetName(),cmd.cols||26,cmd.rows||100,cmd.position);this.history.update("sheetIdsMapName",sheet.name,sheet.id);break;case"MOVE_SHEET":this.moveSheet(cmd.sheetId,cmd.delta);break;case"RENAME_SHEET":this.renameSheet(this.sheets[cmd.sheetId],cmd.name);break;case"HIDE_SHEET":this.hideSheet(cmd.sheetId);break;case"SHOW_SHEET":this.showSheet(cmd.sheetId);break;case"DUPLICATE_SHEET":this.duplicateSheet(cmd.sheetId,cmd.sheetIdTo);break;case"DELETE_SHEET":this.deleteSheet(this.sheets[cmd.sheetId]);break;case"REMOVE_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.removeColumns(this.sheets[cmd.sheetId],[...cmd.elements]);}
else{this.removeRows(this.sheets[cmd.sheetId],[...cmd.elements]);}
break;case"ADD_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.addColumns(this.sheets[cmd.sheetId],cmd.base,cmd.position,cmd.quantity);}
else{this.addRows(this.sheets[cmd.sheetId],cmd.base,cmd.position,cmd.quantity);}
break;case"UPDATE_CELL_POSITION":this.updateCellPosition(cmd);break;case"FREEZE_COLUMNS":this.setPaneDivisions(cmd.sheetId,cmd.quantity,"COL");break;case"FREEZE_ROWS":this.setPaneDivisions(cmd.sheetId,cmd.quantity,"ROW");break;case"UNFREEZE_ROWS":this.setPaneDivisions(cmd.sheetId,0,"ROW");break;case"UNFREEZE_COLUMNS":this.setPaneDivisions(cmd.sheetId,0,"COL");break;case"UNFREEZE_COLUMNS_ROWS":this.setPaneDivisions(cmd.sheetId,0,"COL");this.setPaneDivisions(cmd.sheetId,0,"ROW");}}
import(data){for(let sheet of data.sheets){this.sheetIdsMapName[sheet.name]=sheet.id;}
for(let sheetData of data.sheets){const name=sheetData.name||_t("Sheet")+(Object.keys(this.sheets).length+1);const{colNumber,rowNumber}=this.getImportedSheetSize(sheetData);const sheet={id:sheetData.id,name:name,numberOfCols:colNumber,rows:createDefaultRows(rowNumber),areGridLinesVisible:sheetData.areGridLinesVisible===undefined?true:sheetData.areGridLinesVisible,isVisible:sheetData.isVisible,panes:{xSplit:sheetData.panes?.xSplit||0,ySplit:sheetData.panes?.ySplit||0,},};this.orderedSheetIds.push(sheet.id);this.sheets[sheet.id]=sheet;}}
exportSheets(data){data.sheets=this.orderedSheetIds.filter(isDefined$1).map((id)=>{const sheet=this.sheets[id];const sheetData={id:sheet.id,name:sheet.name,colNumber:sheet.numberOfCols,rowNumber:this.getters.getNumberRows(sheet.id),rows:{},cols:{},merges:[],cells:{},conditionalFormats:[],figures:[],filterTables:[],areGridLinesVisible:sheet.areGridLinesVisible===undefined?true:sheet.areGridLinesVisible,isVisible:sheet.isVisible,};if(sheet.panes.xSplit||sheet.panes.ySplit){sheetData.panes=sheet.panes;}
return sheetData;});}
export(data){this.exportSheets(data);}
exportForExcel(data){this.exportSheets(data);}
getGridLinesVisibility(sheetId){return this.getSheet(sheetId).areGridLinesVisible;}
tryGetSheet(sheetId){return this.sheets[sheetId];}
getSheet(sheetId){const sheet=this.sheets[sheetId];if(!sheet){throw new Error(`Sheet ${sheetId} not found.`);}
return sheet;}
isSheetVisible(sheetId){return this.getSheet(sheetId).isVisible;}
getSheetName(sheetId){return this.getSheet(sheetId).name;}
tryGetSheetName(sheetId){return this.tryGetSheet(sheetId)?.name;}
getSheetIdByName(name){if(name){const unquotedName=getUnquotedSheetName(name);for(const key in this.sheetIdsMapName){if(key.toUpperCase()===unquotedName.toUpperCase()){return this.sheetIdsMapName[key];}}}
return undefined;}
getSheetIds(){return this.orderedSheetIds;}
getVisibleSheetIds(){return this.orderedSheetIds.filter(this.isSheetVisible.bind(this));}
getEvaluationSheets(){return this.sheets;}
doesHeaderExist(sheetId,dimension,index){return dimension==="COL"?index>=0&&index<this.getNumberCols(sheetId):index>=0&&index<this.getNumberRows(sheetId);}
doesHeadersExist(sheetId,dimension,headerIndexes){return headerIndexes.every((index)=>this.doesHeaderExist(sheetId,dimension,index));}
getRow(sheetId,index){const row=this.getSheet(sheetId).rows[index];if(!row){throw new Error(`Row ${row} not found.`);}
return row;}
getCell({sheetId,col,row}){const sheet=this.tryGetSheet(sheetId);const cellId=sheet?.rows[row]?.cells[col];if(cellId===undefined){return undefined;}
return this.getters.getCellById(cellId);}
getColsZone(sheetId,start,end){return{top:0,bottom:this.getNumberRows(sheetId)-1,left:start,right:end,};}
getRowCells(sheetId,row){return Object.values(this.getSheet(sheetId).rows[row]?.cells).filter(isDefined$1);}
getRowsZone(sheetId,start,end){return{top:start,bottom:end,left:0,right:this.getSheet(sheetId).numberOfCols-1,};}
getCellPosition(cellId){const cell=this.cellPosition[cellId];if(!cell){throw new Error(`asking for a cell position that doesn't exist, cell id: ${cellId}`);}
return cell;}
getNumberCols(sheetId){return this.getSheet(sheetId).numberOfCols;}
getNumberRows(sheetId){return this.getSheet(sheetId).rows.length;}
getNumberHeaders(sheetId,dimension){return dimension==="COL"?this.getNumberCols(sheetId):this.getNumberRows(sheetId);}
getNextSheetName(baseName="Sheet"){let i=1;const names=this.orderedSheetIds.map(this.getSheetName.bind(this));let name=`${baseName}${i}`;while(names.includes(name)){name=`${baseName}${i}`;i++;}
return name;}
getSheetSize(sheetId){return{numberOfRows:this.getNumberRows(sheetId),numberOfCols:this.getNumberCols(sheetId),};}
getSheetZone(sheetId){return{top:0,left:0,bottom:this.getNumberRows(sheetId)-1,right:this.getNumberCols(sheetId)-1,};}
getUnboundedZone(sheetId,zone){const isFullRow=zone.left===0&&zone.right===this.getNumberCols(sheetId)-1;const isFullCol=zone.top===0&&zone.bottom===this.getNumberRows(sheetId)-1;return{...zone,bottom:isFullCol?undefined:zone.bottom,right:isFullRow&&!isFullCol?undefined:zone.right,};}
getPaneDivisions(sheetId){return this.getSheet(sheetId).panes;}
setPaneDivisions(sheetId,base,dimension){const panes={...this.getPaneDivisions(sheetId)};if(dimension==="COL"){panes.xSplit=base;}
else if(dimension==="ROW"){panes.ySplit=base;}
this.history.update("sheets",sheetId,"panes",panes);}
checkElementsIncludeAllNonFrozenHeaders(sheetId,dimension,elements){const paneDivisions=this.getters.getPaneDivisions(sheetId);const startIndex=dimension==="ROW"?paneDivisions.ySplit:paneDivisions.xSplit;const endIndex=this.getters.getNumberHeaders(sheetId,dimension);if(!startIndex){return false;}
const indicesToCheck=range(startIndex,endIndex);return includesAll(elements,indicesToCheck);}
getCommandZones(cmd){const zones=[];if("zone"in cmd){zones.push(cmd.zone);}
if("target"in cmd){zones.push(...cmd.target);}
if("ranges"in cmd){zones.push(...cmd.ranges.map((rangeData)=>this.getters.getRangeFromRangeData(rangeData).zone));}
if("col"in cmd&&"row"in cmd){zones.push({top:cmd.row,left:cmd.col,bottom:cmd.row,right:cmd.col});}
return zones;}
checkZonesExistInSheet(sheetId,zones){if(!zones.every(isZoneValid))
return"InvalidRange";if(zones.length){const sheetZone=this.getSheetZone(sheetId);return zones.every((zone)=>isZoneInside(zone,sheetZone))?"Success":"TargetOutOfSheet";}
return"Success";}
updateCellPosition(cmd){const{sheetId,cellId,col,row}=cmd;if(cellId){this.setNewPosition(cellId,sheetId,col,row);}
else{this.clearPosition(sheetId,col,row);}}
setNewPosition(cellId,sheetId,col,row){const currentPosition=this.cellPosition[cellId];if(currentPosition){this.clearPosition(sheetId,currentPosition.col,currentPosition.row);}
this.history.update("cellPosition",cellId,{row:row,col:col,sheetId:sheetId,});this.history.update("sheets",sheetId,"rows",row,"cells",col,cellId);}
clearPosition(sheetId,col,row){const cellId=this.sheets[sheetId]?.rows[row].cells[col];if(cellId){this.history.update("cellPosition",cellId,undefined);this.history.update("sheets",sheetId,"rows",row,"cells",col,undefined);}}
setGridLinesVisibility(sheetId,areGridLinesVisible){this.history.update("sheets",sheetId,"areGridLinesVisible",areGridLinesVisible);}
clearZones(sheetId,zones){for(let zone of zones){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){const cell=this.sheets[sheetId].rows[row].cells[col];if(cell){this.dispatch("UPDATE_CELL",{sheetId:sheetId,content:"",col,row,});}}}}}
createSheet(id,name,colNumber,rowNumber,position){const sheet={id,name,numberOfCols:colNumber,rows:createDefaultRows(rowNumber),areGridLinesVisible:true,isVisible:true,panes:{xSplit:0,ySplit:0,},};const orderedSheetIds=this.orderedSheetIds.slice();orderedSheetIds.splice(position,0,sheet.id);const sheets=this.sheets;this.history.update("orderedSheetIds",orderedSheetIds);this.history.update("sheets",Object.assign({},sheets,{[sheet.id]:sheet}));return sheet;}
moveSheet(sheetId,delta){const orderedSheetIds=this.orderedSheetIds.slice();const currentIndex=orderedSheetIds.findIndex((id)=>id===sheetId);const sheet=orderedSheetIds.splice(currentIndex,1);let index=this.findIndexOfTargetSheet(currentIndex,delta);orderedSheetIds.splice(index,0,sheet[0]);this.history.update("orderedSheetIds",orderedSheetIds);}
findIndexOfTargetSheet(currentIndex,deltaIndex){while(deltaIndex!=0&&0<=currentIndex&&currentIndex<=this.orderedSheetIds.length){if(deltaIndex>0){currentIndex++;if(this.isSheetVisible(this.orderedSheetIds[currentIndex])){deltaIndex--;}}
else if(deltaIndex<0){currentIndex--;if(this.isSheetVisible(this.orderedSheetIds[currentIndex])){deltaIndex++;}}}
if(deltaIndex===0){return currentIndex;}
throw new Error(_t("There is not enough visible sheets"));}
checkSheetName(cmd){const originalSheetName=this.getters.tryGetSheetName(cmd.sheetId);if(originalSheetName!==undefined&&cmd.name===originalSheetName){return"UnchangedSheetName";}
const{orderedSheetIds,sheets}=this;const name=cmd.name&&cmd.name.trim().toLowerCase();if(orderedSheetIds.find((id)=>sheets[id]?.name.toLowerCase()===name&&id!==cmd.sheetId)){return"DuplicatedSheetName";}
if(FORBIDDEN_IN_EXCEL_REGEX.test(name)){return"ForbiddenCharactersInSheetName";}
return"Success";}
checkSheetPosition(cmd){const{orderedSheetIds}=this;if(cmd.position>orderedSheetIds.length||cmd.position<0){return"WrongSheetPosition";}
return"Success";}
checkRowFreezeQuantity(cmd){return cmd.quantity>=1&&cmd.quantity<this.getNumberRows(cmd.sheetId)?"Success":"InvalidFreezeQuantity";}
checkColFreezeQuantity(cmd){return cmd.quantity>=1&&cmd.quantity<this.getNumberCols(cmd.sheetId)?"Success":"InvalidFreezeQuantity";}
checkRowFreezeOverlapMerge(cmd){const merges=this.getters.getMerges(cmd.sheetId);for(let merge of merges){if(merge.top<cmd.quantity&&cmd.quantity<=merge.bottom){return"MergeOverlap";}}
return"Success";}
checkColFreezeOverlapMerge(cmd){const merges=this.getters.getMerges(cmd.sheetId);for(let merge of merges){if(merge.left<cmd.quantity&&cmd.quantity<=merge.right){return"MergeOverlap";}}
return"Success";}
isRenameAllowed(cmd){const name=cmd.name&&cmd.name.trim().toLowerCase();if(!name){return"MissingSheetName";}
return this.checkSheetName(cmd);}
renameSheet(sheet,name){const oldName=sheet.name;this.history.update("sheets",sheet.id,"name",name.trim());const sheetIdsMapName=Object.assign({},this.sheetIdsMapName);delete sheetIdsMapName[oldName];sheetIdsMapName[name]=sheet.id;this.history.update("sheetIdsMapName",sheetIdsMapName);}
hideSheet(sheetId){this.history.update("sheets",sheetId,"isVisible",false);}
showSheet(sheetId){this.history.update("sheets",sheetId,"isVisible",true);}
duplicateSheet(fromId,toId){const sheet=this.getSheet(fromId);const toName=this.getDuplicateSheetName(sheet.name);const newSheet=deepCopy(sheet);newSheet.id=toId;newSheet.name=toName;for(let col=0;col<=newSheet.numberOfCols;col++){for(let row=0;row<=newSheet.rows.length;row++){if(newSheet.rows[row]){newSheet.rows[row].cells[col]=undefined;}}}
const orderedSheetIds=this.orderedSheetIds.slice();const currentIndex=orderedSheetIds.indexOf(fromId);orderedSheetIds.splice(currentIndex+1,0,newSheet.id);this.history.update("orderedSheetIds",orderedSheetIds);this.history.update("sheets",Object.assign({},this.sheets,{[newSheet.id]:newSheet}));for(const cell of Object.values(this.getters.getCells(fromId))){const{col,row}=this.getCellPosition(cell.id);this.dispatch("UPDATE_CELL",{sheetId:newSheet.id,col,row,content:cell.content,format:cell.format,style:cell.style,});}
const sheetIdsMapName=Object.assign({},this.sheetIdsMapName);sheetIdsMapName[newSheet.name]=newSheet.id;this.history.update("sheetIdsMapName",sheetIdsMapName);}
getDuplicateSheetName(sheetName){let i=1;const names=this.orderedSheetIds.map(this.getSheetName.bind(this));const baseName=_t("Copy of %s",sheetName);let name=baseName.toString();while(names.includes(name)){name=`${baseName} (${i})`;i++;}
return name;}
deleteSheet(sheet){const name=sheet.name;const sheets=Object.assign({},this.sheets);delete sheets[sheet.id];this.history.update("sheets",sheets);const orderedSheetIds=this.orderedSheetIds.slice();const currentIndex=orderedSheetIds.indexOf(sheet.id);orderedSheetIds.splice(currentIndex,1);this.history.update("orderedSheetIds",orderedSheetIds);const sheetIdsMapName=Object.assign({},this.sheetIdsMapName);delete sheetIdsMapName[name];this.history.update("sheetIdsMapName",sheetIdsMapName);}
removeColumns(sheet,columns){columns.sort((a,b)=>b-a);for(let column of columns){this.moveCellOnColumnsDeletion(sheet,column);}
const numberOfCols=this.sheets[sheet.id].numberOfCols;this.history.update("sheets",sheet.id,"numberOfCols",numberOfCols-columns.length);const count=columns.filter((col)=>col<sheet.panes.xSplit).length;if(count){this.setPaneDivisions(sheet.id,sheet.panes.xSplit-count,"COL");}}
removeRows(sheet,rows){rows.sort((a,b)=>b-a);for(let group of groupConsecutive(rows)){const from=group[group.length-1];const to=group[0];this.moveCellOnRowsDeletion(sheet,from,to);this.updateRowsStructureOnDeletion(sheet,from,to);}
const count=rows.filter((row)=>row<sheet.panes.ySplit).length;if(count){this.setPaneDivisions(sheet.id,sheet.panes.ySplit-count,"ROW");}}
addColumns(sheet,column,position,quantity){const index=position==="before"?column:column+1;this.moveCellsOnAddition(sheet,index,quantity,"columns");const numberOfCols=this.sheets[sheet.id].numberOfCols;this.history.update("sheets",sheet.id,"numberOfCols",numberOfCols+quantity);if(index<sheet.panes.xSplit){this.setPaneDivisions(sheet.id,sheet.panes.xSplit+quantity,"COL");}}
addRows(sheet,row,position,quantity){const index=position==="before"?row:row+1;this.addEmptyRows(sheet,quantity);this.moveCellsOnAddition(sheet,index,quantity,"rows");if(index<sheet.panes.ySplit){this.setPaneDivisions(sheet.id,sheet.panes.ySplit+quantity,"ROW");}}
moveCellOnColumnsDeletion(sheet,deletedColumn){for(let rowIndex=0;rowIndex<sheet.rows.length;rowIndex++){const row=sheet.rows[rowIndex];for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){if(colIndex===deletedColumn){this.dispatch("CLEAR_CELL",{sheetId:sheet.id,col:colIndex,row:rowIndex,});}
if(colIndex>deletedColumn){this.dispatch("UPDATE_CELL_POSITION",{sheetId:sheet.id,cellId:cellId,col:colIndex-1,row:rowIndex,});}}}}}
moveCellsOnAddition(sheet,addedElement,quantity,dimension){const commands=[];for(let rowIndex=0;rowIndex<sheet.rows.length;rowIndex++){const row=sheet.rows[rowIndex];if(dimension!=="rows"||rowIndex>=addedElement){for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){if(dimension==="rows"||colIndex>=addedElement){commands.push({type:"UPDATE_CELL_POSITION",sheetId:sheet.id,cellId:cellId,col:colIndex+(dimension==="columns"?quantity:0),row:rowIndex+(dimension==="rows"?quantity:0),});}}}}}
for(let cmd of commands.reverse()){this.dispatch(cmd.type,cmd);}}
moveCellOnRowsDeletion(sheet,deleteFromRow,deleteToRow){const numberRows=deleteToRow-deleteFromRow+1;for(let rowIndex=0;rowIndex<sheet.rows.length;rowIndex++){const row=sheet.rows[rowIndex];if(rowIndex>=deleteFromRow&&rowIndex<=deleteToRow){for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){this.dispatch("CLEAR_CELL",{sheetId:sheet.id,col:colIndex,row:rowIndex,});}}}
if(rowIndex>deleteToRow){for(let i in row.cells){const colIndex=Number(i);const cellId=row.cells[i];if(cellId){this.dispatch("UPDATE_CELL_POSITION",{sheetId:sheet.id,cellId:cellId,col:colIndex,row:rowIndex-numberRows,});}}}}}
updateRowsStructureOnDeletion(sheet,deleteFromRow,deleteToRow){const rows=[];const cellsQueue=sheet.rows.map((row)=>row.cells).reverse();for(let i in sheet.rows){const row=Number(i);if(row>=deleteFromRow&&row<=deleteToRow){continue;}
rows.push({cells:cellsQueue.pop(),});}
this.history.update("sheets",sheet.id,"rows",rows);}
addEmptyRows(sheet,quantity){const rows=sheet.rows.slice();for(let i=0;i<quantity;i++){rows.push({cells:{},});}
this.history.update("sheets",sheet.id,"rows",rows);}
getImportedSheetSize(data){const positions=Object.keys(data.cells).map(toCartesian);let rowNumber=data.rowNumber;let colNumber=data.colNumber;for(let{col,row}of positions){rowNumber=Math.max(rowNumber,row+1);colNumber=Math.max(colNumber,col+1);}
return{rowNumber,colNumber};}
checkSheetExists(cmd){if(cmd.type!=="CREATE_SHEET"&&"sheetId"in cmd&&this.sheets[cmd.sheetId]===undefined){return"InvalidSheetId";}
else if(cmd.type==="CREATE_SHEET"&&this.sheets[cmd.sheetId]!==undefined){return"DuplicatedSheetId";}
return"Success";}
checkZonesAreInSheet(cmd){if(!("sheetId"in cmd))
return"Success";return this.checkZonesExistInSheet(cmd.sheetId,this.getCommandZones(cmd));}}
class HeaderGroupingPlugin extends CorePlugin{static getters=["getHeaderGroups","getGroupsLayers","getVisibleGroupLayers","getHeaderGroup","getHeaderGroupsInZone","isGroupFolded","isRowFolded","isColFolded",];groups={};allowDispatch(cmd){switch(cmd.type){case"GROUP_HEADERS":{const{start,end}=cmd;if(!this.getters.doesHeadersExist(cmd.sheetId,cmd.dimension,[start,end])){return"InvalidHeaderGroupStartEnd";}
if(start>end){return"InvalidHeaderGroupStartEnd";}
if(this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,start,end)){return"HeaderGroupAlreadyExists";}
break;}
case"UNGROUP_HEADERS":{const{start,end}=cmd;if(!this.getters.doesHeadersExist(cmd.sheetId,cmd.dimension,[start,end])){return"InvalidHeaderGroupStartEnd";}
if(start>end){return"InvalidHeaderGroupStartEnd";}
break;}
case"UNFOLD_HEADER_GROUP":case"FOLD_HEADER_GROUP":const group=this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);if(!group){return"UnknownHeaderGroup";}
const numberOfHeaders=this.getters.getNumberHeaders(cmd.sheetId,cmd.dimension);const willHideAllHeaders=range(0,numberOfHeaders).every((i)=>(i>=group.start&&i<=group.end)||this.getters.isHeaderHiddenByUser(cmd.sheetId,cmd.dimension,i));if(willHideAllHeaders){return"NotEnoughElements";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"CREATE_SHEET":this.history.update("groups",cmd.sheetId,{ROW:[],COL:[]});break;case"GROUP_HEADERS":this.groupHeaders(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);break;case"UNGROUP_HEADERS":{this.unGroupHeaders(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);break;}
case"DUPLICATE_SHEET":{const groups=deepCopy(this.groups[cmd.sheetId]);this.history.update("groups",cmd.sheetIdTo,groups);break;}
case"DELETE_SHEET":{const groups={...this.groups};delete groups[cmd.sheetId];this.history.update("groups",groups);break;}
case"ADD_COLUMNS_ROWS":const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);this.moveGroupsOnHeaderInsertion(cmd.sheetId,cmd.dimension,addIndex,cmd.quantity);break;case"REMOVE_COLUMNS_ROWS":this.moveGroupsOnHeaderDeletion(cmd.sheetId,cmd.dimension,cmd.elements);break;case"UNFOLD_HEADER_GROUP":{const group=this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);if(group){this.unfoldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"FOLD_HEADER_GROUP":{const group=this.findGroupWithStartEnd(cmd.sheetId,cmd.dimension,cmd.start,cmd.end);if(group){this.foldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"UNFOLD_ALL_HEADER_GROUPS":{const groups=this.getters.getHeaderGroups(cmd.sheetId,cmd.dimension);for(const group of groups){this.unfoldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"FOLD_ALL_HEADER_GROUPS":{const groups=this.getters.getHeaderGroups(cmd.sheetId,cmd.dimension);for(const group of groups){this.foldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
break;}
case"FOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_HEADER_GROUPS_IN_ZONE":{const action=cmd.type==="UNFOLD_HEADER_GROUPS_IN_ZONE"?"unfold":"fold";const layers=this.getGroupsLayers(cmd.sheetId,cmd.dimension);if(action==="fold"){layers.reverse();}
const groups=layers.flat();const start=cmd.dimension==="ROW"?cmd.zone.top:cmd.zone.left;const end=cmd.dimension==="ROW"?cmd.zone.bottom:cmd.zone.right;const groupsToToggle=new Set();for(let header=start;header<=end;header++){const matchedGroups=groups.filter((g)=>g.start-1<=header&&header<=g.end);for(const group of matchedGroups){if((action==="fold"&&group.isFolded)||(action==="unfold"&&!group.isFolded)){continue;}
groupsToToggle.add(group);break;}}
for(const group of groupsToToggle){if(action==="unfold"){this.unfoldHeaderGroup(cmd.sheetId,cmd.dimension,group);}
else{this.foldHeaderGroup(cmd.sheetId,cmd.dimension,group);}}
break;}}}
getHeaderGroups(sheetId,dim){return this.groups[sheetId][dim];}
getHeaderGroup(sheetId,dim,start,end){return this.getHeaderGroups(sheetId,dim).find((group)=>group.start===start&&group.end===end);}
getHeaderGroupsInZone(sheetId,dim,zone){return this.getHeaderGroups(sheetId,dim).filter((group)=>{const start=dim==="ROW"?zone.top:zone.left;const end=dim==="ROW"?zone.bottom:zone.right;return this.doGroupOverlap(group,start,end);});}
getGroupsLayers(sheetId,dimension){const groups=this.getHeaderGroups(sheetId,dimension);return this.bricksFallingAlgorithm(groups,0,0);}
getVisibleGroupLayers(sheetId,dimension){const layers=this.getGroupsLayers(sheetId,dimension);for(const layer of layers){for(let k=layer.length-1;k>=0;k--){const group=layer[k];if(group.start===0){continue;}
const headersInGroup=range(group.start-1,group.end+1);if(headersInGroup.every((i)=>this.getters.isHeaderHiddenByUser(sheetId,dimension,i))){layer.splice(k,1);}}}
return layers.filter((layer)=>layer.length>0);}
isGroupFolded(sheetId,dimension,start,end){return this.getHeaderGroup(sheetId,dimension,start,end)?.isFolded||false;}
isRowFolded(sheetId,row){const groups=this.getters.getHeaderGroups(sheetId,"ROW");return groups.some((group)=>group.start<=row&&row<=group.end&&group.isFolded);}
isColFolded(sheetId,col){const groups=this.getters.getHeaderGroups(sheetId,"COL");return groups.some((group)=>group.start<=col&&col<=group.end&&group.isFolded);}
getGroupId(group){return`${group.start}-${group.end}}`;}
bricksFallingAlgorithm(groups,start,end,delta=0){const isGroupFolded={};for(const group of groups){isGroupFolded[this.getGroupId(group)]=group.isFolded;}
const brickPileSize={};for(const group of groups){for(let i=group.start;i<=group.end;i++){brickPileSize[i]=brickPileSize[i]?brickPileSize[i]+1:1;}}
for(let i=start;i<=end;i++){brickPileSize[i]=brickPileSize[i]?brickPileSize[i]+delta:delta;}
const numberOfLayers=Math.max(...Object.values(brickPileSize),0);const groupLayers=Array.from({length:numberOfLayers},()=>[]);const maxHeader=Math.max(end,...groups.map((group)=>group.end));const minHeader=Math.min(start,...groups.map((group)=>group.start));for(let header=minHeader;header<=maxHeader;header++){const pileSize=brickPileSize[header]||0;for(let layer=0;layer<pileSize;layer++){const currentGroup=groupLayers[layer].at(-1);if(currentGroup&&isConsecutive([currentGroup.end,header])){currentGroup.end++;}
else{const newGroup={start:header,end:header};groupLayers[layer].push(newGroup);}}}
for(const layer of groupLayers){for(const group of layer){group.isFolded=isGroupFolded[this.getGroupId(group)];}}
return groupLayers;}
groupHeaders(sheetId,dimension,start,end){const groups=this.getHeaderGroups(sheetId,dimension);const newGroups=this.bricksFallingAlgorithm(groups,start,end,+1).flat();this.history.update("groups",sheetId,dimension,this.removeDuplicateGroups(newGroups));}
unGroupHeaders(sheetId,dimension,start,end){const groups=this.getHeaderGroups(sheetId,dimension);const newGroups=this.bricksFallingAlgorithm(groups,start,end,-1).flat();this.history.update("groups",sheetId,dimension,this.removeDuplicateGroups(newGroups));}
moveGroupsOnHeaderInsertion(sheetId,dim,index,count){const groups=this.groups[sheetId][dim];for(let i=0;i<groups.length;i++){const group=groups[i];const[start,end]=moveHeaderIndexesOnHeaderAddition(index,count,[group.start,group.end,]);if(start!==group.start||end!==group.end){this.history.update("groups",sheetId,dim,i,{...group,start,end});}}}
moveGroupsOnHeaderDeletion(sheetId,dimension,deletedElements){const groups=this.getHeaderGroups(sheetId,dimension);const newGroups=[];for(const group of groups){const headersInGroup=range(group.start,group.end+1);const headersAfterDeletion=moveHeaderIndexesOnHeaderDeletion(deletedElements,headersInGroup);if(headersAfterDeletion.length===0){continue;}
newGroups.push({...group,start:Math.min(...headersAfterDeletion),end:Math.max(...headersAfterDeletion),});}
this.history.update("groups",sheetId,dimension,this.bricksFallingAlgorithm(newGroups,0,0).flat());}
doGroupOverlap(group,start,end){return group.start<=end&&group.end>=start;}
removeDuplicateGroups(groups){const newGroups={};for(const group of groups){newGroups[this.getGroupId(group)]=group;}
return Object.values(newGroups);}
findGroupWithStartEnd(sheetId,dimension,start,end){return this.getHeaderGroups(sheetId,dimension).find((group)=>group.start===start&&group.end===end);}
foldHeaderGroup(sheetId,dim,groupToFold){const index=this.getGroupIndex(sheetId,dim,groupToFold.start,groupToFold.end);if(index===undefined){return;}
this.history.update("groups",sheetId,dim,index,"isFolded",true);const groups=this.getters.getHeaderGroups(sheetId,dim);for(let i=0;i<groups.length;i++){const group=groups[i];if(group.start===groupToFold.start&&group.end<=groupToFold.end){this.history.update("groups",sheetId,dim,i,"isFolded",true);}}}
unfoldHeaderGroup(sheetId,dim,groupToUnfold){const index=this.getGroupIndex(sheetId,dim,groupToUnfold.start,groupToUnfold.end);if(index===undefined){return;}
this.history.update("groups",sheetId,dim,index,"isFolded",false);const groups=this.getters.getHeaderGroups(sheetId,dim);for(let i=0;i<groups.length;i++){const group=groups[i];if(group.start===groupToUnfold.start&&group.end>=groupToUnfold.end){this.history.update("groups",sheetId,dim,i,"isFolded",false);}}}
getGroupIndex(sheetId,dimension,start,end){const index=this.groups[sheetId][dimension].findIndex((group)=>group.start===start&&group.end===end);return index===-1?undefined:index;}
import(data){for(const sheet of data.sheets){this.groups[sheet.id]={ROW:[],COL:[]};if(!sheet.headerGroups){continue;}
for(const dim of["ROW","COL"]){for(const groupData of sheet.headerGroups[dim]||[]){this.groups[sheet.id][dim].push({...groupData});}}}}
export(data){for(const sheet of data.sheets){sheet.headerGroups=this.groups[sheet.id];}}}
class SettingsPlugin extends CorePlugin{static getters=["getLocale"];locale=DEFAULT_LOCALE;allowDispatch(cmd){switch(cmd.type){case"UPDATE_LOCALE":return isValidLocale(cmd.locale)?"Success":"InvalidLocale";}
return"Success";}
handle(cmd){switch(cmd.type){case"UPDATE_LOCALE":const oldLocale=this.locale;const newLocale=cmd.locale;this.history.update("locale",newLocale);this.changeCellsDateFormatWithLocale(oldLocale,newLocale);break;}}
getLocale(){return this.locale;}
changeCellsDateFormatWithLocale(oldLocale,newLocale){for(const sheetId of this.getters.getSheetIds()){for(const[cellId,cell]of Object.entries(this.getters.getCells(sheetId))){let formatToApply;if(cell.format===oldLocale.dateFormat){formatToApply=newLocale.dateFormat;}
if(cell.format===oldLocale.timeFormat){formatToApply=newLocale.timeFormat;}
if(cell.format===getDateTimeFormat(oldLocale)){formatToApply=getDateTimeFormat(newLocale);}
if(formatToApply){const{col,row,sheetId}=this.getters.getCellPosition(cellId);this.dispatch("UPDATE_CELL",{col,row,sheetId,format:formatToApply,});}}}}
import(data){this.locale=data.settings?.locale??DEFAULT_LOCALE;}
export(data){data.settings={locale:this.locale,};}}
class UIPlugin extends BasePlugin{static layers=[];getters;ui;selection;constructor({getters,stateObserver,dispatch,uiActions,selection}){super(stateObserver,dispatch);this.getters=getters;this.ui=uiActions;this.selection=selection;}
drawGrid(ctx,layer){}}
const functionMap=functionRegistry.mapping;function buildCompilationParameters(context,getters,computeCell){const builder=new CompilationParametersBuilder(context,getters,computeCell);return builder.getParameters();}
class CompilationParametersBuilder{getters;computeCell;evalContext;rangeCache={};constructor(context,getters,computeCell){this.getters=getters;this.computeCell=computeCell;this.evalContext=Object.assign(Object.create(functionMap),context,{getters:this.getters,locale:this.getters.getLocale(),});}
getParameters(){return[this.refFn.bind(this),this.range.bind(this),this.evalContext];}
refFn(range,isMeta,functionName,paramNumber){this.assertRangeValid(range);if(isMeta){return{value:zoneToXc(range.zone)};}
if(range.zone.bottom!==range.zone.top||range.zone.left!==range.zone.right){throw new Error(paramNumber?_t("Function %s expects the parameter %s to be a single value or a single cell reference, not a range.",functionName.toString(),paramNumber.toString()):_t("Function %s expects its parameters to be single values or single cell references, not ranges.",functionName.toString()));}
const position={sheetId:range.sheetId,col:range.zone.left,row:range.zone.top};return this.readCell(position);}
readCell(position){if(!this.getters.tryGetSheet(position.sheetId)){throw new Error(_t("Invalid sheet name"));}
const evaluatedCell=this.getEvaluatedCellIfNotEmpty(position);if(evaluatedCell===undefined){return{value:null,format:this.getters.getCell(position)?.format};}
if(evaluatedCell.type===CellValueType.error){throw evaluatedCell.error;}
return evaluatedCell;}
getEvaluatedCellIfNotEmpty(position){const evaluatedCell=this.computeCell(position);if(evaluatedCell.type===CellValueType.empty){const cell=this.getters.getCell(position);if(!cell||(!cell.isFormula&&cell.content==="")){return undefined;}}
return evaluatedCell;}
range(range){this.assertRangeValid(range);const sheetId=range.sheetId;const zone=range.zone;const sheetZone=this.getters.getSheetZone(sheetId);const _zone=intersection(zone,sheetZone);if(!_zone){return[[]];}
const{top,left,bottom,right}=zone;const cacheKey=`${sheetId}-${top}-${left}-${bottom}-${right}`;if(cacheKey in this.rangeCache){const result=this.rangeCache[cacheKey];if(result instanceof EvaluationError){throw result;}
return result;}
const height=_zone.bottom-_zone.top+1;const width=_zone.right-_zone.left+1;const matrix=new Array(width);for(let col=_zone.left;col<=_zone.right;col++){const colIndex=col-_zone.left;matrix[colIndex]=new Array(height);for(let row=_zone.top;row<=_zone.bottom;row++){const evaluatedCell=this.getEvaluatedCellIfNotEmpty({sheetId,col,row});if(evaluatedCell?.type===CellValueType.error){this.rangeCache[cacheKey]=evaluatedCell.error;throw evaluatedCell.error;}
const rowIndex=row-_zone.top;matrix[colIndex][rowIndex]=this.readCell({sheetId,col,row});}}
this.rangeCache[cacheKey]=matrix;return matrix;}
assertRangeValid(range){if(!isZoneValid(range.zone)){throw new InvalidReferenceError();}
if(range.invalidSheetName){throw new Error(_t("Invalid sheet name: %s",range.invalidSheetName));}}}
function futureRecomputeZones(zones,zonesToRemove=[]){const profilesStartingPosition=[0];const profiles=new Map([[0,[]]]);modifyProfiles(profilesStartingPosition,profiles,zones,false);modifyProfiles(profilesStartingPosition,profiles,zonesToRemove,true);return constructZonesFromProfiles(profilesStartingPosition,profiles);}
function modifyProfiles(profilesStartingPosition,profiles,zones,toRemove=false){for(const zone of zones){const leftValue=zone.left;const rightValue=zone.right===undefined?undefined:zone.right+1;const leftIndex=findIndexAndCreateProfile(profilesStartingPosition,profiles,leftValue,true,0);const rightIndex=findIndexAndCreateProfile(profilesStartingPosition,profiles,rightValue,false,leftIndex);for(let i=leftIndex;i<=rightIndex;i++){const profile=profiles.get(profilesStartingPosition[i]);modifyProfile(profile,zone,toRemove);}
removeContiguousProfiles(profilesStartingPosition,profiles,leftIndex,rightIndex);}}
function findIndexAndCreateProfile(profilesStartingPosition,profiles,value,searchLeft,startIndex){if(value===undefined){return profilesStartingPosition.length-1;}
const predecessorIndex=binaryPredecessorSearch(profilesStartingPosition,value,startIndex);if(value!=profilesStartingPosition[predecessorIndex]){profilesStartingPosition.splice(predecessorIndex+1,0,value);profiles.set(value,[...profiles.get(profilesStartingPosition[predecessorIndex])]);return searchLeft?predecessorIndex+1:predecessorIndex;}
return searchLeft?predecessorIndex:predecessorIndex-1;}
function modifyProfile(profile,zone,toRemove=false){const topValue=zone.top;const bottomValue=zone.bottom===undefined?undefined:zone.bottom+1;const newPoints=[];const topPredIndex=binaryPredecessorSearch(profile,topValue,0,false);if((topPredIndex%2!==0&&!toRemove)||(topPredIndex%2===0&&toRemove)){newPoints.push(topValue);}
if(bottomValue===undefined){profile.splice(topPredIndex+1);profile.push(...newPoints);return;}
const bottomSuccIndex=binarySuccessorSearch(profile,bottomValue,0,false);if((bottomSuccIndex%2===0&&!toRemove)||(bottomSuccIndex%2!==0&&toRemove)){newPoints.push(bottomValue);}
profile.splice(topPredIndex+1,bottomSuccIndex-topPredIndex-1,...newPoints);}
function removeContiguousProfiles(profilesStartingPosition,profiles,leftIndex,rightIndex){const start=leftIndex-1===-1?0:leftIndex-1;const end=rightIndex===profilesStartingPosition.length-1?rightIndex:rightIndex+1;for(let i=end;i>start;i--){if(deepEqualsArray(profiles.get(profilesStartingPosition[i]),profiles.get(profilesStartingPosition[i-1]))){profiles.delete(profilesStartingPosition[i]);profilesStartingPosition.splice(i,1);}}}
function constructZonesFromProfiles(profilesStartingPosition,profiles){const mergedZone=[];let pendingZones=[];for(let colIndex=0;colIndex<profilesStartingPosition.length;colIndex++){const left=profilesStartingPosition[colIndex];const profile=profiles.get(left);if(!profile||profile.length===0){mergedZone.push(...pendingZones);pendingZones=[];continue;}
let right=profilesStartingPosition[colIndex+1];if(right!==undefined){right--;}
const nextPendingZones=[];for(let i=0;i<profile.length;i+=2){const top=profile[i];let bottom=profile[i+1];if(bottom!==undefined){bottom--;}
const profileZone={top,left,bottom,right,hasHeader:(bottom===undefined&&top!==0)||(right===undefined&&left!==0),};let findCorrespondingZone=false;for(let j=pendingZones.length-1;j>=0;j--){const pendingZone=pendingZones[j];if(pendingZone.top===profileZone.top&&pendingZone.bottom===profileZone.bottom){pendingZone.right=profileZone.right;pendingZones.splice(j,1);nextPendingZones.push(pendingZone);findCorrespondingZone=true;break;}}
if(!findCorrespondingZone){nextPendingZones.push(profileZone);}}
mergedZone.push(...pendingZones);pendingZones=nextPendingZones;}
mergedZone.push(...pendingZones);return mergedZone;}
function binaryPredecessorSearch(arr,val,start=0,matchEqual=true){let end=arr.length-1;let result=-1;while(start<=end){const mid=Math.floor((start+end)/2);if(arr[mid]===val&&matchEqual){return mid;}
else if(arr[mid]<val){result=mid;start=mid+1;}
else{end=mid-1;}}
return result;}
function binarySuccessorSearch(arr,val,start=0,matchEqual=true){let end=arr.length-1;let result=arr.length;while(start<=end){const mid=Math.floor((start+end)/2);if(arr[mid]===val&&matchEqual){return mid;}
else if(arr[mid]>val){result=mid;end=mid-1;}
else{start=mid+1;}}
return result;}
function deepEqualsArray(arr1,arr2){if(arr1.length!==arr2.length){return false;}
for(let i=0;i<arr1.length;i++){if(!deepEquals(arr1[i],arr2[i])){return false;}}
return true;}
function quickselect(arr,k,left,right,compare){quickselectStep(arr,k,left||0,right||(arr.length-1),compare||defaultCompare);}
function quickselectStep(arr,k,left,right,compare){while(right>left){if(right-left>600){var n=right-left+1;var m=k-left+1;var z=Math.log(n);var s=0.5*Math.exp(2*z/3);var sd=0.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);var newLeft=Math.max(left,Math.floor(k-m*s/n+sd));var newRight=Math.min(right,Math.floor(k+(n-m)*s/n+sd));quickselectStep(arr,k,newLeft,newRight,compare);}
var t=arr[k];var i=left;var j=right;swap(arr,left,k);if(compare(arr[right],t)>0)swap(arr,left,right);while(i<j){swap(arr,i,j);i++;j--;while(compare(arr[i],t)<0)i++;while(compare(arr[j],t)>0)j--;}
if(compare(arr[left],t)===0)swap(arr,left,j);else{j++;swap(arr,j,right);}
if(j<=k)left=j+1;if(k<=j)right=j-1;}}
function swap(arr,i,j){var tmp=arr[i];arr[i]=arr[j];arr[j]=tmp;}
function defaultCompare(a,b){return a<b?-1:a>b?1:0;}
class RBush{constructor(maxEntries=9){this._maxEntries=Math.max(4,maxEntries);this._minEntries=Math.max(2,Math.ceil(this._maxEntries*0.4));this.clear();}
all(){return this._all(this.data,[]);}
search(bbox){let node=this.data;const result=[];if(!intersects(bbox,node))return result;const toBBox=this.toBBox;const nodesToSearch=[];while(node){for(let i=0;i<node.children.length;i++){const child=node.children[i];const childBBox=node.leaf?toBBox(child):child;if(intersects(bbox,childBBox)){if(node.leaf)result.push(child);else if(contains(bbox,childBBox))this._all(child,result);else nodesToSearch.push(child);}}
node=nodesToSearch.pop();}
return result;}
collides(bbox){let node=this.data;if(!intersects(bbox,node))return false;const nodesToSearch=[];while(node){for(let i=0;i<node.children.length;i++){const child=node.children[i];const childBBox=node.leaf?this.toBBox(child):child;if(intersects(bbox,childBBox)){if(node.leaf||contains(bbox,childBBox))return true;nodesToSearch.push(child);}}
node=nodesToSearch.pop();}
return false;}
load(data){if(!(data&&data.length))return this;if(data.length<this._minEntries){for(let i=0;i<data.length;i++){this.insert(data[i]);}
return this;}
let node=this._build(data.slice(),0,data.length-1,0);if(!this.data.children.length){this.data=node;}else if(this.data.height===node.height){this._splitRoot(this.data,node);}else{if(this.data.height<node.height){const tmpNode=this.data;this.data=node;node=tmpNode;}
this._insert(node,this.data.height-node.height-1,true);}
return this;}
insert(item){if(item)this._insert(item,this.data.height-1);return this;}
clear(){this.data=createNode([]);return this;}
remove(item,equalsFn){if(!item)return this;let node=this.data;const bbox=this.toBBox(item);const path=[];const indexes=[];let i,parent,goingUp;while(node||path.length){if(!node){node=path.pop();parent=path[path.length-1];i=indexes.pop();goingUp=true;}
if(node.leaf){const index=findItem(item,node.children,equalsFn);if(index!==-1){node.children.splice(index,1);path.push(node);this._condense(path);return this;}}
if(!goingUp&&!node.leaf&&contains(node,bbox)){path.push(node);indexes.push(i);i=0;parent=node;node=node.children[0];}else if(parent){i++;node=parent.children[i];goingUp=false;}else node=null;}
return this;}
toBBox(item){return item;}
compareMinX(a,b){return a.minX-b.minX;}
compareMinY(a,b){return a.minY-b.minY;}
toJSON(){return this.data;}
fromJSON(data){this.data=data;return this;}
_all(node,result){const nodesToSearch=[];while(node){if(node.leaf)result.push(...node.children);else nodesToSearch.push(...node.children);node=nodesToSearch.pop();}
return result;}
_build(items,left,right,height){const N=right-left+1;let M=this._maxEntries;let node;if(N<=M){node=createNode(items.slice(left,right+1));calcBBox(node,this.toBBox);return node;}
if(!height){height=Math.ceil(Math.log(N)/Math.log(M));M=Math.ceil(N/Math.pow(M,height-1));}
node=createNode([]);node.leaf=false;node.height=height;const N2=Math.ceil(N/M);const N1=N2*Math.ceil(Math.sqrt(M));multiSelect(items,left,right,N1,this.compareMinX);for(let i=left;i<=right;i+=N1){const right2=Math.min(i+N1-1,right);multiSelect(items,i,right2,N2,this.compareMinY);for(let j=i;j<=right2;j+=N2){const right3=Math.min(j+N2-1,right2);node.children.push(this._build(items,j,right3,height-1));}}
calcBBox(node,this.toBBox);return node;}
_chooseSubtree(bbox,node,level,path){while(true){path.push(node);if(node.leaf||path.length-1===level)break;let minArea=Infinity;let minEnlargement=Infinity;let targetNode;for(let i=0;i<node.children.length;i++){const child=node.children[i];const area=bboxArea(child);const enlargement=enlargedArea(bbox,child)-area;if(enlargement<minEnlargement){minEnlargement=enlargement;minArea=area<minArea?area:minArea;targetNode=child;}else if(enlargement===minEnlargement){if(area<minArea){minArea=area;targetNode=child;}}}
node=targetNode||node.children[0];}
return node;}
_insert(item,level,isNode){const bbox=isNode?item:this.toBBox(item);const insertPath=[];const node=this._chooseSubtree(bbox,this.data,level,insertPath);node.children.push(item);extend(node,bbox);while(level>=0){if(insertPath[level].children.length>this._maxEntries){this._split(insertPath,level);level--;}else break;}
this._adjustParentBBoxes(bbox,insertPath,level);}
_split(insertPath,level){const node=insertPath[level];const M=node.children.length;const m=this._minEntries;this._chooseSplitAxis(node,m,M);const splitIndex=this._chooseSplitIndex(node,m,M);const newNode=createNode(node.children.splice(splitIndex,node.children.length-splitIndex));newNode.height=node.height;newNode.leaf=node.leaf;calcBBox(node,this.toBBox);calcBBox(newNode,this.toBBox);if(level)insertPath[level-1].children.push(newNode);else this._splitRoot(node,newNode);}
_splitRoot(node,newNode){this.data=createNode([node,newNode]);this.data.height=node.height+1;this.data.leaf=false;calcBBox(this.data,this.toBBox);}
_chooseSplitIndex(node,m,M){let index;let minOverlap=Infinity;let minArea=Infinity;for(let i=m;i<=M-m;i++){const bbox1=distBBox(node,0,i,this.toBBox);const bbox2=distBBox(node,i,M,this.toBBox);const overlap=intersectionArea(bbox1,bbox2);const area=bboxArea(bbox1)+bboxArea(bbox2);if(overlap<minOverlap){minOverlap=overlap;index=i;minArea=area<minArea?area:minArea;}else if(overlap===minOverlap){if(area<minArea){minArea=area;index=i;}}}
return index||M-m;}
_chooseSplitAxis(node,m,M){const compareMinX=node.leaf?this.compareMinX:compareNodeMinX;const compareMinY=node.leaf?this.compareMinY:compareNodeMinY;const xMargin=this._allDistMargin(node,m,M,compareMinX);const yMargin=this._allDistMargin(node,m,M,compareMinY);if(xMargin<yMargin)node.children.sort(compareMinX);}
_allDistMargin(node,m,M,compare){node.children.sort(compare);const toBBox=this.toBBox;const leftBBox=distBBox(node,0,m,toBBox);const rightBBox=distBBox(node,M-m,M,toBBox);let margin=bboxMargin(leftBBox)+bboxMargin(rightBBox);for(let i=m;i<M-m;i++){const child=node.children[i];extend(leftBBox,node.leaf?toBBox(child):child);margin+=bboxMargin(leftBBox);}
for(let i=M-m-1;i>=m;i--){const child=node.children[i];extend(rightBBox,node.leaf?toBBox(child):child);margin+=bboxMargin(rightBBox);}
return margin;}
_adjustParentBBoxes(bbox,path,level){for(let i=level;i>=0;i--){extend(path[i],bbox);}}
_condense(path){for(let i=path.length-1,siblings;i>=0;i--){if(path[i].children.length===0){if(i>0){siblings=path[i-1].children;siblings.splice(siblings.indexOf(path[i]),1);}else this.clear();}else calcBBox(path[i],this.toBBox);}}}
function findItem(item,items,equalsFn){if(!equalsFn)return items.indexOf(item);for(let i=0;i<items.length;i++){if(equalsFn(item,items[i]))return i;}
return-1;}
function calcBBox(node,toBBox){distBBox(node,0,node.children.length,toBBox,node);}
function distBBox(node,k,p,toBBox,destNode){if(!destNode)destNode=createNode(null);destNode.minX=Infinity;destNode.minY=Infinity;destNode.maxX=-Infinity;destNode.maxY=-Infinity;for(let i=k;i<p;i++){const child=node.children[i];extend(destNode,node.leaf?toBBox(child):child);}
return destNode;}
function extend(a,b){a.minX=Math.min(a.minX,b.minX);a.minY=Math.min(a.minY,b.minY);a.maxX=Math.max(a.maxX,b.maxX);a.maxY=Math.max(a.maxY,b.maxY);return a;}
function compareNodeMinX(a,b){return a.minX-b.minX;}
function compareNodeMinY(a,b){return a.minY-b.minY;}
function bboxArea(a){return(a.maxX-a.minX)*(a.maxY-a.minY);}
function bboxMargin(a){return(a.maxX-a.minX)+(a.maxY-a.minY);}
function enlargedArea(a,b){return(Math.max(b.maxX,a.maxX)-Math.min(b.minX,a.minX))*(Math.max(b.maxY,a.maxY)-Math.min(b.minY,a.minY));}
function intersectionArea(a,b){const minX=Math.max(a.minX,b.minX);const minY=Math.max(a.minY,b.minY);const maxX=Math.min(a.maxX,b.maxX);const maxY=Math.min(a.maxY,b.maxY);return Math.max(0,maxX-minX)*Math.max(0,maxY-minY);}
function contains(a,b){return a.minX<=b.minX&&a.minY<=b.minY&&b.maxX<=a.maxX&&b.maxY<=a.maxY;}
function intersects(a,b){return b.minX<=a.maxX&&b.minY<=a.maxY&&b.maxX>=a.minX&&b.maxY>=a.minY;}
function createNode(children){return{children,height:1,leaf:true,minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};}
function multiSelect(arr,left,right,n,compare){const stack=[left,right];while(stack.length){right=stack.pop();left=stack.pop();if(right-left<=n)continue;const mid=left+Math.ceil((right-left)/n/2)*n;quickselect(arr,mid,left,right,compare);stack.push(left,mid,mid,right);}}
class SpreadsheetRTree{rTrees={};constructor(items=[]){const rangesPerSheet={};for(const item of items){const sheetId=item.boundingBox.sheetId;if(!rangesPerSheet[sheetId]){rangesPerSheet[sheetId]=[];}
rangesPerSheet[sheetId].push(item);}
for(const sheetId in rangesPerSheet){this.rTrees[sheetId]=new ZoneRBush();this.rTrees[sheetId].load(rangesPerSheet[sheetId]);}}
insert(item){const sheetId=item.boundingBox.sheetId;if(!this.rTrees[sheetId]){this.rTrees[sheetId]=new ZoneRBush();}
this.rTrees[sheetId].insert(item);}
search({zone,sheetId}){if(!this.rTrees[sheetId]){return[];}
return this.rTrees[sheetId].search({minX:zone.left,minY:zone.top,maxX:zone.right,maxY:zone.bottom,});}
remove(item){const sheetId=item.boundingBox.sheetId;if(!this.rTrees[sheetId]){return;}
this.rTrees[sheetId].remove(item,this.rtreeItemComparer);}
rtreeItemComparer(left,right){return(left.data==right.data&&left.boundingBox.sheetId===right.boundingBox.sheetId&&left.boundingBox?.zone.left===right.boundingBox.zone.left&&left.boundingBox?.zone.top===right.boundingBox.zone.top&&left.boundingBox?.zone.right===right.boundingBox.zone.right&&left.boundingBox?.zone.bottom===right.boundingBox.zone.bottom);}}
class ZoneRBush extends RBush{toBBox({boundingBox}){const zone=boundingBox.zone;return{minX:zone.left,minY:zone.top,maxX:zone.right,maxY:zone.bottom,};}
compareMinX(a,b){return a.boundingBox.zone.left-b.boundingBox.zone.left;}
compareMinY(a,b){return a.boundingBox.zone.top-b.boundingBox.zone.top;}}
class FormulaDependencyGraph{encoder;dependencies=new Map();rTree;constructor(encoder,data=[]){this.encoder=encoder;this.rTree=new SpreadsheetRTree(data);}
removeAllDependencies(formulaPositionId){const ranges=this.dependencies.get(formulaPositionId);if(!ranges){return;}
for(const range of ranges){this.rTree.remove(range);}
this.dependencies.delete(formulaPositionId);}
addDependencies(formulaPositionId,dependencies){const rTreeItems=dependencies.map(({sheetId,zone})=>({data:formulaPositionId,boundingBox:{zone,sheetId,},}));for(const item of rTreeItems){this.rTree.insert(item);}
const existingDependencies=this.dependencies.get(formulaPositionId);if(existingDependencies){existingDependencies.push(...rTreeItems);}
else{this.dependencies.set(formulaPositionId,rTreeItems);}}
getCellsDependingOn(ranges){const visited=new JetSet();const queue=Array.from(ranges).reverse();while(queue.length>0){const range=queue.pop();visited.addMany(this.encoder.encodeBoundingBox(range));const impactedPositionIds=this.rTree.search(range).map((dep)=>dep.data);const nextInQueue={};for(const positionId of impactedPositionIds){if(!visited.has(positionId)){const{sheetId,zone}=this.encoder.decodeToBoundingBox(positionId);if(!nextInQueue[sheetId]){nextInQueue[sheetId]=[];}
nextInQueue[sheetId].push(zone);}}
for(const sheetId in nextInQueue){const zones=futureRecomputeZones(nextInQueue[sheetId]);queue.push(...zones.map((zone)=>({sheetId,zone})));}}
visited.deleteMany(ranges.flatMap((r)=>this.encoder.encodeBoundingBox(r)));return visited;}}
class SpreadingRelation{resultsToArrayFormulas=new Map();arrayFormulasToResults=new Map();getFormulaPositionsSpreadingOn(resultPositionId){return this.resultsToArrayFormulas.get(resultPositionId)||EMPTY_ARRAY;}
getArrayResultPositionIds(formulasPositionId){return this.arrayFormulasToResults.get(formulasPositionId)||EMPTY_ARRAY;}
removeNode(positionId){this.resultsToArrayFormulas.delete(positionId);this.arrayFormulasToResults.delete(positionId);}
addRelation({arrayFormulaPositionId,resultPositionId,}){if(!this.resultsToArrayFormulas.has(resultPositionId)){this.resultsToArrayFormulas.set(resultPositionId,new Set());}
this.resultsToArrayFormulas.get(resultPositionId)?.add(arrayFormulaPositionId);if(!this.arrayFormulasToResults.has(arrayFormulaPositionId)){this.arrayFormulasToResults.set(arrayFormulaPositionId,new Set());}
this.arrayFormulasToResults.get(arrayFormulaPositionId)?.add(resultPositionId);}
hasArrayFormulaResult(positionId){return this.resultsToArrayFormulas.has(positionId);}
isArrayFormula(positionId){return this.arrayFormulasToResults.has(positionId);}}
const EMPTY_ARRAY=[];const MAX_ITERATION=30;class Evaluator{context;getters;compilationParams;encoder=new PositionBitsEncoder();evaluatedCells=new Map();formulaDependencies=lazy(new FormulaDependencyGraph(this.encoder));blockedArrayFormulas=new Set();spreadingRelations=new SpreadingRelation();constructor(context,getters){this.context=context;this.getters=getters;this.compilationParams=buildCompilationParameters(this.context,this.getters,this.computeAndSave.bind(this));}
getEvaluatedCell(position){return(this.evaluatedCells.get(this.encoder.encode(position))||createEvaluatedCell("",{locale:this.getters.getLocale()}));}
getSpreadPositionsOf(position){const positionId=this.encoder.encode(position);if(!this.spreadingRelations.isArrayFormula(positionId)){return[];}
return Array.from(this.spreadingRelations.getArrayResultPositionIds(positionId)).map((positionId)=>this.encoder.decode(positionId));}
getArrayFormulaSpreadingOn(position){const positionId=this.encoder.encode(position);const formulaPosition=this.getArrayFormulaSpreadingOnId(positionId);return formulaPosition!==undefined?this.encoder.decode(formulaPosition):undefined;}
getEvaluatedPositions(){return[...this.evaluatedCells.keys()].map((p)=>this.encoder.decode(p));}
getArrayFormulaSpreadingOnId(positionId){if(!this.spreadingRelations.hasArrayFormulaResult(positionId)){return undefined;}
const arrayFormulas=this.spreadingRelations.getFormulaPositionsSpreadingOn(positionId);return Array.from(arrayFormulas).find((positionId)=>!this.blockedArrayFormulas.has(positionId));}
updateDependencies(position){const positionId=this.encoder.encode(position);this.formulaDependencies().removeAllDependencies(positionId);const dependencies=this.getDirectDependencies(positionId);this.formulaDependencies().addDependencies(positionId,dependencies);}
updateCompilationParameters(){this.compilationParams=buildCompilationParameters(this.context,this.getters,this.computeAndSave.bind(this));}
evaluateCells(positions){const cells=positions.map((p)=>this.encoder.encode(p));const cellsToCompute=new JetSet(cells);const arrayFormulasPositionIds=this.getArrayFormulasImpactedByChangesOf(cells);cellsToCompute.addMany(this.getCellsDependingOn(cells));cellsToCompute.addMany(arrayFormulasPositionIds);cellsToCompute.addMany(this.getCellsDependingOn(arrayFormulasPositionIds));this.evaluate(cellsToCompute);}
getArrayFormulasImpactedByChangesOf(positionIds){const impactedPositionIds=new JetSet();for(const positionId of positionIds){const content=this.getCell(positionId)?.content;const arrayFormulaPositionId=this.getArrayFormulaSpreadingOnId(positionId);if(arrayFormulaPositionId!==undefined){impactedPositionIds.add(arrayFormulaPositionId);}
if(!content){impactedPositionIds.addMany(this.getArrayFormulasBlockedBy(positionId));}}
return impactedPositionIds;}
buildDependencyGraph(){this.blockedArrayFormulas=new Set();this.spreadingRelations=new SpreadingRelation();this.formulaDependencies=lazy(()=>{const dependencies=[...this.getAllCells()].flatMap((positionId)=>this.getDirectDependencies(positionId).filter((range)=>!range.invalidSheetName&&!range.invalidXc).map((range)=>({data:positionId,boundingBox:{zone:range.zone,sheetId:range.sheetId,},})));return new FormulaDependencyGraph(this.encoder,dependencies);});}
evaluateAllCells(){this.evaluatedCells=new Map();this.evaluate(this.getAllCells());}
evaluateFormula(sheetId,formulaString){const compiledFormula=compile(formulaString);const ranges=compiledFormula.dependencies.map((xc)=>this.getters.getRangeFromSheetXC(sheetId,xc));this.updateCompilationParameters();const array=compiledFormula.execute(ranges,...this.compilationParams);if(isMatrix(array)){return matrixMap(array,(cell)=>cell.value);}
return array.value;}
getAllCells(){const positionIds=new JetSet();for(const sheetId of this.getters.getSheetIds()){const cellIds=this.getters.getCells(sheetId);for(const cellId in cellIds){positionIds.add(this.encoder.encode(this.getters.getCellPosition(cellId)));}}
return positionIds;}
getArrayFormulasBlockedBy(positionId){if(!this.spreadingRelations.hasArrayFormulaResult(positionId)){return[];}
const arrayFormulas=this.spreadingRelations.getFormulaPositionsSpreadingOn(positionId);const cells=new JetSet(arrayFormulas);const arrayFormulaPositionId=this.getArrayFormulaSpreadingOnId(positionId);if(arrayFormulaPositionId){cells.delete(arrayFormulaPositionId);}
cells.addMany(this.getCellsDependingOn(cells));return cells;}
nextPositionsToUpdate=new JetSet();cellsBeingComputed=new Set();evaluate(cells){this.cellsBeingComputed=new Set();this.nextPositionsToUpdate=cells;let currentIteration=0;while(this.nextPositionsToUpdate.size&&currentIteration++<MAX_ITERATION){this.updateCompilationParameters();const positionIds=Array.from(this.nextPositionsToUpdate);this.nextPositionsToUpdate.clear();for(let i=0;i<positionIds.length;++i){const cell=positionIds[i];this.evaluatedCells.delete(cell);}
for(let i=0;i<positionIds.length;++i){const cell=positionIds[i];this.setEvaluatedCell(cell,this.computeCell(cell));}}}
setEvaluatedCell(positionId,evaluatedCell){this.evaluatedCells.set(positionId,evaluatedCell);}
computeCell(positionId){const evaluation=this.evaluatedCells.get(positionId);if(evaluation){return evaluation;}
if(!this.blockedArrayFormulas.has(positionId)){this.invalidateSpreading(positionId);}
const cell=this.getCell(positionId);if(cell===undefined){return createEvaluatedCell("",{locale:this.getters.getLocale()});}
const cellId=cell.id;try{if(this.cellsBeingComputed.has(cellId)){throw new CircularDependencyError();}
this.cellsBeingComputed.add(cellId);return cell.isFormula?this.computeFormulaCell(cell):evaluateLiteral(cell.content,{format:cell.format,locale:this.getters.getLocale()});}
catch(e){return this.handleError(e,cell);}
finally{this.cellsBeingComputed.delete(cellId);}}
computeAndSave(position){const positionId=this.encoder.encode(position);const evaluatedCell=this.computeCell(positionId);if(!this.evaluatedCells.has(positionId)){this.setEvaluatedCell(positionId,evaluatedCell);}
return evaluatedCell;}
handleError(e,cell){if(!(e instanceof EvaluationError)){e=new EvaluationError(CellErrorType.GenericError,e.message);}
const __lastFnCalled=this.compilationParams[2].__lastFnCalled||"";e.message=e.message.replace("[[FUNCTION_NAME]]",__lastFnCalled);return errorCell(e);}
computeFormulaCell(cellData){const cellId=cellData.id;this.compilationParams[2].__originCellXC=()=>{const position=this.compilationParams[2].getters.getCellPosition(cellId);return toXC(position.col,position.row);};const formulaReturn=cellData.compiledFormula.execute(cellData.compiledFormula.dependencies,...this.compilationParams);if(!isMatrix(formulaReturn)){return createEvaluatedCell(formulaReturn.value,{format:cellData.format||formulaReturn.format,locale:this.getters.getLocale(),});}
const formulaPosition=this.getters.getCellPosition(cellId);this.assertSheetHasEnoughSpaceToSpreadFormulaResult(formulaPosition,formulaReturn);const nbColumns=formulaReturn.length;const nbRows=formulaReturn[0].length;forEachSpreadPositionInMatrix(nbColumns,nbRows,this.updateSpreadRelation(formulaPosition));forEachSpreadPositionInMatrix(nbColumns,nbRows,this.checkCollision(formulaPosition));forEachSpreadPositionInMatrix(nbColumns,nbRows,this.spreadValues(formulaPosition,formulaReturn));return createEvaluatedCell(formulaReturn[0][0].value,{format:cellData.format||formulaReturn[0][0]?.format,locale:this.getters.getLocale(),});}
assertSheetHasEnoughSpaceToSpreadFormulaResult({sheetId,col,row},matrixResult){const numberOfCols=this.getters.getNumberCols(sheetId);const numberOfRows=this.getters.getNumberRows(sheetId);const enoughCols=col+matrixResult.length<=numberOfCols;const enoughRows=row+matrixResult[0].length<=numberOfRows;if(enoughCols&&enoughRows){return;}
if(enoughCols){throw new Error(_t("Result couldn't be automatically expanded. Please insert more rows."));}
if(enoughRows){throw new Error(_t("Result couldn't be automatically expanded. Please insert more columns."));}
throw new Error(_t("Result couldn't be automatically expanded. Please insert more columns and rows."));}
updateSpreadRelation({sheetId,col,row,}){const arrayFormulaPositionId=this.encoder.encode({sheetId,col,row});return(i,j)=>{const position={sheetId,col:i+col,row:j+row};const resultPositionId=this.encoder.encode(position);this.spreadingRelations.addRelation({resultPositionId,arrayFormulaPositionId});};}
checkCollision({sheetId,col,row}){const formulaPositionId=this.encoder.encode({sheetId,col,row});return(i,j)=>{const position={sheetId:sheetId,col:i+col,row:j+row};const rawCell=this.getters.getCell(position);if(rawCell?.content||this.getters.getEvaluatedCell(position).type!==CellValueType.empty){this.blockedArrayFormulas.add(formulaPositionId);throw new Error(_t("Array result was not expanded because it would overwrite data in %s.",toXC(position.col,position.row)));}
this.blockedArrayFormulas.delete(formulaPositionId);};}
spreadValues({sheetId,col,row},matrixResult){return(i,j)=>{const position={sheetId,col:i+col,row:j+row};const cell=this.getters.getCell(position);const format=cell?.format;const evaluatedCell=createEvaluatedCell(matrixResult[i][j].value,{format:format||matrixResult[i][j]?.format,locale:this.getters.getLocale(),});const positionId=this.encoder.encode(position);this.setEvaluatedCell(positionId,evaluatedCell);this.nextPositionsToUpdate.addMany(this.getCellsDependingOn([positionId]));};}
invalidateSpreading(positionId){if(!this.spreadingRelations.isArrayFormula(positionId)){return;}
for(const child of this.spreadingRelations.getArrayResultPositionIds(positionId)){const content=this.getCell(child)?.content;if(content){continue;}
this.evaluatedCells.delete(child);this.nextPositionsToUpdate.addMany(this.getCellsDependingOn([child]));this.nextPositionsToUpdate.addMany(this.getArrayFormulasBlockedBy(child));}
this.spreadingRelations.removeNode(positionId);}
getDirectDependencies(positionId){const cell=this.getCell(positionId);if(!cell?.isFormula){return[];}
return cell.compiledFormula.dependencies;}
getCellsDependingOn(positionIds){const ranges=[];for(const positionId of positionIds){ranges.push(this.encoder.decodeToBoundingBox(positionId));}
return this.formulaDependencies().getCellsDependingOn(ranges);}
getCell(positionId){return this.getters.getCell(this.encoder.decode(positionId));}}
function forEachSpreadPositionInMatrix(nbColumns,nbRows,callback){for(let i=0;i<nbColumns;++i){for(let j=0;j<nbRows;++j){if(i===0&&j===0){continue;}
callback(i,j);}}}
class PositionBitsEncoder{sheetMapping={};inverseSheetMapping=new Map();constructor(){try{o_spreadsheet.__DEBUG__=o_spreadsheet.__DEBUG__||{};o_spreadsheet.__DEBUG__.decodePosition=this.decode.bind(this);o_spreadsheet.__DEBUG__.encodePosition=this.encode.bind(this);}
catch(error){}}
encode({sheetId,col,row}){return(this.encodeSheet(sheetId)<<42n)|(BigInt(col)<<21n)|BigInt(row);}
encodeBoundingBox({sheetId,zone}){const positions=[];forEachPositionsInZone(zone,(col,row)=>{positions.push(this.encode({sheetId,col,row}));});return positions;}
decode(id){const row=Number(id&2097151n);const col=Number((id>>21n)&2097151n);const sheetId=this.decodeSheet(id>>42n);return{sheetId,col,row};}
decodeToBoundingBox(id){const{sheetId,col,row}=this.decode(id);return{sheetId,zone:{left:col,top:row,right:col,bottom:row}};}
encodeSheet(sheetId){const sheetKey=this.sheetMapping[sheetId];if(sheetKey===undefined){const newSheetKey=BigInt(Object.keys(this.sheetMapping).length);this.sheetMapping[sheetId]=newSheetKey;this.inverseSheetMapping.set(newSheetKey,sheetId);return newSheetKey;}
return sheetKey;}
decodeSheet(sheetKey){const sheetId=this.inverseSheetMapping.get(sheetKey);if(sheetId===undefined){throw new Error("Sheet id not found");}
return sheetId;}}
class EvaluationPlugin extends UIPlugin{static getters=["evaluateFormula","getCorrespondingFormulaCell","getRangeFormattedValues","getRangeValues","getRangeFormats","getEvaluatedCell","getEvaluatedCells","getEvaluatedCellsInZone","getSpreadPositionsOf","getArrayFormulaSpreadingOn","isEmpty",];shouldRebuildDependenciesGraph=true;evaluator;positionsToUpdate=[];constructor(config){super(config);this.evaluator=new Evaluator(config.custom,this.getters);}
beforeHandle(cmd){if(invalidateDependenciesCommands.has(cmd.type)){this.shouldRebuildDependenciesGraph=true;}}
handle(cmd){switch(cmd.type){case"UPDATE_CELL":if(!("content"in cmd||"format"in cmd)||this.shouldRebuildDependenciesGraph){return;}
this.positionsToUpdate.push(cmd);if("content"in cmd){this.evaluator.updateDependencies(cmd);}
break;case"EVALUATE_CELLS":this.evaluator.evaluateAllCells();break;}}
finalize(){if(this.shouldRebuildDependenciesGraph){this.evaluator.buildDependencyGraph();this.evaluator.evaluateAllCells();this.shouldRebuildDependenciesGraph=false;}
else if(this.positionsToUpdate.length){this.evaluator.evaluateCells(this.positionsToUpdate);}
this.positionsToUpdate=[];}
evaluateFormula(sheetId,formulaString){try{return this.evaluator.evaluateFormula(sheetId,formulaString);}
catch(error){return error instanceof EvaluationError?error.errorType:CellErrorType.GenericError;}}
getRangeFormattedValues(range){const sheet=this.getters.tryGetSheet(range.sheetId);if(sheet===undefined)
return[];return this.getters.getEvaluatedCellsInZone(sheet.id,range.zone).map((cell)=>cell.formattedValue);}
getRangeValues(range){const sheet=this.getters.tryGetSheet(range.sheetId);if(sheet===undefined)
return[];return this.getters.getEvaluatedCellsInZone(sheet.id,range.zone).map((cell)=>cell.value);}
getRangeFormats(range){const sheet=this.getters.tryGetSheet(range.sheetId);if(sheet===undefined)
return[];return this.getters.getEvaluatedCellsInZone(sheet.id,range.zone).map((cell)=>cell.format);}
getEvaluatedCell(position){return this.evaluator.getEvaluatedCell(position);}
getEvaluatedCells(sheetId){const rawCells=this.getters.getCells(sheetId)||{};const record={};for(let cellId of Object.keys(rawCells)){const position=this.getters.getCellPosition(cellId);record[cellId]=this.getEvaluatedCell(position);}
return record;}
getEvaluatedCellsInZone(sheetId,zone){return positions(zone).map(({col,row})=>this.getters.getEvaluatedCell({sheetId,col,row}));}
getSpreadPositionsOf(position){return this.evaluator.getSpreadPositionsOf(position);}
getArrayFormulaSpreadingOn(position){return this.evaluator.getArrayFormulaSpreadingOn(position);}
isEmpty(sheetId,zone){return positions(zone).map(({col,row})=>this.getEvaluatedCell({sheetId,col,row})).every((cell)=>cell.type===CellValueType.empty);}
exportForExcel(data){for(const position of this.evaluator.getEvaluatedPositions()){const evaluatedCell=this.evaluator.getEvaluatedCell(position);const xc=toXC(position.col,position.row);const value=evaluatedCell.value;let isFormula=false;let newContent=undefined;let newFormat=undefined;let isExported=true;const exportedSheetData=data.sheets.find((sheet)=>sheet.id===position.sheetId);const formulaCell=this.getCorrespondingFormulaCell(position);if(formulaCell){isExported=isExportableToExcel(formulaCell.compiledFormula.tokens);isFormula=isExported;if(!isExported){if(value!==""){newContent=value.toString();newFormat=evaluatedCell.format;}}}
const exportedCellData=exportedSheetData.cells[xc]||{};const format=newFormat?getItemId(newFormat,data.formats):exportedCellData.format;let content;if(isExported&&isFormula&&formulaCell?.compiledFormula.dependencies.length){content=this.getters.getFormulaCellContent(exportedSheetData.id,formulaCell.compiledFormula,formulaCell.compiledFormula.dependencies,true);}
else{content=!isExported?newContent:exportedCellData.content;}
exportedSheetData.cells[xc]={...exportedCellData,value,isFormula,content,format};}}
getCorrespondingFormulaCell(position){const cell=this.getters.getCell(position);if(cell&&cell.isFormula){return isBadExpression(cell.compiledFormula.tokens)?undefined:cell;}
else if(cell&&cell.content){return undefined;}
const spreadingFormulaPosition=this.getArrayFormulaSpreadingOn(position);if(spreadingFormulaPosition===undefined){return undefined;}
const spreadingFormulaCell=this.getters.getCell(spreadingFormulaPosition);if(spreadingFormulaCell?.isFormula){return spreadingFormulaCell;}
return undefined;}}
function isBadExpression(tokens){try{compileTokens(tokens);return false;}
catch(error){return true;}}
function sortWithClusters(colorsToSort){const clusters=[{leadColor:rgba(255,0,0),colors:[]},{leadColor:rgba(255,128,0),colors:[]},{leadColor:rgba(128,128,0),colors:[]},{leadColor:rgba(128,255,0),colors:[]},{leadColor:rgba(0,255,0),colors:[]},{leadColor:rgba(0,255,128),colors:[]},{leadColor:rgba(0,255,255),colors:[]},{leadColor:rgba(0,127,255),colors:[]},{leadColor:rgba(0,0,255),colors:[]},{leadColor:rgba(127,0,255),colors:[]},{leadColor:rgba(128,0,128),colors:[]},{leadColor:rgba(255,0,128),colors:[]},];for(const color of colorsToSort.map(colorToRGBA)){let currentDistance=500;let currentIndex=0;clusters.forEach((cluster,clusterIndex)=>{const distance=colorDistance(color,cluster.leadColor);if(currentDistance>distance){currentDistance=distance;currentIndex=clusterIndex;}});clusters[currentIndex].colors.push(color);}
return clusters.map((cluster)=>cluster.colors.sort((a,b)=>rgbaToHSLA(a).s-rgbaToHSLA(b).s)).flat().map(rgbaToHex);}
function colorDistance(color1,color2){return Math.sqrt(Math.pow(color1.r-color2.r,2)+
Math.pow(color1.g-color2.g,2)+
Math.pow(color1.b-color2.b,2));}
class CustomColorsPlugin extends UIPlugin{customColors={};shouldUpdateColors=false;static getters=["getCustomColors"];handle(cmd){switch(cmd.type){case"UPDATE_CELL":case"UPDATE_CHART":case"CREATE_CHART":case"ADD_CONDITIONAL_FORMAT":case"SET_BORDER":case"SET_ZONE_BORDERS":case"SET_FORMATTING":this.history.update("shouldUpdateColors",true);}}
finalize(){if(this.shouldUpdateColors){this.history.update("shouldUpdateColors",false);for(const color of this.getCustomColors()){this.tryToAddColor(color);}}}
getCustomColors(){let usedColors=[];for(const sheetId of this.getters.getSheetIds()){usedColors=usedColors.concat(this.getColorsFromCells(sheetId),this.getFormattingColors(sheetId),this.getChartColors(sheetId));}
return sortWithClusters([...new Set([...new Set([...usedColors,...Object.keys(this.customColors)])].filter(isColorValid).map(toHex)),]).filter((color)=>!COLOR_PICKER_DEFAULTS.includes(color));}
getColorsFromCells(sheetId){const cells=Object.values(this.getters.getCells(sheetId));const colors=new Set();for(const cell of cells){if(cell.style?.textColor){colors.add(cell.style.textColor);}
if(cell.style?.fillColor){colors.add(cell.style.fillColor);}}
for(const color of this.getters.getBordersColors(sheetId)){colors.add(color);}
return[...colors];}
getFormattingColors(sheetId){const formats=this.getters.getConditionalFormats(sheetId);const formatColors=[];for(const format of formats){const rule=format.rule;if(rule.type==="CellIsRule"){formatColors.push(rule.style.textColor);formatColors.push(rule.style.fillColor);}
else if(rule.type==="ColorScaleRule"){formatColors.push(colorNumberString(rule.minimum.color));formatColors.push(rule.midpoint?colorNumberString(rule.midpoint.color):undefined);formatColors.push(colorNumberString(rule.maximum.color));}}
return formatColors.filter(isDefined$1);}
getChartColors(sheetId){const charts=this.getters.getChartIds(sheetId).map((cid)=>this.getters.getChart(cid));let chartsColors=new Set();for(let chart of charts){if(chart===undefined){continue;}
const background=chart.getDefinition().background;if(background!==undefined){chartsColors.add(background);}
switch(chart.type){case"gauge":const colors=chart.sectionRule.colors;chartsColors.add(colors.lowerColor);chartsColors.add(colors.middleColor);chartsColors.add(colors.upperColor);break;case"scorecard":const scoreChart=chart;chartsColors.add(scoreChart.baselineColorDown);chartsColors.add(scoreChart.baselineColorUp);break;}}
return[...chartsColors];}
tryToAddColor(color){const formattedColor=toHex(color);if(color&&!COLOR_PICKER_DEFAULTS.includes(formattedColor)){this.history.update("customColors",formattedColor,true);}}}
class EvaluationChartPlugin extends UIPlugin{static getters=["getChartRuntime","getStyleOfSingleCellChart"];charts={};createRuntimeChart=chartRuntimeFactory(this.getters);handle(cmd){if(invalidateEvaluationCommands.has(cmd.type)||invalidateCFEvaluationCommands.has(cmd.type)||cmd.type==="EVALUATE_CELLS"||cmd.type==="UPDATE_CELL"){for(const chartId in this.charts){this.charts[chartId]=undefined;}}
switch(cmd.type){case"UPDATE_CHART":case"CREATE_CHART":case"DELETE_FIGURE":this.charts[cmd.id]=undefined;break;case"DELETE_SHEET":for(let chartId in this.charts){if(!this.getters.isChartDefined(chartId)){this.charts[chartId]=undefined;}}
break;}}
getChartRuntime(figureId){if(!this.charts[figureId]){const chart=this.getters.getChart(figureId);if(!chart){throw new Error(`No chart for the given id: ${figureId}`);}
this.charts[figureId]=this.createRuntimeChart(chart);}
return this.charts[figureId];}
getStyleOfSingleCellChart(chartBackground,mainRange){if(chartBackground)
return{background:chartBackground,fontColor:chartFontColor(chartBackground)};if(!mainRange){return{background:BACKGROUND_CHART_COLOR,fontColor:chartFontColor(BACKGROUND_CHART_COLOR),};}
const col=mainRange.zone.left;const row=mainRange.zone.top;const sheetId=mainRange.sheetId;const style=this.getters.getCellComputedStyle({sheetId,col,row});const background=style.fillColor||BACKGROUND_CHART_COLOR;return{background,fontColor:style.textColor||chartFontColor(background),};}
exportForExcel(data){for(const sheet of data.sheets){if(!sheet.images){sheet.images=[];}
const sheetFigures=this.getters.getFigures(sheet.id);const figures=[];for(const figure of sheetFigures){if(!figure||figure.tag!=="chart"){continue;}
const figureId=figure.id;const figureData=this.getters.getChart(figureId)?.getDefinitionForExcel();if(figureData){figures.push({...figure,data:figureData,});}
else{const chart=this.getters.getChart(figureId);if(!chart){continue;}
const type=this.getters.getChartType(figureId);const runtime=this.getters.getChartRuntime(figureId);const img=chartToImage(runtime,figure,type);sheet.images.push({...figure,tag:"image",data:{mimetype:"image/png",path:img,size:{width:figure.width,height:figure.height},},});}}
sheet.charts=figures;}}}
class EvaluationConditionalFormatPlugin extends UIPlugin{static getters=["getConditionalIcon","getCellComputedStyle"];isStale=true;computedStyles={};computedIcons={};handle(cmd){if(invalidateCFEvaluationCommands.has(cmd.type)||(cmd.type==="UPDATE_CELL"&&"content"in cmd)){this.isStale=true;}}
finalize(){if(this.isStale){for(const sheetId of this.getters.getSheetIds()){this.computedStyles[sheetId]=lazy(()=>this.getComputedStyles(sheetId));this.computedIcons[sheetId]=lazy(()=>this.getComputedIcons(sheetId));}
this.isStale=false;}}
getCellComputedStyle(position){const{sheetId,col,row}=position;const cell=this.getters.getCell(position);const styles=this.computedStyles[sheetId]();const cfStyle=styles&&styles[col]?.[row];const computedStyle={...cell?.style,...cfStyle,};const evaluatedCell=this.getters.getEvaluatedCell(position);if(evaluatedCell.link&&!computedStyle.textColor){computedStyle.textColor=LINK_COLOR;}
if(this.getters.isFilterHeader(position)){computedStyle.bold=true;}
return computedStyle;}
getConditionalIcon({sheetId,col,row}){const icons=this.computedIcons[sheetId]();return icons&&icons[col]?.[row];}
getComputedStyles(sheetId){const computedStyle={};for(let cf of this.getters.getConditionalFormats(sheetId).reverse()){switch(cf.rule.type){case"ColorScaleRule":for(let range of cf.ranges){this.applyColorScale(sheetId,range,cf.rule,computedStyle);}
break;case"CellIsRule":const formulas=cf.rule.values.map((value)=>value.startsWith("=")?compile(value):undefined);for(let ref of cf.ranges){const zone=this.getters.getRangeFromSheetXC(sheetId,ref).zone;for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const predicate=this.rulePredicate[cf.rule.type];const target={sheetId,col,row};const values=cf.rule.values.map((value,i)=>{const compiledFormula=formulas[i];if(compiledFormula){return this.getters.getTranslatedCellFormula(sheetId,col-zone.left,row-zone.top,{...compiledFormula,dependencies:compiledFormula.dependencies.map((d)=>this.getters.getRangeFromSheetXC(sheetId,d)),});}
return value;});if(predicate&&predicate(target,{...cf.rule,values})){if(!computedStyle[col])
computedStyle[col]=[];computedStyle[col][row]=Object.assign(computedStyle[col]?.[row]||{},cf.rule.style);}}}}
break;}}
return computedStyle;}
getComputedIcons(sheetId){const computedIcons={};for(let cf of this.getters.getConditionalFormats(sheetId).reverse()){if(cf.rule.type!=="IconSetRule")
continue;for(let range of cf.ranges){this.applyIcon(sheetId,range,cf.rule,computedIcons);}}
return computedIcons;}
parsePoint(sheetId,range,threshold,functionName){const rangeValues=this.getters.getEvaluatedCellsInZone(sheetId,this.getters.getRangeFromSheetXC(sheetId,range).zone).filter((cell)=>cell.type===CellValueType.number).map((cell)=>cell.value);switch(threshold.type){case"value":const result=functionName==="max"?largeMax(rangeValues):largeMin(rangeValues);return result;case"number":return Number(threshold.value);case"percentage":const min=largeMin(rangeValues);const max=largeMax(rangeValues);const delta=max-min;return min+(delta*Number(threshold.value))/100;case"percentile":return percentile(rangeValues,Number(threshold.value)/100,true);case"formula":const value=threshold.value&&this.getters.evaluateFormula(sheetId,threshold.value);return typeof value==="number"?value:null;default:return null;}}
applyIcon(sheetId,range,rule,computedIcons){const lowerInflectionPoint=this.parsePoint(sheetId,range,rule.lowerInflectionPoint);const upperInflectionPoint=this.parsePoint(sheetId,range,rule.upperInflectionPoint);if(lowerInflectionPoint===null||upperInflectionPoint===null||lowerInflectionPoint>upperInflectionPoint){return;}
const zone=this.getters.getRangeFromSheetXC(sheetId,range).zone;const iconSet=[rule.icons.upper,rule.icons.middle,rule.icons.lower];for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.type!==CellValueType.number){continue;}
const icon=this.computeIcon(cell.value,upperInflectionPoint,rule.upperInflectionPoint.operator,lowerInflectionPoint,rule.lowerInflectionPoint.operator,iconSet);if(!computedIcons[col]){computedIcons[col]=[];}
computedIcons[col][row]=icon;}}}
computeIcon(value,upperInflectionPoint,upperOperator,lowerInflectionPoint,lowerOperator,icons){if((upperOperator==="ge"&&value>=upperInflectionPoint)||(upperOperator==="gt"&&value>upperInflectionPoint)){return icons[0];}
else if((lowerOperator==="ge"&&value>=lowerInflectionPoint)||(lowerOperator==="gt"&&value>lowerInflectionPoint)){return icons[1];}
return icons[2];}
applyColorScale(sheetId,range,rule,computedStyle){const minValue=this.parsePoint(sheetId,range,rule.minimum,"min");const midValue=rule.midpoint?this.parsePoint(sheetId,range,rule.midpoint):null;const maxValue=this.parsePoint(sheetId,range,rule.maximum,"max");if(minValue===null||maxValue===null||minValue>=maxValue||(midValue&&(minValue>=midValue||midValue>=maxValue))){return;}
const zone=this.getters.getRangeFromSheetXC(sheetId,range).zone;const colorCellArgs=[];if(rule.midpoint&&midValue){colorCellArgs.push({minValue,minColor:rule.minimum.color,colorDiffUnit:this.computeColorDiffUnits(minValue,midValue,rule.minimum.color,rule.midpoint.color),});colorCellArgs.push({minValue:midValue,minColor:rule.midpoint.color,colorDiffUnit:this.computeColorDiffUnits(midValue,maxValue,rule.midpoint.color,rule.maximum.color),});}
else{colorCellArgs.push({minValue,minColor:rule.minimum.color,colorDiffUnit:this.computeColorDiffUnits(minValue,maxValue,rule.minimum.color,rule.maximum.color),});}
for(let row=zone.top;row<=zone.bottom;row++){for(let col=zone.left;col<=zone.right;col++){const cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.type===CellValueType.number){const value=clip(cell.value,minValue,maxValue);let color;if(colorCellArgs.length===2&&midValue){color=value<=midValue?this.colorCell(value,colorCellArgs[0].minValue,colorCellArgs[0].minColor,colorCellArgs[0].colorDiffUnit):this.colorCell(value,colorCellArgs[1].minValue,colorCellArgs[1].minColor,colorCellArgs[1].colorDiffUnit);}
else{color=this.colorCell(value,colorCellArgs[0].minValue,colorCellArgs[0].minColor,colorCellArgs[0].colorDiffUnit);}
if(!computedStyle[col])
computedStyle[col]=[];computedStyle[col][row]=computedStyle[col]?.[row]||{};computedStyle[col][row].fillColor=colorNumberString(color);}}}}
computeColorDiffUnits(minValue,maxValue,minColor,maxColor){const deltaValue=maxValue-minValue;const deltaColorR=((minColor>>16)%256)-((maxColor>>16)%256);const deltaColorG=((minColor>>8)%256)-((maxColor>>8)%256);const deltaColorB=(minColor%256)-(maxColor%256);const colorDiffUnitR=deltaColorR/deltaValue;const colorDiffUnitG=deltaColorG/deltaValue;const colorDiffUnitB=deltaColorB/deltaValue;return[colorDiffUnitR,colorDiffUnitG,colorDiffUnitB];}
colorCell(value,minValue,minColor,colorDiffUnit){const[colorDiffUnitR,colorDiffUnitG,colorDiffUnitB]=colorDiffUnit;const r=Math.round(((minColor>>16)%256)-colorDiffUnitR*(value-minValue));const g=Math.round(((minColor>>8)%256)-colorDiffUnitG*(value-minValue));const b=Math.round((minColor%256)-colorDiffUnitB*(value-minValue));return(r<<16)|(g<<8)|b;}
rulePredicate={CellIsRule:(target,rule)=>{const cell=this.getters.getEvaluatedCell(target);if(cell.type===CellValueType.error){return false;}
const[value0,value1]=rule.values.map((val)=>{if(val.startsWith("=")){return this.getters.evaluateFormula(target.sheetId,val)??"";}
return parseLiteral(val,DEFAULT_LOCALE);});if(isMatrix(value0)||isMatrix(value1)){return false;}
switch(rule.operator){case"IsEmpty":return cell.value.toString().trim()==="";case"IsNotEmpty":return cell.value.toString().trim()!=="";case"BeginsWith":if(value0===""){return false;}
return cell.value.toString().startsWith(value0.toString());case"EndsWith":if(value0===""){return false;}
return cell.value.toString().endsWith(value0.toString());case"Between":return cell.value>=value0&&cell.value<=value1;case"NotBetween":return!(cell.value>=value0&&cell.value<=value1);case"ContainsText":return cell.value.toString().indexOf(value0.toString())>-1;case"NotContains":return!cell.value||cell.value.toString().indexOf(value0.toString())===-1;case"GreaterThan":return cell.value>value0;case"GreaterThanOrEqual":return cell.value>=value0;case"LessThan":return cell.value<value0;case"LessThanOrEqual":return cell.value<=value0;case"NotEqual":if(value0===""){return false;}
return cell.value!==value0;case"Equal":if(value0===""){return true;}
return cell.value===value0;default:console.warn(_t("Not implemented operator %s for kind of conditional formatting:  %s",rule.operator,rule.type));}
return false;},};}
const VALID_RESULT={isValid:true};class EvaluationDataValidationPlugin extends UIPlugin{static getters=["getDataValidationInvalidCriterionValueMessage","getInvalidDataValidationMessage","getValidationResultForCellValue","isCellValidCheckbox","isDataValidationInvalid",];validationResults={};handle(cmd){if(invalidateEvaluationCommands.has(cmd.type)||cmd.type==="EVALUATE_CELLS"||(cmd.type==="UPDATE_CELL"&&"content"in cmd)){this.validationResults={};return;}
switch(cmd.type){case"ADD_DATA_VALIDATION_RULE":case"REMOVE_DATA_VALIDATION_RULE":delete this.validationResults[cmd.sheetId];break;}}
isDataValidationInvalid(cellPosition){return!this.getValidationResultForCell(cellPosition).isValid;}
getInvalidDataValidationMessage(cellPosition){const validationResult=this.getValidationResultForCell(cellPosition);return validationResult.isValid?undefined:validationResult.error;}
getDataValidationInvalidCriterionValueMessage(criterionType,value){const evaluator=dataValidationEvaluatorRegistry.get(criterionType);if(value.startsWith("=")){return evaluator.allowedValues==="onlyLiterals"?_t("The value must not be a formula"):undefined;}
else if(evaluator.allowedValues==="onlyFormulas"){return _t("The value must be a formula");}
return evaluator.isCriterionValueValid(value)?undefined:evaluator.criterionValueErrorString;}
isCellValidCheckbox(cellPosition){if(!this.getters.isMainCellPosition(cellPosition)){return false;}
const rule=this.getters.getValidationRuleForCell(cellPosition);if(!rule||rule.criterion.type!=="isBoolean"){return false;}
return this.getValidationResultForCell(cellPosition).isValid;}
getValidationResultForCellValue(cellValue,cellPosition){const rule=this.getters.getValidationRuleForCell(cellPosition);if(!rule){return VALID_RESULT;}
const error=this.getRuleErrorForCellValue(cellValue,cellPosition,rule);return error?{error,rule,isValid:false}:VALID_RESULT;}
getValidationResultForCell(cellPosition){const{col,row,sheetId}=cellPosition;if(!this.validationResults[sheetId]){this.validationResults[sheetId]=this.computeSheetValidationResults(sheetId);}
return this.validationResults[sheetId][col]?.[row]?.()||VALID_RESULT;}
computeSheetValidationResults(sheetId){const validationResults={};const ranges=this.getters.getDataValidationRules(sheetId).map((rule)=>rule.ranges);for(const cellPosition of getCellPositionsInRanges(ranges.flat())){const{col,row}=cellPosition;if(!validationResults[col]){validationResults[col]=[];}
validationResults[col][row]=lazy(()=>{const evaluatedCell=this.getters.getEvaluatedCell(cellPosition);if(evaluatedCell.type===CellValueType.empty){return VALID_RESULT;}
return this.getValidationResultForCellValue(evaluatedCell.value,cellPosition);});}
return validationResults;}
getRuleErrorForCellValue(cellValue,cellPosition,rule){const{sheetId}=cellPosition;const criterion=rule.criterion;const evaluator=dataValidationEvaluatorRegistry.get(criterion.type);const offset=this.getCellOffsetInRule(cellPosition,rule);const evaluatedCriterionValues=this.getEvaluatedCriterionValues(sheetId,offset,criterion);const evaluatedCriterion={...criterion,values:evaluatedCriterionValues};if(evaluator.isValueValid(cellValue,evaluatedCriterion,this.getters,sheetId)){return undefined;}
return evaluator.getErrorString(evaluatedCriterion,this.getters,sheetId);}
getCellOffsetInRule(cellPosition,rule){const range=rule.ranges.find((range)=>isInside(cellPosition.col,cellPosition.row,range.zone));if(!range){throw new Error("The cell is not in any range of the rule");}
return{col:cellPosition.col-range.zone.left,row:cellPosition.row-range.zone.top,};}
getEvaluatedCriterionValues(sheetId,offset,criterion){return criterion.values.map((value)=>{if(!value.startsWith("=")){return value;}
try{const formula=compile(value);const translatedFormula=this.getters.getTranslatedCellFormula(sheetId,offset.col,offset.row,{...formula,dependencies:formula.dependencies.map((d)=>this.getters.getRangeFromSheetXC(sheetId,d)),});const evaluated=this.getters.evaluateFormula(sheetId,translatedFormula);return evaluated&&!isMatrix(evaluated)?evaluated.toString():"";}
catch(e){return e instanceof EvaluationError?e.errorType:CellErrorType.GenericError;}});}}
class HeaderSizeUIPlugin extends UIPlugin{static getters=["getRowSize","getHeaderSize"];tallestCellInRow={};ctx=document.createElement("canvas").getContext("2d");handle(cmd){switch(cmd.type){case"START":for(const sheetId of this.getters.getSheetIds()){this.initializeSheet(sheetId);}
break;case"CREATE_SHEET":{this.initializeSheet(cmd.sheetId);break;}
case"DUPLICATE_SHEET":{const tallestCells=deepCopy(this.tallestCellInRow[cmd.sheetId]);this.history.update("tallestCellInRow",cmd.sheetIdTo,tallestCells);break;}
case"DELETE_SHEET":const tallestCells={...this.tallestCellInRow};delete tallestCells[cmd.sheetId];this.history.update("tallestCellInRow",tallestCells);break;case"REMOVE_COLUMNS_ROWS":{if(cmd.dimension==="COL"){return;}
const tallestCells=removeIndexesFromArray(this.tallestCellInRow[cmd.sheetId],cmd.elements);this.history.update("tallestCellInRow",cmd.sheetId,tallestCells);break;}
case"ADD_COLUMNS_ROWS":{if(cmd.dimension==="COL"){return;}
const addIndex=getAddHeaderStartIndex(cmd.position,cmd.base);const newCells=Array(cmd.quantity).fill(undefined);const newTallestCells=insertItemsAtIndex(this.tallestCellInRow[cmd.sheetId],newCells,addIndex);this.history.update("tallestCellInRow",cmd.sheetId,newTallestCells);break;}
case"RESIZE_COLUMNS_ROWS":{const sheetId=cmd.sheetId;if(cmd.dimension==="ROW"){for(const row of cmd.elements){const tallestCell=this.getRowTallestCell(sheetId,row);this.history.update("tallestCellInRow",sheetId,row,tallestCell);}}
else{for(const row of range(0,this.getters.getNumberRows(sheetId))){for(const col of cmd.elements){this.updateRowSizeForCellChange(sheetId,row,col);}}}}
break;case"UPDATE_CELL":this.updateRowSizeForCellChange(cmd.sheetId,cmd.row,cmd.col);break;case"ADD_MERGE":case"REMOVE_MERGE":for(const target of cmd.target){for(const position of positions(target)){this.updateRowSizeForCellChange(cmd.sheetId,position.row,position.col);}}}
return;}
getRowSize(sheetId,row){return Math.round(this.getters.getUserRowSize(sheetId,row)??this.tallestCellInRow[sheetId][row]?.size??DEFAULT_CELL_HEIGHT);}
getHeaderSize(sheetId,dimension,index){if(this.getters.isHeaderHidden(sheetId,dimension,index)){return 0;}
return dimension==="ROW"?this.getRowSize(sheetId,index):this.getters.getColSize(sheetId,index);}
updateRowSizeForCellChange(sheetId,row,col){const tallestCellInRow=this.tallestCellInRow[sheetId]?.[row];if(tallestCellInRow?.cell.col===col){const newTallestCell=this.getRowTallestCell(sheetId,row);this.history.update("tallestCellInRow",sheetId,row,newTallestCell);}
const updatedCellHeight=this.getCellHeight({sheetId,col,row});if(updatedCellHeight<=DEFAULT_CELL_HEIGHT){return;}
if((!tallestCellInRow&&updatedCellHeight>DEFAULT_CELL_HEIGHT)||(tallestCellInRow&&updatedCellHeight>tallestCellInRow.size)){const newTallestCell={cell:{sheetId,col,row},size:updatedCellHeight};this.history.update("tallestCellInRow",sheetId,row,newTallestCell);}}
initializeSheet(sheetId){const tallestCells=[];for(let row=0;row<this.getters.getNumberRows(sheetId);row++){const tallestCell=this.getRowTallestCell(sheetId,row);tallestCells.push(tallestCell);}
this.history.update("tallestCellInRow",sheetId,tallestCells);}
getCellHeight(position){if(this.isInMultiRowMerge(position)){return DEFAULT_CELL_HEIGHT;}
const cell=this.getters.getCell(position);const colSize=this.getters.getColSize(position.sheetId,position.col);return getDefaultCellHeight(this.ctx,cell,colSize);}
isInMultiRowMerge(position){const merge=this.getters.getMerge(position);return!!merge&&merge.bottom!==merge.top;}
getRowTallestCell(sheetId,row){const userRowSize=this.getters.getUserRowSize(sheetId,row);if(userRowSize!==undefined){return undefined;}
const cellIds=this.getters.getRowCells(sheetId,row);let maxHeight=0;let tallestCell=undefined;for(let i=0;i<cellIds.length;i++){const cell=this.getters.getCellById(cellIds[i]);if(!cell){continue;}
const position=this.getters.getCellPosition(cell.id);const cellHeight=this.getCellHeight(position);if(cellHeight>maxHeight&&cellHeight>DEFAULT_CELL_HEIGHT){maxHeight=cellHeight;tallestCell={cell:position,size:cellHeight};}}
if(tallestCell&&tallestCell.size>DEFAULT_CELL_HEIGHT){return tallestCell;}
return undefined;}}
class AutofillGenerator{cells;getters;index=0;direction;constructor(cells,getters,direction){this.cells=cells;this.getters=getters;this.direction=direction;}
next(){const genCell=this.cells[this.index++%this.cells.length];const rule=genCell.rule;const{cellData,tooltip}=autofillModifiersRegistry.get(rule.type).apply(rule,genCell.data,this.getters,this.direction);return{cellData,tooltip,origin:{col:genCell.data.col,row:genCell.data.row,},};}}
class AutofillPlugin extends UIPlugin{static layers=[5];static getters=["getAutofillTooltip"];autofillZone;steps;lastCellSelected={};direction;tooltip;allowDispatch(cmd){switch(cmd.type){case"AUTOFILL_SELECT":const sheetId=this.getters.getActiveSheetId();this.lastCellSelected.col=cmd.col===-1?this.lastCellSelected.col:clip(cmd.col,0,this.getters.getNumberCols(sheetId));this.lastCellSelected.row=cmd.row===-1?this.lastCellSelected.row:clip(cmd.row,0,this.getters.getNumberRows(sheetId));if(this.lastCellSelected.col!==undefined&&this.lastCellSelected.row!==undefined){return"Success";}
return"InvalidAutofillSelection";case"AUTOFILL_AUTO":const zone=this.getters.getSelectedZone();return zone.top===zone.bottom?"Success":"CancelledForUnknownReason";}
return"Success";}
handle(cmd){switch(cmd.type){case"AUTOFILL":this.autofill(true);break;case"AUTOFILL_SELECT":this.select(cmd.col,cmd.row);break;case"AUTOFILL_AUTO":this.autofillAuto();break;case"AUTOFILL_CELL":this.autoFillMerge(cmd.originCol,cmd.originRow,cmd.col,cmd.row);const sheetId=this.getters.getActiveSheetId();this.dispatch("UPDATE_CELL",{sheetId,col:cmd.col,row:cmd.row,style:cmd.style||null,content:cmd.content||"",format:cmd.format||"",});this.dispatch("SET_BORDER",{sheetId,col:cmd.col,row:cmd.row,border:cmd.border,});this.autofillCF(cmd.originCol,cmd.originRow,cmd.col,cmd.row);this.autofillDV(cmd.originCol,cmd.originRow,cmd.col,cmd.row);}}
getAutofillTooltip(){return this.tooltip;}
autofill(apply){if(!this.autofillZone||!this.steps||this.direction===undefined){this.tooltip=undefined;return;}
const source=this.getters.getSelectedZone();const target=this.autofillZone;switch(this.direction){case"down":for(let col=source.left;col<=source.right;col++){const xcs=[];for(let row=source.top;row<=source.bottom;row++){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let row=target.top;row<=target.bottom;row++){this.computeNewCell(generator,col,row,apply);}}
break;case"up":for(let col=source.left;col<=source.right;col++){const xcs=[];for(let row=source.bottom;row>=source.top;row--){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let row=target.bottom;row>=target.top;row--){this.computeNewCell(generator,col,row,apply);}}
break;case"left":for(let row=source.top;row<=source.bottom;row++){const xcs=[];for(let col=source.right;col>=source.left;col--){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let col=target.right;col>=target.left;col--){this.computeNewCell(generator,col,row,apply);}}
break;case"right":for(let row=source.top;row<=source.bottom;row++){const xcs=[];for(let col=source.left;col<=source.right;col++){xcs.push(toXC(col,row));}
const generator=this.createGenerator(xcs);for(let col=target.left;col<=target.right;col++){this.computeNewCell(generator,col,row,apply);}}
break;}
if(apply){this.autofillZone=undefined;this.selection.resizeAnchorZone(this.direction,this.steps);this.lastCellSelected={};this.direction=undefined;this.steps=0;this.tooltip=undefined;}}
select(col,row){const source=this.getters.getSelectedZone();if(isInside(col,row,source)){this.autofillZone=undefined;return;}
this.direction=this.getDirection(col,row);switch(this.direction){case"up":this.saveZone(row,source.top-1,source.left,source.right);this.steps=source.top-row;break;case"down":this.saveZone(source.bottom+1,row,source.left,source.right);this.steps=row-source.bottom;break;case"left":this.saveZone(source.top,source.bottom,col,source.left-1);this.steps=source.left-col;break;case"right":this.saveZone(source.top,source.bottom,source.right+1,col);this.steps=col-source.right;break;}
this.autofill(false);}
autofillAuto(){const zone=this.getters.getSelectedZone();const sheetId=this.getters.getActiveSheetId();let col=zone.left;let row=zone.bottom;if(col>0){let leftPosition={sheetId,col:col-1,row};while(this.getters.getCorrespondingFormulaCell(leftPosition)||this.getters.getCell(leftPosition)?.content){row+=1;leftPosition={sheetId,col:col-1,row};}}
if(row===zone.bottom){col=zone.right;if(col<=this.getters.getNumberCols(sheetId)){let rightPosition={sheetId,col:col+1,row};while(this.getters.getCorrespondingFormulaCell(rightPosition)||this.getters.getCell(rightPosition)?.content){row+=1;rightPosition={sheetId,col:col+1,row};}}}
if(row!==zone.bottom){this.select(zone.left,row-1);this.autofill(true);}}
computeNewCell(generator,col,row,apply){const{cellData,tooltip,origin}=generator.next();const{content,style,border,format}=cellData;this.tooltip=tooltip;if(apply){this.dispatch("AUTOFILL_CELL",{originCol:origin.col,originRow:origin.row,col,row,content,style,border,format,});}}
getRule(cell,cells){const rules=autofillRulesRegistry.getAll().sort((a,b)=>a.sequence-b.sequence);const rule=rules.find((rule)=>rule.condition(cell,cells));return rule&&rule.generateRule(cell,cells);}
createGenerator(source){const nextCells=[];const cellsData=[];const sheetId=this.getters.getActiveSheetId();for(let xc of source){const{col,row}=toCartesian(xc);const cell=this.getters.getCell({sheetId,col,row});cellsData.push({col,row,cell,sheetId,});}
const cells=cellsData.map((cellData)=>cellData.cell);for(let cellData of cellsData){let rule={type:"COPY_MODIFIER"};if(cellData&&cellData.cell){const newRule=this.getRule(cellData.cell,cells);rule=newRule||rule;}
const border=this.getters.getCellBorder(cellData)||undefined;nextCells.push({data:{...cellData,border},rule,});}
return new AutofillGenerator(nextCells,this.getters,this.direction);}
saveZone(top,bottom,left,right){this.autofillZone={top,bottom,left,right};}
getDirection(col,row){const source=this.getters.getSelectedZone();const position={up:{number:source.top-row,value:"up"},down:{number:row-source.bottom,value:"down"},left:{number:source.left-col,value:"left"},right:{number:col-source.right,value:"right"},};if(Object.values(position).map((x)=>(x.number>0?1:0)).reduce((acc,value)=>acc+value)===1){return Object.values(position).find((x)=>(x.number>0?1:0)).value;}
const first=position.up.number>0?"up":"down";const second=position.left.number>0?"left":"right";return Math.abs(position[first].number)>=Math.abs(position[second].number)?position[first].value:position[second].value;}
autoFillMerge(originCol,originRow,col,row){const sheetId=this.getters.getActiveSheetId();const position={sheetId,col,row};const originPosition={sheetId,col:originCol,row:originRow};if(this.getters.isInMerge(position)&&!this.getters.isInMerge(originPosition)){const zone=this.getters.getMerge(position);if(zone){this.dispatch("REMOVE_MERGE",{sheetId,target:[zone],});}}
const originMerge=this.getters.getMerge(originPosition);if(originMerge?.topLeft.col===originCol&&originMerge?.topLeft.row===originRow){this.dispatch("ADD_MERGE",{sheetId,target:[{top:row,bottom:row+originMerge.bottom-originMerge.top,left:col,right:col+originMerge.right-originMerge.left,},],});}}
autofillCF(originCol,originRow,col,row){const sheetId=this.getters.getActiveSheetId();const cfOrigin=this.getters.getRulesByCell(sheetId,originCol,originRow);for(const cf of cfOrigin){const newCfRanges=this.getters.getAdaptedCfRanges(sheetId,cf,[toXC(col,row)],[]);if(newCfRanges){this.dispatch("ADD_CONDITIONAL_FORMAT",{cf:deepCopy(cf),ranges:newCfRanges.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}}}
autofillDV(originCol,originRow,col,row){const sheetId=this.getters.getActiveSheetId();const cellPosition={sheetId,col:originCol,row:originRow};const dvOrigin=this.getters.getValidationRuleForCell(cellPosition);if(!dvOrigin){return;}
const dvRangesXcs=dvOrigin.ranges.map((range)=>this.getters.getRangeString(range,sheetId));const newDvRanges=recomputeZones(dvRangesXcs.concat(toXC(col,row)),[]);this.dispatch("ADD_DATA_VALIDATION_RULE",{rule:dvOrigin,ranges:newDvRanges.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}
drawGrid(renderingContext){if(!this.autofillZone){return;}
const{ctx,thinLineWidth}=renderingContext;const{x,y,width,height}=this.getters.getVisibleRect(this.autofillZone);if(width>0&&height>0){ctx.strokeStyle="black";ctx.lineWidth=thinLineWidth;ctx.setLineDash([3]);ctx.strokeRect(x,y,width,height);ctx.setLineDash([]);}}}
class AutomaticSumPlugin extends UIPlugin{static getters=["getAutomaticSums"];handle(cmd){switch(cmd.type){case"SUM_SELECTION":const sheetId=this.getters.getActiveSheetId();const{zones,anchor}=this.getters.getSelection();for(const zone of zones){const sums=this.getAutomaticSums(sheetId,zone,anchor.cell);this.dispatchCellUpdates(sheetId,sums);}
break;}}
getAutomaticSums(sheetId,zone,anchor){return this.shouldFindData(sheetId,zone)?this.sumAdjacentData(sheetId,zone,anchor):this.sumData(sheetId,zone);}
sumData(sheetId,zone){const dimensions=this.dimensionsToSum(sheetId,zone);const sums=this.sumDimensions(sheetId,zone,dimensions).filter(({zone})=>!this.getters.isEmpty(sheetId,zone));if(dimensions.has("ROW")&&dimensions.has("COL")){sums.push(this.sumTotal(zone));}
return sums;}
sumAdjacentData(sheetId,zone,anchor){const{col,row}=isInside(anchor.col,anchor.row,zone)?anchor:{col:zone.left,row:zone.top};const dataZone=this.findAdjacentData(sheetId,col,row);if(!dataZone){return[];}
if(this.getters.isSingleCellOrMerge(sheetId,zone)||isOneDimensional(union(dataZone,zone))){return[{position:{col,row},zone:dataZone}];}
else{return this.sumDimensions(sheetId,union(dataZone,zone),this.transpose(this.dimensionsToSum(sheetId,zone)));}}
findAdjacentData(sheetId,col,row){const sheet=this.getters.getSheet(sheetId);const mainCellPosition=this.getters.getMainCellPosition({sheetId,col,row});const zone=this.findSuitableZoneToSum(sheet,mainCellPosition.col,mainCellPosition.row);if(zone){return this.getters.expandZone(sheetId,zone);}
return undefined;}
findSuitableZoneToSum(sheet,col,row){const topCell=this.getters.getEvaluatedCell({sheetId:sheet.id,col,row:row-1});const leftCell=this.getters.getEvaluatedCell({sheetId:sheet.id,col:col-1,row});if(this.isNumber(leftCell)&&!this.isNumber(topCell)){return this.findHorizontalZone(sheet,col,row);}
const verticalZone=this.findVerticalZone(sheet,col,row);if(this.isZoneValid(verticalZone)){return verticalZone;}
const horizontalZone=this.findHorizontalZone(sheet,col,row);if(this.isZoneValid(horizontalZone)){return horizontalZone;}
return undefined;}
findVerticalZone(sheet,col,row){const zone={top:0,bottom:row-1,left:col,right:col,};const top=this.reduceZoneStart(sheet,zone,zone.bottom);return{...zone,top};}
findHorizontalZone(sheet,col,row){const zone={top:row,bottom:row,left:0,right:col-1,};const left=this.reduceZoneStart(sheet,zone,zone.right);return{...zone,left};}
reduceZoneStart(sheet,zone,end){const cells=this.getters.getEvaluatedCellsInZone(sheet.id,zone);const cellPositions=range(end,-1,-1);const invalidCells=cellPositions.filter((position)=>cells[position]&&!cells[position].isAutoSummable);const maxValidPosition=largeMax(invalidCells);const numberSequences=groupConsecutive(cellPositions.filter((position)=>this.isNumber(cells[position])));const firstSequence=numberSequences[0]||[];if(largeMax(firstSequence)<maxValidPosition){return Infinity;}
return largeMin(firstSequence);}
shouldFindData(sheetId,zone){return this.getters.isEmpty(sheetId,zone)||this.getters.isSingleCellOrMerge(sheetId,zone);}
isNumber(cell){return cell.type===CellValueType.number&&!(cell.format&&isDateTimeFormat(cell.format));}
isZoneValid(zone){return zone.bottom>=zone.top&&zone.right>=zone.left;}
lastColIsEmpty(sheetId,zone){return this.getters.isEmpty(sheetId,{...zone,left:zone.right});}
lastRowIsEmpty(sheetId,zone){return this.getters.isEmpty(sheetId,{...zone,top:zone.bottom});}
dimensionsToSum(sheetId,zone){const dimensions=new Set();if(isOneDimensional(zone)){dimensions.add(zoneToDimension(zone).numberOfCols===1?"COL":"ROW");return dimensions;}
if(this.lastColIsEmpty(sheetId,zone)){dimensions.add("ROW");}
if(this.lastRowIsEmpty(sheetId,zone)){dimensions.add("COL");}
if(dimensions.size===0){dimensions.add("COL");}
return dimensions;}
sumDimensions(sheetId,zone,dimensions){return[...(dimensions.has("COL")?this.sumColumns(zone,sheetId):[]),...(dimensions.has("ROW")?this.sumRows(zone,sheetId):[]),];}
sumTotal(zone){const{bottom,right}=zone;return{position:{col:right,row:bottom},zone:{...zone,top:bottom,right:right-1},};}
sumColumns(zone,sheetId){const target=this.nextEmptyRow(sheetId,{...zone,bottom:zone.bottom-1});zone={...zone,bottom:Math.min(zone.bottom,target.bottom-1)};return positions(target).map((position)=>({position,zone:{...zone,right:position.col,left:position.col},}));}
sumRows(zone,sheetId){const target=this.nextEmptyCol(sheetId,{...zone,right:zone.right-1});zone={...zone,right:Math.min(zone.right,target.right-1)};return positions(target).map((position)=>({position,zone:{...zone,top:position.row,bottom:position.row},}));}
dispatchCellUpdates(sheetId,sums){for(const sum of sums){const{col,row}=sum.position;this.dispatch("UPDATE_CELL",{sheetId,col,row,content:`=SUM(${this.getters.zoneToXC(sheetId, sum.zone)})`,});}}
nextEmptyRow(sheetId,zone){let start=zone.bottom+1;const{left,right}=zone;while(!this.getters.isEmpty(sheetId,{bottom:start,top:start,left,right})){start++;}
return{...zone,top:start,bottom:start,};}
nextEmptyCol(sheetId,zone){let start=zone.right+1;const{top,bottom}=zone;while(!this.getters.isEmpty(sheetId,{left:start,right:start,top,bottom})){start++;}
return{...zone,left:start,right:start,};}
transpose(dimensions){return new Set([...dimensions.values()].map((dimension)=>(dimension==="COL"?"ROW":"COL")));}}
class CellPopoverPlugin extends UIPlugin{static getters=["getCellPopover","getPersistentPopoverTypeAtPosition","hasOpenedPopover",];persistentPopover;allowDispatch(cmd){switch(cmd.type){case"OPEN_CELL_POPOVER":try{cellPopoverRegistry.get(cmd.popoverType);}
catch(error){return"InvalidCellPopover";}
return"Success";default:return"Success";}}
handle(cmd){switch(cmd.type){case"ACTIVATE_SHEET":this.persistentPopover=undefined;break;case"OPEN_CELL_POPOVER":this.persistentPopover={col:cmd.col,row:cmd.row,sheetId:this.getters.getActiveSheetId(),type:cmd.popoverType,};break;case"CLOSE_CELL_POPOVER":this.persistentPopover=undefined;break;}}
getCellPopover({col,row}){const sheetId=this.getters.getActiveSheetId();if(this.persistentPopover&&this.getters.isVisibleInViewport(this.persistentPopover)){const position=this.getters.getMainCellPosition(this.persistentPopover);const popover=cellPopoverRegistry.get(this.persistentPopover.type).onOpen?.(position,this.getters);return!popover?.isOpen?{isOpen:false}:{...popover,anchorRect:this.computePopoverAnchorRect(this.persistentPopover),};}
if(col===undefined||row===undefined||!this.getters.isVisibleInViewport({sheetId,col,row})){return{isOpen:false};}
const position=this.getters.getMainCellPosition({sheetId,col,row});const popover=cellPopoverRegistry.getAll().map((matcher)=>matcher.onHover?.(position,this.getters)).find((popover)=>popover?.isOpen);return!popover?.isOpen?{isOpen:false}:{...popover,anchorRect:this.computePopoverAnchorRect(position),};}
hasOpenedPopover(){return this.persistentPopover!==undefined;}
getPersistentPopoverTypeAtPosition({col,row}){if(this.persistentPopover&&this.persistentPopover.col===col&&this.persistentPopover.row===row){return this.persistentPopover.type;}
return undefined;}
computePopoverAnchorRect({col,row}){const sheetId=this.getters.getActiveSheetId();const merge=this.getters.getMerge({sheetId,col,row});if(merge){return this.getters.getVisibleRect(merge);}
return this.getters.getVisibleRect(positionToZone({col,row}));}}
class EventBus{subscriptions={};on(type,owner,callback){if(!callback){throw new Error("Missing callback");}
if(!this.subscriptions[type]){this.subscriptions[type]=[];}
this.subscriptions[type].push({owner,callback,});}
trigger(type,payload){const subs=this.subscriptions[type]||[];for(let i=0,iLen=subs.length;i<iLen;i++){const sub=subs[i];sub.callback.call(sub.owner,payload);}}
off(eventType,owner){const subs=this.subscriptions[eventType];if(subs){this.subscriptions[eventType]=subs.filter((s)=>s.owner!==owner);}}
clear(){this.subscriptions={};}}
otRegistry.addTransformation("ADD_COLUMNS_ROWS",["ADD_COLUMNS_ROWS"],addHeadersTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["ADD_COLUMNS_ROWS"],addHeadersTransformation);otRegistry.addTransformation("ADD_COLUMNS_ROWS",["CREATE_CHART","UPDATE_CHART"],updateChartRangesTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["CREATE_CHART","UPDATE_CHART"],updateChartRangesTransformation);otRegistry.addTransformation("DELETE_SHEET",["MOVE_RANGES"],transformTargetSheetId);otRegistry.addTransformation("DELETE_FIGURE",["UPDATE_FIGURE","UPDATE_CHART"],updateChartFigure);otRegistry.addTransformation("CREATE_SHEET",["CREATE_SHEET"],createSheetTransformation);otRegistry.addTransformation("ADD_MERGE",["ADD_MERGE","REMOVE_MERGE","CREATE_FILTER_TABLE"],mergeTransformation);otRegistry.addTransformation("ADD_COLUMNS_ROWS",["FREEZE_COLUMNS","FREEZE_ROWS"],freezeTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["FREEZE_COLUMNS","FREEZE_ROWS"],freezeTransformation);otRegistry.addTransformation("CREATE_FILTER_TABLE",["CREATE_FILTER_TABLE","ADD_MERGE"],createTableTransformation);otRegistry.addTransformation("ADD_COLUMNS_ROWS",["GROUP_HEADERS","UNGROUP_HEADERS","FOLD_HEADER_GROUP","UNFOLD_HEADER_GROUP"],groupHeadersTransformation);otRegistry.addTransformation("REMOVE_COLUMNS_ROWS",["GROUP_HEADERS","UNGROUP_HEADERS","FOLD_HEADER_GROUP","UNFOLD_HEADER_GROUP"],groupHeadersTransformation);function transformTargetSheetId(toTransform,executed){const deletedSheetId=executed.sheetId;if(toTransform.targetSheetId===deletedSheetId||toTransform.sheetId===deletedSheetId){return undefined;}
return toTransform;}
function updateChartFigure(toTransform,executed){if(toTransform.id===executed.id){return undefined;}
return toTransform;}
function updateChartRangesTransformation(toTransform,executed){return{...toTransform,definition:transformDefinition(toTransform.definition,executed),};}
function createSheetTransformation(toTransform,executed){if(toTransform.name===executed.name){return{...toTransform,name:toTransform.name?.match(/\d+/)?toTransform.name.replace(/\d+/,(n)=>(parseInt(n)+1).toString()):`${toTransform.name}~`,position:toTransform.position+1,};}
return toTransform;}
function mergeTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId){return toTransform;}
const target=[];for(const zone1 of toTransform.target){for(const zone2 of executed.target){if(!overlap(zone1,zone2)){target.push({...zone1});}}}
if(target.length){return{...toTransform,target};}
return undefined;}
function freezeTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId){return toTransform;}
const dimension=toTransform.type==="FREEZE_COLUMNS"?"COL":"ROW";if(dimension!==executed.dimension){return toTransform;}
let quantity=toTransform["quantity"];if(executed.type==="REMOVE_COLUMNS_ROWS"){const executedElements=[...executed.elements].sort((a,b)=>b-a);for(let removedElement of executedElements){if(quantity>removedElement){quantity--;}}}
if(executed.type==="ADD_COLUMNS_ROWS"){const executedBase=executed.position==="before"?executed.base-1:executed.base;quantity=quantity>executedBase?quantity+executed.quantity:quantity;}
return quantity>0?{...toTransform,quantity}:undefined;}
function createTableTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId){return toTransform;}
for(const cmdTarget of toTransform.target){for(const executedCmdTarget of executed.target){if(overlap(executedCmdTarget,cmdTarget)){return undefined;}}}
return toTransform;}
function addHeadersTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId||toTransform.dimension!==executed.dimension){return toTransform;}
let result=undefined;if(executed.type==="REMOVE_COLUMNS_ROWS"){result=moveHeaderIndexesOnHeaderDeletion(executed.elements,[toTransform.base])[0];}
else if(executed.type==="ADD_COLUMNS_ROWS"){const base=getAddHeaderStartIndex(executed.position,executed.base);result=moveHeaderIndexesOnHeaderAddition(base,executed.quantity,[toTransform.base])[0];}
if(result===undefined){return undefined;}
return{...toTransform,base:result};}
function groupHeadersTransformation(toTransform,executed){if(toTransform.sheetId!==executed.sheetId||toTransform.dimension!==executed.dimension){return toTransform;}
const elementsToTransform=range(toTransform.start,toTransform.end+1);let results=[];if(executed.type==="REMOVE_COLUMNS_ROWS"){results=moveHeaderIndexesOnHeaderDeletion(executed.elements,elementsToTransform);}
else if(executed.type==="ADD_COLUMNS_ROWS"){const base=getAddHeaderStartIndex(executed.position,executed.base);results=moveHeaderIndexesOnHeaderAddition(base,executed.quantity,elementsToTransform);}
if(results.length===0){return undefined;}
return{...toTransform,start:Math.min(...results),end:Math.max(...results)};}
const transformations=[{match:isSheetDependent,fn:transformSheetId},{match:isTargetDependent,fn:transformTarget},{match:isZoneDependent,fn:transformZoneDependentCommand},{match:isPositionDependent,fn:transformPosition},{match:isHeadersDependant,fn:transformHeaders},{match:isRangeDependant,fn:transformRangesDependentCommand},];function transform(toTransform,executed){const specificTransform=otRegistry.getTransformation(toTransform.type,executed.type);return specificTransform?specificTransform(toTransform,executed):genericTransform(toTransform,executed);}
function transformAll(toTransform,executed){let transformedCommands=[...toTransform];for(const executedCommand of executed){transformedCommands=transformedCommands.map((cmd)=>transform(cmd,executedCommand)).filter(isDefined$1);}
return transformedCommands;}
function genericTransform(cmd,executed){for(const{match,fn}of transformations){if(match(cmd)){const result=fn(cmd,executed);if(result==="SKIP_TRANSFORMATION"){continue;}
if(result==="IGNORE_COMMAND"){return undefined;}
cmd=result;}}
return cmd;}
function transformSheetId(toTransform,executed){if(!("sheetId"in executed)){return toTransform;}
const deleteSheet=executed.type==="DELETE_SHEET"&&executed.sheetId;if(toTransform.sheetId===deleteSheet){return"IGNORE_COMMAND";}
else if(toTransform.type==="CREATE_SHEET"||executed.type==="CREATE_SHEET"||toTransform.sheetId!==executed.sheetId){return toTransform;}
return"SKIP_TRANSFORMATION";}
function transformTarget(cmd,executed){const transformSheetResult=transformSheetId(cmd,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":cmd;}
const target=[];for(const zone of cmd.target){const newZone=transformZone(zone,executed);if(newZone){target.push(newZone);}}
if(!target.length){return"IGNORE_COMMAND";}
return{...cmd,target};}
function transformZoneDependentCommand(cmd,executed){const transformSheetResult=transformSheetId(cmd,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":cmd;}
const newZone=transformZone(cmd.zone,executed);if(newZone){return{...cmd,zone:newZone};}
return"IGNORE_COMMAND";}
function transformRangesDependentCommand(toTransform,executed){if(!("sheetId"in executed)){return toTransform;}
const ranges=toTransform.ranges.map((range)=>transformRangeData(range,executed)).filter(isDefined$1);if(!ranges.length){return"IGNORE_COMMAND";}
return{...toTransform,ranges};}
function transformHeaders(toTransform,executed){const transformSheetResult=transformSheetId(toTransform,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":toTransform;}
if(executed.type!=="ADD_COLUMNS_ROWS"&&executed.type!=="REMOVE_COLUMNS_ROWS"){return"SKIP_TRANSFORMATION";}
if(executed.dimension!==toTransform.dimension){return toTransform;}
let result=[];if(executed.type==="REMOVE_COLUMNS_ROWS"){result=moveHeaderIndexesOnHeaderDeletion(executed.elements,toTransform.elements);}
else if(executed.type==="ADD_COLUMNS_ROWS"){const base=getAddHeaderStartIndex(executed.position,executed.base);result=moveHeaderIndexesOnHeaderAddition(base,executed.quantity,toTransform.elements);}
if(result.length===0){return"IGNORE_COMMAND";}
return{...toTransform,elements:result};}
function transformPosition(toTransform,executed){const transformSheetResult=transformSheetId(toTransform,executed);if(transformSheetResult!=="SKIP_TRANSFORMATION"){return transformSheetResult==="IGNORE_COMMAND"?"IGNORE_COMMAND":toTransform;}
if(executed.type==="ADD_COLUMNS_ROWS"||executed.type==="REMOVE_COLUMNS_ROWS"){return transformPositionWithGrid(toTransform,executed);}
if(executed.type==="ADD_MERGE"){return transformPositionWithMerge(toTransform,executed);}
return"SKIP_TRANSFORMATION";}
function transformPositionWithGrid(toTransform,executed){const field=executed.dimension==="COL"?"col":"row";let base=toTransform[field];if(executed.type==="REMOVE_COLUMNS_ROWS"){const elements=[...executed.elements].sort((a,b)=>b-a);if(elements.includes(base)){return"IGNORE_COMMAND";}
for(let removedElement of elements){if(base>=removedElement){base--;}}}
if(executed.type==="ADD_COLUMNS_ROWS"){if(base>executed.base||(base===executed.base&&executed.position==="before")){base=base+executed.quantity;}}
return{...toTransform,[field]:base};}
function transformPositionWithMerge(toTransform,executed){for(const zone of executed.target){const sameTopLeft=toTransform.col===zone.left&&toTransform.row===zone.top;if(!sameTopLeft&&isInside(toTransform.col,toTransform.row,zone)){return"IGNORE_COMMAND";}}
return toTransform;}
class Revision{rootCommand;timestamp;id;clientId;_commands=[];_changes=[];constructor(id,clientId,commands,rootCommand,changes,timestamp){this.rootCommand=rootCommand;this.timestamp=timestamp;this.id=id;this.clientId=clientId;this._commands=[...commands];this._changes=changes?[...changes]:[];}
setChanges(changes){this._changes=changes;}
get commands(){return this._commands;}
get changes(){return this._changes;}}
class ClientDisconnectedError extends Error{}
class Session extends EventBus{revisions;transportService;serverRevisionId;clients={};clientId="local";debouncedMove;pendingMessages=[];waitingAck=false;waitingUndoRedoAck=false;isReplayingInitialRevisions=false;processedRevisions=new Set();uuidGenerator=new UuidGenerator();lastLocalOperation;constructor(revisions,transportService,serverRevisionId=DEFAULT_REVISION_ID){super();this.revisions=revisions;this.transportService=transportService;this.serverRevisionId=serverRevisionId;this.debouncedMove=debounce(this._move.bind(this),DEBOUNCE_TIME);}
canApplyOptimisticUpdate(){return!this.waitingUndoRedoAck;}
save(rootCommand,commands,changes){if(!commands.length||!changes.length||!this.canApplyOptimisticUpdate())
return;const revision=new Revision(this.uuidGenerator.uuidv4(),this.clientId,commands,rootCommand,changes,Date.now());this.revisions.append(revision.id,revision);if(rootCommand.type!=="REQUEST_REDO"){this.lastLocalOperation=revision;}
this.trigger("new-local-state-update",{id:revision.id});this.sendUpdateMessage({type:"REMOTE_REVISION",version:MESSAGE_VERSION,serverRevisionId:this.serverRevisionId,nextRevisionId:revision.id,clientId:revision.clientId,commands:revision.commands,});}
undo(revisionId){this.waitingUndoRedoAck=true;this.sendUpdateMessage({type:"REVISION_UNDONE",version:MESSAGE_VERSION,serverRevisionId:this.serverRevisionId,nextRevisionId:this.uuidGenerator.uuidv4(),undoneRevisionId:revisionId,});}
redo(revisionId){this.waitingUndoRedoAck=true;this.sendUpdateMessage({type:"REVISION_REDONE",version:MESSAGE_VERSION,serverRevisionId:this.serverRevisionId,nextRevisionId:this.uuidGenerator.uuidv4(),redoneRevisionId:revisionId,});}
move(position){this.debouncedMove(position);}
join(client){if(client){this.clients[client.id]=client;this.clientId=client.id;}
else{this.clients["local"]={id:"local",name:"local"};this.clientId="local";}
this.transportService.onNewMessage(this.clientId,this.onMessageReceived.bind(this));}
loadInitialMessages(messages){this.isReplayingInitialRevisions=true;for(const message of messages){this.onMessageReceived(message);}
this.isReplayingInitialRevisions=false;}
leave(data){if(Object.keys(this.clients).length===1&&this.processedRevisions.size){this.snapshot(data);}
delete this.clients[this.clientId];this.transportService.leave(this.clientId);this.transportService.sendMessage({type:"CLIENT_LEFT",clientId:this.clientId,version:MESSAGE_VERSION,});}
snapshot(data){if(this.pendingMessages.length!==0){return;}
const snapshotId=this.uuidGenerator.uuidv4();this.transportService.sendMessage({type:"SNAPSHOT",nextRevisionId:snapshotId,serverRevisionId:this.serverRevisionId,data:{...data,revisionId:snapshotId},version:MESSAGE_VERSION,});}
getClient(){const client=this.clients[this.clientId];if(!client){throw new ClientDisconnectedError("The client left the session");}
return client;}
getConnectedClients(){return new Set(Object.values(this.clients).filter(isDefined$1));}
getRevisionId(){return this.serverRevisionId;}
isFullySynchronized(){return this.pendingMessages.length===0;}
getLastLocalNonEmptyRevision(){return this.lastLocalOperation;}
_move(position){if(!this.clients[this.clientId])
return;const currentPosition=this.clients[this.clientId]?.position;if(currentPosition?.col===position.col&&currentPosition.row===position.row&&currentPosition.sheetId===position.sheetId){return;}
const type=currentPosition?"CLIENT_MOVED":"CLIENT_JOINED";const client=this.getClient();this.clients[this.clientId]={...client,position};this.transportService.sendMessage({type,version:MESSAGE_VERSION,client:{...client,position},});}
onMessageReceived(message){if(this.isAlreadyProcessed(message))
return;if(this.isWrongServerRevisionId(message)){this.trigger("unexpected-revision-id");return;}
switch(message.type){case"CLIENT_MOVED":this.onClientMoved(message);break;case"CLIENT_JOINED":this.onClientJoined(message);break;case"CLIENT_LEFT":this.onClientLeft(message);break;case"REVISION_REDONE":{this.revisions.redo(message.redoneRevisionId,message.nextRevisionId,message.serverRevisionId);this.trigger("revision-redone",{revisionId:message.redoneRevisionId,commands:this.revisions.get(message.redoneRevisionId).commands,});break;}
case"REVISION_UNDONE":this.revisions.undo(message.undoneRevisionId,message.nextRevisionId,message.serverRevisionId);this.trigger("revision-undone",{revisionId:message.undoneRevisionId,commands:this.revisions.get(message.undoneRevisionId).commands,});break;case"REMOTE_REVISION":const{clientId,commands,timestamp}=message;const revision=new Revision(message.nextRevisionId,clientId,commands,undefined,undefined,timestamp);if(revision.clientId!==this.clientId){this.revisions.insert(revision.id,revision,message.serverRevisionId);const pendingCommands=this.pendingMessages.filter((msg)=>msg.type==="REMOTE_REVISION").map((msg)=>msg.commands).flat();this.trigger("remote-revision-received",{commands:transformAll(commands,pendingCommands),});}
break;case"SNAPSHOT_CREATED":{const revision=new Revision(message.nextRevisionId,"server",[],undefined,undefined,Date.now());this.revisions.insert(revision.id,revision,message.serverRevisionId);this.dropPendingHistoryMessages();this.trigger("snapshot");this.lastLocalOperation=undefined;break;}}
this.acknowledge(message);this.trigger("collaborative-event-received");}
onClientMoved(message){if(message.client.id!==this.clientId){this.clients[message.client.id]=message.client;}}
onClientJoined(message){if(message.client.id!==this.clientId){this.clients[message.client.id]=message.client;const client=this.clients[this.clientId];if(client){const{position}=client;if(position){this.transportService.sendMessage({type:"CLIENT_MOVED",version:MESSAGE_VERSION,client:{...client,position},});}}}}
onClientLeft(message){if(message.clientId!==this.clientId){delete this.clients[message.clientId];}}
sendUpdateMessage(message){this.pendingMessages.push(message);if(this.waitingAck){return;}
this.waitingAck=true;this.sendPendingMessage();}
sendPendingMessage(){let message=this.pendingMessages[0];if(!message)
return;if(message.type==="REMOTE_REVISION"){const revision=this.revisions.get(message.nextRevisionId);if(revision.commands.length===0){this.revisions.drop(revision.id);const revisionIds=this.pendingMessages.filter((message)=>message.type==="REMOTE_REVISION").map((message)=>message.nextRevisionId);this.trigger("pending-revisions-dropped",{revisionIds});this.waitingAck=false;this.waitingUndoRedoAck=false;this.pendingMessages=[];return;}
message={...message,clientId:revision.clientId,commands:revision.commands,};}
if(this.isReplayingInitialRevisions){throw new Error(`Trying to send a new revision while replaying initial revision. This can lead to endless dispatches every time the spreadsheet is open.
      ${JSON.stringify(message)}`);}
this.transportService.sendMessage({...message,serverRevisionId:this.serverRevisionId,});}
acknowledge(message){if(message.type==="REVISION_UNDONE"||message.type==="REVISION_REDONE"){this.waitingUndoRedoAck=false;}
switch(message.type){case"REMOTE_REVISION":case"REVISION_REDONE":case"REVISION_UNDONE":case"SNAPSHOT_CREATED":this.waitingAck=false;this.pendingMessages=this.pendingMessages.filter((msg)=>msg.nextRevisionId!==message.nextRevisionId);this.serverRevisionId=message.nextRevisionId;this.processedRevisions.add(message.nextRevisionId);this.sendPendingMessage();break;}}
isAlreadyProcessed(message){if(message.type==="CLIENT_MOVED"&&message.client.id===this.clientId){return true;}
switch(message.type){case"REMOTE_REVISION":case"REVISION_REDONE":case"REVISION_UNDONE":return this.processedRevisions.has(message.nextRevisionId);default:return false;}}
isWrongServerRevisionId(message){switch(message.type){case"REMOTE_REVISION":case"REVISION_REDONE":case"REVISION_UNDONE":case"SNAPSHOT_CREATED":return message.serverRevisionId!==this.serverRevisionId;default:return false;}}
dropPendingHistoryMessages(){this.waitingUndoRedoAck=false;this.pendingMessages=this.pendingMessages.filter(({type})=>type!=="REVISION_REDONE"&&type!=="REVISION_UNDONE");}}
function randomChoice(arr){return arr[Math.floor(Math.random()*arr.length)];}
const colors=["#ff851b","#0074d9","#7fdbff","#b10dc9","#39cccc","#f012be","#3d9970","#111111","#ff4136","#aaaaaa","#85144b","#001f3f",];class CollaborativePlugin extends UIPlugin{static getters=["getClientsToDisplay","getClient","getConnectedClients","isFullySynchronized",];static layers=[6];availableColors=new Set(colors);colors={};session;constructor(config){super(config);this.session=config.session;}
isPositionValid(position){return(position.row<this.getters.getNumberRows(position.sheetId)&&position.col<this.getters.getNumberCols(position.sheetId));}
chooseNewColor(){if(this.availableColors.size===0){this.availableColors=new Set(colors);}
const color=randomChoice([...this.availableColors.values()]);this.availableColors.delete(color);return color;}
getClient(){return this.session.getClient();}
getConnectedClients(){return this.session.getConnectedClients();}
isFullySynchronized(){return this.session.isFullySynchronized();}
getClientsToDisplay(){try{this.getters.getClient();}
catch(e){if(e instanceof ClientDisconnectedError){return[];}
else{throw e;}}
const sheetId=this.getters.getActiveSheetId();const clients=[];for(const client of this.getters.getConnectedClients()){if(client.id!==this.getters.getClient().id&&client.position&&client.position.sheetId===sheetId&&this.isPositionValid(client.position)){const position=client.position;if(!this.colors[client.id]){this.colors[client.id]=this.chooseNewColor();}
const color=this.colors[client.id];clients.push({...client,position,color});}}
return clients;}
drawGrid(renderingContext){if(this.getters.isDashboard()){return;}
const{ctx,thinLineWidth}=renderingContext;const activeSheetId=this.getters.getActiveSheetId();for(const client of this.getClientsToDisplay()){const{row,col}=client.position;const zone=this.getters.expandZone(activeSheetId,{top:row,bottom:row,left:col,right:col,});const{x,y,width,height}=this.getters.getVisibleRect(zone);if(width<=0||height<=0){continue;}
const color=client.color;const cellBackgroundColor=`${color}10`;ctx.fillStyle=cellBackgroundColor;ctx.lineWidth=4*thinLineWidth;ctx.strokeStyle=color;ctx.globalCompositeOperation="multiply";ctx.fillRect(x,y,width,height);ctx.globalCompositeOperation="source-over";ctx.strokeRect(x,y,width,height);ctx.font=`bold ${DEFAULT_FONT_SIZE + 1}px ${DEFAULT_FONT}`;}}}
class ClipboardCellsAbstractState{getters;dispatch;selection;operation;sheetId;constructor(operation,getters,dispatch,selection){this.getters=getters;this.dispatch=dispatch;this.selection=selection;this.operation=operation;this.sheetId=getters.getActiveSheetId();}
isCutAllowed(target){return"Success";}
isPasteAllowed(target,clipboardOption){return"Success";}
addMissingDimensions(width,height,col,row){const sheetId=this.getters.getActiveSheetId();const missingRows=height+row-this.getters.getNumberRows(sheetId);if(missingRows>0){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"ROW",base:this.getters.getNumberRows(sheetId)-1,sheetId,quantity:missingRows,position:"after",});}
const missingCols=width+col-this.getters.getNumberCols(sheetId);if(missingCols>0){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:this.getters.getNumberCols(sheetId)-1,sheetId,quantity:missingCols,position:"after",});}}
isColRowDirtyingClipboard(position,dimension){return false;}
drawClipboard(renderingContext){}}
class ClipboardCellsState extends ClipboardCellsAbstractState{cells;copiedTables;zones;uuidGenerator=new UuidGenerator();constructor(zones,operation,getters,dispatch,selection){super(operation,getters,dispatch,selection);if(!zones.length){this.cells=[[]];this.zones=[];this.copiedTables=[];return;}
const lefts=new Set(zones.map((z)=>z.left));const rights=new Set(zones.map((z)=>z.right));const tops=new Set(zones.map((z)=>z.top));const bottoms=new Set(zones.map((z)=>z.bottom));const areZonesCompatible=(tops.size===1&&bottoms.size===1)||(lefts.size===1&&rights.size===1);const clippedZones=areZonesCompatible?mergeOverlappingZones(zones):[zones[zones.length-1]];const cellsPosition=clippedZones.map((zone)=>positions(zone)).flat();const columnsIndex=[...new Set(cellsPosition.map((p)=>p.col))].sort((a,b)=>a-b);const rowsIndex=[...new Set(cellsPosition.map((p)=>p.row))].sort((a,b)=>a-b);const cellsInClipboard=[];const sheetId=getters.getActiveSheetId();for(let row of rowsIndex){let cellsInRow=[];for(let col of columnsIndex){const position={col,row,sheetId};const spreader=getters.getArrayFormulaSpreadingOn(position);let cell=getters.getCell(position);const evaluatedCell=getters.getEvaluatedCell(position);if(spreader){const isSpreaderCopied=rowsIndex.includes(spreader.row)&&columnsIndex.includes(spreader.col);const content=isSpreaderCopied?"":formatValue(evaluatedCell.value,{locale:getters.getLocale()});cell={id:cell?.id||"",style:cell?.style,format:evaluatedCell.format,content,isFormula:false,};}
cellsInRow.push({cell,border:getters.getCellBorder(position)||undefined,evaluatedCell,position,});}
cellsInClipboard.push(cellsInRow);}
const tables=[];for(const zone of zones){for(const table of this.getters.getFilterTablesInZone(sheetId,zone)){const values=[];for(const col of range(table.zone.left,table.zone.right+1)){values.push(this.getters.getFilterValues({sheetId,col,row:table.zone.top}));}
tables.push({filtersValues:values,zone:table.zone});}}
this.cells=cellsInClipboard;this.zones=clippedZones;this.copiedTables=tables;}
isCutAllowed(target){if(target.length!==1){return"WrongCutSelection";}
return"Success";}
isPasteAllowed(target,clipboardOption){const sheetId=this.getters.getActiveSheetId();if(this.operation==="CUT"&&clipboardOption?.pasteOption!==undefined){return"WrongPasteOption";}
if(target.length>1){if(this.cells.length>1||this.cells[0].length>1){return"WrongPasteSelection";}}
const clipboardHeight=this.cells.length;const clipboardWidth=this.cells[0].length;for(let zone of this.getPasteZones(target)){if(this.getters.doesIntersectMerge(sheetId,zone)){if(target.length>1||!this.getters.isSingleCellOrMerge(sheetId,target[0])||clipboardHeight*clipboardWidth!==1){return"WillRemoveExistingMerge";}}}
const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);for(const zone of this.getPasteZones(target)){if((zone.left<xSplit&&zone.right>=xSplit)||(zone.top<ySplit&&zone.bottom>=ySplit)){return"FrozenPaneOverlap";}}
return"Success";}
paste(target,options){if(this.operation==="COPY"){this.pasteFromCopy(target,options);}
else{this.pasteFromCut(target,options);}
const height=this.cells.length;const width=this.cells[0].length;const isCutOperation=this.operation==="CUT";if(options?.selectTarget){this.selectPastedZone(width,height,isCutOperation,target);}}
pasteFromCopy(target,options){if(target.length===1){const height=this.cells.length;const width=this.cells[0].length;const pasteZones=this.pastedZones(target,width,height);for(const zone of pasteZones){this.pasteZone(zone.left,zone.top,options);}}
else{for(const zone of target){for(let col=zone.left;col<=zone.right;col++){for(let row=zone.top;row<=zone.bottom;row++){this.pasteZone(col,row,options);}}}}
if(options?.pasteOption===undefined){this.pasteCopiedTables(target);}}
pasteFromCut(target,options){this.clearClippedZones();const selection=target[0];this.pasteZone(selection.left,selection.top,options);this.dispatch("MOVE_RANGES",{target:this.zones,sheetId:this.sheetId,targetSheetId:this.getters.getActiveSheetId(),col:selection.left,row:selection.top,});for(const filterTable of this.copiedTables){this.dispatch("REMOVE_FILTER_TABLE",{sheetId:this.sheetId,target:[filterTable.zone],});}
this.pasteCopiedTables(target);}
pastedZones(target,originWidth,originHeight){const selection=target[0];const repeatHorizontally=Math.max(1,Math.floor((selection.right+1-selection.left)/originWidth));const repeatVertically=Math.max(1,Math.floor((selection.bottom+1-selection.top)/originHeight));const zones=[];for(let x=0;x<repeatHorizontally;x++){for(let y=0;y<repeatVertically;y++){const top=selection.top+y*originHeight;const left=selection.left+x*originWidth;zones.push({left,top,bottom:top+originHeight-1,right:left+originWidth-1,});}}
return zones;}
getPasteZones(target){const cells=this.cells;if(!cells.length||!cells[0].length){return target;}
const pasteZones=[];const height=cells.length;const width=cells[0].length;const selection=target[target.length-1];const col=selection.left;const row=selection.top;const repetitionCol=Math.max(1,Math.floor((selection.right+1-col)/width));const repetitionRow=Math.max(1,Math.floor((selection.bottom+1-row)/height));for(let x=1;x<=repetitionCol;x++){for(let y=1;y<=repetitionRow;y++){pasteZones.push({left:col,top:row,right:col-1+x*width,bottom:row-1+y*height,});}}
return pasteZones;}
selectPastedZone(width,height,isCutOperation,target){const selection=target[0];const col=selection.left;const row=selection.top;if(height>1||width>1||isCutOperation){const zones=this.pastedZones(target,width,height);const newZone=isCutOperation?zones[0]:union(...zones);this.selection.selectZone({cell:{col,row},zone:newZone},{scrollIntoView:false});}}
clearClippedZones(){for(const row of this.cells){for(const cell of row){if(cell?.cell){this.dispatch("CLEAR_CELL",cell.position);}}}
this.dispatch("CLEAR_FORMATTING",{sheetId:this.sheetId,target:this.zones,});}
pasteZone(col,row,clipboardOptions){const height=this.cells.length;const width=this.cells[0].length;const shouldPasteCF=clipboardOptions?.pasteOption!=="onlyValue"&&clipboardOptions?.shouldPasteCF;const shouldPasteDV=!clipboardOptions?.pasteOption;const sheetId=this.getters.getActiveSheetId();this.addMissingDimensions(width,height,col,row);for(let r=0;r<height;r++){const rowCells=this.cells[r];for(let c=0;c<width;c++){const origin=rowCells[c];if(!origin){continue;}
const position={col:col+c,row:row+r,sheetId:sheetId};if(this.operation!=="CUT"){this.pasteMergeIfExist(origin.position,position);}
this.pasteCell(origin,position,this.operation,clipboardOptions);if(shouldPasteCF){this.pasteCf(origin.position,position);}
if(shouldPasteDV){this.pasteDataValidation(origin.position,position);}}}}
pasteCell(origin,target,operation,clipboardOption){const{sheetId,col,row}=target;const targetCell=this.getters.getEvaluatedCell(target);if(clipboardOption?.pasteOption==="onlyValue"){const locale=this.getters.getLocale();const content=formatValue(origin.evaluatedCell.value,{locale});this.dispatch("UPDATE_CELL",{...target,content});return;}
const targetBorders=this.getters.getCellBorder(target);const originBorders=origin.border;const border={top:targetBorders?.top||originBorders?.top,bottom:targetBorders?.bottom||originBorders?.bottom,left:targetBorders?.left||originBorders?.left,right:targetBorders?.right||originBorders?.right,};this.dispatch("SET_BORDER",{sheetId,col,row,border});if(clipboardOption?.pasteOption==="onlyFormat"){this.dispatch("UPDATE_CELL",{...target,style:origin.cell?.style??null,format:origin.cell?.format??origin.evaluatedCell.format??targetCell.format,});return;}
const content=origin.cell&&origin.cell.isFormula&&operation==="COPY"?this.getters.getTranslatedCellFormula(sheetId,col-origin.position.col,row-origin.position.row,origin.cell.compiledFormula):origin.cell?.content;if(content!==""||origin.cell?.format||origin.cell?.style){this.dispatch("UPDATE_CELL",{...target,content,style:origin.cell?.style||null,format:origin.cell?.format,});}
else if(targetCell){this.dispatch("CLEAR_CELL",target);}}
pasteMergeIfExist(origin,target){let{sheetId,col,row}=origin;const{col:mainCellColOrigin,row:mainCellRowOrigin}=this.getters.getMainCellPosition(origin);if(mainCellColOrigin===col&&mainCellRowOrigin===row){const merge=this.getters.getMerge(origin);if(!merge){return;}
({sheetId,col,row}=target);this.dispatch("ADD_MERGE",{sheetId,force:true,target:[{left:col,top:row,right:col+merge.right-merge.left,bottom:row+merge.bottom-merge.top,},],});}}
pasteCopiedTables(target){const sheetId=this.getters.getActiveSheetId();const selection=target[0];const cutZone=this.zones[0];const cutOffset=[selection.left-cutZone.left,selection.top-cutZone.top,];for(const table of this.copiedTables){const newTableZone=createAdaptedZone(table.zone,"both","MOVE",cutOffset);this.dispatch("CREATE_FILTER_TABLE",{sheetId,target:[newTableZone]});for(const i of range(0,table.filtersValues.length)){this.dispatch("UPDATE_FILTER",{sheetId,col:newTableZone.left+i,row:newTableZone.top,hiddenValues:table.filtersValues[i],});}}}
getClipboardContent(){return{[ClipboardMIMEType.PlainText]:this.getPlainTextContent(),[ClipboardMIMEType.Html]:this.getHTMLContent(),};}
getPlainTextContent(){return(this.cells.map((cells)=>{return cells.map((c)=>this.getters.shouldShowFormulas()&&c?.cell?.isFormula?c.cell?.content||"":c?.evaluatedCell?.formattedValue||"").join("\t");}).join("\n")||"\t");}
getHTMLContent(){if(this.cells.length===1&&this.cells[0].length===1){if(!this.cells[0][0]){return"";}
return this.getters.getCellText(this.cells[0][0].position);}
let htmlTable='<table border="1" style="border-collapse:collapse">';for(const row of this.cells){htmlTable+="<tr>";for(const cell of row){if(!cell){continue;}
const cssStyle=cssPropertiesToCss(cellStyleToCss(this.getters.getCellComputedStyle(cell.position)));const cellText=this.getters.getCellText(cell.position);htmlTable+=`<td style="${cssStyle}">`+xmlEscape(cellText)+"</td>";}
htmlTable+="</tr>";}
htmlTable+="</table>";return htmlTable;}
isColRowDirtyingClipboard(position,dimension){if(!this.zones){return false;}
for(let zone of this.zones){if(dimension==="COL"&&position<=zone.right){return true;}
if(dimension==="ROW"&&position<=zone.bottom){return true;}}
return false;}
drawClipboard(renderingContext){const{ctx,thinLineWidth}=renderingContext;if(this.sheetId!==this.getters.getActiveSheetId()||!this.zones||!this.zones.length){return;}
ctx.setLineDash([8,5]);ctx.strokeStyle=SELECTION_BORDER_COLOR;ctx.lineWidth=3.3*thinLineWidth;for(const zone of this.zones){const{x,y,width,height}=this.getters.getVisibleRect(zone);if(width>0&&height>0){ctx.strokeRect(x,y,width,height);}}}
pasteCf(origin,target){const xc=toXC(target.col,target.row);for(let rule of this.getters.getConditionalFormats(origin.sheetId)){for(let range of rule.ranges){if(isInside(origin.col,origin.row,this.getters.getRangeFromSheetXC(origin.sheetId,range).zone)){const cf=rule;const toRemoveRange=[];if(this.operation==="CUT"){toRemoveRange.push(toXC(origin.col,origin.row));}
if(origin.sheetId===target.sheetId){this.adaptCFRules(origin.sheetId,cf,[xc],toRemoveRange);}
else{this.adaptCFRules(origin.sheetId,cf,[],toRemoveRange);const cfToCopyTo=this.getCFToCopyTo(target.sheetId,cf);this.adaptCFRules(target.sheetId,cfToCopyTo,[xc],[]);}}}}}
adaptCFRules(sheetId,cf,toAdd,toRemove){const newRangesXC=this.getters.getAdaptedCfRanges(sheetId,cf,toAdd,toRemove);if(!newRangesXC){return;}
if(newRangesXC.length===0){this.dispatch("REMOVE_CONDITIONAL_FORMAT",{id:cf.id,sheetId});return;}
this.dispatch("ADD_CONDITIONAL_FORMAT",{cf:{id:cf.id,rule:cf.rule,stopIfTrue:cf.stopIfTrue,},ranges:newRangesXC.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}
getCFToCopyTo(targetSheetId,originCF){const cfInTarget=this.getters.getConditionalFormats(targetSheetId).find((cf)=>cf.stopIfTrue===originCF.stopIfTrue&&deepEquals(cf.rule,originCF.rule));return cfInTarget?cfInTarget:{...originCF,id:this.uuidGenerator.uuidv4(),ranges:[]};}
pasteDataValidation(origin,target){const rule=this.getters.getValidationRuleForCell(origin);if(!rule){return;}
const xc=toXC(target.col,target.row);for(const range of rule.ranges){if(isInside(origin.col,origin.row,range.zone)){const toRemoveRange=[];if(this.operation==="CUT"){toRemoveRange.push(toXC(origin.col,origin.row));}
if(origin.sheetId===target.sheetId){this.adaptDataValidationRule(origin.sheetId,rule,[xc],toRemoveRange);}
else{this.adaptDataValidationRule(origin.sheetId,rule,[],toRemoveRange);let copyToRule=this.getDataValidationRuleToCopyTo(target.sheetId,rule);this.adaptDataValidationRule(target.sheetId,copyToRule,[xc],[]);}}}}
getDataValidationRuleToCopyTo(targetSheetId,originRule){const ruleInTargetSheet=this.getters.getDataValidationRules(targetSheetId).find((rule)=>deepEquals(originRule.criterion,rule.criterion)&&originRule.isBlocking===rule.isBlocking);return ruleInTargetSheet?ruleInTargetSheet:{...originRule,id:this.uuidGenerator.uuidv4(),ranges:[]};}
adaptDataValidationRule(sheetId,rule,toAdd,toRemove){const dvRangesXcs=rule.ranges.map((range)=>this.getters.getRangeString(range,sheetId));const newRangesXC=recomputeZones([...dvRangesXcs,...toAdd],toRemove);if(newRangesXC.length===0){this.dispatch("REMOVE_DATA_VALIDATION_RULE",{sheetId,id:rule.id});return;}
this.dispatch("ADD_DATA_VALIDATION_RULE",{rule,ranges:newRangesXC.map((xc)=>this.getters.getRangeDataFromXc(sheetId,xc)),sheetId,});}}
class DataCleanupPlugin extends UIPlugin{allowDispatch(cmd){switch(cmd.type){case"REMOVE_DUPLICATES":return this.checkValidations(cmd,this.chainValidations(this.checkSingleRangeSelected,this.checkNoMergeInZone,this.checkRangeContainsValues,this.checkColumnsIncludedInZone),this.chainValidations(this.checkNoColumnProvided,this.checkColumnsAreUnique));}
return"Success";}
handle(cmd){switch(cmd.type){case"REMOVE_DUPLICATES":this.removeDuplicates(cmd.columns,cmd.hasHeader);break;case"TRIM_WHITESPACE":this.trimWhitespace();break;}}
removeDuplicates(columnsToAnalyze,hasHeader){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getSelectedZone();if(hasHeader){zone.top+=1;}
const uniqueRowsIndexes=this.getUniqueRowsIndexes(sheetId,zone.top,zone.bottom,columnsToAnalyze);const numberOfUniqueRows=uniqueRowsIndexes.length;if(numberOfUniqueRows===zoneToDimension(zone).numberOfRows){this.notifyRowsRemovedAndRemaining(0,numberOfUniqueRows);return;}
const rowsToKeep=uniqueRowsIndexes.map((rowIndex)=>({left:zone.left,top:rowIndex,right:zone.right,bottom:rowIndex,}));const state=new ClipboardCellsState(rowsToKeep,"COPY",this.getters,this.dispatch,this.selection);for(const{col,row}of positions(zone)){this.dispatch("CLEAR_CELL",{col,row,sheetId});}
const zonePasted={left:zone.left,top:zone.top,right:zone.left,bottom:zone.top,};state.paste([zonePasted]);const remainingZone={left:zone.left,top:zone.top-(hasHeader?1:0),right:zone.right,bottom:zone.top+numberOfUniqueRows-1,};this.selection.selectZone({cell:{col:remainingZone.left,row:remainingZone.top},zone:remainingZone,});const removedRows=zone.bottom-zone.top+1-numberOfUniqueRows;this.notifyRowsRemovedAndRemaining(removedRows,numberOfUniqueRows);}
getUniqueRowsIndexes(sheetId,top,bottom,columns){const uniqueRows=new Map();for(const row of range(top,bottom+1)){const cellsValuesInRow=columns.map((col)=>{return this.getters.getEvaluatedCell({sheetId,col,row,}).value;});const isRowUnique=!Object.values(uniqueRows).some((uniqueRow)=>deepEquals(uniqueRow,cellsValuesInRow));if(isRowUnique){uniqueRows[row]=cellsValuesInRow;}}
return Object.keys(uniqueRows).map((key)=>parseInt(key));}
notifyRowsRemovedAndRemaining(removedRows,remainingRows){this.ui.notifyUI({type:"info",text:_t("%s duplicate rows found and removed.\n%s unique rows remain.",removedRows.toString(),remainingRows.toString()),sticky:false,});}
checkSingleRangeSelected(){const zones=this.getters.getSelectedZones();if(zones.length!==1){return"MoreThanOneRangeSelected";}
return"Success";}
checkNoMergeInZone(){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getSelectedZone();const mergesInZone=this.getters.getMergesInZone(sheetId,zone);if(mergesInZone.length>0){return"WillRemoveExistingMerge";}
return"Success";}
checkRangeContainsValues(cmd){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getSelectedZone();if(cmd.hasHeader){zone.top+=1;}
const evaluatedCells=this.getters.getEvaluatedCellsInZone(sheetId,zone);if(evaluatedCells.every((evaluatedCel)=>evaluatedCel.type==="empty")){return"EmptyTarget";}
return"Success";}
checkNoColumnProvided(cmd){if(cmd.columns.length===0){return"NoColumnsProvided";}
return"Success";}
checkColumnsIncludedInZone(cmd){const zone=this.getters.getSelectedZone();const columnsToAnalyze=cmd.columns;if(columnsToAnalyze.some((colIndex)=>colIndex<zone.left||colIndex>zone.right)){return"ColumnsNotIncludedInZone";}
return"Success";}
checkColumnsAreUnique(cmd){if(cmd.columns.length!==new Set(cmd.columns).size){return"DuplicatesColumnsSelected";}
return"Success";}
trimWhitespace(){const zones=this.getters.getSelectedZones();const sheetId=this.getters.getActiveSheetId();let count=0;for(const{col,row}of zones.map(positions).flat()){const cell=this.getters.getCell({col,row,sheetId});if(!cell){continue;}
const trimmedContent=trimContent(cell.content);if(trimmedContent!==cell.content){count+=1;this.dispatch("UPDATE_CELL",{sheetId,col,row,content:trimmedContent,});}}
const text=count?_t("Trimmed whitespace from %s cells.",count):_t("No selected cells had whitespace trimmed.");this.ui.notifyUI({type:"info",text:text,sticky:false,});}}
const BORDER_COLOR="#8B008B";const BACKGROUND_COLOR="#8B008B33";var Direction;(function(Direction){Direction[Direction["previous"]=-1]="previous";Direction[Direction["current"]=0]="current";Direction[Direction["next"]=1]="next";})(Direction||(Direction={}));class FindAndReplacePlugin extends UIPlugin{static layers=[3];static getters=["getSearchMatches","getCurrentSelectedMatchIndex"];searchMatches=[];selectedMatchIndex=null;currentSearchRegex=null;searchOptions={matchCase:false,exactMatch:false,searchFormulas:false,};toSearch="";isSearchDirty=false;handle(cmd){switch(cmd.type){case"UPDATE_SEARCH":this.updateSearch(cmd.toSearch,cmd.searchOptions);break;case"CLEAR_SEARCH":this.clearSearch();break;case"SELECT_SEARCH_PREVIOUS_MATCH":this.selectNextCell(Direction.previous);break;case"SELECT_SEARCH_NEXT_MATCH":this.selectNextCell(Direction.next);break;case"REPLACE_SEARCH":this.replace(cmd.replaceWith);break;case"REPLACE_ALL_SEARCH":this.replaceAll(cmd.replaceWith);break;case"UNDO":case"REDO":case"REMOVE_FILTER_TABLE":case"UPDATE_FILTER":case"REMOVE_COLUMNS_ROWS":case"HIDE_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"ADD_COLUMNS_ROWS":case"EVALUATE_CELLS":case"UPDATE_CELL":this.isSearchDirty=true;break;case"ACTIVATE_SHEET":this.refreshSearch();break;}}
finalize(){if(this.isSearchDirty){this.refreshSearch();this.isSearchDirty=false;}}
getSearchMatches(){return this.searchMatches;}
getCurrentSelectedMatchIndex(){return this.selectedMatchIndex;}
updateSearch(toSearch,searchOptions){this.searchOptions=searchOptions;if(toSearch!==this.toSearch){this.selectedMatchIndex=null;}
this.toSearch=toSearch;this.updateRegex();this.refreshSearch();}
refreshSearch(){const matches=this.findMatches();this.searchMatches=matches;this.selectNextCell(Direction.current);}
updateRegex(){let searchValue=escapeRegExp(this.toSearch);const flags=!this.searchOptions.matchCase?"i":"";if(this.searchOptions.exactMatch){searchValue=`^${searchValue}$`;}
this.currentSearchRegex=RegExp(searchValue,flags);}
findMatches(){const sheetId=this.getters.getActiveSheetId();const cells=this.getters.getCells(sheetId);const matches=[];if(this.toSearch&&this.currentSearchRegex){for(const cell of Object.values(cells)){const{col,row}=this.getters.getCellPosition(cell.id);const cellPosition={sheetId,col,row};const isColHidden=this.getters.isColHidden(sheetId,col);const isRowHidden=this.getters.isRowHidden(sheetId,row);if(isColHidden||isRowHidden){continue;}
if(this.currentSearchRegex.test(this.getSearchableString(cellPosition))){const match={col,row,selected:false};matches.push(match);}
for(const spreadPosition of this.getters.getSpreadPositionsOf(cellPosition)){if(this.currentSearchRegex.test(this.getSearchableString(spreadPosition))){const match={col:spreadPosition.col,row:spreadPosition.row,selected:false,};matches.push(match);}}}}
return matches.sort(this.sortByRowThenColumn);}
sortByRowThenColumn(a,b){if(a.row===b.row){return a.col-b.col;}
return a.row>b.row?1:-1;}
selectNextCell(indexChange){const matches=this.searchMatches;if(!matches.length){this.selectedMatchIndex=null;return;}
let nextIndex;if(this.selectedMatchIndex===null){nextIndex=0;}
else{nextIndex=this.selectedMatchIndex+indexChange;}
nextIndex=((nextIndex%matches.length)+matches.length)%matches.length;this.selectedMatchIndex=nextIndex;this.selection.selectCell(matches[nextIndex].col,matches[nextIndex].row);for(let index=0;index<this.searchMatches.length;index++){this.searchMatches[index].selected=index===this.selectedMatchIndex;}}
clearSearch(){this.toSearch="";this.searchMatches=[];this.selectedMatchIndex=null;this.currentSearchRegex=null;this.searchOptions={matchCase:false,exactMatch:false,searchFormulas:false,};}
replaceMatch(selectedMatch,replaceWith){if(!this.currentSearchRegex){return;}
const sheetId=this.getters.getActiveSheetId();const position={sheetId,...selectedMatch};const cell=this.getters.getCell(position);if(!cell?.content){return;}
if(cell?.isFormula&&!this.searchOptions.searchFormulas){return;}
const replaceRegex=new RegExp(this.currentSearchRegex.source,this.currentSearchRegex.flags+"g");const toReplace=this.getSearchableString(position);const content=toReplace.replace(replaceRegex,replaceWith);const canonicalContent=canonicalizeNumberContent(content,this.getters.getLocale());this.dispatch("UPDATE_CELL",{...position,content:canonicalContent});}
replace(replaceWith){if(this.selectedMatchIndex===null){return;}
const selectedMatch=this.searchMatches[this.selectedMatchIndex];this.replaceMatch(selectedMatch,replaceWith);this.selectNextCell(Direction.next);}
replaceAll(replaceWith){const matchCount=this.searchMatches.length;for(let i=0;i<matchCount;i++){this.replaceMatch(this.searchMatches[i],replaceWith);}}
getSearchableString(position){return this.getters.getCellText(position,this.searchOptions.searchFormulas);}
drawGrid(renderingContext){const{ctx}=renderingContext;const sheetId=this.getters.getActiveSheetId();for(const match of this.searchMatches){const merge=this.getters.getMerge({sheetId,col:match.col,row:match.row});const left=merge?merge.left:match.col;const right=merge?merge.right:match.col;const top=merge?merge.top:match.row;const bottom=merge?merge.bottom:match.row;const{x,y,width,height}=this.getters.getVisibleRect({top,left,right,bottom});if(width>0&&height>0){ctx.fillStyle=BACKGROUND_COLOR;ctx.fillRect(x,y,width,height);if(match.selected){ctx.strokeStyle=BORDER_COLOR;ctx.strokeRect(x,y,width,height);}}}}}
class FormatPlugin extends UIPlugin{handle(cmd){switch(cmd.type){case"SET_DECIMAL":this.setDecimal(cmd.sheetId,cmd.target,cmd.step);break;}}
setDecimal(sheetId,zones,step){for(const zone of zones){for(const position of positions(zone)){const numberFormat=this.getCellNumberFormat({sheetId,...position});if(numberFormat!==undefined){this.getters.getLocale();const newFormat=changeDecimalPlaces(numberFormat,step);this.dispatch("SET_FORMATTING",{sheetId,target:[positionToZone(position)],format:newFormat,});}}}}
getCellNumberFormat(position){for(const pos of[position]){const cell=this.getters.getEvaluatedCell(pos);if(cell.type===CellValueType.number&&!(cell.format&&isDateTimeFormat(cell.format))){return cell.format||createDefaultFormat(cell.value);}}
return undefined;}}
class HeaderVisibilityUIPlugin extends UIPlugin{static getters=["getNextVisibleCellPosition","findVisibleHeader","findLastVisibleColRowIndex","findFirstVisibleColRowIndex","isRowHidden","isColHidden","isHeaderHidden",];isRowHidden(sheetId,index){return(this.getters.isRowHiddenByUser(sheetId,index)||this.getters.isRowFiltered(sheetId,index));}
isColHidden(sheetId,index){return this.getters.isColHiddenByUser(sheetId,index);}
isHeaderHidden(sheetId,dimension,index){return dimension==="COL"?this.isColHidden(sheetId,index):this.isRowHidden(sheetId,index);}
getNextVisibleCellPosition({sheetId,col,row}){return{sheetId,col:this.findVisibleHeader(sheetId,"COL",col,this.getters.getNumberCols(sheetId)-1),row:this.findVisibleHeader(sheetId,"ROW",row,this.getters.getNumberRows(sheetId)-1),};}
findVisibleHeader(sheetId,dimension,from,to){if(from<=to){for(let i=from;i<=to;i++){if(this.getters.doesHeaderExist(sheetId,dimension,i)&&!this.isHeaderHidden(sheetId,dimension,i)){return i;}}}
if(from>to){for(let i=from;i>=to;i--){if(this.getters.doesHeaderExist(sheetId,dimension,i)&&!this.isHeaderHidden(sheetId,dimension,i)){return i;}}}
return undefined;}
findLastVisibleColRowIndex(sheetId,dimension,{last,first}){const lastVisibleIndex=range(last,first,-1).find((index)=>!this.isHeaderHidden(sheetId,dimension,index));return lastVisibleIndex||first;}
findFirstVisibleColRowIndex(sheetId,dimension){const numberOfHeaders=this.getters.getNumberHeaders(sheetId,dimension);for(let i=0;i<numberOfHeaders;i++){if(dimension==="COL"&&!this.isColHidden(sheetId,i)){return i;}
if(dimension==="ROW"&&!this.isRowHidden(sheetId,i)){return i;}}
return undefined;}
exportForExcel(data){for(const sheetData of data.sheets){for(const[row,rowData]of Object.entries(sheetData.rows)){const isHidden=this.isRowHidden(sheetData.id,Number(row));rowData.isHidden=isHidden;}}}}
class HighlightPlugin extends UIPlugin{static layers=[1];static getters=["getHighlights"];getHighlights(){return this.prepareHighlights(this.getters.getComposerHighlights().concat(this.getters.getSelectionInputHighlights()));}
prepareHighlights(highlights){return highlights.filter((x)=>x.zone.top>=0&&x.zone.left>=0&&x.zone.bottom<this.getters.getNumberRows(x.sheetId)&&x.zone.right<this.getters.getNumberCols(x.sheetId)).map((highlight)=>{const{numberOfRows,numberOfCols}=zoneToDimension(highlight.zone);const zone=numberOfRows*numberOfCols===1?this.getters.expandZone(highlight.sheetId,highlight.zone):highlight.zone;return{...highlight,zone,};});}
drawGrid(renderingContext){const{ctx,thinLineWidth}=renderingContext;const sheetId=this.getters.getActiveSheetId();const lineWidth=3*thinLineWidth;ctx.lineWidth=lineWidth;const highlights=this.getHighlights();for(let h of highlights.filter((highlight,index)=>highlights.findIndex((h)=>isEqual(h.zone,highlight.zone)&&h.sheetId===sheetId)===index)){const{x,y,width,height}=this.getters.getVisibleRect(h.zone);if(width>0&&height>0){ctx.strokeStyle=h.color;ctx.strokeRect(x+lineWidth/2,y+lineWidth/2,width-lineWidth,height-lineWidth);ctx.globalCompositeOperation="source-over";ctx.fillStyle=h.color+"20";ctx.fillRect(x+lineWidth,y+lineWidth,width-2*lineWidth,height-2*lineWidth);}}}}
class RendererPlugin extends UIPlugin{static layers=[0,7];static getters=["getColDimensionsInViewport","getRowDimensionsInViewport"];boxes=[];getColDimensionsInViewport(sheetId,col){const left=largeMin(this.getters.getSheetViewVisibleCols());const start=this.getters.getColRowOffsetInViewport("COL",left,col);const size=this.getters.getColSize(sheetId,col);const isColHidden=this.getters.isColHidden(sheetId,col);return{start,size:size,end:start+(isColHidden?0:size),};}
getRowDimensionsInViewport(sheetId,row){const top=largeMin(this.getters.getSheetViewVisibleRows());const start=this.getters.getColRowOffsetInViewport("ROW",top,row);const size=this.getters.getRowSize(sheetId,row);const isRowHidden=this.getters.isRowHidden(sheetId,row);return{start,size:size,end:start+(isRowHidden?0:size),};}
getHeaderOffset(dimension,start,index){let size=this.getters.getColRowOffsetInViewport(dimension,start,index);if(!this.getters.isDashboard()){size+=dimension==="ROW"?HEADER_HEIGHT:HEADER_WIDTH;}
return size;}
drawGrid(renderingContext,layer){switch(layer){case 0:this.boxes=this.getGridBoxes();this.drawBackground(renderingContext);this.drawOverflowingCellBackground(renderingContext);this.drawCellBackground(renderingContext);this.drawBorders(renderingContext);this.drawTexts(renderingContext);this.drawIcon(renderingContext);this.drawFrozenPanes(renderingContext);break;case 7:if(!this.getters.isDashboard()){this.drawHeaders(renderingContext);this.drawFrozenPanesHeaders(renderingContext);}
break;}}
drawBackground(renderingContext){const{ctx,thinLineWidth}=renderingContext;const{width,height}=this.getters.getSheetViewDimensionWithHeaders();ctx.fillStyle="#ffffff";ctx.fillRect(0,0,width+CANVAS_SHIFT,height+CANVAS_SHIFT);const areGridLinesVisible=!this.getters.isDashboard()&&this.getters.getGridLinesVisibility(this.getters.getActiveSheetId());const inset=areGridLinesVisible?0.1*thinLineWidth:0;if(areGridLinesVisible){for(const box of this.boxes){ctx.strokeStyle=CELL_BORDER_COLOR;ctx.lineWidth=thinLineWidth;ctx.strokeRect(box.x+inset,box.y+inset,box.width-2*inset,box.height-2*inset);}}}
drawCellBackground(renderingContext){const{ctx}=renderingContext;for(const box of this.boxes){let style=box.style;if(style.fillColor&&style.fillColor!=="#ffffff"){ctx.fillStyle=style.fillColor||"#ffffff";ctx.fillRect(box.x,box.y,box.width,box.height);}
if(box.isError){ctx.fillStyle="red";ctx.beginPath();ctx.moveTo(box.x+box.width-5,box.y);ctx.lineTo(box.x+box.width,box.y);ctx.lineTo(box.x+box.width,box.y+5);ctx.fill();}}}
drawOverflowingCellBackground(renderingContext){const{ctx,thinLineWidth}=renderingContext;for(const box of this.boxes){if(box.content&&box.isOverflow){const align=box.content.align||"left";let x;let width;const y=box.y+thinLineWidth/2;const height=box.height-thinLineWidth;const clipWidth=Math.min(box.clipRect?.width||Infinity,box.content.width);if(align==="left"){x=box.x+thinLineWidth/2;width=clipWidth-2*thinLineWidth;}
else if(align==="right"){x=box.x+box.width-thinLineWidth/2;width=-clipWidth+2*thinLineWidth;}
else{x=(box.clipRect?.x||box.x+box.width/2-box.content.width/2)+thinLineWidth/2;width=clipWidth-2*thinLineWidth;}
ctx.fillStyle="#ffffff";ctx.fillRect(x,y,width,height);}}}
drawBorders(renderingContext){const{ctx}=renderingContext;for(let box of this.boxes){const border=box.border;if(border){const{x,y,width,height}=box;if(border.left){drawBorder(border.left,x,y,x,y+height);}
if(border.top){drawBorder(border.top,x,y,x+width,y);}
if(border.right){drawBorder(border.right,x+width,y,x+width,y+height);}
if(border.bottom){drawBorder(border.bottom,x,y+height,x+width,y+height);}}}
function drawBorder({style,color},x1,y1,x2,y2){ctx.strokeStyle=color;switch(style){case"medium":ctx.lineWidth=2;x1+=y1===y2?-0.5:0.5;x2+=y1===y2?1.5:0.5;y1+=x1===x2?-0.5:0.5;y2+=x1===x2?1.5:0.5;break;case"thick":ctx.lineWidth=3;if(y1===y2){x1--;x2++;}
if(x1===x2){y1--;y2++;}
break;case"dashed":ctx.lineWidth=1;ctx.setLineDash([1,3]);break;case"dotted":ctx.lineWidth=1;if(y1===y2){x1+=0.5;x2+=0.5;}
if(x1===x2){y1+=0.5;y2+=0.5;}
ctx.setLineDash([1,1]);break;case"thin":default:ctx.lineWidth=1;break;}
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();ctx.lineWidth=1;ctx.setLineDash([]);}}
drawTexts(renderingContext){const{ctx}=renderingContext;ctx.textBaseline="top";let currentFont;for(let box of this.boxes){if(box.content){const style=box.style||{};const align=box.content.align||"left";const font=computeTextFont(style);if(font!==currentFont){currentFont=font;ctx.font=font;}
ctx.fillStyle=style.textColor||"#000";let x=box.x;if(align==="left"){x+=MIN_CELL_TEXT_MARGIN+(box.image?box.image.size+MIN_CF_ICON_MARGIN:0);}
else if(align==="right"){x+=box.width-
MIN_CELL_TEXT_MARGIN-
(box.hasIcon?GRID_ICON_EDGE_LENGTH+GRID_ICON_MARGIN:0);}
else{x+=box.width/2;}
ctx.textAlign=align;if(box.clipRect){ctx.save();ctx.beginPath();const{x,y,width,height}=box.clipRect;ctx.rect(x,y,width,height);ctx.clip();}
const textLineHeight=computeTextFontSizeInPixels(style);const numberOfLines=box.content.textLines.length;let y=this.computeTextYCoordinate(box,textLineHeight,numberOfLines);for(let brokenLine of box.content.textLines){drawDecoratedText(ctx,brokenLine,{x:Math.round(x),y:Math.round(y)},style.underline,style.strikethrough);y+=MIN_CELL_TEXT_MARGIN+textLineHeight;}
if(box.clipRect){ctx.restore();}}}}
drawIcon(renderingContext){const{ctx}=renderingContext;for(const box of this.boxes){if(box.image){const icon=box.image.image;if(box.image.clipIcon){ctx.save();ctx.beginPath();const{x,y,width,height}=box.image.clipIcon;ctx.rect(x,y,width,height);ctx.clip();}
const iconSize=box.image.size;const y=this.computeTextYCoordinate(box,iconSize);ctx.drawImage(icon,box.x+MIN_CF_ICON_MARGIN,y,iconSize,iconSize);if(box.image.clipIcon){ctx.restore();}}}}
computeTextYCoordinate(box,textLineHeight,numberOfLines=1){const y=box.y+1;const textHeight=computeTextLinesHeight(textLineHeight,numberOfLines);const hasEnoughSpaces=box.height>textHeight+MIN_CELL_TEXT_MARGIN*2;const verticalAlign=box.verticalAlign||DEFAULT_VERTICAL_ALIGN;if(hasEnoughSpaces){if(verticalAlign==="middle"){return y+(box.height-textHeight)/2;}
if(verticalAlign==="bottom"){return y+box.height-textHeight-MIN_CELL_TEXT_MARGIN;}}
return y+MIN_CELL_TEXT_MARGIN;}
drawHeaders(renderingContext){const{ctx,thinLineWidth}=renderingContext;const visibleCols=this.getters.getSheetViewVisibleCols();const left=visibleCols[0];const right=visibleCols[visibleCols.length-1];const visibleRows=this.getters.getSheetViewVisibleRows();const top=visibleRows[0];const bottom=visibleRows[visibleRows.length-1];const{width,height}=this.getters.getSheetViewDimensionWithHeaders();const selection=this.getters.getSelectedZones();const selectedCols=getZonesCols(selection);const selectedRows=getZonesRows(selection);const sheetId=this.getters.getActiveSheetId();const numberOfCols=this.getters.getNumberCols(sheetId);const numberOfRows=this.getters.getNumberRows(sheetId);const activeCols=this.getters.getActiveCols();const activeRows=this.getters.getActiveRows();ctx.font=`400 ${HEADER_FONT_SIZE}px ${DEFAULT_FONT}`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.lineWidth=thinLineWidth;ctx.strokeStyle="#333";for(let col=left;col<=right;col++){const colZone={left:col,right:col,top:0,bottom:numberOfRows-1};const{x,width}=this.getters.getVisibleRect(colZone);const colHasFilter=this.getters.doesZonesContainFilter(sheetId,[colZone]);const isColActive=activeCols.has(col);const isColSelected=selectedCols.has(col);if(isColActive){ctx.fillStyle=colHasFilter?FILTERS_COLOR:BACKGROUND_HEADER_ACTIVE_COLOR;}
else if(isColSelected){ctx.fillStyle=colHasFilter?BACKGROUND_HEADER_SELECTED_FILTER_COLOR:BACKGROUND_HEADER_SELECTED_COLOR;}
else{ctx.fillStyle=colHasFilter?BACKGROUND_HEADER_FILTER_COLOR:BACKGROUND_HEADER_COLOR;}
ctx.fillRect(x,0,width,HEADER_HEIGHT);}
for(let row=top;row<=bottom;row++){const rowZone={top:row,bottom:row,left:0,right:numberOfCols-1};const{y,height}=this.getters.getVisibleRect(rowZone);const rowHasFilter=this.getters.doesZonesContainFilter(sheetId,[rowZone]);const isRowActive=activeRows.has(row);const isRowSelected=selectedRows.has(row);if(isRowActive){ctx.fillStyle=rowHasFilter?FILTERS_COLOR:BACKGROUND_HEADER_ACTIVE_COLOR;}
else if(isRowSelected){ctx.fillStyle=rowHasFilter?BACKGROUND_HEADER_SELECTED_FILTER_COLOR:BACKGROUND_HEADER_SELECTED_COLOR;}
else{ctx.fillStyle=rowHasFilter?BACKGROUND_HEADER_FILTER_COLOR:BACKGROUND_HEADER_COLOR;}
ctx.fillRect(0,y,HEADER_WIDTH,height);}
ctx.beginPath();ctx.moveTo(HEADER_WIDTH,0);ctx.lineTo(HEADER_WIDTH,height);ctx.moveTo(0,HEADER_HEIGHT);ctx.lineTo(width,HEADER_HEIGHT);ctx.strokeStyle=HEADER_BORDER_COLOR;ctx.stroke();ctx.beginPath();for(const i of visibleCols){const colSize=this.getters.getColSize(sheetId,i);const colName=numberToLetters(i);ctx.fillStyle=activeCols.has(i)?"#fff":TEXT_HEADER_COLOR;let colStart=this.getHeaderOffset("COL",left,i);ctx.fillText(colName,colStart+colSize/2,HEADER_HEIGHT/2);ctx.moveTo(colStart+colSize,0);ctx.lineTo(colStart+colSize,HEADER_HEIGHT);}
for(const i of visibleRows){const rowSize=this.getters.getRowSize(sheetId,i);ctx.fillStyle=activeRows.has(i)?"#fff":TEXT_HEADER_COLOR;let rowStart=this.getHeaderOffset("ROW",top,i);ctx.fillText(String(i+1),HEADER_WIDTH/2,rowStart+rowSize/2);ctx.moveTo(0,rowStart+rowSize);ctx.lineTo(HEADER_WIDTH,rowStart+rowSize);}
ctx.stroke();}
drawFrozenPanesHeaders(renderingContext){const{ctx,thinLineWidth}=renderingContext;const{x:offsetCorrectionX,y:offsetCorrectionY}=this.getters.getMainViewportCoordinates();const widthCorrection=this.getters.isDashboard()?0:HEADER_WIDTH;const heightCorrection=this.getters.isDashboard()?0:HEADER_HEIGHT;ctx.lineWidth=6*thinLineWidth;ctx.strokeStyle=FROZEN_PANE_HEADER_BORDER_COLOR;ctx.beginPath();if(offsetCorrectionX){ctx.moveTo(widthCorrection+offsetCorrectionX,0);ctx.lineTo(widthCorrection+offsetCorrectionX,heightCorrection);}
if(offsetCorrectionY){ctx.moveTo(0,heightCorrection+offsetCorrectionY);ctx.lineTo(widthCorrection,heightCorrection+offsetCorrectionY);}
ctx.stroke();}
drawFrozenPanes(renderingContext){const{ctx,thinLineWidth}=renderingContext;const{x:offsetCorrectionX,y:offsetCorrectionY}=this.getters.getMainViewportCoordinates();const visibleCols=this.getters.getSheetViewVisibleCols();const left=visibleCols[0];const right=visibleCols[visibleCols.length-1];const visibleRows=this.getters.getSheetViewVisibleRows();const top=visibleRows[0];const bottom=visibleRows[visibleRows.length-1];const viewport={left,right,top,bottom};const rect=this.getters.getVisibleRect(viewport);const widthCorrection=this.getters.isDashboard()?0:HEADER_WIDTH;const heightCorrection=this.getters.isDashboard()?0:HEADER_HEIGHT;ctx.lineWidth=6*thinLineWidth;ctx.strokeStyle=FROZEN_PANE_BORDER_COLOR;ctx.beginPath();if(offsetCorrectionX){ctx.moveTo(widthCorrection+offsetCorrectionX,heightCorrection);ctx.lineTo(widthCorrection+offsetCorrectionX,rect.height+heightCorrection);}
if(offsetCorrectionY){ctx.moveTo(widthCorrection,heightCorrection+offsetCorrectionY);ctx.lineTo(rect.width+widthCorrection,heightCorrection+offsetCorrectionY);}
ctx.stroke();}
findNextEmptyCol(base,max,row){const sheetId=this.getters.getActiveSheetId();let col=base;while(col<max){const position={sheetId,col:col+1,row};const nextCell=this.getters.getEvaluatedCell(position);const nextCellBorder=this.getters.getCellBorderWithFilterBorder(position);const cellHasIcon=this.getters.doesCellHaveGridIcon(position);const cellHasCheckbox=this.getters.isCellValidCheckbox(position);if(nextCell.type!==CellValueType.empty||this.getters.isInMerge(position)||nextCellBorder?.left||cellHasIcon||cellHasCheckbox){return col;}
col++;}
return col;}
findPreviousEmptyCol(base,min,row){const sheetId=this.getters.getActiveSheetId();let col=base;while(col>min){const position={sheetId,col:col-1,row};const previousCell=this.getters.getEvaluatedCell(position);const previousCellBorder=this.getters.getCellBorderWithFilterBorder(position);const cellHasIcon=this.getters.doesCellHaveGridIcon(position);const cellHasCheckbox=this.getters.isCellValidCheckbox(position);if(previousCell.type!==CellValueType.empty||this.getters.isInMerge(position)||previousCellBorder?.right||cellHasIcon||cellHasCheckbox){return col;}
col--;}
return col;}
computeCellAlignment(position,isOverflowing){const cell=this.getters.getCell(position);if(cell?.isFormula&&this.getters.shouldShowFormulas()){return"left";}
const{align}=this.getters.getCellStyle(position);const evaluatedCell=this.getters.getEvaluatedCell(position);if(isOverflowing&&evaluatedCell.type===CellValueType.number){return align!=="center"?"left":align;}
return align||evaluatedCell.defaultAlign;}
createZoneBox(sheetId,zone,viewport){const{left,right}=viewport;const col=zone.left;const row=zone.top;const position={sheetId,col,row};const cell=this.getters.getEvaluatedCell(position);const showFormula=this.getters.shouldShowFormulas();const{x,y,width,height}=this.getters.getVisibleRect(zone);const{verticalAlign}=this.getters.getCellStyle(position);const box={x,y,width,height,border:this.getters.getCellBorderWithFilterBorder(position)||undefined,style:this.getters.getCellComputedStyle(position),verticalAlign,isError:(cell.type===CellValueType.error&&cell.error.isVerbose)||this.getters.isDataValidationInvalid(position),};if(cell.type===CellValueType.empty||this.getters.isCellValidCheckbox(position)){return box;}
const cfIcon=this.getters.getConditionalIcon(position);const fontSizePX=computeTextFontSizeInPixels(box.style);const iconBoxWidth=cfIcon?MIN_CF_ICON_MARGIN+fontSizePX:0;if(cfIcon){box.image={type:"icon",size:fontSizePX,clipIcon:{x:box.x,y:box.y,width:Math.min(iconBoxWidth,width),height},image:ICONS[cfIcon].img,};}
box.hasIcon=this.getters.doesCellHaveGridIcon(position);const headerIconWidth=box.hasIcon?GRID_ICON_EDGE_LENGTH+GRID_ICON_MARGIN:0;const style=this.getters.getCellComputedStyle(position);const wrapping=style.wrapping||"overflow";const maxWidth=wrapping==="wrap"&&!showFormula?width-2*MIN_CELL_TEXT_MARGIN:undefined;const multiLineText=this.getters.getCellMultiLineText(position,maxWidth);const textWidth=Math.max(...multiLineText.map((line)=>this.getters.getTextWidth(line,style)+MIN_CELL_TEXT_MARGIN));const contentWidth=iconBoxWidth+textWidth+headerIconWidth;const align=this.computeCellAlignment(position,contentWidth>width);box.content={textLines:multiLineText,width:wrapping==="overflow"?textWidth:width,align,};const isOverflowing=contentWidth>width||fontSizePX>height;if(cfIcon||box.hasIcon){box.clipRect={x:box.x+iconBoxWidth,y:box.y,width:Math.max(0,width-iconBoxWidth-headerIconWidth),height,};}
else if(isOverflowing&&wrapping==="overflow"){let nextColIndex,previousColIndex;const isCellInMerge=this.getters.isInMerge(position);if(isCellInMerge){nextColIndex=this.getters.getMerge(position).right;previousColIndex=col;}
else{nextColIndex=this.findNextEmptyCol(col,right,row);previousColIndex=this.findPreviousEmptyCol(col,left,row);box.isOverflow=true;}
switch(align){case"left":{const emptyZoneOnTheLeft=positionToZone({col:nextColIndex,row});const{x,y,width,height}=this.getters.getVisibleRect(union(zone,emptyZoneOnTheLeft));if(width<contentWidth||fontSizePX>height||multiLineText.length>1){box.clipRect={x,y,width,height};}
break;}
case"right":{const emptyZoneOnTheRight=positionToZone({col:previousColIndex,row});const{x,y,width,height}=this.getters.getVisibleRect(union(zone,emptyZoneOnTheRight));if(width<contentWidth||fontSizePX>height||multiLineText.length>1){box.clipRect={x,y,width,height};}
break;}
case"center":{const emptyZone={...zone,left:previousColIndex,right:nextColIndex,};const{x,y,height,width}=this.getters.getVisibleRect(emptyZone);const halfContentWidth=contentWidth/2;const boxMiddle=box.x+box.width/2;if(x+width<boxMiddle+halfContentWidth||x>boxMiddle-halfContentWidth||fontSizePX>height||multiLineText.length>1){const clipX=x>boxMiddle-halfContentWidth?x:boxMiddle-halfContentWidth;const clipWidth=x+width-clipX;box.clipRect={x:clipX,y,width:clipWidth,height};}
break;}}}
else if(wrapping==="clip"||wrapping==="wrap"||multiLineText.length>1){box.clipRect={x:box.x,y:box.y,width,height,};}
return box;}
getGridBoxes(){const boxes=[];const visibleCols=this.getters.getSheetViewVisibleCols();const left=visibleCols[0];const right=visibleCols[visibleCols.length-1];const visibleRows=this.getters.getSheetViewVisibleRows();const top=visibleRows[0];const bottom=visibleRows[visibleRows.length-1];const viewport={left,right,top,bottom};const sheetId=this.getters.getActiveSheetId();for(const row of visibleRows){for(const col of visibleCols){const position={sheetId,col,row};if(this.getters.isInMerge(position)){continue;}
boxes.push(this.createZoneBox(sheetId,positionToZone(position),viewport));}}
for(const merge of this.getters.getMerges(sheetId)){if(this.getters.isMergeHidden(sheetId,merge)){continue;}
if(overlap(merge,viewport)){const box=this.createZoneBox(sheetId,merge,viewport);const borderBottomRight=this.getters.getCellBorder({sheetId,col:merge.right,row:merge.bottom,});box.border={...box.border,bottom:borderBottomRight?borderBottomRight.bottom:undefined,right:borderBottomRight?borderBottomRight.right:undefined,};box.isMerge=true;boxes.push(box);}}
return boxes;}}
class SelectionInputPlugin extends UIPlugin{inputHasSingleRange;static layers=[1];static getters=[];ranges=[];focusedRangeIndex=null;inputSheetId;constructor(config,initialRanges,inputHasSingleRange){if(inputHasSingleRange&&initialRanges.length>1){throw new Error("Input with a single range cannot be instantiated with several range references.");}
super(config);this.inputHasSingleRange=inputHasSingleRange;this.insertNewRange(0,initialRanges);this.inputSheetId=this.getters.getActiveSheetId();if(this.ranges.length===0){this.insertNewRange(this.ranges.length,[""]);this.focusLast();}}
handleEvent(event){if(this.focusedRangeIndex===null){return;}
const inputSheetId=this.inputSheetId;const activeSheetId=this.getters.getActiveSheetId();const zone=event.options.unbounded?this.getters.getUnboundedZone(activeSheetId,event.anchor.zone):event.anchor.zone;const range=this.getters.getRangeFromZone(activeSheetId,zone);const willAddNewRange=event.mode==="newAnchor"&&!this.inputHasSingleRange&&this.ranges[this.focusedRangeIndex].xc.trim()!=="";if(willAddNewRange){const xc=this.getters.getSelectionRangeString(range,inputSheetId);this.insertNewRange(this.ranges.length,[xc]);this.focusLast();}
else{let parts=range.parts;const previousXc=this.ranges[this.focusedRangeIndex].xc.trim();if(previousXc){parts=this.getters.getRangeFromSheetXC(inputSheetId,previousXc).parts;}
const newRange=range.clone({parts});const xc=this.getters.getSelectionRangeString(newRange,inputSheetId);this.setRange(this.focusedRangeIndex,[xc]);}}
handle(cmd){switch(cmd.type){case"UNFOCUS_SELECTION_INPUT":this.unfocus();break;case"FOCUS_RANGE":this.focus(this.getIndex(cmd.rangeId));break;case"CHANGE_RANGE":{const index=this.getIndex(cmd.rangeId);if(index!==null&&this.focusedRangeIndex!==index){this.focus(index);}
if(index!==null){const valueWithoutLeadingComma=cmd.value.replace(/^,+/,"");const values=valueWithoutLeadingComma.split(",").map((reference)=>reference.trim());this.setRange(index,values);}
break;}
case"ADD_EMPTY_RANGE":this.insertNewRange(this.ranges.length,[""]);this.focusLast();break;case"ADD_RANGE":this.insertNewRange(this.ranges.length,[cmd.value]);this.focusLast();break;case"REMOVE_RANGE":const index=this.getIndex(cmd.rangeId);if(index!==null){this.removeRange(index);}
break;case"ACTIVATE_SHEET":{if(cmd.sheetIdFrom!==cmd.sheetIdTo){const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:cmd.sheetIdTo,col:0,row:0,});const zone=this.getters.expandZone(cmd.sheetIdTo,positionToZone({col,row}));this.selection.resetAnchor(this,{cell:{col,row},zone});}
break;}
case"START_CHANGE_HIGHLIGHT":const activeSheetId=this.getters.getActiveSheetId();const newZone=this.getters.expandZone(activeSheetId,cmd.zone);const focusIndex=this.ranges.findIndex((range)=>{const{xc,sheetName:sheet}=splitReference(range.xc);const sheetName=sheet||this.getters.getSheetName(this.inputSheetId);if(this.getters.getSheetName(activeSheetId)!==sheetName){return false;}
const refRange=this.getters.getRangeFromSheetXC(activeSheetId,xc);return isEqual(this.getters.expandZone(activeSheetId,refRange.zone),newZone);});if(focusIndex!==-1){this.focus(focusIndex);const{left,top}=newZone;this.selection.resetAnchor(this,{cell:{col:left,row:top},zone:newZone});}
break;}}
getSelectionInputValue(){return this.cleanInputs(this.ranges.map((range)=>{return range.xc?range.xc:"";}));}
getSelectionInputHighlights(){return this.ranges.map((input)=>this.inputToHighlights(input)).flat();}
focus(index){this.focusedRangeIndex=index;}
focusLast(){this.focus(this.ranges.length-1);}
unfocus(){this.focusedRangeIndex=null;}
setContent(index,xc){this.ranges[index]={...this.ranges[index],xc,};}
insertNewRange(index,values){const currentMaxId=Math.max(0,...this.ranges.map((range)=>Number(range.id)));this.ranges.splice(index,0,...values.map((xc,i)=>({xc,id:currentMaxId+i+1,color:colors$1[(currentMaxId+i)%colors$1.length],})));}
setRange(index,values){const[,...additionalValues]=values;this.setContent(index,values[0]);this.insertNewRange(index+1,additionalValues);if(additionalValues.length){this.focus(index+additionalValues.length);}}
removeRange(index){this.ranges.splice(index,1);if(this.focusedRangeIndex!==null){this.focusLast();}}
inputToHighlights({xc,color}){const XCs=this.cleanInputs([xc]).filter((range)=>this.getters.isRangeValid(range)).filter((reference)=>this.shouldBeHighlighted(this.inputSheetId,reference));return XCs.map((xc)=>{const{sheetName}=splitReference(xc);return{zone:this.getters.getRangeFromSheetXC(this.inputSheetId,xc).zone,sheetId:(sheetName&&this.getters.getSheetIdByName(sheetName))||this.inputSheetId,color,};});}
cleanInputs(ranges){return ranges.map((xc)=>xc.split(",")).flat().map((xc)=>xc.trim()).filter((xc)=>xc!=="");}
shouldBeHighlighted(inputSheetId,reference){const{sheetName}=splitReference(reference);const sheetId=this.getters.getSheetIdByName(sheetName);const activeSheetId=this.getters.getActiveSheet().id;const valid=this.getters.isRangeValid(reference);return(valid&&(sheetId===activeSheetId||(sheetId===undefined&&activeSheetId===inputSheetId)));}
getIndex(rangeId){const index=this.ranges.findIndex((range)=>range.id===rangeId);return index>=0?index:null;}}
class SelectionInputsManagerPlugin extends UIPlugin{config;static layers=[1];static getters=["getSelectionInput","getSelectionInputValue","isRangeValid","getSelectionInputHighlights",];inputs={};focusedInputId=null;get currentInput(){return this.focusedInputId?this.inputs[this.focusedInputId]:null;}
constructor(config){super(config);this.config=config;}
allowDispatch(cmd){switch(cmd.type){case"FOCUS_RANGE":case"CHANGE_RANGE":case"ADD_EMPTY_RANGE":case"REMOVE_RANGE":if(!this.inputs[cmd.id]){return"InvalidInputId";}}
switch(cmd.type){case"FOCUS_RANGE":const index=this.currentInput?.getIndex(cmd.rangeId);if(this.focusedInputId===cmd.id&&this.currentInput?.focusedRangeIndex===index){return"InputAlreadyFocused";}
break;case"ADD_RANGE":case"ADD_EMPTY_RANGE":const input=this.inputs[cmd.id];if(input.inputHasSingleRange&&input.ranges.length===1){return"MaximumRangesReached";}
break;case"REMOVE_RANGE":if(this.inputs[cmd.id].ranges.length===1){return"MinimumRangesReached";}
break;case"CHANGE_RANGE":{const input=this.inputs[cmd.id];if(input.inputHasSingleRange&&cmd.value.split(",").length>1){return"MaximumRangesReached";}
break;}}
return"Success";}
handle(cmd){switch(cmd.type){case"ENABLE_NEW_SELECTION_INPUT":this.initInput(cmd.id,cmd.initialRanges||[],cmd.hasSingleRange);break;case"DISABLE_SELECTION_INPUT":if(this.focusedInputId===cmd.id){this.unfocus();}
delete this.inputs[cmd.id];break;case"UNFOCUS_SELECTION_INPUT":this.unfocus();break;case"ADD_RANGE":case"ADD_EMPTY_RANGE":case"REMOVE_RANGE":if(cmd.id!==this.focusedInputId){const input=this.inputs[cmd.id];this.selection.capture(input,{cell:{col:0,row:0},zone:positionToZone({col:0,row:0})},{handleEvent:input.handleEvent.bind(input),release:()=>(this.focusedInputId=null),});this.focusedInputId=cmd.id;}
break;case"FOCUS_RANGE":case"CHANGE_RANGE":const input=this.inputs[cmd.id];const range=input.ranges.find((range)=>range.id===cmd.rangeId);if(range){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.getRangeFromSheetXC(sheetId,range?.xc||"A1").zone;this.selection.capture(input,{cell:{col:zone.left,row:zone.top},zone},{handleEvent:input.handleEvent.bind(input),release:()=>(this.focusedInputId=null),});}
this.focusedInputId=cmd.id;break;}
this.currentInput?.handle(cmd);}
getSelectionInput(id){if(!this.inputs[id]){return[];}
return this.inputs[id].ranges.map((input,index)=>Object.assign({},input,{color:this.focusedInputId===id&&this.inputs[id].focusedRangeIndex!==null&&this.isRangeValid(input.xc)?input.color:null,isFocused:this.focusedInputId===id&&this.inputs[id].focusedRangeIndex===index,}));}
isRangeValid(reference){if(!reference){return false;}
const{xc,sheetName}=splitReference(reference);return(xc.match(rangeReference)!==null&&(!sheetName||this.getters.getSheetIdByName(sheetName)!==undefined));}
getSelectionInputValue(id){return this.inputs[id].getSelectionInputValue();}
getSelectionInputHighlights(){if(!this.focusedInputId){return[];}
return this.inputs[this.focusedInputId].getSelectionInputHighlights();}
initInput(id,initialRanges,inputHasSingleRange=false){if(this.inputs[id]){this.unfocus();}
this.inputs[id]=new SelectionInputPlugin(this.config,initialRanges,inputHasSingleRange);if(initialRanges.length===0){const input=this.inputs[id];const anchor={zone:positionToZone({col:0,row:0}),cell:{col:0,row:0},};this.selection.capture(input,anchor,{handleEvent:input.handleEvent.bind(input),release:()=>(this.focusedInputId=null),});this.focusedInputId=id;}}
unfocus(){this.selection.release(this.currentInput);this.focusedInputId=null;}}
class SortPlugin extends UIPlugin{static getters=["getContiguousZone"];allowDispatch(cmd){switch(cmd.type){case"SORT_CELLS":if(!isInside(cmd.col,cmd.row,cmd.zone)){throw new Error(_t("The anchor must be part of the provided zone"));}
return this.checkValidations(cmd,this.checkMerge,this.checkMergeSizes);}
return"Success";}
handle(cmd){switch(cmd.type){case"SORT_CELLS":this.sortZone(cmd.sheetId,cmd,cmd.zone,cmd.sortDirection,cmd.sortOptions||{});break;}}
checkMerge({sheetId,zone}){if(!this.getters.doesIntersectMerge(sheetId,zone)){return"Success";}
const singleCells=positions(zone).some(({col,row})=>!this.getters.isInMerge({sheetId,col,row}));if(singleCells){return"InvalidSortZone";}
return"Success";}
checkMergeSizes({sheetId,zone}){if(!this.getters.doesIntersectMerge(sheetId,zone)){return"Success";}
const merges=this.getters.getMerges(sheetId).filter((merge)=>overlap(merge,zone));const mergeDimension=zoneToDimension(merges[0]);let[widthFirst,heightFirst]=[mergeDimension.numberOfCols,mergeDimension.numberOfRows];if(!merges.every((merge)=>{let[widthCurrent,heightCurrent]=[merge.right-merge.left+1,merge.bottom-merge.top+1,];return widthCurrent===widthFirst&&heightCurrent===heightFirst;})){return"InvalidSortZone";}
return"Success";}
expand(sheetId,z){const{left,right,top,bottom}=this.getters.expandZone(sheetId,z);return{left:Math.max(0,left),right:Math.min(this.getters.getNumberCols(sheetId)-1,right),top:Math.max(0,top),bottom:Math.min(this.getters.getNumberRows(sheetId)-1,bottom),};}
checkExpandedValues(sheetId,z){const expandedZone=this.expand(sheetId,z);let cell;if(this.getters.doesIntersectMerge(sheetId,expandedZone)){const{left,right,top,bottom}=expandedZone;for(let c=left;c<=right;c++){for(let r=top;r<=bottom;r++){const{col,row}=this.getters.getMainCellPosition({sheetId,col:c,row:r});cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.formattedValue){return true;}}}}
else{for(let cell of this.getters.getEvaluatedCellsInZone(sheetId,expandedZone)){if(cell.formattedValue){return true;}}}
return false;}
getContiguousZone(sheetId,zone){let{top,bottom,left,right}=zone;let canExpand;let stop=false;while(!stop){stop=true;if(top>0){canExpand=this.checkExpandedValues(sheetId,{left:left-1,right:right+1,top:top-1,bottom:top-1,});if(canExpand){stop=false;top--;}}
if(left>0){canExpand=this.checkExpandedValues(sheetId,{left:left-1,right:left-1,top:top-1,bottom:bottom+1,});if(canExpand){stop=false;left--;}}
if(right<this.getters.getNumberCols(sheetId)-1){canExpand=this.checkExpandedValues(sheetId,{left:right+1,right:right+1,top:top-1,bottom:bottom+1,});if(canExpand){stop=false;right++;}}
if(bottom<this.getters.getNumberRows(sheetId)-1){canExpand=this.checkExpandedValues(sheetId,{left:left-1,right:right+1,top:bottom+1,bottom:bottom+1,});if(canExpand){stop=false;bottom++;}}}
return{left,right,top,bottom};}
hasHeader(sheetId,items){if(items[0].length===1)
return false;let cells=items.map((col)=>col.map(({col,row})=>this.getters.getEvaluatedCell({sheetId,col,row}).type));const topLeft=cells[0][0];if(topLeft===CellValueType.empty){cells=cells.slice(1);}
if(cells.some((item)=>item[0]===CellValueType.empty)){return false;}
else if(cells.some((item)=>item[1]!==CellValueType.empty&&item[0]!==item[1])){return true;}
else{return false;}}
sortZone(sheetId,anchor,zone,sortDirection,options){const[stepX,stepY]=this.mainCellsSteps(sheetId,zone);let sortingCol=this.getters.getMainCellPosition({sheetId,col:anchor.col,row:anchor.row,}).col;let sortZone=Object.assign({},zone);let cellPositions=this.mainCells(sheetId,zone);if(!options.sortHeaders&&this.hasHeader(sheetId,cellPositions)){sortZone.top+=stepY;}
cellPositions=this.mainCells(sheetId,sortZone);const sortingCells=cellPositions[sortingCol-sortZone.left];const sortedIndexOfSortTypeCells=sortCells(sortingCells.map((position)=>this.getters.getEvaluatedCell(position)),sortDirection,Boolean(options.emptyCellAsZero));const sortedIndex=sortedIndexOfSortTypeCells.map((x)=>x.index);const[width,height]=[cellPositions.length,cellPositions[0].length];const updateCellCommands=[];for(let c=0;c<width;c++){for(let r=0;r<height;r++){let{col,row,sheetId}=cellPositions[c][sortedIndex[r]];const cell=this.getters.getCell({sheetId,col,row});let newCol=sortZone.left+c*stepX;let newRow=sortZone.top+r*stepY;let newCellValues={sheetId:sheetId,col:newCol,row:newRow,content:"",};if(cell){let content=cell.content;if(cell.isFormula){const position=this.getters.getCellPosition(cell.id);content=this.getters.getTranslatedCellFormula(sheetId,0,newRow-position.row,cell.compiledFormula);}
newCellValues.style=cell.style;newCellValues.content=content;newCellValues.format=cell.format;}
updateCellCommands.push(newCellValues);}}
updateCellCommands.forEach((cmdPayload)=>this.dispatch("UPDATE_CELL",cmdPayload));}
mainCellsSteps(sheetId,zone){const merge=this.getters.getMerge({sheetId,col:zone.left,row:zone.top});const stepX=merge?merge.right-merge.left+1:1;const stepY=merge?merge.bottom-merge.top+1:1;return[stepX,stepY];}
mainCells(sheetId,zone){const[stepX,stepY]=this.mainCellsSteps(sheetId,zone);const cells=[];const cols=range(zone.left,zone.right+1,stepX);const rows=range(zone.top,zone.bottom+1,stepY);for(const col of cols){const colCells=[];cells.push(colCells);for(const row of rows){colCells.push({sheetId,col,row});}}
return cells;}}
class UIOptionsPlugin extends UIPlugin{static getters=["shouldShowFormulas"];showFormulas=false;handle(cmd){switch(cmd.type){case"SET_FORMULA_VISIBILITY":this.showFormulas=cmd.show;break;}}
shouldShowFormulas(){return this.showFormulas;}}
class SheetUIPlugin extends UIPlugin{static getters=["doesCellHaveGridIcon","getCellWidth","getTextWidth","getCellText","getCellMultiLineText",];ctx=document.createElement("canvas").getContext("2d");allowDispatch(cmd){return this.chainValidations(this.checkSheetExists,this.checkZonesAreInSheet)(cmd);}
handle(cmd){switch(cmd.type){case"AUTORESIZE_COLUMNS":for(let col of cmd.cols){const size=this.getColMaxWidth(cmd.sheetId,col);if(size!==0){this.dispatch("RESIZE_COLUMNS_ROWS",{elements:[col],dimension:"COL",size,sheetId:cmd.sheetId,});}}
break;case"AUTORESIZE_ROWS":for(let row of cmd.rows){this.dispatch("RESIZE_COLUMNS_ROWS",{elements:[row],dimension:"ROW",size:null,sheetId:cmd.sheetId,});}
break;}}
getCellWidth(position){const style=this.getters.getCellComputedStyle(position);let contentWidth=0;const content=this.getters.getEvaluatedCell(position).formattedValue;if(content){const multiLineText=splitTextToWidth(this.ctx,content,style,undefined);contentWidth+=Math.max(...multiLineText.map((line)=>computeTextWidth(this.ctx,line,style)));}
const icon=this.getters.getConditionalIcon(position);if(icon){contentWidth+=computeIconWidth(style);}
if(this.getters.doesCellHaveGridIcon(position)){contentWidth+=ICON_EDGE_LENGTH+GRID_ICON_MARGIN;}
if(contentWidth===0){return 0;}
contentWidth+=2*PADDING_AUTORESIZE_HORIZONTAL;if(style.wrapping==="wrap"){const colWidth=this.getters.getColSize(this.getters.getActiveSheetId(),position.col);return Math.min(colWidth,contentWidth);}
return contentWidth;}
getTextWidth(text,style){return computeTextWidth(this.ctx,text,style);}
getCellText(position,showFormula=false){const cell=this.getters.getCell(position);if(showFormula&&cell?.isFormula){return localizeFormula(cell.content,this.getters.getLocale());}
else{return this.getters.getEvaluatedCell(position).formattedValue;}}
getCellMultiLineText(position,width){const style=this.getters.getCellStyle(position);const text=this.getters.getCellText(position,this.getters.shouldShowFormulas());return splitTextToWidth(this.ctx,text,style,width);}
doesCellHaveGridIcon(position){const isFilterHeader=this.getters.isFilterHeader(position);const hasListIcon=!this.getters.isReadonly()&&this.getters.cellHasListDataValidationIcon(position);return isFilterHeader||hasListIcon;}
getColMaxWidth(sheetId,index){const cellsPositions=positions(this.getters.getColsZone(sheetId,index,index));const sizes=cellsPositions.map((position)=>this.getCellWidth({sheetId,...position}));return Math.max(0,largeMax(sizes));}
checkSheetExists(cmd){if("sheetId"in cmd&&this.getters.tryGetSheet(cmd.sheetId)===undefined){return"InvalidSheetId";}
return"Success";}
checkZonesAreInSheet(cmd){const sheetId="sheetId"in cmd?cmd.sheetId:this.getters.tryGetActiveSheetId();const zones=this.getters.getCommandZones(cmd);if(!sheetId&&zones.length>0){return"NoActiveSheet";}
if(sheetId&&zones.length>0){return this.getters.checkZonesExistInSheet(sheetId,zones);}
return"Success";}}
const genericRepeatsTransforms=[repeatSheetDependantCommand,repeatTargetDependantCommand,repeatPositionDependantCommand,];function repeatSheetDependantCommand(getters,command){if(!("sheetId"in command))
return command;return{...deepCopy(command),sheetId:getters.getActiveSheetId()};}
function repeatTargetDependantCommand(getters,command){if(!("target"in command)||!Array.isArray(command.target))
return command;return{...deepCopy(command),target:getters.getSelectedZones(),};}
function repeatZoneDependantCommand(getters,command){if(!("zone"in command))
return command;return{...deepCopy(command),zone:getters.getSelectedZone(),};}
function repeatPositionDependantCommand(getters,command){if(!("row"in command)||!("col"in command))
return command;const{col,row}=getters.getActivePosition();return{...deepCopy(command),col,row};}
const uuidGenerator=new UuidGenerator();function repeatCreateChartCommand(getters,cmd){return{...repeatSheetDependantCommand(getters,cmd),id:uuidGenerator.uuidv4(),};}
function repeatCreateImageCommand(getters,cmd){return{...repeatSheetDependantCommand(getters,cmd),figureId:uuidGenerator.uuidv4(),};}
function repeatCreateFigureCommand(getters,cmd){const newCmd=repeatSheetDependantCommand(getters,cmd);newCmd.figure.id=uuidGenerator.uuidv4();return newCmd;}
function repeatCreateSheetCommand(getters,cmd){const newCmd=deepCopy(cmd);newCmd.sheetId=uuidGenerator.uuidv4();const sheetName=cmd.name||getters.getSheet(getters.getActiveSheetId()).name;const namePrefix=sheetName.match(/(.+?)\d*$/)?.[1]||sheetName;newCmd.name=getters.getNextSheetName(namePrefix);return newCmd;}
function repeatAddColumnsRowsCommand(getters,cmd){const currentPosition=getters.getActivePosition();return{...repeatSheetDependantCommand(getters,cmd),base:cmd.dimension==="COL"?currentPosition.col:currentPosition.row,};}
function repeatHeaderElementCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...repeatSheetDependantCommand(getters,cmd),elements:cmd.dimension==="COL"?range(currentSelection.left,currentSelection.right+1):range(currentSelection.top,currentSelection.bottom+1),};}
function repeatInsertOrDeleteCellCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...deepCopy(cmd),zone:currentSelection,};}
function repeatAutoResizeCommand(getters,cmd){const newCmd=deepCopy(cmd);const currentSelection=getters.getSelectedZone();const{top,bottom,left,right}=currentSelection;if("cols"in newCmd){newCmd.cols=range(left,right+1);}
else if("rows"in newCmd){newCmd.rows=range(top,bottom+1);}
return newCmd;}
function repeatSortCellsCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...repeatSheetDependantCommand(getters,cmd),col:currentSelection.left,row:currentSelection.top,zone:currentSelection,};}
function repeatPasteCommand(getters,cmd){return{type:"REPEAT_PASTE",pasteOption:deepCopy(cmd.pasteOption),target:getters.getSelectedZones(),};}
function repeatGroupHeadersCommand(getters,cmd){const currentSelection=getters.getSelectedZone();return{...repeatSheetDependantCommand(getters,cmd),start:cmd.dimension==="COL"?currentSelection.left:currentSelection.top,end:cmd.dimension==="COL"?currentSelection.right:currentSelection.bottom,};}
const repeatCommandTransformRegistry=new Registry();repeatCommandTransformRegistry.add("UPDATE_CELL",genericRepeat);repeatCommandTransformRegistry.add("CLEAR_CELL",genericRepeat);repeatCommandTransformRegistry.add("DELETE_CONTENT",genericRepeat);repeatCommandTransformRegistry.add("ADD_MERGE",genericRepeat);repeatCommandTransformRegistry.add("REMOVE_MERGE",genericRepeat);repeatCommandTransformRegistry.add("SET_FORMATTING",genericRepeat);repeatCommandTransformRegistry.add("CLEAR_FORMATTING",genericRepeat);repeatCommandTransformRegistry.add("SET_BORDER",genericRepeat);repeatCommandTransformRegistry.add("CREATE_FILTER_TABLE",genericRepeat);repeatCommandTransformRegistry.add("REMOVE_FILTER_TABLE",genericRepeat);repeatCommandTransformRegistry.add("HIDE_SHEET",genericRepeat);repeatCommandTransformRegistry.add("ADD_COLUMNS_ROWS",repeatAddColumnsRowsCommand);repeatCommandTransformRegistry.add("REMOVE_COLUMNS_ROWS",repeatHeaderElementCommand);repeatCommandTransformRegistry.add("HIDE_COLUMNS_ROWS",repeatHeaderElementCommand);repeatCommandTransformRegistry.add("RESIZE_COLUMNS_ROWS",repeatHeaderElementCommand);repeatCommandTransformRegistry.add("CREATE_SHEET",repeatCreateSheetCommand);repeatCommandTransformRegistry.add("CREATE_FIGURE",repeatCreateFigureCommand);repeatCommandTransformRegistry.add("CREATE_CHART",repeatCreateChartCommand);repeatCommandTransformRegistry.add("CREATE_IMAGE",repeatCreateImageCommand);repeatCommandTransformRegistry.add("GROUP_HEADERS",repeatGroupHeadersCommand);repeatCommandTransformRegistry.add("UNGROUP_HEADERS",repeatGroupHeadersCommand);repeatCommandTransformRegistry.add("UNGROUP_HEADERS",repeatGroupHeadersCommand);repeatCommandTransformRegistry.add("UNFOLD_HEADER_GROUPS_IN_ZONE",repeatZoneDependantCommand);repeatCommandTransformRegistry.add("FOLD_HEADER_GROUPS_IN_ZONE",repeatZoneDependantCommand);const repeatLocalCommandTransformRegistry=new Registry();repeatLocalCommandTransformRegistry.add("STOP_EDITION",repeatLocalCommandChildren);repeatLocalCommandTransformRegistry.add("PASTE",repeatPasteCommand);repeatLocalCommandTransformRegistry.add("INSERT_CELL",repeatInsertOrDeleteCellCommand);repeatLocalCommandTransformRegistry.add("DELETE_CELL",repeatInsertOrDeleteCellCommand);repeatLocalCommandTransformRegistry.add("AUTORESIZE_COLUMNS",repeatAutoResizeCommand);repeatLocalCommandTransformRegistry.add("AUTORESIZE_ROWS",repeatAutoResizeCommand);repeatLocalCommandTransformRegistry.add("SORT_CELLS",repeatSortCellsCommand);repeatLocalCommandTransformRegistry.add("SUM_SELECTION",genericRepeat);repeatLocalCommandTransformRegistry.add("SET_DECIMAL",genericRepeat);function genericRepeat(getters,command){let transformedCommand=deepCopy(command);for(const repeatTransform of genericRepeatsTransforms){transformedCommand=repeatTransform(getters,transformedCommand);}
return transformedCommand;}
function repeatCoreCommand(getters,command){if(!command){return undefined;}
const isRepeatable=repeatCommandTransformRegistry.contains(command.type);if(!isRepeatable){return undefined;}
const transform=repeatCommandTransformRegistry.get(command.type);return transform(getters,command);}
function repeatLocalCommand(getters,command,childCommands){const isRepeatable=repeatLocalCommandTransformRegistry.contains(command.type);if(!isRepeatable){return undefined;}
const repeatTransform=repeatLocalCommandTransformRegistry.get(command.type);return repeatTransform(getters,command,childCommands);}
function repeatLocalCommandChildren(getters,cmd,childCommands){return childCommands.map((childCommand)=>repeatCoreCommand(getters,childCommand)).filter(isDefined$1);}
function canRepeatRevision(revision){if(!revision||!revision.rootCommand||typeof revision.rootCommand!=="object"){return false;}
if(isCoreCommand(revision.rootCommand)){return repeatCommandTransformRegistry.contains(revision.rootCommand.type);}
return repeatLocalCommandTransformRegistry.contains(revision.rootCommand.type);}
function repeatRevision(revision,getters){if(!revision.rootCommand||typeof revision.rootCommand!=="object"){return undefined;}
if(isCoreCommand(revision.rootCommand)){return repeatCoreCommand(getters,revision.rootCommand);}
return repeatLocalCommand(getters,revision.rootCommand,revision.commands);}
class HistoryPlugin extends UIPlugin{static getters=["canUndo","canRedo"];undoStack=[];redoStack=[];session;constructor(config){super(config);this.session=config.session;this.session.on("new-local-state-update",this,this.onNewLocalStateUpdate);this.session.on("pending-revisions-dropped",this,({revisionIds})=>this.drop(revisionIds));this.session.on("snapshot",this,()=>{this.undoStack=[];this.redoStack=[];});}
allowDispatch(cmd){switch(cmd.type){case"REQUEST_UNDO":if(!this.canUndo()){return"EmptyUndoStack";}
break;case"REQUEST_REDO":if(!this.canRedo()){return"EmptyRedoStack";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"REQUEST_UNDO":case"REQUEST_REDO":this.requestHistoryChange(cmd.type==="REQUEST_UNDO"?"UNDO":"REDO");}}
finalize(){}
requestHistoryChange(type){const id=type==="UNDO"?this.undoStack.pop():this.redoStack.pop();if(!id){const lastNonRedoRevision=this.getPossibleRevisionToRepeat();if(!lastNonRedoRevision){return;}
const repeatedCommands=repeatRevision(lastNonRedoRevision,this.getters);if(!repeatedCommands){return;}
if(!Array.isArray(repeatedCommands)){this.dispatch(repeatedCommands.type,repeatedCommands);return;}
for(const command of repeatedCommands){this.dispatch(command.type,command);}
return;}
if(type==="UNDO"){this.session.undo(id);this.redoStack.push(id);}
else{this.session.redo(id);this.undoStack.push(id);}}
canUndo(){return this.undoStack.length>0;}
canRedo(){if(this.redoStack.length>0)
return true;const lastNonRedoRevision=this.getPossibleRevisionToRepeat();return canRepeatRevision(lastNonRedoRevision);}
drop(revisionIds){this.undoStack=this.undoStack.filter((id)=>!revisionIds.includes(id));this.redoStack=[];}
onNewLocalStateUpdate({id}){this.undoStack.push(id);this.redoStack=[];if(this.undoStack.length>MAX_HISTORY_STEPS){this.undoStack.shift();}}
getPossibleRevisionToRepeat(){return this.session.getLastLocalNonEmptyRevision();}}
class SplitToColumnsPlugin extends UIPlugin{static getters=["getAutomaticSeparator"];allowDispatch(cmd){switch(cmd.type){case"SPLIT_TEXT_INTO_COLUMNS":return this.chainValidations(this.batchValidations(this.checkSingleColSelected,this.checkNonEmptySelector),this.batchValidations(this.checkNotOverwritingContent,this.checkSeparatorInSelection))(cmd);}
return"Success";}
handle(cmd){switch(cmd.type){case"SPLIT_TEXT_INTO_COLUMNS":this.splitIntoColumns(cmd);break;}}
getAutomaticSeparator(){const cells=this.getters.getSelectedCells();for(const cell of cells){if(cell.value&&cell.type===CellValueType.text){const separator=this.getAutoSeparatorForString(cell.value);if(separator){return separator;}}}
return" ";}
getAutoSeparatorForString(str){const separators=[NEWLINE,";",","," ","."];for(const separator of separators){if(str.includes(separator)){return separator;}}
return;}
splitIntoColumns({separator,addNewColumns}){const selection=this.getters.getSelectedZone();const sheetId=this.getters.getActiveSheetId();const splitted=this.getSplittedCols(selection,separator);if(addNewColumns){this.addColsToAvoidCollisions(selection,splitted);}
this.removeMergesInSplitZone(selection,splitted);this.addColumnsToNotOverflowSheet(selection,splitted);for(let i=0;i<splitted.length;i++){const row=selection.top+i;const splittedContent=splitted[i];const col=selection.left;const mainCell=this.getters.getCell({sheetId,col,row});if(splittedContent.length===1&&splittedContent[0]===mainCell?.content){continue;}
for(const[index,content]of splittedContent.entries()){this.dispatch("UPDATE_CELL",{sheetId,col:col+index,row,content:canonicalizeNumberContent(content,this.getters.getLocale()),format:"",style:mainCell?.style||null,});}}}
getSplittedCols(selection,separator){if(!separator){throw new Error("Separator cannot be empty");}
const sheetId=this.getters.getActiveSheetId();const splitted=[];for(const row of range(selection.top,selection.bottom+1)){const text=this.getters.getEvaluatedCell({sheetId,col:selection.left,row,}).formattedValue;splitted.push(this.splitAndRemoveTrailingEmpty(text,separator));}
return splitted;}
splitAndRemoveTrailingEmpty(string,separator){const splitted=string.split(separator);while(splitted.length>1&&splitted[splitted.length-1]===""){splitted.pop();}
return splitted;}
willSplittedColsOverwriteContent(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();for(const row of range(selection.top,selection.bottom+1)){const splittedText=splittedCols[row-selection.top];for(let i=1;i<splittedText.length;i++){const cell=this.getters.getCell({sheetId,col:selection.left+i,row});if(cell&&cell.content){return true;}}}
return false;}
removeMergesInSplitZone(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();const colsInSplitZone=Math.max(...splittedCols.map((s)=>s.length));const splitZone={...selection,right:selection.left+colsInSplitZone-1};const merges=this.getters.getMergesInZone(sheetId,splitZone);this.dispatch("REMOVE_MERGE",{sheetId,target:merges});}
addColsToAvoidCollisions(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();let colsToAdd=0;for(const row of range(selection.top,selection.bottom+1)){const cellPosition={sheetId,col:selection.left,row};const splittedText=splittedCols[row-selection.top];const colsToAddInRow=this.getColsToAddToAvoidCollision(cellPosition,splittedText);colsToAdd=Math.max(colsToAdd,colsToAddInRow);}
if(colsToAdd){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:selection.left,sheetId,quantity:colsToAdd,position:"after",});}}
getColsToAddToAvoidCollision(cellPosition,splittedText){const maxColumnsToSpread=splittedText.length;for(let i=1;i<maxColumnsToSpread;i++){const col=cellPosition.col+i;const cell=this.getters.getCell({...cellPosition,col});if(cell&&cell.content){return maxColumnsToSpread-i;}}
return 0;}
addColumnsToNotOverflowSheet(selection,splittedCols){const sheetId=this.getters.getActiveSheetId();const maxColumnsToSpread=Math.max(...splittedCols.map((s)=>s.length-1));const maxColIndex=this.getters.getNumberCols(sheetId)-1;if(selection.left+maxColumnsToSpread>maxColIndex){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:maxColIndex,sheetId,quantity:selection.left+maxColumnsToSpread-maxColIndex,position:"after",});}}
checkSingleColSelected(){if(!this.getters.isSingleColSelected()){return"MoreThanOneColumnSelected";}
return"Success";}
checkNonEmptySelector(cmd){if(cmd.separator===""){return"EmptySplitSeparator";}
return"Success";}
checkNotOverwritingContent(cmd){if(cmd.addNewColumns||cmd.force){return"Success";}
const selection=this.getters.getSelectedZones()[0];const splitted=this.getSplittedCols(selection,cmd.separator);if(this.willSplittedColsOverwriteContent(selection,splitted)){return"SplitWillOverwriteContent";}
return"Success";}
checkSeparatorInSelection({separator}){const cells=this.getters.getSelectedCells();for(const cell of cells){if(cell.formattedValue.includes(separator)){return"Success";}}
return"NoSplitSeparatorInSelection";}}
class ClipboardFigureState{operation;getters;dispatch;sheetId;copiedFigure;copiedFigureContent;constructor(operation,getters,dispatch){this.operation=operation;this.getters=getters;this.dispatch=dispatch;this.sheetId=getters.getActiveSheetId();const copiedFigureId=getters.getSelectedFigureId();if(!copiedFigureId){throw new Error(`No figure selected`);}
const figure=getters.getFigure(this.sheetId,copiedFigureId);if(!figure){throw new Error(`No figure for the given id: ${copiedFigureId}`);}
this.copiedFigure={...figure};switch(figure.tag){case"chart":this.copiedFigureContent=new ClipboardFigureChart(dispatch,getters,this.sheetId,copiedFigureId);break;case"image":this.copiedFigureContent=new ClipboardFigureImage(dispatch,getters,this.sheetId,copiedFigureId);break;default:throw new Error(`Unknow tag '${figure.tag}' for the given figure id: ${copiedFigureId}`);}}
isCutAllowed(target){return"Success";}
isPasteAllowed(target,option){if(target.length===0){return"EmptyTarget";}
if(option?.pasteOption!==undefined){return"WrongFigurePasteOption";}
return"Success";}
paste(target){const sheetId=this.getters.getActiveSheetId();const{width,height}=this.copiedFigure;const numCols=this.getters.getNumberCols(sheetId);const numRows=this.getters.getNumberRows(sheetId);const targetX=this.getters.getColDimensions(sheetId,target[0].left).start;const targetY=this.getters.getRowDimensions(sheetId,target[0].top).start;const maxX=this.getters.getColDimensions(sheetId,numCols-1).end;const maxY=this.getters.getRowDimensions(sheetId,numRows-1).end;const position={x:maxX<width?0:Math.min(targetX,maxX-width),y:maxY<height?0:Math.min(targetY,maxY-height),};const newId=new UuidGenerator().uuidv4();this.copiedFigureContent.paste(sheetId,newId,position,{height,width});if(this.operation==="CUT"){this.dispatch("DELETE_FIGURE",{sheetId:this.copiedFigureContent.sheetId,id:this.copiedFigure.id,});}
this.dispatch("SELECT_FIGURE",{id:newId});}
getClipboardContent(){return{[ClipboardMIMEType.PlainText]:"\t"};}
isColRowDirtyingClipboard(position,dimension){return false;}
drawClipboard(renderingContext){}}
class ClipboardFigureChart{dispatch;sheetId;copiedChart;constructor(dispatch,getters,sheetId,copiedFigureId){this.dispatch=dispatch;this.sheetId=sheetId;const chart=getters.getChart(copiedFigureId);if(!chart){throw new Error(`No chart for the given id: ${copiedFigureId}`);}
this.copiedChart=chart.copyInSheetId(sheetId);}
paste(sheetId,figureId,position,size){const copy=this.copiedChart.copyInSheetId(sheetId);this.dispatch("CREATE_CHART",{id:figureId,sheetId,position,size,definition:copy.getDefinition(),});}}
class ClipboardFigureImage{dispatch;sheetId;copiedImage;constructor(dispatch,getters,sheetId,copiedFigureId){this.dispatch=dispatch;this.sheetId=sheetId;const image=getters.getImage(copiedFigureId);this.copiedImage=deepCopy(image);}
paste(sheetId,figureId,position,size){const copy=deepCopy(this.copiedImage);this.dispatch("CREATE_IMAGE",{figureId,sheetId,position,size,definition:copy,});}}
function canonicalizeNumberValue(content,locale){return content.startsWith("=")?canonicalizeFormula(content,locale):canonicalizeNumberLiteral(content,locale);}
function canonicalizeFormula(formula,locale){return _localizeFormula(formula,locale,DEFAULT_LOCALE);}
function _localizeFormula(formula,fromLocale,toLocale){if(fromLocale.formulaArgSeparator===toLocale.formulaArgSeparator&&fromLocale.decimalSeparator===toLocale.decimalSeparator){return formula;}
const tokens=tokenize(formula,fromLocale);let localizedFormula="";for(const token of tokens){if(token.type==="NUMBER"){localizedFormula+=token.value.replace(fromLocale.decimalSeparator,toLocale.decimalSeparator);}
else if(token.type==="ARG_SEPARATOR"){localizedFormula+=toLocale.formulaArgSeparator;}
else{localizedFormula+=token.value;}}
return localizedFormula;}
class ClipboardOsState extends ClipboardCellsAbstractState{values;constructor(content,getters,dispatch,selection){super("COPY",getters,dispatch,selection);this.values=content.replace(/\r/g,"").split("\n").map((vals)=>vals.split("\t"));}
isPasteAllowed(target,clipboardOption){const sheetId=this.getters.getActiveSheetId();const pasteZone=this.getPasteZone(target);if(this.getters.doesIntersectMerge(sheetId,pasteZone)){return"WillRemoveExistingMerge";}
return"Success";}
paste(target,clipboardOption){if(clipboardOption?.pasteOption==="onlyFormat"){return;}
const values=this.values;const pasteZone=this.getPasteZone(target);const{left:activeCol,top:activeRow}=pasteZone;const{numberOfCols,numberOfRows}=zoneToDimension(pasteZone);const sheetId=this.getters.getActiveSheetId();const locale=this.getters.getLocale();this.addMissingDimensions(numberOfCols,numberOfRows,activeCol,activeRow);for(let i=0;i<values.length;i++){for(let j=0;j<values[i].length;j++){this.dispatch("UPDATE_CELL",{row:activeRow+i,col:activeCol+j,content:canonicalizeNumberValue(values[i][j],locale),sheetId,});}}
const zone={left:activeCol,top:activeRow,right:activeCol+numberOfCols-1,bottom:activeRow+numberOfRows-1,};this.selection.selectZone({cell:{col:activeCol,row:activeRow},zone},{scrollIntoView:false});}
getClipboardContent(){return{[ClipboardMIMEType.PlainText]:this.values.map((values)=>values.join("\t")).join("\n"),};}
getPasteZone(target){const height=this.values.length;const width=largeMax(this.values.map((a)=>a.length));const{left:activeCol,top:activeRow}=target[0];return{top:activeRow,left:activeCol,bottom:activeRow+height-1,right:activeCol+width-1,};}}
class ClipboardPlugin extends UIPlugin{static layers=[2];static getters=["getClipboardContent","getClipboardTextContent","isCutOperation","isPaintingFormat",];status="invisible";state;lastPasteState;paintFormatStatus="inactive";originSheetId;allowDispatch(cmd){switch(cmd.type){case"CUT":const zones=this.getters.getSelectedZones();const state=this.getClipboardState(zones,cmd.type);return state.isCutAllowed(zones);case"PASTE":if(!this.state){return"EmptyClipboard";}
const pasteOption=cmd.pasteOption||(this.paintFormatStatus!=="inactive"?"onlyFormat":undefined);return this.state.isPasteAllowed(cmd.target,{pasteOption});case"PASTE_FROM_OS_CLIPBOARD":{const state=new ClipboardOsState(cmd.text,this.getters,this.dispatch,this.selection);return state.isPasteAllowed(cmd.target,{pasteOption:cmd.pasteOption});}
case"COPY_PASTE_CELLS_ABOVE":{const zones=this.getters.getSelectedZones();if(zones.length>1||(zones[0].top===0&&zones[0].bottom===0)){return"InvalidCopyPasteSelection";}
break;}
case"COPY_PASTE_CELLS_ON_LEFT":{const zones=this.getters.getSelectedZones();if(zones.length>1||(zones[0].left===0&&zones[0].right===0)){return"InvalidCopyPasteSelection";}
break;}
case"INSERT_CELL":{const{cut,paste}=this.getInsertCellsTargets(cmd.zone,cmd.shiftDimension);const state=this.getClipboardStateForCopyCells(cut,"CUT");return state.isPasteAllowed(paste);}
case"DELETE_CELL":{const{cut,paste}=this.getDeleteCellsTargets(cmd.zone,cmd.shiftDimension);const state=this.getClipboardStateForCopyCells(cut,"CUT");return state.isPasteAllowed(paste);}
case"ACTIVATE_PAINT_FORMAT":{if(this.paintFormatStatus!=="inactive"){return"AlreadyInPaintingFormatMode";}}}
return"Success";}
handle(cmd){switch(cmd.type){case"COPY":case"CUT":const zones=this.getters.getSelectedZones();this.state=this.getClipboardState(zones,cmd.type);this.status="visible";this.originSheetId=this.getters.getActiveSheetId();break;case"PASTE":if(!this.state){break;}
const pasteOption=cmd.pasteOption||(this.paintFormatStatus!=="inactive"?"onlyFormat":undefined);this.state.paste(cmd.target,{pasteOption,shouldPasteCF:true,selectTarget:true});if(this.state.operation==="CUT"){this.state=undefined;}
this.lastPasteState=this.state;if(this.paintFormatStatus==="oneOff"){this.paintFormatStatus="inactive";}
this.status="invisible";break;case"COPY_PASTE_CELLS_ABOVE":{const zone=this.getters.getSelectedZone();const multipleRowsInSelection=zone.top!==zone.bottom;const copyTarget={...zone,bottom:multipleRowsInSelection?zone.top:zone.top-1,top:multipleRowsInSelection?zone.top:zone.top-1,};const state=this.getClipboardStateForCopyCells([copyTarget],"COPY");state.paste([zone],{pasteOption:undefined,shouldPasteCF:true,selectTarget:true,});}
break;case"COPY_PASTE_CELLS_ON_LEFT":{const zone=this.getters.getSelectedZone();const multipleColsInSelection=zone.left!==zone.right;const copyTarget={...zone,right:multipleColsInSelection?zone.left:zone.left-1,left:multipleColsInSelection?zone.left:zone.left-1,};const state=this.getClipboardStateForCopyCells([copyTarget],"COPY");state.paste([zone],{pasteOption:undefined,shouldPasteCF:true,selectTarget:true,});}
break;case"CLEAN_CLIPBOARD_HIGHLIGHT":this.status="invisible";break;case"DELETE_CELL":{const{cut,paste}=this.getDeleteCellsTargets(cmd.zone,cmd.shiftDimension);if(!isZoneValid(cut[0])){for(const{col,row}of positions(cmd.zone)){this.dispatch("CLEAR_CELL",{col,row,sheetId:this.getters.getActiveSheetId()});}
break;}
const state=this.getClipboardStateForCopyCells(cut,"CUT");state.paste(paste);break;}
case"INSERT_CELL":{const{cut,paste}=this.getInsertCellsTargets(cmd.zone,cmd.shiftDimension);const state=this.getClipboardStateForCopyCells(cut,"CUT");state.paste(paste);break;}
case"ADD_COLUMNS_ROWS":{this.status="invisible";if(this.state?.operation!=="CUT"||cmd.sheetId!==this.state?.sheetId){return;}
const isClipboardDirty=this.state.isColRowDirtyingClipboard(cmd.position==="before"?cmd.base:cmd.base+1,cmd.dimension);if(isClipboardDirty){this.state=undefined;}
break;}
case"REMOVE_COLUMNS_ROWS":{this.status="invisible";if(this.state?.operation!=="CUT"||cmd.sheetId!==this.state?.sheetId){return;}
for(let el of cmd.elements){const isClipboardDirty=this.state.isColRowDirtyingClipboard(el,cmd.dimension);if(isClipboardDirty){this.state=undefined;break;}}
this.status="invisible";break;}
case"PASTE_FROM_OS_CLIPBOARD":this.state=new ClipboardOsState(cmd.text,this.getters,this.dispatch,this.selection);this.state.paste(cmd.target,{pasteOption:cmd.pasteOption});this.lastPasteState=this.state;this.status="invisible";break;case"REPEAT_PASTE":{this.lastPasteState?.paste(cmd.target,{pasteOption:cmd.pasteOption,shouldPasteCF:true,selectTarget:true,});break;}
case"ACTIVATE_PAINT_FORMAT":{const zones=this.getters.getSelectedZones();this.state=this.getClipboardStateForCopyCells(zones,"COPY");this.status="visible";if(cmd.persistent){this.paintFormatStatus="persistent";}
else{this.paintFormatStatus="oneOff";}
break;}
case"DELETE_SHEET":if(this.state?.operation!=="CUT"){return;}
if(this.originSheetId===cmd.sheetId){this.state=undefined;this.status="invisible";}
break;case"CANCEL_PAINT_FORMAT":{this.paintFormatStatus="inactive";this.status="invisible";break;}
default:if(isCoreCommand(cmd)){this.status="invisible";}}}
getClipboardContent(){return this.state?.getClipboardContent()||{[ClipboardMIMEType.PlainText]:"\t"};}
getClipboardTextContent(){return this.state?.getClipboardContent()[ClipboardMIMEType.PlainText]||"\t";}
isCutOperation(){return this.state?this.state.operation==="CUT":false;}
isPaintingFormat(){return this.paintFormatStatus!=="inactive";}
getDeleteCellsTargets(zone,dimension){const sheetId=this.getters.getActiveSheetId();let cut;if(dimension==="COL"){cut={...zone,left:zone.right+1,right:this.getters.getNumberCols(sheetId)-1,};}
else{cut={...zone,top:zone.bottom+1,bottom:this.getters.getNumberRows(sheetId)-1,};}
return{cut:[cut],paste:[zone]};}
getInsertCellsTargets(zone,dimension){const sheetId=this.getters.getActiveSheetId();let cut;let paste;if(dimension==="COL"){cut={...zone,right:this.getters.getNumberCols(sheetId)-1,};paste={...zone,left:zone.right+1,right:zone.right+1,};}
else{cut={...zone,bottom:this.getters.getNumberRows(sheetId)-1,};paste={...zone,top:zone.bottom+1,bottom:this.getters.getNumberRows(sheetId)-1};}
return{cut:[cut],paste:[paste]};}
getClipboardStateForCopyCells(zones,operation){return new ClipboardCellsState(zones,operation,this.getters,this.dispatch,this.selection);}
getClipboardState(zones,operation){const selectedFigureId=this.getters.getSelectedFigureId();if(selectedFigureId){return new ClipboardFigureState(operation,this.getters,this.dispatch);}
return new ClipboardCellsState(zones,operation,this.getters,this.dispatch,this.selection);}
drawGrid(renderingContext){if(this.status!=="visible"||!this.state){return;}
this.state.drawClipboard(renderingContext);}}
function loopThroughReferenceType(token){if(token.type!=="REFERENCE")
return token;const{xc,sheetName}=splitReference(token.value);const[left,right]=xc.split(":");const sheetRef=sheetName?`${getCanonicalSheetName(sheetName)}!`:"";const updatedLeft=getTokenNextReferenceType(left);const updatedRight=right?`:${getTokenNextReferenceType(right)}`:"";return{...token,value:sheetRef+updatedLeft+updatedRight};}
function getTokenNextReferenceType(xc){switch(getReferenceType(xc)){case"none":xc=setXcToReferenceType(xc,"colrow");break;case"colrow":xc=setXcToReferenceType(xc,"row");break;case"row":xc=setXcToReferenceType(xc,"col");break;case"col":xc=setXcToReferenceType(xc,"none");break;}
return xc;}
function setXcToReferenceType(xc,referenceType){xc=xc.replace(/\$/g,"");let indexOfNumber;switch(referenceType){case"col":return"$"+xc;case"row":indexOfNumber=xc.search(/[0-9]/);return xc.slice(0,indexOfNumber)+"$"+xc.slice(indexOfNumber);case"colrow":indexOfNumber=xc.search(/[0-9]/);if(indexOfNumber===-1||indexOfNumber===0){return"$"+xc;}
xc=xc.slice(0,indexOfNumber)+"$"+xc.slice(indexOfNumber);return"$"+xc;case"none":return xc;}}
function getReferenceType(xcCell){if(isColAndRowFixed(xcCell)){return"colrow";}
else if(isColFixed(xcCell)){return"col";}
else if(isRowFixed(xcCell)){return"row";}
return"none";}
function isColFixed(xc){return xc.startsWith("$");}
function isRowFixed(xc){return xc.includes("$",1);}
function isColAndRowFixed(xc){return xc.startsWith("$")&&xc.length>1&&xc.slice(1).includes("$");}
const CELL_DELETED_MESSAGE=_t("The cell you are trying to edit has been deleted.");class EditionPlugin extends UIPlugin{static getters=["getEditionMode","isSelectingForComposer","showSelectionIndicator","getCurrentContent","getComposerSelection","getCurrentTokens","getTokenAtCursor","getComposerHighlights","getCurrentEditedCell","getCycledReference","getAutoCompleteDataValidationValues",];col=0;row=0;mode="inactive";sheetId="";currentContent="";currentTokens=[];selectionStart=0;selectionEnd=0;initialContent="";colorIndexByRange={};allowDispatch(cmd){switch(cmd.type){case"CHANGE_COMPOSER_CURSOR_SELECTION":return this.validateSelection(this.currentContent.length,cmd.start,cmd.end);case"SET_CURRENT_CONTENT":if(cmd.selection){return this.validateSelection(cmd.content.length,cmd.selection.start,cmd.selection.end);}
break;case"START_EDITION":if(cmd.selection){const content=cmd.text||this.getComposerContent(this.getters.getActivePosition());return this.validateSelection(content.length,cmd.selection.start,cmd.selection.end);}
break;case"STOP_EDITION":if(this.mode==="inactive"){return"Success";}
return this.checkDataValidation(cmd);}
return"Success";}
handleEvent(event){const sheetId=this.getters.getActiveSheetId();let unboundedZone;if(event.options.unbounded){unboundedZone=this.getters.getUnboundedZone(sheetId,event.anchor.zone);}
else{unboundedZone=event.anchor.zone;}
switch(event.mode){case"newAnchor":if(this.mode==="selecting"){this.insertSelectedRange(unboundedZone);}
break;default:if(this.mode==="selecting"){this.replaceSelectedRange(unboundedZone);}
else{this.updateComposerRange(event.previousAnchor.zone,unboundedZone);}
break;}}
handle(cmd){switch(cmd.type){case"CHANGE_COMPOSER_CURSOR_SELECTION":this.selectionStart=cmd.start;this.selectionEnd=cmd.end;break;case"STOP_COMPOSER_RANGE_SELECTION":if(this.isSelectingForComposer()){this.mode="editing";}
break;case"START_EDITION":if(this.mode!=="inactive"&&cmd.text){this.setContent(cmd.text,cmd.selection);}
else{this.startEdition(cmd.text,cmd.selection);}
this.updateRangeColor();break;case"STOP_EDITION":this.stopEdition();this.colorIndexByRange={};break;case"CANCEL_EDITION":this.cancelEditionAndActivateSheet();this.resetContent();this.colorIndexByRange={};break;case"SET_CURRENT_CONTENT":this.setContent(cmd.content,cmd.selection,true);this.updateRangeColor();break;case"REPLACE_COMPOSER_CURSOR_SELECTION":this.replaceSelection(cmd.text);break;case"SELECT_FIGURE":this.cancelEditionAndActivateSheet();this.resetContent();break;case"ADD_COLUMNS_ROWS":this.onAddElements(cmd);break;case"REMOVE_COLUMNS_ROWS":if(cmd.dimension==="COL"){this.onColumnsRemoved(cmd);}
else{this.onRowsRemoved(cmd);}
break;case"START_CHANGE_HIGHLIGHT":const{left,top}=cmd.zone;if(this.isSelectingForComposer()){this.mode="editing";}
this.selection.resetAnchor(this,{cell:{col:left,row:top},zone:cmd.zone});break;case"ACTIVATE_SHEET":if(!this.currentContent.startsWith("=")){this.cancelEdition();this.resetContent();}
if(cmd.sheetIdFrom!==cmd.sheetIdTo){const activePosition=this.getters.getActivePosition();const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:cmd.sheetIdTo,col:activePosition.col,row:activePosition.row,});const zone=this.getters.expandZone(cmd.sheetIdTo,positionToZone({col,row}));this.selection.resetAnchor(this,{cell:{col,row},zone});}
break;case"DELETE_SHEET":case"UNDO":case"REDO":const sheetIdExists=!!this.getters.tryGetSheet(this.sheetId);if(!sheetIdExists&&this.mode!=="inactive"){this.sheetId=this.getters.getActiveSheetId();this.cancelEditionAndActivateSheet();this.resetContent();this.ui.raiseBlockingErrorUI(CELL_DELETED_MESSAGE);}
break;case"CYCLE_EDITION_REFERENCES":this.cycleReferences();break;}}
getEditionMode(){return this.mode;}
getCurrentContent(){if(this.mode==="inactive"){return this.getComposerContent(this.getters.getActivePosition());}
return this.currentContent;}
getComposerSelection(){return{start:this.selectionStart,end:this.selectionEnd,};}
getCurrentEditedCell(){return{sheetId:this.sheetId,col:this.col,row:this.row,};}
isSelectingForComposer(){return this.mode==="selecting";}
showSelectionIndicator(){return this.isSelectingForComposer()&&this.canStartComposerRangeSelection();}
getCurrentTokens(){return this.currentTokens;}
getTokenAtCursor(){const start=Math.min(this.selectionStart,this.selectionEnd);const end=Math.max(this.selectionStart,this.selectionEnd);if(start===end&&end===0){return undefined;}
else{return this.currentTokens.find((t)=>t.start<=start&&t.end>=end);}}
getCycledReference(selection,content){const locale=this.getters.getLocale();const currentTokens=content.startsWith("=")?composerTokenize(content,locale):[];const tokens=currentTokens.filter((t)=>(t.start<=selection.start&&t.end>=selection.start)||(t.start>=selection.start&&t.start<selection.end));const refTokens=tokens.filter((token)=>token.type==="REFERENCE");if(refTokens.length===0){return;}
const updatedReferences=tokens.map(loopThroughReferenceType).map((token)=>token.value).join("");const start=tokens[0].start;const end=tokens[tokens.length-1].end;const newContent=content.slice(0,start)+updatedReferences+content.slice(end);const lengthDiff=newContent.length-content.length;const startOfTokens=refTokens[0].start;const endOfTokens=refTokens[refTokens.length-1].end+lengthDiff;const newSelection={start:startOfTokens,end:endOfTokens};if(refTokens.length===1&&selection.start===selection.end){newSelection.start=newSelection.end;}
return{content:newContent,selection:newSelection};}
getInitialComposerContent(){return this.initialContent;}
cycleReferences(){const updated=this.getCycledReference(this.getComposerSelection(),this.currentContent);if(updated===undefined){return;}
this.dispatch("SET_CURRENT_CONTENT",{content:updated.content,selection:updated.selection,});}
validateSelection(length,start,end){return start>=0&&start<=length&&end>=0&&end<=length?"Success":"WrongComposerSelection";}
onColumnsRemoved(cmd){if(cmd.elements.includes(this.col)&&this.mode!=="inactive"){this.dispatch("CANCEL_EDITION");this.ui.raiseBlockingErrorUI(CELL_DELETED_MESSAGE);return;}
const{top,left}=updateSelectionOnDeletion({left:this.col,right:this.col,top:this.row,bottom:this.row},"left",[...cmd.elements]);this.col=left;this.row=top;}
onRowsRemoved(cmd){if(cmd.elements.includes(this.row)&&this.mode!=="inactive"){this.dispatch("CANCEL_EDITION");this.ui.raiseBlockingErrorUI(CELL_DELETED_MESSAGE);return;}
const{top,left}=updateSelectionOnDeletion({left:this.col,right:this.col,top:this.row,bottom:this.row},"top",[...cmd.elements]);this.col=left;this.row=top;}
onAddElements(cmd){const{top,left}=updateSelectionOnInsertion({left:this.col,right:this.col,top:this.row,bottom:this.row},cmd.dimension==="COL"?"left":"top",cmd.base,cmd.position,cmd.quantity);this.col=left;this.row=top;}
startComposerRangeSelection(){if(this.sheetId===this.getters.getActiveSheetId()){const zone=positionToZone({col:this.col,row:this.row});this.selection.resetAnchor(this,{cell:{col:this.col,row:this.row},zone});}
this.mode="selecting";}
startEdition(str,selection){const evaluatedCell=this.getters.getActiveCell();const locale=this.getters.getLocale();if(str&&evaluatedCell.format?.includes("%")&&isNumber(str,locale)){selection=selection||{start:str.length,end:str.length};str=`${str}%`;}
const{col,row,sheetId}=this.getters.getActivePosition();this.col=col;this.sheetId=sheetId;this.row=row;this.initialContent=this.getComposerContent({sheetId,col,row});this.mode="editing";this.setContent(str||this.initialContent,selection);this.colorIndexByRange={};const zone=positionToZone({col:this.col,row:this.row});this.selection.capture(this,{cell:{col:this.col,row:this.row},zone},{handleEvent:this.handleEvent.bind(this),release:()=>{this.stopEdition();},});}
stopEdition(){if(this.mode!=="inactive"){this.cancelEditionAndActivateSheet();const col=this.col;const row=this.row;let content=this.getCurrentCanonicalContent();const didChange=this.initialContent!==content;if(!didChange){return;}
if(content){const sheetId=this.getters.getActiveSheetId();const cell=this.getters.getEvaluatedCell({sheetId,col:this.col,row:this.row});if(content.startsWith("=")){const left=this.currentTokens.filter((t)=>t.type==="LEFT_PAREN").length;const right=this.currentTokens.filter((t)=>t.type==="RIGHT_PAREN").length;const missing=left-right;if(missing>0){content+=concat(new Array(missing).fill(")"));}}
else if(cell.link){content=markdownLink(content,cell.link.url);}
this.dispatch("UPDATE_CELL",{sheetId:this.sheetId,col,row,content,});}
else{this.dispatch("UPDATE_CELL",{sheetId:this.sheetId,content:"",col,row,});}
this.setContent("");}}
getCurrentCanonicalContent(){return canonicalizeNumberContent(this.currentContent,this.getters.getLocale());}
cancelEditionAndActivateSheet(){if(this.mode==="inactive"){return;}
this.cancelEdition();const sheetId=this.getters.getActiveSheetId();if(sheetId!==this.sheetId){this.dispatch("ACTIVATE_SHEET",{sheetIdFrom:this.getters.getActiveSheetId(),sheetIdTo:this.sheetId,});}}
getComposerContent(position){const locale=this.getters.getLocale();const cell=this.getters.getCell(position);if(cell?.isFormula){return localizeFormula(cell.content,locale);}
const{format,value,type,formattedValue}=this.getters.getEvaluatedCell(position);switch(type){case CellValueType.text:case CellValueType.empty:return value;case CellValueType.boolean:return formattedValue;case CellValueType.error:return cell?.content||"";case CellValueType.number:if(format&&isDateTimeFormat(format)){if(parseDateTime(formattedValue,locale)!==null){return formattedValue;}
const timeFormat=Number.isInteger(value)?locale.dateFormat:getDateTimeFormat(locale);return formatValue(value,{locale,format:timeFormat});}
return this.numberComposerContent(value,format,locale);}}
numberComposerContent(value,format,locale){if(format?.includes("%")){return`${numberToString(value * 100, locale.decimalSeparator)}%`;}
return numberToString(value,locale.decimalSeparator);}
cancelEdition(){if(this.mode==="inactive"){return;}
this.mode="inactive";this.selection.release(this);}
resetContent(){this.setContent(this.initialContent||"");}
setContent(text,selection,raise){const isNewCurrentContent=this.currentContent!==text;this.currentContent=text;if(selection){this.selectionStart=selection.start;this.selectionEnd=selection.end;}
else{this.selectionStart=this.selectionEnd=text.length;}
if(isNewCurrentContent||this.mode!=="inactive"){const locale=this.getters.getLocale();this.currentTokens=text.startsWith("=")?composerTokenize(text,locale):[];if(this.currentTokens.length>100){if(raise){this.ui.raiseBlockingErrorUI(_t("This formula has over 100 parts. It can't be processed properly, consider splitting it into multiple cells"));}}}
if(this.canStartComposerRangeSelection()){this.startComposerRangeSelection();}}
insertSelectedRange(zone){const start=Math.min(this.selectionStart,this.selectionEnd);const ref=this.getZoneReference(zone);if(this.canStartComposerRangeSelection()){this.insertText(ref,start);}
else{this.insertText(","+ref,start);}}
replaceSelectedRange(zone){const ref=this.getZoneReference(zone);const currentToken=this.getTokenAtCursor();const start=currentToken?.type==="REFERENCE"?currentToken.start:this.selectionStart;this.replaceText(ref,start,this.selectionEnd);}
updateComposerRange(oldZone,newZone){const activeSheetId=this.getters.getActiveSheetId();const tokentAtCursor=this.getTokenAtCursor();const tokens=tokentAtCursor?[tokentAtCursor,...this.currentTokens]:this.currentTokens;const previousRefToken=tokens.filter((token)=>token.type==="REFERENCE").find((token)=>{const{xc,sheetName:sheet}=splitReference(token.value);const sheetName=sheet||this.getters.getSheetName(this.sheetId);if(this.getters.getSheetName(activeSheetId)!==sheetName){return false;}
const refRange=this.getters.getRangeFromSheetXC(activeSheetId,xc);return isEqual(this.getters.expandZone(activeSheetId,refRange.zone),oldZone);});if(!previousRefToken){return;}
const previousRange=this.getters.getRangeFromSheetXC(activeSheetId,previousRefToken.value);this.selectionStart=previousRefToken.start;this.selectionEnd=this.selectionStart+previousRefToken.value.length;const newRange=this.getters.getRangeFromZone(activeSheetId,newZone);const newRef=this.getRangeReference(newRange,previousRange.parts);this.replaceSelection(newRef);}
getZoneReference(zone){const inputSheetId=this.getters.getCurrentEditedCell().sheetId;const sheetId=this.getters.getActiveSheetId();const range=this.getters.getRangeFromZone(sheetId,zone);return this.getters.getSelectionRangeString(range,inputSheetId);}
getRangeReference(range,fixedParts){let _fixedParts=[...fixedParts];const newRange=range.clone({parts:_fixedParts});return this.getters.getSelectionRangeString(newRange,this.getters.getCurrentEditedCell().sheetId);}
replaceSelection(text){const start=Math.min(this.selectionStart,this.selectionEnd);const end=Math.max(this.selectionStart,this.selectionEnd);this.replaceText(text,start,end);}
replaceText(text,start,end){this.currentContent=this.currentContent.slice(0,start)+
this.currentContent.slice(end,this.currentContent.length);this.insertText(text,start);}
insertText(text,start){const content=this.currentContent.slice(0,start)+text+this.currentContent.slice(start);const end=start+text.length;this.dispatch("SET_CURRENT_CONTENT",{content,selection:{start:end,end},});}
updateRangeColor(){if(!this.currentContent.startsWith("=")||this.mode==="inactive"){return;}
const editionSheetId=this.getters.getCurrentEditedCell().sheetId;const XCs=this.getReferencedRanges().map((range)=>this.getters.getRangeString(range,editionSheetId));const colorsToKeep={};for(const xc of XCs){if(this.colorIndexByRange[xc]!==undefined){colorsToKeep[xc]=this.colorIndexByRange[xc];}}
const usedIndexes=new Set(Object.values(colorsToKeep));let currentIndex=0;const nextIndex=()=>{while(usedIndexes.has(currentIndex))
currentIndex++;usedIndexes.add(currentIndex);return currentIndex;};for(const xc of XCs){const colorIndex=xc in colorsToKeep?colorsToKeep[xc]:nextIndex();colorsToKeep[xc]=colorIndex;}
this.colorIndexByRange=colorsToKeep;}
getComposerHighlights(){if(!this.currentContent.startsWith("=")||this.mode==="inactive"){return[];}
const editionSheetId=this.getters.getCurrentEditedCell().sheetId;const rangeColor=(rangeString)=>{const colorIndex=this.colorIndexByRange[rangeString];return colors$1[colorIndex%colors$1.length];};return this.getReferencedRanges().map((range)=>{const rangeString=this.getters.getRangeString(range,editionSheetId);return{zone:range.zone,color:rangeColor(rangeString),sheetId:range.sheetId,};});}
getReferencedRanges(){const editionSheetId=this.getters.getCurrentEditedCell().sheetId;const referenceRanges=this.currentTokens.filter((token)=>token.type==="REFERENCE").map((token)=>this.getters.getRangeFromSheetXC(editionSheetId,token.value));return referenceRanges.filter((range)=>!range.invalidSheetName&&!range.invalidXc);}
getAutoCompleteDataValidationValues(){if(this.mode==="inactive"){return[];}
const rule=this.getters.getValidationRuleForCell(this.getCurrentEditedCell());if(!rule||(rule.criterion.type!=="isValueInList"&&rule.criterion.type!=="isValueInRange")){return[];}
let values;if(rule.criterion.type==="isValueInList"){values=rule.criterion.values;}
else{const range=this.getters.getRangeFromSheetXC(this.sheetId,rule.criterion.values[0]);values=Array.from(new Set(this.getters.getRangeValues(range).filter(isNotNull).map((value)=>value.toString()).filter((val)=>val!=="")));}
const composerContent=this.getCurrentContent();if(composerContent&&composerContent!==this.getInitialComposerContent()){const filteredValues=fuzzyLookup(composerContent,values,(val)=>val);values=filteredValues.length?filteredValues:values;}
return values;}
canStartComposerRangeSelection(){if(this.currentContent.startsWith("=")){const tokenAtCursor=this.getTokenAtCursor();if(!tokenAtCursor){return false;}
const tokenIdex=this.currentTokens.map((token)=>token.start).indexOf(tokenAtCursor.start);let count=tokenIdex;let currentToken=tokenAtCursor;while(!["ARG_SEPARATOR","LEFT_PAREN","OPERATOR"].includes(currentToken.type)||POSTFIX_UNARY_OPERATORS.includes(currentToken.value)){if(currentToken.type!=="SPACE"||count<1){return false;}
count--;currentToken=this.currentTokens[count];}
count=tokenIdex+1;currentToken=this.currentTokens[count];while(currentToken&&!["ARG_SEPARATOR","RIGHT_PAREN","OPERATOR"].includes(currentToken.type)){if(currentToken.type!=="SPACE"){return false;}
count++;currentToken=this.currentTokens[count];}
return true;}
return false;}
checkDataValidation(cmd){const cellPosition={sheetId:this.sheetId,col:this.col,row:this.row};try{const content=this.getCurrentCanonicalContent();const cellValue=content.startsWith("=")?this.getters.evaluateFormula(this.sheetId,content):parseLiteral(content,this.getters.getLocale());if(isMatrix(cellValue)){return"Success";}
const validationResult=this.getters.getValidationResultForCellValue(cellValue,cellPosition);if(!validationResult.isValid&&validationResult.rule.isBlocking){return"BlockingValidationRule";}
return"Success";}
catch(e){const rule=this.getters.getValidationRuleForCell(cellPosition);return rule?.isBlocking?"BlockingValidationRule":"Success";}}}
class FilterEvaluationPlugin extends UIPlugin{static getters=["getCellBorderWithFilterBorder","getFilterValues","isRowFiltered","isFilterActive",];filterValues={};hiddenRows={};isEvaluationDirty=false;allowDispatch(cmd){switch(cmd.type){case"UPDATE_FILTER":if(!this.getters.getFilterId(cmd)){return"FilterNotFound";}
break;}
return"Success";}
handle(cmd){switch(cmd.type){case"UNDO":case"REDO":case"UPDATE_CELL":case"EVALUATE_CELLS":case"ACTIVATE_SHEET":case"REMOVE_FILTER_TABLE":case"ADD_COLUMNS_ROWS":case"REMOVE_COLUMNS_ROWS":this.isEvaluationDirty=true;break;case"START":for(const sheetId of this.getters.getSheetIds()){this.filterValues[sheetId]={};for(const filter of this.getters.getFilters(sheetId)){this.filterValues[sheetId][filter.id]=[];}}
break;case"CREATE_SHEET":this.filterValues[cmd.sheetId]={};break;case"HIDE_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"GROUP_HEADERS":case"UNGROUP_HEADERS":case"FOLD_HEADER_GROUP":case"UNFOLD_HEADER_GROUP":case"FOLD_ALL_HEADER_GROUPS":case"UNFOLD_ALL_HEADER_GROUPS":this.updateHiddenRows(cmd.sheetId);break;case"UPDATE_FILTER":this.updateFilter(cmd);this.updateHiddenRows(cmd.sheetId);break;case"DUPLICATE_SHEET":const filterValues={};for(const newFilter of this.getters.getFilters(cmd.sheetIdTo)){const zone=newFilter.zoneWithHeaders;filterValues[newFilter.id]=this.getFilterValues({sheetId:cmd.sheetId,col:zone.left,row:zone.top,});}
this.filterValues[cmd.sheetIdTo]=filterValues;break;}}
finalize(){if(this.isEvaluationDirty){for(const sheetId of this.getters.getSheetIds()){this.updateHiddenRows(sheetId);}
this.isEvaluationDirty=false;}}
isRowFiltered(sheetId,row){return!!this.hiddenRows[sheetId]?.has(row);}
getCellBorderWithFilterBorder(position){const{sheetId,col,row}=position;let filterBorder=undefined;for(let filters of this.getters.getFilterTables(sheetId)){const zone=filters.zone;if(isInside(col,row,zone)){const visibleZone=this.intersectZoneWithViewport(sheetId,zone);filterBorder={top:row===visibleZone.top?DEFAULT_FILTER_BORDER_DESC:undefined,bottom:row===visibleZone.bottom?DEFAULT_FILTER_BORDER_DESC:undefined,left:col===visibleZone.left?DEFAULT_FILTER_BORDER_DESC:undefined,right:col===visibleZone.right?DEFAULT_FILTER_BORDER_DESC:undefined,};}}
const cellBorder=this.getters.getCellBorder(position);const border={...filterBorder,...removeFalsyAttributes(cellBorder||{})};return isObjectEmptyRecursive(border)?null:border;}
getFilterValues(position){const id=this.getters.getFilterId(position);const sheetId=position.sheetId;if(!id||!this.filterValues[sheetId])
return[];return this.filterValues[sheetId][id]||[];}
isFilterActive(position){const id=this.getters.getFilterId(position);const sheetId=position.sheetId;return Boolean(id&&this.filterValues[sheetId]?.[id]?.length);}
intersectZoneWithViewport(sheetId,zone){return{left:this.getters.findVisibleHeader(sheetId,"COL",zone.left,zone.right),right:this.getters.findVisibleHeader(sheetId,"COL",zone.right,zone.left),top:this.getters.findVisibleHeader(sheetId,"ROW",zone.top,zone.bottom),bottom:this.getters.findVisibleHeader(sheetId,"ROW",zone.bottom,zone.top),};}
updateFilter({col,row,hiddenValues,sheetId}){const id=this.getters.getFilterId({sheetId,col,row});if(!id)
return;if(!this.filterValues[sheetId])
this.filterValues[sheetId]={};this.filterValues[sheetId][id]=hiddenValues;}
updateHiddenRows(sheetId){const filters=this.getters.getFilters(sheetId).sort((filter1,filter2)=>filter1.zoneWithHeaders.top-filter2.zoneWithHeaders.top);const hiddenRows=new Set();for(let filter of filters){if(hiddenRows.has(filter.zoneWithHeaders.top)||this.getters.isRowHiddenByUser(sheetId,filter.zoneWithHeaders.top)){continue;}
const filteredValues=this.filterValues[sheetId]?.[filter.id]?.map(toLowerCase);if(!filteredValues||!filter.filteredZone)
continue;for(let row=filter.filteredZone.top;row<=filter.filteredZone.bottom;row++){const value=this.getCellValueAsString(sheetId,filter.col,row);if(filteredValues.includes(value)){hiddenRows.add(row);}}}
this.hiddenRows[sheetId]=hiddenRows;}
getCellValueAsString(sheetId,col,row){const value=this.getters.getEvaluatedCell({sheetId,col,row}).formattedValue;return value.toLowerCase();}
exportForExcel(data){for(const sheetData of data.sheets){const sheetId=sheetData.id;for(const tableData of sheetData.filterTables){const tableZone=toZone(tableData.range);const filters=[];const headerNames=[];for(const i of range(0,zoneToDimension(tableZone).numberOfCols)){const position={sheetId:sheetData.id,col:tableZone.left+i,row:tableZone.top,};const filteredValues=this.getFilterValues(position);const filter=this.getters.getFilter(position);if(!filter)
continue;const valuesInFilterZone=filter.filteredZone?positions(filter.filteredZone).map((position)=>this.getters.getEvaluatedCell({sheetId,...position}).formattedValue):[];if(filteredValues.length){const xlsxDisplayedValues=valuesInFilterZone.filter((val)=>val).filter((val)=>!filteredValues.includes(val));filters.push({colId:i,displayedValues:[...new Set(xlsxDisplayedValues)],displayBlanks:!filteredValues.includes("")&&valuesInFilterZone.some((val)=>!val),});}
const headerPosition={col:filter.col,row:filter.zoneWithHeaders.top,sheetId};const headerString=this.getters.getEvaluatedCell(headerPosition).formattedValue;const headerName=this.getUniqueColNameForExcel(i,headerString,headerNames);headerNames.push(headerName);sheetData.cells[toXC(headerPosition.col,headerPosition.row)]={...sheetData.cells[toXC(headerPosition.col,headerPosition.row)],content:headerName,value:headerName,isFormula:false,};}
tableData.filters=filters;}}}
getUniqueColNameForExcel(colIndex,colName,usedColNames){if(!colName){colName=`Column${colIndex}`;}
let currentColName=colName;let i=2;while(usedColNames.includes(currentColName)){currentColName=colName+String(i);i++;}
return currentColName;}}
const selectionStatisticFunctions=[{name:_t("Sum"),types:[CellValueType.number],compute:(values,locale)=>SUM.compute.bind({locale})([values]),},{name:_t("Avg"),types:[CellValueType.number],compute:(values,locale)=>AVERAGE.compute.bind({locale})([values]),},{name:_t("Min"),types:[CellValueType.number],compute:(values,locale)=>MIN.compute.bind({locale})([values]),},{name:_t("Max"),types:[CellValueType.number],compute:(values,locale)=>MAX.compute.bind({locale})([values]),},{name:_t("Count"),types:[CellValueType.number,CellValueType.text,CellValueType.boolean,CellValueType.error],compute:(values,locale)=>COUNTA.compute.bind({locale})([values]),},{name:_t("Count Numbers"),types:[CellValueType.number,CellValueType.text,CellValueType.boolean,CellValueType.error],compute:(values,locale)=>COUNT.compute.bind({locale})([values]),},];class GridSelectionPlugin extends UIPlugin{static layers=[6];static getters=["getActiveSheet","getActiveSheetId","getActiveCell","getActiveCols","getActiveRows","getCurrentStyle","getSelectedZones","getSelectedZone","getSelectedCells","getStatisticFnResults","getAggregate","getSelectedFigureId","getSelection","getActivePosition","getSheetPosition","isSelected","isSingleColSelected","getElementsFromSelection","tryGetActiveSheetId","isGridSelectionActive",];gridSelection={anchor:{cell:{col:0,row:0},zone:{top:0,left:0,bottom:0,right:0},},zones:[{top:0,left:0,bottom:0,right:0}],};selectedFigureId=null;sheetsData={};moveClient;activeSheet=null;constructor(config){super(config);this.moveClient=config.moveClient;}
allowDispatch(cmd){switch(cmd.type){case"ACTIVATE_SHEET":try{this.getters.getSheet(cmd.sheetIdTo);break;}
catch(error){return"InvalidSheetId";}
case"MOVE_COLUMNS_ROWS":return this.isMoveElementAllowed(cmd);}
return"Success";}
handleEvent(event){const anchor=event.anchor;let zones=[];switch(event.mode){case"overrideSelection":zones=[anchor.zone];break;case"updateAnchor":zones=[...this.gridSelection.zones];const index=zones.findIndex((z)=>isEqual(z,event.previousAnchor.zone));if(index>=0){zones[index]=anchor.zone;}
break;case"newAnchor":zones=[...this.gridSelection.zones,anchor.zone];break;}
this.setSelectionMixin(event.anchor,zones);this.selection.resetDefaultAnchor(this,deepCopy(this.gridSelection.anchor));const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId:this.getters.getActiveSheetId(),col,row,});this.selectedFigureId=null;}
handle(cmd){switch(cmd.type){case"START_EDITION":case"ACTIVATE_SHEET":this.selectedFigureId=null;break;case"DELETE_FIGURE":if(this.selectedFigureId===cmd.id){this.selectedFigureId=null;}
break;case"DELETE_SHEET":if(this.selectedFigureId&&this.getters.getFigure(cmd.sheetId,this.selectedFigureId)){this.selectedFigureId=null;}
break;}
switch(cmd.type){case"START":const firstSheetId=this.getters.getVisibleSheetIds()[0];this.activateSheet(firstSheetId,firstSheetId);const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:firstSheetId,col:0,row:0,});this.selectCell(col,row);this.selection.registerAsDefault(this,this.gridSelection.anchor,{handleEvent:this.handleEvent.bind(this),});this.moveClient({sheetId:firstSheetId,col:0,row:0});break;case"ACTIVATE_SHEET":{this.activateSheet(cmd.sheetIdFrom,cmd.sheetIdTo);break;}
case"REMOVE_COLUMNS_ROWS":{const sheetId=this.getters.getActiveSheetId();if(cmd.sheetId===sheetId){if(cmd.dimension==="COL"){this.onColumnsRemoved(cmd);}
else{this.onRowsRemoved(cmd);}
const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId,col,row});}
break;}
case"ADD_COLUMNS_ROWS":{const sheetId=this.getters.getActiveSheetId();if(cmd.sheetId===sheetId){this.onAddElements(cmd);const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId,col,row});}
break;}
case"MOVE_COLUMNS_ROWS":if(cmd.sheetId===this.getActiveSheetId()){this.onMoveElements(cmd);}
break;case"SELECT_FIGURE":this.selectedFigureId=cmd.id;break;case"ACTIVATE_NEXT_SHEET":this.activateNextSheet("right");break;case"ACTIVATE_PREVIOUS_SHEET":this.activateNextSheet("left");break;case"HIDE_SHEET":if(cmd.sheetId===this.getActiveSheetId()){this.dispatch("ACTIVATE_SHEET",{sheetIdFrom:cmd.sheetId,sheetIdTo:this.getters.getVisibleSheetIds()[0],});}
break;case"UNDO":case"REDO":case"DELETE_SHEET":const deletedSheetIds=Object.keys(this.sheetsData).filter((sheetId)=>!this.getters.tryGetSheet(sheetId));for(const sheetId of deletedSheetIds){delete this.sheetsData[sheetId];}
for(const sheetId in this.sheetsData){const gridSelection=this.clipSelection(sheetId,this.sheetsData[sheetId].gridSelection);this.sheetsData[sheetId]={gridSelection:deepCopy(gridSelection),};}
if(!this.getters.tryGetSheet(this.getters.getActiveSheetId())){const currentSheetIds=this.getters.getVisibleSheetIds();this.activeSheet=this.getters.getSheet(currentSheetIds[0]);if(this.activeSheet.id in this.sheetsData){const{anchor}=this.clipSelection(this.activeSheet.id,this.sheetsData[this.activeSheet.id].gridSelection);this.selectCell(anchor.cell.col,anchor.cell.row);}
else{this.selectCell(0,0);}
const{col,row}=this.gridSelection.anchor.cell;this.moveClient({sheetId:this.getters.getActiveSheetId(),col,row,});}
const sheetId=this.getters.getActiveSheetId();this.gridSelection.zones=this.gridSelection.zones.map((z)=>this.getters.expandZone(sheetId,z));this.gridSelection.anchor.zone=this.getters.expandZone(sheetId,this.gridSelection.anchor.zone);this.setSelectionMixin(this.gridSelection.anchor,this.gridSelection.zones);this.selectedFigureId=null;break;}
this.selection.resetDefaultAnchor(this,deepCopy(this.gridSelection.anchor));}
isGridSelectionActive(){return this.selection.isListening(this);}
getActiveSheet(){return this.activeSheet;}
getActiveSheetId(){return this.activeSheet.id;}
tryGetActiveSheetId(){return this.activeSheet?.id;}
getActiveCell(){return this.getters.getEvaluatedCell(this.getActivePosition());}
getActiveCols(){const activeCols=new Set();for(let zone of this.gridSelection.zones){if(zone.top===0&&zone.bottom===this.getters.getNumberRows(this.getters.getActiveSheetId())-1){for(let i=zone.left;i<=zone.right;i++){activeCols.add(i);}}}
return activeCols;}
getActiveRows(){const activeRows=new Set();const sheetId=this.getters.getActiveSheetId();for(let zone of this.gridSelection.zones){if(zone.left===0&&zone.right===this.getters.getNumberCols(sheetId)-1){for(let i=zone.top;i<=zone.bottom;i++){activeRows.add(i);}}}
return activeRows;}
getCurrentStyle(){const zone=this.getters.getSelectedZone();const sheetId=this.getters.getActiveSheetId();return this.getters.getCellStyle({sheetId,col:zone.left,row:zone.top});}
getSelectedZones(){return deepCopy(this.gridSelection.zones);}
getSelectedZone(){return deepCopy(this.gridSelection.anchor.zone);}
getSelection(){return deepCopy(this.gridSelection);}
getSelectedCells(){const sheetId=this.getters.getActiveSheetId();const cells=[];for(const zone of this.gridSelection.zones){cells.push(...this.getters.getEvaluatedCellsInZone(sheetId,zone));}
return cells;}
getSelectedFigureId(){return this.selectedFigureId;}
getActivePosition(){return this.getters.getMainCellPosition({sheetId:this.getActiveSheetId(),col:this.gridSelection.anchor.cell.col,row:this.gridSelection.anchor.cell.row,});}
getSheetPosition(sheetId){if(sheetId===this.getters.getActiveSheetId()){return this.getActivePosition();}
else{const sheetData=this.sheetsData[sheetId];return sheetData?{sheetId,col:sheetData.gridSelection.anchor.cell.col,row:sheetData.gridSelection.anchor.cell.row,}:this.getters.getNextVisibleCellPosition({sheetId,col:0,row:0});}}
getStatisticFnResults(){const sheetId=this.getters.getActiveSheetId();const cells=new Set();for(const zone of this.gridSelection.zones){for(const{col,row}of positions(zone)){if(this.getters.isRowHidden(sheetId,row)||this.getters.isColHidden(sheetId,col)){continue;}
const evaluatedCell=this.getters.getEvaluatedCell({sheetId,col,row});if(evaluatedCell.type!==CellValueType.empty){cells.add(evaluatedCell);}}}
let cellsTypes=new Set();let cellsValues=[];for(let cell of cells){cellsTypes.add(cell.type);cellsValues.push(cell.value);}
const locale=this.getters.getLocale();let statisticFnResults={};for(let fn of selectionStatisticFunctions){let fnResult=undefined;if(fn.types.some((t)=>cellsTypes.has(t))){fnResult=fn.compute(cellsValues,locale);}
statisticFnResults[fn.name]=fnResult;}
return statisticFnResults;}
getAggregate(){let aggregate=0;let n=0;const sheetId=this.getters.getActiveSheetId();const cellPositions=this.gridSelection.zones.map(positions).flat();for(const{col,row}of cellPositions){const cell=this.getters.getEvaluatedCell({sheetId,col,row});if(cell.type===CellValueType.number){n++;aggregate+=cell.value;}}
const locale=this.getters.getLocale();return n<2?null:formatValue(aggregate,{locale});}
isSelected(zone){return!!this.getters.getSelectedZones().find((z)=>isEqual(z,zone));}
isSingleColSelected(){const selection=this.getters.getSelectedZones();if(selection.length!==1||selection[0].left!==selection[0].right){return false;}
return true;}
getElementsFromSelection(dimension){if(dimension==="COL"&&this.getters.getActiveCols().size===0){return[];}
if(dimension==="ROW"&&this.getters.getActiveRows().size===0){return[];}
const zones=this.getters.getSelectedZones();let elements=[];const start=dimension==="COL"?"left":"top";const end=dimension==="COL"?"right":"bottom";for(const zone of zones){const zoneRows=Array.from({length:zone[end]-zone[start]+1},(_,i)=>zone[start]+i);elements=elements.concat(zoneRows);}
return[...new Set(elements)].sort();}
activateSheet(sheetIdFrom,sheetIdTo){if(!this.getters.isSheetVisible(sheetIdTo)){this.dispatch("SHOW_SHEET",{sheetId:sheetIdTo});}
this.setActiveSheet(sheetIdTo);this.sheetsData[sheetIdFrom]={gridSelection:deepCopy(this.gridSelection),};if(sheetIdTo in this.sheetsData){Object.assign(this,this.sheetsData[sheetIdTo]);this.selection.resetDefaultAnchor(this,deepCopy(this.gridSelection.anchor));}
else{const{col,row}=this.getters.getNextVisibleCellPosition({sheetId:sheetIdTo,col:0,row:0,});this.selectCell(col,row);}}
setSelectionMixin(anchor,zones){const{anchor:clippedAnchor,zones:clippedZones}=this.clipSelection(this.getters.getActiveSheetId(),{anchor,zones});this.gridSelection.anchor=clippedAnchor;this.gridSelection.zones=uniqueZones(clippedZones);}
selectCell(col,row){const sheetId=this.getters.getActiveSheetId();const zone=this.getters.expandZone(sheetId,{left:col,right:col,top:row,bottom:row});this.setSelectionMixin({zone,cell:{col,row}},[zone]);}
setActiveSheet(id){const sheet=this.getters.getSheet(id);this.activeSheet=sheet;}
activateNextSheet(direction){const sheetIds=this.getters.getSheetIds();const oldSheetPosition=sheetIds.findIndex((id)=>id===this.activeSheet.id);const delta=direction==="left"?sheetIds.length-1:1;const newPosition=(oldSheetPosition+delta)%sheetIds.length;this.dispatch("ACTIVATE_SHEET",{sheetIdFrom:this.getActiveSheetId(),sheetIdTo:sheetIds[newPosition],});}
onColumnsRemoved(cmd){const{cell,zone}=this.gridSelection.anchor;const selectedZone=updateSelectionOnDeletion(zone,"left",[...cmd.elements]);let anchorZone={left:cell.col,right:cell.col,top:cell.row,bottom:cell.row};anchorZone=updateSelectionOnDeletion(anchorZone,"left",[...cmd.elements]);const anchor={cell:{col:anchorZone.left,row:anchorZone.top,},zone:selectedZone,};const selections=this.gridSelection.zones.map((zone)=>updateSelectionOnDeletion(zone,"left",[...cmd.elements]));this.setSelectionMixin(anchor,selections);}
onRowsRemoved(cmd){const{cell,zone}=this.gridSelection.anchor;const selectedZone=updateSelectionOnDeletion(zone,"top",[...cmd.elements]);let anchorZone={left:cell.col,right:cell.col,top:cell.row,bottom:cell.row};anchorZone=updateSelectionOnDeletion(anchorZone,"top",[...cmd.elements]);const anchor={cell:{col:anchorZone.left,row:anchorZone.top,},zone:selectedZone,};const selections=this.gridSelection.zones.map((zone)=>updateSelectionOnDeletion(zone,"top",[...cmd.elements]));this.setSelectionMixin(anchor,selections);}
onAddElements(cmd){const start=cmd.dimension==="COL"?"left":"top";const anchorZone=updateSelectionOnInsertion(this.gridSelection.anchor.zone,start,cmd.base,cmd.position,cmd.quantity);const selection=this.gridSelection.zones.map((zone)=>updateSelectionOnInsertion(zone,start,cmd.base,cmd.position,cmd.quantity));const anchor={cell:{col:anchorZone.left,row:anchorZone.top},zone:anchorZone,};this.setSelectionMixin(anchor,selection);}
onMoveElements(cmd){const thickness=cmd.elements.length;this.dispatch("ADD_COLUMNS_ROWS",{dimension:cmd.dimension,sheetId:cmd.sheetId,base:cmd.base,quantity:thickness,position:cmd.position,});const isCol=cmd.dimension==="COL";const start=cmd.elements[0];const end=cmd.elements[thickness-1];const isBasedBefore=cmd.base<start;const deltaCol=isBasedBefore&&isCol?thickness:0;const deltaRow=isBasedBefore&&!isCol?thickness:0;const target=[{left:isCol?start+deltaCol:0,right:isCol?end+deltaCol:this.getters.getNumberCols(cmd.sheetId)-1,top:!isCol?start+deltaRow:0,bottom:!isCol?end+deltaRow:this.getters.getNumberRows(cmd.sheetId)-1,},];const state=new ClipboardCellsState(target,"CUT",this.getters,this.dispatch,this.selection);const base=isBasedBefore?cmd.base:cmd.base+1;const pasteTarget=[{left:isCol?base:0,right:isCol?base+thickness-1:this.getters.getNumberCols(cmd.sheetId)-1,top:!isCol?base:0,bottom:!isCol?base+thickness-1:this.getters.getNumberRows(cmd.sheetId)-1,},];state.paste(pasteTarget,{selectTarget:true});const toRemove=isBasedBefore?cmd.elements.map((el)=>el+thickness):cmd.elements;let currentIndex=cmd.base;for(const element of toRemove){const size=this.getters.getHeaderSize(cmd.sheetId,cmd.dimension,element);this.dispatch("RESIZE_COLUMNS_ROWS",{dimension:cmd.dimension,sheetId:cmd.sheetId,size,elements:[currentIndex],});currentIndex+=1;}
this.dispatch("REMOVE_COLUMNS_ROWS",{dimension:cmd.dimension,sheetId:cmd.sheetId,elements:toRemove,});}
isMoveElementAllowed(cmd){const isCol=cmd.dimension==="COL";const start=cmd.elements[0];const end=cmd.elements[cmd.elements.length-1];const id=cmd.sheetId;const doesElementsHaveCommonMerges=isCol?this.getters.doesColumnsHaveCommonMerges:this.getters.doesRowsHaveCommonMerges;if(doesElementsHaveCommonMerges(id,start-1,start)||doesElementsHaveCommonMerges(id,end,end+1)||doesElementsHaveCommonMerges(id,cmd.base-1,cmd.base)){return"WillRemoveExistingMerge";}
const headers=[cmd.base,...cmd.elements];const maxHeaderValue=isCol?this.getters.getNumberCols(id):this.getters.getNumberRows(id);if(headers.some((h)=>h<0||h>=maxHeaderValue)){return"InvalidHeaderIndex";}
return"Success";}
clipSelection(sheetId,selection){const cols=this.getters.getNumberCols(sheetId)-1;const rows=this.getters.getNumberRows(sheetId)-1;const zones=selection.zones.map((z)=>{return{left:clip(z.left,0,cols),right:clip(z.right,0,cols),top:clip(z.top,0,rows),bottom:clip(z.bottom,0,rows),};});const anchorCol=clip(selection.anchor.cell.col,0,cols);const anchorRow=clip(selection.anchor.cell.row,0,rows);const anchorZone={left:clip(selection.anchor.zone.left,0,cols),right:clip(selection.anchor.zone.right,0,cols),top:clip(selection.anchor.zone.top,0,rows),bottom:clip(selection.anchor.zone.bottom,0,rows),};return{zones,anchor:{cell:{col:anchorCol,row:anchorRow},zone:anchorZone,},};}
drawGrid(renderingContext){if(this.getters.isDashboard()){return;}
const{ctx,thinLineWidth}=renderingContext;const zones=this.getSelectedZones();ctx.fillStyle="#f3f7fe";const onlyOneCell=zones.length===1&&zones[0].left===zones[0].right&&zones[0].top===zones[0].bottom;ctx.fillStyle=onlyOneCell?"#f3f7fe":"#e9f0ff";ctx.strokeStyle=SELECTION_BORDER_COLOR;ctx.lineWidth=1.5*thinLineWidth;for(const zone of zones){const{x,y,width,height}=this.getters.getVisibleRect(zone);ctx.globalCompositeOperation="multiply";ctx.fillRect(x,y,width,height);ctx.globalCompositeOperation="source-over";ctx.strokeRect(x,y,width,height);}
ctx.globalCompositeOperation="source-over";const position=this.getActivePosition();ctx.strokeStyle=SELECTION_BORDER_COLOR;ctx.lineWidth=3*thinLineWidth;let zone;if(this.getters.isInMerge(position)){zone=this.getters.getMerge(position);}
else{zone=positionToZone(position);}
const{x,y,width,height}=this.getters.getVisibleRect(zone);if(width>0&&height>0){ctx.strokeRect(x,y,width,height);}}}
class InternalViewport{getters;sheetId;boundaries;top;bottom;left;right;offsetX;offsetY;offsetScrollbarX;offsetScrollbarY;canScrollVertically;canScrollHorizontally;viewportWidth;viewportHeight;offsetCorrectionX;offsetCorrectionY;constructor(getters,sheetId,boundaries,sizeInGrid,options,offsets){this.getters=getters;this.sheetId=sheetId;this.boundaries=boundaries;this.viewportWidth=sizeInGrid.width;this.viewportHeight=sizeInGrid.height;this.offsetScrollbarX=offsets.x;this.offsetScrollbarY=offsets.y;this.canScrollVertically=options.canScrollVertically;this.canScrollHorizontally=options.canScrollHorizontally;this.offsetCorrectionX=this.getters.getColDimensions(this.sheetId,this.boundaries.left).start;this.offsetCorrectionY=this.getters.getRowDimensions(this.sheetId,this.boundaries.top).start;this.adjustViewportOffsetX();this.adjustViewportOffsetY();}
getMaxSize(){const lastCol=this.getters.findLastVisibleColRowIndex(this.sheetId,"COL",{first:this.boundaries.left,last:this.boundaries.right,});const lastRow=this.getters.findLastVisibleColRowIndex(this.sheetId,"ROW",{first:this.boundaries.top,last:this.boundaries.bottom,});const{end:lastColEnd,size:lastColSize}=this.getters.getColDimensions(this.sheetId,lastCol);const{end:lastRowEnd,size:lastRowSize}=this.getters.getRowDimensions(this.sheetId,lastRow);const leftColIndex=this.searchHeaderIndex("COL",lastColEnd-this.viewportWidth,0);const leftColSize=this.getters.getColSize(this.sheetId,leftColIndex);const leftRowIndex=this.searchHeaderIndex("ROW",lastRowEnd-this.viewportHeight,0);const topRowSize=this.getters.getRowSize(this.sheetId,leftRowIndex);let width=lastColEnd-this.offsetCorrectionX;if(this.canScrollHorizontally){width+=Math.max(DEFAULT_CELL_WIDTH,Math.min(leftColSize,this.viewportWidth-lastColSize));width=Math.max(width,this.viewportWidth);}
let height=lastRowEnd-this.offsetCorrectionY;if(this.canScrollVertically){height+=Math.max(DEFAULT_CELL_HEIGHT+5,Math.min(topRowSize,this.viewportHeight-lastRowSize));height=Math.max(height,this.viewportHeight);}
if(lastRowEnd+FOOTER_HEIGHT>height&&!this.getters.isReadonly()){height+=FOOTER_HEIGHT;}
return{width,height};}
getColIndex(x){if(x<this.offsetCorrectionX||x>this.offsetCorrectionX+this.viewportWidth){return-1;}
return this.searchHeaderIndex("COL",x-this.offsetCorrectionX,this.left);}
getRowIndex(y){if(y<this.offsetCorrectionY||y>this.offsetCorrectionY+this.viewportHeight){return-1;}
return this.searchHeaderIndex("ROW",y-this.offsetCorrectionY,this.top);}
adjustPosition(position){const sheetId=this.sheetId;if(!position){position=this.getters.getSheetPosition(sheetId);}
const mainCellPosition=this.getters.getMainCellPosition({sheetId,...position});const{col,row}=this.getters.getNextVisibleCellPosition(mainCellPosition);if(isInside(col,this.boundaries.top,this.boundaries)){this.adjustPositionX(col);}
if(isInside(this.boundaries.left,row,this.boundaries)){this.adjustPositionY(row);}}
adjustPositionX(targetCol){const sheetId=this.sheetId;const{end}=this.getters.getColDimensions(sheetId,targetCol);const maxCol=this.getters.getNumberCols(sheetId);if(this.offsetX+this.offsetCorrectionX+this.viewportWidth<end){let finalTarget=targetCol;while(this.getters.isColHidden(sheetId,finalTarget)&&targetCol<maxCol){finalTarget++;}
const finalTargetEnd=this.getters.getColDimensions(sheetId,finalTarget).end;const startIndex=this.searchHeaderIndex("COL",finalTargetEnd-this.viewportWidth-this.offsetCorrectionX,this.boundaries.left);this.offsetX=this.getters.getColDimensions(sheetId,startIndex).end-this.offsetCorrectionX;this.offsetScrollbarX=this.offsetX;this.adjustViewportZoneX();}
else if(this.left>targetCol){let finalTarget=targetCol;while(this.getters.isColHidden(sheetId,finalTarget)&&targetCol>0){finalTarget--;}
this.offsetX=this.getters.getColDimensions(sheetId,finalTarget).start-this.offsetCorrectionX;this.offsetScrollbarX=this.offsetX;this.adjustViewportZoneX();}}
adjustPositionY(targetRow){const sheetId=this.sheetId;const{end}=this.getters.getRowDimensions(sheetId,targetRow);const maxRow=this.getters.getNumberRows(sheetId);if(this.offsetY+this.viewportHeight+this.offsetCorrectionY<end){let finalTarget=targetRow;while(this.getters.isRowHidden(sheetId,finalTarget)&&targetRow<maxRow){finalTarget++;}
const finalTargetEnd=this.getters.getRowDimensions(sheetId,finalTarget).end;const startIndex=this.searchHeaderIndex("ROW",finalTargetEnd-this.viewportHeight-this.offsetCorrectionY,this.boundaries.top);this.offsetY=this.getters.getRowDimensions(sheetId,startIndex).end-this.offsetCorrectionY;this.offsetScrollbarY=this.offsetY;this.adjustViewportZoneY();}
else if(this.top>targetRow){let finalTarget=targetRow;while(this.getters.isRowHidden(sheetId,finalTarget)&&targetRow>0){finalTarget--;}
this.offsetY=this.getters.getRowDimensions(sheetId,finalTarget).start-this.offsetCorrectionY;this.offsetScrollbarY=this.offsetY;this.adjustViewportZoneY();}}
setViewportOffset(offsetX,offsetY){this.setViewportOffsetX(offsetX);this.setViewportOffsetY(offsetY);}
adjustViewportZone(){this.adjustViewportZoneX();this.adjustViewportZoneY();}
getRect(zone){const targetZone=intersection(zone,this.zone);if(targetZone){const x=this.getters.getColRowOffset("COL",this.zone.left,targetZone.left)+
this.offsetCorrectionX;const y=this.getters.getColRowOffset("ROW",this.zone.top,targetZone.top)+this.offsetCorrectionY;const width=Math.min(this.getters.getColRowOffset("COL",targetZone.left,targetZone.right+1),this.viewportWidth);const height=Math.min(this.getters.getColRowOffset("ROW",targetZone.top,targetZone.bottom+1),this.viewportHeight);return{x,y,width,height,};}
else{return undefined;}}
isVisible(col,row){const isInside=row<=this.bottom&&row>=this.top&&col>=this.left&&col<=this.right;return(isInside&&!this.getters.isColHidden(this.sheetId,col)&&!this.getters.isRowHidden(this.sheetId,row));}
searchHeaderIndex(dimension,position,startIndex=0){const sheetId=this.sheetId;const headers=this.getters.getNumberHeaders(sheetId,dimension);let start=startIndex;let end=headers;while(start<=end&&start!==headers&&end!==-1){const mid=Math.floor((start+end)/2);const offset=this.getters.getColRowOffset(dimension,startIndex,mid);const size=this.getters.getHeaderSize(sheetId,dimension,mid);if(position>=offset&&position<offset+size){return mid;}
else if(position>=offset+size){start=mid+1;}
else{end=mid-1;}}
return-1;}
get zone(){return{left:this.left,right:this.right,top:this.top,bottom:this.bottom};}
setViewportOffsetX(offsetX){if(!this.canScrollHorizontally){return;}
this.offsetScrollbarX=offsetX;this.adjustViewportZoneX();}
setViewportOffsetY(offsetY){if(!this.canScrollVertically){return;}
this.offsetScrollbarY=offsetY;this.adjustViewportZoneY();}
adjustViewportOffsetX(){if(this.canScrollHorizontally){const{width:viewportWidth}=this.getMaxSize();if(this.viewportWidth+this.offsetScrollbarX>viewportWidth){this.offsetScrollbarX=Math.max(0,viewportWidth-this.viewportWidth);}}
this.left=this.getColIndex(this.offsetScrollbarX);this.right=this.getColIndex(this.offsetScrollbarX+this.viewportWidth);if(this.right===-1){this.right=this.boundaries.right;}
this.adjustViewportZoneX();}
adjustViewportOffsetY(){if(this.canScrollVertically){const{height:paneHeight}=this.getMaxSize();if(this.viewportHeight+this.offsetScrollbarY>paneHeight){this.offsetScrollbarY=Math.max(0,paneHeight-this.viewportHeight);}}
this.top=this.getRowIndex(this.offsetScrollbarY);this.bottom=this.getRowIndex(this.offsetScrollbarY+this.viewportHeight);if(this.bottom===-1){this.bottom=this.boundaries.bottom;}
this.adjustViewportZoneY();}
adjustViewportZoneX(){const sheetId=this.sheetId;this.left=this.searchHeaderIndex("COL",this.offsetScrollbarX,this.boundaries.left);this.right=Math.min(this.boundaries.right,this.searchHeaderIndex("COL",this.viewportWidth,this.left));if(this.left===-1){this.left=this.boundaries.left;}
if(this.right===-1){this.right=this.getters.getNumberCols(sheetId)-1;}
this.offsetX=this.getters.getColDimensions(sheetId,this.left).start-
this.getters.getColDimensions(sheetId,this.boundaries.left).start;}
adjustViewportZoneY(){const sheetId=this.sheetId;this.top=this.searchHeaderIndex("ROW",this.offsetScrollbarY,this.boundaries.top);this.bottom=Math.min(this.boundaries.bottom,this.searchHeaderIndex("ROW",this.viewportHeight,this.top));if(this.top===-1){this.top=this.boundaries.top;}
if(this.bottom===-1){this.bottom=this.getters.getNumberRows(sheetId)-1;}
this.offsetY=this.getters.getRowDimensions(sheetId,this.top).start-
this.getters.getRowDimensions(sheetId,this.boundaries.top).start;}}
class SheetViewPlugin extends UIPlugin{static getters=["getColIndex","getRowIndex","getActiveMainViewport","getSheetViewDimension","getSheetViewDimensionWithHeaders","getMainViewportRect","isVisibleInViewport","getEdgeScrollCol","getEdgeScrollRow","getVisibleFigures","getVisibleRect","getVisibleRectWithoutHeaders","getVisibleCellPositions","getColRowOffsetInViewport","getMainViewportCoordinates","getActiveSheetScrollInfo","getActiveSheetDOMScrollInfo","getSheetViewVisibleCols","getSheetViewVisibleRows","getFrozenSheetViewRatio","isPositionVisible",];viewports={};sheetViewWidth=getDefaultSheetViewSize();sheetViewHeight=getDefaultSheetViewSize();gridOffsetX=0;gridOffsetY=0;sheetsWithDirtyViewports=new Set();shouldAdjustViewports=false;allowDispatch(cmd){switch(cmd.type){case"SET_VIEWPORT_OFFSET":return this.checkScrollingDirection(cmd);case"RESIZE_SHEETVIEW":return this.chainValidations(this.checkValuesAreDifferent,this.checkPositiveDimension)(cmd);default:return"Success";}}
handleEvent(event){const sheetId=this.getters.getActiveSheetId();if(event.options.scrollIntoView){let{col,row}=findCellInNewZone(event.previousAnchor.zone,event.anchor.zone);if(event.mode==="updateAnchor"){const oldZone=event.previousAnchor.zone;const newZone=event.anchor.zone;const{top,bottom,left,right}=this.getMainInternalViewport(sheetId);if(oldZone.left===newZone.left&&oldZone.right===newZone.right){col=left>col||col>right?left:col;}
if(oldZone.top===newZone.top&&oldZone.bottom===newZone.bottom){row=top>row||row>bottom?top:row;}}
col=Math.min(col,this.getters.getNumberCols(sheetId)-1);row=Math.min(row,this.getters.getNumberRows(sheetId)-1);if(!this.sheetsWithDirtyViewports.has(sheetId)){this.refreshViewport(this.getters.getActiveSheetId(),{col,row});}}}
handle(cmd){this.cleanViewports();if(invalidateEvaluationCommands.has(cmd.type)){for(const sheetId of this.getters.getSheetIds()){this.sheetsWithDirtyViewports.add(sheetId);}}
switch(cmd.type){case"START":this.selection.observe(this,{handleEvent:this.handleEvent.bind(this),});this.resetViewports(this.getters.getActiveSheetId());break;case"UNDO":case"REDO":for(const sheetId of this.getters.getSheetIds()){this.sheetsWithDirtyViewports.add(sheetId);}
this.shouldAdjustViewports=true;break;case"RESIZE_SHEETVIEW":this.resizeSheetView(cmd.height,cmd.width,cmd.gridOffsetX,cmd.gridOffsetY);break;case"SET_VIEWPORT_OFFSET":this.setSheetViewOffset(cmd.offsetX,cmd.offsetY);break;case"SHIFT_VIEWPORT_DOWN":const sheetId=this.getters.getActiveSheetId();const{top,viewportHeight,offsetCorrectionY}=this.getMainInternalViewport(sheetId);const topRowDims=this.getters.getRowDimensions(sheetId,top);this.shiftVertically(topRowDims.start+viewportHeight-offsetCorrectionY);break;case"SHIFT_VIEWPORT_UP":{const sheetId=this.getters.getActiveSheetId();const{top,viewportHeight,offsetCorrectionY}=this.getMainInternalViewport(sheetId);const topRowDims=this.getters.getRowDimensions(sheetId,top);this.shiftVertically(topRowDims.end-offsetCorrectionY-viewportHeight);break;}
case"REMOVE_FILTER_TABLE":case"UPDATE_FILTER":this.sheetsWithDirtyViewports.add(cmd.sheetId);break;case"REMOVE_COLUMNS_ROWS":case"RESIZE_COLUMNS_ROWS":case"HIDE_COLUMNS_ROWS":case"ADD_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"UNGROUP_HEADERS":case"GROUP_HEADERS":case"FOLD_HEADER_GROUP":case"UNFOLD_HEADER_GROUP":case"FOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_ALL_HEADER_GROUPS":case"FOLD_ALL_HEADER_GROUPS":{const sheetId="sheetId"in cmd?cmd.sheetId:this.getters.getActiveSheetId();this.sheetsWithDirtyViewports.add(sheetId);break;}
case"UPDATE_CELL":if("content"in cmd||"format"in cmd||cmd.style?.fontSize!==undefined){for(const sheetId of this.getters.getSheetIds()){this.sheetsWithDirtyViewports.add(sheetId);}}
break;case"ACTIVATE_SHEET":this.sheetsWithDirtyViewports.add(cmd.sheetIdTo);break;case"UNFREEZE_ROWS":case"UNFREEZE_COLUMNS":case"FREEZE_COLUMNS":case"FREEZE_ROWS":case"UNFREEZE_COLUMNS_ROWS":this.resetViewports(this.getters.getActiveSheetId());break;case"DELETE_SHEET":this.sheetsWithDirtyViewports.delete(cmd.sheetId);break;case"START_EDITION":const{col,row}=this.getters.getActivePosition();this.refreshViewport(this.getters.getActiveSheetId(),{col,row});break;}}
finalize(){for(const sheetId of this.sheetsWithDirtyViewports){this.resetViewports(sheetId);if(this.shouldAdjustViewports){const position=this.getters.getSheetPosition(sheetId);const viewports=this.getSubViewports(sheetId);Object.values(viewports).forEach((viewport)=>{viewport.adjustPosition(position);});}}
this.sheetsWithDirtyViewports=new Set();this.shouldAdjustViewports=false;this.setViewports();}
setViewports(){const sheetIds=this.getters.getSheetIds();for(const sheetId of sheetIds){if(!this.viewports[sheetId]?.bottomRight){this.resetViewports(sheetId);}}}
getColIndex(x){const sheetId=this.getters.getActiveSheetId();return Math.max(...this.getSubViewports(sheetId).map((viewport)=>viewport.getColIndex(x)));}
getRowIndex(y){const sheetId=this.getters.getActiveSheetId();return Math.max(...this.getSubViewports(sheetId).map((viewport)=>viewport.getRowIndex(y)));}
getSheetViewDimensionWithHeaders(){return{width:this.sheetViewWidth+this.gridOffsetX,height:this.sheetViewHeight+this.gridOffsetY,};}
getSheetViewDimension(){return{width:this.sheetViewWidth,height:this.sheetViewHeight,};}
getActiveMainViewport(){const sheetId=this.getters.getActiveSheetId();return this.getMainViewport(sheetId);}
getActiveSheetScrollInfo(){const sheetId=this.getters.getActiveSheetId();const viewport=this.getMainInternalViewport(sheetId);return{scrollX:viewport.offsetX,scrollY:viewport.offsetY,};}
getActiveSheetDOMScrollInfo(){const sheetId=this.getters.getActiveSheetId();const viewport=this.getMainInternalViewport(sheetId);return{scrollX:viewport.offsetScrollbarX,scrollY:viewport.offsetScrollbarY,};}
getSheetViewVisibleCols(){const sheetId=this.getters.getActiveSheetId();const viewports=this.getSubViewports(sheetId);return[...new Set(viewports.map((v)=>range(v.left,v.right+1)).flat())].filter((col)=>!this.getters.isHeaderHidden(sheetId,"COL",col));}
getSheetViewVisibleRows(){const sheetId=this.getters.getActiveSheetId();const viewports=this.getSubViewports(sheetId);return[...new Set(viewports.map((v)=>range(v.top,v.bottom+1)).flat())].filter((row)=>!this.getters.isHeaderHidden(sheetId,"ROW",row));}
getVisibleCellPositions(){const visibleCols=this.getSheetViewVisibleCols();const visibleRows=this.getSheetViewVisibleRows();const sheetId=this.getters.getActiveSheetId();const positions=[];for(const col of visibleCols){for(const row of visibleRows){const position={sheetId,col,row};const mainPosition=this.getters.getMainCellPosition(position);if(mainPosition.row!==row||mainPosition.col!==col){continue;}
positions.push(position);}}
return positions;}
getMainViewportRect(){const sheetId=this.getters.getActiveSheetId();const viewport=this.getMainInternalViewport(sheetId);const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);let{width,height}=viewport.getMaxSize();const x=this.getters.getColDimensions(sheetId,xSplit).start;const y=this.getters.getRowDimensions(sheetId,ySplit).start;return{x,y,width,height};}
getMaximumSheetOffset(){const sheetId=this.getters.getActiveSheetId();const{width,height}=this.getMainViewportRect();const viewport=this.getMainInternalViewport(sheetId);return{maxOffsetX:Math.max(0,width-viewport.viewportWidth+1),maxOffsetY:Math.max(0,height-viewport.viewportHeight+1),};}
getColRowOffsetInViewport(dimension,referenceIndex,index){const sheetId=this.getters.getActiveSheetId();const visibleCols=this.getters.getSheetViewVisibleCols();const visibleRows=this.getters.getSheetViewVisibleRows();if(index<referenceIndex){return-this.getColRowOffsetInViewport(dimension,index,referenceIndex);}
let offset=0;const visibleIndexes=dimension==="COL"?visibleCols:visibleRows;for(let i=referenceIndex;i<index;i++){if(!visibleIndexes.includes(i)){continue;}
offset+=this.getters.getHeaderSize(sheetId,dimension,i);}
return offset;}
isVisibleInViewport({sheetId,col,row}){return this.getSubViewports(sheetId).some((pane)=>pane.isVisible(col,row));}
getEdgeScrollCol(x,previousX,startingX){let canEdgeScroll=false;let direction=0;let delay=0;const{xSplit}=this.getters.getPaneDivisions(this.getters.getActiveSheetId());const{width}=this.getSheetViewDimension();const{x:offsetCorrectionX}=this.getMainViewportCoordinates();const currentOffsetX=this.getActiveSheetScrollInfo().scrollX;if(x>width){canEdgeScroll=true;delay=scrollDelay(x-width);direction=1;}
else if(x<offsetCorrectionX&&startingX>=offsetCorrectionX&&currentOffsetX>0){canEdgeScroll=true;delay=scrollDelay(offsetCorrectionX-x);direction=-1;}
else if(xSplit&&previousX<offsetCorrectionX&&x>offsetCorrectionX){canEdgeScroll=true;delay=scrollDelay(x);direction="reset";}
return{canEdgeScroll,direction,delay};}
getEdgeScrollRow(y,previousY,tartingY){let canEdgeScroll=false;let direction=0;let delay=0;const{ySplit}=this.getters.getPaneDivisions(this.getters.getActiveSheetId());const{height}=this.getSheetViewDimension();const{y:offsetCorrectionY}=this.getMainViewportCoordinates();const currentOffsetY=this.getActiveSheetScrollInfo().scrollY;if(y>height){canEdgeScroll=true;delay=scrollDelay(y-height);direction=1;}
else if(y<offsetCorrectionY&&tartingY>=offsetCorrectionY&&currentOffsetY>0){canEdgeScroll=true;delay=scrollDelay(offsetCorrectionY-y);direction=-1;}
else if(ySplit&&previousY<offsetCorrectionY&&y>offsetCorrectionY){canEdgeScroll=true;delay=scrollDelay(y);direction="reset";}
return{canEdgeScroll,direction,delay};}
getVisibleRect(zone){const rect=this.getVisibleRectWithoutHeaders(zone);return{...rect,x:rect.x+this.gridOffsetX,y:rect.y+this.gridOffsetY};}
getVisibleRectWithoutHeaders(zone){const sheetId=this.getters.getActiveSheetId();const viewportRects=this.getSubViewports(sheetId).map((viewport)=>viewport.getRect(zone)).filter(isDefined$1);if(viewportRects.length===0){return{x:0,y:0,width:0,height:0};}
const x=Math.min(...viewportRects.map((rect)=>rect.x));const y=Math.min(...viewportRects.map((rect)=>rect.y));const width=Math.max(...viewportRects.map((rect)=>rect.x+rect.width))-x;const height=Math.max(...viewportRects.map((rect)=>rect.y+rect.height))-y;return{x,y,width,height};}
getMainViewportCoordinates(){const sheetId=this.getters.getActiveSheetId();const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);const x=this.getters.getColDimensions(sheetId,xSplit).start;const y=this.getters.getRowDimensions(sheetId,ySplit).start;return{x,y};}
ensureMainViewportExist(sheetId){if(!this.viewports[sheetId]){this.resetViewports(sheetId);}}
getSubViewports(sheetId){this.ensureMainViewportExist(sheetId);return Object.values(this.viewports[sheetId]).filter(isDefined$1);}
checkPositiveDimension(cmd){if(cmd.width<0||cmd.height<0){return"InvalidViewportSize";}
return"Success";}
checkValuesAreDifferent(cmd){const{height,width}=this.getSheetViewDimension();if(cmd.gridOffsetX===this.gridOffsetX&&cmd.gridOffsetY===this.gridOffsetY&&cmd.width===width&&cmd.height===height){return"ValuesNotChanged";}
return"Success";}
checkScrollingDirection({offsetX,offsetY,}){const pane=this.getMainInternalViewport(this.getters.getActiveSheetId());if((!pane.canScrollHorizontally&&offsetX>0)||(!pane.canScrollVertically&&offsetY>0)){return"InvalidScrollingDirection";}
return"Success";}
getMainViewport(sheetId){const viewport=this.getMainInternalViewport(sheetId);return{top:viewport.top,left:viewport.left,bottom:viewport.bottom,right:viewport.right,};}
getMainInternalViewport(sheetId){this.ensureMainViewportExist(sheetId);return this.viewports[sheetId].bottomRight;}
cleanViewports(){const sheetIds=this.getters.getSheetIds();for(let sheetId of Object.keys(this.viewports)){if(!sheetIds.includes(sheetId)){delete this.viewports[sheetId];}}}
resizeSheetView(height,width,gridOffsetX=0,gridOffsetY=0){this.sheetViewHeight=height;this.sheetViewWidth=width;this.gridOffsetX=gridOffsetX;this.gridOffsetY=gridOffsetY;this.recomputeViewports();}
recomputeViewports(){for(let sheetId of Object.keys(this.viewports)){this.resetViewports(sheetId);}}
setSheetViewOffset(offsetX,offsetY){const sheetId=this.getters.getActiveSheetId();const{maxOffsetX,maxOffsetY}=this.getMaximumSheetOffset();Object.values(this.getSubViewports(sheetId)).forEach((viewport)=>viewport.setViewportOffset(clip(offsetX,0,maxOffsetX),clip(offsetY,0,maxOffsetY)));}
getViewportOffset(sheetId){return{x:this.viewports[sheetId]?.bottomRight.offsetScrollbarX||0,y:this.viewports[sheetId]?.bottomRight.offsetScrollbarY||0,};}
resetViewports(sheetId){if(!this.getters.tryGetSheet(sheetId)){return;}
const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);const nCols=this.getters.getNumberCols(sheetId);const nRows=this.getters.getNumberRows(sheetId);const colOffset=this.getters.getColRowOffset("COL",0,xSplit,sheetId);const rowOffset=this.getters.getColRowOffset("ROW",0,ySplit,sheetId);const{xRatio,yRatio}=this.getFrozenSheetViewRatio(sheetId);const canScrollHorizontally=xRatio<1.0;const canScrollVertically=yRatio<1.0;const previousOffset=this.getViewportOffset(sheetId);const sheetViewports={topLeft:(ySplit&&xSplit&&new InternalViewport(this.getters,sheetId,{left:0,right:xSplit-1,top:0,bottom:ySplit-1},{width:colOffset,height:rowOffset},{canScrollHorizontally:false,canScrollVertically:false},{x:0,y:0}))||undefined,topRight:(ySplit&&new InternalViewport(this.getters,sheetId,{left:xSplit,right:nCols-1,top:0,bottom:ySplit-1},{width:this.sheetViewWidth-colOffset,height:rowOffset},{canScrollHorizontally,canScrollVertically:false},{x:canScrollHorizontally?previousOffset.x:0,y:0}))||undefined,bottomLeft:(xSplit&&new InternalViewport(this.getters,sheetId,{left:0,right:xSplit-1,top:ySplit,bottom:nRows-1},{width:colOffset,height:this.sheetViewHeight-rowOffset},{canScrollHorizontally:false,canScrollVertically},{x:0,y:canScrollVertically?previousOffset.y:0}))||undefined,bottomRight:new InternalViewport(this.getters,sheetId,{left:xSplit,right:nCols-1,top:ySplit,bottom:nRows-1},{width:this.sheetViewWidth-colOffset,height:this.sheetViewHeight-rowOffset,},{canScrollHorizontally,canScrollVertically},{x:canScrollHorizontally?previousOffset.x:0,y:canScrollVertically?previousOffset.y:0,}),};this.viewports[sheetId]=sheetViewports;}
refreshViewport(sheetId,anchorPosition){Object.values(this.getSubViewports(sheetId)).forEach((viewport)=>{viewport.adjustViewportZone();viewport.adjustPosition(anchorPosition);});}
shiftVertically(offset){const sheetId=this.getters.getActiveSheetId();const{top}=this.getMainInternalViewport(sheetId);const{scrollX}=this.getActiveSheetScrollInfo();this.setSheetViewOffset(scrollX,offset);const{anchor}=this.getters.getSelection();if(anchor.cell.row>=this.getters.getPaneDivisions(sheetId).ySplit){const deltaRow=this.getMainInternalViewport(sheetId).top-top;this.selection.selectCell(anchor.cell.col,anchor.cell.row+deltaRow);}}
getVisibleFigures(){const sheetId=this.getters.getActiveSheetId();const result=[];const figures=this.getters.getFigures(sheetId);const{scrollX,scrollY}=this.getActiveSheetScrollInfo();const{x:offsetCorrectionX,y:offsetCorrectionY}=this.getters.getMainViewportCoordinates();const{width,height}=this.getters.getSheetViewDimensionWithHeaders();for(const figure of figures){if(figure.x>=offsetCorrectionX&&(figure.x+figure.width<=offsetCorrectionX+scrollX||figure.x>=width+scrollX+offsetCorrectionX)){continue;}
if(figure.y>=offsetCorrectionY&&(figure.y+figure.height<=offsetCorrectionY+scrollY||figure.y>=height+scrollY+offsetCorrectionY)){continue;}
result.push(figure);}
return result;}
isPositionVisible(position){const{scrollX,scrollY}=this.getters.getActiveSheetScrollInfo();const{x:mainViewportX,y:mainViewportY}=this.getters.getMainViewportCoordinates();const{width,height}=this.getters.getSheetViewDimension();if(position.x>=mainViewportX&&(position.x<mainViewportX+scrollX||position.x>width+scrollX+mainViewportX)){return false;}
if(position.y>=mainViewportY&&(position.y<mainViewportY+scrollY||position.y>height+scrollY+mainViewportY)){return false;}
return true;}
getFrozenSheetViewRatio(sheetId){const{xSplit,ySplit}=this.getters.getPaneDivisions(sheetId);const offsetCorrectionX=this.getters.getColDimensions(sheetId,xSplit).start;const offsetCorrectionY=this.getters.getRowDimensions(sheetId,ySplit).start;const width=this.sheetViewWidth+this.gridOffsetX;const height=this.sheetViewHeight+this.gridOffsetY;return{xRatio:offsetCorrectionX/width,yRatio:offsetCorrectionY/height};}}
class HeaderPositionsUIPlugin extends UIPlugin{static getters=["getColDimensions","getRowDimensions","getColRowOffset"];headerPositions={};isDirty=true;handle(cmd){if(invalidateEvaluationCommands.has(cmd.type)){this.headerPositions={};this.isDirty=true;}
switch(cmd.type){case"START":for(const sheetId of this.getters.getSheetIds()){this.headerPositions[sheetId]=this.computeHeaderPositionsOfSheet(sheetId);}
break;case"UPDATE_CELL":this.headerPositions={};this.isDirty=true;break;case"UPDATE_FILTER":case"REMOVE_FILTER_TABLE":this.headerPositions={};this.isDirty=true;break;case"REMOVE_COLUMNS_ROWS":case"RESIZE_COLUMNS_ROWS":case"HIDE_COLUMNS_ROWS":case"ADD_COLUMNS_ROWS":case"UNHIDE_COLUMNS_ROWS":case"FOLD_HEADER_GROUP":case"UNFOLD_HEADER_GROUP":case"FOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_HEADER_GROUPS_IN_ZONE":case"UNFOLD_ALL_HEADER_GROUPS":case"FOLD_ALL_HEADER_GROUPS":case"UNGROUP_HEADERS":case"GROUP_HEADERS":case"CREATE_SHEET":this.headerPositions[cmd.sheetId]=this.computeHeaderPositionsOfSheet(cmd.sheetId);break;case"DUPLICATE_SHEET":this.headerPositions[cmd.sheetIdTo]=deepCopy(this.headerPositions[cmd.sheetId]);break;}}
finalize(){if(this.isDirty){for(const sheetId of this.getters.getSheetIds()){this.headerPositions[sheetId]=this.computeHeaderPositionsOfSheet(sheetId);}
this.isDirty=false;}}
getColDimensions(sheetId,col){const start=this.headerPositions[sheetId]["COL"][col];const size=this.getters.getColSize(sheetId,col);const isColHidden=this.getters.isColHidden(sheetId,col);return{start,size,end:start+(isColHidden?0:size),};}
getRowDimensions(sheetId,row){const start=this.headerPositions[sheetId]["ROW"][row];const size=this.getters.getRowSize(sheetId,row);const isRowHidden=this.getters.isRowHidden(sheetId,row);return{start,size:size,end:start+(isRowHidden?0:size),};}
getColRowOffset(dimension,referenceIndex,index,sheetId=this.getters.getActiveSheetId()){const referencePosition=this.headerPositions[sheetId][dimension][referenceIndex];const position=this.headerPositions[sheetId][dimension][index];return position-referencePosition;}
computeHeaderPositionsOfSheet(sheetId){return{COL:this.computePositions(sheetId,"COL"),ROW:this.computePositions(sheetId,"ROW"),};}
computePositions(sheetId,dimension){const positions={};let offset=0;for(let i=0;i<this.getters.getNumberHeaders(sheetId,dimension)+1;i++){positions[i]=offset;if(this.getters.isHeaderHidden(sheetId,dimension,i)){continue;}
offset+=this.getters.getHeaderSize(sheetId,dimension,i);}
return positions;}}
const corePluginRegistry=new Registry().add("settings",SettingsPlugin).add("sheet",SheetPlugin).add("header grouping",HeaderGroupingPlugin).add("header visibility",HeaderVisibilityPlugin).add("filters",FiltersPlugin).add("cell",CellPlugin).add("merge",MergePlugin).add("headerSize",HeaderSizePlugin).add("borders",BordersPlugin).add("conditional formatting",ConditionalFormatPlugin).add("figures",FigurePlugin).add("chart",ChartPlugin).add("image",ImagePlugin).add("dataValidation",DataValidationPlugin);const featurePluginRegistry=new Registry().add("ui_sheet",SheetUIPlugin).add("ui_options",UIOptionsPlugin).add("selectionInputManager",SelectionInputsManagerPlugin).add("highlight",HighlightPlugin).add("grid renderer",RendererPlugin).add("autofill",AutofillPlugin).add("find_and_replace",FindAndReplacePlugin).add("sort",SortPlugin).add("automatic_sum",AutomaticSumPlugin).add("format",FormatPlugin).add("split_to_columns",SplitToColumnsPlugin).add("cell_popovers",CellPopoverPlugin).add("collaborative",CollaborativePlugin).add("history",HistoryPlugin).add("data_cleanup",DataCleanupPlugin);const statefulUIPluginRegistry=new Registry().add("selection",GridSelectionPlugin).add("evaluation_filter",FilterEvaluationPlugin).add("header_visibility_ui",HeaderVisibilityUIPlugin).add("header_positions",HeaderPositionsUIPlugin).add("viewport",SheetViewPlugin).add("clipboard",ClipboardPlugin).add("edition",EditionPlugin);const coreViewsPluginRegistry=new Registry().add("evaluation",EvaluationPlugin).add("evaluation_chart",EvaluationChartPlugin).add("evaluation_cf",EvaluationConditionalFormatPlugin).add("row_size",HeaderSizeUIPlugin).add("custom_colors",CustomColorsPlugin).add("data_validation_ui",EvaluationDataValidationPlugin);const clickableCellRegistry=new Registry();clickableCellRegistry.add("link",{condition:(position,env)=>!!env.model.getters.getEvaluatedCell(position).link,execute:(position,env)=>openLink(env.model.getters.getEvaluatedCell(position).link,env),sequence:5,});class ImageProvider{fileStore;constructor(fileStore){this.fileStore=fileStore;}
async requestImage(){const file=await this.getImageFromUser();const path=await this.fileStore.upload(file);const size=await this.getImageOriginalSize(path);return{path,size,mimetype:file.type};}
getImageFromUser(){return new Promise((resolve,reject)=>{const input=document.createElement("input");input.setAttribute("type","file");input.setAttribute("accept","image/*");input.addEventListener("change",async()=>{if(input.files===null||input.files.length!=1){reject();}
else{resolve(input.files[0]);}});input.click();});}
getImageOriginalSize(path){return new Promise((resolve,reject)=>{const image=new Image();image.src=path;image.addEventListener("load",()=>{const size={width:image.width,height:image.height};resolve(size);});image.addEventListener("error",reject);});}}
class FocusableElement{focusableElement=undefined;setFocusableElement(element){this.focusableElement=element;}
focus(){this.focusableElement?.focus();}}
const RIPPLE_KEY_FRAMES=[{transform:"scale(0)"},{transform:"scale(0.8)",offset:0.33},{opacity:"0",transform:"scale(1)",offset:1},];css`
  .o-ripple {
    z-index: 1;
  }
`;class RippleEffect extends owl.Component{static template="o-spreadsheet-RippleEffect";rippleRef=owl.useRef("ripple");setup(){let animation=undefined;owl.onMounted(()=>{const rippleEl=this.rippleRef.el;if(!rippleEl||!rippleEl.animate)
return;animation=rippleEl.animate(RIPPLE_KEY_FRAMES,{duration:this.props.duration,easing:"ease-out",});animation.addEventListener("finish",this.props.onAnimationEnd);});owl.onWillUnmount(()=>{animation?.removeEventListener("finish",this.props.onAnimationEnd);});}
get rippleStyle(){const{x,y,width,height}=this.props;const offsetX=this.props.offsetX||0;const offsetY=this.props.offsetY||0;return cssPropertiesToCss({transform:"scale(0)",left:x,top:y,"margin-left":`${-width / 2 + offsetX}px`,"margin-top":`${-height / 2 + offsetY}px`,width:`${width}px`,height:`${height}px`,background:this.props.color,"border-radius":"100%",opacity:`${this.props.opacity}`,});}}
RippleEffect.props={x:String,y:String,color:String,opacity:Number,duration:Number,width:Number,height:Number,offsetY:Number,offsetX:Number,allowOverflow:Boolean,onAnimationEnd:Function,style:String,};class Ripple extends owl.Component{static template="o-spreadsheet-Ripple";static components={RippleEffect};static defaultProps={color:"#aaaaaa",opacity:0.4,duration:800,enabled:true,onAnimationEnd:()=>{},class:"",};childContainer=owl.useRef("childContainer");state=owl.useState({ripples:[]});currentId=1;onClick(ev){if(!this.props.enabled)
return;const containerEl=this.childContainer.el;if(!containerEl)
return;const rect=this.getRippleChildRectInfo();const{x,y,width,height}=rect;const maxDim=Math.max(width,height);const rippleRect={x:ev.clientX-x,y:ev.clientY-y,width:this.props.width||maxDim*2.85,height:this.props.height||maxDim*2.85,};this.state.ripples.push({rippleRect,id:this.currentId++});}
getRippleStyle(){const containerEl=this.childContainer.el;if(!containerEl||containerEl.childElementCount!==1||!containerEl.firstElementChild){return"";}
const rect=this.getRippleChildRectInfo();return cssPropertiesToCss({top:rect.marginTop+"px",left:rect.marginLeft+"px",width:rect.width+"px",height:rect.height+"px",});}
getRippleChildRectInfo(){const el=this.childContainer.el;if(!el)
throw new Error("No child container element found");if(el.childElementCount!==1||!el.firstElementChild){const boundingRect=getBoundingRectAsPOJO(el);return{...boundingRect,marginLeft:0,marginTop:0};}
const childEl=el.firstElementChild;const margins=getElementMargins(childEl);const boundingRect=getBoundingRectAsPOJO(childEl);return{...boundingRect,marginLeft:margins.left,marginTop:margins.top,};}
removeRipple(id){const index=this.state.ripples.findIndex((r)=>r.id===id);if(index===-1)
return;this.state.ripples.splice(index,1);}
getRippleEffectProps(id){const rect=this.state.ripples.find((r)=>r.id===id)?.rippleRect;if(!rect)
throw new Error("Cannot find a ripple with the id "+id);return{color:this.props.color,opacity:this.props.opacity,duration:this.props.duration,x:this.props.ignoreClickPosition?"50%":rect.x+"px",y:this.props.ignoreClickPosition?"50%":rect.y+"px",width:rect.width,height:rect.height,offsetX:this.props.offsetX||0,offsetY:this.props.offsetY||0,allowOverflow:this.props.allowOverflow||false,style:this.getRippleStyle(),onAnimationEnd:()=>this.removeRipple(id),};}}
Ripple.props={color:{type:String,optional:true},opacity:{type:Number,optional:true},duration:{type:Number,optional:true},ignoreClickPosition:{type:Boolean,optional:true},width:{type:Number,optional:true},height:{type:Number,optional:true},offsetY:{type:Number,optional:true},offsetX:{type:Number,optional:true},allowOverflow:{type:Boolean,optional:true},enabled:{type:Boolean,optional:true},onAnimationEnd:{type:Function,optional:true},slots:Object,class:{type:String,optional:true},};function interactiveRenameSheet(env,sheetId,name,errorCallback){const result=env.model.dispatch("RENAME_SHEET",{sheetId,name});if(result.reasons.includes("MissingSheetName")){env.raiseError(_t("The sheet name cannot be empty."),errorCallback);}
else if(result.reasons.includes("DuplicatedSheetName")){env.raiseError(_t("A sheet with the name %s already exists. Please select another name.",name),errorCallback);}
else if(result.reasons.includes("ForbiddenCharactersInSheetName")){env.raiseError(_t("Some used characters are not allowed in a sheet name (Forbidden characters are %s).",FORBIDDEN_SHEET_CHARS.join(" ")),errorCallback);}}
css`
  .o-sheet {
    padding: 0 15px;
    padding-right: 10px;
    height: ${BOTTOMBAR_HEIGHT}px;
    border-left: 1px solid #c1c1c1;
    border-right: 1px solid #c1c1c1;
    margin-left: -1px;
    cursor: pointer;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08);
    }

    &.active {
      color: #484;
      background-color: #ffffff;
      box-shadow: 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    }

    .o-sheet-icon {
      z-index: 1;

      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    .o-sheet-name {
      outline: none;
      padding: 2px 4px;

      &.o-sheet-name-editable {
        border-radius: 2px;
        border: 2px solid mediumblue;
        /* negative margins so nothing moves when the border is added */
        margin-left: -2px;
        margin-right: -2px;
      }
    }
  }
`;class BottomBarSheet extends owl.Component{static template="o-spreadsheet-BottomBarSheet";static components={Ripple};static defaultProps={onMouseDown:()=>{},style:"",};state=owl.useState({isEditing:false});sheetDivRef=owl.useRef("sheetDiv");sheetNameRef=owl.useRef("sheetNameSpan");editionState="initializing";setup(){owl.onMounted(()=>{if(this.isSheetActive){this.scrollToSheet();}});owl.onPatched(()=>{if(this.sheetNameRef.el&&this.state.isEditing&&this.editionState==="initializing"){this.editionState="editing";this.focusInputAndSelectContent();}});}
focusInputAndSelectContent(){if(!this.state.isEditing||!this.sheetNameRef.el)
return;this.sheetNameRef.el.focus();const selection=window.getSelection();if(selection&&this.sheetNameRef.el.firstChild){selection.setBaseAndExtent(this.sheetNameRef.el.firstChild,0,this.sheetNameRef.el.firstChild,this.sheetNameRef.el.textContent?.length||0);}}
scrollToSheet(){this.sheetDivRef.el?.scrollIntoView?.();}
onFocusOut(){if(this.state.isEditing&&this.editionState!=="initializing"){this.stopEdition();}}
onMouseDown(ev){this.activateSheet();this.props.onMouseDown(ev);}
activateSheet(){this.env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:this.env.model.getters.getActiveSheetId(),sheetIdTo:this.props.sheetId,});this.scrollToSheet();}
onDblClick(){if(this.env.model.getters.isReadonly()){return;}
this.startEdition();}
onKeyDown(ev){if(!this.state.isEditing)
return;if(ev.key==="Enter"){ev.preventDefault();this.stopEdition();this.env.focusableElement.focus();}
if(ev.key==="Escape"){this.cancelEdition();this.env.focusableElement.focus();}}
onClickSheetName(ev){if(this.state.isEditing)
ev.stopPropagation();}
startEdition(){this.state.isEditing=true;this.editionState="initializing";}
stopEdition(){const input=this.sheetNameRef.el;if(!this.state.isEditing||!input)
return;this.state.isEditing=false;this.editionState="initializing";input.blur();const inputValue=this.getInputContent()||"";input.innerText=inputValue;interactiveRenameSheet(this.env,this.props.sheetId,inputValue,()=>this.startEdition());}
cancelEdition(){this.state.isEditing=false;this.editionState="initializing";this.sheetNameRef.el?.blur();this.setInputContent(this.sheetName);}
onIconClick(ev){if(!this.isSheetActive){this.activateSheet();}
this.props.openContextMenu(this.contextMenuRegistry,ev);}
onContextMenu(ev){if(!this.isSheetActive){this.activateSheet();}
this.props.openContextMenu(this.contextMenuRegistry,ev);}
getInputContent(){return this.sheetNameRef.el?.textContent;}
setInputContent(content){if(this.sheetNameRef.el)
this.sheetNameRef.el.textContent=content;}
get contextMenuRegistry(){return getSheetMenuRegistry({renameSheetCallback:()=>{this.scrollToSheet();this.startEdition();},});}
get isSheetActive(){return this.env.model.getters.getActiveSheetId()===this.props.sheetId;}
get sheetName(){return this.env.model.getters.getSheetName(this.props.sheetId);}}
BottomBarSheet.props={sheetId:String,openContextMenu:Function,style:{type:String,optional:true},onMouseDown:{type:Function,optional:true},};css`
  .o-selection-statistic {
    margin-right: 20px;
    padding: 4px 4px 4px 8px;
    color: #333;
    cursor: pointer;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08) !important;
    }
  }
`;class BottomBarStatistic extends owl.Component{static template="o-spreadsheet-BottomBarStatisic";static components={Ripple};selectedStatisticFn="";statisticFnResults={};setup(){this.statisticFnResults=this.env.model.getters.getStatisticFnResults();owl.onWillUpdateProps(()=>{const newStatisticFnResults=this.env.model.getters.getStatisticFnResults();if(!deepEquals(newStatisticFnResults,this.statisticFnResults)){this.props.closeContextMenu();}
this.statisticFnResults=newStatisticFnResults;});}
getSelectedStatistic(){if(Object.values(this.statisticFnResults).every((result)=>result===undefined)){return undefined;}
if(this.selectedStatisticFn===""){this.selectedStatisticFn=Object.keys(this.statisticFnResults)[0];}
return this.getComposedFnName(this.selectedStatisticFn,this.statisticFnResults[this.selectedStatisticFn]);}
listSelectionStatistics(ev){const registry=new MenuItemRegistry();let i=0;for(let[fnName,fnValue]of Object.entries(this.statisticFnResults)){registry.add(fnName,{name:this.getComposedFnName(fnName,fnValue),sequence:i,isReadonlyAllowed:true,execute:()=>{this.selectedStatisticFn=fnName;},});i++;}
const target=ev.currentTarget;const{top,left,width}=target.getBoundingClientRect();this.props.openContextMenu(left+width,top,registry);}
getComposedFnName(fnName,fnValue){const locale=this.env.model.getters.getLocale();return fnName+": "+(fnValue!==undefined?formatValue(fnValue,{locale}):"__");}}
BottomBarStatistic.props={openContextMenu:Function,closeContextMenu:Function,};const MENU_MAX_HEIGHT=250;css`
  .o-spreadsheet-bottom-bar {
    color: ${TEXT_HEADER_COLOR};
    background-color: ${BACKGROUND_GRAY_COLOR};
    padding-left: ${HEADER_WIDTH}px;
    font-size: 15px;
    border-top: 1px solid lightgrey;

    .o-sheet-item {
      cursor: pointer;
      &:hover {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }

    .o-all-sheets {
      max-width: 70%;
      .o-bottom-bar-fade-out {
        background-image: linear-gradient(-90deg, #cfcfcf, transparent 1%);
      }

      .o-bottom-bar-fade-in {
        background-image: linear-gradient(90deg, #cfcfcf, transparent 1%);
      }
    }

    .o-bottom-bar-arrows {
      .o-bottom-bar-arrow {
        cursor: pointer;
        &:hover:not([class*="o-disabled"]) {
          .o-icon {
            opacity: 0.9;
          }
        }

        .o-icon {
          height: 18px;
          width: 18px;
        }
      }
    }
  }
`;class BottomBar extends owl.Component{static template="o-spreadsheet-BottomBar";static components={Menu,Ripple,BottomBarSheet,BottomBarStatistic};bottomBarRef=owl.useRef("bottomBar");sheetListRef=owl.useRef("sheetList");dragAndDrop=useDragAndDropListItems();targetScroll=undefined;state=owl.useState({isSheetListScrollableLeft:false,isSheetListScrollableRight:false,});menuMaxHeight=MENU_MAX_HEIGHT;menuState=owl.useState({isOpen:false,menuId:undefined,position:null,menuItems:[],});sheetList=this.getVisibleSheets();setup(){owl.onWillUpdateProps(()=>{this.updateScrollState();const visibleSheets=this.getVisibleSheets();if(!deepEquals(this.sheetList,visibleSheets)){this.dragAndDrop.cancel();}
this.sheetList=visibleSheets;});}
clickAddSheet(ev){const activeSheetId=this.env.model.getters.getActiveSheetId();const position=this.env.model.getters.getSheetIds().findIndex((sheetId)=>sheetId===activeSheetId)+1;const sheetId=this.env.model.uuidGenerator.uuidv4();const name=this.env.model.getters.getNextSheetName(_t("Sheet"));this.env.model.dispatch("CREATE_SHEET",{sheetId,position,name});this.env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:activeSheetId,sheetIdTo:sheetId});}
getVisibleSheets(){return this.env.model.getters.getVisibleSheetIds().map((sheetId)=>{const sheet=this.env.model.getters.getSheet(sheetId);return{id:sheet.id,name:sheet.name};});}
clickListSheets(ev){const registry=new MenuItemRegistry();const from=this.env.model.getters.getActiveSheetId();let i=0;for(const sheetId of this.env.model.getters.getSheetIds()){const sheet=this.env.model.getters.getSheet(sheetId);registry.add(sheetId,{name:sheet.name,sequence:i,isReadonlyAllowed:true,textColor:sheet.isVisible?undefined:"grey",execute:(env)=>{env.model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:from,sheetIdTo:sheetId});},});i++;}
const target=ev.currentTarget;const{left}=target.getBoundingClientRect();const top=this.bottomBarRef.el.getBoundingClientRect().top;this.openContextMenu(left,top,"listSheets",registry);}
openContextMenu(x,y,menuId,registry){this.menuState.isOpen=true;this.menuState.menuId=menuId;this.menuState.menuItems=registry.getMenuItems();this.menuState.position={x,y};}
onSheetContextMenu(sheetId,registry,ev){const target=ev.currentTarget;const{top,left}=target.getBoundingClientRect();if(ev.closedMenuId===sheetId){this.closeMenu();return;}
this.openContextMenu(left,top,sheetId,registry);}
closeMenu(){this.menuState.isOpen=false;this.menuState.menuId=undefined;this.menuState.menuItems=[];this.menuState.position=null;}
closeContextMenuWithId(menuId){if(this.menuState.menuId===menuId){this.closeMenu();}}
onWheel(ev){this.targetScroll=undefined;const target=ev.currentTarget;target.scrollLeft+=ev.deltaY*0.5;}
onScroll(){this.updateScrollState();if(this.targetScroll===this.sheetListCurrentScroll){this.targetScroll=undefined;}}
onArrowLeft(ev){if(!this.state.isSheetListScrollableLeft)
return;if(!this.targetScroll)
this.targetScroll=this.sheetListCurrentScroll;const newScroll=this.targetScroll-this.sheetListWidth;this.scrollSheetListTo(Math.max(0,newScroll));}
onArrowRight(ev){if(!this.state.isSheetListScrollableRight)
return;if(!this.targetScroll)
this.targetScroll=this.sheetListCurrentScroll;const newScroll=this.targetScroll+this.sheetListWidth;this.scrollSheetListTo(Math.min(this.sheetListMaxScroll,newScroll));}
updateScrollState(){this.state.isSheetListScrollableLeft=this.sheetListCurrentScroll>0;this.state.isSheetListScrollableRight=this.sheetListCurrentScroll<this.sheetListMaxScroll;}
scrollSheetListTo(scroll){if(!this.sheetListRef.el)
return;this.targetScroll=scroll;this.sheetListRef.el.scrollTo({top:0,left:scroll,behavior:"smooth"});}
onSheetMouseDown(sheetId,event){if(event.button!==0||this.env.model.getters.isReadonly())
return;this.closeMenu();const visibleSheets=this.getVisibleSheets();const sheetRects=this.getSheetItemRects();const sheets=visibleSheets.map((sheet,index)=>({id:sheet.id,size:sheetRects[index].width,position:sheetRects[index].x,}));this.dragAndDrop.start("horizontal",{draggedItemId:sheetId,initialMousePosition:event.clientX,items:sheets,containerEl:this.sheetListRef.el,onDragEnd:(sheetId,finalIndex)=>this.onDragEnd(sheetId,finalIndex),});}
onDragEnd(sheetId,finalIndex){const originalIndex=this.getVisibleSheets().findIndex((sheet)=>sheet.id===sheetId);const delta=finalIndex-originalIndex;if(sheetId&&delta!==0){this.env.model.dispatch("MOVE_SHEET",{sheetId:sheetId,delta:delta,});}}
getSheetStyle(sheetId){return this.dragAndDrop.itemsStyle[sheetId]||"";}
getSheetItemRects(){return Array.from(this.bottomBarRef.el.querySelectorAll(`.o-sheet`)).map((sheetEl)=>sheetEl.getBoundingClientRect()).map((rect)=>({x:rect.x,width:rect.width-1,y:rect.y,height:rect.height,}));}
get sheetListCurrentScroll(){if(!this.sheetListRef.el)
return 0;return this.sheetListRef.el.scrollLeft;}
get sheetListWidth(){if(!this.sheetListRef.el)
return 0;return this.sheetListRef.el.clientWidth;}
get sheetListMaxScroll(){if(!this.sheetListRef.el)
return 0;return this.sheetListRef.el.scrollWidth-this.sheetListRef.el.clientWidth;}}
BottomBar.props={onClick:Function,};css`
  .o-dashboard-clickable-cell {
    position: absolute;
    cursor: pointer;
  }
`;class SpreadsheetDashboard extends owl.Component{static template="o-spreadsheet-SpreadsheetDashboard";static components={GridOverlay,GridPopover,Popover,VerticalScrollBar,HorizontalScrollBar,FilterIconsOverlay,};onMouseWheel;canvasPosition;hoveredCell;setup(){const gridRef=owl.useRef("grid");this.canvasPosition=useAbsoluteBoundingRect(gridRef);this.hoveredCell=owl.useState({col:undefined,row:undefined});owl.useChildSubEnv({getPopoverContainerRect:()=>this.getGridRect()});useGridDrawing("canvas",this.env.model,()=>this.env.model.getters.getSheetViewDimension());this.onMouseWheel=useWheelHandler((deltaX,deltaY)=>{this.moveCanvas(deltaX,deltaY);this.hoveredCell.col=undefined;this.hoveredCell.row=undefined;});}
onCellHovered({col,row}){this.hoveredCell.col=col;this.hoveredCell.row=row;}
get gridContainer(){const sheetId=this.env.model.getters.getActiveSheetId();const{right}=this.env.model.getters.getSheetZone(sheetId);const{end}=this.env.model.getters.getColDimensions(sheetId,right);return cssPropertiesToCss({"max-width":`${end}px`});}
get gridOverlayDimensions(){return cssPropertiesToCss({height:"100%",width:"100%",});}
getCellClickableStyle(coordinates){return cssPropertiesToCss({top:`${coordinates.y}px`,left:`${coordinates.x}px`,width:`${coordinates.width}px`,height:`${coordinates.height}px`,});}
getClickableCells(){const cells=[];const sheetId=this.env.model.getters.getActiveSheetId();for(const col of this.env.model.getters.getSheetViewVisibleCols()){for(const row of this.env.model.getters.getSheetViewVisibleRows()){const position={sheetId,col,row};const action=this.getClickableAction(position);if(!action){continue;}
let zone;if(this.env.model.getters.isInMerge(position)){zone=this.env.model.getters.getMerge(position);}
else{zone=positionToZone({col,row});}
const rect=this.env.model.getters.getVisibleRect(zone);cells.push({coordinates:rect,position:{col,row},action,});}}
return cells;}
getClickableAction(position){for(const items of clickableCellRegistry.getAll().sort((a,b)=>a.sequence-b.sequence)){if(items.condition(position,this.env)){return items.execute;}}
return false;}
selectClickableCell(clickableCell){const{position,action}=clickableCell;action({...position,sheetId:this.env.model.getters.getActiveSheetId()},this.env);}
onClosePopover(){this.env.model.dispatch("CLOSE_CELL_POPOVER");}
onGridResized({height,width}){this.env.model.dispatch("RESIZE_SHEETVIEW",{width:width,height:height,gridOffsetX:0,gridOffsetY:0,});}
moveCanvas(deltaX,deltaY){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetDOMScrollInfo();this.env.model.dispatch("SET_VIEWPORT_OFFSET",{offsetX:scrollX+deltaX,offsetY:scrollY+deltaY,});}
getGridRect(){return{...this.canvasPosition,...this.env.model.getters.getSheetViewDimensionWithHeaders()};}}
SpreadsheetDashboard.props={};css`
  .o-header-group {
    .o-header-group-header {
      z-index: ${ComponentsImportance.HeaderGroupingButton};
      .o-group-fold-button {
        cursor: pointer;
        width: 13px;
        height: 13px;
        border: 1px solid ${HEADER_GROUPING_BORDER_COLOR};
        .o-icon {
          width: 7px;
          height: 7px;
        }

        &:hover {
          border-color: #777;
        }
      }
    }
    .o-group-border {
      box-sizing: border-box;
    }
  }
`;class AbstractHeaderGroup extends owl.Component{static template="o-spreadsheet-HeaderGroup";toggleGroup(){const sheetId=this.env.model.getters.getActiveSheetId();const{start,end}=this.props.group;interactiveToggleGroup(this.env,sheetId,this.dimension,start,end);}
get groupBoxStyle(){const groupBox=this.groupBox;return cssPropertiesToCss({top:`${groupBox.groupRect.y}px`,left:`${groupBox.groupRect.x}px`,width:`${groupBox.groupRect.width}px`,height:`${groupBox.groupRect.height}px`,});}
get groupButtonStyle(){return cssPropertiesToCss({"background-color":this.isGroupFolded?"#333":"#fff",color:this.isGroupFolded?"#fff":"#333",});}
get groupButtonIcon(){return this.isGroupFolded?"o-spreadsheet-Icon.PLUS":"o-spreadsheet-Icon.MINUS";}
get isGroupFolded(){const sheetId=this.env.model.getters.getActiveSheetId();const group=this.props.group;return this.env.model.getters.isGroupFolded(sheetId,this.dimension,group.start,group.end);}
onContextMenu(ev){const sheetId=this.env.model.getters.getActiveSheetId();const position={x:ev.clientX,y:ev.clientY};const group=this.props.group;const menuItems=getHeaderGroupContextMenu(sheetId,this.dimension,group.start,group.end);this.props.openContextMenu(position,menuItems);}}
AbstractHeaderGroup.props={group:Object,layerOffset:Number,openContextMenu:Function,};class RowGroup extends AbstractHeaderGroup{dimension="ROW";get groupBorderStyle(){const groupBox=this.groupBox;if(this.groupBox.groupRect.height===0){return"";}
return cssPropertiesToCss({top:`${groupBox.headerRect.height / 2}px`,left:`calc(50% - 1px)`,width:`30%`,height:`calc(100% - ${groupBox.headerRect.height / 2}px)`,"border-left":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,"border-bottom":groupBox.isEndHidden?"":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,});}
get groupHeaderStyle(){return cssPropertiesToCss({width:`100%`,height:`${this.groupBox.headerRect.height}px`,});}
get groupBox(){const sheetId=this.env.model.getters.getActiveSheetId();const{start:startRow,end:endRow}=this.props.group;const startCoordinates=this.env.model.getters.getRowDimensions(sheetId,startRow).start;const endCoordinates=this.env.model.getters.getRowDimensions(sheetId,endRow).end;let groupHeaderY=0;let groupHeaderHeight=HEADER_HEIGHT;if(startRow!==0){const headerRowDims=this.env.model.getters.getRowDimensions(sheetId,startRow-1);groupHeaderY=HEADER_HEIGHT+headerRowDims.start;groupHeaderHeight=headerRowDims.end-headerRowDims.start;}
const headerRect={x:this.props.layerOffset,y:groupHeaderY,width:GROUP_LAYER_WIDTH,height:groupHeaderHeight,};const groupRect={x:this.props.layerOffset,y:headerRect.y,width:GROUP_LAYER_WIDTH,height:headerRect.height+(endCoordinates-startCoordinates),};return{headerRect,groupRect,isEndHidden:this.env.model.getters.isRowHidden(sheetId,endRow),};}}
class ColGroup extends AbstractHeaderGroup{dimension="COL";get groupBorderStyle(){const groupBox=this.groupBox;if(groupBox.groupRect.width===0){return"";}
return cssPropertiesToCss({top:`calc(50% - 1px)`,left:`${groupBox.headerRect.width / 2}px`,width:`calc(100% - ${groupBox.headerRect.width / 2}px)`,height:`30%`,"border-top":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,"border-right":groupBox.isEndHidden?"":`1px solid ${HEADER_GROUPING_BORDER_COLOR}`,});}
get groupHeaderStyle(){return cssPropertiesToCss({width:`${this.groupBox.headerRect.width}px`,height:`100%`,});}
get groupBox(){const sheetId=this.env.model.getters.getActiveSheetId();const{start:startCol,end:endCol}=this.props.group;const startCoordinates=this.env.model.getters.getColDimensions(sheetId,startCol).start;const endCoordinates=this.env.model.getters.getColDimensions(sheetId,endCol).end;let groupHeaderX=0;let groupHeaderWidth=HEADER_WIDTH;if(startCol!==0){const headerRowDims=this.env.model.getters.getColDimensions(sheetId,startCol-1);groupHeaderX=HEADER_WIDTH+headerRowDims.start;groupHeaderWidth=headerRowDims.end-headerRowDims.start;}
const headerRect={x:groupHeaderX,y:this.props.layerOffset,width:groupHeaderWidth,height:GROUP_LAYER_WIDTH,};const groupRect={x:headerRect.x,y:this.props.layerOffset,width:headerRect.width+(endCoordinates-startCoordinates),height:GROUP_LAYER_WIDTH,};return{headerRect,groupRect,isEndHidden:this.env.model.getters.isColHidden(sheetId,endCol),};}}
css`
  .o-header-group-frozen-pane-border {
    &.o-group-rows {
      margin-top: -1px;
      border-bottom: 3px solid ${FROZEN_PANE_HEADER_BORDER_COLOR};
    }
    &.o-group-columns {
      margin-left: -1px;
      border-right: 3px solid ${FROZEN_PANE_HEADER_BORDER_COLOR};
    }
  }

  .o-header-group-main-pane {
    &.o-group-rows {
      margin-top: -2px; // Counteract o-header-group-frozen-pane-border offset
    }
    &.o-group-columns {
      margin-left: -2px;
    }
  }
`;class HeaderGroupContainer extends owl.Component{static template="o-spreadsheet-HeaderGroupContainer";static components={RowGroup,ColGroup,Menu};menu=owl.useState({isOpen:false,position:null,menuItems:[]});getLayerOffset(layerIndex){return layerIndex*GROUP_LAYER_WIDTH;}
onContextMenu(event){const sheetId=this.env.model.getters.getActiveSheetId();const position={x:event.clientX,y:event.clientY};const menuItems=createHeaderGroupContainerContextMenu(sheetId,this.props.dimension);this.openContextMenu(position,menuItems);}
openContextMenu(position,menuItems){this.menu.isOpen=true;this.menu.position=position;this.menu.menuItems=menuItems;}
closeMenu(){this.menu.isOpen=false;this.menu.position=null;this.menu.menuItems=[];}
get groupComponent(){return this.props.dimension==="ROW"?RowGroup:ColGroup;}
get hasFrozenPane(){const viewportCoordinates=this.env.model.getters.getMainViewportCoordinates();return this.props.dimension==="COL"?viewportCoordinates.x>0:viewportCoordinates.y>0;}
get scrollContainerStyle(){const{scrollX,scrollY}=this.env.model.getters.getActiveSheetScrollInfo();const cssProperties={};if(this.props.dimension==="COL"){cssProperties.left=`${-scrollX - this.frozenPaneContainerSize}px`;}
else{cssProperties.top=`${-scrollY - this.frozenPaneContainerSize}px`;}
return cssPropertiesToCss(cssProperties);}
get frozenPaneContainerStyle(){const cssProperties={};if(this.props.dimension==="COL"){cssProperties.width=`${this.frozenPaneContainerSize}px`;}
else{cssProperties.height=`${this.frozenPaneContainerSize}px`;}
return cssPropertiesToCss(cssProperties);}
get frozenPaneContainerSize(){if(!this.hasFrozenPane){return 0;}
const viewportCoordinates=this.env.model.getters.getMainViewportCoordinates();if(this.props.dimension==="COL"){return HEADER_WIDTH+viewportCoordinates.x;}
else{return HEADER_HEIGHT+viewportCoordinates.y;}}}
HeaderGroupContainer.props={dimension:String,layers:Array,};css`
  .o-sidePanel {
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
    background-color: white;
    border: 1px solid darkgray;
    user-select: none;
    .o-sidePanelHeader {
      padding: 6px;
      height: 30px;
      background-color: ${BACKGROUND_HEADER_COLOR};
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid darkgray;
      border-top: 1px solid darkgray;
      font-weight: bold;
      .o-sidePanelTitle {
        font-weight: bold;
        padding: 5px 10px;
        color: dimgrey;
      }
      .o-sidePanelClose {
        padding: 5px 10px;
        cursor: pointer;
        &:hover {
          background-color: WhiteSmoke;
        }
      }
    }
    .o-sidePanelBody {
      overflow: auto;
      width: 100%;
      height: 100%;

      .o-section {
        padding: 16px;

        .o-section-title {
          font-weight: bold;
          color: dimgrey;
          margin-bottom: 5px;
        }

        .o-section-subtitle {
          color: dimgrey;
          font-weight: 500;
          font-size: 12px;
          line-height: 14px;
          margin: 8px 0 4px 0;
        }

        .o-subsection-left {
          display: inline-block;
          width: 47%;
          margin-right: 3%;
        }

        .o-subsection-right {
          display: inline-block;
          width: 47%;
          margin-left: 3%;
        }
      }
    }

    .o-sidePanelButtons {
      padding: 16px;
      text-align: right;
    }

    .o-sidePanel-btn-link {
      font-size: 14px;
      padding: 20px 24px 11px 24px;
      height: 44px;
      cursor: pointer;
      text-decoration: none;
      &:hover {
        color: #003a39;
        text-decoration: none;
      }
    }

    .o-button.primary:not(.o-disabled) {
      background-color: ${FILTERS_COLOR};
      color: white;
      &:hover:enabled {
        opacity: 0.8;
        background-color: ${FILTERS_COLOR};
      }
    }

    input.o-required,
    select.o-required {
      border-color: #4c4c4c;
    }
    input.o-optional,
    select.o-optional {
      border: 1px solid #a9a9a9;
    }
    input.o-invalid {
      border-color: red;
    }
    select.o-input {
      background-color: white;
      text-align: left;
    }

    .o-checkbox {
      display: flex;
      justify-items: center;
      input {
        margin-right: 5px;
      }
    }

    .o-inflection {
      table {
        table-layout: fixed;
        margin-top: 2%;
        display: table;
        text-align: left;
        font-size: 12px;
        line-height: 18px;
        width: 100%;
      }
      input,
      select {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }
    }

    .o-sidePanel-tools {
      color: #333;
      font-size: 13px;
      cursor: default;
      display: flex;

      .o-tool {
        display: flex;
        align-items: center;
        margin: 2px;
        padding: 0 3px;
        border-radius: 2px;

        &:hover {
          background-color: rgba(0, 0, 0, 0.08);
        }
      }
    }
  }
`;class SidePanel extends owl.Component{static template="o-spreadsheet-SidePanel";state;setup(){this.state=owl.useState({panel:sidePanelRegistry.get(this.props.component),});owl.onWillUpdateProps((nextProps)=>(this.state.panel=sidePanelRegistry.get(nextProps.component)));}
getTitle(){return typeof this.state.panel.title==="function"?this.state.panel.title(this.env):this.state.panel.title;}}
SidePanel.props={component:String,panelProps:{type:Object,optional:true},onCloseSidePanel:Function,};css`
  .o-menu-item-button {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2px;
    border-radius: 2px;
    min-width: 20px;
  }
  .o-disabled {
    opacity: 0.6;
    cursor: default;
  }
`;class ActionButton extends owl.Component{static template="o-spreadsheet-ActionButton";actionButton=createAction(this.props.action);setup(){owl.onWillUpdateProps((nextProps)=>{if(nextProps.action!==this.props.action){this.actionButton=createAction(this.props.action);}});}
get isVisible(){return this.actionButton.isVisible(this.env);}
get isEnabled(){return this.actionButton.isEnabled(this.env);}
get isActive(){return this.actionButton.isActive?.(this.env);}
get title(){const name=this.actionButton.name(this.env);const description=this.actionButton.description(this.env);return name+(description?` (${description})`:"");}
get iconTitle(){return this.actionButton.icon(this.env);}
onClick(ev){if(this.isEnabled){this.props.onClick?.(ev);this.actionButton.execute?.(this.env);}}
get buttonStyle(){if(this.props.selectedColor){return cssPropertiesToCss({"border-bottom":`4px solid ${this.props.selectedColor}`,height:"16px","margin-top":"2px",});}
return"";}}
ActionButton.props={action:Object,hasTriangleDownIcon:{type:Boolean,optional:true},selectedColor:{type:String,optional:true},class:{type:String,optional:true},onClick:{type:Function,optional:true},};const BORDER_POSITIONS=[[["all","o-spreadsheet-Icon.BORDERS"],["hv","o-spreadsheet-Icon.BORDER_HV"],["h","o-spreadsheet-Icon.BORDER_H"],["v","o-spreadsheet-Icon.BORDER_V"],["external","o-spreadsheet-Icon.BORDER_EXTERNAL"],],[["left","o-spreadsheet-Icon.BORDER_LEFT"],["top","o-spreadsheet-Icon.BORDER_TOP"],["right","o-spreadsheet-Icon.BORDER_RIGHT"],["bottom","o-spreadsheet-Icon.BORDER_BOTTOM"],["clear","o-spreadsheet-Icon.BORDER_CLEAR"],],];css`
  .o-border-selector {
    padding: 4px;
    background-color: white;
  }
  .o-divider {
    border-right: 1px solid #e0e2e4;
    margin: 0 6px;
  }
  .o-border-selector-section {
    .o-dropdown-line {
      height: 30px;
      margin: 1px;
      .o-line-item {
        padding: 4px;
        width: 18px;
        height: 18px;
      }
    }
    .o-border-style-tool {
      padding: 0px 3px;
      margin: 2px;
      height: 25px;
    }
  }
  .o-style-preview {
    margin: 7px 5px 7px 5px;
    width: 60px;
    height: 5px;
  }
  .o-style-thin {
    border-bottom: 1px solid #000000;
  }
  .o-style-medium {
    border-bottom: 2px solid #000000;
  }
  .o-style-thick {
    border-bottom: 3px solid #000000;
  }
  .o-style-dashed {
    border-bottom: 1px dashed #000000;
  }
  .o-style-dotted {
    border-bottom: 1px dotted #000000;
  }
  .o-dropdown-border-type {
    &:not(.o-disabled):not(.active):hover {
      background-color: ${BG_HOVER_COLOR};
    }
  }
  .o-dropdown-border-check {
    width: 20px;
    font-size: 12px;
  }
  .o-border-style-dropdown {
    background: #ffffff;
    padding: 4px;
    .o-dropdown-line {
      .o-line-item.active {
        background-color: rgba(0, 0, 0, 0.2);
      }
    }
  }
  .o-border-picker-button {
    padding: 0px !important;
    margin: 5px 0px 0px 0px !important;
    height: 25px !important;
  }
`;class BorderEditor extends owl.Component{static template="o-spreadsheet-BorderEditor";static components={ColorPickerWidget,Popover};BORDER_POSITIONS=BORDER_POSITIONS;lineStyleButtonRef=owl.useRef("lineStyleButton");borderStyles=borderStyles;state=owl.useState({activeTool:undefined,});toggleDropdownTool(tool){const isOpen=this.state.activeTool===tool;this.state.activeTool=isOpen?undefined:tool;}
closeDropdown(){this.state.activeTool=undefined;}
setBorderPosition(position){this.props.onBorderPositionPicked(position);this.closeDropdown();}
setBorderColor(color){this.props.onBorderColorPicked(color);this.closeDropdown();}
setBorderStyle(style){this.props.onBorderStylePicked(style);this.closeDropdown();}
get lineStylePickerPopoverProps(){return{anchorRect:this.lineStylePickerAnchorRect,positioning:"BottomLeft",verticalOffset:0,};}
get popoverProps(){return{anchorRect:this.props.anchorRect,maxHeight:this.props.maxHeight,positioning:"BottomLeft",verticalOffset:0,};}
get lineStylePickerAnchorRect(){const button=this.lineStyleButtonRef.el;if(button===null){return{x:0,y:0,width:0,height:0};}
const buttonRect=button.getBoundingClientRect();return{x:buttonRect.x,y:buttonRect.y,width:buttonRect.width,height:buttonRect.height,};}}
BorderEditor.props={class:{type:String,optional:true},currentBorderColor:{type:String,optional:false},currentBorderStyle:{type:String,optional:false},currentBorderPosition:{type:String,optional:true},onBorderColorPicked:Function,onBorderStylePicked:Function,onBorderPositionPicked:Function,maxHeight:{type:Number,optional:true},anchorRect:Object,};class BorderEditorWidget extends owl.Component{static template="o-spreadsheet-BorderEditorWidget";static components={BorderEditor};borderEditorButtonRef=owl.useRef("borderEditorButton");state=owl.useState({currentColor:DEFAULT_BORDER_DESC.color,currentStyle:DEFAULT_BORDER_DESC.style,currentPosition:undefined,});get borderEditorAnchorRect(){const button=this.borderEditorButtonRef.el;const buttonRect=button.getBoundingClientRect();return{x:buttonRect.x,y:buttonRect.y,width:buttonRect.width,height:buttonRect.height,};}
onBorderPositionPicked(position){this.state.currentPosition=position;this.updateBorder();}
onBorderColorPicked(color){this.state.currentColor=color;this.updateBorder();}
onBorderStylePicked(style){this.state.currentStyle=style;this.updateBorder();}
updateBorder(){if(this.state.currentPosition===undefined){return;}
this.env.model.dispatch("SET_ZONE_BORDERS",{sheetId:this.env.model.getters.getActiveSheetId(),target:this.env.model.getters.getSelectedZones(),border:{position:this.state.currentPosition,color:this.state.currentColor,style:this.state.currentStyle,},});}}
BorderEditorWidget.props={toggleBorderEditor:Function,showBorderEditor:Boolean,disabled:{type:Boolean,optional:true},dropdownMaxHeight:{type:Number,optional:true},class:{type:String,optional:true},};const COMPOSER_MAX_HEIGHT=100;const FX_SVG=`
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 121.8 122.9' width='16' height='16' focusable='false'>
  <path d='m28 34-4 5v2h10l-6 40c-4 22-6 28-7 30-2 2-3 3-5 3-3 0-7-2-9-4H4c-2 2-4 4-4 7s4 6 8 6 9-2 15-8c8-7 13-17 18-39l7-35 13-1 3-6H49c4-23 7-27 11-27 2 0 5 2 8 6h4c1-1 4-4 4-7 0-2-3-6-9-6-5 0-13 4-20 10-6 7-9 14-11 24h-8zm41 16c4-5 7-7 8-7s2 1 5 9l3 12c-7 11-12 17-16 17l-3-1-2-1c-3 0-6 3-6 7s3 7 7 7c6 0 12-6 22-23l3 10c3 9 6 13 10 13 5 0 11-4 18-15l-3-4c-4 6-7 8-8 8-2 0-4-3-6-10l-5-15 8-10 6-4 3 1 3 2c2 0 6-3 6-7s-2-7-6-7c-6 0-11 5-21 20l-2-6c-3-9-5-14-9-14-5 0-12 6-18 15l3 3z' fill='#BDBDBD'/>
</svg>
`;css`
  .o-topbar-composer {
    height: fit-content;
    margin-top: -1px;
    border: 1px solid;
    z-index: ${ComponentsImportance.TopBarComposer};

    .o-composer:empty:not(:focus):not(.active)::before {
      content: url("data:image/svg+xml,${encodeURIComponent(FX_SVG)}");
      position: relative;
      top: 20%;
    }
  }

  .user-select-text {
    user-select: text;
  }
`;class TopBarComposer extends owl.Component{static template="o-spreadsheet-TopBarComposer";static components={Composer};get composerStyle(){const style={padding:"5px 0px 5px 8px","max-height":`${COMPOSER_MAX_HEIGHT}px`,"line-height":"24px",};style.height=this.props.focus==="inactive"?`${TOPBAR_TOOLBAR_HEIGHT}px`:"fit-content";return cssPropertiesToCss(style);}
get containerStyle(){if(this.props.focus==="inactive"){return cssPropertiesToCss({"border-color":SEPARATOR_COLOR,"border-right":"none",});}
return cssPropertiesToCss({"border-color":SELECTION_BORDER_COLOR,});}}
TopBarComposer.props={focus:{validate:(value)=>["inactive","cellFocus","contentFocus"].includes(value)},onComposerContentFocused:Function,};css`
  .o-font-size-editor {
    height: calc(100% - 4px);
    input.o-font-size {
      outline-color: ${SELECTION_BORDER_COLOR};
      height: 20px;
      width: 23px;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }
  }
  .o-text-options > div {
    cursor: pointer;
    line-height: 26px;
    padding: 3px 12px;
    &:hover {
      background-color: rgba(0, 0, 0, 0.08);
    }
  }
`;class FontSizeEditor extends owl.Component{static template="o-spreadsheet-FontSizeEditor";static components={};fontSizes=FONT_SIZES;dropdown=owl.useState({isOpen:false});inputRef=owl.useRef("inputFontSize");rootEditorRef=owl.useRef("FontSizeEditor");setup(){owl.useExternalListener(window,"click",this.onExternalClick,{capture:true});}
onExternalClick(ev){if(!isChildEvent(this.rootEditorRef.el,ev)){this.closeFontList();}}
get currentFontSize(){return this.env.model.getters.getCurrentStyle().fontSize||DEFAULT_FONT_SIZE;}
toggleFontList(){const isOpen=this.dropdown.isOpen;if(!isOpen){this.props.onToggle();this.inputRef.el.focus();}
else{this.closeFontList();}}
closeFontList(){this.dropdown.isOpen=false;}
setSize(fontSizeStr){const fontSize=clip(Math.floor(parseFloat(fontSizeStr)),1,400);setStyle(this.env,{fontSize});this.closeFontList();}
setSizeFromInput(ev){this.setSize(ev.target.value);}
setSizeFromList(fontSizeStr){this.setSize(fontSizeStr);}
onInputFocused(ev){this.dropdown.isOpen=true;ev.target.select();}
onInputKeydown(ev){if(ev.key==="Enter"||ev.key==="Escape"){this.closeFontList();const target=ev.target;if(ev.key==="Escape"){target.value=`${this.currentFontSize}`;}
this.props.onToggle();}}}
FontSizeEditor.props={onToggle:Function,dropdownStyle:String,class:String,};class PaintFormatButton extends owl.Component{static template="o-spreadsheet-PaintFormatButton";get isActive(){return this.env.model.getters.isPaintingFormat();}
onDblClick(){this.env.model.dispatch("ACTIVATE_PAINT_FORMAT",{persistent:true});}
togglePaintFormat(){if(this.isActive){this.env.model.dispatch("CANCEL_PAINT_FORMAT");}
else{this.env.model.dispatch("ACTIVATE_PAINT_FORMAT",{persistent:false});}}}
PaintFormatButton.props={class:{type:String,optional:true},};css`
  .o-spreadsheet-topbar {
    line-height: 1.2;
    font-size: 13px;
    font-weight: 500;
    background-color: #fff;

    .o-topbar-top {
      border-bottom: 1px solid ${SEPARATOR_COLOR};
      padding: 2px 10px;

      /* Menus */
      .o-topbar-topleft {
        .o-topbar-menu {
          padding: 4px 6px;
          margin: 0 2px;

          &.active {
            background-color: ${BG_HOVER_COLOR};
            color: #000;
          }
        }
      }
    }

    .o-topbar-composer {
      flex-grow: 1;
    }

    /* Toolbar */
    .o-topbar-toolbar {
      height: ${TOPBAR_TOOLBAR_HEIGHT}px;

      .o-readonly-toolbar {
        background-color: ${BACKGROUND_HEADER_COLOR};
        padding-left: 18px;
        padding-right: 18px;
      }

      /* Toolbar */
      .o-toolbar-tools {
        display: flex;
        flex-shrink: 0;
        margin: 0px 6px 0px 16px;
        cursor: default;

        .o-divider {
          display: inline-block;
          border-right: 1px solid ${SEPARATOR_COLOR};
          width: 0;
          margin: 0 6px;
        }

        .o-dropdown {
          position: relative;
          display: flex;
          align-items: center;

          > span {
            height: 30px;
          }

          .o-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2px;
            z-index: ${ComponentsImportance.Dropdown};
            box-shadow: 1px 2px 5px 2px rgba(51, 51, 51, 0.15);
            background-color: white;

            .o-dropdown-line {
              display: flex;

              > span {
                padding: 4px;
              }
            }
          }
        }
      }
    }
  }
`;class TopBar extends owl.Component{static template="o-spreadsheet-TopBar";get dropdownStyle(){return`max-height:${this.props.dropdownMaxHeight}px`;}
static components={ColorPickerWidget,ColorPicker,Menu,TopBarComposer,FontSizeEditor,ActionButton,PaintFormatButton,BorderEditorWidget,};state=owl.useState({menuState:{isOpen:false,position:null,menuItems:[]},activeTool:"",fillColor:"#ffffff",textColor:"#000000",});isSelectingMenu=false;openedEl=null;menus=[];EDIT=ACTION_EDIT;FORMAT=ACTION_FORMAT;VIEW=ACTION_VIEW;formatNumberMenuItemSpec=formatNumberMenuItemSpec;isntToolbarMenu=false;setup(){owl.useExternalListener(window,"click",this.onExternalClick);owl.onWillStart(()=>this.updateCellState());owl.onWillUpdateProps(()=>this.updateCellState());}
get topbarComponents(){return topbarComponentRegistry.getAll().filter((item)=>!item.isVisible||item.isVisible(this.env));}
onExternalClick(ev){if(this.openedEl===ev.target){return;}
this.closeMenus();}
onClick(){this.props.onClick();this.closeMenus();}
onMenuMouseOver(menu,ev){if(this.isSelectingMenu&&this.isntToolbarMenu){this.openMenu(menu,ev);}}
toggleDropdownTool(tool,ev){const isOpen=this.state.activeTool===tool;this.closeMenus();this.state.activeTool=isOpen?"":tool;this.openedEl=isOpen?null:ev.target;}
toggleContextMenu(menu,ev){if(this.state.menuState.isOpen&&this.isntToolbarMenu){this.closeMenus();}
else{this.openMenu(menu,ev);this.isntToolbarMenu=true;}}
toggleToolbarContextMenu(menuSpec,ev){if(this.state.menuState.isOpen&&!this.isntToolbarMenu){this.closeMenus();}
else{const menu=createAction(menuSpec);this.openMenu(menu,ev);this.isntToolbarMenu=false;}}
openMenu(menu,ev){const{left,top,height}=ev.currentTarget.getBoundingClientRect();this.state.activeTool="";this.state.menuState.isOpen=true;this.state.menuState.position={x:left,y:top+height};this.state.menuState.menuItems=menu.children(this.env).sort((a,b)=>a.sequence-b.sequence);this.state.menuState.parentMenu=menu;this.isSelectingMenu=true;this.openedEl=ev.target;interactiveStopEdition(this.env);}
closeMenus(){this.state.activeTool="";this.state.menuState.isOpen=false;this.state.menuState.parentMenu=undefined;this.isSelectingMenu=false;this.openedEl=null;}
updateCellState(){const style=this.env.model.getters.getCurrentStyle();this.state.fillColor=style.fillColor||"#ffffff";this.state.textColor=style.textColor||"#000000";this.menus=topbarMenuRegistry.getMenuItems();}
getMenuName(menu){return menu.name(this.env);}
setColor(target,color){setStyle(this.env,{[target]:color});this.onClick();}}
TopBar.props={onClick:Function,focusComposer:String,onComposerContentFocused:Function,dropdownMaxHeight:Number,};function instantiateClipboard(){return new WebClipboardWrapper(navigator.clipboard);}
class WebClipboardWrapper{clipboard;constructor(clipboard){this.clipboard=clipboard;}
async write(clipboardContent){try{this.clipboard?.write(this.getClipboardItems(clipboardContent));}
catch(e){}}
async writeText(text){try{this.clipboard?.writeText(text);}
catch(e){}}
async readText(){let permissionResult=undefined;try{permissionResult=await navigator.permissions.query({name:"clipboard-read"});}
catch(e){}
try{const clipboardContent=await this.clipboard.readText();return{status:"ok",content:clipboardContent};}
catch(e){const status=permissionResult?.state==="denied"?"permissionDenied":"notImplemented";return{status};}}
getClipboardItems(content){return[new ClipboardItem({[ClipboardMIMEType.PlainText]:this.getBlob(content,ClipboardMIMEType.PlainText),[ClipboardMIMEType.Html]:this.getBlob(content,ClipboardMIMEType.Html),}),];}
getBlob(clipboardContent,type){return new Blob([clipboardContent[type]||""],{type,});}}
const ACTIVE_BG_COLOR=BACKGROUND_HEADER_FILTER_COLOR;const ACTIVE_FONT_COLOR=FILTERS_COLOR;const HOVERED_BG_COLOR=BG_HOVER_COLOR;const HOVERED_FONT_COLOR="#000";css`
  .o-spreadsheet {
    position: relative;
    display: grid;
    grid-template-columns: auto 350px;
    color: #333;
    input {
      background-color: white;
    }
    .text-muted {
      color: grey !important;
    }
    .o-disabled {
      opacity: 0.4;
      pointer: default;
      pointer-events: none;
    }

    &,
    *,
    *:before,
    *:after {
      box-sizing: content-box;
      /** rtl not supported ATM */
      direction: ltr;
    }
    .o-separator {
      border-bottom: ${MENU_SEPARATOR_BORDER_WIDTH}px solid ${SEPARATOR_COLOR};
      margin-top: ${MENU_SEPARATOR_PADDING}px;
      margin-bottom: ${MENU_SEPARATOR_PADDING}px;
    }
    .o-hoverable-button {
      border-radius: 2px;
      cursor: pointer;
      .o-icon {
        color: ${ICONS_COLOR};
      }
      &:not(.o-disabled):not(.active):hover {
        background-color: ${HOVERED_BG_COLOR};
        color: ${HOVERED_FONT_COLOR};
        .o-icon {
          color: ${HOVERED_FONT_COLOR};
        }
      }
      &.active {
        background-color: ${ACTIVE_BG_COLOR};
        color: ${ACTIVE_FONT_COLOR};
        .o-icon {
          color: ${ACTIVE_FONT_COLOR};
        }
      }
    }

    .o-grid-container {
      display: grid;
      background-color: ${HEADER_GROUPING_BACKGROUND_COLOR};

      .o-top-left {
        border: 1px solid ${GRID_BORDER_COLOR};
        margin-bottom: -1px;
        margin-right: -1px;
      }

      .o-column-groups {
        grid-column-start: 2;
        border-top: 1px solid ${GRID_BORDER_COLOR};
      }

      .o-row-groups {
        grid-row-start: 2;
      }

      .o-group-grid {
        border-top: 1px solid ${GRID_BORDER_COLOR};
        border-left: 1px solid ${GRID_BORDER_COLOR};
      }
    }
  }

  .o-two-columns {
    grid-column: 1 / 3;
  }

  .o-icon {
    width: ${ICON_EDGE_LENGTH}px;
    height: ${ICON_EDGE_LENGTH}px;
    vertical-align: middle;
  }

  .o-cf-icon {
    width: ${CF_ICON_EDGE_LENGTH}px;
    height: ${CF_ICON_EDGE_LENGTH}px;
    vertical-align: sub;
  }

  .o-text-icon {
    vertical-align: middle;
  }
`;css`
  .o-grid {
    position: relative;
    overflow: hidden;
    background-color: ${BACKGROUND_GRAY_COLOR};
    &:focus {
      outline: none;
    }

    > canvas {
      border-bottom: 1px solid #e2e3e3;
    }
    .o-scrollbar {
      &.corner {
        right: 0px;
        bottom: 0px;
        height: ${SCROLLBAR_WIDTH}px;
        width: ${SCROLLBAR_WIDTH}px;
        border-top: 1px solid #e2e3e3;
        border-left: 1px solid #e2e3e3;
      }
    }

    .o-grid-overlay {
      position: absolute;
      outline: none;
    }
  }

  .o-button {
    border: 1px solid;
    padding: 0px 20px 0px 20px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 14px;
    height: 30px;
    line-height: 16px;
    margin-right: 8px;

    &:not(:hover) {
      background-color: transparent;
    }

    &:enabled {
      cursor: pointer;
    }

    &:disabled {
      color: ${DISABLED_TEXT_COLOR};
    }

    &:last-child {
      margin-right: 0px;
    }

    &.o-button-grey {
      border-color: lightgrey;
      background: #ffffff;
      color: #333;
      &:hover:enabled {
        background-color: rgba(0, 0, 0, 0.08);
      }
    }
  }

  .o-input {
    color: #666666;
    border-radius: 4px;
    min-width: 0px;
    padding: 4px 6px;
    box-sizing: border-box;
    line-height: 1;
    width: 100%;
    height: 28px;
  }
`;class Spreadsheet extends owl.Component{static template="o-spreadsheet-Spreadsheet";static components={TopBar,Grid,BottomBar,SidePanel,SpreadsheetDashboard,HeaderGroupContainer,};sidePanel;composer;_focusGrid;keyDownMapping;isViewportTooSmall=false;get model(){return this.props.model;}
getStyle(){if(this.env.isDashboard()){return`grid-template-rows: auto;`;}
return`grid-template-rows: ${TOPBAR_HEIGHT}px auto ${BOTTOMBAR_HEIGHT + 1}px`;}
setup(){this.sidePanel=owl.useState({isOpen:false,panelProps:{}});this.composer=owl.useState({topBarFocus:"inactive",gridFocusMode:"inactive",});this.keyDownMapping={"CTRL+H":()=>this.toggleSidePanel("FindAndReplace",{}),"CTRL+F":()=>this.toggleSidePanel("FindAndReplace",{}),};const fileStore=this.model.config.external.fileStore;owl.useSubEnv({model:this.model,imageProvider:fileStore?new ImageProvider(fileStore):undefined,loadCurrencies:this.model.config.external.loadCurrencies,loadLocales:this.model.config.external.loadLocales,isDashboard:()=>this.model.getters.isDashboard(),openSidePanel:this.openSidePanel.bind(this),toggleSidePanel:this.toggleSidePanel.bind(this),clipboard:this.env.clipboard||instantiateClipboard(),startCellEdition:(content)=>this.onGridComposerCellFocused(content),focusableElement:new FocusableElement(),});owl.useExternalListener(window,"resize",()=>this.render(true));owl.useExternalListener(window,"beforeunload",this.unbindModelEvents.bind(this));owl.useExternalListener(document.body,"wheel",()=>{});this.bindModelEvents();owl.onWillUpdateProps((nextProps)=>{if(nextProps.model!==this.props.model){throw new Error("Changing the props model is not supported at the moment.");}});owl.onMounted(()=>{this.checkViewportSize();});owl.onWillUnmount(()=>this.unbindModelEvents());owl.onPatched(()=>{this.checkViewportSize();});}
get focusTopBarComposer(){return this.model.getters.getEditionMode()==="inactive"?"inactive":this.composer.topBarFocus;}
get focusGridComposer(){return this.model.getters.getEditionMode()==="inactive"?"inactive":this.composer.gridFocusMode;}
bindModelEvents(){this.model.on("update",this,()=>this.render(true));this.model.on("notify-ui",this,(notification)=>this.env.notifyUser(notification));this.model.on("raise-error-ui",this,({text})=>this.env.raiseError(text));}
unbindModelEvents(){this.model.off("update",this);this.model.off("notify-ui",this);this.model.off("raise-error-ui",this);}
checkViewportSize(){const{xRatio,yRatio}=this.env.model.getters.getFrozenSheetViewRatio(this.env.model.getters.getActiveSheetId());if(!isFinite(xRatio)||!isFinite(yRatio)){return;}
if(yRatio>MAXIMAL_FREEZABLE_RATIO||xRatio>MAXIMAL_FREEZABLE_RATIO){if(this.isViewportTooSmall){return;}
this.env.notifyUser({text:_t("The current window is too small to display this sheet properly. Consider resizing your browser window or adjusting frozen rows and columns."),type:"warning",sticky:false,});this.isViewportTooSmall=true;}
else{this.isViewportTooSmall=false;}}
openSidePanel(panel,panelProps){if(this.sidePanel.isOpen&&panel!==this.sidePanel.component){this.sidePanel.panelProps?.onCloseSidePanel?.();}
this.sidePanel.component=panel;this.sidePanel.panelProps=panelProps;this.sidePanel.isOpen=true;}
closeSidePanel(){this.sidePanel.isOpen=false;this.focusGrid();this.sidePanel.panelProps?.onCloseSidePanel?.();}
toggleSidePanel(panel,panelProps){if(this.sidePanel.isOpen&&panel===this.sidePanel.component){this.sidePanel.isOpen=false;this.focusGrid();}
else{this.openSidePanel(panel,panelProps);}}
focusGrid(){if(!this._focusGrid){throw new Error("_focusGrid should be exposed by the grid component");}
this._focusGrid();}
onKeydown(ev){let keyDownString="";if(isCtrlKey(ev)){keyDownString+="CTRL+";}
keyDownString+=ev.key.toUpperCase();let handler=this.keyDownMapping[keyDownString];if(handler){ev.preventDefault();ev.stopPropagation();handler();return;}}
onTopBarComposerFocused(selection){if(this.model.getters.isReadonly()){return;}
this.composer.topBarFocus="contentFocus";this.composer.gridFocusMode="inactive";this.setComposerContent({selection});}
onGridComposerContentFocused(selection){if(this.model.getters.isReadonly()){return;}
this.composer.topBarFocus="inactive";this.composer.gridFocusMode="contentFocus";this.setComposerContent({selection});}
onGridComposerCellFocused(content,selection){if(this.model.getters.isReadonly()){return;}
this.composer.topBarFocus="inactive";this.composer.gridFocusMode="cellFocus";this.setComposerContent({content,selection}||{});}
setComposerContent({content,selection,}){if(this.model.getters.getEditionMode()==="inactive"){this.model.dispatch("START_EDITION",{text:content,selection});}
else if(content){this.model.dispatch("SET_CURRENT_CONTENT",{content,selection});}}
get gridHeight(){const{height}=this.env.model.getters.getSheetViewDimension();return height;}
get gridContainerStyle(){const gridColSize=GROUP_LAYER_WIDTH*this.rowLayers.length;const gridRowSize=GROUP_LAYER_WIDTH*this.colLayers.length;return cssPropertiesToCss({"grid-template-columns":`${gridColSize ? gridColSize + 2 : 0}px auto`,"grid-template-rows":`${gridRowSize ? gridRowSize + 2 : 0}px auto`,});}
get rowLayers(){const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getVisibleGroupLayers(sheetId,"ROW");}
get colLayers(){const sheetId=this.env.model.getters.getActiveSheetId();return this.env.model.getters.getVisibleGroupLayers(sheetId,"COL");}}
Spreadsheet.props={model:Object,};class LocalTransportService{listeners=[];sendMessage(message){for(const{callback}of this.listeners){callback(message);}}
onNewMessage(id,callback){this.listeners.push({id,callback});}
leave(id){this.listeners=this.listeners.filter((listener)=>listener.id!==id);}}
function inverseCommand(cmd){return inverseCommandRegistry.get(cmd.type)(cmd);}
function createEmptyStructure(node){if(typeof node==="string"){return{};}
else if(typeof node==="number"){return[];}
throw new Error(`Cannot create new node`);}
class Branch{buildTransformation;operations;constructor(buildTransformation,operations=[]){this.buildTransformation=buildTransformation;this.operations=operations;}
getOperations(){return this.operations;}
getOperation(operationId){const operation=this.operations.find((op)=>op.id===operationId);if(!operation){throw new Error(`Operation ${operationId} not found`);}
return operation;}
getLastOperationId(){return this.operations[this.operations.length-1]?.id;}
getFirstOperationAmong(op1,op2){for(const operation of this.operations){if(operation.id===op1)
return op1;if(operation.id===op2)
return op2;}
throw new Error(`Operation ${op1} and ${op2} not found`);}
contains(operationId){return!!this.operations.find((operation)=>operation.id===operationId);}
prepend(operation){const transformation=this.buildTransformation.with(operation.data);this.operations=[operation,...this.operations.map((operation)=>operation.transformed(transformation)),];}
insert(newOperation,predecessorOpId){const transformation=this.buildTransformation.with(newOperation.data);const{before,operation,after}=this.locateOperation(predecessorOpId);this.operations=[...before,operation,newOperation,...after.map((operation)=>operation.transformed(transformation)),];}
append(operation){this.operations.push(operation);}
appendBranch(branch){this.operations=this.operations.concat(branch.operations);}
fork(operationId){const{after}=this.locateOperation(operationId);return new Branch(this.buildTransformation,after);}
transform(transformation){this.operations=this.operations.map((operation)=>operation.transformed(transformation));}
cutBefore(operationId){this.operations=this.locateOperation(operationId).before;}
cutAfter(operationId){const{before,operation}=this.locateOperation(operationId);this.operations=before.concat([operation]);}
locateOperation(operationId){const operationIndex=this.operations.findIndex((step)=>step.id===operationId);if(operationIndex===-1){throw new Error(`Operation ${operationId} not found`);}
return{before:this.operations.slice(0,operationIndex),operation:this.operations[operationIndex],after:this.operations.slice(operationIndex+1),};}}
class Operation{id;data;constructor(id,data){this.id=id;this.data=data;}
transformed(transformation){return new LazyOperation(this.id,lazy(()=>transformation(this.data)));}}
class LazyOperation{id;lazyData;constructor(id,lazyData){this.id=id;this.lazyData=lazyData;}
get data(){return this.lazyData();}
transformed(transformation){return new LazyOperation(this.id,this.lazyData.map(transformation));}}
class OperationSequence{operations;constructor(operations){this.operations=operations;}
[Symbol.iterator](){return this.operations[Symbol.iterator]();}
stopWith(operationId){function*filter(execution,operationId){for(const step of execution){yield step;if(step.operation.id===operationId){return;}}}
return new OperationSequence(filter(this.operations,operationId));}
stopBefore(operationId){function*filter(execution,operationId){for(const step of execution){if(step.operation.id===operationId){return;}
yield step;}}
return new OperationSequence(filter(this.operations,operationId));}
startAfter(operationId){function*filter(execution,operationId){let skip=true;for(const step of execution){if(!skip){yield step;}
if(step.operation.id===operationId){skip=false;}}}
return new OperationSequence(filter(this.operations,operationId));}}
class Tree{buildTransformation;branches;branchingOperationIds=new Map();constructor(buildTransformation,initialBranch){this.buildTransformation=buildTransformation;this.branches=[initialBranch];}
getLastBranch(){return this.branches[this.branches.length-1];}
execution(branch){return new OperationSequence(linkNext(this._execution(branch),this._execution(branch)));}
revertedExecution(branch){return new OperationSequence(linkNext(this._revertedExecution(branch),this._revertedExecution(branch)));}
insertOperationLast(branch,operation){const insertAfter=branch.getLastOperationId()||this.previousBranch(branch)?.getLastOperationId();branch.append(operation);if(insertAfter){this.insertPrevious(branch,operation,insertAfter);}}
insertOperationAfter(branch,operation,predecessorOpId){branch.insert(operation,predecessorOpId);this.updateNextWith(branch,operation,predecessorOpId);this.insertPrevious(branch,operation,predecessorOpId);}
undo(branch,operation){const transformation=this.buildTransformation.without(operation.data);const branchingId=this.branchingOperationIds.get(branch);this.branchingOperationIds.set(branch,operation.id);const nextBranch=branch.fork(operation.id);if(branchingId){this.branchingOperationIds.set(nextBranch,branchingId);}
this.insertBranchAfter(branch,nextBranch);this.transform(nextBranch,transformation);}
redo(branch){const removedBranch=this.nextBranch(branch);if(!removedBranch)
return;const nextBranch=this.nextBranch(removedBranch);this.removeBranchFromTree(removedBranch);const undoBranchingId=this.branchingOperationIds.get(removedBranch);if(undoBranchingId){this.branchingOperationIds.set(branch,undoBranchingId);}
else{this.branchingOperationIds.delete(branch);}
if(nextBranch){this.rebaseUp(nextBranch);}}
drop(operationId){for(const branch of this.branches){if(branch.contains(operationId)){branch.cutBefore(operationId);}}}
findOperation(branch,operationId){for(const operation of this.revertedExecution(branch)){if(operation.operation.id===operationId){return operation;}}
throw new Error(`Operation ${operationId} not found`);}
rebaseUp(branch){const{previousBranch,branchingOperation}=this.findPreviousBranchingOperation(branch);if(!previousBranch||!branchingOperation)
return;const rebaseTransformation=this.buildTransformation.without(branchingOperation.data);const newBranch=previousBranch.fork(branchingOperation.id);this.branchingOperationIds.set(newBranch,this.branchingOperationIds.get(branch));this.removeBranchFromTree(branch);this.insertBranchAfter(previousBranch,newBranch);newBranch.transform(rebaseTransformation);const nextBranch=this.nextBranch(newBranch);if(nextBranch){this.rebaseUp(nextBranch);}}
removeBranchFromTree(branch){const index=this.branches.findIndex((l)=>l===branch);this.branches.splice(index,1);}
insertBranchAfter(branch,toInsert){const index=this.branches.findIndex((l)=>l===branch);this.branches.splice(index+1,0,toInsert);}
updateNextWith(branch,operation,predecessorOpId){const branchingId=this.branchingOperationIds.get(branch);const nextBranch=this.nextBranch(branch);if(!branchingId||!nextBranch){return;}
if(branch.getFirstOperationAmong(predecessorOpId,branchingId)===branchingId){const transformedOperation=this.addToNextBranch(branch,nextBranch,branchingId,operation,predecessorOpId);this.updateNextWith(nextBranch,transformedOperation,predecessorOpId);}
else{const transformation=this.buildTransformation.with(operation.data);this.transform(nextBranch,transformation);}}
addToNextBranch(branch,nextBranch,branchingId,operation,predecessorOpId){let transformedOperation=operation;if(predecessorOpId===branchingId){transformedOperation=this.getTransformedOperation(branch,branchingId,operation);nextBranch.prepend(transformedOperation);}
else if(nextBranch.contains(predecessorOpId)){transformedOperation=this.getTransformedOperation(branch,branchingId,operation);nextBranch.insert(transformedOperation,predecessorOpId);}
else{nextBranch.append(operation);}
return transformedOperation;}
getTransformedOperation(branch,branchingId,operation){const branchingOperation=branch.getOperation(branchingId);const branchingTransformation=this.buildTransformation.without(branchingOperation.data);return operation.transformed(branchingTransformation);}
shouldExecute(branch,operation){return operation.id!==this.branchingOperationIds.get(branch);}
transform(branch,transformation){branch.transform(transformation);const nextBranch=this.nextBranch(branch);if(nextBranch){this.transform(nextBranch,transformation);}}
insertPrevious(branch,newOperation,insertAfter){const{previousBranch,branchingOperation}=this.findPreviousBranchingOperation(branch);if(!previousBranch||!branchingOperation)
return;const transformation=this.buildTransformation.with(branchingOperation.data);const branchTail=branch.fork(insertAfter);branchTail.transform(transformation);previousBranch.cutAfter(insertAfter);previousBranch.appendBranch(branchTail);const operationToInsert=newOperation.transformed(transformation);this.insertPrevious(previousBranch,operationToInsert,insertAfter);}
findPreviousBranchingOperation(branch){const previousBranch=this.previousBranch(branch);if(!previousBranch)
return{previousBranch:undefined,branchingOperation:undefined};const previousBranchingId=this.branchingOperationIds.get(previousBranch);if(!previousBranchingId)
return{previousBranch:undefined,branchingOperation:undefined};return{previousBranch,branchingOperation:previousBranch.getOperation(previousBranchingId),};}
nextBranch(branch){const index=this.branches.findIndex((l)=>l===branch);if(index===-1){return undefined;}
return this.branches[index+1];}
previousBranch(branch){const index=this.branches.findIndex((l)=>l===branch);if(index===-1){return undefined;}
return this.branches[index-1];}*_revertedExecution(branch){const branchingOperationId=this.branchingOperationIds.get(branch);let afterBranchingPoint=!!branchingOperationId;const operations=branch.getOperations();for(let i=operations.length-1;i>=0;i--){const operation=operations[i];if(operation.id===branchingOperationId){afterBranchingPoint=false;}
if(!afterBranchingPoint){yield{operation:operation,branch:branch,isCancelled:!this.shouldExecute(branch,operation),};}}
const previous=this.previousBranch(branch);yield*previous?this._revertedExecution(previous):[];}*_execution(branch){for(const operation of branch.getOperations()){yield{operation:operation,branch:branch,isCancelled:!this.shouldExecute(branch,operation),};if(operation.id===this.branchingOperationIds.get(branch)){const next=this.nextBranch(branch);yield*next?this._execution(next):[];return;}}
if(!this.branchingOperationIds.get(branch)){const next=this.nextBranch(branch);yield*next?this._execution(next):[];}}}
class SelectiveHistory{HEAD_BRANCH;HEAD_OPERATION;tree;applyOperation;revertOperation;buildEmpty;buildTransformation;constructor(args){this.applyOperation=args.applyOperation;this.revertOperation=args.revertOperation;this.buildEmpty=args.buildEmpty;this.buildTransformation=args.buildTransformation;this.HEAD_BRANCH=new Branch(this.buildTransformation);this.tree=new Tree(this.buildTransformation,this.HEAD_BRANCH);const initialOperationId=args.initialOperationId;const initial=new Operation(initialOperationId,this.buildEmpty(initialOperationId));this.tree.insertOperationLast(this.HEAD_BRANCH,initial);this.HEAD_OPERATION=initial;}
get(operationId){return this.tree.findOperation(this.HEAD_BRANCH,operationId).operation.data;}
append(operationId,data){const operation=new Operation(operationId,data);const branch=this.tree.getLastBranch();this.tree.insertOperationLast(branch,operation);this.HEAD_BRANCH=branch;this.HEAD_OPERATION=operation;}
insert(operationId,data,insertAfter){const operation=new Operation(operationId,data);this.revertTo(insertAfter);this.tree.insertOperationAfter(this.HEAD_BRANCH,operation,insertAfter);this.fastForward();}
undo(operationId,undoId,insertAfter){const{branch,operation}=this.tree.findOperation(this.HEAD_BRANCH,operationId);this.revertBefore(operationId);this.tree.undo(branch,operation);this.fastForward();this.insert(undoId,this.buildEmpty(undoId),insertAfter);}
redo(operationId,redoId,insertAfter){const{branch}=this.tree.findOperation(this.HEAD_BRANCH,operationId);this.revertBefore(operationId);this.tree.redo(branch);this.fastForward();this.insert(redoId,this.buildEmpty(redoId),insertAfter);}
drop(operationId){this.revertBefore(operationId);this.tree.drop(operationId);}
getRevertedExecution(){const data=[];const operations=this.tree.revertedExecution(this.HEAD_BRANCH);for(const{operation}of operations){data.push(operation.data);}
return data;}
revertBefore(operationId){const execution=this.tree.revertedExecution(this.HEAD_BRANCH).stopWith(operationId);this.revert(execution);}
revertTo(operationId){const execution=operationId?this.tree.revertedExecution(this.HEAD_BRANCH).stopBefore(operationId):this.tree.revertedExecution(this.HEAD_BRANCH);this.revert(execution);}
revert(execution){for(const{next,operation,isCancelled}of execution){if(!isCancelled){this.revertOperation(operation.data);}
if(next){this.HEAD_BRANCH=next.branch;this.HEAD_OPERATION=next.operation;}}}
fastForward(){const operations=this.HEAD_OPERATION?this.tree.execution(this.HEAD_BRANCH).startAfter(this.HEAD_OPERATION.id):this.tree.execution(this.HEAD_BRANCH);for(const{operation:operation,branch,isCancelled}of operations){if(!isCancelled){this.applyOperation(operation.data);}
this.HEAD_OPERATION=operation;this.HEAD_BRANCH=branch;}}}
function buildRevisionLog(args){return new SelectiveHistory({initialOperationId:args.initialRevisionId,applyOperation:(revision)=>{const commands=revision.commands.slice();const{changes}=args.recordChanges(()=>{for(const command of commands){args.dispatch(command);}});revision.setChanges(changes);},revertOperation:(revision)=>revertChanges([revision]),buildEmpty:(id)=>new Revision(id,"empty",[]),buildTransformation:{with:(revision)=>(toTransform)=>{return new Revision(toTransform.id,toTransform.clientId,transformAll(toTransform.commands,revision.commands),toTransform.rootCommand,undefined,toTransform.timestamp);},without:(revision)=>(toTransform)=>{return new Revision(toTransform.id,toTransform.clientId,transformAll(toTransform.commands,revision.commands.map(inverseCommand).flat()),toTransform.rootCommand,undefined,toTransform.timestamp);},},});}
function revertChanges(revisions){for(const revision of revisions.slice().reverse()){for(let i=revision.changes.length-1;i>=0;i--){const change=revision.changes[i];applyChange(change,"before");}}}
function applyChange(change,target){let val=change.path[0];const key=change.path.at(-1);for(let pathIndex=1;pathIndex<change.path.slice(0,-1).length;pathIndex++){const p=change.path[pathIndex];if(val[p]===undefined){const nextPath=change.path[pathIndex+1];val[p]=createEmptyStructure(nextPath);}
val=val[p];}
if(change[target]===undefined){delete val[key];}
else{val[key]=change[target];}}
class EventStream{observers=new Map();defaultSubscription;mainSubscription;registerAsDefault(owner,callbacks){this.defaultSubscription={owner,callbacks};if(!this.mainSubscription){this.mainSubscription=this.defaultSubscription;}}
observe(owner,callbacks){this.observers.set(owner,{owner,callbacks});}
capture(owner,callbacks){if(this.observers.get(owner)){throw new Error("You are already subscribed forever");}
if(this.mainSubscription?.owner&&this.mainSubscription.owner!==owner){this.mainSubscription.callbacks.release?.();}
this.mainSubscription={owner,callbacks};}
release(owner){if(this.mainSubscription?.owner!==owner||this.observers.get(owner)){return;}
this.mainSubscription=this.defaultSubscription;}
getBackToDefault(){if(this.mainSubscription===this.defaultSubscription){return;}
this.mainSubscription?.callbacks.release?.();this.mainSubscription=this.defaultSubscription;}
isListening(owner){return this.mainSubscription?.owner===owner;}
send(event){this.mainSubscription?.callbacks.handleEvent(event);this.observers.forEach((sub)=>sub.callbacks.handleEvent(event));}}
class SelectionStreamProcessorImpl{getters;stream;anchor;defaultAnchor;constructor(getters){this.getters=getters;this.stream=new EventStream();this.anchor={cell:{col:0,row:0},zone:positionToZone({col:0,row:0})};this.defaultAnchor=this.anchor;}
capture(owner,anchor,callbacks){this.stream.capture(owner,callbacks);this.anchor=anchor;}
registerAsDefault(owner,anchor,callbacks){this.checkAnchorZoneOrThrow(anchor);this.stream.registerAsDefault(owner,callbacks);this.defaultAnchor=anchor;this.capture(owner,anchor,callbacks);}
resetDefaultAnchor(owner,anchor){this.checkAnchorZoneOrThrow(anchor);if(this.stream.isListening(owner)){this.anchor=anchor;}
this.defaultAnchor=anchor;}
resetAnchor(owner,anchor){this.checkAnchorZoneOrThrow(anchor);if(this.stream.isListening(owner)){this.anchor=anchor;}}
observe(owner,callbacks){this.stream.observe(owner,callbacks);}
release(owner){if(this.stream.isListening(owner)){this.stream.release(owner);this.anchor=this.defaultAnchor;}}
getBackToDefault(){this.stream.getBackToDefault();}
modifyAnchor(anchor,mode,options){const sheetId=this.getters.getActiveSheetId();anchor={...anchor,zone:this.getters.expandZone(sheetId,anchor.zone),};return this.processEvent({options,anchor,mode,});}
selectZone(anchor,options={scrollIntoView:true}){return this.modifyAnchor(anchor,"overrideSelection",options);}
selectCell(col,row){const zone=positionToZone({col,row});return this.selectZone({zone,cell:{col,row}},{scrollIntoView:true});}
moveAnchorCell(direction,step=1){if(step!=="end"&&step<=0){return new DispatchResult("InvalidSelectionStep");}
const{col,row}=this.getNextAvailablePosition(direction,step);return this.selectCell(col,row);}
setAnchorCorner(col,row){const sheetId=this.getters.getActiveSheetId();const{col:anchorCol,row:anchorRow}=this.anchor.cell;const zone={left:Math.min(anchorCol,col),top:Math.min(anchorRow,row),right:Math.max(anchorCol,col),bottom:Math.max(anchorRow,row),};const expandedZone=this.getters.expandZone(sheetId,zone);const anchor={zone:expandedZone,cell:{col:anchorCol,row:anchorRow}};return this.processEvent({mode:"updateAnchor",anchor:anchor,options:{scrollIntoView:false},});}
addCellToSelection(col,row){const sheetId=this.getters.getActiveSheetId();({col,row}=this.getters.getMainCellPosition({sheetId,col,row}));const zone=this.getters.expandZone(sheetId,positionToZone({col,row}));return this.processEvent({options:{scrollIntoView:true},anchor:{zone,cell:{col,row}},mode:"newAnchor",});}
resizeAnchorZone(direction,step=1){if(step!=="end"&&step<=0){return new DispatchResult("InvalidSelectionStep");}
const sheetId=this.getters.getActiveSheetId();const anchor=this.anchor;const{col:anchorCol,row:anchorRow}=anchor.cell;const{left,right,top,bottom}=anchor.zone;const starting=this.getStartingPosition(direction);let[deltaCol,deltaRow]=this.deltaToTarget(starting,direction,step);if(deltaCol===0&&deltaRow===0){return DispatchResult.Success;}
let result=anchor.zone;const expand=(z)=>{z=organizeZone(z);const{left,right,top,bottom}=this.getters.expandZone(sheetId,z);return{left:Math.max(0,left),right:Math.min(this.getters.getNumberCols(sheetId)-1,right),top:Math.max(0,top),bottom:Math.min(this.getters.getNumberRows(sheetId)-1,bottom),};};const{col:refCol,row:refRow}=this.getReferencePosition();let n=0;while(result!==null){n++;if(deltaCol<0){const newRight=this.getNextAvailableCol(deltaCol,right-(n-1),refRow);result=refCol<=right-n?expand({top,left,bottom,right:newRight}):null;}
if(deltaCol>0){const newLeft=this.getNextAvailableCol(deltaCol,left+(n-1),refRow);result=left+n<=refCol?expand({top,left:newLeft,bottom,right}):null;}
if(deltaRow<0){const newBottom=this.getNextAvailableRow(deltaRow,refCol,bottom-(n-1));result=refRow<=bottom-n?expand({top,left,bottom:newBottom,right}):null;}
if(deltaRow>0){const newTop=this.getNextAvailableRow(deltaRow,refCol,top+(n-1));result=top+n<=refRow?expand({top:newTop,left,bottom,right}):null;}
result=result?organizeZone(result):result;if(result&&!isEqual(result,anchor.zone)){return this.processEvent({options:{scrollIntoView:true},mode:"updateAnchor",anchor:{zone:result,cell:{col:anchorCol,row:anchorRow}},});}}
const currentZone={top:anchorRow,bottom:anchorRow,left:anchorCol,right:anchorCol,};const zoneWithDelta=organizeZone({top:this.getNextAvailableRow(deltaRow,refCol,top),left:this.getNextAvailableCol(deltaCol,left,refRow),bottom:this.getNextAvailableRow(deltaRow,refCol,bottom),right:this.getNextAvailableCol(deltaCol,right,refRow),});result=expand(union(currentZone,zoneWithDelta));const newAnchor={zone:result,cell:{col:anchorCol,row:anchorRow}};return this.processEvent({anchor:newAnchor,mode:"updateAnchor",options:{scrollIntoView:true},});}
selectColumn(index,mode){const sheetId=this.getters.getActiveSheetId();const bottom=this.getters.getNumberRows(sheetId)-1;let zone={left:index,right:index,top:0,bottom};const top=this.getters.findFirstVisibleColRowIndex(sheetId,"ROW");let col,row;switch(mode){case"overrideSelection":case"newAnchor":col=index;row=top;break;case"updateAnchor":({col,row}=this.anchor.cell);zone=union(zone,{left:col,right:col,top,bottom});break;}
return this.processEvent({options:{scrollIntoView:false,unbounded:true,},anchor:{zone,cell:{col,row}},mode,});}
selectRow(index,mode){const sheetId=this.getters.getActiveSheetId();const right=this.getters.getNumberCols(sheetId)-1;let zone={top:index,bottom:index,left:0,right};const left=this.getters.findFirstVisibleColRowIndex(sheetId,"COL");let col,row;switch(mode){case"overrideSelection":case"newAnchor":col=left;row=index;break;case"updateAnchor":({col,row}=this.anchor.cell);zone=union(zone,{left,right,top:row,bottom:row});break;}
return this.processEvent({options:{scrollIntoView:false,unbounded:true,},anchor:{zone,cell:{col,row}},mode,});}
loopSelection(){const sheetId=this.getters.getActiveSheetId();const anchor=this.anchor;if(isEqual(this.anchor.zone,this.getters.getSheetZone(sheetId))){return this.modifyAnchor({...anchor,zone:positionToZone(anchor.cell)},"updateAnchor",{scrollIntoView:false,});}
const tableZone=this.expandZoneToTable(anchor.zone);return!deepEquals(tableZone,anchor.zone)?this.modifyAnchor({...anchor,zone:tableZone},"updateAnchor",{scrollIntoView:false,}):this.selectAll();}
selectTableAroundSelection(){const tableZone=this.expandZoneToTable(this.anchor.zone);return this.modifyAnchor({...this.anchor,zone:tableZone},"updateAnchor",{scrollIntoView:false,});}
selectAll(){const sheetId=this.getters.getActiveSheetId();const bottom=this.getters.getNumberRows(sheetId)-1;const right=this.getters.getNumberCols(sheetId)-1;const zone={left:0,top:0,bottom,right};return this.processEvent({mode:"overrideSelection",anchor:{zone,cell:this.anchor.cell},options:{scrollIntoView:false,},});}
isListening(owner){return this.stream.isListening(owner);}
processEvent(newAnchorEvent){const event={...newAnchorEvent,previousAnchor:deepCopy(this.anchor)};const commandResult=this.checkEventAnchorZone(event);if(commandResult!=="Success"){return new DispatchResult(commandResult);}
this.anchor=event.anchor;this.stream.send(event);return DispatchResult.Success;}
checkEventAnchorZone(event){return this.checkAnchorZone(event.anchor);}
checkAnchorZone(anchor){const{cell,zone}=anchor;if(!isInside(cell.col,cell.row,zone)){return"InvalidAnchorZone";}
const{left,right,top,bottom}=zone;const sheetId=this.getters.getActiveSheetId();const refCol=this.getters.findVisibleHeader(sheetId,"COL",left,right);const refRow=this.getters.findVisibleHeader(sheetId,"ROW",top,bottom);if(refRow===undefined||refCol===undefined){return"SelectionOutOfBound";}
return"Success";}
checkAnchorZoneOrThrow(anchor){const result=this.checkAnchorZone(anchor);if(result==="InvalidAnchorZone"){throw new Error(_t("The provided anchor is invalid. The cell must be part of the zone."));}}
getNextAvailablePosition(direction,step=1){const{col,row}=this.anchor.cell;const delta=this.deltaToTarget({col,row},direction,step);return{col:this.getNextAvailableCol(delta[0],col,row),row:this.getNextAvailableRow(delta[1],col,row),};}
getNextAvailableCol(delta,colIndex,rowIndex){const sheetId=this.getters.getActiveSheetId();const position={col:colIndex,row:rowIndex};const isInPositionMerge=(nextCol)=>this.getters.isInSameMerge(sheetId,colIndex,rowIndex,nextCol,rowIndex);return this.getNextAvailableHeader(delta,"COL",colIndex,position,isInPositionMerge);}
getNextAvailableRow(delta,colIndex,rowIndex){const sheetId=this.getters.getActiveSheetId();const position={col:colIndex,row:rowIndex};const isInPositionMerge=(nextRow)=>this.getters.isInSameMerge(sheetId,colIndex,rowIndex,colIndex,nextRow);return this.getNextAvailableHeader(delta,"ROW",rowIndex,position,isInPositionMerge);}
getNextAvailableHeader(delta,dimension,startingHeaderIndex,position,isInPositionMerge){const sheetId=this.getters.getActiveSheetId();if(delta===0){return startingHeaderIndex;}
const step=Math.sign(delta);let header=startingHeaderIndex+delta;while(isInPositionMerge(header)){header+=step;}
while(this.getters.isHeaderHidden(sheetId,dimension,header)){header+=step;}
const outOfBound=header<0||header>this.getters.getNumberHeaders(sheetId,dimension)-1;if(outOfBound){if(this.getters.isHeaderHidden(sheetId,dimension,startingHeaderIndex)){return this.getNextAvailableHeader(-step,dimension,startingHeaderIndex,position,isInPositionMerge);}
else{return startingHeaderIndex;}}
return header;}
getReferencePosition(){const sheetId=this.getters.getActiveSheetId();const anchor=this.anchor;const{left,right,top,bottom}=anchor.zone;const{col:anchorCol,row:anchorRow}=anchor.cell;return{col:this.getters.isColHidden(sheetId,anchorCol)?this.getters.findVisibleHeader(sheetId,"COL",left,right)||anchorCol:anchorCol,row:this.getters.isRowHidden(sheetId,anchorRow)?this.getters.findVisibleHeader(sheetId,"ROW",top,bottom)||anchorRow:anchorRow,};}
deltaToTarget(position,direction,step){switch(direction){case"up":return step!=="end"?[0,-step]:[0,this.getEndOfCluster(position,"rows",-1)-position.row];case"down":return step!=="end"?[0,step]:[0,this.getEndOfCluster(position,"rows",1)-position.row];case"left":return step!=="end"?[-step,0]:[this.getEndOfCluster(position,"cols",-1)-position.col,0];case"right":return step!=="end"?[step,0]:[this.getEndOfCluster(position,"cols",1)-position.col,0];}}
getStartingPosition(direction){let{col,row}=this.getPosition();const zone=this.anchor.zone;switch(direction){case"down":case"up":row=row===zone.top?zone.bottom:zone.top;break;case"left":case"right":col=col===zone.right?zone.left:zone.right;break;}
return{col,row};}
getEndOfCluster(startPosition,dim,dir){let currentPosition=startPosition;const nextCellPosition=this.getNextCellPosition(startPosition,dim,dir);let mode=!this.isEvaluatedCellEmpty(currentPosition)&&!this.isEvaluatedCellEmpty(nextCellPosition)?"endOfCluster":"nextCluster";while(true){const nextCellPosition=this.getNextCellPosition(currentPosition,dim,dir);if(currentPosition.col===nextCellPosition.col&&currentPosition.row===nextCellPosition.row){break;}
const isNextCellEmpty=this.isEvaluatedCellEmpty(nextCellPosition);if(mode==="endOfCluster"&&isNextCellEmpty){break;}
else if(mode==="nextCluster"&&!isNextCellEmpty){currentPosition=nextCellPosition;break;}
currentPosition=nextCellPosition;}
return dim==="cols"?currentPosition.col:currentPosition.row;}
isCellEmpty({col,row}){const sheetId=this.getters.getActiveSheetId();const position=this.getters.getMainCellPosition({sheetId,col,row});return!(this.getters.getCorrespondingFormulaCell(position)||this.getters.getCell(position)?.content);}
isEvaluatedCellEmpty({col,row}){const sheetId=this.getters.getActiveSheetId();const position=this.getters.getMainCellPosition({sheetId,col,row});const cell=this.getters.getEvaluatedCell(position);return cell.type===CellValueType.empty;}
getNextCellPosition(currentPosition,dimension,direction){const dimOfInterest=dimension==="cols"?"col":"row";const startingPosition={...currentPosition};const nextCoord=dimension==="cols"?this.getNextAvailableCol(direction,startingPosition.col,startingPosition.row):this.getNextAvailableRow(direction,startingPosition.col,startingPosition.row);startingPosition[dimOfInterest]=nextCoord;return{col:startingPosition.col,row:startingPosition.row};}
getPosition(){return{...this.anchor.cell};}
expandZoneToTable(zoneToExpand){const expandZone=(zone)=>{for(const col of range(zone.left,zone.right+1)){if(!this.isCellEmpty({col,row:zone.top-1})){return{...zone,top:zone.top-1};}
if(!this.isCellEmpty({col,row:zone.bottom+1})){return{...zone,bottom:zone.bottom+1};}}
for(const row of range(zone.top,zone.bottom+1)){if(!this.isCellEmpty({col:zone.left-1,row})){return{...zone,left:zone.left-1};}
if(!this.isCellEmpty({col:zone.right+1,row})){return{...zone,right:zone.right+1};}}
return zone;};let hasExpanded=false;let zone=zoneToExpand;do{hasExpanded=false;const newZone=expandZone(zone);if(!isEqual(zone,newZone)){hasExpanded=true;zone=newZone;continue;}}while(hasExpanded);return zone;}}
class StateObserver{changes=[];commands=[];recordChanges(callback){this.changes=[];this.commands=[];callback();return{changes:this.changes,commands:this.commands};}
addCommand(command){this.commands.push(command);}
addChange(...args){const val=args.pop();const root=args[0];let value=root;let key=args.at(-1);const pathLength=args.length-2;for(let pathIndex=1;pathIndex<=pathLength;pathIndex++){const p=args[pathIndex];if(value[p]===undefined){const nextPath=args[pathIndex+1];value[p]=createEmptyStructure(nextPath);}
value=value[p];}
if(value[key]===val){return;}
this.changes.push({path:args,before:value[key],after:val,});if(val===undefined){delete value[key];}
else{value[key]=val;}}}
const catAxId=17781237;const valAxId=88853993;function createChart(chart,chartSheetIndex,data){const namespaces=[["xmlns:r",RELATIONSHIP_NSR],["xmlns:a",DRAWING_NS_A],["xmlns:c",DRAWING_NS_C],];const chartShapeProperty=shapeProperty({backgroundColor:chart.data.backgroundColor,line:{color:"000000"},});let title=escapeXml``;if(chart.data.title){title=escapeXml`
      <c:title>
        ${insertText(chart.data.title, chart.data.fontColor)}
        <c:overlay val="0" />
      </c:title>
    `;}
let plot=escapeXml``;switch(chart.data.type){case"bar":plot=addBarChart(chart.data);break;case"line":plot=addLineChart(chart.data);break;case"pie":plot=addDoughnutChart(chart.data,chartSheetIndex,data,{holeSize:0});break;}
let position="t";switch(chart.data.legendPosition){case"bottom":position="b";break;case"left":position="l";break;case"right":position="r";break;case"top":position="t";break;}
const fontColor=chart.data.fontColor;const xml=escapeXml`
    <c:chartSpace ${formatAttributes(namespaces)}>
      <c:roundedCorners val="0" />
      <!-- <manualLayout/> to manually position the chart in the figure container -->
      ${chartShapeProperty}
      <c:chart>
        ${title}
        <c:autoTitleDeleted val="0" />
        <c:plotArea>
          <!-- how the chart element is placed on the chart -->
          <c:layout />
          ${plot}
          ${shapeProperty({ backgroundColor: chart.data.backgroundColor })}
        </c:plotArea>
        ${addLegend(position, fontColor)}
      </c:chart>
    </c:chartSpace>
  `;return parseXML(xml);}
function shapeProperty(params){return escapeXml`
    <c:spPr>
      ${params.backgroundColor ? solidFill(params.backgroundColor) : ""}
      ${params.line ? lineAttributes(params.line) : ""}
    </c:spPr>
  `;}
function solidFill(color){return escapeXml`
    <a:solidFill>
      <a:srgbClr val="${color}"/>
    </a:solidFill>
  `;}
function lineAttributes(params){const attrs=[["cmpd","sng"]];if(params.width){attrs.push(["w",convertDotValueToEMU(params.width)]);}
const lineStyle=params.style?escapeXml`<a:prstDash val="${params.style}"/>`:"";return escapeXml`
    <a:ln ${formatAttributes(attrs)}>
      ${solidFill(params.color)}
      ${lineStyle}
    </a:ln>
  `;}
function insertText(text,fontColor="000000",fontsize=22){return escapeXml`
    <c:tx>
      <c:rich>
        <a:bodyPr />
        <a:lstStyle />
        <a:p>
          <a:pPr lvl="0">
            <a:defRPr b="0">
              ${solidFill(fontColor)}
              <a:latin typeface="+mn-lt"/>
            </a:defRPr>
          </a:pPr>
          <a:r> <!-- Runs -->
            <a:rPr sz="${fontsize * 100}"/>
            <a:t>${text}</a:t>
          </a:r>
        </a:p>
      </c:rich>
    </c:tx>
  `;}
function insertTextProperties(fontsize=12,fontColor="000000",bold=false,italic=false){const defPropertiesAttributes=[["b",bold?"1":"0"],["i",italic?"1":"0"],["sz",fontsize*100],];return escapeXml`
    <c:txPr>
      <a:bodyPr/>
      <a:lstStyle/>
      <a:p>
        <a:pPr lvl="0">
          <a:defRPr ${formatAttributes(defPropertiesAttributes)}>
            ${solidFill(fontColor)}
            <a:latin typeface="+mn-lt"/>
          </a:defRPr>
        </a:pPr>
      </a:p>
    </c:txPr>
  `;}
function addBarChart(chart){const colors=new ChartColors();const dataSetsNodes=[];for(const[dsIndex,dataset]of Object.entries(chart.dataSets)){const color=toXlsxHexColor(colors.next());const dataShapeProperty=shapeProperty({backgroundColor:color,line:{color},});dataSetsNodes.push(escapeXml`
      <c:ser>
        <c:idx val="${dsIndex}"/>
        <c:order val="${dsIndex}"/>
        ${dataset.label ? escapeXml /*xml*/ `<c:tx>${stringRef(dataset.label)}</c:tx>` : ""}
        ${dataShapeProperty}
        ${chart.labelRange ? escapeXml /*xml*/ `<c:cat>${stringRef(chart.labelRange)}</c:cat>` : ""} <!-- x-coordinate values -->
        <c:val> <!-- x-coordinate values -->
          ${numberRef(dataset.range)}
        </c:val>
      </c:ser>
    `);}
const axisPos=chart.verticalAxisPosition==="left"?"l":"r";const grouping=chart.stacked?"stacked":"clustered";const overlap=chart.stacked?100:-20;return escapeXml`
    <c:barChart>
      <c:barDir val="col"/>
      <c:grouping val="${grouping}"/>
      <c:overlap val="${overlap}"/>
      <c:gapWidth val="70"/>
      <!-- each data marker in the series does not have a different color -->
      <c:varyColors val="0"/>
      ${joinXmlNodes(dataSetsNodes)}
      <c:axId val="${catAxId}" />
      <c:axId val="${valAxId}" />
    </c:barChart>
    ${addAx("b", "c:catAx", catAxId, valAxId, { fontColor: chart.fontColor })}
    ${addAx(axisPos, "c:valAx", valAxId, catAxId, { fontColor: chart.fontColor })}
  `;}
function addLineChart(chart){const colors=new ChartColors();const dataSetsNodes=[];for(const[dsIndex,dataset]of Object.entries(chart.dataSets)){const dataShapeProperty=shapeProperty({line:{width:2.5,style:"solid",color:toXlsxHexColor(colors.next()),},});dataSetsNodes.push(escapeXml`
      <c:ser>
        <c:idx val="${dsIndex}"/>
        <c:order val="${dsIndex}"/>
        <c:smooth val="0"/>
        <c:marker>
          <c:symbol val="circle" />
          <c:size val="5"/>
        </c:marker>
        ${dataset.label ? escapeXml `<c:tx>${stringRef(dataset.label)}</c:tx>` : ""}
        ${dataShapeProperty}
        ${chart.labelRange ? escapeXml `<c:cat>${stringRef(chart.labelRange)}</c:cat>` : ""} <!-- x-coordinate values -->
        <c:val> <!-- x-coordinate values -->
          ${numberRef(dataset.range)}
        </c:val>
      </c:ser>
    `);}
const axisPos=chart.verticalAxisPosition==="left"?"l":"r";const grouping=chart.stacked?"stacked":"standard";return escapeXml`
    <c:lineChart>
      <c:grouping val="${grouping}"/>
      <!-- each data marker in the series does not have a different color -->
      <c:varyColors val="0"/>
      ${joinXmlNodes(dataSetsNodes)}
      <c:axId val="${catAxId}" />
      <c:axId val="${valAxId}" />
    </c:lineChart>
    ${addAx("b", "c:catAx", catAxId, valAxId, { fontColor: chart.fontColor })}
    ${addAx(axisPos, "c:valAx", valAxId, catAxId, { fontColor: chart.fontColor })}
  `;}
function addDoughnutChart(chart,chartSheetIndex,data,{holeSize}={holeSize:50}){const colors=new ChartColors();const maxLength=largeMax(chart.dataSets.map((ds)=>getRangeSize(ds.range,chartSheetIndex,data)));const doughnutColors=range(0,maxLength).map(()=>toXlsxHexColor(colors.next()));const dataSetsNodes=[];for(const[dsIndex,dataset]of Object.entries(chart.dataSets).reverse()){const dsSize=getRangeSize(dataset.range,chartSheetIndex,data);const dataPoints=[];for(const index of range(0,dsSize)){const pointShapeProperty=shapeProperty({backgroundColor:doughnutColors[index],line:{color:"FFFFFF",width:1.5},});dataPoints.push(escapeXml`
        <c:dPt>
          <c:idx val="${index}"/>
          ${pointShapeProperty}
        </c:dPt>
      `);}
dataSetsNodes.push(escapeXml`
      <c:ser>
        <c:idx val="${dsIndex}"/>
        <c:order val="${dsIndex}"/>
        ${dataset.label ? escapeXml `<c:tx>${stringRef(dataset.label)}</c:tx>` : ""}
        ${joinXmlNodes(dataPoints)}
        ${insertDataLabels({ showLeaderLines: true })}
        ${chart.labelRange ? escapeXml `<c:cat>${stringRef(chart.labelRange)}</c:cat>` : ""}
        <c:val>
          ${numberRef(dataset.range)}
        </c:val>
      </c:ser>
    `);}
return escapeXml`
    <c:doughnutChart>
      <c:varyColors val="1" />
      <c:holeSize val="${holeSize}" />
      ${insertDataLabels()}
      ${joinXmlNodes(dataSetsNodes)}
    </c:doughnutChart>
  `;}
function insertDataLabels({showLeaderLines}={showLeaderLines:false}){return escapeXml`
    <dLbls>
      <c:showLegendKey val="0"/>
      <c:showVal val="0"/>
      <c:showCatName val="0"/>
      <c:showSerName val="0"/>
      <c:showPercent val="0"/>
      <c:showBubbleSize val="0"/>
      <c:showLeaderLines val="${showLeaderLines ? "1" : "0"}"/>
    </dLbls>
  `;}
function addAx(position,axisName,axId,crossAxId,{fontColor}){return escapeXml`
    <${axisName}>
      <c:axId val="${axId}"/>
      <c:crossAx val="${crossAxId}"/> <!-- reference to the other axe of the chart -->
      <c:delete val="0"/> <!-- by default, axis are not displayed -->
      <c:scaling>
        <c:orientation  val="minMax" />
      </c:scaling>
      <c:axPos val="${position}" />
      ${insertMajorGridLines()}
      <c:majorTickMark val="out" />
      <c:minorTickMark val="none" />
      <c:numFmt formatCode="General" sourceLinked="1" />
      <c:title>
        ${insertText("")}
      </c:title>
      ${insertTextProperties(10, fontColor)}
    </${axisName}>
    <!-- <tickLblPos/> omitted -->
  `;}
function addLegend(position,fontColor){return escapeXml`
    <c:legend>
      <c:legendPos val="${position}"/>
      <c:overlay val="0"/>
      ${insertTextProperties(10, fontColor)}
    </c:legend>
  `;}
function insertMajorGridLines(color="B7B7B7"){return escapeXml`
    <c:majorGridlines>
      ${shapeProperty({ line: { color } })}
    </c:majorGridlines>
  `;}
function stringRef(reference){return escapeXml`
    <c:strRef>
      <c:f>${reference}</c:f>
    </c:strRef>
  `;}
function numberRef(reference){return escapeXml`
    <c:numRef>
      <c:f>${reference}</c:f>
      <c:numCache />
    </c:numRef>
  `;}
function addFormula(cell){const formula=cell.content;if(!formula){return{attrs:[],node:escapeXml``};}
const attrs=[];let node=escapeXml``;let cycle=escapeXml``;const XlsxFormula=adaptFormulaToExcel(formula);if(cell.value===CellErrorType.CircularDependency){attrs.push(["t","str"]);cycle=escapeXml`<v>${cell.value}</v>`;}
node=escapeXml`<f>${XlsxFormula}</f>${cycle}`;return{attrs,node};}
function addContent(content,sharedStrings,forceString=false){let value=content;const attrs=[];const clearValue=value.trim().toUpperCase();if(!forceString&&["TRUE","FALSE"].includes(clearValue)){value=clearValue==="TRUE"?"1":"0";attrs.push(["t","b"]);}
else if(forceString||!isNumber(value,DEFAULT_LOCALE)){value=pushElement(content,sharedStrings);attrs.push(["t","s"]);}
return{attrs,node:escapeXml`<v>${value}</v>`};}
function adaptFormulaToExcel(formulaText){if(formulaText[0]==="="){formulaText=formulaText.slice(1);}
let ast;try{ast=parse(formulaText);}
catch(error){return formulaText;}
ast=convertAstNodes(ast,"STRING",convertDateFormat);ast=convertAstNodes(ast,"FUNCALL",(ast)=>{ast={...ast,value:ast.value.toUpperCase()};ast=prependNonRetrocompatibleFunction(ast);ast=addMissingRequiredArgs(ast);return ast;});return ast?astToFormula(ast):formulaText;}
function addMissingRequiredArgs(ast){const formulaName=ast.value.toUpperCase();const args=ast.args;const exportDefaultArgs=FORCE_DEFAULT_ARGS_FUNCTIONS[formulaName];if(exportDefaultArgs){const requiredArgs=functionRegistry.content[formulaName].args.filter((el)=>!el.optional);const diffArgs=requiredArgs.length-ast.args.length;if(diffArgs){for(let i=ast.args.length;i<requiredArgs.length;i++){const currentDefaultArg=exportDefaultArgs[i-diffArgs];args.push({type:currentDefaultArg.type,value:currentDefaultArg.value});}}}
return{...ast,args};}
function prependNonRetrocompatibleFunction(ast){const formulaName=ast.value.toUpperCase();return{...ast,value:NON_RETROCOMPATIBLE_FUNCTIONS.includes(formulaName)?`_xlfn.${formulaName}`:formulaName,};}
function convertDateFormat(ast){const value=ast.value.replace(new RegExp('"',"g"),"");const internalDate=parseDateTime(value,DEFAULT_LOCALE);if(internalDate){let format=[];if(mdyDateRegexp.test(value)||ymdDateRegexp.test(value)){format.push("yyyy-mm-dd");}
if(timeRegexp.test(value)){format.push("hh:mm:ss");}
return{...ast,value:formatValue(internalDate.value,{format:format.join(" "),locale:DEFAULT_LOCALE}),};}
else{return{...ast,value:ast.value.replace(/\\"/g,`""`)};}}
function addConditionalFormatting(dxfs,conditionalFormats){const cfNodes=[];for(const cf of conditionalFormats){switch(cf.rule.type){case"CellIsRule":cfNodes.push(addCellIsRule(cf,cf.rule,dxfs));break;case"ColorScaleRule":cfNodes.push(addColorScaleRule(cf,cf.rule));break;case"IconSetRule":cfNodes.push(addIconSetRule(cf,cf.rule));break;default:console.warn(`Conditional formatting ${cf.rule.type} not implemented`);break;}}
return cfNodes;}
function addCellIsRule(cf,rule,dxfs){const ruleAttributes=commonCfAttributes(cf);const operator=convertOperator(rule.operator);ruleAttributes.push(...cellRuleTypeAttributes(rule),["operator",operator]);const formulas=cellRuleFormula(cf.ranges,rule).map((formula)=>escapeXml`<formula>${formula}</formula>`);const dxf={font:{color:{rgb:rule.style.textColor},bold:rule.style.bold,italic:rule.style.italic,strike:rule.style.strikethrough,underline:rule.style.underline,},};if(rule.style.fillColor){dxf.fill={fgColor:{rgb:rule.style.fillColor}};}
ruleAttributes.push(["dxfId",pushElement(dxf,dxfs)]);return escapeXml`
    <conditionalFormatting sqref="${cf.ranges.join(" ")}">
      <cfRule ${formatAttributes(ruleAttributes)}>
        ${joinXmlNodes(formulas)}
      </cfRule>
    </conditionalFormatting>
  `;}
function cellRuleFormula(ranges,rule){const firstCell=ranges[0].split(":")[0];const values=rule.values;switch(rule.operator){case"ContainsText":return[`NOT(ISERROR(SEARCH("${values[0]}",${firstCell})))`];case"NotContains":return[`ISERROR(SEARCH("${values[0]}",${firstCell}))`];case"BeginsWith":return[`LEFT(${firstCell},LEN("${values[0]}"))="${values[0]}"`];case"EndsWith":return[`RIGHT(${firstCell},LEN("${values[0]}"))="${values[0]}"`];case"IsEmpty":return[`LEN(TRIM(${firstCell}))=0`];case"IsNotEmpty":return[`LEN(TRIM(${firstCell}))>0`];case"Equal":case"NotEqual":case"GreaterThan":case"GreaterThanOrEqual":case"LessThan":case"LessThanOrEqual":return[values[0]];case"Between":case"NotBetween":return[values[0],values[1]];}}
function cellRuleTypeAttributes(rule){const operator=convertOperator(rule.operator);switch(rule.operator){case"ContainsText":case"NotContains":case"BeginsWith":case"EndsWith":return[["type",operator],["text",rule.values[0]],];case"IsEmpty":case"IsNotEmpty":return[["type",operator]];case"Equal":case"NotEqual":case"GreaterThan":case"GreaterThanOrEqual":case"LessThan":case"LessThanOrEqual":case"Between":case"NotBetween":return[["type","cellIs"]];}}
function addColorScaleRule(cf,rule){const ruleAttributes=commonCfAttributes(cf);ruleAttributes.push(["type","colorScale"]);const conditionalFormats=[];for(const range of cf.ranges){const cfValueObject=[];const colors=[];let canExport=true;for(let position of["minimum","midpoint","maximum"]){const threshold=rule[position];if(!threshold){continue;}
if(threshold.type==="formula"){canExport=false;continue;}
cfValueObject.push(thresholdAttributes(threshold,position));colors.push([["rgb",toXlsxHexColor(colorNumberString(threshold.color))]]);}
if(!canExport){console.warn("Conditional formats with formula rules are not supported at the moment. The rule is therefore skipped.");continue;}
const cfValueObjectNodes=cfValueObject.map((attrs)=>escapeXml`<cfvo ${formatAttributes(attrs)}/>`);const cfColorNodes=colors.map((attrs)=>escapeXml`<color ${formatAttributes(attrs)}/>`);conditionalFormats.push(escapeXml`
      <conditionalFormatting sqref="${range}">
        <cfRule ${formatAttributes(ruleAttributes)}>
          <colorScale>
            ${joinXmlNodes(cfValueObjectNodes)}
            ${joinXmlNodes(cfColorNodes)}
          </colorScale>
        </cfRule>
      </conditionalFormatting>
    `);}
return joinXmlNodes(conditionalFormats);}
function addIconSetRule(cf,rule){const ruleAttributes=commonCfAttributes(cf);ruleAttributes.push(["type","iconSet"]);const conditionalFormats=[];for(const range of cf.ranges){const cfValueObject=[[["type","percent"],["val",0],],];let canExport=true;for(let position of["lowerInflectionPoint","upperInflectionPoint"]){if(rule[position].type==="formula"){canExport=false;continue;}
const threshold=rule[position];cfValueObject.push([...thresholdAttributes(threshold,position),["gte",threshold.operator==="ge"?"1":"0"],]);}
if(!canExport){console.warn("Conditional formats with formula rules are not supported at the moment. The rule is therefore skipped.");continue;}
const cfValueObjectNodes=cfValueObject.map((attrs)=>escapeXml`<cfvo ${formatAttributes(attrs)} />`);conditionalFormats.push(escapeXml`
      <conditionalFormatting sqref="${range}">
        <cfRule ${formatAttributes(ruleAttributes)}>
          <iconSet iconSet="${getIconSet(rule.icons)}">
            ${joinXmlNodes(cfValueObjectNodes)}
          </iconSet>
        </cfRule>
      </conditionalFormatting>
    `);}
return joinXmlNodes(conditionalFormats);}
function commonCfAttributes(cf){return[["priority",1],["stopIfTrue",cf.stopIfTrue?1:0],];}
function getIconSet(iconSet){return XLSX_ICONSET_MAP[Object.keys(XLSX_ICONSET_MAP).find((key)=>iconSet.upper.toLowerCase().startsWith(key))||"dots"];}
function thresholdAttributes(threshold,position){const type=getExcelThresholdType(threshold.type,position);const attrs=[["type",type]];if(type!=="min"&&type!=="max"){let val=threshold.value;if(type==="formula"){try{val=adaptFormulaToExcel(threshold.value);}
catch(error){val=threshold.value;}}
attrs.push(["val",val]);}
return attrs;}
function getExcelThresholdType(type,position){switch(type){case"value":return position==="minimum"?"min":"max";case"number":return"num";case"percentage":return"percent";default:return type;}}
function createDrawing(drawingRelIds,sheet,figures){const namespaces=[["xmlns:xdr",NAMESPACE.drawing],["xmlns:r",RELATIONSHIP_NSR],["xmlns:a",DRAWING_NS_A],["xmlns:c",DRAWING_NS_C],];const figuresNodes=[];for(const[figureIndex,figure]of Object.entries(figures)){switch(figure?.tag){case"chart":figuresNodes.push(createChartDrawing(figure,sheet,drawingRelIds[figureIndex]));break;case"image":figuresNodes.push(createImageDrawing(figure,sheet,drawingRelIds[figureIndex]));break;}}
const xml=escapeXml`
    <xdr:wsDr ${formatAttributes(namespaces)}>
      ${joinXmlNodes(figuresNodes)}
    </xdr:wsDr>
  `;return parseXML(xml);}
function convertFigureData(figure,sheet){const{x,y,height,width}=figure;const cols=Object.values(sheet.cols);const rows=Object.values(sheet.rows);const{index:colFrom,offset:offsetColFrom}=figureCoordinates(cols,x);const{index:colTo,offset:offsetColTo}=figureCoordinates(cols,x+width);const{index:rowFrom,offset:offsetRowFrom}=figureCoordinates(rows,y);const{index:rowTo,offset:offsetRowTo}=figureCoordinates(rows,y+height);return{from:{col:colFrom,colOff:offsetColFrom,row:rowFrom,rowOff:offsetRowFrom,},to:{col:colTo,colOff:offsetColTo,row:rowTo,rowOff:offsetRowTo,},};}
function figureCoordinates(headers,position){let currentPosition=0;for(const[headerIndex,header]of headers.entries()){if(currentPosition<=position&&position<currentPosition+header.size){return{index:headerIndex,offset:convertDotValueToEMU(position-currentPosition+FIGURE_BORDER_WIDTH),};}
else if(headerIndex<headers.length-1){currentPosition+=header.size;}}
return{index:headers.length-1,offset:convertDotValueToEMU(position-currentPosition+FIGURE_BORDER_WIDTH),};}
function createChartDrawing(figure,sheet,chartRelId){const{from,to}=convertFigureData(figure,sheet);const chartId=convertChartId(figure.id);const cNvPrAttrs=[["id",chartId],["name",`Chart ${chartId}`],["title","Chart"],];return escapeXml`
    <xdr:twoCellAnchor>
      <xdr:from>
        <xdr:col>${from.col}</xdr:col>
        <xdr:colOff>${from.colOff}</xdr:colOff>
        <xdr:row>${from.row}</xdr:row>
        <xdr:rowOff>${from.rowOff}</xdr:rowOff>
      </xdr:from>
      <xdr:to>
        <xdr:col>${to.col}</xdr:col>
        <xdr:colOff>${to.colOff}</xdr:colOff>
        <xdr:row>${to.row}</xdr:row>
        <xdr:rowOff>${to.rowOff}</xdr:rowOff>
      </xdr:to>
      <xdr:graphicFrame>
        <xdr:nvGraphicFramePr>
          <xdr:cNvPr ${formatAttributes(cNvPrAttrs)} />
          <xdr:cNvGraphicFramePr />
        </xdr:nvGraphicFramePr>
        <xdr:xfrm>
          <a:off x="0" y="0"/>
          <a:ext cx="0" cy="0"/>
        </xdr:xfrm>
        <a:graphic>
          <a:graphicData uri="${DRAWING_NS_C}">
            <c:chart r:id="${chartRelId}" />
          </a:graphicData>
        </a:graphic>
      </xdr:graphicFrame>
      <xdr:clientData fLocksWithSheet="0"/>
    </xdr:twoCellAnchor>
  `;}
function createImageDrawing(figure,sheet,imageRelId){const{from,to}=convertFigureData(figure,sheet);const imageId=convertImageId(figure.id);const cNvPrAttrs=[["id",imageId],["name",`Image ${imageId}`],["title","Image"],];const cx=convertDotValueToEMU(figure.width);const cy=convertDotValueToEMU(figure.height);return escapeXml`
    <xdr:twoCellAnchor editAs="oneCell">
      <xdr:from>
        <xdr:col>${from.col}</xdr:col>
        <xdr:colOff>${from.colOff}</xdr:colOff>
        <xdr:row>${from.row}</xdr:row>
        <xdr:rowOff>${from.rowOff}</xdr:rowOff>
      </xdr:from>
      <xdr:to>
        <xdr:col>${to.col}</xdr:col>
        <xdr:colOff>${to.colOff}</xdr:colOff>
        <xdr:row>${to.row}</xdr:row>
        <xdr:rowOff>${to.rowOff}</xdr:rowOff>
      </xdr:to>
      <xdr:pic>
        <xdr:nvPicPr>
          <xdr:cNvPr ${formatAttributes(cNvPrAttrs)}/>
          <xdr:cNvPicPr preferRelativeResize="0"/>
        </xdr:nvPicPr>
        <xdr:blipFill>
          <a:blip cstate="print" r:embed="${imageRelId}"/>
          <a:stretch>
            <a:fillRect/>
          </a:stretch>
        </xdr:blipFill>
        <xdr:spPr>
          <a:xfrm>
            <a:ext cx="${cx}" cy="${cy}" />
          </a:xfrm>
          <a:prstGeom prst="rect">
            <a:avLst/>
          </a:prstGeom>
          <a:noFill/>
        </xdr:spPr>
      </xdr:pic>
      <xdr:clientData fLocksWithSheet="0"/>
    </xdr:twoCellAnchor>
  `;}
function addNumberFormats(numFmts){const numFmtNodes=[];for(let[index,numFmt]of Object.entries(numFmts)){const numFmtAttrs=[["numFmtId",parseInt(index)+FIRST_NUMFMT_ID],["formatCode",numFmt.format],];numFmtNodes.push(escapeXml`
      <numFmt ${formatAttributes(numFmtAttrs)}/>
    `);}
return escapeXml`
    <numFmts count="${numFmts.length}">
      ${joinXmlNodes(numFmtNodes)}
    </numFmts>
  `;}
function addFont(font){if(isObjectEmptyRecursive(font)){return escapeXml``;}
return escapeXml`
    <font>
      ${font.bold ? escapeXml /*xml*/ `<b/>` : ""}
      ${font.italic ? escapeXml /*xml*/ `<i/>` : ""}
      ${font.underline ? escapeXml /*xml*/ `<u/>` : ""}
      ${font.strike ? escapeXml /*xml*/ `<strike/>` : ""}
      ${font.size ? escapeXml /*xml*/ `<sz val="${font.size}"/>` : ""}
      ${font.color && font.color.rgb
        ? escapeXml /*xml*/ `<color rgb="${toXlsxHexColor(font.color.rgb)}"/>`
        : ""}
      ${font.name ? escapeXml /*xml*/ `<name val="${font.name}"/>` : ""}
    </font>
  `;}
function addFonts(fonts){return escapeXml`
    <fonts count="${fonts.length}">
      ${joinXmlNodes(Object.values(fonts).map(addFont))}
    </fonts>
  `;}
function addFills(fills){const fillNodes=[];for(let fill of Object.values(fills)){if(fill.reservedAttribute!==undefined){fillNodes.push(escapeXml`
        <fill>
          <patternFill patternType="${fill.reservedAttribute}" />
        </fill>
      `);}
else{fillNodes.push(escapeXml`
        <fill>
          <patternFill patternType="solid">
            <fgColor rgb="${toXlsxHexColor(fill.fgColor.rgb)}" />
            <bgColor indexed="64" />
          </patternFill>
        </fill>
      `);}}
return escapeXml`
    <fills count="${fills.length}">
    ${joinXmlNodes(fillNodes)}
    </fills>
  `;}
function addBorders(borders){const borderNodes=[];for(let border of Object.values(borders)){borderNodes.push(escapeXml`
      <border>
        <left ${formatBorderAttribute(border["left"])}>
          ${addBorderColor(border["left"])}
        </left>
        <right ${formatBorderAttribute(border["right"])}>
          ${addBorderColor(border["right"])}
        </right>
        <top ${formatBorderAttribute(border["top"])}>
          ${addBorderColor(border["top"])}
        </top>
        <bottom ${formatBorderAttribute(border["bottom"])}>
          ${addBorderColor(border["bottom"])}
        </bottom>
        <diagonal ${formatBorderAttribute(border["diagonal"])}>
          ${addBorderColor(border["diagonal"])}
        </diagonal>
      </border>
    `);}
return escapeXml`
    <borders count="${borders.length}">
      ${joinXmlNodes(borderNodes)}
    </borders>
  `;}
function formatBorderAttribute(description){if(!description){return escapeXml``;}
return formatAttributes([["style",description.style]]);}
function addBorderColor(description){if(!description){return escapeXml``;}
return escapeXml`
    <color ${formatAttributes([["rgb", toXlsxHexColor(description.color.rgb)]])}/>
  `;}
function addStyles(styles){const styleNodes=[];for(let style of styles){const attributes=[["numFmtId",style.numFmtId],["fillId",style.fillId],["fontId",style.fontId],["borderId",style.borderId],];const alignAttrs=[];if(style.alignment&&style.alignment.vertical){alignAttrs.push(["vertical",style.alignment.vertical]);}
if(style.alignment&&style.alignment.horizontal){alignAttrs.push(["horizontal",style.alignment.horizontal]);}
if(style.alignment&&style.alignment.wrapText){alignAttrs.push(["wrapText","1"]);}
if(alignAttrs.length>0){attributes.push(["applyAlignment","1"]);styleNodes.push(escapeXml`<xf ${formatAttributes(attributes)}>${escapeXml /*xml*/ `<alignment ${formatAttributes(alignAttrs)}/>`}</xf>`);
            }
            else {
                styleNodes.push(escapeXml /*xml*/ `<xf ${formatAttributes(attributes)}/>`);
            }
        }
        return escapeXml /*xml*/ `<cellXfs count="${styles.length}">${joinXmlNodes(styleNodes)}</cellXfs>`;
    }
    /**
     * DXFS : Differential Formatting Records - Conditional formats
     */
    function addCellWiseConditionalFormatting(dxfs // cell-wise CF
    ) {
        const dxfNodes = [];
        for (const dxf of dxfs) {
            let fontNode = escapeXml ``;
            if (dxf.font) {
                fontNode = addFont(dxf.font);
            }
            let fillNode = escapeXml ``;
            if (dxf.fill) {
                fillNode = escapeXml /*xml*/ `<fill><patternFill><bgColor rgb="${toXlsxHexColor(dxf.fill.fgColor.rgb)}"/></patternFill></fill>`;
            }
            dxfNodes.push(escapeXml /*xml*/ `<dxf>${fontNode}
${fillNode}</dxf>`);
        }
        return escapeXml /*xml*/ `<dxfs count="${dxfs.length}">${joinXmlNodes(dxfNodes)}</dxfs>`;
    }

    const TABLE_DEFAULT_ATTRS = [
        ["name", "TableStyleLight8"],
        ["showFirstColumn", "0"],
        ["showLastColumn", "0"],
        ["showRowStripes", "0"],
        ["showColumnStripes", "0"],
    ];
    const TABLE_DEFAULT_STYLE = escapeXml /*xml*/ `<tableStyleInfo ${formatAttributes(TABLE_DEFAULT_ATTRS)}/>`;
    function createTable(table, tableId, sheetData) {
        const tableAttributes = [
            ["id", tableId],
            ["name", `Table${tableId}`],
            ["displayName", `Table${tableId}`],
            ["ref", table.range],
            ["xmlns", NAMESPACE.table],
            ["xmlns:xr", NAMESPACE.revision],
            ["xmlns:xr3", NAMESPACE.revision3],
            ["xmlns:mc", NAMESPACE.markupCompatibility],
        ];
        const xml = escapeXml /*xml*/ `<table ${formatAttributes(tableAttributes)}>${addAutoFilter(table)}
${addTableColumns(table,sheetData)}
${TABLE_DEFAULT_STYLE}</table>`;
        return parseXML(xml);
    }
    function addAutoFilter(table) {
        const autoFilterAttributes = [["ref", table.range]];
        return escapeXml /*xml*/ `<autoFilter ${formatAttributes(autoFilterAttributes)}>${joinXmlNodes(addFilterColumns(table))}</autoFilter>`;
    }
    function addFilterColumns(table) {
        const columns = [];
        for (const filter of table.filters) {
            const colXml = escapeXml /*xml*/ `<filterColumn ${formatAttributes([["colId",filter.colId]])}>${addFilter(filter)}</filterColumn>`;
            columns.push(colXml);
        }
        return columns;
    }
    function addFilter(filter) {
        const filterValues = filter.displayedValues.map((val) => escapeXml /*xml*/ `<filter ${formatAttributes([["val",val]])}/>`);
        const filterAttributes = filter.displayBlanks ? [["blank", 1]] : [];
        return escapeXml /*xml*/ `<filters ${formatAttributes(filterAttributes)}>${joinXmlNodes(filterValues)}</filters>`;
    }
    function addTableColumns(table, sheetData) {
        const tableZone = toZone(table.range);
        const columns = [];
        for (const i of range(0, zoneToDimension(tableZone).numberOfCols)) {
            const colHeaderXc = toXC(tableZone.left + i, tableZone.top);
            const colName = sheetData.cells[colHeaderXc]?.content || `col${i}`;
            const colAttributes = [
                ["id", i + 1],
                ["name", colName],
            ];
            columns.push(escapeXml /*xml*/ `<tableColumn ${formatAttributes(colAttributes)}/>`);
        }
        return escapeXml /*xml*/ `<tableColumns ${formatAttributes([["count",columns.length]])}>${joinXmlNodes(columns)}</tableColumns>`;
    }

    function addColumns(cols) {
        if (!Object.values(cols).length) {
            return escapeXml ``;
        }
        const colNodes = [];
        for (let [id, col] of Object.entries(cols)) {
            // Always force our own col width
            const attributes = [
                ["min", parseInt(id) + 1],
                ["max", parseInt(id) + 1],
                ["width", convertWidthToExcel(col.size || DEFAULT_CELL_WIDTH)],
                ["customWidth", 1],
                ["hidden", col.isHidden ? 1 : 0],
            ];
            colNodes.push(escapeXml /*xml*/ `<col ${formatAttributes(attributes)}/>`);
        }
        return escapeXml /*xml*/ `<cols>${joinXmlNodes(colNodes)}</cols>`;
    }
    function addRows(construct, data, sheet) {
        const rowNodes = [];
        for (let r = 0; r < sheet.rowNumber; r++) {
            const rowAttrs = [["r", r + 1]];
            const row = sheet.rows[r] || {};
            // Always force our own row height
            rowAttrs.push(["ht", convertHeightToExcel(row.size || DEFAULT_CELL_HEIGHT)], ["customHeight", 1], ["hidden", row.isHidden ? 1 : 0]);
            const cellNodes = [];
            for (let c = 0; c < sheet.colNumber; c++) {
                const xc = toXC(c, r);
                const cell = sheet.cells[xc];
                if (cell) {
                    const attributes = [["r", xc]];
                    // style
                    const id = normalizeStyle(construct, extractStyle(cell, data));
                    attributes.push(["s", id]);
                    let additionalAttrs = [];
                    let cellNode = escapeXml ``;
                    // Either formula or static value inside the cell
                    if (cell.isFormula) {
                        const res = addFormula(cell);
                        if (!res) {
                            continue;
                        }
                        ({ attrs: additionalAttrs, node: cellNode } = res);
                    }
                    else if (cell.content && isMarkdownLink(cell.content)) {
                        const { label } = parseMarkdownLink(cell.content);
                        ({ attrs: additionalAttrs, node: cellNode } = addContent(label, construct.sharedStrings));
                    }
                    else if (cell.content && cell.content !== "") {
                        const isTableHeader = isCellTableHeader(c, r, sheet);
                        ({ attrs: additionalAttrs, node: cellNode } = addContent(cell.content, construct.sharedStrings, isTableHeader));
                    }
                    attributes.push(...additionalAttrs);
                    // prettier-ignore
                    cellNodes.push(escapeXml /*xml*/ `<c ${formatAttributes(attributes)}>${cellNode}</c>`);
                }
            }
            if (cellNodes.length || row.size !== DEFAULT_CELL_HEIGHT || row.isHidden) {
                rowNodes.push(escapeXml /*xml*/ `<row ${formatAttributes(rowAttrs)}>${joinXmlNodes(cellNodes)}</row>`);
            }
        }
        return escapeXml /*xml*/ `<sheetData>${joinXmlNodes(rowNodes)}</sheetData>`;
    }
    function isCellTableHeader(col, row, sheet) {
        return sheet.filterTables.some((table) => {
            const zone = toZone(table.range);
            const headerZone = { ...zone, bottom: zone.top };
            return isInside(col, row, headerZone);
        });
    }
    function addHyperlinks(construct, data, sheetIndex) {
        const sheet = data.sheets[sheetIndex];
        const cells = sheet.cells;
        const linkNodes = [];
        for (const xc in cells) {
            const content = cells[xc]?.content;
            if (content && isMarkdownLink(content)) {
                const { label, url } = parseMarkdownLink(content);
                if (isSheetUrl(url)) {
                    const sheetId = parseSheetUrl(url);
                    const sheet = data.sheets.find((sheet) => sheet.id === sheetId);
                    const location = sheet ? `${sheet.name}!A1` : INCORRECT_RANGE_STRING;
                    const hyperlinkAttributes = [
                        ["display", label],
                        ["location", location],
                        ["ref", xc],
                    ];
                    linkNodes.push(escapeXml /*xml*/ `<hyperlink ${formatAttributes(hyperlinkAttributes)}/>`);
                }
                else {
                    const linkRelId = addRelsToFile(construct.relsFiles, `xl/worksheets/_rels/sheet${sheetIndex}.xml.rels`, {
                        target: withHttps(url),
                        type: XLSX_RELATION_TYPE.hyperlink,
                        targetMode: "External",
                    });
                    const hyperlinkAttributes = [
                        ["r:id", linkRelId],
                        ["ref", xc],
                    ];
                    linkNodes.push(escapeXml /*xml*/ `<hyperlink ${formatAttributes(hyperlinkAttributes)}/>`);
                }
            }
        }
        if (!linkNodes.length) {
            return escapeXml ``;
        }
        return escapeXml /*xml*/ `<hyperlinks>${joinXmlNodes(linkNodes)}</hyperlinks>`;
    }
    function addMerges(merges) {
        if (merges.length) {
            const mergeNodes = merges.map((merge) => escapeXml /*xml*/ `<mergeCell ref="${merge}"/>`);
            return escapeXml /*xml*/ `<mergeCells count="${merges.length}">${joinXmlNodes(mergeNodes)}</mergeCells>`;
        }
        else
            return escapeXml ``;
    }
    function addSheetViews(sheet) {
        const panes = sheet.panes;
        let splitPanes = escapeXml /*xml*/ ``;
        if (panes && (panes.xSplit || panes.ySplit)) {
            const xc = toXC(panes.xSplit, panes.ySplit);
            //workbookViewId should be defined in the workbook file but it seems like Excel has a default behaviour.
            const xSplit = panes.xSplit ? escapeXml `xSplit="${panes.xSplit}"` : "";
            const ySplit = panes.ySplit ? escapeXml `ySplit="${panes.ySplit}"` : "";
            const topRight = panes.xSplit ? escapeXml `<selection pane="topRight"/>` : "";
            const bottomLeft = panes.ySplit ? escapeXml `<selection pane="bottomLeft"/>` : "";
            const bottomRight = panes.xSplit && panes.ySplit ? escapeXml `<selection pane="bottomRight"/>` : "";
            splitPanes = escapeXml /*xml*/ `<pane
${xSplit}
${ySplit}
topLeftCell="${xc}"
activePane="${panes.xSplit ? (panes.ySplit ? "bottomRight" : "topRight") : "bottomLeft"}"
state="frozen"/>${topRight}
${bottomLeft}
${bottomRight}`;
        }
        const sheetViewAttrs = [
            ["showGridLines", sheet.areGridLinesVisible ? 1 : 0],
            ["workbookViewId", 0],
        ];
        let sheetView = escapeXml /*xml*/ `<sheetViews><sheetView ${formatAttributes(sheetViewAttrs)}>${splitPanes}</sheetView></sheetViews>`;
        return sheetView;
    }

    /**
     * Return the spreadsheet data in the Office Open XML file format.
     * See ECMA-376 standard.
     * https://www.ecma-international.org/publications-and-standards/standards/ecma-376/
     */
    function getXLSX(data) {
        const files = [];
        const construct = getDefaultXLSXStructure(data);
        files.push(createWorkbook(data, construct));
        files.push(...createWorksheets(data, construct));
        files.push(createStylesSheet(construct));
        files.push(createSharedStrings(construct.sharedStrings));
        files.push(...createRelsFiles(construct.relsFiles));
        files.push(createContentTypes(files));
        files.push(createRelRoot());
        return {
            name: `my_spreadsheet.xlsx`,
            files,
        };
    }
    function createWorkbook(data, construct) {
        const namespaces = [
            ["xmlns", NAMESPACE["workbook"]],
            ["xmlns:r", RELATIONSHIP_NSR],
        ];
        const sheetNodes = [];
        for (const [index, sheet] of Object.entries(data.sheets)) {
            const attributes = [
                ["state", sheet.isVisible ? "visible" : "hidden"],
                ["name", sheet.name],
                ["sheetId", parseInt(index) + 1],
                ["r:id", `rId${parseInt(index)+1}`],
            ];
            sheetNodes.push(escapeXml /*xml*/ `<sheet ${formatAttributes(attributes)}/>`);
            addRelsToFile(construct.relsFiles, "xl/_rels/workbook.xml.rels", {
                type: XLSX_RELATION_TYPE.sheet,
                target: `worksheets/sheet${index}.xml`,
            });
        }
        const xml = escapeXml /*xml*/ `<workbook ${formatAttributes(namespaces)}><sheets>${joinXmlNodes(sheetNodes)}</sheets></workbook>`;
        return createXMLFile(parseXML(xml), "xl/workbook.xml", "workbook");
    }
    function createWorksheets(data, construct) {
        const files = [];
        let currentTableIndex = 1;
        for (const [sheetIndex, sheet] of Object.entries(data.sheets)) {
            const namespaces = [
                ["xmlns", NAMESPACE["worksheet"]],
                ["xmlns:r", RELATIONSHIP_NSR],
            ];
            const sheetFormatAttributes = [
                ["defaultRowHeight", convertHeightToExcel(DEFAULT_CELL_HEIGHT)],
                ["defaultColWidth", convertWidthToExcel(DEFAULT_CELL_WIDTH)],
            ];
            const tablesNode = createTablesForSheet(sheet, sheetIndex, currentTableIndex, construct, files);
            currentTableIndex += sheet.filterTables.length;
            // Figures and Charts
            let drawingNode = escapeXml ``;
            const drawingRelIds = [];
            for (const chart of sheet.charts) {
                const xlsxChartId = convertChartId(chart.id);
                const chartRelId = addRelsToFile(construct.relsFiles, `xl/drawings/_rels/drawing${sheetIndex}.xml.rels`, {
                    target: `../charts/chart${xlsxChartId}.xml`,
                    type: XLSX_RELATION_TYPE.chart,
                });
                drawingRelIds.push(chartRelId);
                files.push(createXMLFile(createChart(chart, sheetIndex, data), `xl/charts/chart${xlsxChartId}.xml`, "chart"));
            }
            for (const image of sheet.images) {
                const mimeType = image.data.mimetype;
                if (mimeType === undefined)
                    continue;
                const extension = IMAGE_MIMETYPE_TO_EXTENSION_MAPPING[mimeType];
                // only support exporting images with mimetypes specified in the mapping
                if (extension === undefined)
                    continue;
                const xlsxImageId = convertImageId(image.id);
                let imageFileName = `image${xlsxImageId}.${extension}`;
                const imageRelId = addRelsToFile(construct.relsFiles, `xl/drawings/_rels/drawing${sheetIndex}.xml.rels`, {
                    target: `../media/${imageFileName}`,
                    type: XLSX_RELATION_TYPE.image,
                });
                drawingRelIds.push(imageRelId);
                files.push({
                    path: `xl/media/${imageFileName}`,
                    imageSrc: image.data.path,
                });
            }
            const drawings = [...sheet.charts, ...sheet.images];
            if (drawings.length) {
                const drawingRelId = addRelsToFile(construct.relsFiles, `xl/worksheets/_rels/sheet${sheetIndex}.xml.rels`, {
                    target: `../drawings/drawing${sheetIndex}.xml`,
                    type: XLSX_RELATION_TYPE.drawing,
                });
                files.push(createXMLFile(createDrawing(drawingRelIds, sheet, drawings), `xl/drawings/drawing${sheetIndex}.xml`, "drawing"));
                drawingNode = escapeXml /*xml*/ `<drawing r:id="${drawingRelId}"/>`;
            }
            const sheetXml = escapeXml /*xml*/ `<worksheet ${formatAttributes(namespaces)}>${addSheetViews(sheet)}<sheetFormatPr ${formatAttributes(sheetFormatAttributes)}/>${addColumns(sheet.cols)}
${addRows(construct,data,sheet)}
${addMerges(sheet.merges)}
${joinXmlNodes(addConditionalFormatting(construct.dxfs,sheet.conditionalFormats))}
${addHyperlinks(construct,data,sheetIndex)}
${drawingNode}
${tablesNode}</worksheet>`;
            files.push(createXMLFile(parseXML(sheetXml), `xl/worksheets/sheet${sheetIndex}.xml`, "sheet"));
        }
        addRelsToFile(construct.relsFiles, "xl/_rels/workbook.xml.rels", {
            type: XLSX_RELATION_TYPE.sharedStrings,
            target: "sharedStrings.xml",
        });
        addRelsToFile(construct.relsFiles, "xl/_rels/workbook.xml.rels", {
            type: XLSX_RELATION_TYPE.styles,
            target: "styles.xml",
        });
        return files;
    }
    /**
     * Create xlsx files for each tables contained in the given sheet, and add them to the XLSXStructure ans XLSXExportFiles.
     *
     * Return an XML string that should be added in the sheet to link these table to the sheet.
     */
    function createTablesForSheet(sheetData, sheetId, startingTableId, construct, files) {
        let currentTableId = startingTableId;
        if (!sheetData.filterTables.length)
            return new XMLString("");
        const sheetRelFile = `xl/worksheets/_rels/sheet${sheetId}.xml.rels`;
        const tableParts = [];
        for (const table of sheetData.filterTables) {
            const tableRelId = addRelsToFile(construct.relsFiles, sheetRelFile, {
                target: `../tables/table${currentTableId}.xml`,
                type: XLSX_RELATION_TYPE.table,
            });
            files.push(createXMLFile(createTable(table, currentTableId, sheetData), `xl/tables/table${currentTableId}.xml`, "table"));
            tableParts.push(escapeXml /*xml*/ `<tablePart r:id="${tableRelId}"/>`);
            currentTableId++;
        }
        return escapeXml /*xml*/ `<tableParts count="${sheetData.filterTables.length}">${joinXmlNodes(tableParts)}</tableParts>`;
    }
    function createStylesSheet(construct) {
        const namespaces = [
            ["xmlns", NAMESPACE["styleSheet"]],
            ["xmlns:r", RELATIONSHIP_NSR],
        ];
        const styleXml = escapeXml /*xml*/ `<styleSheet ${formatAttributes(namespaces)}>${addNumberFormats(construct.numFmts)}
${addFonts(construct.fonts)}
${addFills(construct.fills)}
${addBorders(construct.borders)}
${addStyles(construct.styles)}
${addCellWiseConditionalFormatting(construct.dxfs)}</styleSheet>`;
        return createXMLFile(parseXML(styleXml), "xl/styles.xml", "styles");
    }
    function createSharedStrings(strings) {
        const namespaces = [
            ["xmlns", NAMESPACE["sst"]],
            ["count", strings.length],
            ["uniqueCount", strings.length],
        ];
        const stringNodes = strings.map((string) => escapeXml /*xml*/ `<si><t>${string}</t></si>`);
        const xml = escapeXml /*xml*/ `<sst ${formatAttributes(namespaces)}>${joinXmlNodes(stringNodes)}</sst>`;
        return createXMLFile(parseXML(xml), "xl/sharedStrings.xml", "sharedStrings");
    }
    function createRelsFiles(relsFiles) {
        const XMLRelsFiles = [];
        for (const relFile of relsFiles) {
            const relationNodes = [];
            for (const rel of relFile.rels) {
                const attributes = [
                    ["Id", rel.id],
                    ["Target", rel.target],
                    ["Type", rel.type],
                ];
                if (rel.targetMode) {
                    attributes.push(["TargetMode", rel.targetMode]);
                }
                relationNodes.push(escapeXml /*xml*/ `<Relationship ${formatAttributes(attributes)}/>`);
            }
            const xml = escapeXml /*xml*/ `<Relationships xmlns="${NAMESPACE["Relationships"]}">${joinXmlNodes(relationNodes)}</Relationships>`;
            XMLRelsFiles.push(createXMLFile(parseXML(xml), relFile.path));
        }
        return XMLRelsFiles;
    }
    function createContentTypes(files) {
        const overrideNodes = [];
        // hard-code supported image mimetypes
        const imageDefaultNodes = Object.entries(IMAGE_MIMETYPE_TO_EXTENSION_MAPPING).map(([mimetype, extension]) => createDefaultXMLElement(extension, mimetype));
        for (const file of files) {
            if ("contentType" in file && file.contentType) {
                overrideNodes.push(createOverride("/" + file.path, CONTENT_TYPES[file.contentType]));
            }
        }
        const relsAttributes = [
            ["Extension", "rels"],
            ["ContentType", "application/vnd.openxmlformats-package.relationships+xml"],
        ];
        const xmlAttributes = [
            ["Extension", "xml"],
            ["ContentType", "application/xml"],
        ];
        const xml = escapeXml /*xml*/ `<Types xmlns="${NAMESPACE["Types"]}">${joinXmlNodes(Object.values(imageDefaultNodes))}<Default ${formatAttributes(relsAttributes)}/><Default ${formatAttributes(xmlAttributes)}/>${joinXmlNodes(overrideNodes)}</Types>`;
        return createXMLFile(parseXML(xml), "[Content_Types].xml");
    }
    function createRelRoot() {
        const attributes = [
            ["Id", "rId1"],
            ["Type", XLSX_RELATION_TYPE.document],
            ["Target", "xl/workbook.xml"],
        ];
        const xml = escapeXml /*xml*/ `<Relationships xmlns="${NAMESPACE["Relationships"]}"><Relationship ${formatAttributes(attributes)}/></Relationships>`;
        return createXMLFile(parseXML(xml), "_rels/.rels");
    }

    var Status;
    (function (Status) {
        Status[Status["Ready"] = 0] = "Ready";
        Status[Status["Running"] = 1] = "Running";
        Status[Status["RunningCore"] = 2] = "RunningCore";
        Status[Status["Finalizing"] = 3] = "Finalizing";
    })(Status || (Status = {}));
    class Model extends EventBus {
        corePlugins = [];
        featurePlugins = [];
        statefulUIPlugins = [];
        coreViewsPlugins = [];
        range;
        session;
        /**
         * In a collaborative context, some commands can be replayed, we have to ensure
         * that these commands are not replayed on the UI plugins.
         */
        isReplayingCommand = false;
        /**
         * A plugin can draw some contents on the canvas. But even better: it can do
         * so multiple times.  The order of the render calls will determine a list of
         * "layers" (i.e., earlier calls will be obviously drawn below later calls).
         * This list simply keeps the renderers+layer information so the drawing code
         * can just iterate on it
         */
        renderers = [];
        /**
         * Internal status of the model. Important for command handling coordination
         */
        status = 0 /* Status.Ready */;
        /**
         * The config object contains some configuration flag and callbacks
         */
        config;
        corePluginConfig;
        uiPluginConfig;
        state;
        selection;
        /**
         * Getters are the main way the rest of the UI read data from the model. Also,
         * it is shared between all plugins, so they can also communicate with each
         * other.
         */
        getters;
        /**
         * Getters that are accessible from the core plugins. It's a subset of `getters`,
         * without the UI getters
         */
        coreGetters;
        uuidGenerator;
        handlers = [];
        uiHandlers = [];
        coreHandlers = [];
        constructor(data = {}, config = {}, stateUpdateMessages = [], uuidGenerator = new UuidGenerator(), verboseImport = true) {
            super();
            stateUpdateMessages = repairInitialMessages(data, stateUpdateMessages);
            const workbookData = load(data, verboseImport);
            this.state = new StateObserver();
            this.uuidGenerator = uuidGenerator;
            this.config = this.setupConfig(config);
            this.session = this.setupSession(workbookData.revisionId);
            this.coreGetters = {};
            this.range = new RangeAdapter(this.coreGetters);
            this.coreGetters.getRangeString = this.range.getRangeString.bind(this.range);
            this.coreGetters.getRangeFromSheetXC = this.range.getRangeFromSheetXC.bind(this.range);
            this.coreGetters.createAdaptedRanges = this.range.createAdaptedRanges.bind(this.range);
            this.coreGetters.getRangeDataFromXc = this.range.getRangeDataFromXc.bind(this.range);
            this.coreGetters.getRangeDataFromZone = this.range.getRangeDataFromZone.bind(this.range);
            this.coreGetters.getRangeFromRangeData = this.range.getRangeFromRangeData.bind(this.range);
            this.coreGetters.getRangeFromZone = this.range.getRangeFromZone.bind(this.range);
            this.getters = {
                isReadonly: () => this.config.mode === "readonly" || this.config.mode === "dashboard",
                isDashboard: () => this.config.mode === "dashboard",
            };
            this.uuidGenerator.setIsFastStrategy(true);
            // Initiate stream processor
            this.selection = new SelectionStreamProcessorImpl(this.getters);
            this.coreHandlers.push(this.range);
            this.handlers.push(this.range);
            this.corePluginConfig = this.setupCorePluginConfig();
            this.uiPluginConfig = this.setupUiPluginConfig();
            // registering plugins
            for (let Plugin of corePluginRegistry.getAll()) {
                this.setupCorePlugin(Plugin, workbookData);
            }
            Object.assign(this.getters, this.coreGetters);
            this.session.loadInitialMessages(stateUpdateMessages);
            for (let Plugin of coreViewsPluginRegistry.getAll()) {
                const plugin = this.setupUiPlugin(Plugin);
                this.coreViewsPlugins.push(plugin);
                this.handlers.push(plugin);
                this.uiHandlers.push(plugin);
                this.coreHandlers.push(plugin);
            }
            for (let Plugin of statefulUIPluginRegistry.getAll()) {
                const plugin = this.setupUiPlugin(Plugin);
                this.statefulUIPlugins.push(plugin);
                this.handlers.push(plugin);
                this.uiHandlers.push(plugin);
            }
            for (let Plugin of featurePluginRegistry.getAll()) {
                const plugin = this.setupUiPlugin(Plugin);
                this.featurePlugins.push(plugin);
                this.handlers.push(plugin);
                this.uiHandlers.push(plugin);
            }
            this.uuidGenerator.setIsFastStrategy(false);
            // starting plugins
            this.dispatch("START");
            // Model should be the last permanent subscriber in the list since he should render
            // after all changes have been applied to the other subscribers (plugins)
            this.selection.observe(this, {
                handleEvent: () => this.trigger("update"),
            });
            // This should be done after construction of LocalHistory due to order of
            // events
            this.setupSessionEvents();
            this.joinSession();
            if (config.snapshotRequested) {
                this.session.snapshot(this.exportData());
                this.garbageCollectExternalResources();
            }
            // mark all models as "raw", so they will not be turned into reactive objects
            // by owl, since we do not rely on reactivity
            owl.markRaw(this);
        }
        joinSession() {
            this.session.join(this.config.client);
        }
        leaveSession() {
            this.session.leave(this.exportData());
        }
        setupUiPlugin(Plugin) {
            const plugin = new Plugin(this.uiPluginConfig);
            for (let name of Plugin.getters) {
                if (!(name in plugin)) {
                    throw new Error(`Invalid getter name:${name}for plugin ${plugin.constructor}`);
                }
                if (name in this.getters) {
                    throw new Error(`Getter"${name}"is already defined.`);
                }
                this.getters[name] = plugin[name].bind(plugin);
            }
            const layers = Plugin.layers.map((l) => [plugin, l]);
            this.renderers.push(...layers);
            this.renderers.sort((p1, p2) => p1[1] - p2[1]);
            return plugin;
        }
        /**
         * Initialize and properly configure a plugin.
         *
         * This method is private for now, but if the need arise, there is no deep
         * reason why the model could not add dynamically a plugin while it is running.
         */
        setupCorePlugin(Plugin, data) {
            const plugin = new Plugin(this.corePluginConfig);
            for (let name of Plugin.getters) {
                if (!(name in plugin)) {
                    throw new Error(`Invalid getter name:${name}for plugin ${plugin.constructor}`);
                }
                if (name in this.coreGetters) {
                    throw new Error(`Getter"${name}"is already defined.`);
                }
                this.coreGetters[name] = plugin[name].bind(plugin);
            }
            plugin.import(data);
            this.corePlugins.push(plugin);
            this.coreHandlers.push(plugin);
            this.handlers.push(plugin);
        }
        onRemoteRevisionReceived({ commands }) {
            for (let command of commands) {
                const previousStatus = this.status;
                this.status = 2 /* Status.RunningCore */;
                this.dispatchToHandlers(this.statefulUIPlugins, command);
                this.status = previousStatus;
            }
            this.finalize();
        }
        setupSession(revisionId) {
            const session = new Session(buildRevisionLog({
                initialRevisionId: revisionId,
                recordChanges: this.state.recordChanges.bind(this.state),
                dispatch: (command) => {
                    const result = this.checkDispatchAllowed(command);
                    if (!result.isSuccessful) {
                        return;
                    }
                    this.isReplayingCommand = true;
                    this.dispatchToHandlers(this.coreHandlers, command);
                    this.isReplayingCommand = false;
                },
            }), this.config.transportService, revisionId);
            return session;
        }
        setupSessionEvents() {
            this.session.on("remote-revision-received", this, this.onRemoteRevisionReceived);
            this.session.on("revision-undone", this, ({ commands }) => {
                this.dispatchFromCorePlugin("UNDO", { commands });
                this.finalize();
            });
            this.session.on("revision-redone", this, ({ commands }) => {
                this.dispatchFromCorePlugin("REDO", { commands });
                this.finalize();
            });
            // How could we improve communication between the session and UI?
            // It feels weird to have the model piping specific session events to its own bus.
            this.session.on("unexpected-revision-id", this, () => this.trigger("unexpected-revision-id"));
            this.session.on("collaborative-event-received", this, () => {
                this.trigger("update");
            });
        }
        setupConfig(config) {
            const client = config.client || {
                id: this.uuidGenerator.uuidv4(),
                name: _t("Anonymous").toString(),
            };
            const transportService = config.transportService || new LocalTransportService();
            return {
                ...config,
                mode: config.mode || "normal",
                custom: config.custom || {},
                external: this.setupExternalConfig(config.external || {}),
                transportService,
                client,
                moveClient: () => { },
                snapshotRequested: false,
                notifyUI: (payload) => this.trigger("notify-ui", payload),
                raiseBlockingErrorUI: (text) => this.trigger("raise-error-ui", { text }),
            };
        }
        setupExternalConfig(external) {
            const loadLocales = external.loadLocales || (() => Promise.resolve(DEFAULT_LOCALES));
            return {
                ...external,
                loadLocales,
            };
        }
        setupCorePluginConfig() {
            return {
                getters: this.coreGetters,
                stateObserver: this.state,
                range: this.range,
                dispatch: this.dispatchFromCorePlugin,
                uuidGenerator: this.uuidGenerator,
                custom: this.config.custom,
                external: this.config.external,
            };
        }
        setupUiPluginConfig() {
            return {
                getters: this.getters,
                stateObserver: this.state,
                dispatch: this.dispatch,
                selection: this.selection,
                moveClient: this.session.move.bind(this.session),
                custom: this.config.custom,
                uiActions: this.config,
                session: this.session,
                defaultCurrencyFormat: this.config.defaultCurrencyFormat,
            };
        }
        // ---------------------------------------------------------------------------
        // Command Handling
        // ---------------------------------------------------------------------------
        /**
         * Check if the given command is allowed by all the plugins and the history.
         */
        checkDispatchAllowed(command) {
            const results = isCoreCommand(command)
                ? this.checkDispatchAllowedCoreCommand(command)
                : this.checkDispatchAllowedLocalCommand(command);
            if (results.some((r) => r !== "Success" /* CommandResult.Success */)) {
                return new DispatchResult(results.flat());
            }
            return DispatchResult.Success;
        }
        checkDispatchAllowedCoreCommand(command) {
            const results = this.corePlugins.map((handler) => handler.allowDispatch(command));
            results.push(this.range.allowDispatch(command));
            return results;
        }
        checkDispatchAllowedLocalCommand(command) {
            const results = this.uiHandlers.map((handler) => handler.allowDispatch(command));
            return results;
        }
        finalize() {
            this.status = 3 /* Status.Finalizing */;
            for (const h of this.handlers) {
                h.finalize();
            }
            this.status = 0 /* Status.Ready */;
        }
        /**
         * Check if a command can be dispatched, and returns a DispatchResult object with the possible
         * reasons the dispatch failed.
         */
        canDispatch = (type, payload) => {
            return this.checkDispatchAllowed(createCommand(type, payload));
        };
        /**
         * The dispatch method is the only entry point to manipulate data in the model.
         * This is through this method that commands are dispatched most of the time
         * recursively until no plugin want to react anymore.
         *
         * CoreCommands dispatched from this function are saved in the history.
         *
         * Small technical detail: it is defined as an arrow function.  There are two
         * reasons for this:
         * 1. this means that the dispatch method can be "detached" from the model,
         *    which is done when it is put in the environment (see the Spreadsheet
         *    component)
         * 2. This allows us to define its type by using the interface CommandDispatcher
         */
        dispatch = (type, payload) => {
            const command = createCommand(type, payload);
            let status = this.status;
            if (this.getters.isReadonly() && !canExecuteInReadonly(command)) {
                return new DispatchResult("Readonly" /* CommandResult.Readonly */);
            }
            if (!this.session.canApplyOptimisticUpdate()) {
                return new DispatchResult("WaitingSessionConfirmation" /* CommandResult.WaitingSessionConfirmation */);
            }
            switch (status) {
                case 0 /* Status.Ready */:
                    const result = this.checkDispatchAllowed(command);
                    if (!result.isSuccessful) {
                        return result;
                    }
                    this.status = 1 /* Status.Running */;
                    const { changes, commands } = this.state.recordChanges(() => {
                        if (isCoreCommand(command)) {
                            this.state.addCommand(command);
                        }
                        this.dispatchToHandlers(this.handlers, command);
                        this.finalize();
                    });
                    this.session.save(command, commands, changes);
                    this.status = 0 /* Status.Ready */;
                    this.trigger("update");
                    break;
                case 1 /* Status.Running */:
                    if (isCoreCommand(command)) {
                        const dispatchResult = this.checkDispatchAllowed(command);
                        if (!dispatchResult.isSuccessful) {
                            return dispatchResult;
                        }
                        this.state.addCommand(command);
                    }
                    this.dispatchToHandlers(this.handlers, command);
                    break;
                case 3 /* Status.Finalizing */:
                    throw new Error("Cannot dispatch commands in the finalize state");
                case 2 /* Status.RunningCore */:
                    if (isCoreCommand(command)) {
                        throw new Error(`A UI plugin cannot dispatch ${type}while handling a core command`);
                    }
                    this.dispatchToHandlers(this.handlers, command);
            }
            return DispatchResult.Success;
        };
        /**
         * Dispatch a command from a Core Plugin (or the History).
         * A command dispatched from this function is not added to the history.
         */
        dispatchFromCorePlugin = (type, payload) => {
            const command = createCommand(type, payload);
            const previousStatus = this.status;
            this.status = 2 /* Status.RunningCore */;
            const handlers = this.isReplayingCommand ? this.coreHandlers : this.handlers;
            this.dispatchToHandlers(handlers, command);
            this.status = previousStatus;
            return DispatchResult.Success;
        };
        /**
         * Dispatch the given command to the given handlers.
         * It will call `beforeHandle` and `handle`*/dispatchToHandlers(handlers,command){const isCommandCore=isCoreCommand(command);for(const handler of handlers){if(!isCommandCore&&handler instanceof CorePlugin){continue;}
handler.beforeHandle(command);}
for(const handler of handlers){if(!isCommandCore&&handler instanceof CorePlugin){continue;}
handler.handle(command);}}
drawGrid(context){for(let[renderer,layer]of this.renderers){context.ctx.save();renderer.drawGrid(context,layer);context.ctx.restore();}}
exportData(){let data=createEmptyWorkbookData();for(let handler of this.handlers){if(handler instanceof CorePlugin){handler.export(data);}}
data.revisionId=this.session.getRevisionId()||DEFAULT_REVISION_ID;data=deepCopy(data);return data;}
updateMode(mode){if(mode!=="normal"){this.dispatch("CANCEL_EDITION");}
this.config.mode=mode;this.trigger("update");}
exportXLSX(){this.dispatch("EVALUATE_CELLS");let data=createEmptyExcelWorkbookData();for(let handler of this.handlers){if(handler instanceof BasePlugin){handler.exportForExcel(data);}}
data=deepCopy(data);return getXLSX(data);}
garbageCollectExternalResources(){for(const plugin of this.corePlugins){plugin.garbageCollectExternalResources();}}}
function createCommand(type,payload={}){const command=deepCopy(payload);command.type=type;return command;}
const __info__={};const SPREADSHEET_DIMENSIONS={MIN_ROW_HEIGHT,MIN_COL_WIDTH,HEADER_HEIGHT,HEADER_WIDTH,TOPBAR_HEIGHT,BOTTOMBAR_HEIGHT,DEFAULT_CELL_WIDTH,DEFAULT_CELL_HEIGHT,SCROLLBAR_WIDTH,};const registries={autofillModifiersRegistry,autofillRulesRegistry,cellMenuRegistry,colMenuRegistry,linkMenuRegistry,functionRegistry,featurePluginRegistry,statefulUIPluginRegistry,coreViewsPluginRegistry,corePluginRegistry,rowMenuRegistry,sidePanelRegistry,figureRegistry,chartSidePanelComponentRegistry,chartComponentRegistry,chartRegistry,topbarMenuRegistry,topbarComponentRegistry,clickableCellRegistry,otRegistry,inverseCommandRegistry,urlRegistry,cellPopoverRegistry,numberFormatMenuRegistry,repeatLocalCommandTransformRegistry,repeatCommandTransformRegistry,};const helpers={arg,toBoolean,toJsDate,toNumber,toString,toXC,toZone,toUnboundedZone,toCartesian,numberToLetters,lettersToNumber,UuidGenerator,formatValue,createCurrencyFormat,computeTextWidth,createEmptyWorkbookData,createEmptySheet,createEmptyExcelSheet,getDefaultChartJsRuntime,chartFontColor,ChartColors,EvaluationError,CellErrorLevel,getFillingMode,rgbaToHex,colorToRGBA,positionToZone,isDefined:isDefined$1,isMatrix,lazy,genericRepeat,createAction,createActions,transformRangeData,deepEquals,};const links={isMarkdownLink,parseMarkdownLink,markdownLink,openLink,urlRepresentation,};const components={ChartPanel,ChartFigure,ChartJsComponent,Grid,GridOverlay,ScorecardChart,LineConfigPanel,LineBarPieDesignPanel,BarConfigPanel,LineBarPieConfigPanel,GaugeChartConfigPanel,GaugeChartDesignPanel,ScorecardChartConfigPanel,ScorecardChartDesignPanel,FigureComponent,Menu,SelectionInput,};const hooks={useDragAndDropListItems,};function addFunction(functionName,functionDescription){functionRegistry.add(functionName,functionDescription);return{addFunction:(fName,fDescription)=>addFunction(fName,fDescription),};}
const constants={DEFAULT_LOCALE,};exports.AbstractChart=AbstractChart;exports.CorePlugin=CorePlugin;exports.DispatchResult=DispatchResult;exports.EvaluationError=EvaluationError;exports.Model=Model;exports.Registry=Registry;exports.Revision=Revision;exports.SPREADSHEET_DIMENSIONS=SPREADSHEET_DIMENSIONS;exports.Spreadsheet=Spreadsheet;exports.UIPlugin=UIPlugin;exports.__info__=__info__;exports.addFunction=addFunction;exports.astToFormula=astToFormula;exports.compile=compile;exports.compileTokens=compileTokens;exports.components=components;exports.constants=constants;exports.convertAstNodes=convertAstNodes;exports.coreTypes=coreTypes;exports.findCellInNewZone=findCellInNewZone;exports.functionCache=functionCache;exports.helpers=helpers;exports.hooks=hooks;exports.invalidateCFEvaluationCommands=invalidateCFEvaluationCommands;exports.invalidateDependenciesCommands=invalidateDependenciesCommands;exports.invalidateEvaluationCommands=invalidateEvaluationCommands;exports.iterateAstNodes=iterateAstNodes;exports.links=links;exports.load=load;exports.parse=parse;exports.parseTokens=parseTokens;exports.readonlyAllowedCommands=readonlyAllowedCommands;exports.registries=registries;exports.setDefaultSheetViewSize=setDefaultSheetViewSize;exports.setTranslationMethod=setTranslationMethod;exports.tokenize=tokenize;__info__.version="17.0.26";__info__.date="2024-06-14T10:09:01.338Z";__info__.hash="878073d92";})(this.o_spreadsheet=this.o_spreadsheet||{},owl);;

/* /spreadsheet_account/static/src/accounting_datasource.js */
odoo.define('@spreadsheet_account/accounting_datasource',['@spreadsheet/helpers/helpers','@web/core/l10n/translation','@web/core/utils/strings','@spreadsheet/data_sources/server_data'],function(require){'use strict';let __exports={};const{camelToSnakeObject,toServerDateString}=require("@spreadsheet/helpers/helpers");const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const{ServerData}=require("@spreadsheet/data_sources/server_data");const AccountingDataSource=__exports.AccountingDataSource=class AccountingDataSource{constructor(services){this.serverData=new ServerData(services.orm,{whenDataIsFetched:()=>services.notify(),});}
getCredit(codes,dateRange,offset,companyId,includeUnposted){const data=this._fetchAccountData(codes,dateRange,offset,companyId,includeUnposted);return data.credit;}
getDebit(codes,dateRange,offset,companyId,includeUnposted){const data=this._fetchAccountData(codes,dateRange,offset,companyId,includeUnposted);return data.debit;}
getFiscalStartDate(date,companyId){return this._fetchCompanyData(date,companyId).start;}
getFiscalEndDate(date,companyId){return this._fetchCompanyData(date,companyId).end;}
getAccountGroupCodes(accountType){return this.serverData.batch.get("account.account","get_account_group",accountType);}
_fetchAccountData(codes,dateRange,offset,companyId,includeUnposted){dateRange.year+=offset;if(dateRange.year<1900){throw new Error(sprintf(_t("%s is not a valid year."),dateRange.year));}
return this.serverData.batch.get("account.account","spreadsheet_fetch_debit_credit",camelToSnakeObject({dateRange,codes,companyId,includeUnposted}));}
_fetchCompanyData(date,companyId){const result=this.serverData.batch.get("res.company","get_fiscal_dates",{date:toServerDateString(date),company_id:companyId,});if(result===false){throw new Error(_t("The company fiscal year could not be found."));}
return result;}}
return __exports;});;

/* /spreadsheet_account/static/src/accounting_functions.js */
odoo.define('@spreadsheet_account/accounting_functions',['@web/core/l10n/translation','@web/core/utils/strings','@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const spreadsheet=require("@odoo/o-spreadsheet");const{functionRegistry}=spreadsheet.registries;const{arg,toBoolean,toString,toNumber,toJsDate,formatValue}=spreadsheet.helpers;const QuarterRegexp=/^q([1-4])\/(\d{4})$/i;const MonthRegexp=/^0?([1-9]|1[0-2])\/(\d{4})$/i;function parseAccountingQuarter(dateRange){const found=dateRange.match(QuarterRegexp);return found?{rangeType:"quarter",year:Number(found[2]),quarter:Number(found[1]),}:undefined;}
function parseAccountingMonth(dateRange){const found=dateRange.match(MonthRegexp);return found?{rangeType:"month",year:Number(found[2]),month:Number(found[1]),}:undefined;}
function parseAccountingYear(dateRange,locale){const dateNumber=toNumber(dateRange,locale);if(dateNumber<3000){return{rangeType:"year",year:dateNumber};}
return undefined;}
function parseAccountingDay(dateRange,locale){const dateNumber=toNumber(dateRange,locale);return{rangeType:"day",year:functionRegistry.get("YEAR").compute.bind({locale})(dateNumber),month:functionRegistry.get("MONTH").compute.bind({locale})(dateNumber),day:functionRegistry.get("DAY").compute.bind({locale})(dateNumber),};}
__exports.parseAccountingDate=parseAccountingDate;function parseAccountingDate(dateRange,locale){try{dateRange=toString(dateRange).trim();return(parseAccountingQuarter(dateRange)||parseAccountingMonth(dateRange)||parseAccountingYear(dateRange,locale)||parseAccountingDay(dateRange,locale));}catch{throw new Error(sprintf(_t(`'%s' is not a valid period. Supported formats are "21/12/2022", "Q1/2022", "12/2022", and "2022".`),dateRange));}}
const ODOO_FIN_ARGS=()=>[arg("account_codes (string)",_t("The prefix of the accounts.")),arg("date_range (string, date)",_t(`The date range. Supported formats are "21/12/2022", "Q1/2022", "12/2022", and "2022".`)),arg("offset (number, default=0)",_t("Year offset applied to date_range.")),arg("company_id (number, optional)",_t("The company to target (Advanced).")),arg("include_unposted (boolean, default=FALSE)",_t("Set to TRUE to include unposted entries.")),];functionRegistry.add("ODOO.CREDIT",{description:_t("Get the total credit for the specified account(s) and period."),args:ODOO_FIN_ARGS(),category:"Odoo",returns:["NUMBER"],computeValueAndFormat:function(accountCodes,dateRange,offset={value:0},companyId={value:null},includeUnposted={value:false}){accountCodes=toString(accountCodes?.value).split(",").map((code)=>code.trim()).sort();offset=toNumber(offset.value,this.locale);if(dateRange?.format){dateRange={...dateRange};dateRange.value=formatValue(dateRange.value,{format:dateRange.format,locale:this.locale,});}
dateRange=parseAccountingDate(dateRange?.value,this.locale);includeUnposted=toBoolean(includeUnposted.value);const value=this.getters.getAccountPrefixCredit(accountCodes,dateRange,offset,companyId.value,includeUnposted);const format=this.getters.getCompanyCurrencyFormat(companyId.value)||"#,##0.00";return{value,format};},});functionRegistry.add("ODOO.DEBIT",{description:_t("Get the total debit for the specified account(s) and period."),args:ODOO_FIN_ARGS(),category:"Odoo",returns:["NUMBER"],computeValueAndFormat:function(accountCodes,dateRange,offset={value:0},companyId={value:null},includeUnposted={value:false}){accountCodes=toString(accountCodes?.value).split(",").map((code)=>code.trim()).sort();offset=toNumber(offset.value,this.locale);if(dateRange?.format){dateRange={...dateRange};dateRange.value=formatValue(dateRange.value,{format:dateRange.format,locale:this.locale,});}
dateRange=parseAccountingDate(dateRange?.value,this.locale);includeUnposted=toBoolean(includeUnposted.value);const value=this.getters.getAccountPrefixDebit(accountCodes,dateRange,offset,companyId.value,includeUnposted);const format=this.getters.getCompanyCurrencyFormat(companyId.value)||"#,##0.00";return{value,format};},});functionRegistry.add("ODOO.BALANCE",{description:_t("Get the total balance for the specified account(s) and period."),args:ODOO_FIN_ARGS(),category:"Odoo",returns:["NUMBER"],computeValueAndFormat:function(accountCodes,dateRange,offset={value:0},companyId={value:null},includeUnposted={value:false}){accountCodes=toString(accountCodes?.value).split(",").map((code)=>code.trim()).sort();offset=toNumber(offset.value,this.locale);if(dateRange?.format){dateRange={...dateRange};dateRange.value=formatValue(dateRange.value,{format:dateRange.format,locale:this.locale,});}
dateRange=parseAccountingDate(dateRange?.value,this.locale);includeUnposted=toBoolean(includeUnposted.value);const value=this.getters.getAccountPrefixDebit(accountCodes,dateRange,offset,companyId.value,includeUnposted)-
this.getters.getAccountPrefixCredit(accountCodes,dateRange,offset,companyId.value,includeUnposted);const format=this.getters.getCompanyCurrencyFormat(companyId.value)||"#,##0.00";return{value,format};},});functionRegistry.add("ODOO.FISCALYEAR.START",{description:_t("Returns the starting date of the fiscal year encompassing the provided date."),args:[arg("day (date)",_t("The day from which to extract the fiscal year start.")),arg("company_id (number, optional)",_t("The company.")),],category:"Odoo",returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date,companyId=null){const startDate=this.getters.getFiscalStartDate(toJsDate(date,this.locale),companyId===null?null:toNumber(companyId,this.locale));return toNumber(startDate,this.locale);},});functionRegistry.add("ODOO.FISCALYEAR.END",{description:_t("Returns the ending date of the fiscal year encompassing the provided date."),args:[arg("day (date)",_t("The day from which to extract the fiscal year end.")),arg("company_id (number, optional)",_t("The company.")),],category:"Odoo",returns:["NUMBER"],computeFormat:function(){return this.locale.dateFormat;},compute:function(date,companyId=null){const endDate=this.getters.getFiscalEndDate(toJsDate(date,this.locale),companyId===null?null:toNumber(companyId,this.locale));return toNumber(endDate,this.locale);},});functionRegistry.add("ODOO.ACCOUNT.GROUP",{description:_t("Returns the account ids of a given group."),args:[arg("type (string)",_t("The account type (income, expense, asset_current,...)."))],category:"Odoo",returns:["NUMBER"],compute:function(accountType){const accountTypes=this.getters.getAccountGroupCodes(toString(accountType));return accountTypes.join(",");},});return __exports;});;

/* /spreadsheet_account/static/src/index.js */
odoo.define('@spreadsheet_account',['@web/core/l10n/translation','@odoo/o-spreadsheet','@spreadsheet_account/plugins/accounting_plugin','@spreadsheet_account/utils','@spreadsheet_account/accounting_functions','@spreadsheet/helpers/helpers'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const spreadsheet=require("@odoo/o-spreadsheet");const{AccountingPlugin}=require("@spreadsheet_account/plugins/accounting_plugin");const{getFirstAccountFunction,getNumberOfAccountFormulas}=require("@spreadsheet_account/utils");const{parseAccountingDate}=require("@spreadsheet_account/accounting_functions");const{camelToSnakeObject}=require("@spreadsheet/helpers/helpers");const{cellMenuRegistry,featurePluginRegistry}=spreadsheet.registries;const{astToFormula}=spreadsheet;const{toString,toBoolean,formatValue}=spreadsheet.helpers;featurePluginRegistry.add("odooAccountingAggregates",AccountingPlugin);cellMenuRegistry.add("move_lines_see_records",{name:_t("See records"),sequence:176,async execute(env){const position=env.model.getters.getActivePosition();const sheetId=position.sheetId;const cell=env.model.getters.getCell(position);const{args}=getFirstAccountFunction(cell.compiledFormula.tokens);let[codes,date_range,offset,companyId,includeUnposted]=args.map(astToFormula).map((arg)=>env.model.getters.evaluateFormula(sheetId,arg));codes=toString(codes).split(",");const locale=env.model.getters.getLocale();if(args[1]?.type==="REFERENCE"){const range=env.model.getters.getRangeFromSheetXC(sheetId,args[1].value);const cell=env.model.getters.getEvaluatedCell({sheetId:range.sheetId,col:range.zone.left,row:range.zone.top,});if(cell?.format){date_range=formatValue(date_range,{format:cell.format,locale});}}
const dateRange=parseAccountingDate(date_range,locale);offset=parseInt(offset)||0;dateRange.year+=offset||0;companyId=parseInt(companyId)||null;try{includeUnposted=toBoolean(includeUnposted);}catch{includeUnposted=false;}
const action=await env.services.orm.call("account.account","spreadsheet_move_line_action",[camelToSnakeObject({dateRange,companyId,codes,includeUnposted})]);await env.services.action.doAction(action);},isVisible:(env)=>{const position=env.model.getters.getActivePosition();const evaluatedCell=env.model.getters.getEvaluatedCell(position);const cell=env.model.getters.getCell(position);return(!evaluatedCell.error&&evaluatedCell.value!==""&&cell&&cell.isFormula&&getNumberOfAccountFormulas(cell.compiledFormula.tokens)===1);},});return __exports;});;

/* /spreadsheet_account/static/src/plugins/accounting_plugin.js */
odoo.define('@spreadsheet_account/plugins/accounting_plugin',['@odoo/o-spreadsheet','@spreadsheet_account/accounting_datasource'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{AccountingDataSource}=require("@spreadsheet_account/accounting_datasource");const DATA_SOURCE_ID="ACCOUNTING_AGGREGATES";const AccountingPlugin=__exports.AccountingPlugin=class AccountingPlugin extends spreadsheet.UIPlugin{constructor(config){super(config);this.dataSources=config.custom.dataSources;if(this.dataSources){this.dataSources.add(DATA_SOURCE_ID,AccountingDataSource);}}
getAccountPrefixCredit(codes,dateRange,offset,companyId,includeUnposted){return(this.dataSources&&this.dataSources.get(DATA_SOURCE_ID).getCredit(codes,dateRange,offset,companyId,includeUnposted));}
getAccountPrefixDebit(codes,dateRange,offset,companyId,includeUnposted){return(this.dataSources&&this.dataSources.get(DATA_SOURCE_ID).getDebit(codes,dateRange,offset,companyId,includeUnposted));}
getFiscalStartDate(date,companyId){return(this.dataSources&&this.dataSources.get(DATA_SOURCE_ID).getFiscalStartDate(date,companyId));}
getFiscalEndDate(date,companyId){return(this.dataSources&&this.dataSources.get(DATA_SOURCE_ID).getFiscalEndDate(date,companyId));}
getAccountGroupCodes(accountType){return(this.dataSources&&this.dataSources.get(DATA_SOURCE_ID).getAccountGroupCodes(accountType));}}
AccountingPlugin.getters=["getAccountPrefixCredit","getAccountPrefixDebit","getAccountGroupCodes","getFiscalStartDate","getFiscalEndDate",];return __exports;});;

/* /spreadsheet_account/static/src/utils.js */
odoo.define('@spreadsheet_account/utils',['@spreadsheet/helpers/odoo_functions_helpers'],function(require){'use strict';let __exports={};const{getOdooFunctions}=require("@spreadsheet/helpers/odoo_functions_helpers");__exports.getNumberOfAccountFormulas=getNumberOfAccountFormulas;function getNumberOfAccountFormulas(tokens){return getOdooFunctions(tokens,["ODOO.BALANCE","ODOO.CREDIT","ODOO.DEBIT"]).length;}
__exports.getFirstAccountFunction=getFirstAccountFunction;function getFirstAccountFunction(tokens){return getOdooFunctions(tokens,["ODOO.BALANCE","ODOO.CREDIT","ODOO.DEBIT"])[0];}
return __exports;});;

/* /spreadsheet/static/src/actions/spreadsheet_download_action.js */
odoo.define('@spreadsheet/actions/spreadsheet_download_action',['@web/core/network/download','@web/core/registry','@spreadsheet/helpers/model'],function(require){'use strict';let __exports={};const{download}=require("@web/core/network/download");const{registry}=require("@web/core/registry");const{createSpreadsheetModel,waitForDataLoaded}=require("@spreadsheet/helpers/model");async function downloadSpreadsheet(env,action){let{name,data,stateUpdateMessages,xlsxData}=action.params;if(!xlsxData){const model=await createSpreadsheetModel({env,data,revisions:stateUpdateMessages});await waitForDataLoaded(model);xlsxData=model.exportXLSX();}
await download({url:"/spreadsheet/xlsx",data:{zip_name:`${name}.xlsx`,files:JSON.stringify(xlsxData.files),},});}
registry.category("actions").add("action_download_spreadsheet",downloadSpreadsheet,{force:true});return __exports;});;

/* /spreadsheet/static/src/chart/data_source/chart_data_source.js */
odoo.define('@spreadsheet/chart/data_source/chart_data_source',['@spreadsheet/data_sources/odoo_views_data_source','@web/core/l10n/translation','@web/views/graph/graph_model'],function(require){'use strict';let __exports={};const{OdooViewsDataSource}=require("@spreadsheet/data_sources/odoo_views_data_source");const{_t}=require("@web/core/l10n/translation");const{GraphModel:ChartModel}=require("@web/views/graph/graph_model");const ChartDataSource=__exports.ChartDataSource=class ChartDataSource extends OdooViewsDataSource{constructor(services,params){super(services,params);}
async _load(){await super._load();const metaData={fieldAttrs:{},...this._metaData,};this._model=new ChartModel({_t,},metaData,{orm:this._orm,});await this._model.load(this._searchParams);}
getData(){if(!this.isReady()){this.load();return{datasets:[],labels:[]};}
if(!this._isValid){return{datasets:[],labels:[]};}
return this._model.data;}}
return __exports;});;

/* /spreadsheet/static/src/chart/index.js */
odoo.define('@spreadsheet/chart',['@odoo/o-spreadsheet','@spreadsheet/chart/plugins/odoo_chart_core_plugin','@spreadsheet/chart/plugins/chart_odoo_menu_plugin','@spreadsheet/chart/plugins/odoo_chart_ui_plugin'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{chartComponentRegistry}=spreadsheet.registries;const{ChartJsComponent}=spreadsheet.components;chartComponentRegistry.add("odoo_bar",ChartJsComponent);chartComponentRegistry.add("odoo_line",ChartJsComponent);chartComponentRegistry.add("odoo_pie",ChartJsComponent);const{OdooChartCorePlugin}=require("@spreadsheet/chart/plugins/odoo_chart_core_plugin");const{ChartOdooMenuPlugin}=require("@spreadsheet/chart/plugins/chart_odoo_menu_plugin");const{OdooChartUIPlugin}=require("@spreadsheet/chart/plugins/odoo_chart_ui_plugin");Object.assign(__exports,{OdooChartCorePlugin,ChartOdooMenuPlugin,OdooChartUIPlugin});return __exports;});;

/* /spreadsheet/static/src/chart/odoo_chart/odoo_bar_chart.js */
odoo.define('@spreadsheet/chart/odoo_chart/odoo_bar_chart',['@odoo/o-spreadsheet','@web/core/l10n/translation','@spreadsheet/chart/odoo_chart/odoo_chart'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{_t}=require("@web/core/l10n/translation");const{OdooChart}=require("@spreadsheet/chart/odoo_chart/odoo_chart");const{chartRegistry}=spreadsheet.registries;const{getDefaultChartJsRuntime,chartFontColor,ChartColors}=spreadsheet.helpers;const OdooBarChart=__exports.OdooBarChart=class OdooBarChart extends OdooChart{constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.verticalAxisPosition=definition.verticalAxisPosition;this.stacked=definition.stacked;}
getDefinition(){return{...super.getDefinition(),verticalAxisPosition:this.verticalAxisPosition,stacked:this.stacked,};}}
chartRegistry.add("odoo_bar",{match:(type)=>type==="odoo_bar",createChart:(definition,sheetId,getters)=>new OdooBarChart(definition,sheetId,getters),getChartRuntime:createOdooChartRuntime,validateChartDefinition:(validator,definition)=>OdooBarChart.validateChartDefinition(validator,definition),transformDefinition:(definition)=>OdooBarChart.transformDefinition(definition),getChartDefinitionFromContextCreation:()=>OdooBarChart.getDefinitionFromContextCreation(),name:_t("Bar"),});function createOdooChartRuntime(chart,getters){const background=chart.background||"#FFFFFF";const{datasets,labels}=chart.dataSource.getData();const locale=getters.getLocale();const chartJsConfig=getBarConfiguration(chart,labels,locale);const colors=new ChartColors();for(const{label,data}of datasets){const color=colors.next();const dataset={label,data,borderColor:color,backgroundColor:color,};chartJsConfig.data.datasets.push(dataset);}
return{background,chartJsConfig};}
function getBarConfiguration(chart,labels,locale){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,{locale});config.type=chart.type.replace("odoo_","");const legend={...config.options.legend,display:chart.legendPosition!=="none",labels:{fontColor},};legend.position=chart.legendPosition;config.options.plugins=config.options.plugins||{};config.options.plugins.legend=legend;config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.scales={x:{ticks:{maxRotation:60,minRotation:15,padding:5,labelOffset:2,color:fontColor,},},y:{position:chart.verticalAxisPosition,ticks:{color:fontColor,},beginAtZero:true,},};if(chart.stacked){config.options.scales.x.stacked=true;config.options.scales.y.stacked=true;}
return config;}
return __exports;});;

/* /spreadsheet/static/src/chart/odoo_chart/odoo_chart.js */
odoo.define('@spreadsheet/chart/odoo_chart/odoo_chart',['@odoo/o-spreadsheet','@spreadsheet/chart/data_source/chart_data_source'],function(require){'use strict';let __exports={};const{AbstractChart,CommandResult}=require("@odoo/o-spreadsheet");const{ChartDataSource}=require("@spreadsheet/chart/data_source/chart_data_source");const OdooChart=__exports.OdooChart=class OdooChart extends AbstractChart{constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.type=definition.type;this.metaData={...definition.metaData,mode:this.type.replace("odoo_",""),cumulated:definition.cumulative,cumulatedStart:definition.cumulative,};this.searchParams=definition.searchParams;this.legendPosition=definition.legendPosition;this.background=definition.background;this.dataSource=undefined;}
static transformDefinition(definition){return definition;}
static validateChartDefinition(validator,definition){return CommandResult.Success;}
static getDefinitionFromContextCreation(){throw new Error("It's not possible to convert an Odoo chart to a native chart");}
getDefinitionForDataSource(){return{metaData:this.metaData,searchParams:this.searchParams,};}
getDefinition(){return{title:this.title,background:this.background,legendPosition:this.legendPosition,metaData:this.metaData,searchParams:this.searchParams,type:this.type,};}
getDefinitionForExcel(){return undefined;}
updateRanges(){return this;}
copyForSheetId(){return this;}
copyInSheetId(){return this;}
getContextCreation(){return{};}
getSheetIdsUsedInChartRanges(){return[];}
setDataSource(dataSource){if(dataSource instanceof ChartDataSource){this.dataSource=dataSource;}else{throw new Error("Only ChartDataSources can be added.");}}}
return __exports;});;

/* /spreadsheet/static/src/chart/odoo_chart/odoo_line_chart.js */
odoo.define('@spreadsheet/chart/odoo_chart/odoo_line_chart',['@odoo/o-spreadsheet','@web/core/l10n/translation','@spreadsheet/chart/odoo_chart/odoo_chart','@web/views/graph/graph_renderer'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{_t}=require("@web/core/l10n/translation");const{OdooChart}=require("@spreadsheet/chart/odoo_chart/odoo_chart");const{LINE_FILL_TRANSPARENCY}=require("@web/views/graph/graph_renderer");const{chartRegistry}=spreadsheet.registries;const{getDefaultChartJsRuntime,chartFontColor,ChartColors,getFillingMode,colorToRGBA,rgbaToHex,}=spreadsheet.helpers;const OdooLineChart=__exports.OdooLineChart=class OdooLineChart extends OdooChart{constructor(definition,sheetId,getters){super(definition,sheetId,getters);this.verticalAxisPosition=definition.verticalAxisPosition;this.stacked=definition.stacked;this.cumulative=definition.cumulative;}
getDefinition(){return{...super.getDefinition(),verticalAxisPosition:this.verticalAxisPosition,stacked:this.stacked,cumulative:this.cumulative,};}}
chartRegistry.add("odoo_line",{match:(type)=>type==="odoo_line",createChart:(definition,sheetId,getters)=>new OdooLineChart(definition,sheetId,getters),getChartRuntime:createOdooChartRuntime,validateChartDefinition:(validator,definition)=>OdooLineChart.validateChartDefinition(validator,definition),transformDefinition:(definition)=>OdooLineChart.transformDefinition(definition),getChartDefinitionFromContextCreation:()=>OdooLineChart.getDefinitionFromContextCreation(),name:_t("Line"),});function createOdooChartRuntime(chart,getters){const background=chart.background||"#FFFFFF";const{datasets,labels}=chart.dataSource.getData();const locale=getters.getLocale();const chartJsConfig=getLineConfiguration(chart,labels,locale);const colors=new ChartColors();for(let[index,{label,data,cumulatedStart}]of datasets.entries()){const color=colors.next();const backgroundRGBA=colorToRGBA(color);if(chart.stacked){backgroundRGBA.a=LINE_FILL_TRANSPARENCY;}
if(chart.cumulative){let accumulator=cumulatedStart;data=data.map((value)=>{accumulator+=value;return accumulator;});}
const backgroundColor=rgbaToHex(backgroundRGBA);const dataset={label,data,lineTension:0,borderColor:color,backgroundColor,pointBackgroundColor:color,fill:chart.stacked?getFillingMode(index):false,};chartJsConfig.data.datasets.push(dataset);}
return{background,chartJsConfig};}
function getLineConfiguration(chart,labels,locale){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,{locale});config.type=chart.type.replace("odoo_","");const legend={...config.options.legend,display:chart.legendPosition!=="none",labels:{color:fontColor,generateLabels(chart){const{data}=chart;const labels=window.Chart.defaults.plugins.legend.labels.generateLabels(chart);for(const[index,label]of labels.entries()){label.fillStyle=data.datasets[index].borderColor;}
return labels;},},};legend.position=chart.legendPosition;config.options.plugins=config.options.plugins||{};config.options.plugins.legend=legend;config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.scales={x:{ticks:{maxRotation:60,minRotation:15,padding:5,labelOffset:2,color:fontColor,},},y:{position:chart.verticalAxisPosition,ticks:{color:fontColor,},beginAtZero:true,},};if(chart.stacked){config.options.scales.y.stacked=true;}
return config;}
return __exports;});;

/* /spreadsheet/static/src/chart/odoo_chart/odoo_pie_chart.js */
odoo.define('@spreadsheet/chart/odoo_chart/odoo_pie_chart',['@odoo/o-spreadsheet','@web/core/l10n/translation','@spreadsheet/chart/odoo_chart/odoo_chart'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{_t}=require("@web/core/l10n/translation");const{OdooChart}=require("@spreadsheet/chart/odoo_chart/odoo_chart");const{chartRegistry}=spreadsheet.registries;const{getDefaultChartJsRuntime,chartFontColor,ChartColors}=spreadsheet.helpers;chartRegistry.add("odoo_pie",{match:(type)=>type==="odoo_pie",createChart:(definition,sheetId,getters)=>new OdooChart(definition,sheetId,getters),getChartRuntime:createOdooChartRuntime,validateChartDefinition:(validator,definition)=>OdooChart.validateChartDefinition(validator,definition),transformDefinition:(definition)=>OdooChart.transformDefinition(definition),getChartDefinitionFromContextCreation:()=>OdooChart.getDefinitionFromContextCreation(),name:_t("Pie"),});function createOdooChartRuntime(chart,getters){const background=chart.background||"#FFFFFF";const{datasets,labels}=chart.dataSource.getData();const locale=getters.getLocale();const chartJsConfig=getPieConfiguration(chart,labels,locale);const colors=new ChartColors();for(const{label,data}of datasets){const backgroundColor=getPieColors(colors,datasets);const dataset={label,data,borderColor:"#FFFFFF",backgroundColor,};chartJsConfig.data.datasets.push(dataset);}
return{background,chartJsConfig};}
function getPieConfiguration(chart,labels,locale){const fontColor=chartFontColor(chart.background);const config=getDefaultChartJsRuntime(chart,labels,fontColor,{locale});config.type=chart.type.replace("odoo_","");const legend={...config.options.legend,display:chart.legendPosition!=="none",labels:{fontColor},};legend.position=chart.legendPosition;config.options.plugins=config.options.plugins||{};config.options.plugins.legend=legend;config.options.layout={padding:{left:20,right:20,top:chart.title?10:25,bottom:10},};config.options.plugins.tooltip={callbacks:{title:function(tooltipItem){return tooltipItem.label;},},};return config;}
function getPieColors(colors,dataSetsValues){const pieColors=[];const maxLength=Math.max(...dataSetsValues.map((ds)=>ds.data.length));for(let i=0;i<=maxLength;i++){pieColors.push(colors.next());}
return pieColors;}
return __exports;});;

/* /spreadsheet/static/src/chart/odoo_menu/figure_component.js */
odoo.define('@spreadsheet/chart/odoo_menu/figure_component',['@web/core/utils/patch','@odoo/o-spreadsheet','@web/core/utils/hooks','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{patch}=require("@web/core/utils/patch");const spreadsheet=require("@odoo/o-spreadsheet");const{useService}=require("@web/core/utils/hooks");const{_t}=require("@web/core/l10n/translation");patch(spreadsheet.components.FigureComponent.prototype,{setup(){super.setup();this.menuService=useService("menu");this.actionService=useService("action");this.notificationService=useService("notification");},async navigateToOdooMenu(){const menu=this.env.model.getters.getChartOdooMenu(this.props.figure.id);if(!menu){throw new Error(`Cannot find any menu associated with the chart`);}
if(!menu.actionID){this.notificationService.add(_t("The menu linked to this chart doesn't have an corresponding action. Please link the chart to another menu."),{type:"danger"});return;}
await this.actionService.doAction(menu.actionID);},get hasOdooMenu(){return this.env.model.getters.getChartOdooMenu(this.props.figure.id)!==undefined;},async onClick(){if(this.env.isDashboard()&&this.hasOdooMenu){this.navigateToOdooMenu();}},});return __exports;});;

/* /spreadsheet/static/src/chart/plugins/chart_odoo_menu_plugin.js */
odoo.define('@spreadsheet/chart/plugins/chart_odoo_menu_plugin',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{coreTypes,CorePlugin}=require("@odoo/o-spreadsheet");const ChartOdooMenuPlugin=__exports.ChartOdooMenuPlugin=class ChartOdooMenuPlugin extends CorePlugin{constructor(config){super(config);this.odooMenuReference={};}
handle(cmd){switch(cmd.type){case"LINK_ODOO_MENU_TO_CHART":this.history.update("odooMenuReference",cmd.chartId,cmd.odooMenuId);break;case"DELETE_FIGURE":this.history.update("odooMenuReference",cmd.id,undefined);break;}}
getChartOdooMenu(chartId){const menuId=this.odooMenuReference[chartId];return menuId?this.getters.getIrMenu(menuId):undefined;}
import(data){if(data.chartOdooMenusReferences){this.odooMenuReference=data.chartOdooMenusReferences;}}
export(data){data.chartOdooMenusReferences=this.odooMenuReference;}}
ChartOdooMenuPlugin.getters=["getChartOdooMenu"];coreTypes.add("LINK_ODOO_MENU_TO_CHART");return __exports;});;

/* /spreadsheet/static/src/chart/plugins/odoo_chart_core_plugin.js */
odoo.define('@spreadsheet/chart/plugins/odoo_chart_core_plugin',['@odoo/o-spreadsheet','@spreadsheet/global_filters/plugins/global_filters_core_plugin','@spreadsheet/global_filters/helpers','@spreadsheet/o_spreadsheet/cancelled_reason','@web/core/domain'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{globalFiltersFieldMatchers}=require("@spreadsheet/global_filters/plugins/global_filters_core_plugin");const{checkFilterFieldMatching}=require("@spreadsheet/global_filters/helpers");const{CommandResult}=require("@spreadsheet/o_spreadsheet/cancelled_reason");const{Domain}=require("@web/core/domain");const{CorePlugin}=spreadsheet;const OdooChartCorePlugin=__exports.OdooChartCorePlugin=class OdooChartCorePlugin extends CorePlugin{constructor(config){super(config);this.charts={};globalFiltersFieldMatchers["chart"]={getIds:()=>this.getters.getOdooChartIds(),getDisplayName:(chartId)=>this.getters.getOdooChartDisplayName(chartId),getFieldMatching:(chartId,filterId)=>this.getOdooChartFieldMatching(chartId,filterId),getModel:(chartId)=>this.getters.getChart(chartId).getDefinitionForDataSource().metaData.resModel,};}
allowDispatch(cmd){switch(cmd.type){case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":if(cmd.chart){return checkFilterFieldMatching(cmd.chart);}}
return CommandResult.Success;}
handle(cmd){switch(cmd.type){case"CREATE_CHART":{switch(cmd.definition.type){case"odoo_pie":case"odoo_bar":case"odoo_line":this._addOdooChart(cmd.id);break;}
break;}
case"DELETE_FIGURE":{const charts={...this.charts};delete charts[cmd.id];this.history.update("charts",charts);break;}
case"REMOVE_GLOBAL_FILTER":this._onFilterDeletion(cmd.id);break;case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":if(cmd.chart){this._setOdooChartFieldMatching(cmd.filter.id,cmd.chart);}
break;}}
getOdooChartIds(){return Object.keys(this.charts);}
getChartFieldMatch(chartId){return this.charts[chartId].fieldMatching;}
getOdooChartDisplayName(chartId){return`(#${this.getOdooChartIds().indexOf(chartId) + 1}) ${
            this.getters.getChart(chartId).title
        }`;}
import(data){for(const sheet of data.sheets){if(sheet.figures){for(const figure of sheet.figures){if(figure.tag==="chart"&&figure.data.type.startsWith("odoo_")){this._addOdooChart(figure.id,figure.data.fieldMatching);}}}}}
export(data){for(const sheet of data.sheets){if(sheet.figures){for(const figure of sheet.figures){if(figure.tag==="chart"&&figure.data.type.startsWith("odoo_")){figure.data.fieldMatching=this.getChartFieldMatch(figure.id);figure.data.searchParams.domain=new Domain(figure.data.searchParams.domain).toJson();}}}}}
getOdooChartFieldMatching(chartId,filterId){return this.charts[chartId].fieldMatching[filterId];}
_setOdooChartFieldMatching(filterId,chartFieldMatches){const charts={...this.charts};for(const[chartId,fieldMatch]of Object.entries(chartFieldMatches)){charts[chartId].fieldMatching[filterId]=fieldMatch;}
this.history.update("charts",charts);}
_onFilterDeletion(filterId){const charts={...this.charts};for(const chartId in charts){this.history.update("charts",chartId,"fieldMatching",filterId,undefined);}}
_addOdooChart(chartId,fieldMatching=undefined){const charts={...this.charts};if(!fieldMatching){const model=this.getters.getChartDefinition(chartId).metaData.resModel;fieldMatching=this.getters.getFieldMatchingForModel(model);}
charts[chartId]={fieldMatching,};this.history.update("charts",charts);}}
OdooChartCorePlugin.getters=["getOdooChartIds","getChartFieldMatch","getOdooChartDisplayName","getOdooChartFieldMatching",];return __exports;});;

/* /spreadsheet/static/src/chart/plugins/odoo_chart_ui_plugin.js */
odoo.define('@spreadsheet/chart/plugins/odoo_chart_ui_plugin',['@odoo/o-spreadsheet','@web/core/domain','@spreadsheet/global_filters/plugins/global_filters_core_plugin','@spreadsheet/chart/data_source/chart_data_source','@web/core/utils/strings','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{Domain}=require("@web/core/domain");const{globalFiltersFieldMatchers}=require("@spreadsheet/global_filters/plugins/global_filters_core_plugin");const{ChartDataSource}=require("@spreadsheet/chart/data_source/chart_data_source");const{sprintf}=require("@web/core/utils/strings");const{_t}=require("@web/core/l10n/translation");const{UIPlugin}=spreadsheet;const OdooChartUIPlugin=__exports.OdooChartUIPlugin=class OdooChartUIPlugin extends UIPlugin{constructor(config){super(config);this.dataSources=config.custom.dataSources;globalFiltersFieldMatchers["chart"]={...globalFiltersFieldMatchers["chart"],getTag:async(chartId)=>{const model=await this.getChartDataSource(chartId).getModelLabel();return sprintf(_t("Chart - %s"),model);},waitForReady:()=>this._getOdooChartsWaitForReady(),getFields:(chartId)=>this.getChartDataSource(chartId).getFields(),};}
beforeHandle(cmd){switch(cmd.type){case"START":for(const chartId of this.getters.getOdooChartIds()){this._setupChartDataSource(chartId);}
this._addDomains();break;}}
handle(cmd){switch(cmd.type){case"CREATE_CHART":{switch(cmd.definition.type){case"odoo_pie":case"odoo_bar":case"odoo_line":this._setupChartDataSource(cmd.id);break;}
break;}
case"UPDATE_CHART":{switch(cmd.definition.type){case"odoo_pie":case"odoo_bar":case"odoo_line":{const dataSource=this.getChartDataSource(cmd.id);if(dataSource.getInitialDomainString()!==new Domain(cmd.definition.searchParams.domain).toString()){this._resetChartDataSource(cmd.id);}
this._setChartDataSource(cmd.id);break;}}
break;}
case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":case"REMOVE_GLOBAL_FILTER":case"SET_GLOBAL_FILTER_VALUE":case"CLEAR_GLOBAL_FILTER_VALUE":this._addDomains();break;case"UNDO":case"REDO":{if(cmd.commands.find((command)=>["ADD_GLOBAL_FILTER","EDIT_GLOBAL_FILTER","REMOVE_GLOBAL_FILTER",].includes(command.type))){this._addDomains();}
const domainEditionCommands=cmd.commands.filter((cmd)=>cmd.type==="UPDATE_CHART"||cmd.type==="CREATE_CHART");for(const cmd of domainEditionCommands){if(!this.getters.getOdooChartIds().includes(cmd.id)){continue;}
const dataSource=this.getChartDataSource(cmd.id);if(dataSource.getInitialDomainString()!==new Domain(cmd.definition.searchParams.domain).toString()){this._resetChartDataSource(cmd.id);}}
break;}
case"REFRESH_ODOO_CHART":this._refreshOdooChart(cmd.chartId);break;case"REFRESH_ALL_DATA_SOURCES":this._refreshOdooCharts();break;}}
getChartDataSource(chartId){const dataSourceId=this._getOdooChartDataSourceId(chartId);return this.dataSources.get(dataSourceId);}
_addDomain(chartId){const domainList=[];for(const[filterId,fieldMatch]of Object.entries(this.getters.getChartFieldMatch(chartId))){domainList.push(this.getters.getGlobalFilterDomain(filterId,fieldMatch));}
const domain=Domain.combine(domainList,"AND").toString();this.getChartDataSource(chartId).addDomain(domain);}
_addDomains(){for(const chartId of this.getters.getOdooChartIds()){this._addDomain(chartId);}}
_setupChartDataSource(chartId){const dataSourceId=this._getOdooChartDataSourceId(chartId);if(!this.dataSources.contains(dataSourceId)){this._resetChartDataSource(chartId);}
this._setChartDataSource(chartId);}
_resetChartDataSource(chartId){const definition=this.getters.getChart(chartId).getDefinitionForDataSource();const dataSourceId=this._getOdooChartDataSourceId(chartId);this.dataSources.add(dataSourceId,ChartDataSource,definition);}
_setChartDataSource(chartId){const chart=this.getters.getChart(chartId);chart.setDataSource(this.getChartDataSource(chartId));}
_getOdooChartsWaitForReady(){return this.getters.getOdooChartIds().map((chartId)=>this.getChartDataSource(chartId).loadMetadata());}
_getOdooChartDataSourceId(chartId){return`chart-${chartId}`;}
_refreshOdooChart(chartId){this.getChartDataSource(chartId).load({reload:true});}
_refreshOdooCharts(){for(const chartId of this.getters.getOdooChartIds()){this._refreshOdooChart(chartId);}}}
OdooChartUIPlugin.getters=["getChartDataSource"];return __exports;});;

/* /spreadsheet/static/src/chart/plugins/operational_transform.js */
odoo.define('@spreadsheet/chart/plugins/operational_transform',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{inverseCommandRegistry,otRegistry}=spreadsheet.registries;function identity(cmd){return[cmd];}
otRegistry.addTransformation("DELETE_FIGURE",["LINK_ODOO_MENU_TO_CHART"],(toTransform,executed)=>{if(executed.id===toTransform.chartId){return undefined;}
return toTransform;});inverseCommandRegistry.add("LINK_ODOO_MENU_TO_CHART",identity);return __exports;});;

/* /spreadsheet/static/src/components/share_button/share_button.js */
odoo.define('@spreadsheet/components/share_button/share_button',['@odoo/owl','@web/core/browser/browser','@web/core/l10n/translation','@web/core/dropdown/dropdown','@web/core/dropdown/dropdown_item','@web/views/fields/copy_clipboard/copy_button','@spreadsheet/helpers/model','@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{Component,useState}=require("@odoo/owl");const{browser}=require("@web/core/browser/browser");const{_t}=require("@web/core/l10n/translation");const{Dropdown}=require("@web/core/dropdown/dropdown");const{DropdownItem}=require("@web/core/dropdown/dropdown_item");const{CopyButton}=require("@web/views/fields/copy_clipboard/copy_button");const{waitForDataLoaded,freezeOdooData}=require("@spreadsheet/helpers/model");const{Model}=require("@odoo/o-spreadsheet");const SpreadsheetShareButton=__exports.SpreadsheetShareButton=class SpreadsheetShareButton extends Component{static template="spreadsheet.ShareButton";static components={Dropdown,DropdownItem,CopyButton};static props={model:{type:Model,optional:true},onSpreadsheetShared:Function,togglerClass:{type:String,optional:true},};setup(){this.copiedText=_t("Copied");this.state=useState({url:undefined});}
get togglerClass(){return["btn btn-light",this.props.togglerClass].join(" ");}
async onOpened(){const model=this.props.model;await waitForDataLoaded(model);const data=await freezeOdooData(model);if(!this.isChanged(data)){return;}
const url=await this.props.onSpreadsheetShared(data,model.exportXLSX());this.state.url=url;setTimeout(async()=>{await browser.navigator.clipboard.writeText(url);})}
isChanged(data){const contentsChanged=data.revisionId!==this.lastRevisionId;let globalFilterChanged=this.lastGlobalFilters===undefined;const newCells=data.sheets[data.sheets.length-1].cells;if(this.lastGlobalFilters!==undefined){for(const key of Object.keys(newCells)){if(this.lastGlobalFilters[key]?.content!==newCells[key].content){globalFilterChanged=true;break;}}}
const localeChanged=data.settings.locale.code!==this.lastLocale;if(!(localeChanged||globalFilterChanged||contentsChanged)){return false;}
this.lastRevisionId=data.revisionId;this.lastGlobalFilters=newCells;this.lastLocale=data.settings.locale.code;return true;}}
return __exports;});;

/* /spreadsheet/static/src/currency/currency_data_source.js */
odoo.define('@spreadsheet/currency/currency_data_source',['@web/core/l10n/translation','@spreadsheet/data_sources/server_data','@spreadsheet/helpers/helpers'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{ServerData}=require("@spreadsheet/data_sources/server_data");const{toServerDateString}=require("@spreadsheet/helpers/helpers");const CurrencyDataSource=__exports.CurrencyDataSource=class CurrencyDataSource{constructor(services){this.serverData=new ServerData(services.orm,{whenDataIsFetched:()=>services.notify(),});}
getCurrencyRate(from,to,date){const data=this.serverData.batch.get("res.currency.rate","get_rates_for_spreadsheet",{from,to,date:date?toServerDateString(date):undefined,});const rate=data!==undefined?data.rate:undefined;if(rate===false){throw new Error(_t("Currency rate unavailable."));}
return rate;}
getCompanyCurrencyFormat(companyId){const result=this.serverData.get("res.currency","get_company_currency_for_spreadsheet",[companyId,]);if(result===false){throw new Error(_t("Currency not available for this company."));}
return result;}}
return __exports;});;

/* /spreadsheet/static/src/currency/formulas.js */
odoo.define('@spreadsheet/currency/formulas',['@web/core/l10n/translation','@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const spreadsheet=require("@odoo/o-spreadsheet");const{arg,toString,toJsDate}=spreadsheet.helpers;const{functionRegistry}=spreadsheet.registries;functionRegistry.add("ODOO.CURRENCY.RATE",{description:_t("This function takes in two currency codes as arguments, and returns the exchange rate from the first currency to the second as float."),category:"Odoo",compute:function(currencyFrom,currencyTo,date){const from=toString(currencyFrom);const to=toString(currencyTo);const _date=date?toJsDate(date,this.locale):undefined;return this.getters.getCurrencyRate(from,to,_date);},args:[arg("currency_from (string)",_t("First currency code.")),arg("currency_to (string)",_t("Second currency code.")),arg("date (date, optional)",_t("Date of the rate.")),],returns:["NUMBER"],});return __exports;});;

/* /spreadsheet/static/src/currency/helpers.js */
odoo.define('@spreadsheet/currency/helpers',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{helpers}=require("@odoo/o-spreadsheet");const{createCurrencyFormat}=helpers;__exports.createDefaultCurrencyFormat=createDefaultCurrencyFormat;function createDefaultCurrencyFormat(currency){return createCurrencyFormat({symbol:currency.symbol,position:currency.position,decimalPlaces:currency.decimalPlaces,});}
return __exports;});;

/* /spreadsheet/static/src/currency/plugins/currency.js */
odoo.define('@spreadsheet/currency/plugins/currency',['@odoo/o-spreadsheet','@spreadsheet/currency/currency_data_source'],function(require){'use strict';let __exports={};const{helpers,registries,UIPlugin}=require("@odoo/o-spreadsheet");const{CurrencyDataSource}=require("@spreadsheet/currency/currency_data_source");const{featurePluginRegistry}=registries;const{createCurrencyFormat}=helpers;const DATA_SOURCE_ID="CURRENCIES";class CurrencyPlugin extends UIPlugin{constructor(config){super(config);this.currentCompanyCurrencyFormat=config.defaultCurrencyFormat;this.dataSources=config.custom.dataSources;if(this.dataSources){this.dataSources.add(DATA_SOURCE_ID,CurrencyDataSource);}}
getCurrencyRate(from,to,date){return(this.dataSources&&this.dataSources.get(DATA_SOURCE_ID).getCurrencyRate(from,to,date));}
computeFormatFromCurrency(currency){if(!currency){return undefined;}
return createCurrencyFormat({symbol:currency.symbol,position:currency.position,decimalPlaces:currency.decimalPlaces,});}
getCompanyCurrencyFormat(companyId){if(!companyId&&this.currentCompanyCurrencyFormat){return this.currentCompanyCurrencyFormat;}
const currency=this.dataSources&&this.dataSources.get(DATA_SOURCE_ID).getCompanyCurrencyFormat(companyId);return this.computeFormatFromCurrency(currency);}}
CurrencyPlugin.getters=["getCurrencyRate","computeFormatFromCurrency","getCompanyCurrencyFormat",];featurePluginRegistry.add("odooCurrency",CurrencyPlugin);return __exports;});;

/* /spreadsheet/static/src/data_sources/data_source.js */
odoo.define('@spreadsheet/data_sources/data_source',['@spreadsheet/o_spreadsheet/errors','@web/core/network/rpc_service','@web/core/utils/concurrency'],function(require){'use strict';let __exports={};const{LoadingDataError}=require("@spreadsheet/o_spreadsheet/errors");const{RPCError}=require("@web/core/network/rpc_service");const{KeepLast}=require("@web/core/utils/concurrency");const LoadableDataSource=__exports.LoadableDataSource=class LoadableDataSource{constructor(params){this._orm=params.orm;this._metadataRepository=params.metadataRepository;this._notifyWhenPromiseResolves=params.notifyWhenPromiseResolves;this._cancelPromise=params.cancelPromise;this._lastUpdate=undefined;this._concurrency=new KeepLast();this._loadPromise=undefined;this._isFullyLoaded=false;this._isValid=true;this._loadErrorMessage="";}
async load(params){if(params&&params.reload){this._cancelPromise(this._loadPromise);this._loadPromise=undefined;}
if(!this._loadPromise){this._isFullyLoaded=false;this._isValid=true;this._loadErrorMessage="";this._loadPromise=this._concurrency.add(this._load()).catch((e)=>{this._isValid=false;this._loadErrorMessage=e instanceof RPCError?e.data.message:e.message;}).finally(()=>{this._lastUpdate=Date.now();this._isFullyLoaded=true;});await this._notifyWhenPromiseResolves(this._loadPromise);}
return this._loadPromise;}
get lastUpdate(){return this._lastUpdate;}
isReady(){return this._isFullyLoaded;}
_assertDataIsLoaded(){if(!this._isFullyLoaded){this.load();throw LOADING_ERROR;}
if(!this._isValid){throw new Error(this._loadErrorMessage);}}
async _load(){}}
const LOADING_ERROR=new LoadingDataError();return __exports;});;

/* /spreadsheet/static/src/data_sources/data_sources.js */
odoo.define('@spreadsheet/data_sources/data_sources',['@spreadsheet/data_sources/data_source','@spreadsheet/data_sources/metadata_repository','@odoo/owl'],function(require){'use strict';let __exports={};const{LoadableDataSource}=require("@spreadsheet/data_sources/data_source");const{MetadataRepository}=require("@spreadsheet/data_sources/metadata_repository");const{EventBus}=require("@odoo/owl");const DataSources=__exports.DataSources=class DataSources extends EventBus{constructor(env){super();this._orm=env.services.orm.silent;this._metadataRepository=new MetadataRepository(env);this._metadataRepository.addEventListener("labels-fetched",()=>this.notify());this._dataSources={};this.pendingPromises=new Set();}
create(cls,params){return new cls({orm:this._orm,metadataRepository:this._metadataRepository,notify:()=>this.notify(),notifyWhenPromiseResolves:this.notifyWhenPromiseResolves.bind(this),cancelPromise:(promise)=>this.pendingPromises.delete(promise),},params);}
add(id,cls,params){this._dataSources[id]=this.create(cls,params);return this._dataSources[id];}
async load(id,reload=false){const dataSource=this.get(id);if(dataSource instanceof LoadableDataSource){await dataSource.load({reload});}}
get(id){return this._dataSources[id];}
contains(id){return id in this._dataSources;}
async notifyWhenPromiseResolves(promise){this.pendingPromises.add(promise);await promise.then(()=>{this.pendingPromises.delete(promise);this.notify();}).catch(()=>{this.pendingPromises.delete(promise);this.notify();});}
notify(){if(this.pendingPromises.size){if(!this.nextTriggerTimeOutId){this.nextTriggerTimeOutId=setTimeout(()=>{this.nextTriggerTimeOutId=undefined;if(this.pendingPromises.size){this.trigger("data-source-updated");}},10000);}
return;}
this.trigger("data-source-updated");}
async waitForAllLoaded(){await Promise.all(Object.values(this._dataSources).map((ds)=>ds instanceof LoadableDataSource&&ds.load()));}}
return __exports;});;

/* /spreadsheet/static/src/data_sources/display_name_repository.js */
odoo.define('@spreadsheet/data_sources/display_name_repository',['@web/core/l10n/translation','@spreadsheet/o_spreadsheet/errors'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{LoadingDataError}=require("@spreadsheet/o_spreadsheet/errors");const DisplayNameRepository=__exports.DisplayNameRepository=class DisplayNameRepository{constructor(env,{whenDataIsFetched}){this.dataFetchedCallback=whenDataIsFetched;this._displayNames={};this._blockNotification=false;this._nameService=env.services.name;}
setDisplayName(model,id,displayName){this._nameService.addDisplayNames(model,{[id]:displayName});if(!this._displayNames[model]){this._displayNames[model]={};}
this._displayNames[model][id]={state:"COMPLETED",value:displayName,};}
getDisplayName(model,id){if(!id){return"";}
const displayNameResult=this._displayNames[model]?.[id];if(!displayNameResult){this._fetchDisplayName(model,id);throw new LoadingDataError();}
switch(displayNameResult.state){case"ERROR":throw displayNameResult.error;case"COMPLETED":return displayNameResult.value;default:throw new LoadingDataError();}}
async _fetchDisplayName(model,id){if(!this._displayNames[model]){this._displayNames[model]={};}
this._displayNames[model][id]={state:"PENDING"};const displayNames=await this._nameService.loadDisplayNames(model,[id]);if(typeof displayNames[id]==="string"){this._displayNames[model][id].state="COMPLETED";this._displayNames[model][id].value=displayNames[id];}else{this._displayNames[model][id].state="ERROR";this._displayNames[model][id].error=new Error(_t("Name not found. You may not have the required access rights."));}
if(this._blockNotification){return;}
this._blockNotification=true;await Promise.resolve();this._blockNotification=false;this.dataFetchedCallback();}}
return __exports;});;

/* /spreadsheet/static/src/data_sources/labels_repository.js */
odoo.define('@spreadsheet/data_sources/labels_repository',[],function(require){'use strict';let __exports={};const LabelsRepository=__exports.LabelsRepository=class LabelsRepository{constructor(){this._labels={};}
getLabel(model,field,value){return(this._labels[model]&&this._labels[model][field]&&this._labels[model][field][value]);}
setLabel(model,field,value,label){if(!this._labels[model]){this._labels[model]={};}
if(!this._labels[model][field]){this._labels[model][field]={};}
this._labels[model][field][value]=label;}}
return __exports;});;

/* /spreadsheet/static/src/data_sources/metadata_repository.js */
odoo.define('@spreadsheet/data_sources/metadata_repository',['@web/core/l10n/translation','@web/core/utils/strings','@spreadsheet/data_sources/server_data','@spreadsheet/o_spreadsheet/errors','@spreadsheet/data_sources/display_name_repository','@spreadsheet/data_sources/labels_repository','@odoo/owl'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const{ServerData}=require("@spreadsheet/data_sources/server_data");const{LoadingDataError}=require("@spreadsheet/o_spreadsheet/errors");const{DisplayNameRepository}=require("@spreadsheet/data_sources/display_name_repository");const{LabelsRepository}=require("@spreadsheet/data_sources/labels_repository");const{EventBus}=require("@odoo/owl");const MetadataRepository=__exports.MetadataRepository=class MetadataRepository extends EventBus{constructor(env){super();this.orm=env.services.orm.silent;this.nameService=env.services.name;this.serverData=new ServerData(this.orm,{whenDataIsFetched:()=>this.trigger("labels-fetched"),});this.labelsRepository=new LabelsRepository();this.displayNameRepository=new DisplayNameRepository(env,{whenDataIsFetched:()=>this.trigger("labels-fetched"),});}
async modelDisplayName(model){const result=await this.serverData.fetch("ir.model","display_name_for",[[model]]);return(result[0]&&result[0].display_name)||"";}
async fieldsGet(model){return this.serverData.fetch(model,"fields_get");}
registerLabel(model,field,value,label){this.labelsRepository.setLabel(model,field,value,label);}
getLabel(model,field,value){return this.labelsRepository.getLabel(model,field,value);}
setDisplayName(model,id,result){this.displayNameRepository.setDisplayName(model,id,result);}
getRecordDisplayName(model,id){try{return this.displayNameRepository.getDisplayName(model,id);}catch(e){if(e instanceof LoadingDataError){throw e;}
throw new Error(sprintf(_t("Unable to fetch the label of %s of model %s"),id,model));}}}
return __exports;});;

/* /spreadsheet/static/src/data_sources/odoo_views_data_source.js */
odoo.define('@spreadsheet/data_sources/odoo_views_data_source',['@spreadsheet/data_sources/data_source','@web/core/domain','@spreadsheet/o_spreadsheet/errors','@web/core/utils/objects'],function(require){'use strict';let __exports={};const{LoadableDataSource}=require("@spreadsheet/data_sources/data_source");const{Domain}=require("@web/core/domain");const{LoadingDataError}=require("@spreadsheet/o_spreadsheet/errors");const{omit}=require("@web/core/utils/objects");const OdooViewsDataSource=__exports.OdooViewsDataSource=class OdooViewsDataSource extends LoadableDataSource{constructor(services,params){super(services);this._metaData=JSON.parse(JSON.stringify(params.metaData));this._initialSearchParams=JSON.parse(JSON.stringify(params.searchParams));const userContext=this._orm.user.context;this._initialSearchParams.context=omit(this._initialSearchParams.context||{},...Object.keys(userContext));this._customDomain=this._initialSearchParams.domain;}
get _searchParams(){return{...this._initialSearchParams,domain:this.getComputedDomain(),};}
async loadMetadata(){if(!this._metaData.fields){this._metaData.fields=await this._metadataRepository.fieldsGet(this._metaData.resModel);}}
getFields(){if(this._metaData.fields===undefined){this.loadMetadata();throw new LoadingDataError();}
return this._metaData.fields;}
getField(field){return this._metaData.fields[field];}
async _load(){await this.loadMetadata();}
isMetaDataLoaded(){return this._metaData.fields!==undefined;}
getComputedDomain(){const userContext=this._orm.user.context;return new Domain(this._customDomain).toList({...this._initialSearchParams.context,...userContext,});}
getInitialDomainString(){return new Domain(this._initialSearchParams.domain).toString();}
addDomain(domain){const newDomain=Domain.and([this._initialSearchParams.domain,domain]).toString();if(newDomain.toString()===new Domain(this._customDomain).toString()){return;}
this._customDomain=newDomain;if(this._loadPromise===undefined){return;}
this.load({reload:true});}
getModelLabel(){return this._metadataRepository.modelDisplayName(this._metaData.resModel);}}
return __exports;});;

/* /spreadsheet/static/src/data_sources/server_data.js */
odoo.define('@spreadsheet/data_sources/server_data',['@spreadsheet/o_spreadsheet/errors'],function(require){'use strict';let __exports={};const{LoadingDataError}=require("@spreadsheet/o_spreadsheet/errors");function removeDuplicates(array){return[...new Set(array.map((el)=>JSON.stringify(el)))].map((el)=>JSON.parse(el));}
const Request=__exports.Request=class Request{constructor(resModel,method,args){this.resModel=resModel;this.method=method;this.args=args;this.key=`${resModel}/${method}(${JSON.stringify(args)})`;}}
class ListRequestBatch{constructor(resModel,method,requests=[]){this.resModel=resModel;this.method=method;this.requests=requests;}
get payload(){const payload=removeDuplicates(this.requests.map((request)=>request.args).flat());return[payload];}
add(request){if(request.resModel!==this.resModel||request.method!==this.method){throw new Error(`Request ${request.resModel}/${request.method} cannot be added to the batch ${this.resModel}/${this.method}`);}
this.requests.push(request);}
splitResponse(results){const split=new Map();for(let i=0;i<this.requests.length;i++){split.set(this.requests[i],results[i]);}
return split;}}
const ServerData=__exports.ServerData=class ServerData{constructor(orm,{whenDataIsFetched}){this.orm=orm;this.dataFetchedCallback=whenDataIsFetched;this.cache={};this.asyncCache={};this.batchEndpoints={};}
get batch(){return{get:(resModel,method,args)=>this._getBatchItem(resModel,method,args)};}
_getBatchItem(resModel,method,args){const request=new Request(resModel,method,[args]);if(!(request.key in this.cache)){const error=new LoadingDataError();this.cache[request.key]=error;this._batch(request);throw error;}
return this._getOrThrowCachedResponse(request);}
get(resModel,method,args){const request=new Request(resModel,method,args);if(!(request.key in this.cache)){const error=new LoadingDataError();this.cache[request.key]=error;this.orm.call(resModel,method,args).then((result)=>(this.cache[request.key]=result)).catch((error)=>(this.cache[request.key]=error)).finally(()=>this.dataFetchedCallback());throw error;}
return this._getOrThrowCachedResponse(request);}
async fetch(resModel,method,args){const request=new Request(resModel,method,args);if(!(request.key in this.asyncCache)){this.asyncCache[request.key]=this.orm.call(resModel,method,args);}
return this.asyncCache[request.key];}
_batch(request){const endpoint=this._getBatchEndPoint(request.resModel,request.method);endpoint.call(request);}
_getOrThrowCachedResponse(request){const data=this.cache[request.key];if(data instanceof Error){throw data;}
return data;}
_getBatchEndPoint(resModel,method){if(!this.batchEndpoints[resModel]||!this.batchEndpoints[resModel][method]){this.batchEndpoints[resModel]={...this.batchEndpoints[resModel],[method]:this._createBatchEndpoint(resModel,method),};}
return this.batchEndpoints[resModel][method];}
_createBatchEndpoint(resModel,method){return new BatchEndpoint(this.orm,resModel,method,{whenDataIsFetched:()=>this.dataFetchedCallback(),successCallback:(request,result)=>(this.cache[request.key]=result),failureCallback:(request,error)=>(this.cache[request.key]=error),});}}
const BatchEndpoint=__exports.BatchEndpoint=class BatchEndpoint{constructor(orm,resModel,method,{successCallback,failureCallback,whenDataIsFetched}){this.orm=orm;this.resModel=resModel;this.method=method;this.successCallback=successCallback;this.failureCallback=failureCallback;this.batchedFetchedCallback=whenDataIsFetched;this._isScheduled=false;this._pendingBatch=new ListRequestBatch(resModel,method);}
call(request){this._pendingBatch.add(request);this._scheduleNextBatch();}
_notifyResults(batchResult){for(const[request,result]of batchResult){if(result instanceof Error){this.failureCallback(request,result);}else{this.successCallback(request,result);}}}
_scheduleNextBatch(){if(this._isScheduled||this._pendingBatch.requests.length===0){return;}
this._isScheduled=true;queueMicrotask(async()=>{try{this._isScheduled=false;const batch=this._pendingBatch;const{resModel,method}=batch;this._pendingBatch=new ListRequestBatch(resModel,method);await this.orm.call(resModel,method,batch.payload).then((result)=>batch.splitResponse(result)).catch(()=>this._retryOneByOne(batch)).then((batchResults)=>this._notifyResults(batchResults));}finally{this.batchedFetchedCallback();}});}
async _retryOneByOne(batch){const mergedResults=new Map();const{resModel,method}=batch;const singleRequestBatches=batch.requests.map((request)=>new ListRequestBatch(resModel,method,[request]));const proms=[];for(const batch of singleRequestBatches){const request=batch.requests[0];const prom=this.orm.call(resModel,method,batch.payload).then((result)=>mergedResults.set(request,batch.splitResponse(result).get(request))).catch((error)=>mergedResults.set(request,error));proms.push(prom);}
await Promise.allSettled(proms);return mergedResults;}}
return __exports;});;

/* /spreadsheet/static/src/global_filters/components/filter_date_from_to_value/filter_date_from_to_value.js */
odoo.define('@spreadsheet/global_filters/components/filter_date_from_to_value/filter_date_from_to_value',['@odoo/owl','@web/core/l10n/translation','@web/core/datetime/datetime_input','@web/core/l10n/dates'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{_t}=require("@web/core/l10n/translation");const{DateTimeInput}=require("@web/core/datetime/datetime_input");const{serializeDate,deserializeDate}=require("@web/core/l10n/dates");const DateFromToValue=__exports.DateFromToValue=class DateFromToValue extends Component{static template="spreadsheet.DateFromToValue";static components={DateTimeInput};static props={onFromToChanged:Function,from:{type:String,optional:true},to:{type:String,optional:true},};fromPlaceholder=_t("Date from...");toPlaceholder=_t("Date to...");onDateFromChanged(dateFrom){this.props.onFromToChanged({from:dateFrom?serializeDate(dateFrom.startOf("day")):undefined,to:this.props.to,});}
onDateToChanged(dateTo){this.props.onFromToChanged({from:this.props.from,to:dateTo?serializeDate(dateTo.endOf("day")):undefined,});}
get dateFrom(){return this.props.from&&deserializeDate(this.props.from);}
get dateTo(){return this.props.to&&deserializeDate(this.props.to);}}
return __exports;});;

/* /spreadsheet/static/src/global_filters/components/filter_date_value/filter_date_value.js */
odoo.define('@spreadsheet/global_filters/components/filter_date_value/filter_date_value',['@odoo/owl','@web/core/datetime/datetime_input','@spreadsheet/assets_backend/constants','@web/search/utils/dates'],function(require){'use strict';let __exports={};const{Component,onWillUpdateProps}=require("@odoo/owl");const{DateTimeInput}=require("@web/core/datetime/datetime_input");const{FILTER_DATE_OPTION,monthsOptions}=require("@spreadsheet/assets_backend/constants");const{getPeriodOptions}=require("@web/search/utils/dates");const{DateTime}=luxon;const DateFilterValue=__exports.DateFilterValue=class DateFilterValue extends Component{setup(){this._setStateFromProps(this.props);onWillUpdateProps(this._setStateFromProps);this.dateOptions=this.getDateOptions();}
_setStateFromProps(props){this.period=props.period;this.yearOffset=props.yearOffset;this.date=this.yearOffset!==undefined?DateTime.local().plus({year:this.yearOffset}):undefined;}
getDateOptions(){const periodOptions=getPeriodOptions(DateTime.local());const quarters=FILTER_DATE_OPTION["quarter"].map((quarterId)=>periodOptions.find((option)=>option.id===quarterId));return quarters.concat(monthsOptions);}
isSelected(periodId){return this.period===periodId;}
onPeriodChanged(ev){this.period=ev.target.value;this._updateFilter();}
onYearChanged(date){this.date=date;this.yearOffset=date.year-DateTime.now().year;this._updateFilter();}
_updateFilter(){this.props.onTimeRangeChanged({yearOffset:this.yearOffset||0,period:this.period,});}}
DateFilterValue.template="spreadsheet_edition.DateFilterValue";DateFilterValue.components={DateTimeInput};DateFilterValue.props={onTimeRangeChanged:Function,yearOffset:{type:Number,optional:true},period:{type:String,optional:true},};return __exports;});;

/* /spreadsheet/static/src/global_filters/components/filter_text_value/filter_text_value.js */
odoo.define('@spreadsheet/global_filters/components/filter_text_value/filter_text_value',['@odoo/owl','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{Component}=require("@odoo/owl");const{_t}=require("@web/core/l10n/translation");const TextFilterValue=__exports.TextFilterValue=class TextFilterValue extends Component{static template="spreadsheet.TextFilterValue";static props={label:{type:String,optional:true},onValueChanged:Function,value:{type:String,optional:true},options:{type:Array,element:{type:Object,shape:{value:String,formattedValue:String},optional:true,},},};translate(label){return _t(label);}}
return __exports;});;

/* /spreadsheet/static/src/global_filters/components/filter_value/filter_value.js */
odoo.define('@spreadsheet/global_filters/components/filter_value/filter_value',['@web/core/record_selectors/multi_record_selector','@spreadsheet/helpers/constants','@spreadsheet/global_filters/components/filter_date_value/filter_date_value','@spreadsheet/global_filters/components/filter_date_from_to_value/filter_date_from_to_value','@odoo/owl','@web/core/l10n/translation','@web/core/utils/hooks','@spreadsheet/global_filters/components/filter_text_value/filter_text_value'],function(require){'use strict';let __exports={};const{MultiRecordSelector}=require("@web/core/record_selectors/multi_record_selector");const{RELATIVE_DATE_RANGE_TYPES}=require("@spreadsheet/helpers/constants");const{DateFilterValue}=require("@spreadsheet/global_filters/components/filter_date_value/filter_date_value");const{DateFromToValue}=require("@spreadsheet/global_filters/components/filter_date_from_to_value/filter_date_from_to_value");const{Component}=require("@odoo/owl");const{_t}=require("@web/core/l10n/translation");const{useService}=require("@web/core/utils/hooks");const{TextFilterValue}=require("@spreadsheet/global_filters/components/filter_text_value/filter_text_value");const FilterValue=__exports.FilterValue=class FilterValue extends Component{setup(){this.getters=this.props.model.getters;this.relativeDateRangesTypes=RELATIVE_DATE_RANGE_TYPES;this.nameService=useService("name");}
get filter(){return this.props.filter;}
get filterValue(){return this.getters.getGlobalFilterValue(this.filter.id);}
get textAllowedValues(){return this.getters.getTextFilterOptions(this.filter.id);}
onDateInput(id,value){this.props.model.dispatch("SET_GLOBAL_FILTER_VALUE",{id,value});}
onTextInput(id,value){this.props.model.dispatch("SET_GLOBAL_FILTER_VALUE",{id,value});}
async onTagSelected(id,resIds){if(!resIds.length){this.clear(id);}else{const displayNames=await this.nameService.loadDisplayNames(this.filter.modelName,resIds);this.props.model.dispatch("SET_GLOBAL_FILTER_VALUE",{id,value:resIds,displayNames:Object.values(displayNames),});}}
translate(text){return _t(text);}
clear(id){this.props.model.dispatch("CLEAR_GLOBAL_FILTER_VALUE",{id});}}
FilterValue.template="spreadsheet_edition.FilterValue";FilterValue.components={DateFilterValue,DateFromToValue,MultiRecordSelector,TextFilterValue};FilterValue.props={filter:Object,model:Object,};return __exports;});;

/* /spreadsheet/static/src/global_filters/helpers.js */
odoo.define('@spreadsheet/global_filters/helpers',['@web/core/l10n/dates','@web/core/domain','@spreadsheet/o_spreadsheet/cancelled_reason','@spreadsheet/helpers/constants'],function(require){'use strict';let __exports={};const{serializeDate,serializeDateTime}=require("@web/core/l10n/dates");const{Domain}=require("@web/core/domain");const{CommandResult}=require("@spreadsheet/o_spreadsheet/cancelled_reason");const{RELATIVE_DATE_RANGE_TYPES}=require("@spreadsheet/helpers/constants");__exports.checkFiltersTypeValueCombination=checkFiltersTypeValueCombination;function checkFiltersTypeValueCombination(type,value){if(value!==undefined){switch(type){case"text":if(typeof value!=="string"){return CommandResult.InvalidValueTypeCombination;}
break;case"date":{if(value===""){return CommandResult.Success;}else if(typeof value==="string"){const expectedValues=RELATIVE_DATE_RANGE_TYPES.map((val)=>val.type);expectedValues.push("this_month","this_quarter","this_year");if(expectedValues.includes(value)){return CommandResult.Success;}
return CommandResult.InvalidValueTypeCombination;}else if(typeof value!=="object"){return CommandResult.InvalidValueTypeCombination;}
break;}
case"relation":if(value==="current_user"){return CommandResult.Success;}
if(!Array.isArray(value)){return CommandResult.InvalidValueTypeCombination;}
break;}}
return CommandResult.Success;}
__exports.checkFilterFieldMatching=checkFilterFieldMatching;function checkFilterFieldMatching(fieldMatchings){for(const fieldMatch of Object.values(fieldMatchings)){if(fieldMatch.offset&&(!fieldMatch.chain||!fieldMatch.type)){return CommandResult.InvalidFieldMatch;}}
return CommandResult.Success;}
__exports.getRelativeDateDomain=getRelativeDateDomain;function getRelativeDateDomain(now,offset,rangeType,fieldName,fieldType){const startOfNextDay=now.plus({days:1}).startOf("day");let endDate=now.endOf("day");let startDate=endDate;switch(rangeType){case"year_to_date":{const offsetParam={years:offset};startDate=now.startOf("year").plus(offsetParam);endDate=now.endOf("day").plus(offsetParam);break;}
case"last_week":{const offsetParam={days:7*offset};endDate=endDate.plus(offsetParam);startDate=startOfNextDay.minus({days:7}).plus(offsetParam);break;}
case"last_month":{const offsetParam={days:30*offset};endDate=endDate.plus(offsetParam);startDate=startOfNextDay.minus({days:30}).plus(offsetParam);break;}
case"last_three_months":{const offsetParam={days:90*offset};endDate=endDate.plus(offsetParam);startDate=startOfNextDay.minus({days:90}).plus(offsetParam);break;}
case"last_six_months":{const offsetParam={days:180*offset};endDate=endDate.plus(offsetParam);startDate=startOfNextDay.minus({days:180}).plus(offsetParam);break;}
case"last_year":{const offsetParam={days:365*offset};endDate=endDate.plus(offsetParam);startDate=startOfNextDay.minus({days:365}).plus(offsetParam);break;}
case"last_three_years":{const offsetParam={days:3*365*offset};endDate=endDate.plus(offsetParam);startDate=startOfNextDay.minus({days:3*365}).plus(offsetParam);break;}
default:return undefined;}
let leftBound,rightBound;if(fieldType==="date"){leftBound=serializeDate(startDate);rightBound=serializeDate(endDate);}else{leftBound=serializeDateTime(startDate);rightBound=serializeDateTime(endDate);}
return new Domain(["&",[fieldName,">=",leftBound],[fieldName,"<=",rightBound]]);}
return __exports;});;

/* /spreadsheet/static/src/global_filters/index.js */
odoo.define('@spreadsheet/global_filters',['@odoo/o-spreadsheet','@spreadsheet/global_filters/plugins/global_filters_ui_plugin','@spreadsheet/global_filters/plugins/global_filters_core_plugin'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{GlobalFiltersUIPlugin}=require("@spreadsheet/global_filters/plugins/global_filters_ui_plugin");const{GlobalFiltersCorePlugin}=require("@spreadsheet/global_filters/plugins/global_filters_core_plugin");const{inverseCommandRegistry}=spreadsheet.registries;function identity(cmd){return[cmd];}
const{coreTypes,invalidateEvaluationCommands,invalidateCFEvaluationCommands,invalidateDependenciesCommands,readonlyAllowedCommands,}=spreadsheet;coreTypes.add("ADD_GLOBAL_FILTER");coreTypes.add("EDIT_GLOBAL_FILTER");coreTypes.add("REMOVE_GLOBAL_FILTER");coreTypes.add("MOVE_GLOBAL_FILTER");invalidateEvaluationCommands.add("ADD_GLOBAL_FILTER");invalidateEvaluationCommands.add("EDIT_GLOBAL_FILTER");invalidateEvaluationCommands.add("REMOVE_GLOBAL_FILTER");invalidateEvaluationCommands.add("SET_GLOBAL_FILTER_VALUE");invalidateEvaluationCommands.add("CLEAR_GLOBAL_FILTER_VALUE");invalidateDependenciesCommands.add("ADD_GLOBAL_FILTER");invalidateDependenciesCommands.add("EDIT_GLOBAL_FILTER");invalidateDependenciesCommands.add("REMOVE_GLOBAL_FILTER");invalidateDependenciesCommands.add("SET_GLOBAL_FILTER_VALUE");invalidateDependenciesCommands.add("CLEAR_GLOBAL_FILTER_VALUE");invalidateCFEvaluationCommands.add("ADD_GLOBAL_FILTER");invalidateCFEvaluationCommands.add("EDIT_GLOBAL_FILTER");invalidateCFEvaluationCommands.add("REMOVE_GLOBAL_FILTER");invalidateCFEvaluationCommands.add("SET_GLOBAL_FILTER_VALUE");invalidateCFEvaluationCommands.add("CLEAR_GLOBAL_FILTER_VALUE");readonlyAllowedCommands.add("SET_GLOBAL_FILTER_VALUE");readonlyAllowedCommands.add("SET_MANY_GLOBAL_FILTER_VALUE");readonlyAllowedCommands.add("CLEAR_GLOBAL_FILTER_VALUE");readonlyAllowedCommands.add("UPDATE_OBJECT_DOMAINS");inverseCommandRegistry.add("EDIT_GLOBAL_FILTER",identity).add("ADD_GLOBAL_FILTER",(cmd)=>{return[{type:"REMOVE_GLOBAL_FILTER",id:cmd.filter.id,},];}).add("REMOVE_GLOBAL_FILTER",(cmd)=>{return[{type:"ADD_GLOBAL_FILTER",filter:{},},];}).add("MOVE_GLOBAL_FILTER",(cmd)=>{return[{type:"MOVE_GLOBAL_FILTER",id:cmd.id,delta:cmd.delta*-1,},];});Object.assign(__exports,{GlobalFiltersCorePlugin,GlobalFiltersUIPlugin});return __exports;});;

/* /spreadsheet/static/src/global_filters/plugins/global_filters_core_plugin.js */
odoo.define('@spreadsheet/global_filters/plugins/global_filters_core_plugin',['@odoo/o-spreadsheet','@spreadsheet/o_spreadsheet/cancelled_reason','@spreadsheet/global_filters/helpers','@web/core/l10n/translation','@web/core/utils/strings'],function(require){'use strict';let __exports={};const globalFiltersFieldMatchers=__exports.globalFiltersFieldMatchers={};const spreadsheet=require("@odoo/o-spreadsheet");const{CommandResult}=require("@spreadsheet/o_spreadsheet/cancelled_reason");const{checkFiltersTypeValueCombination}=require("@spreadsheet/global_filters/helpers");const{_t}=require("@web/core/l10n/translation");const{escapeRegExp}=require("@web/core/utils/strings");const GlobalFiltersCorePlugin=__exports.GlobalFiltersCorePlugin=class GlobalFiltersCorePlugin extends spreadsheet.CorePlugin{constructor(config){super(config);this.globalFilters=[];}
allowDispatch(cmd){switch(cmd.type){case"EDIT_GLOBAL_FILTER":if(!this.getGlobalFilter(cmd.filter.id)){return CommandResult.FilterNotFound;}else if(this._isDuplicatedLabel(cmd.filter.id,cmd.filter.label)){return CommandResult.DuplicatedFilterLabel;}
return checkFiltersTypeValueCombination(cmd.filter.type,cmd.filter.defaultValue);case"REMOVE_GLOBAL_FILTER":if(!this.getGlobalFilter(cmd.id)){return CommandResult.FilterNotFound;}
break;case"ADD_GLOBAL_FILTER":if(this._isDuplicatedLabel(cmd.filter.id,cmd.filter.label)){return CommandResult.DuplicatedFilterLabel;}
return checkFiltersTypeValueCombination(cmd.filter.type,cmd.filter.defaultValue);case"MOVE_GLOBAL_FILTER":{const index=this.globalFilters.findIndex((filter)=>filter.id===cmd.id);if(index===-1){return CommandResult.FilterNotFound;}
const targetIndex=index+cmd.delta;if(targetIndex<0||targetIndex>=this.globalFilters.length){return CommandResult.InvalidFilterMove;}
break;}}
return CommandResult.Success;}
handle(cmd){switch(cmd.type){case"ADD_GLOBAL_FILTER":{const filter={...cmd.filter};if(filter.type==="text"&&filter.rangeOfAllowedValues){filter.rangeOfAllowedValues=this.getters.getRangeFromRangeData(filter.rangeOfAllowedValues);}
this.history.update("globalFilters",[...this.globalFilters,filter]);break;}
case"EDIT_GLOBAL_FILTER":{this._editGlobalFilter(cmd.filter);break;}
case"REMOVE_GLOBAL_FILTER":{const filters=this.globalFilters.filter((filter)=>filter.id!==cmd.id);this.history.update("globalFilters",filters);break;}
case"MOVE_GLOBAL_FILTER":this._onMoveFilter(cmd.id,cmd.delta);break;}}
adaptRanges(applyChange){for(const filterIndex in this.globalFilters){const filter=this.globalFilters[filterIndex];if(filter.type==="text"&&filter.rangeOfAllowedValues){const change=applyChange(filter.rangeOfAllowedValues);switch(change.changeType){case"REMOVE":{this.history.update("globalFilters",filterIndex,"rangeOfAllowedValues",undefined);break;}
case"RESIZE":case"MOVE":case"CHANGE":{this.history.update("globalFilters",filterIndex,"rangeOfAllowedValues",change.range);}}}}}
getGlobalFilter(id){return this.globalFilters.find((filter)=>filter.id===id);}
getGlobalFilterLabel(label){return this.globalFilters.find((filter)=>_t(filter.label)===_t(label));}
getGlobalFilters(){return[...this.globalFilters];}
getGlobalFilterDefaultValue(id){return this.getGlobalFilter(id).defaultValue;}
getFieldMatchingForModel(newModel){const globalFilters=this.getGlobalFilters();if(globalFilters.length===0){return{};}
for(const matcher of Object.values(globalFiltersFieldMatchers)){for(const dataSourceId of matcher.getIds()){const model=matcher.getModel(dataSourceId);if(model===newModel){const fieldMatching={};for(const filter of globalFilters){const matchedField=matcher.getFieldMatching(dataSourceId,filter.id);if(matchedField){fieldMatching[filter.id]={chain:matchedField.chain,type:matchedField.type,};}}
return fieldMatching;}}}
return{};}
_editGlobalFilter(newFilter){newFilter={...newFilter};if(newFilter.type==="text"&&newFilter.rangeOfAllowedValues){newFilter.rangeOfAllowedValues=this.getters.getRangeFromRangeData(newFilter.rangeOfAllowedValues);}
const id=newFilter.id;const currentLabel=this.getGlobalFilter(id).label;const index=this.globalFilters.findIndex((filter)=>filter.id===id);if(index===-1){return;}
this.history.update("globalFilters",index,newFilter);const newLabel=this.getGlobalFilter(id).label;if(currentLabel!==newLabel){this._updateFilterLabelInFormulas(currentLabel,newLabel);}}
import(data){for(const globalFilter of data.globalFilters||[]){if(globalFilter.type==="text"&&globalFilter.rangeOfAllowedValues){globalFilter.rangeOfAllowedValues=this.getters.getRangeFromSheetXC("",globalFilter.rangeOfAllowedValues);}
this.globalFilters.push(globalFilter);}}
export(data){data.globalFilters=this.globalFilters.map((filter)=>{filter={...filter};if(filter.type==="text"&&filter.rangeOfAllowedValues){filter.rangeOfAllowedValues=this.getters.getRangeString(filter.rangeOfAllowedValues);}
return filter;});}
_updateFilterLabelInFormulas(currentLabel,newLabel){const sheetIds=this.getters.getSheetIds();currentLabel=escapeRegExp(currentLabel);for(const sheetId of sheetIds){for(const cell of Object.values(this.getters.getCells(sheetId))){if(cell.isFormula){const newContent=cell.content.replace(new RegExp(`FILTER\\.VALUE\\(\\s*"${currentLabel}"\\s*\\)`,"g"),`FILTER.VALUE("${newLabel}")`);if(newContent!==cell.content){const{col,row}=this.getters.getCellPosition(cell.id);this.dispatch("UPDATE_CELL",{sheetId,content:newContent,col,row,});}}}}}
_isDuplicatedLabel(filterId,label){return(this.globalFilters.findIndex((filter)=>(!filterId||filter.id!==filterId)&&filter.label===label)>-1);}
_onMoveFilter(filterId,delta){const filters=[...this.globalFilters];const currentIndex=filters.findIndex((s)=>s.id===filterId);const filter=filters[currentIndex];const targetIndex=currentIndex+delta;filters.splice(currentIndex,1);filters.splice(targetIndex,0,filter);this.history.update("globalFilters",filters);}}
GlobalFiltersCorePlugin.getters=["getGlobalFilter","getGlobalFilters","getGlobalFilterDefaultValue","getGlobalFilterLabel","getFieldMatchingForModel",];return __exports;});;

/* /spreadsheet/static/src/global_filters/plugins/global_filters_ui_plugin.js */
odoo.define('@spreadsheet/global_filters/plugins/global_filters_ui_plugin',['@web/core/l10n/translation','@web/core/utils/strings','@web/core/domain','@web/search/utils/dates','@odoo/o-spreadsheet','@spreadsheet/o_spreadsheet/cancelled_reason','@spreadsheet/helpers/helpers','@spreadsheet/assets_backend/constants','@spreadsheet/global_filters/helpers','@spreadsheet/helpers/constants','@spreadsheet/helpers/model','@web/core/l10n/dates'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const{Domain}=require("@web/core/domain");const{constructDateRange,getPeriodOptions,QUARTER_OPTIONS}=require("@web/search/utils/dates");const spreadsheet=require("@odoo/o-spreadsheet");const{CommandResult}=require("@spreadsheet/o_spreadsheet/cancelled_reason");const{isEmpty}=require("@spreadsheet/helpers/helpers");const{FILTER_DATE_OPTION}=require("@spreadsheet/assets_backend/constants");const{checkFiltersTypeValueCombination,getRelativeDateDomain,}=require("@spreadsheet/global_filters/helpers");const{RELATIVE_DATE_RANGE_TYPES}=require("@spreadsheet/helpers/constants");const{getItemId}=require("@spreadsheet/helpers/model");const{serializeDateTime,serializeDate}=require("@web/core/l10n/dates");const{DateTime}=luxon;const MONTHS={january:{value:1,granularity:"month"},february:{value:2,granularity:"month"},march:{value:3,granularity:"month"},april:{value:4,granularity:"month"},may:{value:5,granularity:"month"},june:{value:6,granularity:"month"},july:{value:7,granularity:"month"},august:{value:8,granularity:"month"},september:{value:9,granularity:"month"},october:{value:10,granularity:"month"},november:{value:11,granularity:"month"},december:{value:12,granularity:"month"},};const{UuidGenerator,createEmptyExcelSheet,createEmptySheet,toXC,toNumber}=spreadsheet.helpers;const uuidGenerator=new UuidGenerator();const GlobalFiltersUIPlugin=__exports.GlobalFiltersUIPlugin=class GlobalFiltersUIPlugin extends spreadsheet.UIPlugin{constructor(config){super(config);this.orm=config.custom.env?.services.orm;this.dataSources=config.custom.dataSources;this.user=config.custom.env?.services.user;this.recordsDisplayName={};this.values={};}
allowDispatch(cmd){switch(cmd.type){case"SET_GLOBAL_FILTER_VALUE":{const filter=this.getters.getGlobalFilter(cmd.id);if(!filter){return CommandResult.FilterNotFound;}
return checkFiltersTypeValueCombination(filter.type,cmd.value);}}
return CommandResult.Success;}
handle(cmd){switch(cmd.type){case"ADD_GLOBAL_FILTER":this.recordsDisplayName[cmd.filter.id]=cmd.filter.defaultValueDisplayNames;break;case"EDIT_GLOBAL_FILTER":{const id=cmd.filter.id;if(this.values[id]&&this.values[id].rangeType!==cmd.filter.rangeType){delete this.values[id];}
this.recordsDisplayName[id]=cmd.filter.defaultValueDisplayNames;break;}
case"SET_GLOBAL_FILTER_VALUE":this.recordsDisplayName[cmd.id]=cmd.displayNames;if(!cmd.value){this._clearGlobalFilterValue(cmd.id);}else{this._setGlobalFilterValue(cmd.id,cmd.value);}
break;case"SET_MANY_GLOBAL_FILTER_VALUE":for(const filter of cmd.filters){if(filter.value!==undefined){this.dispatch("SET_GLOBAL_FILTER_VALUE",{id:filter.filterId,value:filter.value,});}else{this.dispatch("CLEAR_GLOBAL_FILTER_VALUE",{id:filter.filterId});}}
break;case"REMOVE_GLOBAL_FILTER":delete this.recordsDisplayName[cmd.id];delete this.values[cmd.id];break;case"CLEAR_GLOBAL_FILTER_VALUE":this.recordsDisplayName[cmd.id]=[];this._clearGlobalFilterValue(cmd.id);break;}}
getGlobalFilterDomain(filterId,fieldMatching){const filter=this.getters.getGlobalFilter(filterId);if(!filter){return new Domain();}
switch(filter.type){case"text":return this._getTextDomain(filter,fieldMatching);case"date":return this._getDateDomain(filter,fieldMatching);case"relation":return this._getRelationDomain(filter,fieldMatching);}}
getGlobalFilterValue(filterId){const filter=this.getters.getGlobalFilter(filterId);const value=filterId in this.values?this.values[filterId].value:undefined;const preventAutomaticValue=this.values[filterId]?.value?.preventAutomaticValue;if(filter.type==="date"&&filter.rangeType==="from_to"){return value||{from:undefined,to:undefined};}
const defaultValue=(!preventAutomaticValue&&filter.defaultValue)||undefined;if(filter.type==="date"&&preventAutomaticValue){return undefined;}
if(filter.type==="date"&&isEmpty(value)&&defaultValue){return this._getValueOfCurrentPeriod(filterId);}
if(filter.type==="relation"&&preventAutomaticValue){return[];}
if(filter.type==="relation"&&isEmpty(value)&&defaultValue==="current_user"){return[this.user.userId];}
if(filter.type==="text"&&preventAutomaticValue){return"";}
return value||defaultValue;}
isGlobalFilterActive(id){const{type}=this.getters.getGlobalFilter(id);const value=this.getGlobalFilterValue(id);switch(type){case"text":return value;case"date":return(value&&(typeof value==="string"||value.yearOffset!==undefined||value.period||value.from||value.to));case"relation":return value&&value.length;}}
getActiveFilterCount(){return this.getters.getGlobalFilters().filter((filter)=>this.isGlobalFilterActive(filter.id)).length;}
getFilterDisplayValue(filterName){const filter=this.getters.getGlobalFilterLabel(filterName);if(!filter){throw new Error(sprintf(_t(`Filter "%s" not found`),filterName));}
const value=this.getGlobalFilterValue(filter.id);switch(filter.type){case"text":return[[{value:value||""}]];case"date":{if(filter.rangeType==="from_to"){const locale=this.getters.getLocale();const from={value:value.from&&toNumber(value.from,locale),format:locale.dateFormat,};const to={value:value.to&&toNumber(value.to,locale),format:locale.dateFormat,};return[[from],[to]];}
if(value&&typeof value==="string"){const type=RELATIVE_DATE_RANGE_TYPES.find((type)=>type.type===value);if(!type){return[[{value:""}]];}
return[[{value:type.description.toString()}]];}
if(!value||value.yearOffset===undefined){return[[{value:""}]];}
const periodOptions=getPeriodOptions(DateTime.local());const year=String(DateTime.local().year+value.yearOffset);const period=periodOptions.find(({id})=>value.period===id);let periodStr=period&&period.description;if(!period){periodStr=MONTHS[value.period]&&String(MONTHS[value.period].value).padStart(2,"0");}
return[[{value:periodStr?periodStr+"/"+year:year}]];}
case"relation":if(!value?.length||!this.orm){return[[{value:""}]];}
if(!this.recordsDisplayName[filter.id]){const promise=this.orm.call(filter.modelName,"read",[value,["display_name"]]).then((result)=>{const names=result.map(({display_name})=>display_name);this.recordsDisplayName[filter.id]=names;});this.dataSources.notifyWhenPromiseResolves(promise);return[[{value:""}]];}
return[[{value:this.recordsDisplayName[filter.id].join(", ")}]];}}
getTextFilterOptions(filterId){const filter=this.getters.getGlobalFilter(filterId);const range=filter.rangeOfAllowedValues;if(!range){return[];}
const additionOptions=[this.getGlobalFilterValue(filterId),filter.defaultValue,];const options=this.getTextFilterOptionsFromRange(range,additionOptions);return options;}
getTextFilterOptionsFromRange(range,additionalOptionValues=[]){const cells=this.getters.getEvaluatedCellsInZone(range.sheetId,range.zone);const uniqueFormattedValues=new Set();const uniqueValues=new Set();const allowedValues=cells.filter((cell)=>!["empty","error"].includes(cell.type)).map((cell)=>({value:cell.value.toString(),formattedValue:cell.formattedValue,})).filter((cell)=>{if(uniqueFormattedValues.has(cell.formattedValue)){return false;}
uniqueFormattedValues.add(cell.formattedValue);uniqueValues.add(cell.value);return true;});const additionalOptions=additionalOptionValues.map((value)=>({value,formattedValue:value})).filter((cell)=>{if(cell.value===undefined||cell.value===""||uniqueValues.has(cell.value)){return false;}
uniqueValues.add(cell.value);return true;});return allowedValues.concat(additionalOptions);}
_setGlobalFilterValue(id,value){this.values[id]={value:value,rangeType:this.getters.getGlobalFilter(id).rangeType};}
_getValueOfCurrentPeriod(filterId){const filter=this.getters.getGlobalFilter(filterId);switch(filter.defaultValue){case"this_year":return{yearOffset:0};case"this_month":{const month=new Date().getMonth()+1;const period=Object.entries(MONTHS).find((item)=>item[1].value===month)[0];return{yearOffset:0,period};}
case"this_quarter":{const quarter=Math.floor(new Date().getMonth()/3);const period=FILTER_DATE_OPTION.quarter[quarter];return{yearOffset:0,period};}}
return filter.defaultValue;}
_clearGlobalFilterValue(id){const{type,rangeType}=this.getters.getGlobalFilter(id);let value;switch(type){case"text":value={preventAutomaticValue:true};break;case"date":value={preventAutomaticValue:true};break;case"relation":value={preventAutomaticValue:true};break;}
this.values[id]={value,rangeType};}
_getDateDomain(filter,fieldMatching){let granularity;const value=this.getGlobalFilterValue(filter.id);if(!value||!fieldMatching.chain){return new Domain();}
const field=fieldMatching.chain;const type=fieldMatching.type;const offset=fieldMatching.offset||0;const now=DateTime.local();if(filter.rangeType==="from_to"){const serialize=type==="datetime"?serializeDateTime:serializeDate;const from=value.from&&serialize(DateTime.fromISO(value.from).startOf("day"));const to=value.to&&serialize(DateTime.fromISO(value.to).endOf("day"));if(from&&to){return new Domain(["&",[field,">=",from],[field,"<=",to]]);}
if(from){return new Domain([[field,">=",from]]);}
if(to){return new Domain([[field,"<=",to]]);}
return new Domain();}
if(filter.rangeType==="relative"){return getRelativeDateDomain(now,offset,value,field,type);}
const noPeriod=!value.period||value.period==="empty";const noYear=value.yearOffset===undefined;if(noPeriod&&noYear){return new Domain();}
const setParam={year:now.year};const yearOffset=value.yearOffset||0;const plusParam={years:yearOffset};if(noPeriod){granularity="year";plusParam.years+=offset;}else{granularity=value.period.endsWith("_quarter")?"quarter":"month";switch(granularity){case"month":setParam.month=MONTHS[value.period].value;plusParam.month=offset;break;case"quarter":setParam.quarter=QUARTER_OPTIONS[value.period].setParam.quarter;plusParam.quarter=offset;break;}}
return constructDateRange({referenceMoment:now,fieldName:field,fieldType:type,granularity,setParam,plusParam,}).domain;}
_getTextDomain(filter,fieldMatching){const value=this.getGlobalFilterValue(filter.id);if(!value||!fieldMatching.chain){return new Domain();}
const field=fieldMatching.chain;return new Domain([[field,"ilike",value]]);}
_getRelationDomain(filter,fieldMatching){const values=this.getGlobalFilterValue(filter.id);if(!values||values.length===0||!fieldMatching.chain){return new Domain();}
const field=fieldMatching.chain;return new Domain([[field,"in",values]]);}
exportForExcel(data){if(this.getters.getGlobalFilters().length===0){return;}
this.exportSheetWithActiveFilters(data);data.sheets[data.sheets.length-1]={...createEmptyExcelSheet(uuidGenerator.uuidv4(),_t("Active Filters")),...data.sheets.at(-1),};}
exportSheetWithActiveFilters(data){if(this.getters.getGlobalFilters().length===0){return;}
const styleId=getItemId({bold:true},data.styles);const cells={};cells["A1"]={content:"Filter",style:styleId};cells["B1"]={content:"Value",style:styleId};let numberOfCols=2;let filterRowIndex=1;for(const filter of this.getters.getGlobalFilters()){cells[`A${filterRowIndex + 1}`]={content:filter.label};const result=this.getFilterDisplayValue(filter.label);for(const colIndex in result){numberOfCols=Math.max(numberOfCols,Number(colIndex)+2);for(const rowIndex in result[colIndex]){const cell=result[colIndex][rowIndex];if(cell.value===undefined){continue;}
const xc=toXC(Number(colIndex)+1,Number(rowIndex)+filterRowIndex);cells[xc]={content:cell.value.toString()};if(cell.format){const formatId=getItemId(cell.format,data.formats);cells[xc].format=formatId;}}}
filterRowIndex+=result[0].length;}
const sheet={...createEmptySheet(uuidGenerator.uuidv4(),_t("Active Filters")),cells,colNumber:numberOfCols,rowNumber:filterRowIndex,};data.sheets.push(sheet);}}
GlobalFiltersUIPlugin.getters=["getFilterDisplayValue","getGlobalFilterDomain","getGlobalFilterValue","getActiveFilterCount","isGlobalFilterActive","getTextFilterOptions","getTextFilterOptionsFromRange","exportSheetWithActiveFilters",];return __exports;});;

/* /spreadsheet/static/src/helpers/constants.js */
odoo.define('@spreadsheet/helpers/constants',['@web/core/l10n/translation'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const DEFAULT_LINES_NUMBER=__exports.DEFAULT_LINES_NUMBER=20;const HEADER_STYLE=__exports.HEADER_STYLE={fillColor:"#E6F2F3"};const TOP_LEVEL_STYLE=__exports.TOP_LEVEL_STYLE={bold:true,fillColor:"#E6F2F3"};const MEASURE_STYLE=__exports.MEASURE_STYLE={fillColor:"#E6F2F3",textColor:"#756f6f"};const UNTITLED_SPREADSHEET_NAME=__exports.UNTITLED_SPREADSHEET_NAME=_t("Untitled spreadsheet");const RELATIVE_DATE_RANGE_TYPES=__exports.RELATIVE_DATE_RANGE_TYPES=[{type:"year_to_date",description:_t("Year to Date")},{type:"last_week",description:_t("Last 7 Days")},{type:"last_month",description:_t("Last 30 Days")},{type:"last_three_months",description:_t("Last 90 Days")},{type:"last_six_months",description:_t("Last 180 Days")},{type:"last_year",description:_t("Last 365 Days")},{type:"last_three_years",description:_t("Last 3 Years")},];return __exports;});;

/* /spreadsheet/static/src/helpers/helpers.js */
odoo.define('@spreadsheet/helpers/helpers',[],function(require){'use strict';let __exports={};__exports.intersect=intersect;function intersect(a,b){return a.filter((x)=>b.includes(x));}
__exports.getMaxObjectId=getMaxObjectId;function getMaxObjectId(o){const keys=Object.keys(o);if(!keys.length){return 0;}
const nums=keys.map((id)=>parseInt(id,10));const max=Math.max(...nums);return max;}
__exports.toServerDateString=toServerDateString;function toServerDateString(value){return`${value.getFullYear()}-${value.getMonth() + 1}-${value.getDate()}`;}
__exports.sum=sum;function sum(array){return array.reduce((acc,n)=>acc+n,0);}
function camelToSnakeKey(word){const result=word.replace(/(.){1}([A-Z])/g,"$1 $2");return result.split(" ").join("_").toLowerCase();}
__exports.camelToSnakeObject=camelToSnakeObject;function camelToSnakeObject(obj){const result={};for(const[key,value]of Object.entries(obj)){const isPojo=typeof value==="object"&&value!==null&&value.constructor===Object;result[camelToSnakeKey(key)]=isPojo?camelToSnakeObject(value):value;}
return result;}
__exports.isEmpty=isEmpty;function isEmpty(item){if(!item){return true;}
if(typeof item==="object"){if(Object.values(item).length===0||Object.values(item).every((val)=>val===undefined)){return true;}}
return false;}
__exports.containsReferences=containsReferences;function containsReferences(cell){if(!cell.isFormula){return false;}
return cell.compiledFormula.tokens.some((token)=>token.type==="REFERENCE");}
return __exports;});;

/* /spreadsheet/static/src/helpers/model.js */
odoo.define('@spreadsheet/helpers/model',['@spreadsheet/data_sources/data_sources','@odoo/o-spreadsheet','@spreadsheet/o_spreadsheet/migration','@web/core/l10n/translation','@web/core/assets','@spreadsheet/ir_ui_menu/odoo_menu_link_cell'],function(require){'use strict';let __exports={};const{DataSources}=require("@spreadsheet/data_sources/data_sources");const{Model,parse,helpers,iterateAstNodes}=require("@odoo/o-spreadsheet");const{migrate}=require("@spreadsheet/o_spreadsheet/migration");const{_t}=require("@web/core/l10n/translation");const{loadBundle}=require("@web/core/assets");const{formatValue,isDefined,toCartesian}=helpers;const{isMarkdownViewUrl,isMarkdownIrMenuIdUrl,isIrMenuXmlUrl,}=require("@spreadsheet/ir_ui_menu/odoo_menu_link_cell");__exports.fetchSpreadsheetModel=fetchSpreadsheetModel;async function fetchSpreadsheetModel(env,resModel,resId){const{data,revisions}=await env.services.orm.call(resModel,"join_spreadsheet_session",[resId,]);return createSpreadsheetModel({env,data,revisions});}
__exports.createSpreadsheetModel=createSpreadsheetModel;function createSpreadsheetModel({env,data,revisions}){const dataSources=new DataSources(env);const model=new Model(migrate(data),{custom:{dataSources}},revisions);return model;}
__exports.waitForDataLoaded=waitForDataLoaded;async function waitForDataLoaded(model){const dataSources=model.config.custom.dataSources;await dataSources.waitForAllLoaded();return new Promise((resolve,reject)=>{function check(){model.dispatch("EVALUATE_CELLS");if(isLoaded(model)){dataSources.removeEventListener("data-source-updated",check);resolve();}}
dataSources.addEventListener("data-source-updated",check);check();});}
function containsLinkToOdoo(link){if(link&&link.url){return(isMarkdownViewUrl(link.url)||isIrMenuXmlUrl(link.url)||isMarkdownIrMenuIdUrl(link.url));}}
__exports.freezeOdooData=freezeOdooData;async function freezeOdooData(model){await waitForDataLoaded(model);const data=model.exportData();for(const sheet of Object.values(data.sheets)){for(const[xc,cell]of Object.entries(sheet.cells)){const{col,row}=toCartesian(xc);const sheetId=sheet.id;const evaluatedCell=model.getters.getEvaluatedCell({sheetId,col,row,});if(containsOdooFunction(cell.content)){cell.content=evaluatedCell.value.toString();if(evaluatedCell.format){cell.format=getItemId(evaluatedCell.format,data.formats);}}
if(containsLinkToOdoo(evaluatedCell.link)){cell.content=evaluatedCell.link.label;}}
for(const figure of sheet.figures){if(figure.tag==="chart"&&figure.data.type.startsWith("odoo_")){await loadBundle("web.chartjs_lib");const img=odooChartToImage(model,figure);figure.tag="image";figure.data={path:img,size:{width:figure.width,height:figure.height},};}}}
exportGlobalFiltersToSheet(model,data);return data;}
function exportGlobalFiltersToSheet(model,data){model.getters.exportSheetWithActiveFilters(data);const locale=model.getters.getLocale();for(const filter of data.globalFilters){const content=model.getters.getFilterDisplayValue(filter.label);filter["value"]=content.flat().filter(isDefined).map(({value,format})=>formatValue(value,{format,locale})).filter(isDefined).join(", ");}}
__exports.getItemId=getItemId;function getItemId(item,itemsDic){for(const[key,value]of Object.entries(itemsDic)){if(value===item){return parseInt(key,10);}}
const ids=Object.keys(itemsDic);const maxId=ids.length===0?0:Math.max(...ids.map((id)=>parseInt(id,10)));itemsDic[maxId+1]=item;return maxId+1;}
function containsOdooFunction(content){if(!content||!content.startsWith("=")||(!content.toUpperCase().includes("ODOO.")&&!content.toUpperCase().includes("_T"))){return false;}
try{const ast=parse(content);return iterateAstNodes(ast).some((ast)=>ast.type==="FUNCALL"&&(ast.value.toUpperCase().startsWith("ODOO.")||ast.value.toUpperCase().startsWith("_T")));}catch{return false;}}
function isLoaded(model){for(const sheetId of model.getters.getSheetIds()){for(const cell of Object.values(model.getters.getEvaluatedCells(sheetId))){if(cell.type==="error"&&cell.error.message===_t("Data is loading")){return false;}}}
return true;}
function odooChartToImage(model,figure){const runtime=model.getters.getChartRuntime(figure.id);const div=document.createElement("div");div.style.width=`${figure.width}px`;div.style.height=`${figure.height}px`;const canvas=document.createElement("canvas");div.append(canvas);canvas.setAttribute("width",figure.width);canvas.setAttribute("height",figure.height);document.body.append(div);runtime.chartJsConfig.plugins=[backgroundColorPlugin];const chart=new Chart(canvas,runtime.chartJsConfig);const img=chart.toBase64Image();chart.destroy();div.remove();return img;}
const backgroundColorPlugin={id:"customCanvasBackgroundColor",beforeDraw:(chart,args,options)=>{const{ctx}=chart;ctx.save();ctx.globalCompositeOperation="destination-over";ctx.fillStyle="#ffffff";ctx.fillRect(0,0,chart.width,chart.height);ctx.restore();},};return __exports;});;

/* /spreadsheet/static/src/helpers/odoo_functions_helpers.js */
odoo.define('@spreadsheet/helpers/odoo_functions_helpers',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{parseTokens,iterateAstNodes}=spreadsheet;__exports.getOdooFunctions=getOdooFunctions;function getOdooFunctions(tokens,functionNames){if(!tokens.some((t)=>t.type==="SYMBOL"&&functionNames.includes(t.value.toUpperCase()))){return[];}
let ast;try{ast=parseTokens(tokens);}catch{return[];}
return _getOdooFunctionsFromAST(ast,functionNames);}
function _getOdooFunctionsFromAST(ast,functionNames){return iterateAstNodes(ast).filter((ast)=>ast.type==="FUNCALL"&&functionNames.includes(ast.value.toUpperCase())).map((ast)=>({functionName:ast.value.toUpperCase(),args:ast.args}));}
return __exports;});;

/* /spreadsheet/static/src/hooks.js */
odoo.define('@spreadsheet/hooks',['@odoo/owl','@web/core/assets'],function(require){'use strict';let __exports={};const{useEffect,useExternalListener,useState}=require("@odoo/owl");const{loadBundle}=require("@web/core/assets");__exports.useSpreadsheetPrint=useSpreadsheetPrint;function useSpreadsheetPrint(model){let frozenPrintState=undefined;const printState=useState({active:false});useExternalListener(window,"keydown",async(ev)=>{const isMeta=ev.metaKey||ev.ctrlKey;if(ev.key==="p"&&isMeta){if(!model()){return;}
ev.preventDefault();ev.stopImmediatePropagation();await preparePrint();}},{capture:true});useExternalListener(window,"afterprint",afterPrint)
useEffect(()=>{if(printState.active){window.print();}},()=>[printState.active]);function getPrintRect(){const sheetId=model().getters.getActiveSheetId();const{bottom,right}=model().getters.getSheetZone(sheetId);const{end:width}=model().getters.getColDimensions(sheetId,right);const{end:height}=model().getters.getRowDimensions(sheetId,bottom);return{x:0,y:0,width,height};}
async function preparePrint(){if(!model()){return;}
await loadBundle("spreadsheet.assets_print");const{width,height}=model().getters.getSheetViewDimension();const{width:widthAndHeader,height:heightAndHeader}=model().getters.getSheetViewDimension();const viewRect={x:widthAndHeader-width,y:heightAndHeader-height,width,height,};frozenPrintState={viewRect,offset:model().getters.getActiveSheetDOMScrollInfo(),mode:model().config.mode,};model().updateMode("dashboard");model().dispatch("SET_VIEWPORT_OFFSET",{offsetX:0,offsetY:0});model().dispatch("RESIZE_SHEETVIEW",{...getPrintRect(),});printState.active=true;}
function afterPrint(){if(!model()){return;}
if(frozenPrintState){model().dispatch("RESIZE_SHEETVIEW",frozenPrintState.viewRect);const{scrollX:offsetX,scrollY:offsetY}=frozenPrintState.offset;model().dispatch("SET_VIEWPORT_OFFSET",{offsetX,offsetY});model().updateMode(frozenPrintState.mode);frozenPrintState=undefined;}
printState.active=false;}
return preparePrint;}
return __exports;});;

/* /spreadsheet/static/src/index.js */
odoo.define('@spreadsheet',['@odoo/o-spreadsheet','@spreadsheet/global_filters','@spreadsheet/pivot','@spreadsheet/list','@spreadsheet/chart'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{corePluginRegistry,coreViewsPluginRegistry}=spreadsheet.registries;const{GlobalFiltersCorePlugin,GlobalFiltersUIPlugin}=require("@spreadsheet/global_filters");const{PivotCorePlugin,PivotUIPlugin}=require("@spreadsheet/pivot");const{ListCorePlugin,ListUIPlugin}=require("@spreadsheet/list");const{ChartOdooMenuPlugin,OdooChartCorePlugin,OdooChartUIPlugin,}=require("@spreadsheet/chart");corePluginRegistry.add("OdooGlobalFiltersCorePlugin",GlobalFiltersCorePlugin);corePluginRegistry.add("OdooPivotCorePlugin",PivotCorePlugin);corePluginRegistry.add("OdooListCorePlugin",ListCorePlugin);corePluginRegistry.add("odooChartCorePlugin",OdooChartCorePlugin);corePluginRegistry.add("chartOdooMenuPlugin",ChartOdooMenuPlugin);coreViewsPluginRegistry.add("OdooGlobalFiltersUIPlugin",GlobalFiltersUIPlugin);coreViewsPluginRegistry.add("OdooPivotUIPlugin",PivotUIPlugin);coreViewsPluginRegistry.add("OdooListUIPlugin",ListUIPlugin);coreViewsPluginRegistry.add("odooChartUIPlugin",OdooChartUIPlugin);return __exports;});;

/* /spreadsheet/static/src/ir_ui_menu/index.js */
odoo.define('@spreadsheet/ir_ui_menu',['@web/core/registry','@odoo/o-spreadsheet','@spreadsheet/ir_ui_menu/ir_ui_menu_plugin','@spreadsheet/ir_ui_menu/odoo_menu_link_cell','@web/core/l10n/translation','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const spreadsheet=require("@odoo/o-spreadsheet");const{IrMenuPlugin}=require("@spreadsheet/ir_ui_menu/ir_ui_menu_plugin");const{isMarkdownIrMenuIdUrl,isIrMenuXmlUrl,isMarkdownViewUrl,parseIrMenuXmlUrl,parseViewLink,parseIrMenuIdLink,}=require("@spreadsheet/ir_ui_menu/odoo_menu_link_cell");const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const{urlRegistry,corePluginRegistry}=spreadsheet.registries;const{EvaluationError}=spreadsheet;corePluginRegistry.add("ir_ui_menu_plugin",IrMenuPlugin);class BadOdooLinkError extends EvaluationError{constructor(menuId){super(_t("#LINK"),sprintf(_t("Menu %s not found. You may not have the required access rights."),menuId));}}
const spreadsheetLinkMenuCellService=__exports.spreadsheetLinkMenuCellService={dependencies:["menu"],start(env){function _getIrMenuByXmlId(xmlId){const menu=env.services.menu.getAll().find((menu)=>menu.xmlid===xmlId);if(!menu){throw new BadOdooLinkError(xmlId);}
return menu;}
urlRegistry.add("OdooMenuIdLink",{sequence:65,match:isMarkdownIrMenuIdUrl,createLink(url,label){const menuId=parseIrMenuIdLink(url);const menu=env.services.menu.getMenu(menuId);if(!menu){throw new BadOdooLinkError(menuId);}
return{url,label:_t(label),isExternal:false,isUrlEditable:false,};},urlRepresentation(url){const menuId=parseIrMenuIdLink(url);return env.services.menu.getMenu(menuId).name;},open(url){const menuId=parseIrMenuIdLink(url);const menu=env.services.menu.getMenu(menuId);env.services.action.doAction(menu.actionID);},}).add("OdooMenuXmlLink",{sequence:66,match:isIrMenuXmlUrl,createLink(url,label){const xmlId=parseIrMenuXmlUrl(url);_getIrMenuByXmlId(xmlId);return{url,label:_t(label),isExternal:false,isUrlEditable:false,};},urlRepresentation(url){const xmlId=parseIrMenuXmlUrl(url);const menuId=_getIrMenuByXmlId(xmlId).id;return env.services.menu.getMenu(menuId).name;},open(url){const xmlId=parseIrMenuXmlUrl(url);const menuId=_getIrMenuByXmlId(xmlId).id;const menu=env.services.menu.getMenu(menuId);env.services.action.doAction(menu.actionID);},}).add("OdooViewLink",{sequence:67,match:isMarkdownViewUrl,createLink(url,label){return{url,label:_t(label),isExternal:false,isUrlEditable:false,};},urlRepresentation(url){const actionDescription=parseViewLink(url);return actionDescription.name;},open(url){const{viewType,action,name}=parseViewLink(url);env.services.action.doAction({type:"ir.actions.act_window",name:name,res_model:action.modelName,views:action.views,target:"current",domain:action.domain,context:action.context,},{viewType});},});return true;},};registry.category("services").add("spreadsheetLinkMenuCell",spreadsheetLinkMenuCellService);return __exports;});;

/* /spreadsheet/static/src/ir_ui_menu/ir_ui_menu_plugin.js */
odoo.define('@spreadsheet/ir_ui_menu/ir_ui_menu_plugin',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{CorePlugin}=spreadsheet;const IrMenuPlugin=__exports.IrMenuPlugin=class IrMenuPlugin extends CorePlugin{constructor(config){super(config);this.env=config.custom.env;}
getIrMenu(menuId){let menu=this.env.services.menu.getMenu(menuId);if(!menu){menu=this.env.services.menu.getAll().find((menu)=>menu.xmlid===menuId);}
return menu;}}
IrMenuPlugin.getters=["getIrMenu"];return __exports;});;

/* /spreadsheet/static/src/ir_ui_menu/odoo_menu_link_cell.js */
odoo.define('@spreadsheet/ir_ui_menu/odoo_menu_link_cell',[],function(require){'use strict';let __exports={};const VIEW_PREFIX="odoo://view/";const IR_MENU_ID_PREFIX="odoo://ir_menu_id/";const IR_MENU_XML_ID_PREFIX="odoo://ir_menu_xml_id/";__exports.isMarkdownViewUrl=isMarkdownViewUrl;function isMarkdownViewUrl(url){return url.startsWith(VIEW_PREFIX);}
__exports.parseViewLink=parseViewLink;function parseViewLink(viewLink){if(viewLink.startsWith(VIEW_PREFIX)){return JSON.parse(viewLink.substr(VIEW_PREFIX.length));}
throw new Error(`${viewLink} is not a valid view link`);}
__exports.buildViewLink=buildViewLink;function buildViewLink(viewDescription){return`${VIEW_PREFIX}${JSON.stringify(viewDescription)}`;}
__exports.isMarkdownIrMenuIdUrl=isMarkdownIrMenuIdUrl;function isMarkdownIrMenuIdUrl(url){return url.startsWith(IR_MENU_ID_PREFIX);}
__exports.parseIrMenuIdLink=parseIrMenuIdLink;function parseIrMenuIdLink(irMenuLink){if(irMenuLink.startsWith(IR_MENU_ID_PREFIX)){return parseInt(irMenuLink.substr(IR_MENU_ID_PREFIX.length),10);}
throw new Error(`${irMenuLink} is not a valid menu id link`);}
__exports.buildIrMenuIdLink=buildIrMenuIdLink;function buildIrMenuIdLink(menuId){return`${IR_MENU_ID_PREFIX}${menuId}`;}
__exports.isIrMenuXmlUrl=isIrMenuXmlUrl;function isIrMenuXmlUrl(url){return url.startsWith(IR_MENU_XML_ID_PREFIX);}
__exports.parseIrMenuXmlUrl=parseIrMenuXmlUrl;function parseIrMenuXmlUrl(irMenuUrl){if(irMenuUrl.startsWith(IR_MENU_XML_ID_PREFIX)){return irMenuUrl.substr(IR_MENU_XML_ID_PREFIX.length);}
throw new Error(`${irMenuUrl} is not a valid menu xml link`);}
__exports.buildIrMenuXmlLink=buildIrMenuXmlLink;function buildIrMenuXmlLink(menuXmlId){return`${IR_MENU_XML_ID_PREFIX}${menuXmlId}`;}
return __exports;});;

/* /spreadsheet/static/src/list/index.js */
odoo.define('@spreadsheet/list',['@web/core/l10n/translation','@odoo/o-spreadsheet','@spreadsheet/list/list_functions','@spreadsheet/list/plugins/list_core_plugin','@spreadsheet/list/plugins/list_ui_plugin','@spreadsheet/list/list_actions'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const spreadsheet=require("@odoo/o-spreadsheet");require("@spreadsheet/list/list_functions");const{ListCorePlugin}=require("@spreadsheet/list/plugins/list_core_plugin");const{ListUIPlugin}=require("@spreadsheet/list/plugins/list_ui_plugin");const{SEE_RECORD_LIST,SEE_RECORD_LIST_VISIBLE}=require("@spreadsheet/list/list_actions");const{inverseCommandRegistry}=spreadsheet.registries;function identity(cmd){return[cmd];}
const{coreTypes,invalidateEvaluationCommands,invalidateCFEvaluationCommands,invalidateDependenciesCommands,}=spreadsheet;const{cellMenuRegistry}=spreadsheet.registries;coreTypes.add("INSERT_ODOO_LIST");coreTypes.add("RENAME_ODOO_LIST");coreTypes.add("REMOVE_ODOO_LIST");coreTypes.add("RE_INSERT_ODOO_LIST");coreTypes.add("UPDATE_ODOO_LIST_DOMAIN");coreTypes.add("ADD_LIST_DOMAIN");invalidateEvaluationCommands.add("UPDATE_ODOO_LIST_DOMAIN");invalidateEvaluationCommands.add("INSERT_ODOO_LIST");invalidateEvaluationCommands.add("REMOVE_ODOO_LIST");invalidateDependenciesCommands.add("UPDATE_ODOO_LIST_DOMAIN");invalidateDependenciesCommands.add("INSERT_ODOO_LIST");invalidateDependenciesCommands.add("REMOVE_ODOO_LIST");invalidateCFEvaluationCommands.add("UPDATE_ODOO_LIST_DOMAIN");invalidateCFEvaluationCommands.add("INSERT_ODOO_LIST");invalidateCFEvaluationCommands.add("REMOVE_ODOO_LIST");cellMenuRegistry.add("list_see_record",{name:_t("See record"),sequence:200,execute:async(env)=>{const position=env.model.getters.getActivePosition();await SEE_RECORD_LIST(position,env);},isVisible:(env)=>{const position=env.model.getters.getActivePosition();return SEE_RECORD_LIST_VISIBLE(position,env);},icon:"o-spreadsheet-Icon.SEE_RECORDS",});inverseCommandRegistry.add("INSERT_ODOO_LIST",identity).add("UPDATE_ODOO_LIST_DOMAIN",identity).add("RE_INSERT_ODOO_LIST",identity).add("RENAME_ODOO_LIST",identity).add("REMOVE_ODOO_LIST",identity);Object.assign(__exports,{ListCorePlugin,ListUIPlugin});return __exports;});;

/* /spreadsheet/static/src/list/list_actions.js */
odoo.define('@spreadsheet/list/list_actions',['@odoo/o-spreadsheet','@spreadsheet/list/list_helpers'],function(require){'use strict';let __exports={};const{astToFormula}=require("@odoo/o-spreadsheet");const{getFirstListFunction,getNumberOfListFormulas}=require("@spreadsheet/list/list_helpers");const SEE_RECORD_LIST=__exports.SEE_RECORD_LIST=async(position,env)=>{const cell=env.model.getters.getCell(position);const sheetId=position.sheetId;if(!cell){return;}
const{args}=getFirstListFunction(cell.compiledFormula.tokens);const evaluatedArgs=args.map(astToFormula).map((arg)=>env.model.getters.evaluateFormula(sheetId,arg));const listId=env.model.getters.getListIdFromPosition(position);const{model}=env.model.getters.getListDefinition(listId);const dataSource=await env.model.getters.getAsyncListDataSource(listId);const recordId=dataSource.getIdFromPosition(evaluatedArgs[1]-1);if(!recordId){return;}
await env.services.action.doAction({type:"ir.actions.act_window",res_model:model,res_id:recordId,views:[[false,"form"]],view_mode:"form",});};const SEE_RECORD_LIST_VISIBLE=__exports.SEE_RECORD_LIST_VISIBLE=(position,env)=>{const evaluatedCell=env.model.getters.getEvaluatedCell(position);const cell=env.model.getters.getCell(position);return(evaluatedCell.type!=="empty"&&evaluatedCell.type!=="error"&&cell&&cell.isFormula&&getNumberOfListFormulas(cell.compiledFormula.tokens)===1&&getFirstListFunction(cell.compiledFormula.tokens).functionName==="ODOO.LIST");};return __exports;});;

/* /spreadsheet/static/src/list/list_data_source.js */
odoo.define('@spreadsheet/list/list_data_source',['@spreadsheet/data_sources/odoo_views_data_source','@spreadsheet/o_spreadsheet/errors','@web/core/l10n/translation','@web/core/utils/strings','@web/core/l10n/dates','@web/search/utils/order_by','@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{OdooViewsDataSource}=require("@spreadsheet/data_sources/odoo_views_data_source");const{LoadingDataError}=require("@spreadsheet/o_spreadsheet/errors");const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const{formatDateTime,deserializeDateTime,formatDate,deserializeDate,}=require("@web/core/l10n/dates");const{orderByToString}=require("@web/search/utils/order_by");const spreadsheet=require("@odoo/o-spreadsheet");const{toNumber}=spreadsheet.helpers;const{DEFAULT_LOCALE}=spreadsheet.constants;const ListDataSource=__exports.ListDataSource=class ListDataSource extends OdooViewsDataSource{constructor(services,params){super(services,params);this.maxPosition=params.limit;this.maxPositionFetched=0;this.data=[];}
increaseMaxPosition(position){this.maxPosition=Math.max(this.maxPosition,position);}
async _load(){await super._load();if(this.maxPosition===0){this.data=[];return;}
const{domain,orderBy,context}=this._searchParams;const{records}=await this._orm.webSearchRead(this._metaData.resModel,domain,{specification:this._getReadSpec(),order:orderByToString(orderBy),limit:this.maxPosition,context,});this.data=records;this.maxPositionFetched=this.maxPosition;}
_getReadSpec(){const spec={};const fields=this._metaData.columns.map((f)=>this.getField(f)).filter(Boolean);for(const field of fields){switch(field.type){case"monetary":spec[field.name]={};spec[field.currency_field]={fields:{...spec[field.currency_field]?.fields,name:{},symbol:{},decimal_places:{},position:{},},};break;case"many2one":case"many2many":case"one2many":spec[field.name]={fields:{display_name:{},...spec[field.name]?.fields,},};break;default:spec[field.name]=field;break;}}
return spec;}
getIdFromPosition(position){this._assertDataIsLoaded();const record=this.data[position];return record?record.id:undefined;}
getListHeaderValue(fieldName){this._assertDataIsLoaded();const field=this.getField(fieldName);return field?field.string:fieldName;}
getListCellValue(position,fieldName){this._assertDataIsLoaded();if(position>=this.maxPositionFetched){this.increaseMaxPosition(position+1);this._triggerFetching();throw new LoadingDataError();}
const record=this.data[position];if(!record){return"";}
const field=this.getField(fieldName);if(!field){throw new Error(sprintf(_t("The field %s does not exist or you do not have access to that field"),fieldName));}
if(!(fieldName in record)){this._metaData.columns.push(fieldName);this._metaData.columns=[...new Set(this._metaData.columns)];this._triggerFetching();throw new LoadingDataError();}
switch(field.type){case"many2one":return record[fieldName].display_name??"";case"one2many":case"many2many":{const labels=record[fieldName].map(({display_name})=>display_name).filter((displayName)=>displayName!==undefined);return labels.join(", ");}
case"selection":{const key=record[fieldName];const value=field.selection.find((array)=>array[0]===key);return value?value[1]:"";}
case"boolean":return record[fieldName]?"TRUE":"FALSE";case"date":return record[fieldName]?toNumber(this._formatDate(record[fieldName]),DEFAULT_LOCALE):"";case"datetime":return record[fieldName]?toNumber(this._formatDateTime(record[fieldName]),DEFAULT_LOCALE):"";case"properties":{const properties=record[fieldName]||[];return properties.map((property)=>property.string).join(", ");}
case"json":throw new Error(sprintf(_t('Fields of type "%s" are not supported'),"json"));default:return record[fieldName]||"";}}
getListCurrency(position,currencyFieldName){this._assertDataIsLoaded();const currency=this.data[position]?.[currencyFieldName];if(!currency){return undefined;}
return{code:currency.name,symbol:currency.symbol,decimalPlaces:currency.decimal_places,position:currency.position,};}
_formatDateTime(dateValue){const date=deserializeDateTime(dateValue);return formatDateTime(date.reconfigure({numberingSystem:"latn"}),{format:"yyyy-MM-dd HH:mm:ss",});}
_formatDate(dateValue){const date=deserializeDate(dateValue);return formatDate(date.reconfigure({numberingSystem:"latn"}),{format:"yyyy-MM-dd",});}
_triggerFetching(){if(this._fetchingPromise){return;}
this._fetchingPromise=Promise.resolve().then(()=>{new Promise((resolve)=>{this.load({reload:true});this._fetchingPromise=undefined;resolve();});});}}
return __exports;});;

/* /spreadsheet/static/src/list/list_functions.js */
odoo.define('@spreadsheet/list/list_functions',['@web/core/l10n/translation','@odoo/o-spreadsheet','@web/core/utils/strings'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const spreadsheet=require("@odoo/o-spreadsheet");const{sprintf}=require("@web/core/utils/strings");const{arg,toString,toNumber}=spreadsheet.helpers;const{functionRegistry}=spreadsheet.registries;function assertListsExists(listId,getters){if(!getters.isExistingList(listId)){throw new Error(sprintf(_t('There is no list with id "%s"'),listId));}}
const ODOO_LIST={description:_t("Get the value from a list."),args:[arg("list_id (string)",_t("ID of the list.")),arg("index (string)",_t("Position of the record in the list.")),arg("field_name (string)",_t("Name of the field.")),],category:"Odoo",compute:function(listId,index,fieldName){const id=toString(listId);const position=toNumber(index,this.locale)-1;const field=toString(fieldName);assertListsExists(id,this.getters);return this.getters.getListCellValue(id,position,field);},computeFormat:function(listId,index,fieldName){const id=toString(listId.value);const position=toNumber(index.value,this.locale)-1;const field=this.getters.getListDataSource(id).getField(toString(fieldName.value));switch(field.type){case"integer":return"0";case"float":return"#,##0.00";case"monetary":{const currency=this.getters.getListCurrency(id,position,field.currency_field);if(!currency){return"#,##0.00";}
return this.getters.computeFormatFromCurrency(currency);}
case"date":return this.locale.dateFormat;case"datetime":return this.locale.dateFormat+" "+this.locale.timeFormat;default:return undefined;}},returns:["NUMBER","STRING"],};const ODOO_LIST_HEADER={description:_t("Get the header of a list."),args:[arg("list_id (string)",_t("ID of the list.")),arg("field_name (string)",_t("Name of the field.")),],category:"Odoo",compute:function(listId,fieldName){const id=toString(listId);const field=toString(fieldName);assertListsExists(id,this.getters);return this.getters.getListHeaderValue(id,field);},returns:["NUMBER","STRING"],};functionRegistry.add("ODOO.LIST",ODOO_LIST);functionRegistry.add("ODOO.LIST.HEADER",ODOO_LIST_HEADER);return __exports;});;

/* /spreadsheet/static/src/list/list_helpers.js */
odoo.define('@spreadsheet/list/list_helpers',['@spreadsheet/helpers/odoo_functions_helpers'],function(require){'use strict';let __exports={};const{getOdooFunctions}=require("@spreadsheet/helpers/odoo_functions_helpers");__exports.getNumberOfListFormulas=getNumberOfListFormulas;function getNumberOfListFormulas(tokens){return getOdooFunctions(tokens,["ODOO.LIST","ODOO.LIST.HEADER"]).length;}
__exports.getFirstListFunction=getFirstListFunction;function getFirstListFunction(tokens){return getOdooFunctions(tokens,["ODOO.LIST","ODOO.LIST.HEADER"])[0];}
return __exports;});;

/* /spreadsheet/static/src/list/plugins/list_core_plugin.js */
odoo.define('@spreadsheet/list/plugins/list_core_plugin',['@odoo/o-spreadsheet','@spreadsheet/o_spreadsheet/cancelled_reason','@spreadsheet/helpers/helpers','@spreadsheet/helpers/constants','@web/core/l10n/translation','@spreadsheet/global_filters/plugins/global_filters_core_plugin','@web/core/utils/strings','@spreadsheet/global_filters/helpers','@web/core/domain'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{CommandResult}=require("@spreadsheet/o_spreadsheet/cancelled_reason");const{getMaxObjectId}=require("@spreadsheet/helpers/helpers");const{TOP_LEVEL_STYLE}=require("@spreadsheet/helpers/constants");const{_t}=require("@web/core/l10n/translation");const{globalFiltersFieldMatchers}=require("@spreadsheet/global_filters/plugins/global_filters_core_plugin");const{sprintf}=require("@web/core/utils/strings");const{checkFilterFieldMatching}=require("@spreadsheet/global_filters/helpers");const{Domain}=require("@web/core/domain");const{CorePlugin}=spreadsheet;const ListCorePlugin=__exports.ListCorePlugin=class ListCorePlugin extends CorePlugin{constructor(config){super(config);this.nextId=1;this.lists={};globalFiltersFieldMatchers["list"]={getIds:()=>this.getters.getListIds(),getDisplayName:(listId)=>this.getters.getListName(listId),getTag:(listId)=>sprintf(_t("List #%s"),listId),getFieldMatching:(listId,filterId)=>this.getListFieldMatching(listId,filterId),getModel:(listId)=>this.getListDefinition(listId).model,};}
allowDispatch(cmd){switch(cmd.type){case"INSERT_ODOO_LIST":if(cmd.id!==this.nextId.toString()){return CommandResult.InvalidNextId;}
if(this.lists[cmd.id]){return CommandResult.ListIdDuplicated;}
break;case"RENAME_ODOO_LIST":if(!(cmd.listId in this.lists)){return CommandResult.ListIdNotFound;}
if(cmd.name===""){return CommandResult.EmptyName;}
break;case"UPDATE_ODOO_LIST_DOMAIN":if(!(cmd.listId in this.lists)){return CommandResult.ListIdNotFound;}
break;case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":if(cmd.list){return checkFilterFieldMatching(cmd.list);}}
return CommandResult.Success;}
handle(cmd){switch(cmd.type){case"INSERT_ODOO_LIST":{const{sheetId,col,row,id,definition,linesNumber,columns}=cmd;const anchor=[col,row];this._addList(id,definition);this._insertList(sheetId,anchor,id,linesNumber,columns);this.history.update("nextId",parseInt(id,10)+1);break;}
case"RE_INSERT_ODOO_LIST":{const{sheetId,col,row,id,linesNumber,columns}=cmd;const anchor=[col,row];this._insertList(sheetId,anchor,id,linesNumber,columns);break;}
case"RENAME_ODOO_LIST":{this.history.update("lists",cmd.listId,"definition","name",cmd.name);break;}
case"REMOVE_ODOO_LIST":{const lists={...this.lists};delete lists[cmd.listId];this.history.update("lists",lists);break;}
case"UPDATE_ODOO_LIST_DOMAIN":{this.history.update("lists",cmd.listId,"definition","searchParams","domain",cmd.domain);break;}
case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":if(cmd.list){this._setListFieldMatching(cmd.filter.id,cmd.list);}
break;case"REMOVE_GLOBAL_FILTER":this._onFilterDeletion(cmd.id);break;}}
getListDisplayName(id){return`(#${id}) ${this.getListName(id)}`;}
getListName(id){return _t(this.lists[id].definition.name);}
getListFieldMatch(id){return this.lists[id].fieldMatching;}
getListIds(){return Object.keys(this.lists);}
getNextListId(){return this.nextId.toString();}
getListDefinition(id){const def=this.lists[id].definition;return{columns:[...def.metaData.columns],domain:def.searchParams.domain,model:def.metaData.resModel,context:{...def.searchParams.context},orderBy:[...def.searchParams.orderBy],id,name:def.name,};}
getListModelDefinition(id){return this.lists[id].definition;}
isExistingList(id){return id in this.lists;}
getListFieldMatching(listId,filterId){return this.lists[listId].fieldMatching[filterId];}
_setListFieldMatching(filterId,listFieldMatches){const lists={...this.lists};for(const[listId,fieldMatch]of Object.entries(listFieldMatches)){lists[listId].fieldMatching[filterId]=fieldMatch;}
this.history.update("lists",lists);}
_onFilterDeletion(filterId){const lists={...this.lists};for(const listId in lists){this.history.update("lists",listId,"fieldMatching",filterId,undefined);}}
_addList(id,definition,fieldMatching=undefined){const lists={...this.lists};if(!fieldMatching){const model=definition.metaData.resModel;fieldMatching=this.getters.getFieldMatchingForModel(model);}
lists[id]={id,definition,fieldMatching,};this.history.update("lists",lists);}
_insertList(sheetId,anchor,id,linesNumber,columns){this._resizeSheet(sheetId,anchor,columns.length,linesNumber+1);this._insertHeaders(sheetId,anchor,id,columns);this._insertValues(sheetId,anchor,id,columns,linesNumber);}
_insertHeaders(sheetId,anchor,id,columns){let[col,row]=anchor;for(const column of columns){this.dispatch("UPDATE_CELL",{sheetId,col,row,content:`=ODOO.LIST.HEADER(${id},"${column.name}")`,});col++;}
this.dispatch("SET_FORMATTING",{sheetId,style:TOP_LEVEL_STYLE,target:[{top:anchor[1],bottom:anchor[1],left:anchor[0],right:anchor[0]+columns.length-1,},],});this.dispatch("SET_ZONE_BORDERS",{sheetId,target:[{top:anchor[1],bottom:anchor[1],left:anchor[0],right:anchor[0]+columns.length-1,},],border:{position:"external",color:"#2D7E84",},});}
_insertValues(sheetId,anchor,id,columns,linesNumber){let col=anchor[0];let row=anchor[1]+1;for(let i=1;i<=linesNumber;i++){col=anchor[0];for(const column of columns){this.dispatch("UPDATE_CELL",{sheetId,col,row,content:`=ODOO.LIST(${id},${i},"${column.name}")`,});col++;}
row++;}
this.dispatch("SET_ZONE_BORDERS",{sheetId,target:[{top:anchor[1],bottom:anchor[1]+linesNumber,left:anchor[0],right:anchor[0]+columns.length-1,},],border:{position:"external",color:"#2D7E84",},});}
_resizeSheet(sheetId,anchor,columns,rows){const numberCols=this.getters.getNumberCols(sheetId);const deltaCol=numberCols-anchor[0];if(deltaCol<columns){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:numberCols-1,sheetId:sheetId,quantity:columns-deltaCol,position:"after",});}
const numberRows=this.getters.getNumberRows(sheetId);const deltaRow=numberRows-anchor[1];if(deltaRow<rows){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"ROW",base:numberRows-1,sheetId:sheetId,quantity:rows-deltaRow,position:"after",});}}
import(data){if(data.lists){for(const[id,list]of Object.entries(data.lists)){const definition={metaData:{resModel:list.model,columns:list.columns,},searchParams:{domain:list.domain,context:list.context,orderBy:list.orderBy,},name:list.name,};this._addList(id,definition,list.fieldMatching);}}
this.nextId=data.listNextId||getMaxObjectId(this.lists)+1;}
export(data){data.lists={};for(const id in this.lists){data.lists[id]=JSON.parse(JSON.stringify(this.getListDefinition(id)));data.lists[id].domain=new Domain(data.lists[id].domain).toJson();data.lists[id].fieldMatching=this.lists[id].fieldMatching;}
data.listNextId=this.nextId;}}
ListCorePlugin.getters=["getListDisplayName","getListDefinition","getListModelDefinition","getListIds","getListName","getNextListId","isExistingList","getListFieldMatch","getListFieldMatching",];return __exports;});;

/* /spreadsheet/static/src/list/plugins/list_ui_plugin.js */
odoo.define('@spreadsheet/list/plugins/list_ui_plugin',['@odoo/o-spreadsheet','@spreadsheet/list/list_helpers','@web/core/domain','@spreadsheet/list/list_data_source','@spreadsheet/global_filters/plugins/global_filters_core_plugin'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{getFirstListFunction,getNumberOfListFormulas}=require("@spreadsheet/list/list_helpers");const{Domain}=require("@web/core/domain");const{ListDataSource}=require("@spreadsheet/list/list_data_source");const{globalFiltersFieldMatchers}=require("@spreadsheet/global_filters/plugins/global_filters_core_plugin");const{astToFormula}=spreadsheet;const ListUIPlugin=__exports.ListUIPlugin=class ListUIPlugin extends spreadsheet.UIPlugin{constructor(config){super(config);this.selectedListId=undefined;this.env=config.custom.env;this.dataSources=config.custom.dataSources;globalFiltersFieldMatchers["list"]={...globalFiltersFieldMatchers["list"],getFields:(listId)=>this.getListDataSource(listId).getFields(),waitForReady:()=>this.getListsWaitForReady(),};}
beforeHandle(cmd){switch(cmd.type){case"START":for(const listId of this.getters.getListIds()){this._setupListDataSource(listId,0);}
this._addDomains();break;}}
handle(cmd){switch(cmd.type){case"START":for(const sheetId of this.getters.getSheetIds()){const cells=this.getters.getCells(sheetId);for(const cell of Object.values(cells)){if(cell.isFormula){this._addListPositionToDataSource(cell);}}}
break;case"INSERT_ODOO_LIST":{const{id,linesNumber}=cmd;this._setupListDataSource(id,linesNumber);break;}
case"SELECT_ODOO_LIST":this._selectList(cmd.listId);break;case"REMOVE_ODOO_LIST":if(cmd.listId===this.selectedListId){this.selectedListId=undefined;}
break;case"REFRESH_ODOO_LIST":this._refreshOdooList(cmd.listId);break;case"REFRESH_ALL_DATA_SOURCES":this._refreshOdooLists();break;case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":case"REMOVE_GLOBAL_FILTER":case"SET_GLOBAL_FILTER_VALUE":case"CLEAR_GLOBAL_FILTER_VALUE":this._addDomains();break;case"UPDATE_ODOO_LIST_DOMAIN":{const listDefinition=this.getters.getListModelDefinition(cmd.listId);const dataSourceId=this._getListDataSourceId(cmd.listId);this.dataSources.add(dataSourceId,ListDataSource,listDefinition);break;}
case"UPDATE_CELL":if(cmd.content){const position={sheetId:cmd.sheetId,col:cmd.col,row:cmd.row};const cell=this.getters.getCell(position);if(cell&&cell.isFormula){this._addListPositionToDataSource(cell);}}
break;case"UNDO":case"REDO":{if(cmd.commands.find((command)=>["ADD_GLOBAL_FILTER","EDIT_GLOBAL_FILTER","REMOVE_GLOBAL_FILTER",].includes(command.type))){this._addDomains();}
const domainEditionCommands=cmd.commands.filter((cmd)=>cmd.type==="UPDATE_ODOO_LIST_DOMAIN"||cmd.type==="INSERT_ODOO_LIST");for(const cmd of domainEditionCommands){if(!this.getters.isExistingList(cmd.listId)){continue;}
const listDefinition=this.getters.getListModelDefinition(cmd.listId);const dataSourceId=this._getListDataSourceId(cmd.listId);this.dataSources.add(dataSourceId,ListDataSource,listDefinition);}
if(!this.getters.getListIds().length){this.selectedListId=undefined;}
break;}}}
_setupListDataSource(listId,limit,definition){const dataSourceId=this._getListDataSourceId(listId);definition=definition||this.getters.getListModelDefinition(listId);if(!this.dataSources.contains(dataSourceId)){this.dataSources.add(dataSourceId,ListDataSource,{...definition,limit,});}}
_addDomain(listId){const domainList=[];for(const[filterId,fieldMatch]of Object.entries(this.getters.getListFieldMatch(listId))){domainList.push(this.getters.getGlobalFilterDomain(filterId,fieldMatch));}
const domain=Domain.combine(domainList,"AND").toString();this.getters.getListDataSource(listId).addDomain(domain);}
_addDomains(){for(const listId of this.getters.getListIds()){this._addDomain(listId);}}
_refreshOdooList(listId){this.getters.getListDataSource(listId).load({reload:true});}
_refreshOdooLists(){for(const listId of this.getters.getListIds()){this._refreshOdooList(listId);}}
_selectList(listId){this.selectedListId=listId;}
_getListDataSourceId(listId){return`list-${listId}`;}
_addListPositionToDataSource(cell){if(getNumberOfListFormulas(cell.compiledFormula.tokens)!==1){return;}
const{functionName,args}=getFirstListFunction(cell.compiledFormula.tokens);if(functionName!=="ODOO.LIST"){return;}
const[listId,positionArg]=args.map((arg)=>arg.value.toString());if(!this.getters.getListIds().includes(listId)){return;}
const position=parseInt(positionArg,10);if(isNaN(position)){return;}
const dataSourceId=this._getListDataSourceId(listId);if(!this.dataSources.get(dataSourceId)){this._setupListDataSource(listId,0);}
this.dataSources.get(dataSourceId).increaseMaxPosition(position);}
getListComputedDomain(listId){return this.getters.getListDataSource(listId).getComputedDomain();}
getListIdFromPosition(position){const cell=this.getters.getCell(position);const sheetId=position.sheetId;if(cell&&cell.isFormula){const listFunction=getFirstListFunction(cell.compiledFormula.tokens);if(listFunction){const content=astToFormula(listFunction.args[0]);return this.getters.evaluateFormula(sheetId,content).toString();}}
return undefined;}
getListHeaderValue(listId,fieldName){return this.getters.getListDataSource(listId).getListHeaderValue(fieldName);}
getListCellValue(listId,position,fieldName){return this.getters.getListDataSource(listId).getListCellValue(position,fieldName);}
getListCurrency(listId,position,fieldName){return this.getters.getListDataSource(listId).getListCurrency(position,fieldName);}
getSelectedListId(){return this.selectedListId;}
getListDataSource(id){const dataSourceId=this._getListDataSourceId(id);return this.dataSources.get(dataSourceId);}
async getAsyncListDataSource(id){const dataSourceId=this._getListDataSourceId(id);await this.dataSources.load(dataSourceId);return this.getListDataSource(id);}
getListsWaitForReady(){return this.getters.getListIds().map((listId)=>this.getListDataSource(listId).loadMetadata());}}
ListUIPlugin.getters=["getListComputedDomain","getListCurrency","getListHeaderValue","getListIdFromPosition","getListCellValue","getSelectedListId","getListDataSource","getAsyncListDataSource",];return __exports;});;

/* /spreadsheet/static/src/o_spreadsheet/cancelled_reason.js */
odoo.define('@spreadsheet/o_spreadsheet/cancelled_reason',[],function(require){'use strict';let __exports={};const CommandResult=__exports.CommandResult={Success:"Success",FilterNotFound:"FilterNotFound",InvalidFilterMove:"InvalidFilterMove",DuplicatedFilterLabel:"DuplicatedFilterLabel",PivotCacheNotLoaded:"PivotCacheNotLoaded",InvalidValueTypeCombination:"InvalidValueTypeCombination",ListIdDuplicated:"ListIdDuplicated",InvalidNextId:"InvalidNextId",ListIdNotFound:"ListIdNotFound",EmptyName:"EmptyName",PivotIdNotFound:"PivotIdNotFound",InvalidFieldMatch:"InvalidFieldMatch",};return __exports;});;

/* /spreadsheet/static/src/o_spreadsheet/errors.js */
odoo.define('@spreadsheet/o_spreadsheet/errors',['@web/core/l10n/translation','@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const spreadsheet=require("@odoo/o-spreadsheet");const{EvaluationError,CellErrorLevel}=spreadsheet.helpers;const LoadingDataError=__exports.LoadingDataError=class LoadingDataError extends EvaluationError{constructor(){super(_t("Loading..."),_t("Data is loading"),CellErrorLevel.silent);}}
return __exports;});;

/* /spreadsheet/static/src/o_spreadsheet/init_callbacks.js */
odoo.define('@spreadsheet/o_spreadsheet/init_callbacks',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{Registry}=require("@odoo/o-spreadsheet");const initCallbackRegistry=__exports.initCallbackRegistry=new Registry();return __exports;});;

/* /spreadsheet/static/src/o_spreadsheet/migration.js */
odoo.define('@spreadsheet/o_spreadsheet/migration',['@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{load,CorePlugin,tokenize,parse,convertAstNodes,astToFormula}=spreadsheet;const{corePluginRegistry}=spreadsheet.registries;const ODOO_VERSION=__exports.ODOO_VERSION=6;const MAP={PIVOT:"ODOO.PIVOT","PIVOT.HEADER":"ODOO.PIVOT.HEADER","PIVOT.POSITION":"ODOO.PIVOT.POSITION","FILTER.VALUE":"ODOO.FILTER.VALUE",LIST:"ODOO.LIST","LIST.HEADER":"ODOO.LIST.HEADER",};const dmyRegex=/^([0|1|2|3][1-9])\/(0[1-9]|1[0-2])\/(\d{4})$/i;__exports.migrate=migrate;function migrate(data){let _data=load(data,!!odoo.debug);const version=_data.odooVersion||0;if(version<1){_data=migrate0to1(_data);}
if(version<2){_data=migrate1to2(_data);}
if(version<3){_data=migrate2to3(_data);}
if(version<4){_data=migrate3to4(_data);}
if(version<5){_data=migrate4to5(_data);}
if(version<6){_data=migrate5to6(_data);}
return _data;}
function tokensToString(tokens){return tokens.reduce((acc,token)=>acc+token.value,"");}
function migrate0to1(data){for(const sheet of data.sheets){for(const xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.content&&cell.content.startsWith("=")){const tokens=tokenize(cell.content);for(const token of tokens){if(token.type==="SYMBOL"&&token.value.toUpperCase()in MAP){token.value=MAP[token.value.toUpperCase()];}}
cell.content=tokensToString(tokens);}}}
return data;}
function migrate1to2(data){for(const sheet of data.sheets){for(const xc in sheet.cells||[]){const cell=sheet.cells[xc];if(cell.content&&cell.content.startsWith("=")){try{cell.content=migratePivotDaysParameters(cell.content);}catch{continue;}}}}
return data;}
function migrate2to3(data){if(data.globalFilters){for(const gf of data.globalFilters){if(gf.fields){gf.pivotFields=gf.fields;delete gf.fields;}
if(gf.type==="date"&&typeof gf.defaultValue==="object"&&"year"in gf.defaultValue){switch(gf.defaultValue.year){case"last_year":gf.defaultValue.yearOffset=-1;break;case"antepenultimate_year":gf.defaultValue.yearOffset=-2;break;case"this_year":case undefined:gf.defaultValue.yearOffset=0;break;}
delete gf.defaultValue.year;}
if(!gf.listFields){gf.listFields={};}
if(!gf.graphFields){gf.graphFields={};}}}
return data;}
function migrate3to4(data){if(data.lists){for(const list of Object.values(data.lists)){list.name=list.name||list.model;}}
if(data.pivots){for(const pivot of Object.values(data.pivots)){pivot.name=pivot.name||pivot.model;}}
return data;}
function migrate4to5(data){for(const filter of data.globalFilters||[]){for(const[id,fm]of Object.entries(filter.pivotFields||{})){if(!(data.pivots&&id in data.pivots)){delete filter.pivotFields[id];continue;}
if(!data.pivots[id].fieldMatching){data.pivots[id].fieldMatching={};}
data.pivots[id].fieldMatching[filter.id]={chain:fm.field,type:fm.type};if("offset"in fm){data.pivots[id].fieldMatching[filter.id].offset=fm.offset;}}
delete filter.pivotFields;for(const[id,fm]of Object.entries(filter.listFields||{})){if(!(data.lists&&id in data.lists)){delete filter.listFields[id];continue;}
if(!data.lists[id].fieldMatching){data.lists[id].fieldMatching={};}
data.lists[id].fieldMatching[filter.id]={chain:fm.field,type:fm.type};if("offset"in fm){data.lists[id].fieldMatching[filter.id].offset=fm.offset;}}
delete filter.listFields;const findFigureFromId=(id)=>{for(const sheet of data.sheets){const fig=sheet.figures.find((f)=>f.id===id);if(fig){return fig;}}
return undefined;};for(const[id,fm]of Object.entries(filter.graphFields||{})){const figure=findFigureFromId(id);if(!figure){delete filter.graphFields[id];continue;}
if(!figure.data.fieldMatching){figure.data.fieldMatching={};}
figure.data.fieldMatching[filter.id]={chain:fm.field,type:fm.type};if("offset"in fm){figure.data.fieldMatching[filter.id].offset=fm.offset;}}
delete filter.graphFields;}
return data;}
function migratePivotDaysParameters(formulaString){const ast=parse(formulaString);const convertedAst=convertAstNodes(ast,"FUNCALL",(ast)=>{if(["ODOO.PIVOT","ODOO.PIVOT.HEADER"].includes(ast.value.toUpperCase())){for(const subAst of ast.args){if(subAst.type==="STRING"){const date=subAst.value.match(dmyRegex);if(date){subAst.value=`${[date[2], date[1], date[3]].join("/")}`;}}}}
return ast;});return"="+astToFormula(convertedAst);}
function migrate5to6(data){if(!data.globalFilters?.length){return data;}
for(const filter of data.globalFilters){if(filter.type==="date"&&["year","quarter","month"].includes(filter.rangeType)){if(filter.defaultsToCurrentPeriod){filter.defaultValue=`this_${filter.rangeType}`;}
filter.rangeType="fixedPeriod";}
delete filter.defaultsToCurrentPeriod;}
return data;}
const OdooVersion=__exports.OdooVersion=class OdooVersion extends CorePlugin{export(data){data.odooVersion=ODOO_VERSION;}}
OdooVersion.getters=[];corePluginRegistry.add("odooMigration",OdooVersion);return __exports;});;

/* /spreadsheet/static/src/o_spreadsheet/odoo_module.js */
odoo.define("@odoo/o-spreadsheet",["@web/core/l10n/translation"],function(require){"use strict";const{_t,translationLoaded,translatedTerms}=require("@web/core/l10n/translation");const spreadsheet=window.o_spreadsheet;spreadsheet.setTranslationMethod(_t,()=>translatedTerms[translationLoaded]);return spreadsheet;});;

/* /spreadsheet/static/src/o_spreadsheet/translation.js */
odoo.define('@spreadsheet/o_spreadsheet/translation',['@odoo/o-spreadsheet','@web/core/l10n/translation'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{_t}=require("@web/core/l10n/translation");const{arg,toString}=spreadsheet.helpers;const{functionRegistry}=spreadsheet.registries;functionRegistry.add("_t",{description:_t("Get the translated value of the given string"),args:[arg("value (string)",_t("Value to translate."))],compute:function(value){return _t(toString(value));},returns:["STRING"],hidden:true,});return __exports;});;

/* /spreadsheet/static/src/pivot/index.js */
odoo.define('@spreadsheet/pivot',['@web/core/l10n/translation','@odoo/o-spreadsheet','@spreadsheet/pivot/plugins/pivot_core_plugin','@spreadsheet/pivot/plugins/pivot_ui_plugin','@spreadsheet/pivot/pivot_actions'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const spreadsheet=require("@odoo/o-spreadsheet");const{PivotCorePlugin}=require("@spreadsheet/pivot/plugins/pivot_core_plugin");const{PivotUIPlugin}=require("@spreadsheet/pivot/plugins/pivot_ui_plugin");const{SEE_RECORDS_PIVOT,SEE_RECORDS_PIVOT_VISIBLE}=require("@spreadsheet/pivot/pivot_actions");const{coreTypes,invalidateEvaluationCommands,invalidateCFEvaluationCommands,invalidateDependenciesCommands,}=spreadsheet;const{cellMenuRegistry}=spreadsheet.registries;const{inverseCommandRegistry}=spreadsheet.registries;function identity(cmd){return[cmd];}
coreTypes.add("INSERT_PIVOT");coreTypes.add("RENAME_ODOO_PIVOT");coreTypes.add("REMOVE_PIVOT");coreTypes.add("RE_INSERT_PIVOT");coreTypes.add("UPDATE_ODOO_PIVOT_DOMAIN");invalidateEvaluationCommands.add("UPDATE_ODOO_PIVOT_DOMAIN");invalidateEvaluationCommands.add("REMOVE_PIVOT");invalidateEvaluationCommands.add("INSERT_PIVOT");invalidateEvaluationCommands.add("RENAME_ODOO_PIVOT");invalidateDependenciesCommands.add("UPDATE_ODOO_PIVOT_DOMAIN");invalidateDependenciesCommands.add("REMOVE_PIVOT");invalidateDependenciesCommands.add("INSERT_PIVOT");invalidateDependenciesCommands.add("RENAME_ODOO_PIVOT");invalidateCFEvaluationCommands.add("UPDATE_ODOO_PIVOT_DOMAIN");invalidateCFEvaluationCommands.add("REMOVE_PIVOT");invalidateCFEvaluationCommands.add("INSERT_PIVOT");invalidateCFEvaluationCommands.add("RENAME_ODOO_PIVOT");cellMenuRegistry.add("pivot_see_records",{name:_t("See records"),sequence:175,execute:async(env)=>{const position=env.model.getters.getActivePosition();await SEE_RECORDS_PIVOT(position,env);},isVisible:(env)=>{const position=env.model.getters.getActivePosition();return SEE_RECORDS_PIVOT_VISIBLE(position,env);},icon:"o-spreadsheet-Icon.SEE_RECORDS",});inverseCommandRegistry.add("INSERT_PIVOT",identity).add("RENAME_ODOO_PIVOT",identity).add("REMOVE_PIVOT",identity).add("UPDATE_ODOO_PIVOT_DOMAIN",identity).add("RE_INSERT_PIVOT",identity);Object.assign(__exports,{PivotCorePlugin,PivotUIPlugin});return __exports;});;

/* /spreadsheet/static/src/pivot/pivot_actions.js */
odoo.define('@spreadsheet/pivot/pivot_actions',['@spreadsheet/pivot/pivot_helpers'],function(require){'use strict';let __exports={};const{getNumberOfPivotFormulas}=require("@spreadsheet/pivot/pivot_helpers");const SEE_RECORDS_PIVOT=__exports.SEE_RECORDS_PIVOT=async(position,env)=>{const pivotId=env.model.getters.getPivotIdFromPosition(position);const{model}=env.model.getters.getPivotDefinition(pivotId);const dataSource=await env.model.getters.getAsyncPivotDataSource(pivotId);const argsDomain=env.model.getters.getPivotDomainArgsFromPosition(position)?.domainArgs;const domain=dataSource.getPivotCellDomain(argsDomain);const name=await dataSource.getModelLabel();await env.services.action.doAction({type:"ir.actions.act_window",name,res_model:model,view_mode:"list",views:[[false,"list"],[false,"form"],],target:"current",domain,});};const SEE_RECORDS_PIVOT_VISIBLE=__exports.SEE_RECORDS_PIVOT_VISIBLE=(position,env)=>{const cell=env.model.getters.getCorrespondingFormulaCell(position);const evaluatedCell=env.model.getters.getEvaluatedCell(position);const argsDomain=env.model.getters.getPivotDomainArgsFromPosition(position)?.domainArgs;const pivotId=env.model.getters.getPivotIdFromPosition(position);if(!env.model.getters.isExistingPivot(pivotId)){return false;}
const dataSource=env.model.getters.getPivotDataSource(pivotId);return(dataSource.isReady()&&evaluatedCell.type!=="empty"&&evaluatedCell.type!=="error"&&argsDomain!==undefined&&cell&&cell.isFormula&&getNumberOfPivotFormulas(cell.compiledFormula.tokens)===1);};__exports.SET_FILTER_MATCHING_CONDITION=SET_FILTER_MATCHING_CONDITION;function SET_FILTER_MATCHING_CONDITION(position,env){if(!SEE_RECORDS_PIVOT_VISIBLE(position,env)){return false;}
const pivotId=env.model.getters.getPivotIdFromPosition(position);const pivotInfo=env.model.getters.getPivotDomainArgsFromPosition(position);if(pivotInfo?.domainArgs===undefined){return false;}
const matchingFilters=env.model.getters.getFiltersMatchingPivotArgs(pivotId,pivotInfo?.domainArgs);return pivotInfo?.isHeader&&matchingFilters.length>0;}
__exports.SET_FILTER_MATCHING=SET_FILTER_MATCHING;function SET_FILTER_MATCHING(position,env){const pivotId=env.model.getters.getPivotIdFromPosition(position);const domainArgs=env.model.getters.getPivotDomainArgsFromPosition(position)?.domainArgs;const filters=env.model.getters.getFiltersMatchingPivotArgs(pivotId,domainArgs);env.model.dispatch("SET_MANY_GLOBAL_FILTER_VALUE",{filters});}
return __exports;});;

/* /spreadsheet/static/src/pivot/pivot_data_source.js */
odoo.define('@spreadsheet/pivot/pivot_data_source',['@web/core/l10n/translation','@spreadsheet/data_sources/odoo_views_data_source','@spreadsheet/pivot/pivot_model','@web/core/domain'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{OdooViewsDataSource}=require("@spreadsheet/data_sources/odoo_views_data_source");const{SpreadsheetPivotModel}=require("@spreadsheet/pivot/pivot_model");const{Domain}=require("@web/core/domain");const PivotDataSource=__exports.PivotDataSource=class PivotDataSource extends OdooViewsDataSource{constructor(services,params){super(services,params);}
async _load(){await super._load();this._model=new SpreadsheetPivotModel({_t},{metaData:this._metaData,searchParams:this._searchParams,},{orm:this._orm,metadataRepository:this._metadataRepository,});await this._model.load(this._searchParams);}
async copyModelWithOriginalDomain(){await this.loadMetadata();const model=new SpreadsheetPivotModel({_t},{metaData:this._metaData,searchParams:this._initialSearchParams,},{orm:this._orm,metadataRepository:this._metadataRepository,});const userContext=this._orm.user.context;const domain=new Domain(this._initialSearchParams.domain).toList({...this._initialSearchParams.context,...userContext,});const searchParams={...this._initialSearchParams,domain};await model.load(searchParams);return model;}
computeOdooPivotHeaderValue(domainArgs){this._assertDataIsLoaded();if(domainArgs.length===0){return _t("Total");}
if(domainArgs.at(-2)==="measure"){return this.getMeasureDisplayName(domainArgs.at(-1));}
return this._model.getGroupByCellValue(domainArgs.at(-2),this._model.getLastPivotGroupValue(domainArgs));}
getMeasureDisplayName(measure){if(measure==="__count"){return _t("Count");}
const field=this.getField(measure);if(field===undefined){throw new Error(_t("Field %s does not exist",measure));}
return field.string;}
getLastPivotGroupValue(domainArgs){this._assertDataIsLoaded();return this._model.getLastPivotGroupValue(domainArgs);}
markAsValueUsed(measure,domain){if(this._model){this._model.markAsValueUsed(measure,domain);}}
markAsHeaderUsed(domain){if(this._model){this._model.markAsHeaderUsed(domain);}}
isUsedValue(measure,domain){this._assertDataIsLoaded();return this._model.isUsedValue(measure,domain);}
isUsedHeader(domain){this._assertDataIsLoaded();return this._model.isUsedHeader(domain);}
clearUsedValues(){if(this._model){this._model.clearUsedValues();}}
getTableStructure(){this._assertDataIsLoaded();return this._model.getTableStructure();}
getPivotCellValue(measure,domain){this._assertDataIsLoaded();return this._model.getPivotCellValue(measure,domain);}
getPivotCellDomain(domain){this._assertDataIsLoaded();return this._model.getPivotCellDomain(domain);}
getFormattedGroupBy(fieldName){this._assertDataIsLoaded();return this._model.getFormattedGroupBy(fieldName);}
parseGroupField(groupFieldString){this._assertDataIsLoaded();return this._model.parseGroupField(groupFieldString);}
isGroupedOnlyByOneDate(dimension){this._assertDataIsLoaded();return this._model.isGroupedOnlyByOneDate(dimension);}
getGroupOfFirstDate(dimension){this._assertDataIsLoaded();return this._model.getGroupOfFirstDate(dimension);}
getGroupByAtIndex(dimension,index){this._assertDataIsLoaded();return this._model.getGroupByAtIndex(dimension,index);}
isColumnGroupBy(fieldName){this._assertDataIsLoaded();return this._model.isColumnGroupBy(fieldName);}
isRowGroupBy(fieldName){this._assertDataIsLoaded();return this._model.isRowGroupBy(fieldName);}
getNumberOfColGroupBys(){this._assertDataIsLoaded();return this._model.getNumberOfColGroupBys();}
async prepareForTemplateGeneration(){this._assertDataIsLoaded();await this._model.prepareForTemplateGeneration();}}
return __exports;});;

/* /spreadsheet/static/src/pivot/pivot_functions.js */
odoo.define('@spreadsheet/pivot/pivot_functions',['@web/core/l10n/translation','@web/core/utils/strings','@odoo/o-spreadsheet','@web/core/utils/numbers'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const spreadsheet=require("@odoo/o-spreadsheet");const{range}=require("@web/core/utils/numbers");const{arg,toBoolean,toString,toNumber}=spreadsheet.helpers;const{functionRegistry}=spreadsheet.registries;function assertPivotsExists(pivotId,getters){if(!getters.isExistingPivot(pivotId)){throw new Error(sprintf(_t('There is no pivot with id "%s"'),pivotId));}}
function assertMeasureExist(pivotId,measure,getters){const{measures}=getters.getPivotDefinition(pivotId);if(!measures.includes(measure)){const validMeasures=`(${measures})`;throw new Error(sprintf(_t("The argument %s is not a valid measure. Here are the measures: %s"),measure,validMeasures));}}
function assertDomainLength(domain){if(domain.length%2!==0){throw new Error(_t("Function PIVOT takes an even number of arguments."));}}
const ODOO_FILTER_VALUE={description:_t("Return the current value of a spreadsheet filter."),args:[arg("filter_name (string)",_t("The label of the filter whose value to return."))],category:"Odoo",computeValueAndFormat:function(filterName){const unEscapedFilterName=toString(filterName.value).replaceAll('\\"','"');return this.getters.getFilterDisplayValue(unEscapedFilterName);},returns:["STRING"],};const ODOO_PIVOT={description:_t("Get the value from a pivot."),args:[arg("pivot_id (string)",_t("ID of the pivot.")),arg("measure_name (string)",_t("Name of the measure.")),arg("domain_field_name (string,optional,repeating)",_t("Field name.")),arg("domain_value (string,optional,repeating)",_t("Value.")),],compute:function(pivotId,measureName,...domain){pivotId=toString(pivotId);const measure=toString(measureName);const args=domain.map(toString);assertPivotsExists(pivotId,this.getters);assertMeasureExist(pivotId,measure,this.getters);assertDomainLength(args);return this.getters.getPivotCellValue(pivotId,measure,args);},category:"Odoo",computeFormat:function(pivotId,measureName,...domain){pivotId=toString(pivotId.value);const measure=toString(measureName.value);if(measure==="__count"){return"0";}
return this.getters.getPivotFieldFormat(pivotId,measure);},returns:["NUMBER","STRING"],};const ODOO_PIVOT_HEADER={description:_t("Get the header of a pivot."),args:[arg("pivot_id (string)",_t("ID of the pivot.")),arg("domain_field_name (string,optional,repeating)",_t("Field name.")),arg("domain_value (string,optional,repeating)",_t("Value.")),],category:"Odoo",compute:function(pivotId,...domain){pivotId=toString(pivotId);const domainArgs=domain.map(toString);assertPivotsExists(pivotId,this.getters);assertDomainLength(domainArgs);return this.getters.computeOdooPivotHeaderValue(pivotId,domainArgs);},computeFormat:function(pivotId,...domain){pivotId=toString(pivotId.value);const len=domain.length;if(!len){return undefined;}
const fieldName=toString(domain[len-2].value);const value=toString(domain[len-1].value);if(fieldName==="measure"||value==="false"){return undefined;}
return this.getters.getPivotFieldFormat(pivotId,fieldName);},returns:["NUMBER","STRING"],};const ODOO_PIVOT_POSITION={description:_t("Get the absolute ID of an element in the pivot"),args:[arg("pivot_id (string)",_t("ID of the pivot.")),arg("field_name (string)",_t("Name of the field.")),arg("position (number)",_t("Position in the pivot")),],compute:function(){throw new Error(_t(`[[FUNCTION_NAME]] cannot be called from the spreadsheet.`));},returns:["STRING"],hidden:true,};const ODOO_PIVOT_TABLE={description:_t("Get a pivot table."),args:[arg("pivot_id (string)",_t("ID of the pivot.")),arg("row_count (number, optional, default=10000)",_t("number of rows")),arg("include_total (boolean, default=TRUE)",_t("Whether to include total/sub-totals or not.")),arg("include_column_titles (boolean, default=TRUE)",_t("Whether to include the column titles or not.")),],computeValueAndFormat:function(pivotId,rowCount={value:10000},includeTotal={value:true},includeColumnHeaders={value:true}){const _pivotId=toString(pivotId.value);assertPivotsExists(_pivotId,this.getters);const table=this.getters.getPivotTableStructure(_pivotId);const _includeColumnHeaders=toBoolean(includeColumnHeaders.value);const cells=table.getPivotCells(toBoolean(includeTotal.value),_includeColumnHeaders);const headerRows=_includeColumnHeaders?table.getNumberOfHeaderRows():0;const pivotTitle=this.getters.getPivotDisplayName(_pivotId);const _rowCount=toNumber(rowCount.value);if(_rowCount<0){throw new Error(_t("The number of rows must be positive."));}
const end=Math.min(headerRows+_rowCount,cells[0].length);if(end===0){return[[{value:pivotTitle}]];}
const tableWidth=cells.length;const tableRows=range(0,end);const result=[];for(const col of range(0,tableWidth)){result[col]=[];for(const row of tableRows){const pivotCell=cells[col][row];result[col].push(getPivotCellValueAndFormat.call(this,_pivotId,pivotCell));}}
if(_includeColumnHeaders){result[0][0]={value:pivotTitle};}
return result;},category:"Odoo",returns:["RANGE<ANY>"],};function getPivotCellValueAndFormat(pivotId,pivotCell){if(!pivotCell.domain){return{value:"",format:undefined};}else{const domain=pivotCell.domain;const measure=pivotCell.measure;const fn=pivotCell.isHeader?ODOO_PIVOT_HEADER:ODOO_PIVOT;const args=pivotCell.isHeader?[pivotId,...domain]:[pivotId,measure,...domain];return{value:fn.compute.call(this,...args),format:fn.computeFormat.call(this,...args.map((a)=>({value:a}))),};}}
functionRegistry.add("ODOO.FILTER.VALUE",ODOO_FILTER_VALUE).add("ODOO.PIVOT",ODOO_PIVOT).add("ODOO.PIVOT.HEADER",ODOO_PIVOT_HEADER).add("ODOO.PIVOT.POSITION",ODOO_PIVOT_POSITION).add("ODOO.PIVOT.TABLE",ODOO_PIVOT_TABLE);return __exports;});;

/* /spreadsheet/static/src/pivot/pivot_helpers.js */
odoo.define('@spreadsheet/pivot/pivot_helpers',['@web/core/l10n/translation','@spreadsheet/helpers/odoo_functions_helpers'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{getOdooFunctions}=require("@spreadsheet/helpers/odoo_functions_helpers");const pivotFormulaRegex=__exports.pivotFormulaRegex=/^=.*PIVOT/;__exports.getNumberOfPivotFormulas=getNumberOfPivotFormulas;function getNumberOfPivotFormulas(tokens){return getOdooFunctions(tokens,["ODOO.PIVOT","ODOO.PIVOT.HEADER","ODOO.PIVOT.POSITION","ODOO.PIVOT.TABLE",]).length;}
__exports.getFirstPivotFunction=getFirstPivotFunction;function getFirstPivotFunction(tokens){return getOdooFunctions(tokens,["ODOO.PIVOT","ODOO.PIVOT.HEADER","ODOO.PIVOT.POSITION","ODOO.PIVOT.TABLE",])[0];}
__exports.makePivotFormula=makePivotFormula;function makePivotFormula(formula,args){return`=${formula}(${args
        .map((arg) => {
            const stringIsNumber =
                typeof arg == "string" && !isNaN(arg) && Number(arg).toString() === arg;
            const convertToNumber = typeof arg == "number" || stringIsNumber;
            return convertToNumber ? `${arg}` : `"${arg.toString().replace(/"/g,'\\"')}"`;
        })
        .join(",")})`;}
const PERIODS=__exports.PERIODS={day:_t("Day"),week:_t("Week"),month:_t("Month"),quarter:_t("Quarter"),year:_t("Year"),};return __exports;});;

/* /spreadsheet/static/src/pivot/pivot_model.js */
odoo.define('@spreadsheet/pivot/pivot_model',['@web/core/l10n/translation','@web/core/domain','@web/core/utils/strings','@web/views/pivot/pivot_model','@odoo/o-spreadsheet','@spreadsheet/pivot/pivot_helpers','@spreadsheet/pivot/pivot_table','@spreadsheet/pivot/pivot_time_adapters'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{Domain}=require("@web/core/domain");const{sprintf}=require("@web/core/utils/strings");const{PivotModel}=require("@web/views/pivot/pivot_model");const spreadsheet=require("@odoo/o-spreadsheet");const{PERIODS}=require("@spreadsheet/pivot/pivot_helpers");const{SpreadsheetPivotTable}=require("@spreadsheet/pivot/pivot_table");const{pivotTimeAdapter}=require("@spreadsheet/pivot/pivot_time_adapters");const{toString,toNumber,toBoolean}=spreadsheet.helpers;const{DEFAULT_LOCALE}=spreadsheet.constants;function parseGroupField(allFields,groupFieldString){let fieldName=groupFieldString;let aggregateOperator=undefined;const index=groupFieldString.indexOf(":");if(index!==-1){fieldName=groupFieldString.slice(0,index);aggregateOperator=groupFieldString.slice(index+1);}
const isPositional=fieldName.startsWith("#");fieldName=isPositional?fieldName.substring(1):fieldName;const field=allFields[fieldName];if(field===undefined){throw new Error(sprintf(_t("Field %s does not exist"),fieldName));}
if(["date","datetime"].includes(field.type)){aggregateOperator=aggregateOperator||"month";}
return{isPositional,field,aggregateOperator,};}
const UNSUPPORTED_FIELD_TYPES=["one2many","binary","html"];const NO_RECORD_AT_THIS_POSITION=__exports.NO_RECORD_AT_THIS_POSITION=Symbol("NO_RECORD_AT_THIS_POSITION");function isNotSupported(fieldType){return UNSUPPORTED_FIELD_TYPES.includes(fieldType);}
function throwUnsupportedFieldError(field){throw new Error(sprintf(_t("Field %s is not supported because of its type (%s)"),field.string,field.type));}
__exports.toNormalizedPivotValue=toNormalizedPivotValue;function toNormalizedPivotValue(field,groupValue,aggregateOperator){const groupValueString=typeof groupValue==="boolean"?toString(groupValue).toLocaleLowerCase():toString(groupValue);if(isNotSupported(field.type)){throwUnsupportedFieldError(field);}
if(groupValueString==="false"){return false;}
switch(field.type){case"datetime":case"date":return pivotTimeAdapter(aggregateOperator).normalizeFunctionValue(groupValueString,field);case"selection":case"char":case"text":return toString(groupValueString);case"boolean":return toBoolean(groupValueString);case"float":case"integer":case"monetary":case"many2one":case"many2many":return toNumber(groupValueString,DEFAULT_LOCALE);default:throwUnsupportedFieldError(field);}}
const SpreadsheetPivotModel=__exports.SpreadsheetPivotModel=class SpreadsheetPivotModel extends PivotModel{setup(params,services){(params.metaData.fieldAttrs={}),super.setup(params);this.metadataRepository=services.metadataRepository;this._usedValueDomains=new Set();this._usedHeaderDomains=new Set();this._modelLabel=params.metaData.modelLabel;}
isColumnGroupBy(fieldName){try{const{field}=this.parseGroupField(fieldName);return this._isCol(field);}catch{return false;}}
isRowGroupBy(fieldName){try{const{field}=this.parseGroupField(fieldName);return this._isRow(field);}catch{return false;}}
getFormattedGroupBy(fieldName){const{field,aggregateOperator}=this.parseGroupField(fieldName);return field.string+(aggregateOperator?` (${PERIODS[aggregateOperator]})`:"");}
clearUsedValues(){this._usedHeaderDomains.clear();this._usedValueDomains.clear();}
isUsedValue(domain,measure){return this._usedValueDomains.has(measure+","+domain.join());}
isUsedHeader(domain){return this._usedHeaderDomains.has(domain.join());}
markAsValueUsed(domain,measure){this._usedValueDomains.add(measure+","+domain.join());}
markAsHeaderUsed(domain){this._usedHeaderDomains.add(domain.join());}
isGroupedOnlyByOneDate(dimension){const groupBys=dimension==="COLUMN"?this.metaData.fullColGroupBys:this.metaData.fullRowGroupBys;return groupBys.length===1&&this._isDateField(this.parseGroupField(groupBys[0]).field);}
getGroupOfFirstDate(dimension){if(!this.isGroupedOnlyByOneDate(dimension)){return undefined;}
const groupBys=dimension==="COLUMN"?this.metaData.fullColGroupBys:this.metaData.fullRowGroupBys;return this.parseGroupField(groupBys[0]).aggregateOperator;}
getGroupByAtIndex(dimension,index){const groupBys=dimension==="COLUMN"?this.metaData.fullColGroupBys:this.metaData.fullRowGroupBys;return groupBys[index];}
getNumberOfColGroupBys(){return this.metaData.fullColGroupBys.length;}
getPivotCellValue(measure,domain){const{cols,rows}=this._getColsRowsValuesFromDomain(domain);const group=JSON.stringify([rows,cols]);const values=this.data.measurements[group];if(values&&(values[0][measure]||values[0][measure]===0)){return values[0][measure];}
return"";}
getGroupByCellValue(groupFieldString,groupValueString){if(groupValueString===NO_RECORD_AT_THIS_POSITION){return"";}
const{field,aggregateOperator}=this.parseGroupField(groupFieldString);const value=toNormalizedPivotValue(field,groupValueString,aggregateOperator);const undef=_t("None");if(this._isDateField(field)){const adapter=pivotTimeAdapter(aggregateOperator);return adapter.toCellValue(value);}
if(field.relation){const label=this.metadataRepository.getRecordDisplayName(field.relation,value);if(!label){return undef;}
return label;}
const label=this.metadataRepository.getLabel(this.metaData.resModel,field.name,value);if(!label){return undef;}
return label;}
getLastPivotGroupValue(domainArgs){const groupFieldString=domainArgs.at(-2);if(groupFieldString.startsWith("#")){const{field}=this.parseGroupField(groupFieldString);const{cols,rows}=this._getColsRowsValuesFromDomain(domainArgs);return this._isCol(field)?cols.at(-1):rows.at(-1);}
const groupValueString=domainArgs.at(-1);return groupValueString;}
getPivotCellDomain(domain){const{cols,rows}=this._getColsRowsValuesFromDomain(domain);const key=JSON.stringify([rows,cols]);const domains=this.data.groupDomains[key];return domains?domains[0]:Domain.FALSE.toList();}
getTableStructure(){if(this._tableStructure===undefined){this._tableStructure=this._buildTableStructure();}
return this._tableStructure;}
_buildTableStructure(){const cols=this._getSpreadsheetCols();const rows=this._getSpreadsheetRows(this.data.rowGroupTree);rows.push(rows.shift());const measures=this.metaData.activeMeasures;const rowTitle=this.metaData.rowGroupBys[0]?this.getFormattedGroupBy(this.metaData.rowGroupBys[0]):"";return new SpreadsheetPivotTable(cols,rows,measures,rowTitle);}
async _loadData(config){this.parseGroupField=parseGroupField.bind(null,this.metaData.fields);const prune=false;await super._loadData(config,prune);const metadataRepository=this.metadataRepository;const registerLabels=(tree,groupBys)=>{const group=tree.root;if(!tree.directSubTrees.size){for(let i=0;i<group.values.length;i++){const{field}=this.parseGroupField(groupBys[i]);if(!field.relation){metadataRepository.registerLabel(config.metaData.resModel,field.name,group.values[i],group.labels[i]);}else{metadataRepository.setDisplayName(field.relation,group.values[i],group.labels[i]);}}}
[...tree.directSubTrees.values()].forEach((subTree)=>{registerLabels(subTree,groupBys);});};registerLabels(this.data.colGroupTree,this.metaData.fullColGroupBys);registerLabels(this.data.rowGroupTree,this.metaData.fullRowGroupBys);}
_isDateField(field){return["date","datetime"].includes(field.type);}
_getGroupValues(group,groupBys){return groupBys.map((gb)=>{const groupBy=this._normalize(gb);const{field,aggregateOperator}=this.parseGroupField(gb);if(this._isDateField(field)){return pivotTimeAdapter(aggregateOperator).normalizeServerValue(groupBy,field,group);}
return this._sanitizeValue(group[groupBy]);});}
_isCol(field){return this.metaData.fullColGroupBys.map(this.parseGroupField).map(({field})=>field.name).includes(field.name);}
_isRow(field){return this.metaData.fullRowGroupBys.map(this.parseGroupField).map(({field})=>field.name).includes(field.name);}
_parsePivotFormulaWithPosition(field,groupValueString,cols,rows){const position=toNumber(groupValueString,DEFAULT_LOCALE)-1;let tree;if(this._isCol(field)){tree=this.data.colGroupTree;for(const col of cols){tree=tree&&tree.directSubTrees.get(col);}}else{tree=this.data.rowGroupTree;for(const row of rows){tree=tree&&tree.directSubTrees.get(row);}}
if(tree){const treeKeys=tree.sortedKeys||[...tree.directSubTrees.keys()];const sortedKey=treeKeys[position];return sortedKey!==undefined?sortedKey:NO_RECORD_AT_THIS_POSITION;}
return NO_RECORD_AT_THIS_POSITION;}
_getColsRowsValuesFromDomain(domain){const rows=[];const cols=[];let i=0;while(i<domain.length){const groupFieldString=domain[i];const groupValue=domain[i+1];const{field,isPositional,aggregateOperator}=this.parseGroupField(groupFieldString);let value;if(isPositional){value=this._parsePivotFormulaWithPosition(field,groupValue,cols,rows);}else{value=toNormalizedPivotValue(field,groupValue,aggregateOperator);}
if(this._isCol(field)){cols.push(value);}else if(this._isRow(field)){rows.push(value);}
i+=2;}
return{rows,cols};}
_getSpreadsheetRows(tree){const rows=[];const group=tree.root;const indent=group.labels.length;const rowGroupBys=this.metaData.fullRowGroupBys;rows.push({fields:rowGroupBys.slice(0,indent),values:group.values.map((val)=>val.toString()),indent,});const subTreeKeys=tree.sortedKeys||tree.directSubTrees.keys();subTreeKeys.forEach((subTreeKey)=>{const subTree=tree.directSubTrees.get(subTreeKey);rows.push(...this._getSpreadsheetRows(subTree));});return rows;}
_getSpreadsheetCols(){const colGroupBys=this.metaData.fullColGroupBys;const height=colGroupBys.length;const measureCount=this.metaData.activeMeasures.length;const leafCounts=this._getLeafCounts(this.data.colGroupTree);const headers=new Array(height).fill(0).map(()=>[]);function generateTreeHeaders(tree,fields){const group=tree.root;const rowIndex=group.values.length;if(rowIndex!==0){const row=headers[rowIndex-1];const leafCount=leafCounts[JSON.stringify(tree.root.values)];const cell={fields:colGroupBys.slice(0,rowIndex),values:group.values.map((val)=>val.toString()),width:leafCount*measureCount,};row.push(cell);}
[...tree.directSubTrees.values()].forEach((subTree)=>{generateTreeHeaders(subTree,fields);});}
generateTreeHeaders(this.data.colGroupTree,this.metaData.fields);const hasColGroupBys=this.metaData.colGroupBys.length;const measureRow=[];if(hasColGroupBys){headers[headers.length-1].forEach((cell)=>{this.metaData.activeMeasures.forEach((measureName)=>{const measureCell={fields:[...cell.fields,"measure"],values:[...cell.values,measureName],width:1,};measureRow.push(measureCell);});});}
this.metaData.activeMeasures.forEach((measureName)=>{const measureCell={fields:["measure"],values:[measureName],width:1,};measureRow.push(measureCell);});headers.push(measureRow);if(headers.length===1){headers.unshift([]);}
headers[headers.length-2].push({fields:[],values:[],width:this.metaData.activeMeasures.length,});return headers;}}
return __exports;});;

/* /spreadsheet/static/src/pivot/pivot_table.js */
odoo.define('@spreadsheet/pivot/pivot_table',['@spreadsheet/helpers/constants'],function(require){'use strict';let __exports={};const{HEADER_STYLE,TOP_LEVEL_STYLE,MEASURE_STYLE}=require("@spreadsheet/helpers/constants");const SpreadsheetPivotTable=__exports.SpreadsheetPivotTable=class SpreadsheetPivotTable{constructor(cols,rows,measures,rowTitle=""){this._cols=cols.map((row)=>{let offset=1;return row.map((col)=>{col={...col,offset};offset+=col.width;return col;});});this._rows=rows;this._measures=measures;this._rowTitle=rowTitle;this._maxIndent=Math.max(...this._rows.map((row)=>row.indent));this._pivotCells={};}
getColHeaders(){return this._cols;}
getMeasureHeaders(){return this._cols[this.getNumberOfHeaderRows()-1];}
getNumberOfDataColumns(){return this._cols[this.getNumberOfHeaderRows()-1].length;}
getNumberOfHeaderRows(){return this._cols.length;}
getRowHeaders(){return this._rows;}
getNumberOfDataRows(){return this._rows.length;}
getColMeasureIndex(values){const vals=JSON.stringify(values);const maxLength=Math.max(...this._cols.map((col)=>col.length));for(let i=0;i<maxLength;i++){const cellValues=this._cols.map((col)=>JSON.stringify((col[i]||{}).values));if(cellValues.includes(vals)){return i;}}
return-1;}
getNextColCell(colIndex,rowIndex){return this._cols[rowIndex][colIndex];}
getRowIndex(values){const vals=JSON.stringify(values);return this._rows.findIndex((cell)=>JSON.stringify(cell.values.map((val)=>val.toString()))===vals);}
getCellFromMeasureRowAtIndex(index){return this.getMeasureHeaders()[index];}
getCellsFromRowAtIndex(index){return this._rows[index];}
getPivotCells(includeTotal=true,includeColumnHeaders=true){const key=JSON.stringify({includeTotal,includeColumnHeaders});if(!this._pivotCells[key]){const numberOfDataRows=this.getNumberOfDataRows();const numberOfDataColumns=this.getNumberOfDataColumns();let pivotHeight=this.getNumberOfHeaderRows()+numberOfDataRows;let pivotWidth=1+numberOfDataColumns;if(!includeTotal&&numberOfDataRows!==1){pivotHeight-=1;}
if(!includeTotal&&numberOfDataColumns!==this._measures.length){pivotWidth-=this._measures.length;}
const domainArray=[];const startRow=includeColumnHeaders?0:this.getNumberOfHeaderRows();for(let col=0;col<pivotWidth;col++){domainArray.push([]);for(let row=startRow;row<pivotHeight;row++){if(!includeTotal&&row===pivotHeight){continue;}
domainArray[col].push(this._getPivotCell(col,row,includeTotal));}}
this._pivotCells[key]=domainArray;}
return this._pivotCells[key];}
_isTotalRow(row){return this._rows[row].indent!==this._maxIndent;}
_getPivotCell(col,row,includeTotal=true){const colHeadersHeight=this.getNumberOfHeaderRows();if(col===0&&row===colHeadersHeight-1){return{content:this._rowTitle,isHeader:true,style:HEADER_STYLE};}else if(row<=colHeadersHeight-1){const domain=this._getColHeaderDomain(col,row);const style=row===colHeadersHeight-1?MEASURE_STYLE:TOP_LEVEL_STYLE;return{domain,isHeader:true,style};}else if(col===0){const rowIndex=row-colHeadersHeight;const domain=this._getRowDomain(rowIndex);const indent=this._rows[rowIndex].indent;const style=indent<=1?TOP_LEVEL_STYLE:indent===2?HEADER_STYLE:undefined;return{domain,isHeader:true,style};}else{const rowIndex=row-colHeadersHeight;if(!includeTotal&&this._isTotalRow(rowIndex)){return{isHeader:false};}
const domain=[...this._getRowDomain(rowIndex),...this._getColDomain(col)];const measure=this._getColMeasure(col);return{domain,isHeader:false,measure};}}
_getColHeaderDomain(col,row){if(col===0){return undefined;}
const domain=[];const pivotCol=this._cols[row].find((pivotCol)=>pivotCol.offset===col);if(!pivotCol){return undefined;}
for(let i=0;i<pivotCol.fields.length;i++){domain.push(pivotCol.fields[i]);domain.push(pivotCol.values[i]);}
return domain;}
_getColDomain(col){return this._getColHeaderDomain(col,this.getNumberOfHeaderRows()-1).slice(0,-2);}
_getColMeasure(col){return this._getColHeaderDomain(col,this.getNumberOfHeaderRows()-1).at(-1);}
_getRowDomain(row){const domain=[];for(let i=0;i<this._rows[row].fields.length;i++){domain.push(this._rows[row].fields[i]);domain.push(this._rows[row].values[i]);}
return domain;}
export(){return{cols:this._cols,rows:this._rows,measures:this._measures,rowTitle:this._rowTitle,};}}
return __exports;});;

/* /spreadsheet/static/src/pivot/pivot_time_adapters.js */
odoo.define('@spreadsheet/pivot/pivot_time_adapters',['@odoo/o-spreadsheet','@web/core/l10n/dates','@web/core/l10n/translation','@web/core/utils/strings','@web/session'],function(require){'use strict';let __exports={};const{helpers,constants}=require("@odoo/o-spreadsheet");const{deserializeDate}=require("@web/core/l10n/dates");const{_t}=require("@web/core/l10n/translation");const{sprintf}=require("@web/core/utils/strings");const{session}=require("@web/session");const{toNumber,formatValue}=helpers;const{DEFAULT_LOCALE}=constants;const{DateTime}=luxon;__exports.pivotTimeAdapter=pivotTimeAdapter;function pivotTimeAdapter(groupAggregate){return TIME_ADAPTERS[groupAggregate];}
const dayAdapter={normalizeServerValue(groupBy,field,readGroupResult){const serverDayValue=getGroupStartingDay(field,groupBy,readGroupResult);const date=deserializeDate(serverDayValue);return date.toFormat("MM/dd/yyyy");},normalizeFunctionValue(value){const date=toNumber(value,DEFAULT_LOCALE);return formatValue(date,{locale:DEFAULT_LOCALE,format:"mm/dd/yyyy"});},increment(normalizedValue,step){const date=DateTime.fromFormat(normalizedValue,"MM/dd/yyyy");return date.plus({days:step}).toFormat("MM/dd/yyyy");},getFormat(locale){return locale.dateFormat;},formatValue(normalizedValue,locale){const value=toNumber(normalizedValue,DEFAULT_LOCALE);return formatValue(value,{locale,format:this.getFormat(locale)});},toCellValue(normalizedValue){return toNumber(normalizedValue,DEFAULT_LOCALE);},};const weekAdapter={normalizeServerValue(groupBy,field,readGroupResult){const weekValue=readGroupResult[groupBy];const{week,year}=parseServerWeekHeader(weekValue);return`${week}/${year}`;},normalizeFunctionValue(value){const[week,year]=value.split("/");return`${Number(week)}/${Number(year)}`;},increment(normalizedValue,step){const[week,year]=normalizedValue.split("/");const weekNumber=Number(week);const yearNumber=Number(year);const date=DateTime.fromObject({weekNumber,weekYear:yearNumber});const nextWeek=date.plus({weeks:step});return`${nextWeek.weekNumber}/${nextWeek.weekYear}`;},getFormat(locale){return undefined;},formatValue(normalizedValue,locale){const[week,year]=normalizedValue.split("/");return sprintf(_t("W%(week)s %(year)s"),{week,year});},toCellValue(normalizedValue){return this.formatValue(normalizedValue);},};const monthAdapter={normalizeServerValue(groupBy,field,readGroupResult){const firstOfTheMonth=getGroupStartingDay(field,groupBy,readGroupResult);const date=deserializeDate(firstOfTheMonth);return date.toFormat("MM/yyyy");},normalizeFunctionValue(value){const date=toNumber(value,DEFAULT_LOCALE);return formatValue(date,{DEFAULT_LOCALE,format:"mm/yyyy"});},increment(normalizedValue,step){return DateTime.fromFormat(normalizedValue,"MM/yyyy").plus({months:step}).toFormat("MM/yyyy");},getFormat(locale){return"mmmm yyyy";},formatValue(normalizedValue,locale){const value=toNumber(normalizedValue,DEFAULT_LOCALE);return formatValue(value,{locale,format:this.getFormat(locale)});},toCellValue(normalizedValue){return toNumber(normalizedValue,DEFAULT_LOCALE);},};const quarterAdapter={normalizeServerValue(groupBy,field,readGroupResult){const firstOfTheQuarter=getGroupStartingDay(field,groupBy,readGroupResult);const date=deserializeDate(firstOfTheQuarter);return`${date.quarter}/${date.year}`;},normalizeFunctionValue(value){const[quarter,year]=value.split("/");return`${quarter}/${year}`;},increment(normalizedValue,step){const[quarter,year]=normalizedValue.split("/");const date=DateTime.fromObject({year:Number(year),month:Number(quarter)*3});const nextQuarter=date.plus({quarters:step});return`${nextQuarter.quarter}/${nextQuarter.year}`;},getFormat(locale){return undefined;},formatValue(normalizedValue,locale){const[quarter,year]=normalizedValue.split("/");return sprintf(_t("Q%(quarter)s %(year)s"),{quarter,year});},toCellValue(normalizedValue){return this.formatValue(normalizedValue);},};const yearAdapter={normalizeServerValue(groupBy,field,readGroupResult){return Number(readGroupResult[groupBy]);},normalizeFunctionValue(value){return toNumber(value,DEFAULT_LOCALE);},increment(normalizedValue,step){return normalizedValue+step;},getFormat(locale){return"0";},formatValue(normalizedValue,locale){return formatValue(normalizedValue,{locale,format:"0"});},toCellValue(normalizedValue){return normalizedValue;},};function falseHandlerDecorator(adapter){return{normalizeServerValue(groupBy,field,readGroupResult){if(readGroupResult[groupBy]===false){return false;}
return adapter.normalizeServerValue(groupBy,field,readGroupResult);},normalizeFunctionValue(value){if(value===false||value==="false"){return false;}
return adapter.normalizeFunctionValue(value);},increment(normalizedValue,step){if(normalizedValue===false){return false;}
return adapter.increment(normalizedValue,step);},getFormat:adapter.getFormat.bind(adapter),formatValue(normalizedValue,locale){if(normalizedValue===false){return _t("None");}
return adapter.formatValue(normalizedValue,locale);},toCellValue(normalizedValue){if(normalizedValue===false){return _t("None");}
return adapter.toCellValue(normalizedValue);},};}
const TIME_ADAPTERS={day:falseHandlerDecorator(dayAdapter),week:falseHandlerDecorator(weekAdapter),month:falseHandlerDecorator(monthAdapter),quarter:falseHandlerDecorator(quarterAdapter),year:falseHandlerDecorator(yearAdapter),};function getGroupStartingDay(field,groupBy,readGroup){if(!readGroup["__range"]||!readGroup["__range"][groupBy]){return undefined;}
const sqlValue=readGroup["__range"][groupBy].from;if(field.type==="date"){return sqlValue;}
const userTz=session.user_context.tz||luxon.Settings.defaultZoneName;return DateTime.fromSQL(sqlValue,{zone:"utc"}).setZone(userTz).toISODate();}
function parseServerWeekHeader(value){const[week,year]=value.split(" ");return{week:Number(week.slice(1)),year:Number(year)};}
return __exports;});;

/* /spreadsheet/static/src/pivot/plugins/pivot_core_plugin.js */
odoo.define('@spreadsheet/pivot/plugins/pivot_core_plugin',['@odoo/o-spreadsheet','@spreadsheet/pivot/pivot_helpers','@spreadsheet/helpers/helpers','@spreadsheet/pivot/pivot_table','@spreadsheet/o_spreadsheet/cancelled_reason','@web/core/l10n/translation','@spreadsheet/global_filters/plugins/global_filters_core_plugin','@web/core/utils/strings','@spreadsheet/global_filters/helpers','@web/core/domain'],function(require){'use strict';let __exports={};const{CorePlugin,helpers}=require("@odoo/o-spreadsheet");const{makePivotFormula}=require("@spreadsheet/pivot/pivot_helpers");const{getMaxObjectId}=require("@spreadsheet/helpers/helpers");const{SpreadsheetPivotTable}=require("@spreadsheet/pivot/pivot_table");const{CommandResult}=require("@spreadsheet/o_spreadsheet/cancelled_reason");const{_t}=require("@web/core/l10n/translation");const{globalFiltersFieldMatchers}=require("@spreadsheet/global_filters/plugins/global_filters_core_plugin");const{sprintf}=require("@web/core/utils/strings");const{checkFilterFieldMatching}=require("@spreadsheet/global_filters/helpers");const{Domain}=require("@web/core/domain");const{isDefined}=helpers;const PivotCorePlugin=__exports.PivotCorePlugin=class PivotCorePlugin extends CorePlugin{constructor(config){super(config);this.nextId=1;this.pivots={};globalFiltersFieldMatchers["pivot"]={getIds:()=>this.getters.getPivotIds(),getDisplayName:(pivotId)=>this.getters.getPivotName(pivotId),getTag:(pivotId)=>sprintf(_t("Pivot #%s"),pivotId),getFieldMatching:(pivotId,filterId)=>this.getPivotFieldMatching(pivotId,filterId),getModel:(pivotId)=>this.getPivotDefinition(pivotId).model,};}
allowDispatch(cmd){switch(cmd.type){case"RENAME_ODOO_PIVOT":if(!(cmd.pivotId in this.pivots)){return CommandResult.PivotIdNotFound;}
if(cmd.name===""){return CommandResult.EmptyName;}
break;case"INSERT_PIVOT":if(cmd.id!==this.nextId.toString()){return CommandResult.InvalidNextId;}
break;case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":if(cmd.pivot){return checkFilterFieldMatching(cmd.pivot);}}
return CommandResult.Success;}
handle(cmd){switch(cmd.type){case"INSERT_PIVOT":{const{sheetId,col,row,id,definition}=cmd;const position={col,row};const{cols,rows,measures,rowTitle}=cmd.table;const table=new SpreadsheetPivotTable(cols,rows,measures,rowTitle);this._addPivot(id,definition);this._insertPivot(sheetId,position,id,table);this.history.update("nextId",parseInt(id,10)+1);break;}
case"RE_INSERT_PIVOT":{const{sheetId,col,row,id}=cmd;const position={col,row};const{cols,rows,measures,rowTitle}=cmd.table;const table=new SpreadsheetPivotTable(cols,rows,measures,rowTitle);this._insertPivot(sheetId,position,id,table);break;}
case"RENAME_ODOO_PIVOT":{this.history.update("pivots",cmd.pivotId,"definition","name",cmd.name);break;}
case"REMOVE_PIVOT":{const pivots={...this.pivots};delete pivots[cmd.pivotId];this.history.update("pivots",pivots);break;}
case"UPDATE_ODOO_PIVOT_DOMAIN":{this.history.update("pivots",cmd.pivotId,"definition","searchParams","domain",cmd.domain);break;}
case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":if(cmd.pivot){this._setPivotFieldMatching(cmd.filter.id,cmd.pivot);}
break;case"REMOVE_GLOBAL_FILTER":this._onFilterDeletion(cmd.id);break;}}
getPivotDisplayName(id){return`(#${id}) ${this.getPivotName(id)}`;}
getPivotName(id){return _t(this.pivots[id].definition.name);}
getPivotFieldMatch(id){return this.pivots[id].fieldMatching;}
getNextPivotId(){return this.nextId.toString();}
getPivotDefinition(id){const def=this.pivots[id].definition;return{colGroupBys:[...def.metaData.colGroupBys],context:{...def.searchParams.context},domain:def.searchParams.domain,id,measures:[...def.metaData.activeMeasures],model:def.metaData.resModel,rowGroupBys:[...def.metaData.rowGroupBys],name:def.name,sortedColumn:def.metaData.sortedColumn?{...def.metaData.sortedColumn}:null,};}
getPivotModelDefinition(id){return this.pivots[id].definition;}
getPivotIds(){return Object.keys(this.pivots);}
isExistingPivot(pivotId){return pivotId in this.pivots;}
getPivotFieldMatching(pivotId,filterId){return this.pivots[pivotId].fieldMatching[filterId];}
_setPivotFieldMatching(filterId,pivotFieldMatches){const pivots={...this.pivots};for(const[pivotId,fieldMatch]of Object.entries(pivotFieldMatches)){pivots[pivotId].fieldMatching[filterId]=fieldMatch;}
this.history.update("pivots",pivots);}
_onFilterDeletion(filterId){const pivots={...this.pivots};for(const pivotId in pivots){this.history.update("pivots",pivotId,"fieldMatching",filterId,undefined);}}
_addPivot(id,definition,fieldMatching=undefined){const pivots={...this.pivots};if(!fieldMatching){const model=definition.metaData.resModel;fieldMatching=this.getters.getFieldMatchingForModel(model);}
pivots[id]={id,definition,fieldMatching,};this.history.update("pivots",pivots);}
_insertPivot(sheetId,position,id,table){this._resizeSheet(sheetId,position,table);const pivotCells=table.getPivotCells();for(let col=0;col<pivotCells.length;col++){for(let row=0;row<pivotCells[col].length;row++){const pivotCell=pivotCells[col][row];const functionCol=position.col+col;const functionRow=position.row+row;this._addPivotFormula(sheetId,id,{col:functionCol,row:functionRow},pivotCell);}}
this._addBorders(sheetId,position,table);}
_resizeSheet(sheetId,{col,row},table){const colLimit=table.getNumberOfDataColumns()+1;const numberCols=this.getters.getNumberCols(sheetId);const deltaCol=numberCols-col;if(deltaCol<colLimit){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"COL",base:numberCols-1,sheetId:sheetId,quantity:colLimit-deltaCol,position:"after",});}
const rowLimit=table.getNumberOfHeaderRows()+table.getNumberOfDataRows();const numberRows=this.getters.getNumberRows(sheetId);const deltaRow=numberRows-row;if(deltaRow<rowLimit){this.dispatch("ADD_COLUMNS_ROWS",{dimension:"ROW",base:numberRows-1,sheetId:sheetId,quantity:rowLimit-deltaRow,position:"after",});}}
_addBorders(sheetId,{col,row},table){const colHeight=table.getNumberOfHeaderRows();const colWidth=table.getNumberOfDataColumns();const totalRow=row+colHeight+table.getRowHeaders().length-1;const headerAndMeasureZone={top:row,bottom:row+colHeight-1,left:col,right:col+colWidth,};this.dispatch("SET_ZONE_BORDERS",{sheetId,target:[headerAndMeasureZone,{left:col,right:col+colWidth,top:totalRow,bottom:totalRow,},{left:col,right:col+colWidth,top:row,bottom:totalRow,},],border:{position:"external",color:"#2D7E84",},});}
_addPivotFormula(sheetId,pivotId,{col,row},pivotCell){const formula=pivotCell.isHeader?"ODOO.PIVOT.HEADER":"ODOO.PIVOT";const args=pivotCell.domain?[pivotId,pivotCell.measure,...pivotCell.domain].filter(isDefined):undefined;this.dispatch("UPDATE_CELL",{sheetId,col,row,content:pivotCell.content||(args?makePivotFormula(formula,args):undefined),style:pivotCell.style,});}
import(data){if(data.pivots){for(const[id,pivot]of Object.entries(data.pivots)){const definition={metaData:{colGroupBys:pivot.colGroupBys,rowGroupBys:pivot.rowGroupBys,activeMeasures:pivot.measures.map((elt)=>elt.field),resModel:pivot.model,sortedColumn:!pivot.sortedColumn?undefined:{groupId:pivot.sortedColumn.groupId,measure:pivot.sortedColumn.measure,order:pivot.sortedColumn.order,},},searchParams:{groupBy:[],orderBy:[],domain:pivot.domain,context:pivot.context,},name:pivot.name,};this._addPivot(id,definition,pivot.fieldMatching);}}
this.nextId=data.pivotNextId||getMaxObjectId(this.pivots)+1;}
export(data){data.pivots={};for(const id in this.pivots){data.pivots[id]=JSON.parse(JSON.stringify(this.getPivotDefinition(id)));data.pivots[id].measures=data.pivots[id].measures.map((elt)=>({field:elt}));data.pivots[id].fieldMatching=this.pivots[id].fieldMatching;data.pivots[id].domain=new Domain(data.pivots[id].domain).toJson();}
data.pivotNextId=this.nextId;}}
PivotCorePlugin.getters=["getNextPivotId","getPivotDefinition","getPivotDisplayName","getPivotIds","getPivotName","isExistingPivot","getPivotFieldMatch","getPivotFieldMatching","getPivotModelDefinition",];return __exports;});;

/* /spreadsheet/static/src/pivot/plugins/pivot_ui_plugin.js */
odoo.define('@spreadsheet/pivot/plugins/pivot_ui_plugin',['@odoo/o-spreadsheet','@spreadsheet/pivot/pivot_helpers','@spreadsheet/assets_backend/constants','@web/core/domain','@spreadsheet/pivot/pivot_model','@spreadsheet/global_filters/plugins/global_filters_core_plugin','@spreadsheet/pivot/pivot_data_source','@spreadsheet/pivot/pivot_time_adapters'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{getFirstPivotFunction,getNumberOfPivotFormulas}=require("@spreadsheet/pivot/pivot_helpers");const{FILTER_DATE_OPTION,monthsOptions}=require("@spreadsheet/assets_backend/constants");const{Domain}=require("@web/core/domain");const{NO_RECORD_AT_THIS_POSITION}=require("@spreadsheet/pivot/pivot_model");const{globalFiltersFieldMatchers}=require("@spreadsheet/global_filters/plugins/global_filters_core_plugin");const{PivotDataSource}=require("@spreadsheet/pivot/pivot_data_source");const{pivotTimeAdapter}=require("@spreadsheet/pivot/pivot_time_adapters");const{astToFormula,helpers}=spreadsheet;const{formatValue}=helpers;const{DateTime}=luxon;function pivotPeriodToFilterValue(timeRange,value){const yearOffset=(value.split("/").pop()|0)-DateTime.now().year;switch(timeRange){case"year":return{yearOffset,};case"month":{const month=value.split("/")[0]|0;return{yearOffset,period:monthsOptions[month-1].id,};}
case"quarter":{const quarter=value.split("/")[0]|0;return{yearOffset,period:FILTER_DATE_OPTION.quarter[quarter-1],};}}}
const PivotUIPlugin=__exports.PivotUIPlugin=class PivotUIPlugin extends spreadsheet.UIPlugin{constructor(config){super(config);this.selectedPivotId=undefined;this.selection.observe(this,{handleEvent:this.handleEvent.bind(this),});this.dataSources=config.custom.dataSources;globalFiltersFieldMatchers["pivot"]={...globalFiltersFieldMatchers["pivot"],waitForReady:()=>this._getPivotsWaitForReady(),getFields:(pivotId)=>this.getPivotDataSource(pivotId).getFields(),};}
handleEvent(event){if(!this.getters.isDashboard()){return;}
switch(event.type){case"ZonesSelected":{const sheetId=this.getters.getActiveSheetId();const{col,row}=event.anchor.cell;const cell=this.getters.getCell({sheetId,col,row});if(cell!==undefined&&cell.content.startsWith("=ODOO.PIVOT.HEADER(")){const filters=this._getFiltersMatchingPivot(sheetId,cell.compiledFormula.tokens);this.dispatch("SET_MANY_GLOBAL_FILTER_VALUE",{filters});}
break;}}}
beforeHandle(cmd){switch(cmd.type){case"START":for(const pivotId of this.getters.getPivotIds()){this._setupPivotDataSource(pivotId);}
this._addDomains();break;}}
handle(cmd){switch(cmd.type){case"SELECT_PIVOT":this.selectedPivotId=cmd.pivotId;break;case"REMOVE_PIVOT":if(this.selectedPivotId===cmd.pivotId){this.selectedPivotId=undefined;}
break;case"REFRESH_PIVOT":this._refreshOdooPivot(cmd.id);break;case"REFRESH_ALL_DATA_SOURCES":this._refreshOdooPivots();break;case"ADD_GLOBAL_FILTER":case"EDIT_GLOBAL_FILTER":case"REMOVE_GLOBAL_FILTER":case"SET_GLOBAL_FILTER_VALUE":case"CLEAR_GLOBAL_FILTER_VALUE":this._addDomains();break;case"INSERT_PIVOT":{const{id}=cmd;this._setupPivotDataSource(id);break;}
case"UPDATE_ODOO_PIVOT_DOMAIN":{const pivotDefinition=this.getters.getPivotModelDefinition(cmd.pivotId);const dataSourceId=this.getPivotDataSourceId(cmd.pivotId);this.dataSources.add(dataSourceId,PivotDataSource,pivotDefinition);break;}
case"UNDO":case"REDO":{if(cmd.commands.find((command)=>["ADD_GLOBAL_FILTER","EDIT_GLOBAL_FILTER","REMOVE_GLOBAL_FILTER",].includes(command.type))){this._addDomains();}
const domainEditionCommands=cmd.commands.filter((cmd)=>cmd.type==="UPDATE_ODOO_PIVOT_DOMAIN"||cmd.type==="INSERT_PIVOT");for(const cmd of domainEditionCommands){if(!this.getters.isExistingPivot(cmd.pivotId)){continue;}
const pivotDefinition=this.getters.getPivotModelDefinition(cmd.pivotId);const dataSourceId=this.getPivotDataSourceId(cmd.pivotId);this.dataSources.add(dataSourceId,PivotDataSource,pivotDefinition);}
if(!this.getters.getPivotIds().length){this.selectedPivotId=undefined;}
break;}}}
getSelectedPivotId(){return this.selectedPivotId;}
getPivotIdFromPosition(position){const cell=this.getters.getCorrespondingFormulaCell(position);if(cell&&cell.isFormula){const pivotFunction=this.getters.getFirstPivotFunction(position.sheetId,cell.compiledFormula.tokens);if(pivotFunction&&pivotFunction.args[0]){return pivotFunction.args[0].toString();}}
return undefined;}
getFirstPivotFunction(sheetId,tokens){const pivotFunction=getFirstPivotFunction(tokens);if(!pivotFunction){return undefined;}
const{functionName,args}=pivotFunction;const evaluatedArgs=args.map((argAst)=>{if(argAst.type=="EMPTY"){return undefined;}else if(argAst.type==="STRING"||argAst.type==="BOOLEAN"||argAst.type==="NUMBER"){return argAst.value;}
const argsString=astToFormula(argAst);return this.getters.evaluateFormula(sheetId,argsString);});return{functionName,args:evaluatedArgs};}
getPivotDomainArgsFromPosition(position){const cell=this.getters.getCorrespondingFormulaCell(position);if(!cell||!cell.isFormula||getNumberOfPivotFormulas(cell.compiledFormula.tokens)===0){return undefined;}
const mainPosition=this.getters.getCellPosition(cell.id);const{args,functionName}=this.getters.getFirstPivotFunction(position.sheetId,cell.compiledFormula.tokens);if(functionName==="ODOO.PIVOT.TABLE"){const pivotId=args[0];const dataSource=this.getPivotDataSource(pivotId);if(!this.getters.isExistingPivot(pivotId)||!dataSource.isReady()){return undefined;}
const includeTotal=args[2];const includeColumnHeaders=args[3];const pivotCells=this.getPivotTableStructure(pivotId).getPivotCells(includeTotal,includeColumnHeaders);const pivotCol=position.col-mainPosition.col;const pivotRow=position.row-mainPosition.row;const pivotCell=pivotCells[pivotCol][pivotRow];let domain=pivotCell.domain;if(domain?.at(-2)==="measure"){domain=domain.slice(0,-2);}
return{domainArgs:domain,isHeader:pivotCell.isHeader};}
let domain=args.slice(functionName==="ODOO.PIVOT"?2:1);if(domain.at(-2)==="measure"){domain=domain.slice(0,-2);}
const isHeader=functionName==="ODOO.PIVOT.HEADER";return{domainArgs:domain,isHeader};}
getPivotComputedDomain(pivotId){return this.getters.getPivotDataSource(pivotId).getComputedDomain();}
getPivotGroupByValues(pivotId,fieldName){return this.getters.getPivotDataSource(pivotId).getPossibleValuesForGroupBy(fieldName);}
computeOdooPivotHeaderValue(pivotId,domainArgs){const dataSource=this.getters.getPivotDataSource(pivotId);dataSource.markAsHeaderUsed(domainArgs);return dataSource.computeOdooPivotHeaderValue(domainArgs);}
getPivotHeaderFormattedValue(pivotId,pivotArgs){const dataSource=this.getters.getPivotDataSource(pivotId);const value=dataSource.computeOdooPivotHeaderValue(pivotArgs);if(typeof value==="string"){return value;}
const format=this.getPivotFieldFormat(pivotId,pivotArgs.at(-2));const locale=this.getters.getLocale();return formatValue(value,{format,locale});}
getPivotFieldFormat(pivotId,fieldName){const dataSource=this.getPivotDataSource(pivotId);const{field,aggregateOperator}=dataSource.parseGroupField(fieldName);return this._getFieldFormat(field,aggregateOperator);}
getPivotCellValue(pivotId,measure,domain){const dataSource=this.getters.getPivotDataSource(pivotId);dataSource.markAsValueUsed(domain,measure);return dataSource.getPivotCellValue(measure,domain);}
getPivotTableStructure(pivotId){const dataSource=this.getters.getPivotDataSource(pivotId);return dataSource.getTableStructure();}
_getFiltersMatchingPivot(sheetId,tokens){const functionDescription=this.getters.getFirstPivotFunction(sheetId,tokens);if(!functionDescription){return[];}
const{args}=functionDescription;if(args.length<=2){return[];}
const pivotId=args[0];return this.getFiltersMatchingPivotArgs(pivotId,args);}
getFiltersMatchingPivotArgs(pivotId,domainArgs){const argField=domainArgs[domainArgs.length-2];if(argField==="measure"||!argField){return[];}
const filters=this.getters.getGlobalFilters();const matchingFilters=[];for(const filter of filters){const dataSource=this.getters.getPivotDataSource(pivotId);const{field,aggregateOperator:time}=dataSource.parseGroupField(argField);const pivotFieldMatching=this.getters.getPivotFieldMatching(pivotId,filter.id);if(pivotFieldMatching&&pivotFieldMatching.chain===field.name){let value=dataSource.getLastPivotGroupValue(domainArgs.slice(-2));if(value===NO_RECORD_AT_THIS_POSITION){continue;}
let transformedValue;const currentValue=this.getters.getGlobalFilterValue(filter.id);switch(filter.type){case"date":if(filter.rangeType==="fixedPeriod"&&time){if(value==="false"){transformedValue=undefined;}else{transformedValue=pivotPeriodToFilterValue(time,value);if(JSON.stringify(transformedValue)===JSON.stringify(currentValue)){transformedValue=undefined;}}}else{continue;}
break;case"relation":if(typeof value=="string"){value=Number(value);if(Number.isNaN(value)){break;}}
if(JSON.stringify(currentValue)!==`[${value}]`){transformedValue=[value];}
break;case"text":if(currentValue!==value){transformedValue=value;}
break;}
matchingFilters.push({filterId:filter.id,value:transformedValue});}}
return matchingFilters;}
getPivotDataSource(pivotId){const dataSourceId=this.getPivotDataSourceId(pivotId);return this.dataSources.get(dataSourceId);}
getPivotDataSourceId(pivotId){return`pivot-${pivotId}`;}
async getAsyncPivotDataSource(pivotId){const dataSourceId=this.getPivotDataSourceId(pivotId);await this.dataSources.load(dataSourceId);return this.getPivotDataSource(pivotId);}
_getFieldFormat(field,aggregateOperator){switch(field.type){case"integer":return"0";case"float":return"#,##0.00";case"monetary":return this.getters.getCompanyCurrencyFormat()||"#,##0.00";case"date":case"datetime":{const timeAdapter=pivotTimeAdapter(aggregateOperator);return timeAdapter.getFormat(this.getters.getLocale());}
default:return undefined;}}
_refreshOdooPivot(pivotId){const dataSource=this.getters.getPivotDataSource(pivotId);dataSource.clearUsedValues();dataSource.load({reload:true});}
_refreshOdooPivots(){for(const pivotId of this.getters.getPivotIds()){this._refreshOdooPivot(pivotId,false);}}
_addDomain(pivotId){const domainList=[];for(const[filterId,fieldMatch]of Object.entries(this.getters.getPivotFieldMatch(pivotId))){domainList.push(this.getters.getGlobalFilterDomain(filterId,fieldMatch));}
const domain=Domain.combine(domainList,"AND").toString();this.getters.getPivotDataSource(pivotId).addDomain(domain);}
_addDomains(){for(const pivotId of this.getters.getPivotIds()){this._addDomain(pivotId);}}
_getPivotsWaitForReady(){return this.getters.getPivotIds().map((pivotId)=>this.getPivotDataSource(pivotId).loadMetadata());}
_setupPivotDataSource(pivotId){const dataSourceId=this.getPivotDataSourceId(pivotId);const definition=this.getters.getPivotModelDefinition(pivotId);if(!this.dataSources.contains(dataSourceId)){this.dataSources.add(dataSourceId,PivotDataSource,definition);}}}
PivotUIPlugin.getters=["getPivotDataSource","getAsyncPivotDataSource","getFirstPivotFunction","getSelectedPivotId","getPivotComputedDomain","computeOdooPivotHeaderValue","getPivotHeaderFormattedValue","getPivotFieldFormat","getPivotIdFromPosition","getPivotCellValue","getPivotGroupByValues","getFiltersMatchingPivotArgs","getPivotDataSourceId","getPivotTableStructure","getPivotDomainArgsFromPosition",];return __exports;});;

/* /spreadsheet_dashboard/static/src/bundle/dashboard_action/dashboard_action.js */
odoo.define('@spreadsheet_dashboard/bundle/dashboard_action/dashboard_action',['@web/core/registry','@web/search/control_panel/control_panel','@spreadsheet_dashboard/bundle/dashboard_action/dashboard_loader','@odoo/o-spreadsheet','@web/webclient/actions/action_hook','@spreadsheet_dashboard/bundle/dashboard_action/mobile_search_panel/mobile_search_panel','@spreadsheet_dashboard/bundle/dashboard_action/mobile_figure_container/mobile_figure_container','@spreadsheet/global_filters/components/filter_value/filter_value','@web/core/utils/hooks','@web/webclient/actions/action_service','@spreadsheet/components/share_button/share_button','@spreadsheet/hooks','@odoo/owl'],function(require){'use strict';let __exports={};const{registry}=require("@web/core/registry");const{ControlPanel}=require("@web/search/control_panel/control_panel");const{DashboardLoader,Status}=require("@spreadsheet_dashboard/bundle/dashboard_action/dashboard_loader");const{Spreadsheet}=require("@odoo/o-spreadsheet");const{useSetupAction}=require("@web/webclient/actions/action_hook");const{DashboardMobileSearchPanel}=require("@spreadsheet_dashboard/bundle/dashboard_action/mobile_search_panel/mobile_search_panel");const{MobileFigureContainer}=require("@spreadsheet_dashboard/bundle/dashboard_action/mobile_figure_container/mobile_figure_container");const{FilterValue}=require("@spreadsheet/global_filters/components/filter_value/filter_value");const{useService}=require("@web/core/utils/hooks");const{standardActionServiceProps}=require("@web/webclient/actions/action_service");const{SpreadsheetShareButton}=require("@spreadsheet/components/share_button/share_button");const{useSpreadsheetPrint}=require("@spreadsheet/hooks");const{Component,onWillStart,useState,useEffect}=require("@odoo/owl");const SpreadsheetDashboardAction=__exports.SpreadsheetDashboardAction=class SpreadsheetDashboardAction extends Component{setup(){this.Status=Status;this.controlPanelDisplay={};this.orm=useService("orm");this.router=useService("router");this.loader=useState(new DashboardLoader(this.env,this.env.services.orm));onWillStart(async()=>{if(this.props.state&&this.props.state.dashboardLoader){const{groups,dashboards}=this.props.state.dashboardLoader;this.loader.restoreFromState(groups,dashboards);}else{await this.loader.load();}
const activeDashboardId=this.getInitialActiveDashboard();if(activeDashboardId){this.openDashboard(activeDashboardId);}});useEffect(()=>this.router.pushState({dashboard_id:this.activeDashboardId}),()=>[this.activeDashboardId]);useEffect(()=>{const dashboard=this.state.activeDashboard;if(dashboard&&dashboard.status===Status.Loaded){const render=()=>this.render(true);dashboard.model.on("update",this,render);return()=>dashboard.model.off("update",this,render);}},()=>{const dashboard=this.state.activeDashboard;return[dashboard?.model,dashboard?.status];});useSetupAction({getLocalState:()=>{return{activeDashboardId:this.activeDashboardId,dashboardLoader:this.loader.getState(),};},});useSpreadsheetPrint(()=>this.state.activeDashboard?.model);this.state=useState({activeDashboard:undefined});}
get activeDashboardId(){return this.state.activeDashboard?this.state.activeDashboard.id:undefined;}
get filters(){const dashboard=this.state.activeDashboard;if(!dashboard||dashboard.status!==Status.Loaded){return[];}
return dashboard.model.getters.getGlobalFilters();}
getInitialActiveDashboard(){if(this.props.state&&this.props.state.activeDashboardId){return this.props.state.activeDashboardId;}
const params=this.props.action.params||this.props.action.context.params;if(params&&params.dashboard_id){return params.dashboard_id;}
const[firstSection]=this.getDashboardGroups();if(firstSection&&firstSection.dashboards.length){return firstSection.dashboards[0].id;}}
getDashboardGroups(){return this.loader.getDashboardGroups();}
openDashboard(dashboardId){this.state.activeDashboard=this.loader.getDashboard(dashboardId);}
async shareSpreadsheet(data,excelExport){const url=await this.orm.call("spreadsheet.dashboard.share","action_get_share_url",[{dashboard_id:this.activeDashboardId,spreadsheet_data:JSON.stringify(data),excel_files:excelExport.files,},]);return url;}}
SpreadsheetDashboardAction.template="spreadsheet_dashboard.DashboardAction";SpreadsheetDashboardAction.components={ControlPanel,Spreadsheet,FilterValue,DashboardMobileSearchPanel,MobileFigureContainer,SpreadsheetShareButton,};SpreadsheetDashboardAction.props={...standardActionServiceProps};registry.category("actions").add("action_spreadsheet_dashboard",SpreadsheetDashboardAction,{force:true});return __exports;});;

/* /spreadsheet_dashboard/static/src/bundle/dashboard_action/dashboard_loader.js */
odoo.define('@spreadsheet_dashboard/bundle/dashboard_action/dashboard_loader',['@spreadsheet/data_sources/data_sources','@spreadsheet/o_spreadsheet/migration','@odoo/o-spreadsheet','@spreadsheet/currency/helpers'],function(require){'use strict';let __exports={};const{DataSources}=require("@spreadsheet/data_sources/data_sources");const{migrate}=require("@spreadsheet/o_spreadsheet/migration");const{Model}=require("@odoo/o-spreadsheet");const{createDefaultCurrencyFormat}=require("@spreadsheet/currency/helpers");const Status=__exports.Status={NotLoaded:"NotLoaded",Loading:"Loading",Loaded:"Loaded",Error:"Error",};const DashboardLoader=__exports.DashboardLoader=class DashboardLoader{constructor(env,orm){this.env=env;this.orm=orm;this.groups=[];this.dashboards={};}
restoreFromState(groups,dashboards){this.groups=groups;this.dashboards=dashboards;}
getState(){return{groups:this.groups,dashboards:this.dashboards,};}
async load(){const groups=await this._fetchGroups();this.groups=groups.filter((group)=>group.dashboard_ids.length).map((group)=>({id:group.id,name:group.name,dashboards:group.dashboard_ids,}));const dashboards=this.groups.map((group)=>group.dashboards).flat();for(const dashboard of dashboards){this.dashboards[dashboard.id]={id:dashboard.id,displayName:dashboard.name,status:Status.NotLoaded,};}}
getDashboard(dashboardId){const dashboard=this._getDashboard(dashboardId);if(dashboard.status===Status.NotLoaded){dashboard.promise=this._loadDashboardData(dashboardId);}
return dashboard;}
getDashboardGroups(){return this.groups.map((section)=>({id:section.id,name:section.name,dashboards:section.dashboards.map((dashboard)=>({id:dashboard.id,displayName:dashboard.name,status:this._getDashboard(dashboard.id).status,})),}));}
async _fetchGroups(){const groups=await this.orm.webSearchRead("spreadsheet.dashboard.group",[["dashboard_ids","!=",false]],{specification:{name:{},dashboard_ids:{fields:{name:{}}},},});return groups.records;}
_getDashboard(id){if(!this.dashboards[id]){this.dashboards[id]={status:Status.NotLoaded,id,displayName:""};}
return this.dashboards[id];}
async _loadDashboardData(dashboardId){const dashboard=this._getDashboard(dashboardId);dashboard.status=Status.Loading;try{const{snapshot,revisions,default_currency}=await this.orm.call("spreadsheet.dashboard","get_readonly_dashboard",[dashboardId]);dashboard.model=this._createSpreadsheetModel(snapshot,revisions,default_currency);dashboard.status=Status.Loaded;}catch(error){dashboard.error=error;dashboard.status=Status.Error;throw error;}}
_activateFirstSheet(model){const sheetId=model.getters.getActiveSheetId();const firstSheetId=model.getters.getSheetIds()[0];if(firstSheetId!==sheetId){model.dispatch("ACTIVATE_SHEET",{sheetIdFrom:sheetId,sheetIdTo:firstSheetId,});}}
_createSpreadsheetModel(snapshot,revisions=[],defaultCurrency){const dataSources=new DataSources(this.env);const defaultCurrencyFormat=defaultCurrency?createDefaultCurrencyFormat(defaultCurrency):undefined;const model=new Model(migrate(snapshot),{custom:{env:this.env,orm:this.orm,dataSources},mode:"dashboard",defaultCurrencyFormat,},revisions);this._activateFirstSheet(model);dataSources.addEventListener("data-source-updated",()=>model.dispatch("EVALUATE_CELLS"));return model;}}
return __exports;});;

/* /spreadsheet_dashboard/static/src/bundle/dashboard_action/mobile_figure_container/mobile_figure_container.js */
odoo.define('@spreadsheet_dashboard/bundle/dashboard_action/mobile_figure_container/mobile_figure_container',['@odoo/o-spreadsheet','@odoo/owl'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{Component,useSubEnv}=require("@odoo/owl");const{registries}=spreadsheet;const{figureRegistry}=registries;const MobileFigureContainer=__exports.MobileFigureContainer=class MobileFigureContainer extends Component{setup(){useSubEnv({model:this.props.spreadsheetModel,isDashboard:()=>this.props.spreadsheetModel.getters.isDashboard(),openSidePanel:()=>{},});}
get figures(){const sheetId=this.props.spreadsheetModel.getters.getActiveSheetId();return this.props.spreadsheetModel.getters.getFigures(sheetId).sort((f1,f2)=>(this.isBefore(f1,f2)?-1:1)).map((figure)=>({...figure,width:window.innerWidth,height:300,}));}
getFigureComponent(figure){return figureRegistry.get(figure.tag).Component;}
isBefore(f1,f2){return f1.x<f2.x?f1.y<f2.y:f1.y<f2.y;}}
MobileFigureContainer.template="documents_spreadsheet.MobileFigureContainer";MobileFigureContainer.props={spreadsheetModel:Object,};return __exports;});;

/* /spreadsheet_dashboard/static/src/bundle/dashboard_action/mobile_search_panel/mobile_search_panel.js */
odoo.define('@spreadsheet_dashboard/bundle/dashboard_action/mobile_search_panel/mobile_search_panel',['@web/core/l10n/translation','@odoo/owl'],function(require){'use strict';let __exports={};const{_t}=require("@web/core/l10n/translation");const{Component,useState}=require("@odoo/owl");const DashboardMobileSearchPanel=__exports.DashboardMobileSearchPanel=class DashboardMobileSearchPanel extends Component{setup(){this.state=useState({isOpen:false});}
get searchBarText(){return this.props.activeDashboard?this.props.activeDashboard.displayName:_t("Choose a dashboard....");}
onDashboardSelected(dashboardId){this.props.onDashboardSelected(dashboardId);this.state.isOpen=false;}
openDashboardSelection(){const dashboards=this.props.groups.map((group)=>group.dashboards).flat();if(dashboards.length>1){this.state.isOpen=true;}}}
DashboardMobileSearchPanel.template="documents_spreadsheet.DashboardMobileSearchPanel";DashboardMobileSearchPanel.props={onDashboardSelected:Function,groups:Object,activeDashboard:{type:Object,optional:true,},};return __exports;});;

/* /spreadsheet_dashboard/static/src/bundle/list/clickable_cell.js */
odoo.define('@spreadsheet_dashboard/bundle/list/clickable_cell',['@spreadsheet/list/list_actions','@odoo/o-spreadsheet'],function(require){'use strict';let __exports={};const{SEE_RECORD_LIST,SEE_RECORD_LIST_VISIBLE}=require("@spreadsheet/list/list_actions");const spreadsheet=require("@odoo/o-spreadsheet");const{clickableCellRegistry}=spreadsheet.registries;clickableCellRegistry.add("list",{condition:SEE_RECORD_LIST_VISIBLE,execute:SEE_RECORD_LIST,sequence:10,});return __exports;});;

/* /spreadsheet_dashboard/static/src/bundle/pivot/clickable_cell.js */
odoo.define('@spreadsheet_dashboard/bundle/pivot/clickable_cell',['@odoo/o-spreadsheet','@spreadsheet/pivot/pivot_actions'],function(require){'use strict';let __exports={};const spreadsheet=require("@odoo/o-spreadsheet");const{SEE_RECORDS_PIVOT,SEE_RECORDS_PIVOT_VISIBLE,SET_FILTER_MATCHING,SET_FILTER_MATCHING_CONDITION,}=require("@spreadsheet/pivot/pivot_actions");const{clickableCellRegistry}=spreadsheet.registries;clickableCellRegistry.add("pivot",{condition:SEE_RECORDS_PIVOT_VISIBLE,execute:SEE_RECORDS_PIVOT,sequence:3,});clickableCellRegistry.add("pivot_set_filter_matching",{condition:SET_FILTER_MATCHING_CONDITION,execute:SET_FILTER_MATCHING,sequence:2,});return __exports;});

                    /*******************************************
                    *  Templates                               *
                    *******************************************/

                    odoo.define('spreadsheet.o_spreadsheet.bundle.xml', ['@web/core/registry'], function(require){
                        'use strict';
                        const { registry } = require('@web/core/registry');
                        registry.category(`xml_templates`).add(`spreadsheet.o_spreadsheet`, `<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
<t t-name="o-spreadsheet-ActionButton">
    <span t-if="isVisible" class="o-menu-item-button" t-att-title="title" t-att-class="{'o-disabled': !isEnabled, active: isActive}" t-attf-class="{{props.class}}" t-on-click="onClick">
      <span t-if="iconTitle" t-att-style="buttonStyle">
        <t t-call="{{iconTitle}}"/>
      </span>
      <t t-if="props.hasTriangleDownIcon">
        <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
      </t>
    </span>
  </t>

  <t t-name="o-spreadsheet-Ripple">
    <div class="o-ripple-container position-relative" t-att-class="props.class" t-on-click="onClick">
      <div class="position-absolute w-100 h-100">
        <t t-foreach="state.ripples" t-as="ripple" t-key="ripple.id">
          <RippleEffect t-props="getRippleEffectProps(ripple.id)"/>
        </t>
      </div>
      <div class="position-relative" t-ref="childContainer">
        <t t-slot="default"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-RippleEffect">
    <div class="position-absolute" t-att-class="{ 'overflow-hidden': !props.allowOverflow }" t-att-style="props.style">
      <div class="o-ripple position-relative pe-none" t-ref="ripple" t-att-style="rippleStyle"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-Autofill">
    <div class="o-autofill" t-att-style="style"/>
    <div class="o-autofill-handler" t-att-style="handlerStyle" t-on-mousedown="onMouseDown" t-on-dblclick="onDblClick"/>
    <t t-set="tooltip" t-value="getTooltip()"/>
    <div t-if="tooltip" class="o-autofill-nextvalue" t-att-style="styleNextValue">
      <t t-component="tooltip.component" t-props="tooltip.props"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-BorderEditor">
    <t t-set="border_color">Border Color</t>
    <Popover t-props="popoverProps">
      <div class="d-flex o-border-selector" t-on-click.stop="" t-att-class="props.class ? props.class : ''">
        <div class="o-border-selector-section">
          <div t-foreach="BORDER_POSITIONS" t-as="borderPositionsRow" t-key="borderPositionsRow" class="d-flex o-dropdown-button o-dropdown-line">
            <span t-foreach="borderPositionsRow" t-as="borderPosition" t-key="borderPosition" class="o-line-item o-hoverable-button" t-att-class="{active:props.currentBorderPosition === borderPosition[0]}" t-att-name="borderPosition[0]" t-on-click.stop="() =&gt; this.setBorderPosition(borderPosition[0])">
              <t t-call="{{borderPosition[1]}}"/>
            </span>
          </div>
        </div>
        <div class="o-divider"/>
        <div class="o-border-selector-section">
          <div class="m-0 p-0 d-flex align-items-center justify-content-center o-with-color o-hoverable-button" title="Border color" t-on-click.stop="(ev) =&gt; this.toggleDropdownTool('borderColorTool')">
            <ColorPickerWidget currentColor="props.currentBorderColor" toggleColorPicker="(ev) =&gt; this.toggleDropdownTool('borderColorTool')" showColorPicker="state.activeTool === 'borderColorTool'" onColorPicked="(color) =&gt; this.setBorderColor(color)" title="border_color" icon="props.currentBorderColor === '' ? 'o-spreadsheet-Icon.BORDER_NO_COLOR' : 'o-spreadsheet-Icon.BORDER_COLOR'" dropdownMaxHeight="this.props.dropdownMaxHeight" class="'o-dropdown-button o-border-picker-button'"/>
            <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
          </div>
          <div class="o-border-style-tool d-flex align-items-center justify-content-center o-hoverable-button" title="Line style" t-ref="lineStyleButton" t-on-click.stop="(ev) =&gt; this.toggleDropdownTool('borderTypeTool')">
            <t t-call="o-spreadsheet-Icon.BORDER_TYPE"/>
            <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
            <Popover t-props="lineStylePickerPopoverProps" t-if="state.activeTool === 'borderTypeTool'">
              <div class="o-border-style-dropdown">
                <t t-foreach="borderStyles" t-as="borderStyle" t-key="borderStyle">
                  <div t-att-title="borderStyle" t-on-click.stop="() =&gt; this.setBorderStyle(borderStyle)">
                    <div class="d-flex o-dropdown-border-type">
                      <div class="o-dropdown-border-check">
                        <t t-if="props.currentBorderStyle === borderStyle" t-call="o-spreadsheet-Icon.CHECK"/>
                      </div>
                      <div t-attf-class="o-style-preview o-style-{{borderStyle}}"/>
                    </div>
                  </div>
                </t>
              </div>
            </Popover>
          </div>
        </div>
      </div>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-BorderEditorWidget">
    <div class="d-flex position-relative" title="Borders">
      <span t-ref="borderEditorButton" t-on-click.stop="props.toggleBorderEditor" t-att-class="props.class ? props.class : ''" t-att-disabled="props.disabled">
        <span t-att-style="iconStyle">
          <t t-call="o-spreadsheet-Icon.BORDERS"/>
        </span>
      </span>
      <BorderEditor t-if="props.showBorderEditor" onBorderColorPicked.bind="onBorderColorPicked" onBorderStylePicked.bind="onBorderStylePicked" onBorderPositionPicked.bind="onBorderPositionPicked" currentBorderColor="state.currentColor" currentBorderStyle="state.currentStyle" currentBorderPosition="state.currentPosition" maxHeight="props.dropdownMaxHeight" anchorRect="borderEditorAnchorRect"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-BottomBar">
    <div class="o-spreadsheet-bottom-bar o-two-columns d-flex align-items-center overflow-hidden" t-on-click="props.onClick" t-ref="bottomBar" t-on-contextmenu.prevent="">
      <Ripple>
        <div class="o-sheet-item o-add-sheet me-2 p-1" t-if="!env.model.getters.isReadonly()" t-on-click="clickAddSheet">
          <t t-call="o-spreadsheet-Icon.PLUS"/>
        </div>
      </Ripple>
      <Ripple>
        <div class="o-sheet-item o-list-sheets me-2 p-1" t-on-click="clickListSheets">
          <t t-call="o-spreadsheet-Icon.LIST"/>
        </div>
      </Ripple>
      <div class="o-all-sheets position-relative flex-shrink-0 d-flex h-100 me-3">
        <div class="o-bottom-bar-fade-in position-absolute h-100 w-100 pe-none" t-if="state.isSheetListScrollableLeft"/>
        <div class="o-sheet-list d-flex w-100 overflow-hidden px-1" t-ref="sheetList" t-on-wheel="onWheel" t-on-scroll="onScroll">
          <t t-foreach="getVisibleSheets()" t-as="sheet" t-key="sheet.id">
            <BottomBarSheet style="getSheetStyle(sheet.id)" sheetId="sheet.id" openContextMenu="(registry, ev) =&gt; this.onSheetContextMenu(sheet.id, registry, ev)" onMouseDown="(ev) =&gt; this.onSheetMouseDown(sheet.id, ev)"/>
          </t>
        </div>
        <div class="o-bottom-bar-fade-out position-absolute h-100 w-100 pe-none" t-if="state.isSheetListScrollableRight"/>
      </div>
      <div class="o-bottom-bar-arrows d-flex h-100 me-5 align-items-center" t-if="state.isSheetListScrollableLeft || state.isSheetListScrollableRight">
        <Ripple ignoreClickPosition="true" width="20" height="20" offsetX="1" allowOverflow="true" enabled="state.isSheetListScrollableLeft">
          <div class="o-bottom-bar-arrow o-bottom-bar-arrow-left d-flex align-items-center me-2" t-att-class="{'o-disabled': !state.isSheetListScrollableLeft}" t-on-click="onArrowLeft">
            <t t-call="o-spreadsheet-Icon.CARET_LEFT"/>
          </div>
        </Ripple>
        <Ripple ignoreClickPosition="true" width="20" height="20" offsetX="-1" allowOverflow="true" enabled="state.isSheetListScrollableRight">
          <div class="o-bottom-bar-arrow o-bottom-bar-arrow-right d-flex align-items-center me-4" t-att-class="{'o-disabled': !state.isSheetListScrollableRight}" t-on-click="onArrowRight">
            <t t-call="o-spreadsheet-Icon.CARET_RIGHT"/>
          </div>
        </Ripple>
      </div>

      <BottomBarStatistic openContextMenu="(x, y, registry) =&gt; this.openContextMenu(x, y, 'listSelectionStatistics', registry)" closeContextMenu="() =&gt; this.closeContextMenuWithId('listSelectionStatistics')"/>

      <Menu t-if="menuState.isOpen" position="menuState.position" menuItems="menuState.menuItems" maxHeight="menuMaxHeight" onClose="() =&gt; this.closeMenu()" menuId="menuState.menuId"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-BottomBarSheet">
    <Ripple>
      <div class="o-sheet d-flex align-items-center user-select-none text-nowrap " t-on-mousedown="(ev) =&gt; this.onMouseDown(ev)" t-on-contextmenu.prevent="(ev) =&gt; this.onContextMenu(ev)" t-ref="sheetDiv" t-att-style="props.style" t-att-title="sheetName" t-att-data-id="props.sheetId" t-att-class="{active: isSheetActive}">
        <span class="o-sheet-name" t-att-class="{'o-sheet-name-editable': state.isEditing }" t-ref="sheetNameSpan" t-esc="sheetName" t-on-click="(ev) =&gt; this.onClickSheetName(ev)" t-on-dblclick="() =&gt; this.onDblClick()" t-on-focusout="() =&gt; this.onFocusOut()" t-on-keydown="(ev) =&gt; this.onKeyDown(ev)" t-att-contenteditable="state.isEditing ? 'true': 'false'"/>
        <span class="o-sheet-icon ms-1" t-on-click.stop="(ev) =&gt; this.onIconClick(ev)">
          <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
        </span>
      </div>
    </Ripple>
  </t>

  <t t-name="o-spreadsheet-BottomBarStatisic">
    <t t-set="selectedStatistic" t-value="getSelectedStatistic()"/>
    <Ripple class="'ms-auto'" t-if="selectedStatistic !== undefined">
      <div class="o-selection-statistic text-truncate user-select-none me-4 bg-white rounded shadow" t-on-click="listSelectionStatistics">
        <t t-esc="selectedStatistic"/>
        <span class="ms-2">
          <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
        </span>
      </div>
    </Ripple>
  </t>

  <t t-name="o-spreadsheet-ClientTag">
    <div t-if="props.active" class="o-client-tag" t-att-style="tagStyle" t-esc="props.name"/>
  </t>

  <t t-name="o-spreadsheet-ColorPicker">
    <Popover t-props="popoverProps">
      <div class="o-color-picker" t-on-click.stop="" t-att-style="colorPickerStyle">
        <div class="o-color-picker-section-name">Standard</div>
        <div class="colors-grid">
          <div t-foreach="COLORS" t-as="color" t-key="color" class="o-color-picker-line-item" t-att-data-color="color" t-on-click="() =&gt; this.onColorClick(color)" t-attf-style="background-color:{{color}};">
            <div t-if="isSameColor(props.currentColor, color)" align="center" t-attf-style="color:{{checkmarkColor}}">
              ✓
            </div>
          </div>
        </div>
        <div class="o-separator"/>
        <div class="o-color-picker-section-name o-color-picker-toggler" t-on-click="toggleColorPicker">
          <span>Custom</span>
        </div>
        <div class="colors-grid o-color-picker-toggler" t-on-click.stop="toggleColorPicker">
          <div class="o-color-picker-line-item o-color-picker-toggler-button">
            <div class="o-color-picker-toggler-sign">
              <t t-call="o-spreadsheet-Icon.PLUS"/>
            </div>
          </div>
          <div t-foreach="env.model.getters.getCustomColors()" t-as="color" t-key="color" class="o-color-picker-line-item" t-att-data-color="color" t-attf-style="background-color:{{color}};" t-on-click="() =&gt; this.onColorClick(color)">
            <div t-if="isSameColor(props.currentColor, color)" align="center" t-attf-style="color:{{checkmarkColor}}">
              ✓
            </div>
          </div>
        </div>
        <div t-if="state.showGradient" class="o-custom-selector">
          <div class="o-gradient" t-on-click.stop="" t-on-mousedown="dragGradientPointer" t-att-style="gradientHueStyle">
            <div class="saturation w-100 h-100 position-absolute pe-none"/>
            <div class="lightness w-100 h-100 position-absolute pe-none"/>
            <div class="magnifier pe-none" t-att-style="pointerStyle"/>
          </div>
          <div class="o-hue-container" t-on-mousedown="dragHuePointer">
            <div class="o-hue-picker" t-on-click.stop=""/>
            <div class="o-hue-slider pe-none" t-att-style="sliderStyle">
              <t t-call="o-spreadsheet-Icon.TRIANGLE_UP"/>
            </div>
          </div>
          <div class="o-custom-input-preview">
            <input type="text" t-att-class="{'o-wrong-color': !isHexColorInputValid }" t-on-click.stop="" t-att-value="state.customHexColor" t-on-input="setHexColor" maxlength="7"/>
            <div class="o-color-preview" t-att-style="colorPreviewStyle"/>
          </div>
          <div class="o-custom-input-buttons">
            <button class="o-add-button" t-att-class="{'o-disabled': !state.customHexColor or !isHexColorInputValid}" t-on-click.stop="addCustomColor">
              Add
            </button>
          </div>
        </div>
        <div class="o-separator"/>
        <div class="o-buttons">
          <button t-on-click="resetColor" class="o-cancel">No Color</button>
        </div>
      </div>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-ColorPickerWidget">
    <div class="o-color-picker-widget">
      <span class="o-color-picker-button" t-ref="colorPickerButton" t-on-click.stop="props.toggleColorPicker" t-att-title="props.title" t-att-class="props.class ? props.class : 'o-color-picker-button-style'" t-att-disabled="props.disabled">
        <span t-att-style="iconStyle">
          <t t-call="{{props.icon}}"/>
        </span>
      </span>
      <ColorPicker t-if="props.showColorPicker" anchorRect="colorPickerAnchorRect" onColorPicked="props.onColorPicked" currentColor="props.currentColor" maxHeight="props.dropdownMaxHeight"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-TextValueProvider">
    <div t-ref="autoCompleteList" t-att-class="{           'o-autocomplete-dropdown':props.values.length }">
      <t t-foreach="props.values" t-as="v" t-key="v.text">
        <div class="d-flex flex-column text-start" t-att-class="{'o-autocomplete-value-focus': props.selectedIndex === v_index}" t-on-click="() =&gt; this.props.onValueSelected(v.text)" t-on-mousemove="() =&gt; this.props.onValueHovered(v_index)">
          <div class="o-autocomplete-value text-truncate">
            <t t-set="htmlContent" t-value="props.getHtmlContent(v.text)"/>
            <span t-foreach="htmlContent" t-as="content" t-key="content_index" t-att-class="content.class" t-attf-style="color: {{content.color || 'inherit'}};" t-esc="content.value"/>
          </div>
          <div class="o-autocomplete-description text-truncate" t-esc="v.description" t-if="props.selectedIndex === v_index"/>
        </div>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-Composer">
    <div class="o-composer-container w-100 h-100">
      <div class="o-composer w-100 text-start" t-att-class="{ 'text-muted': env.model.getters.isReadonly(), 'active': props.focus !== 'inactive' }" t-att-style="props.inputStyle" t-ref="o_composer" tabindex="1" t-att-contenteditable="env.model.getters.isReadonly() ? 'false' : 'true'" spellcheck="false" t-on-keydown="onKeydown" t-on-mousewheel.stop="" t-on-input="onInput" t-on-mousedown="onMousedown" t-on-click="onClick" t-on-keyup="onKeyup" t-on-paste="onPaste" t-on-compositionstart="onCompositionStart" t-on-compositionend="onCompositionEnd" t-on-dblclick="onDblClick" t-on-contextmenu="onContextMenu"/>

      <div t-if="props.focus !== 'inactive' and (autoCompleteState.showProvider or functionDescriptionState.showDescription)" class="o-composer-assistant shadow" t-att-style="assistantStyle" t-on-wheel.stop="" t-on-mousedown.prevent.stop="" t-on-click.prevent.stop="" t-on-mouseup.prevent.stop="">
        <TextValueProvider t-if="autoCompleteState.showProvider" values="autoCompleteState.values" selectedIndex="autoCompleteState.selectedIndex" onValueSelected.bind="this.autoComplete" onValueHovered.bind="this.updateAutoCompleteIndex" getHtmlContent="autoCompleteState.getHtmlContent"/>
        <FunctionDescriptionProvider t-if="functionDescriptionState.showDescription" functionName="functionDescriptionState.functionName" functionDescription="functionDescriptionState.functionDescription" argToFocus="functionDescriptionState.argToFocus"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FunctionDescriptionProvider">
    <div class="o-formula-assistant-container user-select-none shadow" t-att-class="{           'pe-none': assistantState.allowCellSelectionBehind,           'pe-auto': !assistantState.allowCellSelectionBehind           }">
      <t t-set="context" t-value="getContext()"/>
      <div class="o-formula-assistant" t-if="context.functionName" t-on-mousemove="onMouseMove" t-att-class="{'opacity-25': assistantState.allowCellSelectionBehind}">
        <div class="o-formula-assistant-head">
          <span t-esc="context.functionName"/>
          (
          <t t-foreach="context.functionDescription.args" t-as="arg" t-key="arg.name">
            <span t-if="arg_index &gt; '0'" t-esc="formulaArgSeparator"/>
            <span t-att-class="{ 'o-formula-assistant-focus': context.argToFocus === arg_index }">
              <span>
                <span t-if="arg.optional || arg.repeating || arg.default">[</span>
                <span t-esc="arg.name"/>
                <span t-if="arg.repeating">, ...</span>
                <span t-if="arg.optional || arg.repeating || arg.default">]</span>
              </span>
            </span>
          </t>
          )
        </div>

        <div class="o-formula-assistant-core pb-3 m-3">
          <div class="o-formula-assistant-gray">ABOUT</div>
          <div t-esc="context.functionDescription.description"/>
        </div>

        <t t-foreach="context.functionDescription.args" t-as="arg" t-key="arg.name">
          <div class="o-formula-assistant-arg p-3 pt-0 display-flex flex-column" t-att-class="{                 'o-formula-assistant-gray': context.argToFocus &gt;= '0',                 'o-formula-assistant-focus': context.argToFocus === arg_index,               }">
            <div>
              <span t-esc="arg.name"/>
              <span t-if="arg.optional || arg.repeating || arg.default "> - [optional] </span>
              <span t-if="arg.default">
                <span>default: </span>
                <t t-esc="arg.defaultValue"/>
              </span>
              <span t-if="arg.repeating">repeatable</span>
            </div>
            <div class="o-formula-assistant-arg-description" t-esc="arg.description"/>
          </div>
        </t>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridComposer">
    <div class="o-cell-reference" t-if="shouldDisplayCellReference" t-att-style="cellReferenceStyle" t-esc="cellReference"/>
    <div class="o-grid-composer" t-att-style="containerStyle" t-ref="gridComposer">
      <Composer t-props="composerProps"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-TopBarComposer">
    <div class="o-topbar-composer bg-white user-select-text" t-on-click.stop="" t-att-style="containerStyle">
      <Composer focus="props.focus" inputStyle="composerStyle" onComposerContentFocused="props.onComposerContentFocused"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-SpreadsheetDashboard">
    <div class="o-grid o-two-columns" tabindex="-1" t-on-wheel="onMouseWheel" t-on-click="onClosePopover">
      <div class="mx-auto h-100 position-relative" t-ref="grid" t-att-style="gridContainer">
        <GridOverlay onCellHovered.bind="onCellHovered" onGridResized.bind="onGridResized" onGridMoved.bind="moveCanvas" gridOverlayDimensions="gridOverlayDimensions"/>
        <canvas t-ref="canvas"/>
        <GridPopover hoveredCell="hoveredCell" gridRect="getGridRect()" onMouseWheel.bind="onMouseWheel" onClosePopover.bind="onClosePopover"/>
        <div t-foreach="getClickableCells()" t-as="clickableCell" t-key="clickableCell_index" class="o-dashboard-clickable-cell" t-on-click="() =&gt; this.selectClickableCell(clickableCell)" t-on-contextmenu.prevent="" t-att-style="getCellClickableStyle(clickableCell.coordinates)"/>
        <FilterIconsOverlay/>
      </div>
      <VerticalScrollBar/>
      <HorizontalScrollBar/>
      <div class="o-scrollbar corner"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationOverlay">
    <t t-foreach="checkBoxCellPositions" t-as="position" t-key="'checkbox'+position_index">
      <GridCellIcon cellPosition="position">
        <DataValidationCheckbox cellPosition="position"/>
      </GridCellIcon>
    </t>

    <t t-foreach="listIconsCellPositions" t-as="position" t-key="'list'+position_index">
      <GridCellIcon cellPosition="position" horizontalAlign="'right'">
        <DataValidationListIcon cellPosition="position"/>
      </GridCellIcon>
    </t>
  </t>

  <t t-name="o-spreadsheet-DataValidationCheckbox">
    <input type="checkbox" class="o-dv-checkbox" t-att-class="{'pe-none': isDisabled}" t-on-change="onCheckboxChange" t-att-checked="checkBoxValue"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationListIcon">
    <div class="o-dv-list-icon d-flex align-items-center justify-content-center" t-on-click="onClick">
      <t t-call="o-spreadsheet-Icon.CARET_DOWN"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-ErrorToolTip">
    <div class="o-error-tooltip">
      <t t-foreach="props.errors" t-as="error" t-key="error_index">
        <div class="o-error-tooltip-title fw-bold text-danger">
          <t t-esc="error.title"/>
        </div>
        <div class="o-error-tooltip-message">
          <t t-esc="error.message"/>
        </div>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ChartJsComponent">
    <canvas class="o-figure-canvas w-100 h-100" t-att-style="canvasStyle" t-ref="graphContainer"/>
  </t>

  <t t-name="o-spreadsheet-ScorecardChart">
    <canvas class="o-figure-canvas w-100 h-100" t-ref="chartContainer"/>
  </t>

  <t t-name="o-spreadsheet-FigureComponent">
    <div class="o-figure-wrapper pe-auto" t-att-style="wrapperStyle">
      <div class="o-figure w-100 h-100" t-on-mousedown.stop="(ev) =&gt; this.onMouseDown(ev)" t-on-contextmenu.prevent.stop="(ev) =&gt; !env.model.getters.isReadonly() and this.onContextMenu(ev)" t-ref="figure" t-att-style="props.style" t-att-data-id="props.figure.id" tabindex="0" t-on-keydown="(ev) =&gt; this.onKeyDown(ev)" t-on-keyup.stop="" t-on-click="() =&gt; this.onClick()" t-att-role="env.isDashboard() and hasOdooMenu ? &quot;button&quot; : &quot;&quot;">
        <t t-component="figureRegistry.get(props.figure.tag).Component" t-key="props.figure.id" onFigureDeleted="props.onFigureDeleted" figure="props.figure"/>
        <div class="o-figure-menu position-absolute m-2" t-if="!env.isDashboard()">
            <div t-if="hasOdooMenu and !env.isDashboard()" class="o-figure-menu-item o-chart-external-link" t-on-click="navigateToOdooMenu">
                <span class="fa fa-external-link"/>
            </div>
          <div class="o-figure-menu-item" t-if="!env.model.getters.isReadonly()" t-on-click="showMenu" t-ref="menuButton" t-on-contextmenu.prevent.stop="showMenu">
            <t t-call="o-spreadsheet-Icon.LIST"/>
          </div>
          <Menu t-if="menuState.isOpen" position="menuState.position" menuItems="menuState.menuItems" onClose="() =&gt; this.menuState.isOpen=false"/>
        </div>
      </div>
      <div class="o-figure-border w-100 h-100 position-absolute pe-none" t-att-style="borderStyle"/>
      <t t-if="isSelected">
        <div class="o-fig-anchor o-top" t-att-style="this.getResizerPosition('top')" t-on-mousedown="(ev) =&gt; this.clickAnchor(0,-1, ev)"/>
        <div class="o-fig-anchor o-topRight" t-att-style="this.getResizerPosition('top right')" t-on-mousedown="(ev) =&gt; this.clickAnchor(1,-1, ev)"/>
        <div class="o-fig-anchor o-right" t-att-style="this.getResizerPosition('right')" t-on-mousedown="(ev) =&gt; this.clickAnchor(1,0, ev)"/>
        <div class="o-fig-anchor o-bottomRight" t-att-style="this.getResizerPosition('bottom right')" t-on-mousedown="(ev) =&gt; this.clickAnchor(1,1, ev)"/>
        <div class="o-fig-anchor o-bottom" t-att-style="this.getResizerPosition('bottom')" t-on-mousedown="(ev) =&gt; this.clickAnchor(0,1, ev)"/>
        <div class="o-fig-anchor o-bottomLeft" t-att-style="this.getResizerPosition('bottom left')" t-on-mousedown="(ev) =&gt; this.clickAnchor(-1,1, ev)"/>
        <div class="o-fig-anchor o-left" t-att-style="this.getResizerPosition('left')" t-on-mousedown="(ev) =&gt; this.clickAnchor(-1,0, ev)"/>
        <div class="o-fig-anchor o-topLeft" t-att-style="this.getResizerPosition('top left')" t-on-mousedown="(ev) =&gt; this.clickAnchor(-1,-1, ev)"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ChartFigure">
    <div class="o-chart-container w-100 h-100" t-on-dblclick="onDoubleClick">
      <t t-component="chartComponent" figure="this.props.figure" t-key="this.props.figure.id + '-' + chartType"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-FiguresContainer">
    <div>
      <t t-foreach="containers" t-as="container" t-key="container.type">
        <div class="o-figure-container position-absolute pe-none overflow-hidden" t-att-style="container.style" t-att-data-id="container.type + 'Container'">
          <div class="o-figure-viewport-inverse w-0 h-0 overflow-visible position-absolute" t-att-style="container.inverseViewportStyle">
            <t t-foreach="container.figures" t-as="figure" t-key="figure.id">
              <FigureComponent onFigureDeleted="this.props.onFigureDeleted" figure="figure" style="getFigureStyle(figure)" onMouseDown="(ev) =&gt; this.startDraggingFigure(figure, ev)" onClickAnchor="(dirX, dirY, ev) =&gt; this.startResize(figure, dirX, dirY, ev)"/>
            </t>
          </div>
        </div>
      </t>
    </div>
    <div class="o-figure-container position-absolute pe-none overflow-hidden" t-if="dnd.horizontalSnap" t-att-style="dnd.horizontalSnap.containerStyle" t-att-data-id="'HorizontalSnapContainer'">
      <div class="o-figure-snap-line horizontal" t-att-style="dnd.horizontalSnap.lineStyle"/>
    </div>
    <div class="o-figure-container position-absolute pe-none overflow-hidden" t-if="dnd.verticalSnap" t-att-style="dnd.verticalSnap.containerStyle" t-att-data-id="'VerticalSnapContainer'">
      <div class="o-figure-snap-line vertical" t-att-style="dnd.verticalSnap.lineStyle"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-ImageFigure">
    <img t-att-src="getImagePath" class="w-100 h-100"/>
  </t>

  <t t-name="o-spreadsheet-FilterIcon">
    <div class="o-filter-icon" t-on-click.stop="onClick">
      <t t-if="isFilterActive" t-call="o-spreadsheet-Icon.FILTER_ICON_ACTIVE"/>
      <t t-else="" t-call="o-spreadsheet-Icon.FILTER_ICON"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-FilterIconsOverlay">
    <t t-foreach="getFilterHeadersPositions()" t-as="position" t-key="'filter'+position.col + '_' + position.row">
      <GridCellIcon cellPosition="position" offset="props.gridPosition" horizontalAlign="'right'">
        <FilterIcon cellPosition="position"/>
      </GridCellIcon>
    </t>
  </t>

  <t t-name="o-spreadsheet-FilterMenu">
    <div class="o-filter-menu d-flex flex-column bg-white" t-on-wheel.stop="">
      <div t-if="!isReadonly">
        <div class="o-filter-menu-item" t-on-click="() =&gt; this.sortFilterZone('ascending')">
          Sort ascending (A ⟶ Z)
        </div>
        <div class="o-filter-menu-item" t-on-click="() =&gt; this.sortFilterZone('descending')">
          Sort descending (Z ⟶ A)
        </div>
      </div>
      <div class="o-separator" t-if="!isReadonly"/>
      <div class="o-filter-menu-actions">
        <div class="o-filter-menu-action-text" t-on-click="selectAll">Select all</div>
        <div class="o-filter-menu-action-text" t-on-click="clearAll">Clear</div>
      </div>
      <div class="position-relative">
        <input class="w-100" t-ref="filterMenuSearchBar" type="text" t-model="state.textFilter" placeholder="Search..." t-on-keydown="onKeyDown"/>
        <i class="o-search-icon position-absolute">
          <t t-call="o-spreadsheet-Icon.SEARCH"/>
        </i>
      </div>
      <div class="o-filter-menu-list d-flex flex-column rounded" t-ref="filterValueList" t-on-click="this.clearScrolledToValue" t-on-scroll="this.clearScrolledToValue">
        <t t-foreach="displayedValues" t-as="value" t-key="value.string">
          <FilterMenuValueItem onClick="() =&gt; this.checkValue(value)" onMouseMove="() =&gt; this.onMouseMove(value)" value="value.string" isChecked="value.checked" isSelected="value.string === state.selectedValue" scrolledTo="value.scrolledTo"/>
        </t>
        <div t-if="displayedValues.length === 0" class="o-filter-menu-no-values d-flex align-items-center justify-content-center w-100 h-100 ">
          No results
        </div>
      </div>
      <div class="o-filter-menu-buttons d-flex justify-content-end">
        <div class="o-filter-menu-button o-filter-menu-button-cancel" t-on-click="cancel">
          Cancel
        </div>
        <div class="o-filter-menu-button o-filter-menu-button-primary" t-on-click="confirm">
          Confirm
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FilterMenuValueItem">
    <div t-on-click="this.props.onClick" t-on-mousemove="this.props.onMouseMove" class="o-filter-menu-item o-filter-menu-value" t-ref="menuValueItem" t-att-class="{'selected': this.props.isSelected}">
      <div>
        <div class="o-filter-menu-value-checked">
          <span t-if="this.props.isChecked">✓</span>
        </div>
      </div>
      <div class="o-filter-menu-value-text text-truncate">
        <t t-if="this.props.value === ''">(Blanks)</t>
        <t t-else="" t-esc="this.props.value"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FontSizeEditor">
    <div class="o-dropdown" t-ref="FontSizeEditor">
      <div class=" o-font-size-editor d-flex align-items-center" t-att-class="props.class" title="Font Size" t-on-click="this.toggleFontList">
        <input type="number" min="1" max="400" class="o-font-size bg-transparent border-0" t-on-keydown="onInputKeydown" t-on-click.stop="" t-on-focus.stop="onInputFocused" t-att-value="currentFontSize" t-on-change="setSizeFromInput" t-ref="inputFontSize"/>
        <span>
          <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
        </span>
      </div>
      <div class="o-dropdown-content o-text-options" t-if="dropdown.isOpen" t-on-click.stop="" t-att-style="props.dropdownStyle">
        <t t-foreach="fontSizes" t-as="fontSize" t-key="fontSize">
          <div t-esc="fontSize" t-att-data-size="fontSize" t-on-click="() =&gt; this.setSizeFromList(fontSize)"/>
        </t>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-Grid">
    <div class="o-grid w-100 h-100" tabindex="-1" t-on-click="focusDefaultElement" t-on-keydown="onKeydown" t-on-wheel="onMouseWheel" t-ref="grid">
      <GridOverlay onCellClicked.bind="onCellClicked" onCellDoubleClicked.bind="onCellDoubleClicked" onCellRightClicked.bind="onCellRightClicked" onCellHovered.bind="onCellHovered" onGridResized.bind="onGridResized" onGridMoved.bind="moveCanvas" gridOverlayDimensions="gridOverlayDimensions" onFigureDeleted.bind="focusDefaultElement"/>
      <HeadersOverlay onOpenContextMenu="(type, x, y) =&gt; this.toggleContextMenu(type, x, y)"/>
      <GridComposer focus="props.focusComposer" onComposerContentFocused="props.onComposerContentFocused" onComposerCellFocused="props.onGridComposerCellFocused" gridDims="env.model.getters.getSheetViewDimensionWithHeaders()" onInputContextMenu.bind="onInputContextMenu"/>
      <canvas t-ref="canvas"/>
      <t t-foreach="env.model.getters.getClientsToDisplay()" t-as="client" t-key="getClientPositionKey(client)">
        <ClientTag name="client.name" color="client.color" col="client.position.col" row="client.position.row" active="isCellHovered(client.position.col, client.position.row)"/>
      </t>
      <GridPopover t-if="!menuState.isOpen" hoveredCell="hoveredCell" gridRect="getGridRect()" onMouseWheel.bind="onMouseWheel" onClosePopover.bind="onClosePopover"/>
      <t t-if="env.model.getters.getEditionMode() === 'inactive'">
        <Autofill position="getAutofillPosition()" isVisible="isAutofillVisible"/>
      </t>
      <t t-foreach="env.model.getters.getHighlights()" t-as="highlight" t-key="highlight_index">
        <t t-if="highlight.sheetId === env.model.getters.getActiveSheetId()">
          <Highlight zone="highlight.zone" color="highlight.color"/>
        </t>
      </t>
      <Menu t-if="menuState.isOpen" menuItems="menuState.menuItems" position="menuState.position" onClose="() =&gt; this.closeMenu()"/>
      <FilterIconsOverlay gridPosition="{ x: HEADER_WIDTH, y : HEADER_HEIGHT }"/>
      <VerticalScrollBar topOffset="HEADER_HEIGHT"/>
      <HorizontalScrollBar leftOffset="HEADER_WIDTH"/>
      <div class="o-scrollbar corner"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridAddRowsFooter">
    <div class="o-grid-add-rows mt-2 ms-2 w-100 d-flex position-relative align-items-center" t-att-style="addRowsPosition" t-on-mousedown.stop.prevent="">
      <button t-on-click="onConfirm" t-att-disabled="state.errorFlag" class="o-button o-button-grey">
        Add
      </button>
      <input type="text" class="o-grid-add-rows-input o-input mt-0 me-2" t-ref="inputRef" value="100" t-on-click.stop="" t-on-keydown.stop="onKeydown" t-on-mousedown.stop="" t-on-input.stop="onInput"/>
      <span>more rows at the bottom</span>
      <ValidationMessages t-if="state.errorFlag" messages="errorMessages" msgType="'error'"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridCellIcon">
    <div class="o-grid-cell-icon position-absolute overflow-hidden" t-if="isPositionVisible(this.props.cellPosition)" t-att-style="iconStyle">
      <t t-slot="default"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridOverlay">
    <div t-ref="gridOverlay" class="o-grid-overlay overflow-hidden" t-att-class="{'o-paint-format-cursor': isPaintingFormat}" t-att-style="style" t-on-mousedown="onMouseDown" t-on-dblclick.self="onDoubleClick" t-on-contextmenu.stop.prevent="onContextMenu">
      <FiguresContainer onFigureDeleted="props.onFigureDeleted"/>
      <DataValidationOverlay/>
      <GridAddRowsFooter t-if="!env.model.getters.isReadonly()" t-key="env.model.getters.getActiveSheetId()" focusGrid="props.onFigureDeleted"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-GridPopover">
    <Popover t-if="cellPopover.isOpen" positioning="cellPopover.cellCorner" maxHeight="cellPopover.Component.size and cellPopover.Component.size.maxHeight" maxWidth="cellPopover.Component.size and cellPopover.Component.size.maxHidth" anchorRect="cellPopover.anchorRect" containerRect="env.getPopoverContainerRect()" onMouseWheel="props.onMouseWheel" zIndex="zIndex">
      <t t-component="cellPopover.Component" t-props="{...cellPopover.props, onClosed : () =&gt; props.onClosePopover()}"/>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-HeaderGroup">
    <div class="o-header-group position-absolute" t-att-style="groupBoxStyle" t-att-data-id="props.group.start + '-' + props.group.end" t-on-click="toggleGroup" t-on-contextmenu.stop.prevent="onContextMenu">
      <div class="o-header-group-header position-absolute d-flex align-items-center justify-content-center overflow-hidden" t-att-style="groupHeaderStyle">
        <div class="o-group-fold-button user-select-none rounded d-flex align-items-center justify-content-center" t-att-style="groupButtonStyle">
          <t t-call="{{groupButtonIcon}}"/>
        </div>
      </div>
      <div class="o-group-border position-absolute" t-if="!isGroupFolded" t-att-style="groupBorderStyle"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-HeaderGroupContainer">
    <div class="o-header-group-container d-flex w-100 h-100 overflow-hidden" t-att-class="{         'flex-column': props.dimension === 'ROW',         'flex-row': props.dimension === 'COL',       }" t-if="props.layers.length" t-on-contextmenu.prevent="onContextMenu">
      <div class="o-header-group-frozen-pane flex-shrink-0 overflow-hidden position-relative" t-att-class="{           'o-group-rows': props.dimension === 'ROW',           'o-group-columns': props.dimension === 'COL',         }" t-if="hasFrozenPane" t-att-style="frozenPaneContainerStyle">
        <t t-foreach="props.layers" t-as="layer" t-key="layer_index">
          <t t-foreach="layer" t-as="group" t-key="group.start + '-' + group.end">
            <t t-component="groupComponent" group=" group" layerOffset="getLayerOffset(layer_index)" openContextMenu.bind="openContextMenu"/>
          </t>
        </t>
      </div>
      <div class="o-header-group-frozen-pane-border" t-att-class="{           'o-group-rows': props.dimension === 'ROW',           'o-group-columns': props.dimension === 'COL',         }" t-if="hasFrozenPane"/>

      <div class="o-header-group-main-pane flex-shrink-0 position-relative h-100 w-100 overflow-hidden" t-att-class="{           'o-group-rows': hasFrozenPane and props.dimension === 'ROW',           'o-group-columns': hasFrozenPane and props.dimension === 'COL',         }">
        <div class="o-header-group-scroll-container position-relative" t-att-style="scrollContainerStyle">
          <t t-foreach="props.layers" t-as="layer" t-key="layer_index">
            <t t-foreach="layer" t-as="group" t-key="group.start + '-' + group.end">
              <t t-component="groupComponent" group="group" layerOffset="getLayerOffset(layer_index)" openContextMenu.bind="openContextMenu"/>
            </t>
          </t>
        </div>
      </div>

      <Menu t-if="menu.isOpen" menuItems="menu.menuItems" position="menu.position" onClose.bind="this.closeMenu"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-HeadersOverlay">
    <div class="o-overlay">
      <ColResizer onOpenContextMenu="props.onOpenContextMenu"/>
      <RowResizer onOpenContextMenu="props.onOpenContextMenu"/>
      <div class="all" t-on-mousedown.self="selectAll"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-RowResizer">
    <div class="o-row-resizer" t-on-mousemove.self="onMouseMove" t-on-mouseleave="onMouseLeave" t-on-mousedown.self.prevent="select" t-ref="rowResizer" t-on-mouseup.self="onMouseUp" t-on-contextmenu.self="onContextMenu" t-att-class="{'o-grab': state.waitingForMove, 'o-dragging': state.isMoving}">
      <div t-if="state.isMoving" class="dragging-row-line" t-attf-style="top:{{state.draggerLinePosition}}px;"/>
      <div t-if="state.isMoving" class="dragging-row-shadow" t-attf-style="top:{{state.draggerShadowPosition}}px; height:{{state.draggerShadowThickness}}px;"/>
      <t t-if="state.resizerIsActive">
        <div class="o-handle" t-on-mousedown="onMouseDown" t-on-dblclick="onDblClick" t-on-contextmenu.prevent="" t-attf-style="top:{{state.draggerLinePosition - 2}}px;">
          <div class="dragging-resizer" t-if="state.isResizing"/>
        </div>
      </t>
      <t t-foreach="env.model.getters.getHiddenRowsGroups(env.model.getters.getActiveSheetId())" t-as="hiddenItem" t-key="hiddenItem_index">
        <t t-if="!hiddenItem.includes(0)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="top:{{unhideStyleValue(hiddenItem[0]) - 17}}px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_UP"/>
          </div>
        </t>
        <t t-if="!hiddenItem.includes(env.model.getters.getNumberRows(env.model.getters.getActiveSheetId())-1)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="top:{{unhideStyleValue(hiddenItem[0]) + 3}}px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_DOWN"/>
          </div>
        </t>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ColResizer">
    <div class="o-col-resizer" t-on-mousemove.self="onMouseMove" t-on-mouseleave="onMouseLeave" t-on-mousedown.self.prevent="select" t-ref="colResizer" t-on-mouseup.self="onMouseUp" t-on-contextmenu.self="onContextMenu" t-att-class="{'o-grab': state.waitingForMove, 'o-dragging': state.isMoving, }">
      <div t-if="state.isMoving" class="dragging-col-line" t-attf-style="left:{{state.draggerLinePosition}}px;"/>
      <div t-if="state.isMoving" class="dragging-col-shadow" t-attf-style="left:{{state.draggerShadowPosition}}px; width:{{state.draggerShadowThickness}}px"/>
      <t t-if="state.resizerIsActive">
        <div class="o-handle" t-on-mousedown="onMouseDown" t-on-dblclick="onDblClick" t-on-contextmenu.prevent="" t-attf-style="left:{{state.draggerLinePosition - 2}}px;">
          <div class="dragging-resizer" t-if="state.isResizing"/>
        </div>
      </t>
      <t t-foreach="env.model.getters.getHiddenColsGroups(env.model.getters.getActiveSheetId())" t-as="hiddenItem" t-key="hiddenItem_index">
        <t t-if="!hiddenItem.includes(0)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="left:{{unhideStyleValue(hiddenItem[0]) - 17}}px; margin-right:6px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_LEFT"/>
          </div>
        </t>
        <t t-if="!hiddenItem.includes(env.model.getters.getNumberCols(env.model.getters.getActiveSheetId())-1)">
          <div class="o-unhide" t-att-data-index="hiddenItem_index" t-attf-style="left:{{unhideStyleValue(hiddenItem[0]) + 3}}px;" t-on-click="() =&gt; this.unhide(hiddenItem)">
            <t t-call="o-spreadsheet-Icon.TRIANGLE_RIGHT"/>
          </div>
        </t>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-Border">
    <div class="o-border" t-on-mousedown.prevent="onMouseDown" t-att-style="style" t-att-class="{           'o-moving': props.isMoving,           'o-border-n': props.orientation === 'n',           'o-border-s': props.orientation === 's',           'o-border-w': props.orientation === 'w',           'o-border-e': props.orientation === 'e',         }"/>
  </t>

  <t t-name="o-spreadsheet-Corner">
    <div class="o-corner" t-on-mousedown.prevent="onMouseDown" t-att-style="style" t-att-class="{           'o-resizing': props.isResizing,           'o-corner-nw': props.orientation === 'nw',           'o-corner-ne': props.orientation === 'ne',           'o-corner-sw': props.orientation === 'sw',           'o-corner-se': props.orientation === 'se',         }"/>
  </t>

  <t t-name="o-spreadsheet-Highlight">
    <div class="o-highlight" t-ref="highlight">
      <t t-foreach="['n', 's', 'w', 'e']" t-as="orientation" t-key="orientation">
        <Border onMoveHighlight="(x, y) =&gt; this.onMoveHighlight(x,y)" isMoving="highlightState.shiftingMode === &quot;isMoving&quot;" orientation="orientation" zone="props.zone"/>
      </t>
      <t t-foreach="['nw', 'ne', 'sw', 'se']" t-as="orientation" t-key="orientation">
        <Corner onResizeHighlight="(isLeft, isTop) =&gt; this.onResizeHighlight(isLeft, isTop)" isResizing="highlightState.shiftingMode === &quot;isResizing&quot;" orientation="orientation" zone="props.zone" color="props.color"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-IconPicker">
    <div class="o-icon-picker">
      <t t-foreach="iconSets" t-as="iconSet" t-key="iconSet">
        <div class="o-cf-icon-line">
          <div class="o-icon-picker-item" t-on-click="() =&gt; this.onIconClick(iconSets[iconSet].good)">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].good].template}}"/>
          </div>
          <div class="o-icon-picker-item" t-on-click="() =&gt; this.onIconClick(iconSets[iconSet].neutral)">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].neutral].template}}"/>
          </div>
          <div class="o-icon-picker-item" t-on-click="() =&gt; this.onIconClick(iconSets[iconSet].bad)">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].bad].template}}"/>
          </div>
        </div>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-Icon.CLEAR_AND_RELOAD">
    <svg class="o-icon">
      <path fill="currentColor" d="M14 15H4V3h6v3h4M4 1.5A1.5 1.5 0 0 0 2.5 3v12a1.5 1.5 0 0 0 1.4 1.5h10a1.5 1.5 0 0 0 1.5-1.5V5l-3.5-3.5         "/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.EXPORT_XLSX">
    <svg class="o-icon">
      <path fill="currentColor" d="M0 1a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1m4-4V1H1v3m7 0V1H5v3M4 8V5H1v3m7 0V5H5v3m-3.5 2h2v4h3v-1.5l3 2.5-3 2.5V16h-5m9.5-6h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1h-6a1 1 0 0 1-1-1v-6a1 1 0 0 1 1-1m1.7 7 1.3-2 1.3 2h2l-2-3 2-3h-2L14 13l-1.3-2h-2l2 3-2 3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.OPEN_READ_ONLY">
    <svg class="o-icon">
      <path fill="currentColor" d="M13 7V5c0-2.5-2-4-4-4S5 2.5 5 5v2h-.5C3.5 7 3 7.5 3 8.5v7c0 1 .5 1.5 1.5 1.5h9c1 0 1.5-.5 1.5-1.5v-7c0-1-.5-1.5-1.5-1.5m-7-2c0-1.5 1-2.5 2.5-2.5s2.5 1 2.5 2.5v2h-5V5m1 7a1.5 1.5 0 0 1 3 0 1.5 1.5 0 0 1-3 0"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.OPEN_DASHBOARD">
    <svg class="o-icon">
      <path fill="currentColor" d="M13 2.07A8 8 0 1 0 15.93 5L14.2 6A6 6 0 1 1 12 3.8m-2 3.47a2 2 0 1 0 .73.73l5.5-5.5-.6-.6M9.3 3.8a.6.6 0 1 1-.01-.01m1.81.51a.6.6 0 1 1-.01-.01M7.5 4.3a.6.6 0 1 1-.01-.01M5.9 5.4a.6.6 0 1 1-.01-.01M4.8 6.9a.6.6 0 1 1-.01-.01m8.71.61a.6.6 0 1 0-.01 0"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.OPEN_READ_WRITE">
    <svg class="o-icon">
      <path fill="currentColor" d="M13 7V5a4 4 0 0 0-8 0v2h-.5C3.5 7 3 7.5 3 8.5v7c0 1 .5 1.5 1.5 1.5h9c1 0 1.5-.5 1.5-1.5v-7c0-1-.5-1.5-1.5-1.5m-7-2a2 2 0 0 1 5 0v2h-5m1 5a1.5 1.5 0 0 1 3 0 1.5 1.5 0 0 1-3 0m6 3.5h-9v-7h9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.IMPORT_XLSX">
    <svg class="o-icon">
      <path fill="currentColor" d="M9 10a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1m4-4v-3h-3v3m7 0v-3h-3v3m-1 4v-3h-3v3m7 0v-3h-3v3M.5 9h2v4h3v-1.5l3 2.5-3 2.5V15h-5M1 0h6a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V1a1 1 0 0 1 1-1m1.7 7L4 5l1.3 2h2l-2-3 2-3h-2L4 3 2.7 1h-2l2 3-2 3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNDO">
    <svg class="o-icon">
      <path fill="currentColor" d="M5.43 9.43 8 12H1V5l2.96 2.958A8.29 8.29 0 0 1 9.32 6c3.46 0 6.42 2.11 7.68 5l-2 1c-.94-2.39-3.13-3.92-5.68-4a6.57 6.57 0 0 0-3.89 1.43"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.REDO">
    <svg class="o-icon">
      <path fill="currentColor" d="M12.57 9.43 10 12h7V5l-2.96 2.96A8.29 8.29 0 0 0 8.68 6C5.22 6 2.26 8.11 1 11l2 1c.94-2.39 3.13-3.92 5.68-4a6.58 6.58 0 0 1 3.89 1.43"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.COPY">
    <svg class="o-icon">
      <path fill="currentColor" d="M14.5 15.23v1.5H3a1 1 0 0 1-1-1V3.23h1.5v11a1 1 0 0 0 1 1h10m0-3.5a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-8a1 1 0 0 1 1-1h6.5a1 1 0 0 1 1 1m-9-2.5a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1H15a1 1 0 0 0 1-1v-11a1 1 0 0 0-1-1"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CUT">
    <svg class="o-icon">
      <path fill="currentColor" d="M3 2v2l4.5 5-1.2 1.3c-.4-.2-.8-.3-1.3-.3-1.7 0-3 1.3-3 3s1.3 3 3 3 3-1.3 3-3c0-.5-.1-.9-.3-1.3L9 10.4l1.3 1.3c-.2.4-.3.8-.3 1.3 0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3c-.5 0-.9.1-1.3.3L10.4 9 15 4.4V2h-.4L9 7.6 3.4 2H3Zm2 12.5c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5Zm9.5-1.5c0 .8-.7 1.5-1.5 1.5s-1.5-.7-1.5-1.5.7-1.5 1.5-1.5 1.5.7 1.5 1.5ZM9 8.5c.3 0 .5.2.5.5s-.2.5-.5.5-.5-.2-.5-.5.2-.5.5-.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PASTE">
    <svg class="o-icon">
      <path fill="currentColor" d="M14.5 2.5H11C10.7 1.6 10 1 9 1s-1.5.5-2 1.5H3.5C2.5 2.5 2 3 2 4v11c0 1 .5 1.5 1.5 1.5h11c1 0 1.5-.5 1.5-1.5V4c0-1-.5-1.5-1.5-1.5Zm-4.75.75c0 .5-.34.75-.75.75s-.75-.34-.75-.75.34-.75.75-.75.75.34.75.75ZM14.5 15h-11V4H5v2.5h8V4h1.5v11"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FIND_AND_REPLACE">
    <svg class="o-icon">
      <path fill="currentColor" d="M10.75 11.25c-1 .75-2.25 1.25-3.5 1.25-3 0-5.5-2.5-5.5-5.5s2.5-5.5 5.5-5.5 5.5 2.5 5.5 5.5c0 1.25-.5 2.5-1.25 3.5l.25.25h.75l4 4-1.5 1.5-4-4v-.75l-.25-.25ZM7.25 11c2.25 0 4-1.75 4-4s-1.75-4-4-4-4 1.75-4 4 1.75 4 4 4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DELETE">
    <svg class="o-icon">
      <path fill="currentColor" d="M12 1.75v-1H6v1H1.5v2h1v12a1.5 1.5 0 0 0 1.5 1.5h10a1.5 1.5 0 0 0 1.5-1.5v-12h1v-2M4 15.75v-12h10v12Zm2-10.5h2v9H6Zm4 0h2v9h-2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CLEAR">
    <svg class="o-icon">
      <path fill="currentColor" d="M1.5 15a.75.75 0 0 0 0 1.5h15a.75.75 0 0 0 0-1.5M5.3 12.75c.1.1.3.2.5.2h4c.2 0 .4-.1.5-.2l5.5-5.5c.2-.3.2-.6 0-.8l-4.4-4.4c-.3-.2-.6-.2-.8 0l-4.8 4.8c-2.7 2.9-3.1 2.8-2.4 4M7 7.25l3.6 3.6-1 1-3.6.1-1.8-1.9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FREEZE">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 17.5h16a1 1 0 0 0 1-1v-15a1 1 0 0 0-1-1h-15a1 1 0 0 0-1 1v15a1 1 0 0 0 1 1m9-10.5v4.5H6V7m0 9v-3.5h4.5V16M5 16H3.5L5 14.5M5 13l-3 3v-1.5l3-3M2 13v-2l3-3v2m-3-.5v-2l3-3v2M2 6V4l2-2h1v1m11 13h-4.5v-3.5H16m0-1h-4.5V7H16m0-5v4h-4.5V2m-1 4H6V2h4.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNFREEZE">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 17.5h16a1 1 0 0 0 1-1v-15a1 1 0 0 0-1-1h-15a1 1 0 0 0-1 1v15a1 1 0 0 0 1 1M5 6H2V2h3m0 9.5H2V7h3m0 9H2v-3.5h3M10.5 7v4.5H6V7m0 9v-3.5h4.5V16m5.5 0h-4.5v-3.5H16m0-1h-4.5V7H16m0-5v4h-4.5V2m-1 4H6V2h4.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SHOW_HIDE_GRID">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v7H11V7H7v4s-.5 0-1.5 1h-1v5h-3a1.5 1.5 0 0 1-1-1M6 6V2H2v4m9 0V2H7v4m9 0V2h-4v4m-6 5V7H2v4m14-2V7h-4v2m-7.5 6.5V12H2v3.5 M14 10.5c1 0 1 .5 1 1-1.5 2.5-3.5 4.5-5 6.5-.5 0-1-.5-1-1-1-.5-1.5-1-2.5-2 0 0-.5-.5 0-1 1.5-2 4-3 7-3m-1 1.5C13.5 12 4 14 10 16c0 0-1.5-2 2.5-3.5m5 1.5c.5.5.5 1 .5 1-1.5 2-3.5 3-6 2.5.5-.5.5-1 1-1s5.5-1 2-3.5l1-1"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SHOW_HIDE_FORMULA">
    <svg class="o-icon">
      <path fill="currentColor" d="M7 14.25q-.25.75-.75 1.25T5 16q-.75 0-1.5-.5Q3 15 3 14.25q0-.5.25-.75t.75-.25q.25 0 .25.75v.5H5q.5 0 .5-.5l1.25-6.5H5V6h2l.5-2.25q.25-.75.75-1.25T9.5 2q1 0 1.5.5t.5 1q0 .5-.25.75t-.5.25q-.5 0-.75-.25t-.25-.5V3H9.5q-.25 0-.5.5L8.5 6H10v1.5H8.25m1.25 1H15v1h-4l2 2-2 2h4v1H9V14l2.5-2.5L9 9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.HIDE_ROW">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v3.5h14V2H2v9h14V7H2v9h14v-3.5H2M1 12l4-5h2l-4 5m2 0 4-5h2l-4 5m2 0 4-5h2l-4 5m2 0 4-5v4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.HIDE_COL">
    <svg class="o-icon">
      <path fill="currentColor" d="M16 .5A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2A1.5 1.5 0 0 1 2 .5h14V2h-3.5v14H16V2H7v14h4V2H2v14h3.5V2M6 1l5 4v2L6 3m0 2 5 4v2L6 7m0 2 5 4v2l-5-4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_ROW">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v3.5h14V2H2v9h14V7H2v9h14v-3.5H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_ROW_BEFORE">
    <svg class="o-icon">
      <path fill="currentColor" d="M3.5 14.5A1.5 1.5 0 0 0 5 16h10a1.5 1.5 0 0 0 1.5-1.5v-7h-3V5h3V1.5A1.5 1.5 0 0 0 15 0H5a1.5 1.5 0 0 0-1.5 1.5v2h-3V9h3M15 12.5v2H5v-2M15 9v2H5V9m10-7.5v2H5v-2M12 5v2.5H2V5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_ROW_AFTER">
    <svg class="o-icon">
      <path fill="currentColor" d="M3.5 1.5A1.5 1.5 0 0 1 5 0h10a1.5 1.5 0 0 1 1.5 1.5v7h-3V11h3v3.5A1.5 1.5 0 0 1 15 16H5a1.5 1.5 0 0 1-1.5-1.5v-2h-3V7h3M15 3.5v-2H5v2M15 7V5H5v2m10 7.5v-2H5v2m7-3.5V8.5H2V11"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_COL">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h3.5V2H2h5v14h4V2H2h10.5v14H16V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_COL_AFTER">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.5 3A1.5 1.5 0 0 0 1 4.5v10A1.5 1.5 0 0 0 2.5 16h7v-3H12v3h3.5a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 15.5 3h-2V0H8v3M4.5 14.5h-2v-10h2m3.5 10H6v-10h2m7.5 10h-2v-10h2m-3.5 7H9.5v-10H12"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_COL_BEFORE">
    <svg class="o-icon">
      <path fill="currentColor" d="M15.5 3A1.5 1.5 0 0 1 17 4.5v10a1.5 1.5 0 0 1-1.5 1.5h-7v-3H6v3H2.5A1.5 1.5 0 0 1 1 14.5v-10A1.5 1.5 0 0 1 2.5 3h2V0H10v3m3.5 11.5h2v-10h-2m-3.5 10h2v-10h-2m-7.5 10h2v-10h-2m3.5 7h2.5v-10H6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CELL">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h14V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CELL_SHIFT_DOWN">
    <svg class="o-icon">
      <path fill="currentColor" d="M5 2.5A1.5 1.5 0 0 1 6.5 1h10A1.5 1.5 0 0 1 18 2.5v13a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 5 15.5v-5h5.25v-3H5m11.5-2v-3h-4.75v3m-1.5 0v-3H6.5v3m10 5v-3h-4.75v3m-1.5 5v-3H6.5v3m10 0v-3h-4.75v3M0 12.5l2.5 4 2.5-4H3.25v-6h-1.5v6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CELL_SHIFT_RIGHT">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.5 5A1.5 1.5 0 0 0 1 6.5v10A1.5 1.5 0 0 0 2.5 18h13a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 15.5 5h-5v5.25h-3V5m-2 11.5h-3v-4.75h3m0-1.5h-3V6.5h3m5 10h-3v-4.75h3m5-1.5h-3V6.5h3m0 10h-3v-4.75h3M12.5 0l4 2.5-4 2.5V3.25h-6v-1.5h6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DELETE_CELL_SHIFT_UP">
    <svg class="o-icon">
      <path fill="currentColor" d="M5 2.5A1.5 1.5 0 0 1 6.5 1h10A1.5 1.5 0 0 1 18 2.5v13a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 5 15.5v-5h5.25v-3H5m11.5-2v-3h-4.75v3m-1.5 0v-3H6.5v3m10 5v-3h-4.75v3m-1.5 5v-3H6.5v3m10 0v-3h-4.75v3M0 10l2.5-4L5 10H3.25v6h-1.5v-6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DELETE_CELL_SHIFT_LEFT">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.5 5A1.5 1.5 0 0 0 1 6.5v10A1.5 1.5 0 0 0 2.5 18h13a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 15.5 5h-5v5.25h-3V5m-2 11.5h-3v-4.75h3m0-1.5h-3V6.5h3m5 10h-3v-4.75h3m5-1.5h-3V6.5h3m0 10h-3v-4.75h3M10 0 6 2.5 10 5V3.25h6v-1.5h-6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_CHART">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h14V2H2m1.5 12.5h2v-7h-2m3 7h2v-10h-2m3 10h2v-5h-2m3 5h2v-11h-2M2 14.5h14v1H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_IMAGE">
    <svg class="o-icon" fill="currentColor">
      <path d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v14a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2H2v14h14V2H2m10 4.5L10 11 8.5 9.5l-2 2.5L5 10.5l-2 3h12M3.5,5a1.5,1.5,0,0,1,3,0a1.5,1.5,0,0,1,-3,0"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_LINK">
    <svg class="o-icon" fill="currentColor">
      <path d="M6.88 13.69c.19-.19.41-.28.68-.28.27 0 .51.09.72.28.43.45.43.92 0 1.4l-.84.8c-.75.75-1.63 1.12-2.64 1.12-1.04 0-1.93-.37-2.68-1.12C1.37 15.14 1 14.26 1 13.25c0-1.04.37-1.93 1.12-2.68l2.96-2.96c.93-.9 1.89-1.42 2.88-1.54.98-.12 1.84.17 2.56.86.21.21.32.45.32.72 0 .26-.1.51-.32.72-.48.43-.95.43-1.4 0-.67-.64-1.55-.41-2.67.68l-2.93 2.92c-.35.35-.52.77-.52 1.28s.17.92.52 1.24c.35.35.76.52 1.26.52.49 0 .91-.17 1.26-.52l.84-.8m9-11.48c.75.75 1.12 1.63 1.12 2.64 0 1.04-.37 1.94-1.12 2.68l-3.16 3.16c-.99.96-1.99 1.44-3 1.44-.83 0-1.57-.33-2.24-1a.913.913 0 0 1-.28-.68c0-.27.09-.5.27-.72.19-.19.43-.28.71-.28.28 0 .51.09.7.28.66.64 1.48.48 2.44-.48l3.16-3.12c.37-.37.56-.8.56-1.28 0-.51-.19-.92-.56-1.24-.32-.35-.7-.56-1.12-.62-.43-.07-.83.07-1.2.42l-1 1c-.22.19-.45.28-.72.28-.26 0-.5-.09-.68-.28-.46-.45-.46-.92 0-1.4l1-1c.72-.72 1.56-1.06 2.54-1.02.97.04 1.83.45 2.58 1.22"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.INSERT_SHEET">
    <svg class="o-icon" fill="currentColor">
      <path d="M17.5 5.5V16a1.5 1.5 0 0 1-1.5 1.5H2A1.5 1.5 0 0 1 .5 16V2A1.5 1.5 0 0 1 2 .5h10.5M2 5.5h3.5V2H2m5.25 3.5h3.5V2h-3.5M2 10.75h3.5v-3.5H2m5.25 3.5h3.5v-3.5h-3.5m5.25 3.5H16v-3.5h-3.5M2 16h3.5v-3.5H2M7.25 16h3.5v-3.5h-3.5M12.5 16H16v-3.5h-3.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PAINT_FORMAT">
    <svg class="o-icon">
      <path fill="currentColor" d="M9,0 L1,0 C0.45,0 0,0.45 0,1 L0,4 C0,4.55 0.45,5 1,5 L9,5 C9.55,5 10,4.55 10,4 L10,3 L11,3 L11,6 L4,6 L4,14 L6,14 L6,8 L13,8 L13,2 L10,2 L10,1 C10,0.45 9.55,0 9,0 Z" transform="translate(3 2)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CONDITIONAL_FORMAT">
    <svg class="o-icon">
      <path fill="currentColor" d="M12.25.5c2 0 3.5 1.5 3.5 3.5v6.5c0 .5 0 2-2 2h-2.5v4c0 .5-.5 1-1 1h-2.5c-.5 0-1-.5-1-1v-4h-2.5c-1 0-2-1-2-2V.5m12 3a1.5 1.5 0 0 0-1.5-1.5h-3v2h-1.5V2h-1v4h-2V2h-1.5v8.5h10.5m-12-3h12.5V9H2.25"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CLEAR_FORMAT">
    <svg class="o-icon">
      <path fill="currentColor" d="M2.12 4.05 7.28 9.2l-2.43 5.3h2.5l1.64-3.58 4.59 4.58 1.27-1.27L3.4 2.77 2.12 4.05ZM5.67 2.5l2 2h1.76l-.55 1.21 1.71 1.71 1.34-2.92h3.92v-2H5.67"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_DOWN">
    <svg class="o-icon">
      <polygon fill="currentColor" points="0 0 4 4 8 0" transform="translate(5 7)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_UP">
    <svg class="o-icon">
      <polygon fill="currentColor" points="4 0 0 4 8 4" transform="translate(5 7)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_RIGHT">
    <svg class="o-icon">
      <polygon fill="currentColor" points="0 0 4 4 0 8" transform="translate(5 5)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_LEFT">
    <svg class="o-icon">
      <polygon fill="currentColor" points="4 0 0 4 4 8" transform="translate(5 5)"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BOLD">
    <svg class="o-icon">
      <path fill="currentColor" d="M13.5 6.5C13.5 4.57 11.93 3 10 3H4.5v12h6.25c1.79 0 3.25-1.46 3.25-3.25 0-1.3-.77-2.41-1.87-2.93.83-.58 1.37-1.44 1.37-2.32M9.5 5c.83 0 1.5.67 1.5 1.5S10.33 8 9.5 8h-2V5h2m-2 8v-3H10c.83 0 1.5.67 1.5 1.5S10.83 13 10 13H7.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ITALIC">
    <svg class="o-icon">
      <path fill="currentColor" d="M7 3v2h2.58l-3.66 8H3v2h8v-2H8.42l3.66-8H15V3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNDERLINE">
    <svg class="o-icon">
      <path fill="currentColor" d="M9 15c2.76 0 5-2.24 5-5V3h-2v7c0 1.75-1.5 3-3 3s-3-1.242-3-3V3H4v7c0 2.76 2.24 5 5 5Zm-6 1v2h12v-2H3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.STRIKE">
    <svg class="o-icon">
      <path fill="currentColor" d="M4.89 6.06c0-.46.1-.87.3-1.25.2-.38.46-.7.84-.97s.78-.47 1.28-.62A5.71 5.71 0 0 1 8.93 3c.61 0 1.16.08 1.65.25.5.17.92.4 1.27.7.35.3.62.66.81 1.07.19.41.28.87.28 1.36h-2.26a1.85 1.85 0 0 0-.11-.64 1.26 1.26 0 0 0-.33-.51 1.53 1.53 0 0 0-.56-.33A2.42 2.42 0 0 0 8.89 4.8c-.3 0-.55.03-.77.1a1.52 1.52 0 0 0-.54.27 1.14 1.14 0 0 0-.43.9c0 .36.18.66.55.91l.06.04C8.02 7.19 8.5 7.5 9 8H6s-.79-.62-.82-.69c-.19-.36-.29-.77-.29-1.25M16 9H2v2h7.22c.14.05.3.1.41.15.28.12.5.26.65.38.16.13.26.27.32.42.06.15.08.33.08.51 0 .18-.03.34-.1.49a1.02 1.02 0 0 1-.31.39 1.6 1.6 0 0 1-.53.26 2.71 2.71 0 0 1-.76.09c-.33 0-.62-.03-.89-.1a1.8 1.8 0 0 1-.68-.31 1.45 1.45 0 0 1-.44-.56c-.11-.23-.19-.57-.19-.74H4.55c0 .25.06.69.18 1.02a3.15 3.15 0 0 0 1.22 1.6c.28.2.58.36.92.49.33.13.67.23 1.04.29.36.06.72.09 1.08.09.6 0 1.15-.07 1.64-.21a3.88 3.88 0 0 0 1.25-.59 2.69 2.69 0 0 0 .8-.95c.19-.38.28-.81.28-1.29 0-.45-.08-.86-.23-1.211a2.26 2.26 0 0 0-.13-.25L16 11V9"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TEXT_COLOR">
    <svg class="o-icon">
      <path fill="currentColor" d="M10 1H8L3.5 13h2l1.12-3h4.75l1.12 3h2L10 1ZM7.38 8 9 3.67 10.62 8H7.38"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILL_COLOR">
    <svg class="o-icon">
      <path fill="currentColor" d="M14.5 8.87S13 10.49 13 11.49c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5c0-.99-1.5-2.62-1.5-2.62m-1.79-2.08L5.91 0 4.85 1.06l1.59 1.59-4.15 4.14a.996.996 0 0 0 0 1.41l4.5 4.5c.2.2.45.3.71.3.26 0 .51-.1.71-.29l4.5-4.5c.39-.39.39-1.03 0-1.42M4.21 7 7.5 3.71 10.79 7H4.21"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MERGE_CELL">
    <svg class="o-icon">
      <path fill="currentColor" d="M3 6H1V2h7v2H3v2m7-2V2h7v4h-2V4h-5m0 10h5v-2h2v4h-7v-2m-9-2h2v2h5v2H1v-4m0-4h4V6l3 3-3 3v-2H1V8m9 1 3-3v2h4v2h-4v2l-3-3"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_LEFT">
    <svg class="o-icon align-left">
      <path fill="currentColor" d="M2 16h10v-2H2v2M12 6H2v2h10V6M2 2v2h14V2H2m0 10h14v-2H2v2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_CENTER">
    <svg class="o-icon align-center">
      <path fill="currentColor" d="M4 14v2h10v-2H4m0-8v2h10V6H4m-2 6h14v-2H2v2M2 2v2h14V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_RIGHT">
    <svg class="o-icon align-right">
      <path fill="currentColor" d="M6 16h10v-2H6v2m-4-4h14v-2H2v2M2 2v2h14V2H2m4 6h10V6H6v2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_TOP">
    <svg class="o-icon align-top">
      <path d="M3 2h12v2H3m2.5 5H8v7h2V9h2.5L9 5.5" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_MIDDLE">
    <svg class="o-icon align-middle">
      <path d="M12.5 3H10V0H8v3H5.5L9 6.5M5.5 15H8v3h2v-3h2.5L9 11.5M3 8v2h12V8" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ALIGN_BOTTOM">
    <svg class="o-icon align-bottom">
      <path d="M5.5 9H8V2h2v7h2.5L9 12.5M3 14v2h12v-2" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.WRAPPING_OVERFLOW">
    <svg class="o-icon wrapping-overflow">
      <path d="M13 8H6v2h7v2l3-3-3-3M2 2h2v14H2M9 2h2v4H9m0 6h2v4H9" fill="currentColor"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.WRAPPING_WRAP">
    <svg class="o-icon wrapping-wrap">
      <path fill="currentColor" d="M6 5v2h3.75c.75 0 1.5.67 1.5 1.5 0 .75-.75 1.5-1.5 1.5H8V8l-3 3 3 3v-2h1.5c2 0 3.5-1.5 3.5-3.5S11.5 5 9.5 5M2 2h2v14H2M14 2M14,2,h2v14h-2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.WRAPPING_CLIP">
    <svg class="o-icon wrapping-clip">
      <path fill="currentColor" d="M2 2h2v14H2M14 2h2v14h-2v-6H6V8h8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDERS">
    <svg class="o-icon">
      <path fill="currentColor" d="M2 2v14h14V2H2m6 12H4v-4h4v4m0-6H4V4h4v4m6 6h-4v-4h4v4m0-6h-4V4h4v4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_HV">
    <svg class="o-icon" fill="currentColor">
      <path d="M2 16h2v-2H2v2M4 5H2v2h2V5m1 11h2v-2H5v2m8-14h-2v2h2V2M4 2H2v2h2V2m3 0H5v2h2V2M2 13h2v-2H2v2m9 3h2v-2h-2v2m3-14v2h2V2h-2m0 5h2V5h-2v2m0 9h2v-2h-2v2m0-3h2v-2h-2v2" opacity=".54"/>
      <path d="M10 2H8v6H2v2h6v6h2v-6h6V8h-6"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_H">
    <svg class="o-icon" fill="currentColor">
      <path d="M8 16h2v-2H8v2M5 4h2V2H5v2m3 9h2v-2H8v2m-3 3h2v-2H5v2M2 7h2V5H2v2m0 9h2v-2H2v2M2 4h2V2H2v2m0 9h2v-2H2v2m12 0h2v-2h-2v2m0 3h2v-2h-2v2m0-9h2V5h-2v2m0-5v2h2V2h-2M8 4h2V2H8v2m3 0h2V2h-2v2M8 7h2V5H8v2m3 9h2v-2h-2v2" opacity=".54"/>
      <path d="M2 10h14V8H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_V">
    <svg class="o-icon" fill="currentColor">
      <path d="M5 16h2v-2H5v2M2 7h2V5H2v2m0-3h2V2H2v2m3 6h2V8H5v2m0-6h2V2H5v2M2 16h2v-2H2v2m0-6h2V8H2v2m0 3h2v-2H2v2M14 2v2h2V2h-2m0 8h2V8h-2v2m0 6h2v-2h-2v2m0-9h2V5h-2v2m0 6h2v-2h-2v2m-3 3h2v-2h-2v2m0-6h2V8h-2v2m0-6h2V2h-2v2" opacity=".54"/>
      <path d="M8 16h2V2H8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_EXTERNAL">
    <svg class="o-icon" fill="currentColor">
      <path d="M10 5H8v2h2V5m3 3h-2v2h2V8m-3 0H8v2h2V8m0 3H8v2h2v-2M7 8H5v2h2V8" opacity=".54"/>
      <path d="M2 2h14v14H2V2m12 12V4H4v10h10"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_LEFT">
    <svg class="o-icon" fill="currentColor">
      <path d="M8 10h2V8H8v2m0-3h2V5H8v2m0 6h2v-2H8v2m0 3h2v-2H8v2m-3 0h2v-2H5v2M5 4h2V2H5v2m0 6h2V8H5v2m9 6h2v-2h-2v2m0-6h2V8h-2v2m0 3h2v-2h-2v2m0-6h2V5h-2v2M8 4h2V2H8v2m6-2v2h2V2h-2m-3 14h2v-2h-2v2m0-6h2V8h-2v2m0-6h2V2h-2v2" opacity=".54"/>
      <path d="M2 16h2V2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_TOP">
    <svg class="o-icon" fill="currentColor">
      <path d="M5 10h2V8H5v2m-3 6h2v-2H2v2m6 0h2v-2H8v2m0-3h2v-2H8v2m-3 3h2v-2H5v2m-3-3h2v-2H2v2m6-3h2V8H8v2M2 7h2V5H2v2m0 3h2V8H2v2m12 0h2V8h-2v2m0 3h2v-2h-2v2m0-6h2V5h-2v2M8 7h2V5H8v2m3 9h2v-2h-2v2m0-6h2V8h-2v2m3 6h2v-2h-2v2" opacity=".54"/>
      <path d="M2 2v2h14V2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_RIGHT">
    <svg class="o-icon" fill="currentColor">
      <path d="M2 4h2V2H2v2m3 0h2V2H5v2m0 6h2V8H5v2m0 6h2v-2H5v2M2 7h2V5H2v2m0 3h2V8H2v2m0 6h2v-2H2v2m0-3h2v-2H2v2m9-3h2V8h-2v2m-3 6h2v-2H8v2m3 0h2v-2h-2v2M8 4h2V2H8v2m3 0h2V2h-2v2m-3 9h2v-2H8v2m0-6h2V5H8v2m0 3h2V8H8v2" opacity=".54"/>
      <path d="M14 2v14h2V2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_BOTTOM">
    <svg class="o-icon" fill="currentColor">
      <path d="M7 2H5v2h2V2m3 6H8v2h2V8m0 3H8v2h2v-2m3-3h-2v2h2V8M7 8H5v2h2V8m6-6h-2v2h2V2m-3 3H8v2h2V5m0-3H8v2h2V2m-6 9H2v2h2v-2m10 2h2v-2h-2v2m0-6h2V5h-2v2m0 3h2V8h-2v2m0-8v2h2V2h-2M4 2H2v2h2V2m0 3H2v2h2V5m0 3H2v2h2V8" opacity=".54"/>
      <path d="M2 16h14v-2H2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_CLEAR">
    <svg class="o-icon">
      <path fill="currentColor" d="M8 16h2v-2H8v2m-3-6h2V8H5v2m0-6h2V2H5v2m3 9h2v-2H8v2m-3 3h2v-2H5v2M2 7h2V5H2v2m0 9h2v-2H2v2M2 4h2V2H2v2m0 6h2V8H2v2m6 0h2V8H8v2m-6 3h2v-2H2v2m12 0h2v-2h-2v2m0 3h2v-2h-2v2m0-6h2V8h-2v2m0-3h2V5h-2v2m0-5v2h2V2h-2M8 4h2V2H8v2m3 0h2V2h-2v2M8 7h2V5H8v2m3 9h2v-2h-2v2m0-6h2V8h-2v2" opacity=".54"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_TYPE">
    <svg class="o-icon">
      <g fill="currentColor" transform="translate(2 2)">
        <polygon points="0 0 0 2 14 2 14 0"/>
        <polygon points="0 6 0 8 5 8 5 6"/>
        <polygon points="9 6 9 8 14 8 14 6"/>
        <polygon points="0 12 0 14 2 14 2 12"/>
        <polygon points="4 12 4 14 6 14 6 12"/>
        <polygon points="8 12 8 14 10 14 10 12"/>
        <polygon points="12 12 12 14 14 14 14 12"/>
      </g>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_COLOR">
    <svg class="o-icon">
      <g fill="currentColor" transform="translate(4 2)">
        <polygon points="0 12 0 9 7 2 10 5 3 12"/>
        <polygon points="8 1 9 0 12 3 11 4"/>
      </g>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.BORDER_NO_COLOR">
    <svg class="o-icon">
      <g fill="currentColor">
        <polygon points="4 12 4 9 11 2 14 5 7 12"/>
        <polygon points="12 1 13 0 16 3 15 4"/>
      </g>
      <g>
        <rect x="0" y="14" width="18" height="4" stroke="black" fill="none"/>
      </g>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.PLUS">
    <svg class="o-icon plus" viewBox="0 0 18 18">
      <path fill="currentColor" d="M8 0h2v8h8v2h-8v8H8v-8H0V8h8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MINUS">
    <svg class="o-icon minus" viewBox="0 0 18 18">
      <path fill="currentColor" d="M0 8h18v2H0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.LIST">
    <svg class="o-icon" viewBox="0 0 384 384">
      <rect x="0" y="277.333" width="384" height="42.667" fill="currentColor"/>
      <rect x="0" y="170.667" width="384" height="42.667" fill="currentColor"/>
      <rect x="0" y="64" width="384" height="42.667" fill="currentColor"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.EDIT">
    <svg class="o-icon" viewBox="0 0 576 512">
      <path fill="currentColor" d="M402.6 83.2l90.2 90.2c3.8 3.8 3.8 10 0 13.8L274.4 405.6l-92.8 10.3c-12.4 1.4-22.9-9.1-21.5-21.5l10.3-92.8L388.8 83.2c3.8-3.8 10-3.8 13.8 0zm162-22.9l-48.8-48.8c-15.2-15.2-39.9-15.2-55.2 0l-35.4 35.4c-3.8 3.8-3.8 10 0 13.8l90.2 90.2c3.8 3.8 10 3.8 13.8 0l35.4-35.4c15.2-15.3 15.2-40 0-55.2zM384 346.2V448H64V128h229.8c3.2 0 6.2-1.3 8.5-3.5l40-40c7.6-7.6 2.2-20.5-8.5-20.5H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V306.2c0-10.7-12.9-16-20.5-8.5l-40 40c-2.2 2.3-3.5 5.3-3.5 8.5z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNLINK">
    <svg class="o-icon" viewBox="0 0 512 512">
      <path fill="currentColor" d="M304.083 405.907c4.686 4.686 4.686 12.284 0 16.971l-44.674 44.674c-59.263 59.262-155.693 59.266-214.961 0-59.264-59.265-59.264-155.696 0-214.96l44.675-44.675c4.686-4.686 12.284-4.686 16.971 0l39.598 39.598c4.686 4.686 4.686 12.284 0 16.971l-44.675 44.674c-28.072 28.073-28.072 73.75 0 101.823 28.072 28.072 73.75 28.073 101.824 0l44.674-44.674c4.686-4.686 12.284-4.686 16.971 0l39.597 39.598zm-56.568-260.216c4.686 4.686 12.284 4.686 16.971 0l44.674-44.674c28.072-28.075 73.75-28.073 101.824 0 28.072 28.073 28.072 73.75 0 101.823l-44.675 44.674c-4.686 4.686-4.686 12.284 0 16.971l39.598 39.598c4.686 4.686 12.284 4.686 16.971 0l44.675-44.675c59.265-59.265 59.265-155.695 0-214.96-59.266-59.264-155.695-59.264-214.961 0l-44.674 44.674c-4.686 4.686-4.686 12.284 0 16.971l39.597 39.598zm234.828 359.28l22.627-22.627c9.373-9.373 9.373-24.569 0-33.941L63.598 7.029c-9.373-9.373-24.569-9.373-33.941 0L7.029 29.657c-9.373 9.373-9.373 24.569 0 33.941l441.373 441.373c9.373 9.372 24.569 9.372 33.941 0z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.CARET_UP">
    <svg class="caret-up" viewBox="0 0 320 512">
      <path fill="currentColor" d="M288.662 352H31.338c-17.818 0-26.741-21.543-14.142-34.142l128.662-128.662c7.81-7.81 20.474-7.81 28.284 0l128.662 128.662c12.6 12.599 3.676 34.142-14.142 34.142z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CARET_DOWN">
    <svg class="caret-down" viewBox="0 0 320 512">
      <path fill="currentColor" d="M31.3 192h257.3c17.8 0 26.7 21.5 14.1 34.1L174.1 354.8c-7.8 7.8-20.5 7.8-28.3 0L17.2 226.1C4.6 213.5 13.5 192 31.3 192z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CARET_RIGHT">
    <svg class="o-icon caret-right" viewBox="0 0 192 512">
      <path d="M0 384.662V127.338c0-17.818 21.543-26.741 34.142-14.142l128.662 128.662c7.81 7.81 7.81 20.474 0 28.284L34.142 398.804C21.543 411.404 0 402.48 0 384.662z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CARET_LEFT">
    <svg class="o-icon caret-left" viewBox="0 0 192 512">
      <path d="M192 127.338v257.324c0 17.818-21.543 26.741-34.142 14.142L29.196 270.142c-7.81-7.81-7.81-20.474 0-28.284l128.662-128.662c12.599-12.6 34.142-3.676 34.142 14.142z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.TRASH">
    <svg class="o-cf-icon trash" viewBox="0 0 448 512">
      <path fill="currentColor" d="M432 32H312l-9.4-18.7A24 24 0 0 0 281.1 0H166.8a23.72 23.72 0 0 0-21.4 13.3L136 32H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16zM53.2 467a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45L416 128H32z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.REFRESH">
    <svg class="o-cf-icon refresh" viewBox="0 0 512 512">
      <path fill="currentColor" d="M440.65 12.57l4 82.77A247.16 247.16 0 0 0 255.83 8C134.73 8 33.91 94.92 12.29 209.82A12 12 0 0 0 24.09 224h49.05a12 12 0 0 0 11.67-9.26 175.91 175.91 0 0 1 317-56.94l-101.46-4.86a12 12 0 0 0-12.57 12v47.41a12 12 0 0 0 12 12H500a12 12 0 0 0 12-12V12a12 12 0 0 0-12-12h-47.37a12 12 0 0 0-11.98 12.57zM255.83 432a175.61 175.61 0 0 1-146-77.8l101.8 4.87a12 12 0 0 0 12.57-12v-47.4a12 12 0 0 0-12-12H12a12 12 0 0 0-12 12V500a12 12 0 0 0 12 12h47.35a12 12 0 0 0 12-12.6l-4.15-82.57A247.17 247.17 0 0 0 255.83 504c121.11 0 221.93-86.92 243.55-201.82a12 12 0 0 0-11.8-14.18h-49.05a12 12 0 0 0-11.67 9.26A175.86 175.86 0 0 1 255.83 432z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.ARROW_DOWN">
    <svg class="o-cf-icon arrow-down" width="10" height="10" focusable="false" viewBox="0 0 448 512">
      <path fill="#DC6965" t-att-style="color" d="M413.1 222.5l22.2 22.2c9.4 9.4 9.4 24.6 0 33.9L241 473c-9.4 9.4-24.6 9.4-33.9 0L12.7 278.6c-9.4-9.4-9.4-24.6 0-33.9l22.2-22.2c9.5-9.5 25-9.3 34.3.4L184 343.4V56c0-13.3 10.7-24 24-24h32c13.3 0 24 10.7 24 24v287.4l114.8-120.5c9.3-9.8 24.8-10 34.3-.4z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ARROW_UP">
    <svg class="o-cf-icon arrow-up" width="10" height="10" focusable="false" viewBox="0 0 448 512">
      <path fill="#00A04A" t-att-style="color" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ARROW_RIGHT">
    <svg class="o-cf-icon arrow-right" width="10" height="10" focusable="false" viewBox="0 0 448 512">
      <path fill="#F0AD4E" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.SMILE">
    <svg class="o-cf-icon smile" width="10" height="10" focusable="false" viewBox="0 0 496 512">
      <path fill="#00A04A" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm4 72.6c-20.8 25-51.5 39.4-84 39.4s-63.2-14.3-84-39.4c-8.5-10.2-23.7-11.5-33.8-3.1-10.2 8.5-11.5 23.6-3.1 33.8 30 36 74.1 56.6 120.9 56.6s90.9-20.6 120.9-56.6c8.5-10.2 7.1-25.3-3.1-33.8-10.1-8.4-25.3-7.1-33.8 3.1z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MEH">
    <svg class="o-cf-icon meh" width="10" height="10" focusable="false" viewBox="0 0 496 512">
      <path fill="#F0AD4E" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm8 144H160c-13.2 0-24 10.8-24 24s10.8 24 24 24h176c13.2 0 24-10.8 24-24s-10.8-24-24-24z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FROWN">
    <svg class="o-cf-icon frown" width="10" height="10" focusable="false" viewBox="0 0 496 512">
      <path fill="#DC6965" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 448c-110.3 0-200-89.7-200-200S137.7 56 248 56s200 89.7 200 200-89.7 200-200 200zm-80-216c17.7 0 32-14.3 32-32s-14.3-32-32-32-32 14.3-32 32 14.3 32 32 32zm160-64c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm-80 128c-40.2 0-78 17.7-103.8 48.6-8.5 10.2-7.1 25.3 3.1 33.8 10.2 8.4 25.3 7.1 33.8-3.1 16.6-19.9 41-31.4 66.9-31.4s50.3 11.4 66.9 31.4c8.1 9.7 23.1 11.9 33.8 3.1 10.2-8.5 11.5-23.6 3.1-33.8C326 321.7 288.2 304 248 304z"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-Icon.GREEN_DOT">
    <svg class="o-cf-icon green-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="#00A04A" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.YELLOW_DOT">
    <svg class="o-cf-icon yellow-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="#F0AD4E" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.RED_DOT">
    <svg class="o-cf-icon red-dot" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="#DC6965" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SORT_RANGE">
    <svg class="o-icon">
      <path fill="currentColor" d="M9 3.5h8v2H9M9 8h6v2H9m0 2.5h3v2H9M6 6l1-1-3-3-3 3 1 1 1-1v8l-1-1-1 1 3 3 3-3-1-1-1 1V5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SORT_ASCENDING">
    <svg class="o-icon" fill="currentColor">
      <path d="m3 13-1-1-1 1 3 3 3-3-1-1-1 1V0H3"/>
      <text x="9" y="7" class="small-text">A</text>
      <text x="9.3" y="15" class="small-text">Z</text>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SORT_DESCENDING">
    <svg class="o-icon" fill="currentColor">
      <path d="m3 13.9-1-1-1 1 3 3 3-3-1-1-1 1V.9H3"/>
      <text x="9.3" y="7.9" class="small-text">Z</text>
      <text x="9" y="15.9" class="small-text">A</text>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DATA_CLEANUP">
    <svg class="o-icon" fill="currentColor">
      <path d="m13.6 6.4-2.1-2.1c-.4-.4-1-.4-1.4 0l-8.8 8.9c-.4.4-.4 1 0 1.4l2.1 2.1c.4.4 1 .4 1.4 0l8.8-8.9c.4-.4.4-1 0-1.4M8 8.5 10.5 6l1.4 1.4-2.5 2.5m3-7 1.8.8.8 1.8.8-1.8 1.8-.8-1.8-.8L14.9.4l-.8 1.8M3.5 4l1.7.7.8 1.8.8-1.8 1.8-.8-1.8-.8-.8-1.8-.8 1.8zm13.5 7.7-1.8-.8-.8-1.8-.8 1.8-1.8.8 1.8.8.8 1.8.7-1.8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILTER_ICON">
    <svg class="o-cf-icon filter-icon" width="10" height="10" focusable="false" viewBox="0 0 850 850">
      <path fill="currentColor" d="M 339.667 681 L 510.333 681 L 510.333 595.667 L 339.667 595.667 L 339.667 681 Z M 41 169 L 41 254.333 L 809 254.333 L 809 169 L 41 169 Z M 169 467.667 L 681 467.667 L 681 382.333 L 169 382.333 L 169 467.667 Z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILTER_ICON_ACTIVE">
    <svg class="o-cf-icon filter-icon-active" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="currentColor" d="M487.976 0H24.028C2.71 0-8.047 25.866 7.058 40.971L192 225.941V432c0 7.831 3.821 15.17 10.237 19.662l80 55.98C298.02 518.69 320 507.493 320 487.98V225.941l184.947-184.97C520.021 25.896 509.338 0 487.976 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FILTER_ICON_INACTIVE">
    <svg class="o-cf-icon filter-icon-inactive" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="currentColor" d="M487.976 0H24.028C2.71 0-8.047 25.866 7.058 40.971L192 225.941V432c0 7.831 3.821 15.17 10.237 19.662l80 55.98C298.02 518.69 320 507.493 320 487.98V225.941l184.947-184.97C520.021 25.896 509.338 0 487.976 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.MENU_FILTER_ICON">
    <svg class="o-icon">
      <path fill="currentColor" d="M16.6.5H1.29C.59.5.23 1.35.73 1.85l6.1 6.1v6.8c0 .26.13.5.34.65l2.64 1.85a.79.79 0 0 0 1.25-.65V7.96l6.1-6.1A.79.79 0 0 0 16.6.51"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SEARCH">
    <svg class="search-icon" width="10" height="10" focusable="false" viewBox="0 0 512 512">
      <path fill="currentColor" d="M500.3 443.7l-119.7-119.7c27.22-40.41 40.65-90.9 33.46-144.7C401.8 87.79 326.8 13.32 235.2 1.723C99.01-15.51-15.51 99.01 1.724 235.2c11.6 91.64 86.08 166.7 177.6 178.9c53.8 7.189 104.3-6.236 144.7-33.46l119.7 119.7c15.62 15.62 40.95 15.62 56.57 0C515.9 484.7 515.9 459.3 500.3 443.7zM79.1 208c0-70.58 57.42-128 128-128s128 57.42 128 128c0 70.58-57.42 128-128 128S79.1 278.6 79.1 208z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.CHECK">
    <svg class="o-icon" viewBox="0 0 24 24">
      <path fill="currentColor" d="M18.707 7.293a1 1 0 0 1 0 1.414L11.414 16a2 2 0 0 1-2.828 0l-3.293-3.293a1 1 0 1 1 1.414-1.414L10 14.586l7.293-7.293a1 1 0 0 1 1.414 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PERCENT">
    <span class="o-text-icon">%</span>
  </t>
  <t t-name="o-spreadsheet-Icon.DECRASE_DECIMAL">
    <span class="o-text-icon">.0</span>
  </t>
  <t t-name="o-spreadsheet-Icon.INCREASE_DECIMAL">
    <span class="o-text-icon">.00</span>
  </t>
  <t t-name="o-spreadsheet-Icon.NUMBER_FORMATS">
    <svg class="o-icon" fill="currentColor">
      <path d="M0 6h2v8h2V4H0m9 0H5v2h4v2H6.5A1.5 1.5 0 0 0 5 9.5V14h6v-2H7v-2h2.5A1.5 1.5 0 0 0 11 8.5v-3A1.5 1.5 0 0 0 9.5 4M12 4v2h4v2h-2v2h2v2h-4v2h4.5a1.5 1.5 0 0 0 1.5-1.5v-2A1.5 1.5 0 0 0 16.5 9 1.5 1.5 0 0 0 18 7.5v-2A1.5 1.5 0 0 0 16.5 4"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.FONT_SIZE">
    <svg class="o-icon" fill="currentColor">
      <text x="2" y="15" class="small-text">A</text>
      <text x="6" y="15" class="heavy-text">A</text>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.TRIANGLE_EXCLAMATION">
    <svg class="o-icon" viewBox="0 0 512 512">
      <path fill="currentColor" d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.SPLIT_TEXT">
    <svg class="o-icon">
      <path fill="currentColor" d="M14 6v2h-4v2h4v2l3-3m-9 1V8H4V6L1 9l3 3v-2m3.5-6.5h3V7H12V3.5h3V2H3v1.5h3V7h1.5m3 7.5h-3V11H6v3.5H3V16h12v-1.5h-3V11h-1.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.ERROR">
    <svg class="error-icon" width="14" height="14" viewBox="0 0 512 512">
      <path fill="currentColor" d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DISPLAY_HEADER">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M.75.5h16.5v17H.75m1.5-12H.75V7h1.5v1.5H.75V10h1.5v1.5H.75V13h1.5v1.5H.75V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v1.5h1.5V16h1.5v-1.5h-1.5V13h1.5v-1.5h-1.5V10h1.5V8.5h-1.5V7h1.5V5.5M2.75 2.25v1.5h2v-1.5m2.5 0v1.5h7v-1.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.COG">
    <svg fill="currentColor" viewBox="0 0 16 16">
      <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
      <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.PLUS_IN_BOX">
    <svg class="o-icon" width="18" height="18" style="fill:none;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.5">
      <path stroke="currentColor" d="M1.5,1.5h15v15h-15v-15M9,5v8M5,9h8"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.GROUP_ROWS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M6 2.5A1.5 1.5 0 0 1 7.5 1H16a1.5 1.5 0 0 1 1.5 1.5V15a1.5 1.5 0 0 1-1.5 1.5H7.5A1.5 1.5 0 0 1 6 15M7.5 2.5v2H16v-2M7.5 6v2H16V6M7.5 9.5v2H16v-2M7.5 13v2H16v-2M2 5.75V13h3v-1.5H3.5V5.75h1.25V3l-1 1v.75H3M.25 1.25v4.5h4.5v-4.5m-3.5 1h2.5v2.5h-2.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNGROUP_ROWS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M6 2.5A1.5 1.5 0 0 1 7.5 1H16a1.5 1.5 0 0 1 1.5 1.5V15a1.5 1.5 0 0 1-1.5 1.5H7.5A1.5 1.5 0 0 1 6 15M7.5 2.5v2H16v-2M7.5 6v2H16V6M7.5 9.5v2H16v-2M7.5 13v2H16v-2M2 5.75V13h3v-1.5H3.5V5.75M0 5.25.75 6l2-2 2 2 .75-.75-2-2 2-2L4.75.5l-2 2-2-2-.75.75 2 2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.GROUP_COLUMNS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M2.75 6a1.5 1.5 0 0 0-1.5 1.5V16a1.5 1.5 0 0 0 1.5 1.5h12.5a1.5 1.5 0 0 0 1.5-1.5V7.5a1.5 1.5 0 0 0-1.5-1.5M2.75 7.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2M6 2h7.25v3h-1.5V3.5H6v1.25H3.25l1-1H5V3M1.5.25H6v4.5H1.5m1-3.5v2.5H5v-2.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.UNGROUP_COLUMNS">
    <svg class="o-icon" width="18" height="18">
      <path fill="currentColor" d="M2.75 6a1.5 1.5 0 0 0-1.5 1.5V16a1.5 1.5 0 0 0 1.5 1.5h12.5a1.5 1.5 0 0 0 1.5-1.5V7.5a1.5 1.5 0 0 0-1.5-1.5M2.75 7.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2m3.5-8.5h2V16h-2M6 2h7.25v3h-1.5V3.5H6M5.5 0l.75.75-2 2 2 2-.75.75-2-2-2 2-.75-.75 2-2-2-2L1.5 0l2 2"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DATA_VALIDATION">
    <svg class="o-icon">
      <path fill="currentColor" d="M.5 2A1.5 1.5 0 0 1 2 .5h14A1.5 1.5 0 0 1 17.5 2v7H11V7H7v4s-.5 0-1.5 1h-1v5h-3a1.5 1.5 0 0 1-1-1M6 6V2H2v4m9 0V2H7v4m9 0V2h-4v4m-6 5V7H2v4m14-2V7h-4v2m-7.5 6.5V12H2v3.5"/>
      <path stroke="currentColor" style="fill:none; stroke-linecap:round; stroke-width:1.5" d="M8,13 l3 3 l6 -5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.THIN_DRAG_HANDLE">
    <svg class="o-icon" viewBox="0 0 4 16" fill="currentColor">
      <circle cx="2" cy="3.5" r="1"/>
      <circle cx="2" cy="6.5" r="1"/>
      <circle cx="2" cy="9.5" r="1"/>
      <circle cx="2" cy="12.5" r="1"/>
    </svg>
  </t>

  <t t-name="o-spreadsheet-LinkDisplay">
    <div class="o-link-tool d-flex align-items-center">

      <img t-if="link.isExternal" t-key="link.url" t-attf-src="https://www.google.com/s2/favicons?sz=16&amp;domain={{link.url}}"/>
      <a t-if="link.isExternal" class="o-link" t-att-href="link.url" target="_blank" t-on-click.prevent="openLink" t-att-title="link.url">
        <t t-esc="getUrlRepresentation(link)"/>
      </a>
      <a t-else="" class="o-link" t-on-click.prevent="openLink" t-att-title="getUrlRepresentation(link)">
        <t t-esc="getUrlRepresentation(link)"/>
      </a>
      <span t-if="!env.model.getters.isReadonly()" class="o-link-icon o-unlink" t-on-click="unlink" title="Remove link">
        <t t-call="o-spreadsheet-Icon.UNLINK"/>
      </span>
      <span t-if="!env.model.getters.isReadonly()" class="o-link-icon o-edit-link" t-on-click="edit" title="Edit link">
        <t t-call="o-spreadsheet-Icon.EDIT"/>
      </span>
    </div>
  </t>

  <t t-name="o-spreadsheet-LinkEditor">
    <div class="o-link-editor" t-on-click.stop="() =&gt; this.menu.isOpen=false" t-on-keydown="onKeyDown" t-ref="linkEditor">
      <div class="o-section">
        <div class="o-section-title">Text</div>
        <div class="d-flex">
          <input type="text" title="Link label" class="o-input flex-grow-1" t-model="link.label"/>
        </div>

        <div class="o-section-title mt-3">Link</div>
        <div class="o-link-url">
          <t t-if="link.isUrlEditable">
            <input type="text" title="Link URL" t-ref="urlInput" t-model="link.url"/>
          </t>
          <t t-else="">
            <input type="text" title="Link URL" t-att-value="getUrlRepresentation(link)" disabled="1"/>
          </t>
          <button t-if="link.url" t-on-click="removeLink" class="o-remove-url">✖</button>
          <button t-if="!link.url" t-on-click.stop="openMenu" class="o-special-link">
            <t t-call="o-spreadsheet-Icon.LIST"/>
          </button>
        </div>
      </div>
      <Menu t-if="menu.isOpen" position="menuPosition" menuItems="menuItems" onMenuClicked="(ev) =&gt; this.onSpecialLink(ev)" onClose="() =&gt; this.menu.isOpen=false"/>
      <div class="o-buttons">
        <button t-on-click="cancel" class="o-button o-button-grey o-cancel">Cancel</button>
        <button t-on-click="save" class="o-button o-button-grey o-save" t-att-disabled="!link.url">
          Confirm
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-Menu">
    <Popover t-if="menuItemsAndSeparators.length" t-props="popoverProps">
      <div t-ref="menu" class="o-menu" t-on-scroll="onScroll" t-on-wheel.stop="" t-on-click.stop="" t-on-contextmenu.prevent="">
        <t t-foreach="menuItemsAndSeparators" t-as="menuItem" t-key="menuItem_index">
          <div t-if="menuItem === 'separator'" class="o-separator"/>
          <t t-else="">
            <t t-set="isMenuRoot" t-value="isRoot(menuItem)"/>
            <t t-set="isMenuEnabled" t-value="isEnabled(menuItem)"/>
            <div t-att-title="getName(menuItem)" t-att-data-name="menuItem.id" t-on-click="(ev) =&gt; this.onClickMenu(menuItem, menuItem_index, ev)" t-on-mouseover="(ev) =&gt; this.onMouseOver(menuItem, menuItem_index, ev)" class="o-menu-item" t-att-class="{ 'o-menu-root': isMenuRoot, 'disabled': !isMenuEnabled, 'o-menu-item-active': isParentMenu(subMenu, menuItem)}" t-att-style="getColor(menuItem)">
              <div class="d-flex w-100">
                <div t-if="childrenHaveIcon" class="o-menu-item-icon align-middle flex-shrink-0">
                  <t t-if="getIconName(menuItem)" t-call="{{getIconName(menuItem)}}"/>
                </div>
                <div class="o-menu-item-name align-middle text-truncate" t-esc="getName(menuItem)"/>
                <t t-set="description" t-value="menuItem.description(env)"/>
                <div t-if="description" class="o-menu-item-description ms-auto text-truncate" t-esc="description"/>
                <div t-if="isMenuRoot" class="o-menu-item-root align-middle ms-auto" t-call="o-spreadsheet-Icon.TRIANGLE_RIGHT"/>
              </div>
            </div>
          </t>
        </t>
      </div>
      <Menu t-if="subMenu.isOpen" position="subMenuPosition" menuItems="subMenu.menuItems" depth="props.depth + 1" maxHeight="props.maxHeight" onMenuClicked="props.onMenuClicked" onClose="() =&gt; this.close()" menuId="props.menuId"/>
    </Popover>
  </t>

  <t t-name="o-spreadsheet-PaintFormatButton">
    <span class="o-menu-item-button" title="Paint Format" t-att-class="{active: isActive}" t-attf-class="{{props.class}}" t-on-click="togglePaintFormat" t-on-dblclick="onDblClick">
      <span>
        <t t-call="o-spreadsheet-Icon.PAINT_FORMAT"/>
      </span>
    </span>
  </t>

  <t t-name="o-spreadsheet-Popover">
    <t t-portal="'.o-spreadsheet'">
      <div class="o-popover" t-ref="popover" t-on-wheel="props.onMouseWheel" t-att-style="popoverStyle" t-on-click.stop="">
        <t t-slot="default"/>
      </div>
    </t>
  </t>

  <t t-name="o-spreadsheet-ScrollBar">
    <div class="o-scrollbar" t-on-scroll="onScroll" t-ref="scrollbar" t-att-style="positionCss">
      <div t-att-style="sizeCss"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-SelectionInput">
    <div class="o-selection">
      <div t-foreach="ranges" t-as="range" t-key="range.id" class="o-selection-input d-flex flex-row" t-att-class="props.class">
        <div class="position-relative w-100">
          <input type="text" spellcheck="false" t-on-input="(ev) =&gt; this.onInputChanged(range.id, ev)" t-on-focus="() =&gt; this.focus(range.id)" t-on-keydown="onKeydown" t-att-value="range.xc" t-att-style="getColor(range)" class="w-100" t-att-class="{               'o-focused' : range.isFocused,               'o-required': props.required,               'o-optional': !props.required,               'o-invalid border-danger position-relative': isInvalid || !range.isValidRange,               'text-decoration-underline': range.isFocused and state.mode === 'select-range'             }" t-ref="{{range.isFocused ? 'focusedInput' : 'unfocusedInput' + range_index}}"/>
          <span t-if="isInvalid || !range.isValidRange" class="error-icon text-danger position-absolute d-flex align-items-center" title="This range is invalid">
            <t t-call="o-spreadsheet-Icon.ERROR"/>
          </span>
        </div>
        <button class="o-btn border-0 bg-transparent fw-bold o-remove-selection" t-if="ranges.length &gt; 1" t-on-click="() =&gt; this.removeInput(range.id)">
          ✕
        </button>
      </div>

      <div class="o-selection-input d-flex flex-row">
        <button class="o-btn-action bg-transparent fw-bold o-add-selection" t-if="canAddRange" t-on-click="addEmptyInput">
          Add range
        </button>
        <button class="o-btn-action bg-transparent fw-bold o-selection-ko" t-if="isResettable" t-on-click="reset">
          Reset
        </button>
        <button class="o-btn-action bg-transparent fw-bold o-selection-ok" t-if="isConfirmable" t-on-click="confirm">
          Confirm
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-BarConfigPanel">
    <div>
      <div class="o-section pt-0">
        <label class="o-checkbox">
          <input type="checkbox" name="stacked" t-att-checked="props.definition.stacked" t-on-change="onUpdateStacked" class="align-middle"/>
          Stacked barchart
        </label>
      </div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data Series</div>
        <SelectionInput ranges="() =&gt; this.getDataSeriesRanges()" required="true" onSelectionChanged="(ranges) =&gt; this.onDataSeriesRangesChanged(ranges)" onSelectionConfirmed="() =&gt; this.onDataSeriesConfirmed()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Categories / Labels</div>
        <SelectionInput ranges="() =&gt; [this.getLabelRange()]" isInvalid="isLabelInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onLabelRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.onLabelRangeConfirmed()"/>
        <label class="o-checkbox">
          <input type="checkbox" name="aggregated" t-att-checked="props.definition.aggregated" t-on-change="onUpdateAggregated" class="align-middle"/>
          Aggregate
        </label>
      </div>
      <div class="o-section o-use-row-as-headers" t-if="calculateHeaderPosition()">
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="props.definition.dataSetsHaveTitle" t-on-change="onUpdateDataSetsHaveTitle" class="align-middle"/>
          <span>
            Use row
            <t t-esc="calculateHeaderPosition()"/>
            as headers
          </span>
        </label>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-BarChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker()" showColorPicker="state.fillColorTool" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>
      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Vertical axis position</div>
        <select t-att-value="props.definition.verticalAxisPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('verticalAxisPosition', ev)">
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
      <div class="o-section">
        <div class="o-section-title">Legend position</div>
        <select t-att-value="props.definition.legendPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('legendPosition', ev)">
          <option value="none">None</option>
          <option value="top">Top</option>
          <option value="bottom">Bottom</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartConfigPanel">
    <div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data range</div>
        <SelectionInput ranges="() =&gt; [this.getDataRange()]" isInvalid="isDataRangeInvalid" hasSingleRange="true" required="true" onSelectionChanged="(ranges) =&gt; this.onDataRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.updateDataRange()"/>
      </div>

      <div class="o-section" t-if="configurationErrorMessages.length">
        <ValidationMessages messages="configurationErrorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleMenu('backgroundColor', ev)" showColorPicker="state.openedMenu === 'backgroundColor'" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>

      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>

      <div class="o-section">
        <div class="o-section-title">Range</div>
        <div class="o-subsection-left">
          <input type="text" t-model="state.sectionRule.rangeMin" t-on-change="() =&gt; this.updateSectionRule(state.sectionRule)" t-on-input="() =&gt; this.canUpdateSectionRule(state.sectionRule)" class="o-input o-data-range-min" t-att-class="{ 'o-invalid': isRangeMinInvalid() }"/>
        </div>
        <div class="o-subsection-right">
          <input type="text" t-model="state.sectionRule.rangeMax" t-on-change="() =&gt; this.updateSectionRule(state.sectionRule)" t-on-input="() =&gt; this.canUpdateSectionRule(state.sectionRule)" class="o-input o-data-range-max" t-att-class="{ 'o-invalid': isRangeMaxInvalid() }"/>
        </div>
      </div>

      <div class="o-section">
        <div class="o-section-title">Thresholds</div>
        <t t-call="o-spreadsheet-GaugeChartColorSectionTemplate">
          <t t-set="sectionRule" t-value="state.sectionRule"/>
        </t>
      </div>

      <div class="o-section" t-if="designErrorMessages.length">
        <ValidationMessages messages="designErrorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartColorSectionTemplate">
    <div class="o-gauge-color-set">
      <table>
        <tr>
          <th class="o-gauge-color-set-colorPicker"/>
          <th class="o-gauge-color-set-text"/>
          <th class="o-gauge-color-set-value">Value</th>
          <th class="o-gauge-color-set-type">Type</th>
        </tr>

        <t t-call="o-spreadsheet-GaugeChartColorSectionTemplateRow">
          <t t-set="sectionColor" t-value="sectionRule.colors.lowerColor"/>
          <t t-set="sectionType" t-value="'lowerColor'"/>
          <t t-set="inflectionPoint" t-value="sectionRule.lowerInflectionPoint"/>
          <t t-set="isInvalid" t-value="isLowerInflectionPointInvalid"/>
          <t t-set="inflectionPointName" t-value="'lowerInflectionPoint'"/>
        </t>

        <t t-call="o-spreadsheet-GaugeChartColorSectionTemplateRow">
          <t t-set="sectionColor" t-value="sectionRule.colors.middleColor"/>
          <t t-set="sectionType" t-value="'middleColor'"/>
          <t t-set="inflectionPoint" t-value="sectionRule.upperInflectionPoint"/>
          <t t-set="isInvalid" t-value="isUpperInflectionPointInvalid"/>
          <t t-set="inflectionPointName" t-value="'upperInflectionPoint'"/>
        </t>

        <tr>
          <td>
            <ColorPickerWidget currentColor="sectionRule.colors.upperColor" toggleColorPicker="(ev) =&gt; this.toggleMenu('sectionColor-upperColor', ev)" showColorPicker="state.openedMenu === 'sectionColor-upperColor'" onColorPicked="(color) =&gt; this.updateSectionColor('upperColor', color)" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
          </td>
          <td>Else</td>
          <td/>
          <td/>
          <td/>
        </tr>
      </table>
    </div>
  </t>

  <t t-name="o-spreadsheet-GaugeChartColorSectionTemplateRow">
    <tr>
      <td>
        <ColorPickerWidget currentColor="sectionColor" toggleColorPicker="(ev) =&gt; this.toggleMenu('sectionColor-'+sectionType, ev)" showColorPicker="state.openedMenu === 'sectionColor-'+sectionType" onColorPicked="(color) =&gt; this.updateSectionColor(sectionType, color)" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
      </td>
      <td>When value is below</td>
      <td>
        <input type="text" class="o-input" t-model="inflectionPoint.value" t-on-input="() =&gt; this.canUpdateSectionRule(state.sectionRule)" t-on-change="() =&gt; this.updateSectionRule(state.sectionRule)" t-attf-class="o-input-{{inflectionPointName}}" t-att-class="{ 'o-invalid': isInvalid }"/>
      </td>
      <td>
        <select class="o-input" name="valueType" t-model="inflectionPoint.type" t-on-change="(ev) =&gt; this.updateSectionRule(state.sectionRule)">
          <option value="number">Number</option>
          <option value="percentage">Percentage</option>
        </select>
      </td>
    </tr>
  </t>

  <t t-name="o-spreadsheet-LineBarPieConfigPanel">
    <div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data Series</div>
        <SelectionInput ranges="() =&gt; this.getDataSeriesRanges()" required="true" onSelectionChanged="(ranges) =&gt; this.onDataSeriesRangesChanged(ranges)" onSelectionConfirmed="() =&gt; this.onDataSeriesConfirmed()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Categories / Labels</div>
        <SelectionInput ranges="() =&gt; [this.getLabelRange()]" isInvalid="isLabelInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onLabelRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.onLabelRangeConfirmed()"/>
        <label class="o-checkbox">
          <input type="checkbox" name="aggregated" t-att-checked="props.definition.aggregated" t-on-change="onUpdateAggregated" class="align-middle"/>
          Aggregate
        </label>
      </div>
      <div class="o-section o-use-row-as-headers" t-if="calculateHeaderPosition()">
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="props.definition.dataSetsHaveTitle" t-on-change="onUpdateDataSetsHaveTitle" class="align-middle"/>
          <span>
            Use row
            <t t-esc="calculateHeaderPosition()"/>
            as headers
          </span>
        </label>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-LineBarPieDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker()" showColorPicker="state.fillColorTool" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>
      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Legend position</div>
        <select t-att-value="props.definition.legendPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('legendPosition', ev)">
          <option value="none">None</option>
          <option value="top">Top</option>
          <option value="bottom">Bottom</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-LineConfigPanel">
    <div>
      <div class="o-section pt-0">
        <label class="o-checkbox">
          <input type="checkbox" name="stacked" t-att-checked="props.definition.stacked" t-on-change="onUpdateStacked" class="align-middle"/>
          Stacked linechart
        </label>
        <label class="o-checkbox">
          <input type="checkbox" name="cumulative" t-att-checked="props.definition.cumulative" t-on-change="onUpdateCumulative" class="align-middle"/>
          Cumulative data
        </label>
      </div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Data Series</div>
        <SelectionInput ranges="() =&gt; this.getDataSeriesRanges()" required="true" onSelectionChanged="(ranges) =&gt; this.onDataSeriesRangesChanged(ranges)" onSelectionConfirmed="() =&gt; this.onDataSeriesConfirmed()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Categories / Labels</div>
        <SelectionInput ranges="() =&gt; [this.getLabelRange()]" isInvalid="isLabelInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onLabelRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.onLabelRangeConfirmed()"/>
        <label class="o-checkbox">
          <input type="checkbox" name="aggregated" t-att-checked="props.definition.aggregated" t-on-change="onUpdateAggregated" class="align-middle"/>
          Aggregate
        </label>
        <label t-if="canTreatLabelsAsText" class="o-checkbox">
          <input type="checkbox" name="labelsAsText" t-att-checked="props.definition.labelsAsText" t-on-change="onUpdateLabelsAsText"/>
          Treat labels as text
        </label>
      </div>
      <div class="o-section o-use-row-as-headers" t-if="calculateHeaderPosition()">
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="props.definition.dataSetsHaveTitle" t-on-change="onUpdateDataSetsHaveTitle" class="align-middle"/>
          <span>
            Use row
            <t t-esc="calculateHeaderPosition()"/>
            as headers
          </span>
        </label>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-LineChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker()" showColorPicker="state.fillColorTool" onColorPicked="(color) =&gt; this.updateBackgroundColor(color)" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>
      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Vertical axis position</div>
        <select t-att-value="props.definition.verticalAxisPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('verticalAxisPosition', ev)">
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
      <div class="o-section">
        <div class="o-section-title">Legend position</div>
        <select t-att-value="props.definition.legendPosition" class="o-input o-type-selector" t-on-change="(ev) =&gt; this.updateSelect('legendPosition', ev)">
          <option value="none">None</option>
          <option value="top">Top</option>
          <option value="bottom">Bottom</option>
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ChartPanel">
    <div class="o-chart">
      <div class="o-panel">
        <div class="o-panel-element o-panel-configuration" t-att-class="state.panel !== 'configuration' ? 'inactive' : ''" t-on-click="() =&gt; this.activatePanel('configuration')">
          <i class="fa fa-sliders"/>
          Configuration
        </div>
        <div class="o-panel-element o-panel-design" t-att-class="state.panel !== 'design' ? 'inactive' : ''" t-on-click="() =&gt; this.activatePanel('design')">
          <i class="fa fa-paint-brush"/>
          Design
        </div>
      </div>

      <t t-set="definition" t-value="getChartDefinition()"/>
      <t t-if="state.panel === 'configuration'">
        <div class="o-section">
          <div class="o-section-title">Chart type</div>
          <t t-set="types" t-value="chartTypes"/>
          <select class="o-input o-type-selector" t-on-change="(ev) =&gt; this.onTypeChange(ev.target.value)">
            <option t-foreach="chartTypes" t-as="type" t-key="type" t-att-value="type" t-esc="types[type]" t-att-selected="definition.type === type"/>
          </select>
        </div>
        <t t-component="chartPanel.configuration" definition="definition" figureId="figureId" updateChart.bind="updateChart" canUpdateChart.bind="canUpdateChart" t-key="figureId + definition.type"/>
      </t>
      <t t-else="">
        <t t-component="chartPanel.design" definition="definition" figureId="figureId" updateChart.bind="updateChart" canUpdateChart.bind="canUpdateChart" t-key="figureId + definition.type"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-ScorecardChartConfigPanel">
    <div>
      <div class="o-section o-data-series">
        <div class="o-section-title">Key value</div>
        <SelectionInput ranges="() =&gt; [this.getKeyValueRange()]" isInvalid="isKeyValueInvalid" hasSingleRange="true" required="true" onSelectionChanged="(ranges) =&gt; this.onKeyValueRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.updateKeyValueRange()"/>
      </div>
      <div class="o-section o-data-labels">
        <div class="o-section-title">Baseline configuration</div>
        <div class="o-section-subtitle">Baseline value</div>
        <SelectionInput ranges="() =&gt; [this.getBaselineRange()]" isInvalid="isBaselineInvalid" hasSingleRange="true" onSelectionChanged="(ranges) =&gt; this.onBaselineRangeChanged(ranges)" onSelectionConfirmed="() =&gt; this.updateBaselineRange()"/>
        <div class="o-section-subtitle">Baseline format</div>
        <select t-att-value="props.definition.baselineMode" class="o-input o-type-selector o-optional" t-on-change="(ev) =&gt; this.updateBaselineMode(ev)">
          <option value="text">Absolute value</option>
          <option value="difference">Value change from key value</option>
          <option value="percentage">Percentage change from key value</option>
        </select>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ScorecardChartDesignPanel">
    <t t-set="background_color">Background Color</t>
    <t t-set="color_up">Color Up</t>
    <t t-set="color_down">Color Down</t>
    <div>
      <div class="o-section o-chart-background-color">
        <div class="o-section-title">Background color</div>
        <div class="d-flex align-items-center">
          <span class="pe-1">Select a color...</span>
          <ColorPickerWidget currentColor="props.definition.background" toggleColorPicker="() =&gt; this.toggleColorPicker('backgroundColor')" showColorPicker="state.openedColorPicker === 'backgroundColor'" onColorPicked="(color) =&gt; this.setColor(color, 'backgroundColor')" title="background_color" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
        </div>
      </div>

      <div class="o-section o-chart-title">
        <div class="o-section-title">Title</div>
        <input type="text" t-model="state.title" t-on-change="updateTitle" class="o-input o-optional" placeholder="New Chart"/>
      </div>
      <div class="o-section">
        <div class="o-section-title">Baseline description</div>
        <input type="text" t-att-value="translate(props.definition.baselineDescr)" t-on-change="updateBaselineDescr" class="o-input o-optional"/>
      </div>
    </div>
    <div class="o-section o-chart-baseline-color">
      <div class="o-section-title">Baseline color</div>
      <div class="d-flex align-items-center">
        <span class="pe-1">Color on value increase</span>
        <ColorPickerWidget currentColor="props.definition.baselineColorUp" toggleColorPicker="() =&gt; this.toggleColorPicker('baselineColorUp')" showColorPicker="state.openedColorPicker === 'baselineColorUp'" onColorPicked="(color) =&gt; this.setColor(color, 'baselineColorUp')" title="color_up" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
      </div>
      <div class="d-flex align-items-center">
        <span class="pe-1">Color on value decrease</span>
        <ColorPickerWidget currentColor="props.definition.baselineColorDown" toggleColorPicker="() =&gt; this.toggleColorPicker('baselineColorDown')" showColorPicker="state.openedColorPicker === 'baselineColorDown'" onColorPicked="(color) =&gt; this.setColor(color, 'baselineColorDown')" title="color_down" icon="'o-spreadsheet-Icon.FILL_COLOR'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-CellIsRuleEditorPreview">
    <div class="o-cf-preview-line" t-attf-style="font-weight:{{currentStyle.bold ?'bold':'normal'}};                        text-decoration:{{getTextDecoration(currentStyle)}};                        font-style:{{currentStyle.italic?'italic':'normal'}};                        color:{{currentStyle.textColor || '#000'}};                        border-radius: 4px;                        background-color:{{currentStyle.fillColor}};">
      <t t-if="previewText" t-esc="previewText"/>
      <t t-else="">Preview text</t>
    </div>
  </t>

  <t t-name="o-spreadsheet-CellIsRuleEditor">
    <t t-set="fill_color">Fill Color</t>
    <t t-set="text_color">Text Color</t>
    <div class="o-cf-cell-is-rule">
      <div class="o-section-subtitle">Format cells if...</div>
      <select t-model="rule.operator" class="o-input o-cell-is-operator">
        <t t-foreach="Object.keys(cellIsOperators)" t-as="op" t-key="op_index">
          <option t-att-value="op" t-esc="cellIsOperators[op]"/>
        </t>
      </select>
      <t t-if="rule.operator !== 'IsEmpty' and rule.operator !== 'IsNotEmpty'">
        <input type="text" placeholder="Value or formula" t-model="rule.values[0]" t-att-class="{ 'o-invalid': isValue1Invalid }" class="o-input o-cell-is-value o-required" t-on-keydown="(ev) =&gt; this.onKeydown(ev)"/>
        <t t-if="rule.operator === 'Between' || rule.operator === 'NotBetween'">
          <input type="text" placeholder="and value or formula" t-model="rule.values[1]" t-att-class="{ 'o-invalid': isValue2Invalid }" class="o-input o-cell-is-value o-required" t-on-keydown="(ev) =&gt; this.onKeydown(ev)"/>
        </t>
      </t>
      <div class="o-section-subtitle">Formatting style</div>

      <t t-call="o-spreadsheet-CellIsRuleEditorPreview">
        <t t-set="currentStyle" t-value="rule.style"/>
      </t>
      <div class="o-sidePanel-tools">
        <div class="o-tool" title="Bold" t-att-class="{active:rule.style.bold}" t-on-click="() =&gt; this.toggleStyle('bold')">
          <t t-call="o-spreadsheet-Icon.BOLD"/>
        </div>
        <div class="o-tool" title="Italic" t-att-class="{active:rule.style.italic}" t-on-click="() =&gt; this.toggleStyle('italic')">
          <t t-call="o-spreadsheet-Icon.ITALIC"/>
        </div>
        <div class="o-tool" title="Underline" t-att-class="{active:rule.style.underline}" t-on-click="(ev) =&gt; this.toggleStyle('underline', ev)">
          <t t-call="o-spreadsheet-Icon.UNDERLINE"/>
        </div>
        <div class="o-tool" title="Strikethrough" t-att-class="{active:rule.style.strikethrough}" t-on-click="(ev) =&gt; this.toggleStyle('strikethrough', ev)">
          <t t-call="o-spreadsheet-Icon.STRIKE"/>
        </div>
        <ColorPickerWidget currentColor="rule.style.textColor || '#000000'" toggleColorPicker="(ev) =&gt; this.toggleMenu('cellIsRule-textColor', ev)" showColorPicker="state.openedMenu === 'cellIsRule-textColor'" onColorPicked="(color) =&gt; this.setColor('textColor', color)" title="text_color" icon="'o-spreadsheet-Icon.TEXT_COLOR'" class="'o-tool'"/>
        <div class="o-divider"/>
        <ColorPickerWidget currentColor="rule.style.fillColor" toggleColorPicker="(ev) =&gt; this.toggleMenu('cellIsRule-fillColor', ev)" showColorPicker="state.openedMenu === 'cellIsRule-fillColor'" onColorPicked="(color) =&gt; this.setColor('fillColor', color)" title="fill_color" icon="'o-spreadsheet-Icon.FILL_COLOR'" class="'o-tool'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormattingEditor">
    <div class="o-cf-ruleEditor">
      <div class="o-section o-cf-range">
        <div class="o-section-title">Apply to range</div>
        <div class="o-selection-cf">
          <SelectionInput ranges="() =&gt; state.currentCF.ranges" class="'o-range'" isInvalid="isRangeValid" onSelectionChanged="(ranges) =&gt; this.onRangesChanged(ranges)" required="true"/>
        </div>
        <div class="o-section-title">Format rules</div>
        <div class="o_field_radio o_horizontal o_field_widget o-cf-type-selector">
          <div class="custom-control form-check o_cf_radio_item" t-on-click="() =&gt; this.changeRuleType('CellIsRule')">
            <input class="form-check-input o_radio_input" t-att-checked="state.currentCFType === 'CellIsRule'" type="radio" id="cellIsRule" name="ruleType" value="CellIsRule"/>
            <label for="cellIsRule" class="form-check-label o_form_label">Single color</label>
          </div>
          <div class="custom-control form-check o_cf_radio_item" t-on-click="() =&gt; this.changeRuleType('ColorScaleRule')">
            <input class="form-check-input o_radio_input" t-att-checked="state.currentCFType === 'ColorScaleRule'" type="radio" id="colorScaleRule" name="ruleType" value="ColorScaleRule"/>
            <label for="colorScaleRule" class="form-check-label o_form_label">Color scale</label>
          </div>

          <div class="custom-control form-check o_cf_radio_item" t-on-click="() =&gt; this.changeRuleType('IconSetRule')">
            <input class="form-check-input o_radio_input" t-att-checked="state.currentCFType === 'IconSetRule'" type="radio" id="iconSetRule" name="ruleType" value="IconSetRule"/>
            <label for="iconSetRule" class="form-check-label o_form_label">Icon set</label>
          </div>
        </div>
      </div>
      <div class="o-section o-cf-editor">
        <t t-if="state.currentCFType === 'CellIsRule'" t-call="o-spreadsheet-CellIsRuleEditor">
          <t t-set="rule" t-value="state.rules.cellIs"/>
        </t>
        <t t-if="state.currentCFType === 'ColorScaleRule'" t-call="o-spreadsheet-ColorScaleRuleEditor">
          <t t-set="rule" t-value="state.rules.colorScale"/>
        </t>
        <t t-if="state.currentCFType === 'IconSetRule'" t-call="o-spreadsheet-IconSetEditor">
          <t t-set="rule" t-value="state.rules.iconSet"/>
        </t>
        <div class="o-sidePanelButtons">
          <button t-on-click="props.onExitEdition" class="o-button o-button-grey o-cf-cancel">
            Cancel
          </button>
          <button t-on-click="saveConditionalFormat" class="o-button o-button-grey primary o-cf-save">
            Save
          </button>
        </div>
      </div>
      <div class="o-section">
        <div class="o-cf-error" t-foreach="state.errors || []" t-as="error" t-key="error_index">
          <t t-esc="errorMessage(error)"/>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ColorScaleRuleEditorPreview">
    <div class="o-cf-preview-gradient" t-attf-style="{{getPreviewGradient()}}">Preview text</div>
  </t>

  <t t-name="o-spreadsheet-ColorScaleRuleEditorThreshold">
    <t t-set="fill_color">Fill Color</t>
    <div t-attf-class="o-threshold o-threshold-{{thresholdType}}">
      <t t-if="thresholdType === 'midpoint'">
        <t t-set="type" t-value="threshold and threshold.type"/>
        <select class="o-input" name="valueType" t-on-change="onMidpointChange" t-on-click="closeMenus">
          <option value="none" t-att-selected="threshold === undefined">None</option>
          <option value="number" t-att-selected="type === 'number'">FixedNumber</option>
          <option value="percentage" t-att-selected="type === 'percentage'">Percentage</option>
          <option value="percentile" t-att-selected="type === 'percentile'">Percentile</option>
          <option value="formula" t-att-selected="type === 'formula'">Formula</option>
        </select>
      </t>
      <t t-else="">
        <select class="o-input" name="valueType" t-model="threshold.type" t-on-click="closeMenus">
          <option value="value">Cell values</option>
          <option value="number">Number</option>
          <option value="percentage">Percentage</option>
          <option value="percentile">Percentile</option>
          <option value="formula">Formula</option>
        </select>
      </t>
      <input type="text" class="o-input o-threshold-value o-required" t-model="rule[thresholdType].value" t-att-class="{ 'o-invalid': isValueInvalid(thresholdType) }" t-if="threshold !== undefined and threshold.type !== 'value'"/>
      <input type="text" class="o-input o-threshold-value" t-else="" disabled="1"/>
      <ColorPickerWidget currentColor="getThresholdColor(threshold)" toggleColorPicker="(ev) =&gt; this.toggleMenu('colorScale-'+thresholdType+'Color', ev)" showColorPicker="state.openedMenu === 'colorScale-'+thresholdType+'Color'" onColorPicked="(color) =&gt; this.setColorScaleColor(thresholdType, color)" title="fill_color" icon="'o-spreadsheet-Icon.FILL_COLOR'" disabled="threshold === undefined"/>
    </div>
  </t>

  <t t-name="o-spreadsheet-ColorScaleRuleEditor">
    <div class="o-cf-color-scale-editor">
      <div class="o-section-subtitle">Preview</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorPreview"/>
      <div class="o-section-subtitle">Minpoint</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorThreshold">
        <t t-set="threshold" t-value="rule.minimum"/>
        <t t-set="thresholdType" t-value="'minimum'"/>
      </t>
      <div class="o-section-subtitle">MidPoint</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorThreshold">
        <t t-set="threshold" t-value="rule.midpoint"/>
        <t t-set="thresholdType" t-value="'midpoint'"/>
      </t>
      <div class="o-section-subtitle">MaxPoint</div>
      <t t-call="o-spreadsheet-ColorScaleRuleEditorThreshold">
        <t t-set="threshold" t-value="rule.maximum"/>
        <t t-set="thresholdType" t-value="'maximum'"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-IconSets">
    <div>
      <div class="o-section-subtitle">Icons</div>
      <div class="o-cf-iconsets">
        <div class="o-cf-iconset" t-foreach="['arrows', 'smiley', 'dots']" t-as="iconSet" t-key="iconSet" t-on-click="(ev) =&gt; this.setIconSet(iconSet, ev)">
          <div class="o-cf-icon">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].good].template}}"/>
          </div>
          <div class="o-cf-icon">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].neutral].template}}"/>
          </div>
          <div class="o-cf-icon">
            <t t-call="o-spreadsheet-Icon.{{icons[iconSets[iconSet].bad].template}}"/>
          </div>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-IconSetInflexionPointRow">
    <tr>
      <td>
        <div t-on-click.stop="(ev) =&gt; this.toggleMenu('iconSet-'+icon+'Icon', ev)">
          <div class="o-cf-icon-button">
            <t t-call="o-spreadsheet-Icon.{{icons[iconValue].template}}"/>
          </div>
        </div>
        <IconPicker t-if="state.openedMenu === 'iconSet-'+icon+'Icon'" onIconPicked="(i) =&gt; this.setIcon(icon, i)"/>
      </td>
      <td>When value is</td>
      <td>
        <select class="o-input" name="valueType" t-model="inflectionPointValue.operator">
          <option value="gt">
            <span>&gt;</span>
          </option>
          <option value="ge">
            <span>≥</span>
          </option>
        </select>
      </td>
      <td>
        <input type="text" class="o-input" t-att-class="{ 'o-invalid': isInflectionPointInvalid(inflectionPoint) }" t-model="rule[inflectionPoint].value"/>
      </td>
      <td>
        <select class="o-input" name="valueType" t-model="inflectionPointValue.type">
          <option value="number">Number</option>
          <option value="percentage">Percentage</option>
          <option value="percentile">Percentile</option>
          <option value="formula">Formula</option>
        </select>
      </td>
    </tr>
  </t>

  <t t-name="o-spreadsheet-IconSetInflexionPoints">
    <div class="o-inflection">
      <table>
        <tr>
          <th class="o-cf-iconset-icons"/>
          <th class="o-cf-iconset-text"/>
          <th class="o-cf-iconset-operator"/>
          <th class="o-cf-iconset-value">Value</th>
          <th class="o-cf-iconset-type">Type</th>
        </tr>
        <t t-call="o-spreadsheet-IconSetInflexionPointRow">
          <t t-set="iconValue" t-value="rule.icons.upper"/>
          <t t-set="icon" t-value="'upper'"/>
          <t t-set="inflectionPointValue" t-value="rule.upperInflectionPoint"/>
          <t t-set="inflectionPoint" t-value="'upperInflectionPoint'"/>
        </t>
        <t t-call="o-spreadsheet-IconSetInflexionPointRow">
          <t t-set="iconValue" t-value="rule.icons.middle"/>
          <t t-set="icon" t-value="'middle'"/>
          <t t-set="inflectionPointValue" t-value="rule.lowerInflectionPoint"/>
          <t t-set="inflectionPoint" t-value="'lowerInflectionPoint'"/>
        </t>
        <tr>
          <td>
            <div t-on-click.stop="(ev) =&gt; this.toggleMenu('iconSet-lowerIcon', ev)">
              <div class="o-cf-icon-button">
                <t t-call="o-spreadsheet-Icon.{{icons[rule.icons.lower].template}}"/>
              </div>
            </div>
            <IconPicker t-if="state.openedMenu === 'iconSet-lowerIcon'" onIconPicked="(icon) =&gt; this.setIcon('lower', icon)"/>
          </td>
          <td>Else</td>
          <td/>
          <td/>
          <td/>
        </tr>
      </table>
    </div>
  </t>
  <t t-name="o-spreadsheet-IconSetEditor">
    <div class="o-cf-iconset-rule">
      <t t-call="o-spreadsheet-IconSets"/>
      <t t-call="o-spreadsheet-IconSetInflexionPoints"/>
      <div class="btn btn-link o_refresh_measures o-cf-iconset-reverse" t-on-click="reverseIcons">
        <div class="me-1 d-inline-block">
          <t t-call="o-spreadsheet-Icon.REFRESH"/>
        </div>
        Reverse icons
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormatPreviewList">
    <div class="o-cf-preview-list h-100 overflow-auto" t-ref="cfList">
      <t t-foreach="props.conditionalFormats" t-as="cf" t-key="cf.id">
        <t t-call="o-spreadsheet-ConditionalFormattingPanelPreview"/>
      </t>
      <div class="btn btn-link o-sidePanel-btn-link o-cf-add float-end" t-on-click.prevent.stop="props.onAddConditionalFormat">
        + Add another rule
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormattingPanelPreview">
    <div class="o-cf-preview d-flex position-relative" t-att-class="{ 'o-cf-dragging': dragAndDrop.draggedItemId === cf.id }" t-att-style="getPreviewDivStyle(cf)" t-att-data-id="cf.id" t-on-click="(ev) =&gt; props.onPreviewClick(cf)" t-on-mousedown="(ev) =&gt; this.onMouseDown(cf, ev)">
      <div class="position-relative h-100 w-100 d-flex align-items-center">
        <div class="o-cf-drag-handle h-100 position-absolute d-flex align-items-center text-muted">
          <t t-call="o-spreadsheet-Icon.THIN_DRAG_HANDLE"/>
        </div>
        <t t-if="cf.rule.type==='IconSetRule'">
          <div class="o-cf-preview-icon d-flex justify-content-around align-items-center me-2">
            <t t-call="o-spreadsheet-Icon.{{icons[cf.rule.icons.upper].template}}"/>
            <t t-call="o-spreadsheet-Icon.{{icons[cf.rule.icons.middle].template}}"/>
            <t t-call="o-spreadsheet-Icon.{{icons[cf.rule.icons.lower].template}}"/>
          </div>
        </t>
        <t t-else="">
          <div t-att-style="getPreviewImageStyle(cf.rule)" class="o-cf-preview-icon d-flex justify-content-around align-items-center me-2">
            123
          </div>
        </t>
        <div class="o-cf-preview-description">
          <div class="o-cf-preview-ruletype">
            <div class="o-cf-preview-description-rule text-truncate">
              <t t-esc="getDescription(cf)"/>
            </div>
          </div>
          <div class="o-cf-preview-range text-truncate" t-esc="cf.ranges"/>
        </div>
        <div class="o-cf-delete">
          <div class="o-cf-delete-button text-muted" t-on-click.stop="(ev) =&gt; this.deleteConditionalFormat(cf, ev)" title="Remove rule">
            <t t-call="o-spreadsheet-Icon.TRASH"/>
          </div>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-ConditionalFormattingPanel">
    <div class="o-cf h-100">
      <t t-if="state.mode === 'list'">
        <ConditionalFormatPreviewList conditionalFormats="conditionalFormats" onPreviewClick.bind="editConditionalFormat" onAddConditionalFormat.bind="addConditionalFormat"/>
      </t>
      <t t-if="state.mode === 'edit'">
        <ConditionalFormattingEditor editedCf="state.editedCf" onExitEdition.bind="switchToList"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-CustomCurrencyPanel">
    <div class="o-custom-currency">
      <div class="o-section" t-if="availableCurrencies.length &gt; 1">
        <div class="o-section-title">Currency</div>
        <select class="o-input o-available-currencies" t-on-change="(ev) =&gt; this.updateSelectCurrency(ev)">
          <t t-foreach="availableCurrencies" t-as="currency" t-key="currency_index">
            <option t-att-value="currency_index" t-esc="currencyDisplayName(currency)" t-att-selected="currency_index === state.selectedCurrencyIndex"/>
          </t>
        </select>
      </div>
      <div class="o-section">
        <div class="o-subsection-left">
          <div class="o-section-title">Code</div>
          <input type="text" class="o-input" t-model="state.currencyCode" t-on-input="(ev) =&gt; this.updateCode(ev)"/>
        </div>
        <div class="o-subsection-right">
          <div class="o-section-title">Symbol</div>
          <input type="text" class="o-input" t-model="state.currencySymbol" t-on-input="(ev) =&gt; this.updateSymbol(ev)"/>
        </div>
      </div>
      <div class="o-section">
        <div class="o-section-title">Format</div>
        <select class="o-input o-format-proposals" t-on-change="(ev) =&gt; this.updateSelectFormat(ev)" t-att-disabled="!formatProposals.length">
          <t t-foreach="formatProposals" t-as="proposal" t-key="proposal_index">
            <option t-att-value="proposal_index" t-esc="proposal.example" t-att-selected="proposal_index === state.selectedFormatIndex"/>
          </t>
        </select>
      </div>
      <div class="o-sidePanelButtons">
        <button class="o-button o-button-grey" t-on-click="() =&gt; this.apply()" t-att-disabled="!formatProposals.length || isSameFormat">
          Apply
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationPanel">
    <div class="o-data-validation">
      <t t-if="state.mode === 'list'">
        <div class="o-dv-preview-list">
          <t t-foreach="validationRules" t-as="rule" t-key="rule.id">
            <DataValidationPreview rule="localizeDVRule(rule)" onClick="() =&gt; this.onPreviewClick(rule.id)"/>
          </t>
        </div>
        <div class="o-dv-add btn btn-link o-sidePanel-btn-link float-end" t-on-click="addDataValidationRule">
          + Add another rule
        </div>
      </t>
      <t t-else="">
        <DataValidationEditor rule="localizeDVRule(state.activeRule)" onExit.bind="onExitEditMode"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationDateCriterion">
    <select class="o-dv-date-value o-input mb-4" t-on-change="onDateValueChanged">
      <option t-foreach="dateValues" t-as="dateValue" t-key="dateValue.value" t-att-value="dateValue.value" t-esc="dateValue.title" t-att-selected="dateValue.value === props.criterion.dateValue"/>
    </select>

    <DataValidationInput t-if="props.criterion.dateValue === 'exactDate'" value="props.criterion.values[0]" onValueChanged.bind="onValueChanged" criterionType="props.criterion.type"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationDoubleInput">
    <DataValidationInput value="props.criterion.values[0]" onValueChanged.bind="onFirstValueChanged" criterionType="props.criterion.type"/>

    <div class="o-section-subtitle ms-1 my-2">and</div>
    <DataValidationInput value="props.criterion.values[1]" onValueChanged.bind="onSecondValueChanged" criterionType="props.criterion.type"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationInput">
    <div class="o-dv-input position-relative w-100">
      <input type="text" t-ref="input" t-on-input="onValueChanged" t-att-value="props.value" class="o-input" t-att-class="{             'o-invalid border-danger position-relative': errorMessage,           }" t-att-title="errorMessage" t-att-placeholder="placeholder" t-on-keydown="props.onKeyDown" t-on-blur="props.onBlur"/>
      <span t-if="errorMessage" class="error-icon text-danger position-absolute d-flex align-items-center" t-att-title="errorMessage">
        <t t-call="o-spreadsheet-Icon.ERROR"/>
      </span>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationSingleInput">
    <DataValidationInput value="props.criterion.values[0]" onValueChanged.bind="onValueChanged" criterionType="props.criterion.type"/>
  </t>

  <t t-name="o-spreadsheet-DataValidationListCriterionForm">
    <t t-foreach="displayedValues" t-as="value" t-key="value_index">
      <div class="o-dv-list-values d-flex align-items-center">
        <DataValidationInput value="props.criterion.values[value_index]" onValueChanged="(v) =&gt; this.onValueChanged(v, value_index)" criterionType="props.criterion.type" onKeyDown="(ev) =&gt; this.onKeyDown(ev, value_index)" focused="value_index === state.focusedValueIndex" onBlur.bind="onBlurInput"/>
        <div class="o-dv-list-item-delete ms-2 me-1" t-on-click="() =&gt; this.removeItem(value_index)">
          <t t-call="o-spreadsheet-Icon.TRASH"/>
        </div>
      </div>
      <div class="mb-2"/>
    </t>
    <button class="o-dv-list-add-value o-button o-button-grey mb-3" t-on-click="onAddAnotherValue">
      Add another item
    </button>

    <div class="o-section-subtitle">Display style</div>
    <select class="o-dv-display-style o-input" t-on-change="onChangedDisplayStyle">
      <option t-att-selected="props.criterion.displayStyle === 'arrow'" value="arrow">Arrow</option>
      <option t-att-selected="props.criterion.displayStyle === 'plainText'" value="plainText">
        Plain text
      </option>
    </select>
  </t>

  <t t-name="o-spreadsheet-DataValidationValueInRangeCriterionForm">
    <SelectionInput ranges="() =&gt; [props.criterion.values[0] || '']" onSelectionChanged="(ranges) =&gt; this.onRangeChanged(ranges[0])" required="true" hasSingleRange="true"/>

    <div class="o-section-subtitle">Display style</div>
    <select class="o-dv-display-style o-input" t-on-change="onChangedDisplayStyle">
      <option t-att-selected="props.criterion.displayStyle === 'arrow'" value="arrow">Arrow</option>
      <option t-att-selected="props.criterion.displayStyle === 'plainText'" value="plainText">
        Plain text
      </option>
    </select>
  </t>

  <t t-name="o-spreadsheet-DataValidationEditor">
    <div class="o-dv-form w-100 h-100">
      <div class="o-section o-dv-range">
        <div class="o-section-title">Apply to range</div>
        <SelectionInput ranges="() =&gt; state.rule.ranges" onSelectionChanged="(ranges) =&gt; this.onRangesChanged(ranges)" required="true"/>

        <div class="o-subsection o-dv-settings">
          <div class="o-section-title">Criteria</div>
          <SelectMenu class="'o-dv-type o-input mb-4'" menuItems="dvCriterionMenuItems" selectedValue="selectedCriterionName"/>

          <t t-if="criterionComponent" t-component="criterionComponent" t-key="state.rule.criterion.type" criterion="state.rule.criterion" onCriterionChanged.bind="onCriterionChanged"/>
        </div>
      </div>

      <div class="o-section o-dv-invalid-option">
        <div class="o-section-title">If the data is invalid</div>
        <select class="o-dv-reject-input o-input" t-on-change="changeRuleIsBlocking">
          <option t-att-selected="!state.rule.isBlocking" value="false">Show a warning</option>
          <option t-att-selected="state.rule.isBlocking" value="true">Reject the input</option>
        </select>
      </div>

      <div class="o-sidePanelButtons">
        <button t-on-click="props.onExit" class="o-dv-cancel o-button o-button-grey">Cancel</button>
        <button t-on-click="onSave" class="o-dv-save o-button o-button-grey primary" t-att-class="{'o-disabled': !canSave }">
          Save
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-DataValidationPreview">
    <div class="o-dv-preview p-3" t-on-click="props.onClick">
      <div class="d-flex justify-content-between">
        <div class="o-dv-container d-flex flex-column">
          <div class="o-dv-preview-description fw-bold text-truncate" t-esc="descriptionString"/>
          <div class="o-dv-preview-ranges text-truncate" t-esc="rangesString"/>
        </div>
        <div class="o-dv-preview-delete d-flex align-items-center text-muted px-3" t-on-click.stop="deleteDataValidation">
          <t t-call="o-spreadsheet-Icon.TRASH"/>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-FindAndReplacePanel">
    <div class="o-find-and-replace">
      <div class="o-section">
        <div class="o-section-title">Search</div>
        <div class="o-input-search-container">
          <input type="text" t-ref="searchInput" class="o-input o-input-with-count" t-on-input="onInput" t-on-keydown="onKeydownSearch"/>
          <div class="o-input-count" t-if="hasSearchResult">
            <t t-esc="env.model.getters.getCurrentSelectedMatchIndex()+1"/>
            /
            <t t-esc="env.model.getters.getSearchMatches().length"/>
          </div>
          <div t-elif="!pendingSearch and state.toSearch !== ''" class="o-input-count">0 / 0</div>
        </div>
        <div>

          <label class="o-checkbox mt-1">
            <input t-model="state.searchOptions.matchCase" t-on-change="updateSearch" type="checkbox"/>
            <span>Match case</span>
          </label>
          <label class="o-checkbox">
            <input t-model="state.searchOptions.exactMatch" t-on-change="updateSearch" type="checkbox"/>
            <span>Match entire cell content</span>
          </label>
          <label class="o-checkbox">
            <input t-model="state.searchOptions.searchFormulas" t-on-change="searchFormulas" type="checkbox"/>
            <span>Search in formulas</span>
          </label>
        </div>
      </div>
      <div class="o-sidePanelButtons">
        <button t-att-disabled="!hasSearchResult" t-on-click="onSelectPreviousCell" class="o-button o-button-grey">
          Previous
        </button>
        <button t-att-disabled="!hasSearchResult" t-on-click="onSelectNextCell" class="o-button o-button-grey">
          Next
        </button>
      </div>
      <div class="o-section" t-if="!env.model.getters.isReadonly()">
        <div class="o-section-title">Replace</div>
        <div class="o-input-search-container">
          <input type="text" class="o-input o-input-without-count" t-model="state.replaceWith" t-on-keydown="onKeydownReplace"/>
        </div>
      </div>

      <div class="o-sidePanelButtons" t-if="!env.model.getters.isReadonly()">
        <button t-att-disabled="env.model.getters.getCurrentSelectedMatchIndex() === null" t-on-click="replace" class="o-button o-button-grey">
          Replace
        </button>
        <button t-att-disabled="env.model.getters.getCurrentSelectedMatchIndex() === null" t-on-click="replaceAll" class="o-button o-button-grey">
          Replace all
        </button>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-MoreFormatsPanel">
    <div class="o-more-formats-panel">
      <div t-foreach="dateFormatsActions" t-as="action" t-key="action.name(env)" t-att-data-name="action.name(env)" t-on-click="() =&gt; action.execute(env)" class="w-100 d-flex align-items-center border-bottom format-preview">
        <span class="ms-3 check-icon">
          <t t-if="action.isActive(env)" t-call="o-spreadsheet-Icon.CHECK"/>
        </span>
        <span t-out="action.description(env)"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-RemoveDuplicatesPanel">
    <div class="o-remove-duplicates">
      <div class="o-section">
        <div class="o-section-subtitle" t-esc="selectionStatisticalInformation"/>
        <label class="o-checkbox">
          <input type="checkbox" t-att-checked="state.hasHeader" t-on-change="toggleHasHeader"/>
          Data has header row
        </label>
      </div>

      <div class="o-section">
        <div class="o-section-title">Columns to analyze</div>
        <div class="o-checkbox-selection overflow-auto p-3 vh-50 border rounded">
          <label class="o-checkbox">
            <input t-att-checked="isEveryColumnSelected" t-on-change="toggleAllColumns" type="checkbox"/>
            Select all
          </label>

          <t t-foreach="Object.keys(state.columns)" t-as="colIndex" t-key="colIndex">
            <label class="o-checkbox">
              <input type="checkbox" t-att-checked="state.columns[colIndex]" t-on-change="() =&gt; this.toggleColumn(colIndex)"/>
              <t t-esc="getColLabel(colIndex)"/>
            </label>
          </t>
        </div>
      </div>

      <div class="o-sidePanelButtons">
        <button class="o-button o-button-grey" t-att-class="{'o-disabled': !canConfirm}" t-on-click="onRemoveDuplicates">
          Remove duplicates
        </button>
      </div>

      <div class="o-section" t-if="errorMessages.length">
        <ValidationMessages messages="errorMessages" msgType="'error'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-SelectMenu">
    <select t-att-class="props.class" t-ref="select" t-on-mousedown.stop.prevent="" t-on-click="onClick">
      <option selected="true" t-esc="props.selectedValue"/>
    </select>
    <Menu t-if="state.isMenuOpen" menuItems="props.menuItems" position="menuPosition" onClose.bind="onMenuClosed" menuId="menuId"/>
  </t>

  <t t-name="o-spreadsheet-SettingsPanel">
    <div class="o-settings-panel">
      <div class="o-section">
        <div class="o-section-title">Locale</div>
        <select class="o-input o-type-selector" t-on-change="(ev) =&gt; this.onLocaleChange(ev.target.value)">
          <option t-foreach="supportedLocales" t-as="locale" t-key="locale.code" t-att-value="locale.code" t-esc="locale.name" t-att-selected="currentLocale.code === locale.code"/>
        </select>
        <div class="o-locale-preview mt-2 ms-3">
          <div>
            <span class="fw-bold me-1">Number:</span>
            <span t-esc="numberFormatPreview"/>
          </div>
          <div>
            <span class="fw-bold me-1">Date:</span>
            <span t-esc="dateFormatPreview"/>
          </div>
          <div>
            <span class="fw-bold me-1">Date time:</span>
            <span t-esc="dateTimeFormatPreview"/>
          </div>
        </div>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-SidePanel">
    <div class="o-sidePanel">
      <div class="o-sidePanelHeader">
        <div class="o-sidePanelTitle" t-esc="getTitle()"/>
        <div class="o-sidePanelClose" t-on-click="() =&gt; this.props.onCloseSidePanel()">✕</div>
      </div>
      <div class="o-sidePanelBody">
        <t t-component="state.panel.Body" t-props="props.panelProps" onCloseSidePanel="props.onCloseSidePanel" t-key="'Body_' + props.component"/>
      </div>
      <div class="o-sidePanelFooter" t-if="state.panel.Footer">
        <t t-component="state.panel.Footer" t-props="props.panelProps" t-key="'Footer_' + props.component"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-SplitIntoColumnsPanel">
    <div class="o-split-to-cols-panel">
      <div class="o-section">
        <div class="o-section-title">Separator</div>
        <select class="o-input o-type-selector" t-on-change="(ev) =&gt; this.onSeparatorChange(ev.target.value)">
          <option t-foreach="separators" t-as="separator" t-key="separator.value" t-att-value="separator.value" t-esc="separator.name" t-att-selected="state.separatorValue === separator.value"/>
        </select>

        <input class="o-input o-required mt-3" type="text" t-if="state.separatorValue === 'custom'" t-att-value="state.customSeparator" t-on-input="updateCustomSeparator" placeholder="Add any characters or symbol"/>

        <label class="o-checkbox">
          <input type="checkbox" name="add columns" t-att-checked="state.addNewColumns" t-on-change="updateAddNewColumnsCheckbox"/>
          Add new columns to avoid overwriting cells
        </label>

        <div class="o-sidePanelButtons">
          <button class="o-button o-button-grey" t-att-class="{'o-disabled': isConfirmDisabled}" t-on-click="confirm">
            Confirm
          </button>
        </div>

        <ValidationMessages messages="errorMessages" msgType="'error'"/>
        <ValidationMessages messages="warningMessages" msgType="'warning'"/>
      </div>
    </div>
  </t>

  <t t-name="o-spreadsheet-Spreadsheet">
    <div class="o-spreadsheet" t-on-keydown="(ev) =&gt; !env.isDashboard() and this.onKeydown(ev)" t-att-style="getStyle()">
      <t t-if="env.isDashboard()">
        <SpreadsheetDashboard/>
      </t>
      <t t-else="">
        <TopBar onClick="() =&gt; this.focusGrid()" onComposerContentFocused="(selection) =&gt; this.onTopBarComposerFocused(selection)" focusComposer="focusTopBarComposer" dropdownMaxHeight="gridHeight"/>
        <div class="o-grid-container" t-att-class="{'o-two-columns': !sidePanel.isOpen}" t-att-style="gridContainerStyle" t-on-click="this.focusGrid">
          <div class="o-top-left"/>
          <div class="o-column-groups">
            <HeaderGroupContainer layers="colLayers" dimension="'COL'"/>
          </div>
          <div class="o-row-groups">
            <HeaderGroupContainer layers="rowLayers" dimension="'ROW'"/>
          </div>
          <div class="o-group-grid overflow-hidden">
            <Grid sidePanelIsOpen="sidePanel.isOpen" focusComposer="focusGridComposer" exposeFocus="(focus) =&gt; this._focusGrid = focus" onComposerContentFocused="() =&gt; this.onGridComposerContentFocused()" onGridComposerCellFocused="(content, selection) =&gt; this.onGridComposerCellFocused(content, selection)"/>
          </div>
        </div>
        <SidePanel t-if="sidePanel.isOpen" onCloseSidePanel="() =&gt; this.closeSidePanel()" component="sidePanel.component" panelProps="sidePanel.panelProps"/>
        <BottomBar onClick="() =&gt; this.focusGrid()"/>
      </t>
    </div>
  </t>

  <t t-name="o-spreadsheet-TopBar">
    <t t-set="text_color">Text Color</t>
    <t t-set="fill_color">Fill Color</t>
    <div class="o-spreadsheet-topbar o-two-columns d-flex flex-column user-select-none" t-on-click="props.onClick">
      <div class="o-topbar-top d-flex justify-content-between">

        <div class="o-topbar-topleft d-flex">
          <t t-foreach="menus" t-as="menu" t-key="menu_index">
            <div t-if="menu.children.length !== 0" class="o-topbar-menu o-hoverable-button rounded" t-att-class="{'active': state.menuState.parentMenu and state.menuState.parentMenu.id === menu.id}" t-on-click="(ev) =&gt; this.toggleContextMenu(menu, ev)" t-on-mouseover="(ev) =&gt; this.onMenuMouseOver(menu, ev)" t-att-data-id="menu.id">
              <t t-esc="getMenuName(menu)"/>
            </div>
          </t>
        </div>
        <div class="o-topbar-topright d-flex justify-content-end">
          <div t-foreach="topbarComponents" t-as="comp" t-key="comp.id">
            <t t-component="comp.component"/>
          </div>
        </div>
      </div>

      <div class="d-flex">
        <div class="o-topbar-toolbar d-flex flex-shrink-0">

          <div t-if="env.model.getters.isReadonly()" class="o-readonly-toolbar d-flex align-items-center text-muted">
            <span>
              <i class="fa fa-eye"/>
              Readonly Access
            </span>
          </div>
          <div t-else="" class="o-toolbar-tools d-flex flex-shrink-0 ms-4">
            <ActionButton action="EDIT.undo" class="'o-hoverable-button'"/>
            <ActionButton action="EDIT.redo" class="'o-hoverable-button'"/>
            <PaintFormatButton class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.clearFormat" class="'o-hoverable-button'"/>

            <div class="o-divider"/>

            <ActionButton action="FORMAT.formatPercent" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.decraseDecimalPlaces" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.incraseDecimalPlaces" class="'o-hoverable-button'"/>
            <ActionButton action="formatNumberMenuItemSpec" onClick="(ev) =&gt; this.toggleToolbarContextMenu(formatNumberMenuItemSpec, ev)" hasTriangleDownIcon="true" class="'o-hoverable-button'"/>

            <div class="o-divider"/>
            <FontSizeEditor class="'o-hoverable-button'" onToggle.bind="this.onClick" dropdownStyle="this.dropdownStyle"/>
            <div class="o-divider"/>

            <ActionButton action="FORMAT.formatBold" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.formatItalic" class="'o-hoverable-button'"/>
            <ActionButton action="FORMAT.formatStrikethrough" class="'o-hoverable-button'"/>

            <ColorPickerWidget currentColor="state.textColor" toggleColorPicker="(ev) =&gt; this.toggleDropdownTool('textColorTool', ev)" showColorPicker="state.activeTool === 'textColorTool'" onColorPicked="(color) =&gt; this.setColor('textColor', color)" title="text_color" icon="'o-spreadsheet-Icon.TEXT_COLOR'" dropdownMaxHeight="this.props.dropdownMaxHeight" class="'o-hoverable-button o-menu-item-button'"/>

            <div class="o-divider"/>

            <ColorPickerWidget currentColor="state.fillColor" toggleColorPicker="(ev) =&gt; this.toggleDropdownTool('fillColorTool', ev)" showColorPicker="state.activeTool === 'fillColorTool'" onColorPicked="(color) =&gt; this.setColor('fillColor', color)" title="fill_color" icon="'o-spreadsheet-Icon.FILL_COLOR'" dropdownMaxHeight="this.props.dropdownMaxHeight" class="'o-hoverable-button o-menu-item-button'"/>

            <BorderEditorWidget class="'o-hoverable-button o-menu-item-button'" toggleBorderEditor="(ev) =&gt; this.toggleDropdownTool('borderTool', ev)" showBorderEditor="state.activeTool === 'borderTool'" dropdownMaxHeight="this.props.dropdownMaxHeight"/>
            <ActionButton action="EDIT.mergeCells" class="'o-hoverable-button'"/>
            <div class="o-divider"/>

            <div class="o-dropdown">
              <ActionButton action="FORMAT.formatAlignmentHorizontal" hasTriangleDownIcon="true" t-on-click="(ev) =&gt; this.toggleDropdownTool('horizontalAlignTool', ev)" class="'o-hoverable-button'"/>
              <div class="o-dropdown-content" t-if="state.activeTool === 'horizontalAlignTool'" t-att-style="dropdownStyle" t-on-click.stop="">
                <div class="o-dropdown-line">
                  <ActionButton action="FORMAT.formatAlignmentLeft" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentCenter" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentRight" class="'o-hoverable-button'"/>
                </div>
              </div>
            </div>
            <div class="o-dropdown">
              <ActionButton action="FORMAT.formatAlignmentVertical" hasTriangleDownIcon="true" t-on-click="(ev) =&gt; this.toggleDropdownTool('verticalAlignTool', ev)" class="'o-hoverable-button'"/>
              <div class="o-dropdown-content" t-att-style="dropdownStyle" t-if="state.activeTool === 'verticalAlignTool'" t-on-click.stop="">
                <div class="o-dropdown-line">
                  <ActionButton action="FORMAT.formatAlignmentTop" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentMiddle" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatAlignmentBottom" class="'o-hoverable-button'"/>
                </div>
              </div>
            </div>
            <div class="o-dropdown">
              <ActionButton action="FORMAT.formatWrapping" hasTriangleDownIcon="true" t-on-click="(ev) =&gt; this.toggleDropdownTool('textWrappingTool', ev)" class="'o-hoverable-button'"/>
              <div class="o-dropdown-content" t-att-style="dropdownStyle" t-if="state.activeTool === 'textWrappingTool'" t-on-click.stop="">
                <div class="o-dropdown-line">
                  <ActionButton action="FORMAT.formatWrappingOverflow" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatWrappingWrap" class="'o-hoverable-button'"/>
                  <ActionButton action="FORMAT.formatWrappingClip" class="'o-hoverable-button'"/>
                </div>
              </div>
            </div>

            <div class="o-divider"/>

            <ActionButton action="VIEW.createRemoveFilter" class="'o-hoverable-button'"/>
          </div>
        </div>
        <TopBarComposer focus="props.focusComposer" onComposerContentFocused="props.onComposerContentFocused"/>
      </div>
    </div>
    <Menu t-if="state.menuState.isOpen" position="state.menuState.position" menuItems="state.menuState.menuItems" onClose="() =&gt; this.closeMenus()" onMenuClicked="() =&gt; this.props.onClick()"/>
  </t>

  <t t-name="o-spreadsheet-ValidationMessages">
    <t t-foreach="props.messages" t-as="msg" t-key="msg">
      <div class="d-flex align-items-center o-side-panel-error" t-att-class="divClasses">
        <t t-call="o-spreadsheet-Icon.TRIANGLE_EXCLAMATION"/>
        <span t-esc="msg"/>
      </div>
    </t>
  </t>
<t t-name="spreadsheet.ShareButton">
    <Dropdown togglerClass="togglerClass" menuClass="'spreadsheet_share_dropdown d-flex flex-column h-auto'" position="'bottom-end'" onOpened.bind="onOpened" disabled="!props.model">
      <t t-set-slot="toggler">
        <i class="fa fa-share-alt"/>
              Share
      </t>
      <t t-if="state.url">
        <div class="d-flex px-3">
          <div class="align-self-center d-flex justify-content-center align-items-center flex-shrink-0">
            <i class="fa fa-globe fa-2x" title="Share to web"/>
          </div>
          <div class="flex-grow-1 px-3">
            <div class="lead">Spreadsheet published</div>
            <div>Frozen version - Anyone can view</div>
          </div>
        </div>
        <div class=" px-3 o_field_widget o_readonly_modifier o_field_CopyClipboardChar">
          <div class="d-grid rounded-2 overflow-hidden">
            <span t-out="state.url"/>
            <CopyButton className="'o_btn_char_copy btn-sm'" content="state.url" successText="copiedText"/>
          </div>
        </div>
      </t>
      <div t-else="" class="d-flex align-items-center justify-content-center h-100">
        <i class="fa fa-spin fa-spinner px-2"/><span>Generating sharing link</span>
      </div>
    </Dropdown>
  </t>
<div t-name="spreadsheet.DateFromToValue" class="date_filter_values">
        <DateTimeInput value="dateFrom" type="'date'" placeholder="fromPlaceholder" onChange.bind="onDateFromChanged"/>
        <i class="oi oi-arrow-right"/>
        <DateTimeInput value="dateTo" type="'date'" placeholder="toPlaceholder" onChange.bind="onDateToChanged"/>
    </div>
<div t-name="spreadsheet_edition.DateFilterValue" class="date_filter_values">
        <select class="o_input me-3" t-on-change="onPeriodChanged">
            <option value="empty">Select period...</option>
            <t t-foreach="dateOptions" t-as="periodOption" t-key="periodOption.id">
                <option t-if="isSelected(periodOption.id)" selected="1" t-att-value="periodOption.id">
                    <t t-esc="periodOption.description"/>
                </option>
                <option t-else="" t-att-value="periodOption.id">
                    <t t-esc="periodOption.description"/>
                </option>
            </t>
        </select>
        <DateTimeInput value="date" format="'yyyy'" minPrecision="'years'" type="'date'" placeholder="'Select year...'" onChange.bind="onYearChanged"/>
    </div>
<t t-name="spreadsheet.TextFilterValue">
        <select t-if="props.options?.length" t-on-change="(e) =&gt; props.onValueChanged(e.target.value)" class="o_input me-3" required="true">
            <option value="">Choose a value...</option>
            <t t-foreach="props.options" t-as="option" t-key="option.formattedValue">
                <option t-att-selected="option.value === props.value" t-att-value="option.value" t-esc="option.formattedValue"/>
            </t>
        </select>
        <input type="text" t-else="" class="o_input o-global-filter-text-value text-truncate" t-att-placeholder="translate(props.label)" t-att-value="props.value" t-on-change="(e) =&gt; props.onValueChanged(e.target.value)"/>
    </t>
<t t-name="spreadsheet_edition.FilterValue">
        <div class="o-filter-value d-flex align-items-start w-100">
            <div t-if="filter.type === 'text'" class="w-100">
                <TextFilterValue value="filterValue" label="filter.label" options="textAllowedValues" onValueChanged="(value) =&gt; this.onTextInput(filter.id, value)"/>
            </div>
            <span t-if="filter.type === 'relation'" class="w-100">
                <MultiRecordSelector placeholder="' ' + translate(filter.label)" resModel="filter.modelName" resIds="filterValue || []" update="(resIds) =&gt; this.onTagSelected(filter.id, resIds)"/>
            </span>
            <div t-if="filter.type === 'date'" class="w-100">
                <select t-if="filter.rangeType === 'relative'" t-on-change="(e) =&gt; this.onDateInput(filter.id, e.target.value || undefined)" class="date_filter_values o_input me-3" required="true">
                    <option value="">Select period...</option>
                    <t t-foreach="relativeDateRangesTypes" t-as="range" t-key="range.type">
                        <option t-att-selected="range.type === filterValue" t-att-value="range.type">
                            <t t-esc="range.description"/>
                        </option>
                    </t>
                </select>
                <DateFromToValue t-elif="filter.rangeType === 'from_to'" from="filterValue?.from" to="filterValue?.to" onFromToChanged="(value) =&gt; this.onDateInput(filter.id, value)"/>

                <DateFilterValue t-else="" period="filterValue?.period" yearOffset="filterValue?.yearOffset" onTimeRangeChanged="(value) =&gt; this.onDateInput(filter.id, value)"/>
            </div>
            <i t-if="getters.isGlobalFilterActive(filter.id)" class="fa fa-times btn btn-link text-muted o_side_panel_filter_icon ms-1" title="Clear" t-on-click="() =&gt; this.clear(filter.id)"/>
        </div>
    </t>
<t t-name="o-spreadsheet-Icon.SEE_RECORDS">
    <svg class="o-icon">
      <path fill="currentColor" d="M9.05 11.25c-1.49 0-2.7-1.21-2.7-2.7s1.21-2.7 2.7-2.7 2.7 1.21 2.7 2.7-1.21 2.7-2.7 2.7m0-1.8c.5 0 .9-.4.9-.9s-.4-.9-.9-.9-.9.4-.9.9.4.9.9.9M9 3.15c-3.75 0-6.7 2.1-8 5.06 1.3 2.97 4.25 5.74 8 5.74s6.7-2.77 8-5.74c-1.3-2.96-4.25-5.06-8-5.06m0 9c-2.84 0-4.78-1.66-6.02-3.94C4.22 5.94 6.16 4.95 9 4.95s4.8.99 6.03 3.26c-1.23 2.27-3.19 3.94-6.03 3.94"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.DOWNLOAD">
    <svg class="o-icon">
      <path fill="currentColor" d="M2 10.5h1.5V15h11v-4.5H16v6H2M5.5 8H8V1h2v7h2.5L9 11.5"/>
    </svg>
  </t>
  <t t-name="o-spreadsheet-Icon.GLOBAL_FILTERS">
    <svg width="20" height="20" viewbox="0 0 20 20">
      <path fill="currentColor" d="M1 3h12L7 9M5.5 6h3v11l-3-3M14 4h4v2h-4m-3 3h7v2h-7m0 3h7v2h-7"/>
    </svg>
  </t>
<div t-name="spreadsheet_dashboard.DashboardAction" class="o_action o_spreadsheet_dashboard_action o_field_highlight">
        <ControlPanel display="controlPanelDisplay">
            <t t-set-slot="layout-actions">
                <t t-set="status" t-value="state.activeDashboard and state.activeDashboard.status"/>
                <FilterValue t-if="status === Status.Loaded" filter="filter" model="state.activeDashboard.model" t-as="filter" t-foreach="filters" t-key="filter.id"/>
            </t>
            <t t-set-slot="control-panel-navigation-additional">
                <SpreadsheetShareButton t-key="activeDashboardId" model="state.activeDashboard?.model" onSpreadsheetShared.bind="shareSpreadsheet"/>
            </t>
        </ControlPanel>
        <t t-set="dashboard" t-value="state.activeDashboard"/>
        <div class="o_content o_component_with_search_panel" t-att-class="{ o_mobile_dashboard: env.isSmall }">

            <t t-if="env.isSmall">
                <DashboardMobileSearchPanel onDashboardSelected="(dashboardId) =&gt; this.openDashboard(dashboardId)" activeDashboard="dashboard" groups="getDashboardGroups()"/>
            </t>
            <t t-else="">
                <div class="o_spreadsheet_dashboard_search_panel o_search_panel flex-grow-0 border-end flex-shrink-0 pe-2 pb-5 ps-4 h-100 bg-view overflow-auto">
                    <section t-foreach="getDashboardGroups()" t-as="group" t-key="group.id" class="o_search_panel_section o_search_panel_category">
                        <header class="o_search_panel_section_header pt-4 pb-2 text-uppercase o_cursor_default user-select-none">
                            <b t-esc="group.name"/>
                        </header>
                        <ul class="list-group d-block o_search_panel_field">
                            <li t-foreach="group.dashboards" t-as="dashboard" t-key="dashboard.id" t-on-click="() =&gt; this.openDashboard(dashboard.id)" t-esc="dashboard.displayName" t-att-data-name="dashboard.displayName" class="o_search_panel_category_value list-group-item cursor-pointer border-0" t-att-class="{'active': dashboard.id === state.activeDashboard.id}"/>
                        </ul>
                    </section>
                </div>
            </t>

            <h3 t-if="!dashboard" class="dashboard-loading-status">No available dashboard</h3>
            <t t-else="">
                <t t-set="status" t-value="dashboard.status"/>
                <h3 t-if="status === Status.Loading" class="dashboard-loading-status">Loading...</h3>
                <div t-elif="status === Status.Error" class="dashboard-loading-status error">
                    An error occured while loading the dashboard
                </div>
                <t t-else="">
                    <MobileFigureContainer t-if="env.isSmall" spreadsheetModel="dashboard.model" t-key="dashboard.id"/>
                    <div t-else="" class="o_renderer">
                        <Spreadsheet model="dashboard.model" t-key="dashboard.id"/>
                    </div>
                </t>
            </t>
        </div>
    </div>
<t t-name="documents_spreadsheet.MobileFigureContainer">
        <t t-if="!figures.length">
            Only chart figures are displayed in small screens but this dashboard doesn't contain any
        </t>
        <t t-foreach="figures" t-as="figure" t-component="getFigureComponent(figure)" onFigureDeleted="() =&gt; {}" figure="figure" t-key="figure.id"/>
    </t>
<div t-name="documents_spreadsheet.DashboardMobileSearchPanel" class="o_search_panel o_search_panel_summary btn w-100 overflow-visible">
        <t t-if="state.isOpen">
            <t t-portal="'body'">
                <div class="o_spreadsheet_dashboard_search_panel o_search_panel o_searchview o_mobile_search">
                    <div class="o_mobile_search_header">
                        <button type="button" class="o_mobile_search_button btn" t-on-click="() =&gt; this.state.isOpen = false">
                            <i class="oi oi-arrow-left"/>
                            <strong class="ml8">BACK</strong>
                        </button>
                    </div>
                    <div class="o_mobile_search_content">
                        <div class="o_search_panel flex-grow-0 flex-shrink-0 border-end pe-2 pb-5 ps-4 h-100 bg-view overflow-auto">
                            <section t-foreach="props.groups" t-as="group" t-key="group.id" class="o_search_panel_section o_search_panel_category">
                                <header class="o_search_panel_section_header pt-4 pb-2 text-uppercase cursor-default">
                                    <b t-esc="group.name"/>
                                </header>
                                <ul class="list-group d-block o_search_panel_field">
                                    <li t-foreach="group.dashboards" t-as="dashboard" t-key="dashboard.id" t-on-click="() =&gt; this.onDashboardSelected(dashboard.id)" class="o_search_panel_category_value list-group-item py-1 o_cursor_pointer border-0 ps-0 pe-2">
                                        <header class="list-group-item list-group-item-action d-flex align-items-center p-0 border-0" t-att-class="{'active text-900 fw-bold': dashboard.id === props.activeDashboard.id}">
                                            <div class="o_search_panel_label d-flex align-items-center overflow-hidden w-100 o_cursor_pointer mb-0">

                                                <button class="o_toggle_fold btn p-0 flex-shrink-0 text-center"/>
                                                <span t-esc="dashboard.displayName" class="o_search_panel_label_title text-truncate"/>
                                            </div>

                                        </header>
                                    </li>
                                </ul>
                            </section>
                        </div>
                    </div>
                </div>
            </t>
        </t>
        <div t-elif="props.groups.length" t-on-click="openDashboardSelection" class="d-flex align-items-center">
            <i class="fa fa-fw fa-filter"/>
            <div t-esc="searchBarText" class="o_search_panel_current_selection text-truncate ms-2 me-auto"/>
        </div>
    </div>

</templates>`);
                    });